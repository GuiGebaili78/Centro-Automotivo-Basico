PROJECT DUMP GENERATED ON 01/21/2026 14:25:15
ROOT: C:\workspace\Meus Projetos\Centro Automotivo APP\App Centro Automotivo
EXCLUDED: node_modules, .git, dist, build, .next, coverage, package-lock.json, yarn.lock, pnpm-lock.yaml, *.log, *.png, *.jpg, *.jpeg, *.gif, *.ico, *.svg, *.webp, *.pdf, .DS_Store, .env


================================================================================
FILE PATH: DEBUG_CARTOES.md
================================================================================
# üîç CHECKLIST DE DEBUG - CART√ïES NO CAIXA

## TESTE PASSO A PASSO:

### 1. Criar OS com Cart√£o de Cr√©dito 3x

1. Criar nova OS
2. Adicionar pagamento Cr√©dito 3x de R$ 300,00
3. **IMPORTANTE**: Selecionar operadora (ex: Stone, Cielo)
4. Salvar pagamento
5. Ir em Fechamento Financeiro
6. Clicar em "Salvar e Finalizar"

### 2. Verificar Console do Navegador (F12)

Procurar por erros ou mensagens

### 3. Verificar Banco de Dados

Execute no PostgreSQL:

```sql
-- Verificar se pagamento tem id_operadora
SELECT 
  id_pagamento_cliente,
  metodo_pagamento,
  valor,
  id_operadora,
  id_conta_bancaria
FROM pagamento_cliente
ORDER BY id_pagamento_cliente DESC
LIMIT 5;

-- Verificar se lan√ßamento foi criado no caixa
SELECT 
  id_livro_caixa,
  descricao,
  valor,
  tipo_movimentacao,
  categoria,
  dt_movimentacao
FROM livro_caixa
ORDER BY id_livro_caixa DESC
LIMIT 10;

-- Verificar se receb√≠veis foram criados
SELECT 
  id_recebivel,
  id_os,
  id_operadora,
  num_parcela,
  total_parcelas,
  valor_bruto,
  valor_liquido,
  status
FROM recebivel_cartao
ORDER BY id_recebivel DESC
LIMIT 10;
```

### 4. Resultados Esperados:

‚úÖ `pagamento_cliente.id_operadora` deve ter um valor (n√£o null)
‚úÖ Deve existir 1 lan√ßamento no `livro_caixa` com descri√ß√£o "Faturamento CREDITO - OS #X"
‚úÖ Devem existir 3 registros em `recebivel_cartao` (uma para cada parcela)

### 5. Se `id_operadora` for NULL:

**Problema**: Frontend n√£o est√° enviando a operadora
**Solu√ß√£o**: Verificar se o select de operadora est√° funcionando no formul√°rio verde

### 6. Se `id_operadora` existe mas n√£o tem lan√ßamento no caixa:

**Problema**: Consolida√ß√£o n√£o est√° executando ou est√° falhando
**Solu√ß√£o**: Verificar logs do servidor Docker

```bash
docker compose logs api --tail=100
```

---

## PR√ìXIMO PASSO:

Execute o teste acima e me informe:
1. O valor de `id_operadora` no banco
2. Se existe lan√ßamento no caixa
3. Se existem receb√≠veis
4. Qualquer erro no console ou logs



================================================================================
FILE PATH: docker-compose.yml
================================================================================
services:
  # 1. Servi√ßo do Banco de Dados PostgreSQL
  centroautomotivo_db:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: automotivo_db
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d automotivo_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network

  # 2. Servi√ßo da API (Backend Node/Express)
  api:
    build:
      context: ./server
      dockerfile: Dockerfile
    image: automotivo-api
    command: sh -c "npx prisma generate && npx prisma migrate deploy && npm run dev"
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: postgresql://user:password@centroautomotivo_db:5432/automotivo_db
      PORT: 3000
      NODE_ENV: development
      NODE_OPTIONS: "--max-old-space-size=2048"
    depends_on:
      centroautomotivo_db:
        condition: service_healthy
    volumes:
      - ./server:/app/server
      - /app/server/node_modules
    networks:
      - app-network

  # 3. Servi√ßo do Frontend (React + Vite)
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    image: automotivo-client
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://localhost:3000
      NODE_OPTIONS: "--max-old-space-size=2048"
    volumes:
      - ./client:/app/client
      - /app/client/node_modules
    depends_on:
      - api
    networks:
      - app-network

volumes:
  postgres_data:

networks:
  app-network:
    driver: bridge


================================================================================
FILE PATH: package.json
================================================================================
{
  "name": "centro-automotivo-app",
  "version": "1.0.0",
  "description": "Root scripts for managing Docker and overarching project tasks",
  "scripts": {
    "docker:reset": "docker compose up -d && docker compose restart api",
    "docker:up": "docker compose up -d",
    "docker:down": "docker compose down",
    "db:migrate": "docker compose exec api npx prisma migrate dev",
    "db:studio": "docker compose exec api npx prisma studio",
    "generate:context": "powershell -ExecutionPolicy Bypass -File ./generate_context.ps1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}



================================================================================
FILE PATH: PROJECT_RULES.md
================================================================================
# Documenta√ß√£o Mestra do Projeto & Regras de Neg√≥cio (Guardrails)

> [!IMPORTANT]
> Este documento serve como **Fonte da Verdade** para o desenvolvimento do projeto. Qualquer altera√ß√£o futura deve respeitar estritamente as regras de neg√≥cio, a arquitetura e as diretrizes de design definidas aqui para evitar quebras de funcionalidade ou regress√µes visuais.

---

## 1. Arquitetura e Tecnologias

O projeto utiliza uma arquitetura monol√≠tica modular separada em `client` e `server` dentro do mesmo reposit√≥rio, orquestrada via Docker.

- **Frontend**: React (Vite), TailwindCSS, Lucide Icons.
- **Backend**: Node.js (Express), Prisma ORM.
- **Banco de Dados**: PostgreSQL (Container `centroautomotivo_db`).
- **Infraestrutura**: Docker Compose (`api`, `client`, `db`).

### Conven√ß√µes de C√≥digo
- **Backend**: Padr√£o **Repository Pattern**. A l√≥gica de neg√≥cio pesada (ex: consolida√ß√£o) DEVE residir nos reposit√≥rios (`src/repositories`), n√£o nos controllers.
- **Frontend**: Componentiza√ß√£o forte. P√°ginas em `src/pages`, componentes reutiliz√°veis em `src/components/ui`.

---

## 2. Regras de Neg√≥cio Cr√≠ticas (N√ÉO QUEBRAR)

### 2.1. M√≥dulo Financeiro & Consolida√ß√£o de OS
Esta √© a parte mais cr√≠tica e sens√≠vel do sistema.

#### Regra de Ouro da Consolida√ß√£o (`consolidarOS`)
Ao finalizar uma OS financeiramente, o sistema processa os pagamentos de formas distintas dependendo do m√©todo:

1.  **PIX e DINHEIRO**:
    *   **A√ß√£o Imediata**: Deve atualizar o saldo da `ContaBancaria` selecionada (`saldo_atual + valor`).
    *   **Livro Caixa**: Deve criar um registro de `ENTRADA` no `LivroCaixa` vinculado √† conta.
    *   **Extrato**: O valor deve aparecer imediatamente na tela de Extrato Banc√°rio.
    *   **Regra de Valida√ß√£o**: √â OBRIGAT√ìRIO informar uma conta banc√°ria para estes m√©todos.

2.  **CART√ÉO (Cr√©dito/D√©bito)**:
    *   **N√ÉO Atualiza Saldo Imediatamente**: O saldo da conta banc√°ria **N√ÉO** deve ser alterado na consolida√ß√£o.
    *   **Cria√ß√£o de Receb√≠veis**: Deve gerar registros na tabela `RecebivelCartao` (parcelas calculadas conforme taxas da operadora).
    *   **Livro Caixa (Controle)**: Cria um registro no `LivroCaixa` com `id_conta_bancaria: null` apenas para registrar o faturamento bruto (n√£o afeta extrato banc√°rio).
    *   **Concilia√ß√£o Manual**: O saldo banc√°rio s√≥ √© atualizado quando o usu√°rio clica em "Confirmar/Dar Baixa" na aba de **Receb√≠veis**.

#### Regra do "Caixa Geral"
*   **Proibido**: N√£o existe uma conta "Caixa Geral" gen√©rica. Todas as movimenta√ß√µes devem ser rastre√°veis para contas reais (Nubank, Cofre F√≠sico, etc.).

### 2.2. Ordens de Servi√ßo (OS)
*   **Fluxo de Status**: `ABERTA` -> `PRONTO PARA FINANCEIRO` -> `FINALIZADA`.
*   **Edi√ß√£o**: Itens e M√£o de Obra s√≥ podem ser editados enquanto a OS n√£o estiver `FINALIZADA`.
*   **Pagamentos Mistos**: O sistema deve suportar m√∫ltiplos pagamentos (ex: parte em PIX, parte em Cart√£o) na mesma OS, aplicando as regras de consolida√ß√£o acima para cada fra√ß√£o.

---

## 3. Diretrizes de Design (UI/UX)

O layout segue um estilo "Premium/Moderno". Regress√µes para estilos "padr√£o" ou "b√°sicos" s√£o inaceit√°veis.

### 3.1. Paleta de Cores
*   **A√ß√µes Prim√°rias**: Tons de **Azul** (`bg-blue-600`, `text-blue-600`).
*   **Sucesso/Dinheiro**: Tons de **Verde/Emerald** (`text-green-600`, `bg-green-50`).
*   **Alerta/D√≠vida**: Tons de **Vermelho** (`text-red-600`, `bg-red-50`).
*   **Neutros**: Evitar preto puro (`#000`). Usar `neutral-900` para textos escuros e `neutral-500` para secund√°rios.
*   **Proibido**: Bot√µes cinzas ou pretos para a√ß√µes principais de "Salvar" ou "Confirmar". Usar sempre cores sem√¢nticas ou vibrantes.

### 3.2. Formas e Sombras
*   **Bordas**: Sempre arredondadas. Usar `rounded-xl` ou `rounded-2xl` para cards e containeres. `rounded-lg` para inputs e bot√µes menores.
*   **Sombras**: Usar sombras suaves (`shadow-sm`, `shadow-md`) aliadas a bordas sutis (`border-neutral-100`) para criar profundidade.
*   **Superf√≠cies**: Priorizar fundo branco (`bg-white`) sobre fundo cinza claro (`bg-neutral-50`) para destacar conte√∫do.

### 3.3. Componentes Espec√≠ficos
*   **Tabelas**: Cabe√ßalhos sempre em uppercase, fonte pequena e bold (`text-xs font-black uppercase text-neutral-400`). Linhas com hover suave.
*   **Modais**: Fundo com `backdrop-blur-sm`. Anima√ß√µes de entrada (`animate-in zoom-in-95`).
*   **Inputs**: Sem bordas padr√£o escuras. Usar `bg-neutral-50` com focus ring colorido.

---

## 4. Banco de Dados (Schema Notes)

*   **Tabelas Chave**:
    *   `livro_caixa`: Centraliza todas as movimenta√ß√µes. Campo `id_conta_bancaria` define se aparece no extrato.
    *   `recebivel_cartao`: Controla o fluxo futuro de entradas de cart√£o.
    *   `pagamento_cliente`: Registra a inten√ß√£o de pagamento na OS. Deve ter v√≠nculo (`id_livro_caixa`) ap√≥s consolida√ß√£o.

> [!WARNING]
> Nunca assuma que `id_conta_bancaria` em `pagamento_cliente` existe para cart√µes. Para cart√µes, o v√≠nculo √© via `id_operadora`.

---

## 5. Procedimentos de Deploy e Teste

1.  **Build**: Sempre validar se n√£o h√° erros de tipagem (`tsc -b`) antes de subir, pois a Vercel/Build step ir√° falhar (como ocorreu com `implicit any`).
2.  **Docker**: Servidor roda em `npm run dev`. N√£o √© necess√°rio rebuildar containers para mudan√ßas de c√≥digo JS/TS, apenas para mudan√ßas em `package.json` ou `Dockerfile`.
3.  **Testes Manuais Obrigat√≥rios**:
    *   Criar OS -> Adicionar Pe√ßa e M√£o de Obra -> Adicionar Pagamento Misto (PIX + Cart√£o) -> Finalizar.
    *   Verificar se o PIX caiu no Extrato.
    *   Verificar se o Cart√£o caiu em Receb√≠veis (e N√ÉO no Extrato).



================================================================================
FILE PATH: README.md
================================================================================
# Centro-Automotivo-Basico




================================================================================
FILE PATH: TESTE_CONSOLIDACAO.md
================================================================================
# üîç DIAGN√ìSTICO - PROBLEMAS DE CONSOLIDA√á√ÉO

## PROBLEMAS REPORTADOS:

1. ‚ùå PIX aparece no caixa mas N√ÉO na conta banc√°ria
2. ‚ùå Cr√©dito aparece em receb√≠veis mas N√ÉO no caixa
3. ‚ùå Extrato n√£o mostra movimenta√ß√µes (s√≥ saldo)

## POSS√çVEIS CAUSAS:

### Problema 1: PIX n√£o atualiza conta
**Causa prov√°vel**: `id_conta_bancaria` n√£o est√° sendo salvo no `PagamentoCliente`
**Solu√ß√£o**: Verificar se o campo est√° sendo enviado do frontend

### Problema 2: Cr√©dito n√£o aparece no caixa
**Causa prov√°vel**: Lan√ßamento no caixa n√£o est√° sendo criado para cart√µes
**Solu√ß√£o**: Verificar l√≥gica de consolida√ß√£o (linhas 148-185 do repository)

### Problema 3: Extrato n√£o mostra movimenta√ß√µes
**Causa prov√°vel**: Movimenta√ß√µes n√£o t√™m `id_conta_bancaria` vinculado
**Solu√ß√£o**: Verificar se consolida√ß√£o est√° criando lan√ßamentos com `id_conta_bancaria`

## CHECKLIST DE VERIFICA√á√ÉO:

- [ ] Frontend est√° enviando `id_conta_bancaria` para PIX/Dinheiro?
- [ ] Frontend est√° enviando `id_operadora` para Cart√µes?
- [ ] Backend est√° recebendo esses campos?
- [ ] Consolida√ß√£o est√° criando lan√ßamentos no caixa?
- [ ] Consolida√ß√£o est√° vinculando `id_conta_bancaria` aos lan√ßamentos?
- [ ] Consolida√ß√£o est√° atualizando saldo banc√°rio?

## PR√ìXIMOS PASSOS:

1. Testar novamente ap√≥s corre√ß√£o do status (mudan√ßa para PRONTO PARA FINANCEIRO antes de consolidar)
2. Verificar logs do servidor para erros
3. Verificar banco de dados diretamente se necess√°rio



================================================================================
FILE PATH: .antigravity\rules.md
================================================================================
Voc√™ √© um desenvolvedor fullstack s√™nior, especialista em ReactJS, NextJS, TypeScript, TailwindCSS 3, Shadcn e Radix. Suas respostas devem ser diretas, profissionais e focadas em efici√™ncia.  
1. Fluxo de Trabalho e Economia de Tokens
Planejamento Conciso: Antes de codificar, apresente um plano de implementa√ß√£o resumido e direto ao ponto. Aguarde minha aprova√ß√£o para iniciar a codifica√ß√£o.  
Foco na Tarefa (Escopo): Concentre-se apenas nos arquivos e componentes mencionados na tarefa atual. N√£o modifique ou adicione c√≥digo a arquivos j√° existentes e fora do escopo a menos que seja explicitamente solicitado.  
Gera√ß√£o de C√≥digo: Ao receber a aprova√ß√£o, gere o c√≥digo completo, funcional, din√¢mico e sem placeholders, mocks ou dados fixos. N√£o gere documenta√ß√£o adicional, pseudo-c√≥digo ou planos extensos, a menos que seja explicitamente pedido. Em caso de bugs ou necessidade de ajustes, aponte a causa e a solu√ß√£o de forma objetiva. Itere na solu√ß√£o at√© eu confirmar que a funcionalidade est√° correta. 
2. Padr√µes de C√≥digo
DRY (Don't Repeat Yourself): O c√≥digo deve ser reutiliz√°vel e modular.  Use nomes claros e descritivos para componentes, vari√°veis e fun√ß√µes. Use o prefixo handle para fun√ß√µes de eventos (ex: handleClick). Utilize exclusivamente TailwindCSS 3 na estiliza√ß√£o. UI/UX: Priorize o uso de Shadcn e Radix para componentes complexos, estilizando-os com Tailwind.  
Boas Pr√°ticas:
Sempre use const e let. Use TypeScript com tipagem expl√≠cita sempre que poss√≠vel. Implemente acessibilidade (ex: tabindex, aria-label). Priorize early returns para maior legibilidade. Fa√ßa os tratamentos de erros pertinentes ao c√≥digo.
3. Gerenciamento de Cores
Todas as cores e fontes devem ser definidas e gerenciadas exclusivamente no arquivo tailwind.config.js. Isso garante um controle centralizado e a gera√ß√£o autom√°tica de todas as classes de utilidade do Tailwind.   
Resumo das Regras Principais
Planejar de forma concisa ‚Üí Aprovar ‚Üí Executar.  
Respeitar o escopo da tarefa, sem alterar c√≥digo j√° aprovado.  
C√≥digo deve ser leg√≠vel, completo, funcional e acess√≠vel.  
Estiliza√ß√£o via Tailwind 3 com cores centralizadas no tailwind.config.js.  
Tudo passa pelo Docker, n√£o √© pra fazer nada direto sem passar pelo docker.
Preciso que vc tenha essas informa√ß√µes para que a cada altera√ß√£o n√£o modifique c√≥digos ou funcionalidades que j√° est√£o funcionando bem.
Responder tudo e portugues Brasil, pt-br. N√£o entendo nada de ingles

O projeto √© um app para gest√£o de oficinas automotivas, o diferencial √© que ele √© f√°cil de usar, √© objetivo e f√°cil de navegar. Para oficinas pequenas que n√£o precisam de um software complexo e caro. Oficinas que n√£o vendem pe√ßas, apenas servi√ßos de manuten√ß√£o e pequenas pe√ßas como lampadas, oleo, bateria etc.. apenas para agilizar o servi√ßo.


================================================================================
FILE PATH: client\.dockerignore
================================================================================
node_modules
npm-debug.log
dist
build
.git
.gitignore
README.md


================================================================================
FILE PATH: client\Dockerfile
================================================================================
# Usa uma imagem leve do Node
FROM node:20-alpine

# Define o diret√≥rio de trabalho
WORKDIR /app/client

# Copia os arquivos de depend√™ncias
COPY package*.json ./

# Instala as depend√™ncias
RUN npm install

# Copia o restante do c√≥digo
COPY . .

# Exp√µe a porta padr√£o do Vite
EXPOSE 5173

# Inicia o servidor de desenvolvimento com host 0.0.0.0 para acesso externo
CMD ["npm", "run", "dev", "--", "--host"]



================================================================================
FILE PATH: client\eslint.config.js
================================================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])



================================================================================
FILE PATH: client\index.html
================================================================================
<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Centro Automotivo APP</title>
</head>

<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>

</html>


================================================================================
FILE PATH: client\package.json
================================================================================
{
  "name": "client",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
    
  },
  "dependencies": {
    "@tailwindcss/vite": "^4.1.17",
    "axios": "^1.13.2",
    "lucide-react": "^0.561.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.10.1",
    "tailwindcss": "^4.1.17"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4"
  }
}



================================================================================
FILE PATH: client\README.md
================================================================================
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```



================================================================================
FILE PATH: client\tsconfig.app.json
================================================================================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}



================================================================================
FILE PATH: client\tsconfig.json
================================================================================
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}



================================================================================
FILE PATH: client\tsconfig.node.json
================================================================================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}



================================================================================
FILE PATH: client\vite.config.ts
================================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import tailwindcss from '@tailwindcss/vite'


// https://vite.dev/config/
export default defineConfig({
  plugins: [react(), tailwindcss()],
  server: {
    host: true, // Listen on all addresses
    strictPort: true,
    port: 5173,
    watch: {
      usePolling: true, 
      interval: 1000, // Check files every 1000ms (Reduced Load)
      binaryInterval: 2000, // Check binary files less often
    },
    hmr: {
      clientPort: 5173, // Ensures simple WebSocket connection from browser
    }
  }
})



================================================================================
FILE PATH: client\src\App.css
================================================================================
@import "tailwindcss";

#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}

.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}

.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }

  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


================================================================================
FILE PATH: client\src\App.tsx
================================================================================
import {
  createBrowserRouter,
  RouterProvider,
  createRoutesFromElements,
  Route,
} from "react-router-dom";
import { MainLayout } from "./components/layouts/MainLayout";
import { NotFoundPage } from "./pages/NotFoundPage";
import { ClientePage } from "./pages/ClientePage";

// Importe suas p√°ginas antigas aqui enquanto n√£o refatora todas
import { VeiculoPage } from "./pages/VeiculoPage";
import { OrdemDeServicoPage } from "./pages/OrdemDeServicoPage";
import { OrdemDeServicoDetalhePage } from "./pages/OrdemDeServicoDetalhePage";
import { CadastroUnificadoPage } from "./pages/CadastroUnificadoPage";

import { PecasEstoquePage } from "./pages/PecasEstoquePage";
import { EntradaEstoquePage } from "./pages/EntradaEstoquePage";
import { FuncionarioPage } from "./pages/FuncionarioPage";
import { PessoaPage } from "./pages/PessoaPage";
import { TipoPage } from "./pages/TipoPage";
import { FechamentoFinanceiroPage } from "./pages/FechamentoFinanceiroPage";
import { FechamentoFinanceiroDetalhePage } from "./pages/FechamentoFinanceiroDetalhePage";

import { FornecedorPage } from "./pages/FornecedorPage";
import { PagamentoPecaPage } from "./pages/PagamentoPecaPage";
import { LivroCaixaPage } from "./pages/LivroCaixaPage";
import { ContasAPagarPage } from "./pages/ContasAPagarPage";
import { SearchClientePage } from "./pages/SearchClientePage";
import { SearchVeiculoPage } from "./pages/SearchVeiculoPage";
import { NovoPagamentoPage } from "./pages/NovoPagamentoPage";
import { PagamentoEquipePage } from "./pages/PagamentoEquipePage";
import { ExtratoBancarioPage } from "./pages/ExtratoBancarioPage";
import { DaschboardPage } from "./pages/DaschboardPage";

const router = createBrowserRouter(
  createRoutesFromElements(
    <Route element={<MainLayout />}>
      <Route path="/" element={<DaschboardPage />} />
      {/* P√°ginas Modernizadas */}
      <Route path="/cliente" element={<ClientePage />} />
      {/* P√°ginas Legadas (Ainda funcionam dentro do layout novo!) */}
      <Route path="/veiculo" element={<VeiculoPage />} />
      <Route path="/ordem-de-servico" element={<OrdemDeServicoPage />} />
      <Route
        path="/ordem-de-servico/:id"
        element={<OrdemDeServicoDetalhePage />}
      />
      {/* Unified Registration Routes */}
      <Route path="/novo-cadastro" element={<CadastroUnificadoPage />} />
      <Route path="/cadastro/:clienteId" element={<CadastroUnificadoPage />} />
      <Route path="/pecas-estoque" element={<PecasEstoquePage />} />
      <Route path="/entrada-estoque" element={<EntradaEstoquePage />} />
      <Route path="/funcionario" element={<FuncionarioPage />} />
      <Route path="/pessoa" element={<PessoaPage />} />
      <Route path="/tipo" element={<TipoPage />} />
      <Route
        path="/fechamento-financeiro"
        element={<FechamentoFinanceiroPage />}
      />
      <Route
        path="/fechamento-financeiro/:id"
        element={<FechamentoFinanceiroDetalhePage />}
      />
      <Route path="/financeiro" element={<LivroCaixaPage />} />{" "}
      {/* Redirect old /financeiro to LivroCaixaPage */}
      <Route path="/financeiro/livro-caixa" element={<LivroCaixaPage />} />
      <Route
        path="/financeiro/pagamento-pecas"
        element={<PagamentoPecaPage />}
      />
      <Route path="/financeiro/contas-pagar" element={<ContasAPagarPage />} />
      <Route
        path="/financeiro/extrato/:idConta"
        element={<ExtratoBancarioPage />}
      />
      <Route path="/financeiro/equipe" element={<PagamentoEquipePage />} />{" "}
      {/* Nova Rota */}
      <Route path="/pagamento-equipe" element={<PagamentoEquipePage />} />
      <Route path="/pagamento-equipe/novo" element={<NovoPagamentoPage />} />
      <Route path="/fornecedor" element={<FornecedorPage />} />
      <Route path="/pagamento-peca" element={<PagamentoPecaPage />} />
      {/* Search Pages */}
      <Route path="/search-cliente" element={<SearchClientePage />} />
      <Route path="/search-veiculo" element={<SearchVeiculoPage />} />
      {/* Rota 404 para qualquer coisa n√£o definida */}
      <Route path="*" element={<NotFoundPage />} />
    </Route>,
  ),
);

function App() {
  return <RouterProvider router={router} />;
}

export default App;



================================================================================
FILE PATH: client\src\index.css
================================================================================
@import "tailwindcss";

@theme {
  /* Tipografia */
  --font-sans: "Inter", system-ui, -apple-system, sans-serif;
  --font-mono: "JetBrains Mono", "Fira Code", monospace;

  /* Escala Azul (Oficina/Principal) */
  --color-primary-25: #eff6ff;
  --color-primary-50: #eff6ff;
  --color-primary-100: #dbeafe;
  --color-primary-200: #bfdbfe;
  --color-primary-300: #93c5fd;
  --color-primary-400: #60a5fa;
  --color-primary-500: #3b82f6;
  --color-primary-600: #2563eb;
  --color-primary-700: #1d4ed8;
  --color-primary-800: #1e40af;
  --color-primary-900: #1e3a8a;

  /* Escala Laranja (Oficina/Destaque) */
  --color-secondary-25: #fffaf5;
  --color-secondary-50: #fff7ed;
  --color-secondary-100: #ffedd5;
  --color-secondary-200: #fed7aa;
  --color-secondary-300: #fdba74;
  --color-secondary-400: #fb923c;
  --color-secondary-500: #f97316;
  --color-secondary-600: #ea580c;
  --color-secondary-700: #c2410c;
  --color-secondary-800: #9a3412;
  --color-secondary-900: #7c2d12;

  /* Neutros */
  --color-neutral-25: #fcfcfd;
  --color-neutral-50: #f9fafb;
  --color-neutral-100: #f3f4f6;
  --color-neutral-200: #e5e7eb;
  --color-neutral-300: #d1d5db;
  --color-neutral-400: #9ca3af;
  --color-neutral-500: #6b7280;
  --color-neutral-600: #4b5563;
  --color-neutral-700: #374151;
  --color-neutral-800: #1f2937;
  --color-neutral-900: #0d121d;

  /* Accent / Cyan */
  --color-accent-25: #f0fdfa;
  --color-accent-50: #ecfeff;
  --color-accent-100: #cffafe;
  --color-accent-200: #a5f3fc;
  --color-accent-300: #67e8f9;
  --color-accent-400: #22d3ee;
  --color-accent-500: #06b6d4;
  --color-accent-600: #0891b2;
  --color-accent-700: #0e7490;
  --color-accent-800: #155e75;
  --color-accent-900: #164e63;

  /* Sem√¢nticas */
  --color-success: #059669;
  --color-success-50: #ecfdf5;
  --color-warning: #d97706;
  --color-warning-50: #fffbeb;
  --color-error: #dc2626;
  --color-error-50: #fef2f2;
  --color-info: #2563eb;

  /* UI Tokens */
  --color-background: var(--color-neutral-50);
  --color-surface: #ffffff;
  --color-border: var(--color-neutral-200);
  --color-text-main: var(--color-neutral-900);
  --color-text-muted: var(--color-neutral-500);
  --color-sidebar: var(--color-neutral-900);
}

:root {
  font-family: var(--font-sans);
  line-height: 1.5;
  font-weight: 400;
  color: #334155;
  /* Slate 700 */
  background-color: var(--color-background);
  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  margin: 0;
  display: flex;
  min-width: 320px;
  min-height: 100vh;
}

/* Scrollbar moderna */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}



================================================================================
FILE PATH: client\src\main.tsx
================================================================================
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)



================================================================================
FILE PATH: client\src\components\Sidebar.tsx
================================================================================
import { useState } from "react";
import {
  Wrench,
  Package,
  LayoutDashboard,
  DollarSign,
  ChevronDown,
  ChevronRight,
  Search,
} from "lucide-react";
import { Link, useLocation } from "react-router-dom";

const menuItems = [
  { path: "/", label: "Dashboard", icon: LayoutDashboard },
  {
    label: "Buscar",
    icon: Search,
    path: "/buscar",
    subItems: [
      { path: "/cliente", label: "Clientes" },
      { path: "/veiculo", label: "Ve√≠culos" },
      { path: "/fornecedor", label: "Fornecedores" },
      { path: "/funcionario", label: "Colaboradores" },
    ],
  },
  { path: "/ordem-de-servico", label: "Ordens de Servi√ßo", icon: Wrench },
  {
    label: "Estoque",
    icon: Package,
    path: "/estoque",
    subItems: [
      { path: "/pecas-estoque", label: "Vis√£o Geral / Consulta" },
      { path: "/entrada-estoque", label: "Nova Compra (Entrada)" },
    ],
  },
  {
    label: "Financeiro",
    icon: DollarSign,
    path: "/financeiro", // Base path for checking active state
    subItems: [
      { path: "/financeiro/livro-caixa", label: "Gest√£o Financeira" },
      { path: "/financeiro/equipe", label: "Pagamento de Equipe" },
      { path: "/financeiro/pagamento-pecas", label: "Pagamento Auto Pe√ßas" },
      { path: "/financeiro/contas-pagar", label: "Contas a Pagar (Geral)" },
      { path: "/fechamento-financeiro", label: "Consolida√ß√£o" },
    ],
  },
];

export const Sidebar = () => {
  const location = useLocation();
  const [expandedMenus, setExpandedMenus] = useState<string[]>(["Financeiro"]); // Auto-expand Financeiro for visibility

  const toggleMenu = (label: string) => {
    setExpandedMenus((prev) =>
      prev.includes(label)
        ? prev.filter((item) => item !== label)
        : [...prev, label]
    );
  };

  return (
    <aside className="w-64 bg-neutral-900 text-neutral-400 flex flex-col h-screen fixed left-0 top-0 overflow-y-auto border-r border-neutral-500">
      <div className="p-6 border-b border-neutral-800">
        <h1 className="text-2xl font-bold text-white tracking-tight">
          Auto<span className="text-primary-500">Center</span>
        </h1>
      </div>

      <nav className="flex-1 py-6 px-3 space-y-1">
        {menuItems.map((item) => {
          const isActive =
            location.pathname === item.path ||
            (item.subItems &&
              item.subItems.some((sub) => location.pathname === sub.path));
          const isExpanded = expandedMenus.includes(item.label);

          return (
            <div key={item.label}>
              {item.subItems ? (
                <button
                  onClick={() => toggleMenu(item.label)}
                  className={`w-full flex items-center justify-between px-4 py-3 rounded-xl transition-all duration-200 font-medium cursor-pointer ${
                    isActive
                      ? "bg-neutral-800 text-white shadow-lg shadow-primary-900/50"
                      : "hover:bg-neutral-800 hover:text-white"
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <item.icon
                      size={20}
                      className={
                        isActive ? "text-primary-500" : "text-neutral-500"
                      }
                    />
                    {item.label}
                  </div>
                  {isExpanded ? (
                    <ChevronDown size={16} />
                  ) : (
                    <ChevronRight size={16} />
                  )}
                </button>
              ) : (
                <Link
                  to={item.path}
                  className={`flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 font-medium ${
                    isActive
                      ? "bg-neutral-800 text-neutral-400 shadow-lg shadow-primary-900/50"
                      : "hover:bg-neutral-800 hover:text-white"
                  }`}
                >
                  <item.icon
                    size={20}
                    className={isActive ? "text-white" : "text-neutral-500"}
                  />
                  {item.label}
                </Link>
              )}

              {/* Submenu Rendering */}
              {item.subItems && isExpanded && (
                <div className="mt-1 ml-4 space-y-1 border-l border-neutral-800 pl-2">
                  {item.subItems.map((sub) => {
                    const isSubActive = location.pathname === sub.path;
                    return (
                      <Link
                        key={sub.path}
                        to={sub.path}
                        className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm transition-colors ${
                          isSubActive
                            ? " neutral-400 bg-neutral-800 shadow-lg shadow-primary-900/30 font-bold"
                            : "text-primary-500 hover:text-neutral-300"
                        }`}
                      >
                        {sub.label}
                      </Link>
                    );
                  })}
                </div>
              )}
            </div>
          );
        })}
      </nav>

      <div className="p-4 border-t border-neutral-800">
        <div className="bg-neutral-800/50 rounded-lg p-3">
          <p className="text-xs text-center text-neutral-500">
            &copy; 2026 Centro Automotivo <br /> Guilherme Gebaili <br />{" "}
            https://github.com/GuiGebaili78
          </p>
        </div>
      </div>
    </aside>
  );
};



================================================================================
FILE PATH: client\src\components\financeiro\CategoryManager.tsx
================================================================================
import { useState, useEffect } from "react";
import { api } from "../../services/api";
import { Trash2, Plus, X, AlertTriangle, Edit, Save } from "lucide-react";
import { Modal } from "../ui/Modal";
import { Button } from "../ui/Button";
import { Input } from "../ui/input";

interface Category {
  id_categoria: number;
  nome: string;
  tipo: string;
}

interface CategoryManagerProps {
  isOpen: boolean;
  onClose: () => void;
  onUpdate: () => void;
}

export const CategoryManager = ({
  isOpen,
  onClose,
  onUpdate,
}: CategoryManagerProps) => {
  const [categories, setCategories] = useState<Category[]>([]);
  const [newCatName, setNewCatName] = useState("");
  const [newCatType, setNewCatType] = useState("AMBOS");
  const [loading, setLoading] = useState(false);

  // Conflict Resolution State
  const [conflictData, setConflictData] = useState<{
    id: number;
    message: string;
    count: number;
  } | null>(null);
  const [replacementCat, setReplacementCat] = useState("");

  // Editing State
  const [editingCatId, setEditingCatId] = useState<number | null>(null);
  const [editName, setEditName] = useState("");
  const [editType, setEditType] = useState("AMBOS");

  // UI State
  const [deleteConfirmId, setDeleteConfirmId] = useState<number | null>(null);

  useEffect(() => {
    if (isOpen) {
      loadCategories(); // This will hit the backend which now syncs
      setConflictData(null);
      setReplacementCat("");
    }
  }, [isOpen]);

  const loadCategories = async () => {
    try {
      const res = await api.get("/categoria-financeira");
      setCategories(res.data);
    } catch (error) {
      console.error(error);
    }
  };

  const handleAdd = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      setLoading(true);
      await api.post("/categoria-financeira", {
        nome: newCatName,
        tipo: newCatType,
      });
      setNewCatName("");
      loadCategories();
      onUpdate();
    } catch (error) {
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async (id: number, replacement?: string) => {
    // Direct delete (called from confirm UI)
    try {
      // Need to pass replacement in body if it exists. Note: axios delete config for body is distinct.
      await api.delete(`/categoria-financeira/${id}`, {
        data: { replacementCategory: replacement },
      });

      // Success
      setConflictData(null);
      setReplacementCat("");
      setDeleteConfirmId(null);
      loadCategories();
      onUpdate();
    } catch (error: any) {
      if (error.response && error.response.status === 409) {
        setDeleteConfirmId(null); // Close simple delete confirm
        setConflictData({
          id,
          message: error.response.data.message,
          count: error.response.data.usageCount,
        });
        // Set default replacement to first available
        const firstAvailable = categories.find((c) => c.id_categoria !== id);
        if (firstAvailable) setReplacementCat(firstAvailable.nome);
      } else {
        console.error(error);
      }
    } finally {
      // clean up state if needed
    }
  };

  const startEditing = (cat: Category) => {
    setEditingCatId(cat.id_categoria);
    setEditName(cat.nome);
    setEditType(cat.tipo);
  };

  const handleEdit = async (id: number) => {
    try {
      // Optimistic update for UI responsiveness
      setCategories(
        categories.map((c) =>
          c.id_categoria === id ? { ...c, nome: editName, tipo: editType } : c,
        ),
      );
      setEditingCatId(null);

      await api.put(`/categoria-financeira/${id}`, {
        nome: editName,
        tipo: editType,
      });
      loadCategories();
      onUpdate();
    } catch (error) {
      console.error(error);
      loadCategories(); // Revert on error
    }
  };

  if (!isOpen) return null;

  return (
    <Modal title="Gerenciar Categorias" onClose={onClose} className="max-w-md">
      {conflictData ? (
        <div className="bg-orange-50 border border-orange-100 p-4 rounded-xl mb-6">
          <div className="flex items-center gap-3 text-orange-600 mb-2">
            <AlertTriangle size={20} />
            <h3 className="font-bold">Categoria em uso</h3>
          </div>
          <p className="text-sm text-neutral-600 mb-4">
            {conflictData.message}
          </p>

          <label className="block text-[10px] font-bold text-neutral-400 uppercase mb-1">
            Substituir por:
          </label>
          <select
            value={replacementCat}
            onChange={(e) => setReplacementCat(e.target.value)}
            className="w-full bg-white border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-orange-300 mb-4"
          >
            {categories
              .filter((c) => c.id_categoria !== conflictData.id)
              .map((c) => (
                <option key={c.id_categoria} value={c.nome}>
                  {c.nome}
                </option>
              ))}
          </select>
          <div className="flex gap-2">
            <Button
              variant="ghost"
              onClick={() => setConflictData(null)}
              className="flex-1"
            >
              Cancelar
            </Button>
            <Button
              onClick={() => handleDelete(conflictData.id, replacementCat)}
              className="flex-1 bg-orange-500 hover:bg-orange-600 text-neutral-25 shadow-orange-200"
            >
              Confirmar Troca
            </Button>
          </div>
        </div>
      ) : deleteConfirmId ? (
        <div className="bg-red-50 border border-red-100 p-4 rounded-xl mb-6 animate-in fade-in zoom-in duration-200">
          <div className="flex items-center gap-3 text-red-600 mb-2">
            <Trash2 size={20} />
            <h3 className="font-bold">Excluir Categoria?</h3>
          </div>
          <p className="text-sm text-neutral-600 mb-4">
            Esta a√ß√£o n√£o pode ser desfeita. Se houver lan√ßamentos vinculados,
            voc√™ precisar√° escolher um substituto.
          </p>
          <div className="flex gap-2">
            <Button
              variant="ghost"
              onClick={() => setDeleteConfirmId(null)}
              className="flex-1"
            >
              Cancelar
            </Button>
            <Button
              variant="danger"
              onClick={() => handleDelete(deleteConfirmId)}
              className="flex-1"
            >
              Sim, Excluir
            </Button>
          </div>
        </div>
      ) : (
        <>
          <form onSubmit={handleAdd} className="flex gap-2 mb-6">
            <div className="flex-1">
              <Input
                value={newCatName}
                onChange={(e) => setNewCatName(e.target.value)}
                placeholder="Nova categoria..."
                required
              />
            </div>
            <div className="w-24">
              <div className="relative">
                <select
                  value={newCatType}
                  onChange={(e) => setNewCatType(e.target.value)}
                  className="w-full bg-neutral-50 border border-neutral-200 p-[11px] rounded-xl font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all cursor-pointer"
                >
                  <option value="AMBOS">Ambos</option>
                  <option value="ENTRADA">Entrada</option>
                  <option value="SAIDA">Sa√≠da</option>
                </select>
              </div>
            </div>
            <Button
              type="submit"
              disabled={loading}
              variant="primary"
              className="px-3"
              icon={Plus}
            >
              Criar
            </Button>
          </form>

          <div className="max-h-[300px] overflow-y-auto space-y-2 pr-2 custom-scrollbar">
            {categories.map((cat) => (
              <div
                key={cat.id_categoria}
                className="flex justify-between items-center p-3 bg-neutral-50 rounded-xl border border-neutral-100 group hover:border-neutral-200 transition-colors"
              >
                {editingCatId === cat.id_categoria ? (
                  <div className="flex gap-2 w-full">
                    <input
                      value={editName}
                      onChange={(e) => setEditName(e.target.value)}
                      className="flex-1 bg-white border border-neutral-300 p-2 rounded-lg font-bold text-sm outline-none focus:border-primary-500"
                      autoFocus
                    />
                    <select
                      value={editType}
                      onChange={(e) => setEditType(e.target.value)}
                      className="w-24 bg-white border border-neutral-300 p-2 rounded-lg font-bold text-sm outline-none focus:border-primary-500"
                    >
                      <option value="AMBOS">Ambos</option>
                      <option value="ENTRADA">Entrada</option>
                      <option value="SAIDA">Sa√≠da</option>
                    </select>
                    <button
                      onClick={() => handleEdit(cat.id_categoria)}
                      className="bg-green-500 text-neutral-25 p-2 rounded-lg hover:bg-green-600 transition-all hover:scale-105 active:scale-95 shadow-sm"
                    >
                      <Save size={16} />
                    </button>
                    <button
                      onClick={() => setEditingCatId(null)}
                      className="bg-neutral-200 text-neutral-600 p-2 rounded-lg hover:bg-neutral-300 transition-all hover:scale-105 active:scale-95"
                    >
                      <X size={16} />
                    </button>
                  </div>
                ) : (
                  <>
                    <div>
                      <p className="font-bold text-neutral-800">{cat.nome}</p>
                      <p className="text-[10px] uppercase font-bold text-neutral-400">
                        {cat.tipo}
                      </p>
                    </div>
                    <div className="flex gap-1">
                      <button
                        onClick={() => startEditing(cat)}
                        className="text-neutral-300 hover:text-primary-500 transition-colors p-2 hover:bg-primary-50 rounded-lg"
                      >
                        <Edit size={16} />
                      </button>
                      <button
                        onClick={() => setDeleteConfirmId(cat.id_categoria)}
                        className="text-neutral-300 hover:text-red-500 transition-colors p-2 hover:bg-red-50 rounded-lg"
                      >
                        <Trash2 size={16} />
                      </button>
                    </div>
                  </>
                )}
              </div>
            ))}
            {categories.length === 0 && (
              <p className="text-center text-neutral-400 text-sm py-4">
                Nenhuma categoria cadastrada.
              </p>
            )}
          </div>
        </>
      )}
    </Modal>
  );
};



================================================================================
FILE PATH: client\src\components\financeiro\ContasTab.tsx
================================================================================
import { useState, useEffect } from "react";
import { formatCurrency } from "../../utils/formatCurrency";
import { useNavigate } from "react-router-dom";
import { api } from "../../services/api";
import {
  Plus,
  Trash2,
  Landmark,
  Eye,
  EyeOff,
  FileText,
  Edit,
} from "lucide-react";
import type { IContaBancaria } from "../../types/backend";
import { StatusBanner } from "../ui/StatusBanner";
import { Button } from "../ui/Button";
import { Input } from "../ui/input";
import { Modal } from "../ui/Modal";
import { ActionButton } from "../ui/ActionButton";

export const ContasTab = () => {
  const navigate = useNavigate();
  const [accounts, setAccounts] = useState<IContaBancaria[]>([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingAccount, setEditingAccount] = useState<IContaBancaria | null>(
    null,
  );
  const [formData, setFormData] = useState<Partial<IContaBancaria>>({
    nome: "",
    banco: "",
    agencia: "",
    conta: "",
    saldo_atual: 0,
    ativo: true,
  });
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });
  const [showBalance, setShowBalance] = useState<Record<number, boolean>>({});

  useEffect(() => {
    loadAccounts();
  }, []);

  const loadAccounts = async () => {
    try {
      const res = await api.get("/conta-bancaria");
      setAccounts(res.data);
    } catch (error) {
      console.error(error);
      setStatusMsg({
        type: "error",
        text: "Erro ao carregar contas banc√°rias.",
      });
    }
  };

  const handleOpenCreate = () => {
    setEditingAccount(null);
    setFormData({
      nome: "",
      banco: "",
      agencia: "",
      conta: "",
      saldo_atual: 0,
      ativo: true,
    });
    setIsModalOpen(true);
  };

  const handleOpenEdit = (acc: IContaBancaria) => {
    setEditingAccount(acc);
    setFormData({
      nome: acc.nome,
      banco: acc.banco || "",
      agencia: acc.agencia || "",
      conta: acc.conta || "",
      saldo_atual: Number(acc.saldo_atual),
      ativo: acc.ativo,
    });
    setIsModalOpen(true);
  };

  const handleOpenStatement = (acc: IContaBancaria) => {
    navigate(`/financeiro/extrato/${acc.id_conta}`);
  };

  const handleSubmit = async () => {
    try {
      if (editingAccount) {
        await api.put(`/conta-bancaria/${editingAccount.id_conta}`, formData);
        setStatusMsg({
          type: "success",
          text: "Conta atualizada com sucesso!",
        });
      } else {
        await api.post("/conta-bancaria", formData);
        setStatusMsg({ type: "success", text: "Conta criada com sucesso!" });
      }
      setIsModalOpen(false);
      loadAccounts();
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: "error", text: "Erro ao salvar conta." });
    }
  };

  const toggleDelete = async (acc: IContaBancaria) => {
    if (
      !window.confirm(
        `Tem certeza que deseja ${acc.ativo ? "desativar" : "ativar"} esta conta?`,
      )
    )
      return;
    try {
      await api.put(`/conta-bancaria/${acc.id_conta}`, { ativo: !acc.ativo });
      loadAccounts();
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao alterar status da conta." });
    }
  };

  const toggleBalanceVisibility = (id: number) => {
    setShowBalance((prev) => ({ ...prev, [id]: !prev[id] }));
  };

  return (
    <div className="p-6">
      <StatusBanner
        msg={statusMsg}
        onClose={() => setStatusMsg({ type: null, text: "" })}
      />

      <div className="flex justify-between items-center mb-8">
        <div>
          <h2 className="text-xl font-bold text-neutral-800">
            Contas Banc√°rias e Caixas
          </h2>
          <p className="text-neutral-500 text-sm">
            Gerencie onde o dinheiro entra e sai.
          </p>
        </div>
        <Button
          onClick={handleOpenCreate}
          variant="primary"
          icon={Plus}
          className="shadow-lg shadow-primary-500/20"
        >
          Nova Conta
        </Button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        {accounts.map((acc) => (
          <div
            key={acc.id_conta}
            className={`bg-surface p-6 rounded-xl border ${acc.ativo ? "border-neutral-200" : "border-neutral-100 opacity-60"} shadow-sm relative group hover:border-blue-200 transition-all`}
          >
            <div className="flex justify-between items-start mb-4">
              <div className="bg-neutral-100 p-3 rounded-xl text-neutral-600">
                <Landmark size={24} />
              </div>
              <div className="flex gap-2">
                <ActionButton
                  onClick={() => handleOpenEdit(acc)}
                  icon={Edit}
                  label="Editar"
                  className="opacity-0 group-hover:opacity-100 transition-opacity translate-y-2 group-hover:translate-y-0"
                  variant="neutral"
                />
                <ActionButton
                  onClick={() => toggleDelete(acc)}
                  icon={Trash2}
                  variant="danger"
                  label={acc.ativo ? "Desativar" : "Ativar"}
                  className="opacity-0 group-hover:opacity-100 transition-opacity translate-y-2 group-hover:translate-y-0"
                />
              </div>
            </div>

            <div className="mb-4">
              <h3 className="font-bold text-lg text-neutral-900 truncate">
                {acc.nome}
              </h3>
              <p className="text-xs text-neutral-500 font-medium uppercase tracking-wider">
                {acc.banco || "Caixa F√≠sico"}
              </p>
            </div>

            <div className="bg-neutral-50 p-4 rounded-xl mb-4">
              <div className="flex justify-between items-center mb-1">
                <span className="text-[10px] font-bold text-neutral-400 uppercase">
                  Saldo Atual
                </span>
                <button
                  onClick={() => toggleBalanceVisibility(acc.id_conta)}
                  className="text-neutral-400 hover:text-neutral-600"
                >
                  {showBalance[acc.id_conta] ? (
                    <EyeOff size={14} />
                  ) : (
                    <Eye size={14} />
                  )}
                </button>
              </div>
              <div
                className={`text-2xl font-black ${Number(acc.saldo_atual) < 0 ? "text-red-600" : "text-neutral-900"}`}
              >
                {showBalance[acc.id_conta]
                  ? formatCurrency(Number(acc.saldo_atual))
                  : "----"}
              </div>
            </div>

            <Button
              onClick={() => handleOpenStatement(acc)}
              variant="secondary"
              className="w-full"
              icon={FileText}
            >
              Ver Extrato
            </Button>

            {!acc.ativo && (
              <div className="absolute top-4 right-4 bg-red-100 text-red-600 text-[10px] font-bold px-2 py-1 rounded-md uppercase">
                Inativo
              </div>
            )}
          </div>
        ))}

        {/* Empty State Card */}
        <button
          onClick={handleOpenCreate}
          className="border-2 border-dashed border-neutral-200 rounded-xl p-6 flex flex-col items-center justify-center gap-4 text-neutral-400 hover:border-neutral-300 hover:bg-neutral-50 transition-all min-h-[250px] group"
        >
          <div className="bg-neutral-100 p-4 rounded-full group-hover:bg-neutral-200 transition-colors">
            <Plus size={24} />
          </div>
          <span className="font-bold text-sm">Adicionar Conta</span>
        </button>
      </div>

      {/* MODAL EDIT/CREATE */}
      {isModalOpen && (
        <Modal
          title={editingAccount ? "Editar Conta" : "Nova Conta"}
          onClose={() => setIsModalOpen(false)}
        >
          <div className="space-y-4">
            <div>
              <Input
                label="Nome / Apelido"
                required
                value={formData.nome}
                onChange={(e) =>
                  setFormData({ ...formData, nome: e.target.value })
                }
                placeholder="Ex: Nubank, Caixa Gaveta..."
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Input
                  label="Banco (Opcional)"
                  value={formData.banco || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, banco: e.target.value })
                  }
                />
              </div>
              <div>
                <Input
                  label="Saldo Inicial (R$)"
                  type="number"
                  step="0.01"
                  disabled={!!editingAccount}
                  value={formData.saldo_atual}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      saldo_atual: Number(e.target.value),
                    })
                  }
                />
                {editingAccount && (
                  <p className="text-[10px] text-neutral-400 mt-1">
                    Ajuste via Movimenta√ß√µes.
                  </p>
                )}
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Input
                  label="Ag√™ncia"
                  value={formData.agencia || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, agencia: e.target.value })
                  }
                />
              </div>
              <div>
                <Input
                  label="Conta"
                  value={formData.conta || ""}
                  onChange={(e) =>
                    setFormData({ ...formData, conta: e.target.value })
                  }
                />
              </div>
            </div>

            {!editingAccount && (
              <div className="p-4 bg-yellow-50 text-yellow-800 text-xs rounded-xl font-medium">
                Aten√ß√£o: O saldo inicial ser√° registrado como primeira
                movimenta√ß√£o se for maior que zero.
              </div>
            )}

            <div className="pt-4 flex justify-end gap-3">
              <Button variant="ghost" onClick={() => setIsModalOpen(false)}>
                Cancelar
              </Button>
              <Button
                onClick={handleSubmit}
                variant="primary"
                className="shadow-lg shadow-primary-500/20"
              >
                {editingAccount ? "Salvar" : "Criar Conta"}
              </Button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\components\financeiro\MovimentacoesTab.tsx
================================================================================
import { useState, useEffect } from "react";
import { formatCurrency } from "../../utils/formatCurrency";
import { api } from "../../services/api";
import {
  Plus,
  Search,
  ArrowUpCircle,
  ArrowDownCircle,
  Calendar,
  Trash2,
  Settings,
  Wallet,
  Edit,
  AlertTriangle,
} from "lucide-react";
import { StatusBanner } from "../ui/StatusBanner";
import { CategoryManager } from "./CategoryManager";
import { Button } from "../ui/Button";
import { Input } from "../ui/input";
import { Modal } from "../ui/Modal";
import { ActionButton } from "../ui/ActionButton";

interface CashBookEntry {
  id: string; // 'man-1', 'in-5', 'out-10' (prefix to identify source)
  rawId: number;
  date: string; // ISO date string
  description: string;
  type: "IN" | "OUT";
  value: number;
  category: string;
  vehicle?: string;
  client?: string;
  supplier?: string; // New field
  obs?: string;
  source: "MANUAL" | "AUTO";
  deleted_at?: string | null;
  originalData?: any;
  // New fields
  conta_bancaria?: string;
  paymentMethod?: string;
}

interface Category {
  id_categoria: number;
  nome: string;
  tipo: string;
}

export const MovimentacoesTab = () => {
  const [cashBookEntries, setCashBookEntries] = useState<CashBookEntry[]>([]);
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  // Filters
  const [cashSearch, setCashSearch] = useState("");
  const [cashFilterStart, setCashFilterStart] = useState(
    new Date().toLocaleDateString("en-CA"),
  );
  const [cashFilterEnd, setCashFilterEnd] = useState(
    new Date().toLocaleDateString("en-CA"),
  );
  const [filterSource, setFilterSource] = useState<"ALL" | "MANUAL" | "AUTO">(
    "ALL",
  );
  const [filterCategory, setFilterCategory] = useState<string>("ALL");
  const [activeQuickFilter, setActiveQuickFilter] = useState<
    "TODAY" | "WEEK" | "MONTH"
  >("TODAY");

  // Modals
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
  const [editingItem, setEditingItem] = useState<CashBookEntry | null>(null);
  const [itemToDelete, setItemToDelete] = useState<CashBookEntry | null>(null);
  const [deleteObs, setDeleteObs] = useState("");

  // Category Management
  const [categories, setCategories] = useState<Category[]>([]);
  const [isCategoryModalOpen, setIsCategoryModalOpen] = useState(false);

  // Form
  const [formData, setFormData] = useState({
    descricao: "",
    valor: "",
    tipo_movimentacao: "ENTRADA",
    categoria: "OUTROS",
    obs: "",
  });

  useEffect(() => {
    loadData();
    loadCategories();
  }, []);

  const loadCategories = async () => {
    try {
      const res = await api.get("/categoria-financeira");
      setCategories(res.data);
    } catch (error) {
      console.error(error);
    }
  };

  const loadData = async () => {
    try {
      const [manualRes, paymentsRes, inflowsRes, opsRes] = await Promise.all([
        api.get("/livro-caixa"),
        api.get("/pagamento-peca"),
        api.get("/pagamento-cliente"),
        api.get("/operadora-cartao"),
      ]);

      // Build Operators Map
      const opMap: Record<number, string> = {};
      (opsRes.data || []).forEach((op: any) => {
        opMap[op.id_operadora] = op.nome;
      });

      // Build Payment Map (Link LivroCaixa ID -> Payment Data)
      const lcPaymentMap: Record<number, any> = {};
      (inflowsRes.data || []).forEach((p: any) => {
        if (p.id_livro_caixa) {
          lcPaymentMap[p.id_livro_caixa] = p;
        }
      });

      // 1. Manual Entries (from Libro Caixa)
      // Enrich with values from Linked Payment if available
      const manual = manualRes.data
        .filter((e: any) => e.categoria !== "CONCILIACAO_CARTAO")
        .map((e: any) => {
          const linkedP = lcPaymentMap[e.id_livro_caixa];
          let methodDisplay = null;

          if (linkedP) {
            // Enrich from Linked Payment
            const method = linkedP.metodo_pagamento;
            if (method === "CREDITO") {
              const opName =
                opMap[linkedP.id_operadora] ||
                linkedP.bandeira_cartao ||
                "Cart√£o";
              const parc =
                linkedP.qtd_parcelas > 1
                  ? ` (${linkedP.qtd_parcelas}x)`
                  : " (√Ä Vista)";
              methodDisplay = `CR√âDITO ${opName}${parc}`;
            } else if (method === "DEBITO") {
              const opName =
                opMap[linkedP.id_operadora] ||
                linkedP.bandeira_cartao ||
                "Cart√£o";
              methodDisplay = `D√âBITO ${opName}`;
            } else if (method === "PIX") {
              const nsu = linkedP.codigo_transacao
                ? ` | ID: ${linkedP.codigo_transacao}`
                : "";
              const bankInfo = linkedP.conta_bancaria?.nome
                ? ` (${linkedP.conta_bancaria.nome})`
                : "";
              methodDisplay = `PIX${bankInfo}${nsu}`;
            } else if (method === "DINHEIRO") {
              const bankInfo = linkedP.conta_bancaria?.nome
                ? ` (${linkedP.conta_bancaria.nome})`
                : "";
              methodDisplay = `DINHEIRO${bankInfo}`;
            }
          }

          return {
            id: `man-${e.id_livro_caixa}`,
            rawId: e.id_livro_caixa,
            date: e.dt_movimentacao,
            description: e.descricao,
            type: e.tipo_movimentacao === "ENTRADA" ? "IN" : "OUT",
            value: Number(e.valor),
            category: e.category || e.categoria,
            obs: e.obs,
            source: e.origem === "AUTOMATICA" ? "AUTO" : "MANUAL",
            deleted_at: e.deleted_at,
            originalData: e,
            conta_bancaria: e.conta ? e.conta.nome : null,
            paymentMethod: methodDisplay, // Enriched info
          };
        });

      // 2. Auto Outflows (Payments to Suppliers)
      const outflows = paymentsRes.data
        .filter(
          (p: any) =>
            (p.pago_ao_fornecedor && p.data_pagamento_fornecedor) ||
            p.deleted_at,
        )
        .map((p: any) => {
          const os = p.item_os?.ordem_de_servico;
          const veh = os?.veiculo;
          const cli = os?.cliente;
          const clientName =
            cli?.pessoa_fisica?.pessoa?.nome ||
            cli?.pessoa_juridica?.nome_fantasia ||
            cli?.pessoa_juridica?.razao_social ||
            "Desconhecido";
          const vehicleText = veh
            ? `${veh.placa} - ${veh.modelo} (${veh.cor})`
            : "";
          const supplierName = p.fornecedor?.nome || "Fornecedor";

          return {
            id: `out-${p.id_pagamento_peca}`,
            rawId: p.id_pagamento_peca,
            date: p.data_pagamento_fornecedor || p.data_compra,
            description: `OS #${p.item_os?.id_os || "?"} - ${veh?.modelo || "V"} ${veh?.cor || ""} (${veh?.placa || "?"}) - ${p.item_os?.descricao || "Pe√ßa"}`,
            type: "OUT",
            value: Number(p.custo_real),
            category: "Auto Pe√ßas",
            vehicle: vehicleText,
            client: clientName,
            supplier: supplierName,
            obs: "",
            source: "AUTO",
            deleted_at: p.deleted_at,
            originalData: p,
          };
        });

      // 3. Auto Inflows (Payments from Clients)
      const inflows = (inflowsRes.data || [])
        .filter((p: any) => !p.id_livro_caixa) // Prevent duplicates if already in LC
        .map((p: any) => {
          const os = p.ordem_de_servico;
          const veh = os?.veiculo;
          const cli = os?.cliente;
          const clientName =
            cli?.pessoa_fisica?.pessoa?.nome ||
            cli?.pessoa_juridica?.nome_fantasia ||
            cli?.pessoa_juridica?.razao_social ||
            "Desconhecido";
          const vehicleText = veh
            ? `${veh.placa} - ${veh.modelo} (${veh.cor})`
            : "";

          // Determine display method
          let methodDisplay = p.metodo_pagamento;
          let opName = null;

          if (methodDisplay === "CREDITO") {
            opName = opMap[p.id_operadora] || p.bandeira_cartao || "Cart√£o";
            const parc =
              p.qtd_parcelas > 1 ? ` (${p.qtd_parcelas}x)` : " (√Ä Vista)";
            const nsu = p.codigo_transacao
              ? ` | NSU/Aut: ${p.codigo_transacao}`
              : "";
            methodDisplay = `CR√âDITO ${opName}${parc} - ${p.bandeira_cartao || ""}${nsu}`;
          }
          if (methodDisplay === "DEBITO") {
            opName = opMap[p.id_operadora] || p.bandeira_cartao || "Cart√£o";
            const nsu = p.codigo_transacao
              ? ` | NSU/Aut: ${p.codigo_transacao}`
              : "";
            methodDisplay = `D√âBITO ${opName} - ${p.bandeira_cartao || ""}${nsu}`;
          }
          if (methodDisplay === "PIX") {
            const nsu = p.codigo_transacao
              ? ` | ID: ${p.codigo_transacao}`
              : "";
            const bankInfo = p.conta_bancaria?.nome
              ? ` (${p.conta_bancaria.nome})`
              : "";
            methodDisplay = `PIX${bankInfo}${nsu}`;
          }
          if (methodDisplay === "DINHEIRO") {
            const bankInfo = p.conta_bancaria?.nome
              ? ` (${p.conta_bancaria.nome})`
              : "";
            methodDisplay = `DINHEIRO${bankInfo}`;
          }
          const contaDisplay = p.conta_bancaria
            ? p.conta_bancaria.nome
            : opName || null;

          return {
            id: `in-${p.id_pagamento_cliente}`,
            rawId: p.id_pagamento_cliente,
            date: p.data_pagamento,
            description: `Recebimento: OS #${p.id_os}`,
            type: "IN",
            value: Number(p.valor),
            category: "Receita de Servi√ßos",
            vehicle: vehicleText,
            client: clientName,
            obs: p.observacao || "",
            source: "AUTO",
            deleted_at: p.deleted_at,
            originalData: p,
            // Store method + account for display
            paymentMethod: methodDisplay,
            conta_bancaria: contaDisplay,
          };
        });

      const combined = [...manual, ...outflows, ...inflows].sort(
        (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime(),
      );
      setCashBookEntries(combined);
    } catch (error) {
      console.error(error);
      setStatusMsg({
        type: "error",
        text: "Erro ao carregar dados financeiros.",
      });
    }
  };

  // Filter Logic
  const filteredCashBook = cashBookEntries.filter((entry) => {
    if (filterSource !== "ALL") {
      if (filterSource !== entry.source) return false;
    }
    if (filterCategory !== "ALL") {
      if (entry.category !== filterCategory) return false;
    }

    if (cashSearch) {
      const searchTerms = cashSearch
        .toLowerCase()
        .split(" ")
        .filter((term) => term.length > 0);
      const searchableText = [
        entry.description,
        entry.category,
        entry.vehicle,
        entry.client,
        entry.obs,
        `#${entry.rawId}`,
        String(entry.value),
        entry.conta_bancaria,
        entry.supplier,
        entry.paymentMethod,
        entry.type === "IN" ? "Entrada" : "Sa√≠da",
      ]
        .join(" ")
        .toLowerCase();

      // Check if ALL search terms are present in the searchable text
      return searchTerms.every((term) => searchableText.includes(term));
    }

    const recordDateLocal = new Date(entry.date).toLocaleDateString("en-CA");
    if (cashFilterStart && recordDateLocal < cashFilterStart) return false;
    if (cashFilterEnd && recordDateLocal > cashFilterEnd) return false;

    return true;
  });

  const totalInflow = filteredCashBook
    .filter((e) => e.type === "IN" && !e.deleted_at)
    .reduce((acc, e) => acc + e.value, 0);
  const totalOutflow = filteredCashBook
    .filter((e) => e.type === "OUT" && !e.deleted_at)
    .reduce((acc, e) => acc + e.value, 0);
  const balance = totalInflow - totalOutflow;

  const applyQuickFilter = (type: "TODAY" | "WEEK" | "MONTH") => {
    setActiveQuickFilter(type);
    const now = new Date();
    const todayStr = now.toLocaleDateString("en-CA"); // Ensure YYYY-MM-DD
    if (type === "TODAY") {
      setCashFilterStart(todayStr);
      setCashFilterEnd(todayStr);
    } else if (type === "WEEK") {
      const weekAgo = new Date(now);
      weekAgo.setDate(now.getDate() - 7);
      setCashFilterStart(weekAgo.toLocaleDateString("en-CA"));
      setCashFilterEnd(todayStr);
    } else if (type === "MONTH") {
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      setCashFilterStart(firstDay.toLocaleDateString("en-CA"));
      setCashFilterEnd(todayStr);
    }
  };

  const handleOpenCreate = () => {
    setEditingItem(null);
    setFormData({
      descricao: "",
      valor: "",
      tipo_movimentacao: "ENTRADA",
      categoria: "OUTROS",
      obs: "",
    });
    setIsModalOpen(true);
  };

  const handleOpenEdit = (entry: any) => {
    setEditingItem(entry);
    if (entry.source === "MANUAL") {
      setFormData({
        descricao: entry.originalData.descricao,
        valor: entry.originalData.valor,
        tipo_movimentacao: entry.originalData.tipo_movimentacao,
        categoria: entry.originalData.categoria,
        obs: entry.originalData.obs || "",
      });
    } else if (entry.source === "AUTO") {
      setFormData({
        descricao: entry.description,
        valor: entry.originalData.custo_real || entry.originalData.valor,
        tipo_movimentacao: entry.type === "IN" ? "ENTRADA" : "SAIDA",
        categoria: entry.category,
        obs: entry.obs,
      });
    }

    setIsModalOpen(true);
  };

  const handleOpenDelete = (entry: any) => {
    setItemToDelete(entry);
    setDeleteObs("");
    setIsDeleteModalOpen(true);
  };

  const handleSubmit = async () => {
    try {
      if (editingItem) {
        if (editingItem.id.startsWith("man-")) {
          await api.put(`/livro-caixa/${editingItem.rawId}`, formData);
        } else if (editingItem.id.startsWith("in-")) {
          await api.put(`/pagamento-cliente/${editingItem.rawId}`, {
            valor: formData.valor,
          });
        } else if (editingItem.id.startsWith("out-")) {
          await api.put(`/pagamento-peca/${editingItem.rawId}`, {
            custo_real: formData.valor,
          });
        }
        setStatusMsg({ type: "success", text: "Lan√ßamento atualizado!" });
      } else {
        await api.post("/livro-caixa", { ...formData, origem: "MANUAL" });
        setStatusMsg({ type: "success", text: "Lan√ßamento criado!" });
      }
      setIsModalOpen(false);
      loadData();
    } catch (err) {
      console.error(err);
      setStatusMsg({ type: "error", text: "Erro ao salvar lan√ßamento." });
    }
  };

  const handleDelete = async () => {
    if (!itemToDelete) return;
    try {
      if (itemToDelete.id.startsWith("man-")) {
        await api.delete(`/livro-caixa/${itemToDelete.rawId}`, {
          data: { obs: deleteObs },
        });
      } else if (itemToDelete.id.startsWith("in-")) {
        await api.delete(`/pagamento-cliente/${itemToDelete.rawId}`);
      } else if (itemToDelete.id.startsWith("out-")) {
        await api.delete(`/pagamento-peca/${itemToDelete.rawId}`);
      }

      setStatusMsg({
        type: "success",
        text: "Lan√ßamento deletado (estornado).",
      });
      setIsDeleteModalOpen(false);
      loadData();
    } catch (err) {
      console.error(err);
      setStatusMsg({ type: "error", text: "Erro ao deletar lan√ßamento." });
    }
  };

  const getQuickFilterClass = (type: "TODAY" | "WEEK" | "MONTH") =>
    `flex-1 px-2 py-1.5 rounded-lg text-[10px] font-bold uppercase transition-all ${
      activeQuickFilter === type
        ? "bg-primary-200 text-primary-500 shadow-sm"
        : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
    }`;

  return (
    <div className="p-6 space-y-6 animate-in fade-in duration-500 relative">
      <StatusBanner
        msg={statusMsg}
        onClose={() => setStatusMsg({ type: null, text: "" })}
      />

      <CategoryManager
        isOpen={isCategoryModalOpen}
        onClose={() => setIsCategoryModalOpen(false)}
        onUpdate={() => {
          loadCategories();
        }}
      />

      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h2 className="text-xl font-bold text-neutral-800">
            Hist√≥rico de Movimenta√ß√µes
          </h2>
          <p className="text-neutral-500 text-sm">
            Registro completo de entradas e sa√≠das.
          </p>
        </div>
        <Button
          variant="secondary"
          onClick={() => setIsCategoryModalOpen(true)}
          icon={Settings}
        >
          Categorias
        </Button>
      </div>

      <div className="space-y-6">
        {/* Filters Board */}
        <div className="bg-surface p-6 rounded-xl border border-neutral-200 shadow-sm flex flex-col xl:flex-row justify-between items-end gap-6">
          <div className="w-full grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
            {/* Search */}
            <div className="md:col-span-3">
              <Input
                label="Buscar"
                value={cashSearch}
                onChange={(e) => setCashSearch(e.target.value)}
                placeholder="Pesquisar..."
                icon={Search}
              />
            </div>

            {/* Dates */}
            <div className="md:col-span-4 flex gap-2">
              <div className="flex-1">
                <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1.5 block">
                  De
                </label>
                <input
                  type="date"
                  value={cashFilterStart}
                  onChange={(e) => {
                    setCashFilterStart(e.target.value);
                    setActiveQuickFilter(null as any); // Clear quick filter
                  }}
                  className={`w-full h-[42px] px-3 rounded-lg border text-sm font-bold bg-white focus:outline-none focus:ring-2 focus:ring-primary-200 transition-colors uppercase ${
                    activeQuickFilter
                      ? "border-neutral-200 text-neutral-600"
                      : "border-primary-300 text-primary-700"
                  }`}
                />
              </div>
              <div className="flex-1">
                <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1.5 block">
                  At√©
                </label>
                <input
                  type="date"
                  value={cashFilterEnd}
                  onChange={(e) => {
                    setCashFilterEnd(e.target.value);
                    setActiveQuickFilter(null as any);
                  }}
                  className={`w-full h-[42px] px-3 rounded-lg border text-sm font-bold bg-white focus:outline-none focus:ring-2 focus:ring-primary-200 transition-colors uppercase ${
                    activeQuickFilter
                      ? "border-neutral-200 text-neutral-600"
                      : "border-primary-300 text-primary-700"
                  }`}
                />
              </div>
            </div>

            {/* Quick Filters */}
            <div className="md:col-span-5 flex items-center justify-end">
              <div className="w-full">
                <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1.5 block">
                  Per√≠odo
                </label>
                <div className="flex bg-neutral-100 p-1 rounded-xl h-[42px] items-center w-full">
                  <button
                    onClick={() => applyQuickFilter("TODAY")}
                    className={getQuickFilterClass("TODAY")}
                  >
                    Hoje
                  </button>
                  <button
                    onClick={() => applyQuickFilter("WEEK")}
                    className={getQuickFilterClass("WEEK")}
                  >
                    Semana
                  </button>
                  <button
                    onClick={() => applyQuickFilter("MONTH")}
                    className={getQuickFilterClass("MONTH")}
                  >
                    M√™s
                  </button>
                </div>
              </div>
            </div>

            {/* Source Filter */}
            <div className="md:col-span-2">
              <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1.5 block">
                Origem
              </label>
              <div className="relative">
                <select
                  value={filterSource}
                  onChange={(e) => setFilterSource(e.target.value as any)}
                  className="w-full h-[42px] bg-neutral-50 border border-neutral-200 px-3 rounded-lg font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all appearance-none cursor-pointer"
                >
                  <option value="ALL">Todas</option>
                  <option value="MANUAL">Manual</option>
                  <option value="AUTO">Autom√°tica</option>
                </select>
                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-neutral-500">
                  <ArrowDownCircle size={14} />
                </div>
              </div>
            </div>

            {/* Category Filter */}
            <div className="md:col-span-3">
              <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1.5 block">
                Categoria
              </label>
              <div className="relative">
                <select
                  value={filterCategory}
                  onChange={(e) => setFilterCategory(e.target.value)}
                  className="w-full h-[42px] bg-neutral-50 border border-neutral-200 px-3 rounded-lg font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all appearance-none cursor-pointer"
                >
                  <option value="ALL">Todas</option>
                  {categories.map((cat) => (
                    <option key={cat.id_categoria} value={cat.nome}>
                      {cat.nome}
                    </option>
                  ))}
                </select>
                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-neutral-500">
                  <ArrowDownCircle size={14} />
                </div>
              </div>
            </div>

            <div className="md:col-span-2">
              <Button
                variant="primary"
                onClick={handleOpenCreate}
                className="w-full h-[42px] shadow-lg shadow-primary-500/20"
                icon={Plus}
              >
                Novo Lan√ßamento
              </Button>
            </div>
          </div>
        </div>

        {/* SUMMARY */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="bg-surface p-6 rounded-xl shadow-sm border border-neutral-200">
            <div className="flex items-center gap-3 mb-2">
              <div className="p-2 bg-emerald-50 text-emerald-600 rounded-lg">
                <ArrowDownCircle size={20} />
              </div>
              <p className="text-xs font-bold text-neutral-400 uppercase tracking-widest">
                Entradas
              </p>
            </div>
            <p className="text-3xl font-black text-emerald-600">
              {formatCurrency(totalInflow)}
            </p>
          </div>
          <div className="bg-surface p-6 rounded-xl shadow-sm border border-neutral-200">
            <div className="flex items-center gap-3 mb-2">
              <div className="p-2 bg-red-50 text-red-600 rounded-lg">
                <ArrowUpCircle size={20} />
              </div>
              <p className="text-xs font-bold text-neutral-400 uppercase tracking-widest">
                Sa√≠das
              </p>
            </div>
            <p className="text-3xl font-black text-red-600">
              {formatCurrency(totalOutflow)}
            </p>
          </div>
          <div className="bg-neutral-800 p-6 rounded-xl shadow-xl text-neutral-25">
            <div className="flex items-center gap-3 mb-2">
              <div className="p-2 bg-neutral-800 text-neutral-400 rounded-lg">
                <Wallet size={20} />
              </div>
              <p className="text-xs font-bold text-neutral-400 uppercase tracking-widest">
                Saldo
              </p>
            </div>
            <p
              className={`text-3xl font-bold ${balance >= 0 ? "text-neutral-25" : "text-red-400"}`}
            >
              {formatCurrency(balance)}
            </p>
          </div>
        </div>

        {/* TABLE */}
        <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden w-full">
          <table className="w-full text-left border-collapse">
            <thead className="bg-neutral-50 border-b border-neutral-200 text-xs uppercase tracking-wider text-neutral-500 font-semibold">
              <tr>
                <th className="p-4">Data</th>
                <th className="p-4">Descri√ß√£o</th>
                <th className="p-4">Tipo</th>
                <th className="p-4">Categoria</th>
                <th className="p-4">Conta / Origem</th>
                <th className="p-4 text-right whitespace-nowrap min-w-[150px]">
                  Valor
                </th>
                <th className="p-4 font-bold text-neutral-400 uppercase text-[10px] tracking-widest">
                  Obs
                </th>
                <th className="p-4 text-center">A√ß√µes</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-neutral-100">
              {filteredCashBook.length === 0 ? (
                <tr>
                  <td
                    colSpan={8}
                    className="p-12 text-center text-neutral-400 italic font-medium"
                  >
                    Nenhuma movimenta√ß√£o encontrada.
                  </td>
                </tr>
              ) : (
                filteredCashBook.map((entry) => (
                  <tr
                    key={entry.id}
                    className={`hover:bg-neutral-50 transition-colors ${entry.deleted_at ? "opacity-50" : ""}`}
                  >
                    <td className="p-4">
                      <div
                        className={`flex items-center gap-2 font-bold text-xs ${entry.deleted_at ? "line-through text-neutral-400" : "text-neutral-600"}`}
                      >
                        <Calendar size={14} />
                        {new Date(entry.date).toLocaleDateString("pt-BR")}
                        <span className="text-[10px] text-neutral-400">
                          {new Date(entry.date).toLocaleTimeString("pt-BR", {
                            hour: "2-digit",
                            minute: "2-digit",
                          })}
                        </span>
                      </div>
                    </td>
                    <td
                      className={`p-4 font-bold ${entry.deleted_at ? "line-through text-neutral-400" : "text-neutral-900"}`}
                    >
                      <div className="text-sm">{entry.description}</div>
                      {entry.source === "AUTO" && (
                        <div className="text-[10px] text-neutral-400 font-medium mt-0.5">
                          {entry.type === "OUT" ? (
                            <span>Pago a: {entry.supplier}</span>
                          ) : (
                            <span>
                              {entry.client}{" "}
                              {entry.vehicle ? `| ${entry.vehicle}` : ""}
                            </span>
                          )}
                        </div>
                      )}
                      {/* Show manual obs if exists */}
                      {entry.source === "MANUAL" && entry.obs && (
                        <div className="text-[10px] text-neutral-400 font-medium mt-0.5 italic">
                          {entry.obs}
                        </div>
                      )}
                    </td>
                    <td className="p-4">
                      <span
                        className={`px-2 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider ${
                          entry.deleted_at
                            ? "bg-neutral-100 text-neutral-500 line-through"
                            : entry.type === "IN"
                              ? "bg-emerald-50 text-emerald-700"
                              : "bg-red-50 text-red-700"
                        }`}
                      >
                        {entry.deleted_at
                          ? "CANCELADO"
                          : entry.type === "IN"
                            ? "Entrada"
                            : "Sa√≠da"}{" "}
                        ({entry.source === "MANUAL" ? "M" : "A"})
                      </span>
                    </td>
                    <td className="p-4">
                      <span className="bg-neutral-100 text-neutral-600 px-2 py-1 rounded text-xs font-bold uppercase tracking-wide">
                        {entry.category}
                      </span>
                    </td>
                    <td className="p-4">
                      <div className="flex flex-col">
                        <span className="text-xs font-bold text-neutral-700">
                          {entry.conta_bancaria || "Caixa Geral / Indefinido"}
                        </span>
                        {entry.paymentMethod && (
                          <span className="text-[10px] text-neutral-400 font-bold uppercase mt-0.5">
                            {entry.paymentMethod}
                          </span>
                        )}
                      </div>
                    </td>
                    <td
                      className={`p-4 text-right font-black text-sm whitespace-nowrap ${
                        entry.deleted_at
                          ? "line-through text-neutral-400"
                          : entry.type === "IN"
                            ? "text-emerald-600"
                            : "text-red-600"
                      }`}
                    >
                      {entry.type === "IN" ? "+ " : "- "}
                      {formatCurrency(entry.value)}
                    </td>
                    <td className="p-4">
                      {entry.obs ? (
                        <span
                          className="text-xs text-neutral-500 italic truncate max-w-[150px] block"
                          title={entry.obs}
                        >
                          {entry.obs}
                        </span>
                      ) : (
                        <span className="text-neutral-300">-</span>
                      )}
                    </td>
                    <td className="p-4 text-center">
                      {!entry.deleted_at && (
                        <div className="flex items-center justify-center gap-2">
                          <ActionButton
                            icon={Edit}
                            onClick={() => handleOpenEdit(entry)}
                            label="Editar"
                            variant="neutral"
                          />
                          <ActionButton
                            icon={Trash2}
                            onClick={() => handleOpenDelete(entry)}
                            label="Excluir"
                            variant="danger"
                          />
                        </div>
                      )}
                      {entry.deleted_at && (
                        <span className="text-[10px] font-bold text-red-300 uppercase">
                          Exclu√≠do
                        </span>
                      )}
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* CREATE/EDIT MODAL */}
      {isModalOpen && (
        <Modal
          title={editingItem ? "Editar Lan√ßamento" : "Novo Lan√ßamento"}
          onClose={() => setIsModalOpen(false)}
        >
          <div className="space-y-4">
            <div>
              <Input
                label="Descri√ß√£o"
                required
                value={formData.descricao}
                onChange={(e) =>
                  setFormData({ ...formData, descricao: e.target.value })
                }
                placeholder="Ex: Compra de Material, Cafezinho..."
                readOnly={editingItem?.source === "AUTO"} // Prevent edit desc if auto
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Input
                  label="Valor (R$)"
                  required
                  type="number"
                  step="0.01"
                  value={formData.valor}
                  onChange={(e) =>
                    setFormData({ ...formData, valor: e.target.value })
                  }
                  readOnly={editingItem?.source === "AUTO"} // Prevent edit value if auto (usually restricted)
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                  Tipo
                </label>
                <div className="relative">
                  <select
                    value={formData.tipo_movimentacao}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        tipo_movimentacao: e.target.value,
                      })
                    }
                    disabled={!!editingItem} // Usually can't change type after creation easily without messes, or enable it. Let's disable for safety or matching legacy.
                    className="w-full bg-neutral-50 border border-neutral-200 px-3 py-2.5 rounded-lg font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all appearance-none cursor-pointer disabled:opacity-50"
                  >
                    <option value="ENTRADA">Entrada (+)</option>
                    <option value="SAIDA">Sa√≠da (-)</option>
                  </select>
                  <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-neutral-500">
                    <ArrowDownCircle size={14} />
                  </div>
                </div>
              </div>
            </div>

            <div>
              <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                Categoria
              </label>
              <div className="relative">
                <select
                  value={formData.categoria}
                  onChange={(e) =>
                    setFormData({ ...formData, categoria: e.target.value })
                  }
                  className="w-full bg-neutral-50 border border-neutral-200 px-3 py-2.5 rounded-lg font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all appearance-none cursor-pointer"
                >
                  {categories.map((cat) => (
                    <option key={cat.id_categoria} value={cat.nome}>
                      {cat.nome}
                    </option>
                  ))}
                </select>
                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-neutral-500">
                  <ArrowDownCircle size={14} />
                </div>
              </div>
            </div>

            <div>
              <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                Observa√ß√£o (Opcional)
              </label>
              <textarea
                rows={3}
                value={formData.obs}
                onChange={(e) =>
                  setFormData({ ...formData, obs: e.target.value })
                }
                className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-lg font-medium text-neutral-900 outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all"
              />
            </div>

            <div className="pt-4 flex gap-3 justify-end">
              <Button variant="ghost" onClick={() => setIsModalOpen(false)}>
                Cancelar
              </Button>
              <Button
                onClick={handleSubmit}
                variant="primary"
                className="shadow-lg shadow-primary-500/20"
              >
                {editingItem ? "Salvar Altera√ß√µes" : "Criar Lan√ßamento"}
              </Button>
            </div>
          </div>
        </Modal>
      )}

      {/* DELETE CONFIRM MODAL */}
      {isDeleteModalOpen && (
        <Modal
          title="Confirmar Exclus√£o"
          onClose={() => setIsDeleteModalOpen(false)}
        >
          <div className="space-y-4">
            <div className="bg-red-50 border border-red-100 p-4 rounded-xl flex items-start gap-3">
              <AlertTriangle className="text-red-600 shrink-0" size={24} />
              <div>
                <h3 className="font-bold text-red-900">Aten√ß√£o!</h3>
                <p className="text-sm text-red-700 mt-1">
                  Voc√™ est√° prestes a excluir o lan√ßamento: <br />
                  <span className="font-black">
                    {itemToDelete?.description} (
                    {formatCurrency(itemToDelete?.value || 0)})
                  </span>
                </p>
                <p className="text-xs text-red-600 mt-2">
                  Essa a√ß√£o registrar√° um estorno e n√£o poder√° ser desfeita
                  completamente (o registro ser√° mantido como exclu√≠do).
                </p>
              </div>
            </div>

            <div>
              <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                Motivo da Exclus√£o (Opcional)
              </label>
              <Input
                value={deleteObs}
                onChange={(e) => setDeleteObs(e.target.value)}
                placeholder="Ex: Lan√ßado errado, Duplicado..."
              />
            </div>

            <div className="pt-4 flex gap-3 justify-end">
              <Button
                variant="ghost"
                onClick={() => setIsDeleteModalOpen(false)}
              >
                Cancelar
              </Button>
              <Button variant="danger" onClick={handleDelete} icon={Trash2}>
                Confirmar Exclus√£o
              </Button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\components\financeiro\OperadorasTab.tsx
================================================================================
import { useState, useEffect } from "react";
import { api } from "../../services/api";
import { Plus, CreditCard, Trash2, AlertTriangle, Edit } from "lucide-react";
import type { IOperadoraCartao, IContaBancaria } from "../../types/backend";
import { StatusBanner } from "../ui/StatusBanner";
import { Button } from "../ui/Button";
import { Input } from "../ui/input";
import { Modal } from "../ui/Modal";
import { ActionButton } from "../ui/ActionButton";

export const OperadorasTab = () => {
  const [operadoras, setOperadoras] = useState<IOperadoraCartao[]>([]);
  const [contas, setContas] = useState<IContaBancaria[]>([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
  const [editingOp, setEditingOp] = useState<IOperadoraCartao | null>(null);
  const [opToDelete, setOpToDelete] = useState<IOperadoraCartao | null>(null);
  const [formData, setFormData] = useState<Partial<IOperadoraCartao>>({
    nome: "",
    taxa_debito: 0,
    prazo_debito: 1,
    taxa_credito_vista: 0,
    prazo_credito_vista: 30,
    taxa_credito_parc: 0,
    prazo_credito_parc: 30,
    taxa_antecipacao: 0,
    antecipacao_auto: false,
    id_conta_destino: 0,
  });
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const [opRes, accRes] = await Promise.all([
        api.get("/operadora-cartao"),
        api.get("/conta-bancaria"),
      ]);
      setOperadoras(opRes.data);
      setContas(accRes.data.filter((c: IContaBancaria) => c.ativo));
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: "error", text: "Erro ao carregar dados." });
    }
  };

  const handleOpenCreate = () => {
    setEditingOp(null);
    setFormData({
      nome: "",
      taxa_debito: 0,
      prazo_debito: 1,
      taxa_credito_vista: 0,
      prazo_credito_vista: 30,
      taxa_credito_parc: 0,
      prazo_credito_parc: 30,
      taxa_antecipacao: 0,
      antecipacao_auto: false,
      id_conta_destino: contas.length > 0 ? contas[0].id_conta : 0,
    });
    setIsModalOpen(true);
  };

  const handleOpenEdit = (op: IOperadoraCartao) => {
    setEditingOp(op);
    setFormData({
      ...op,
      taxa_debito: Number(op.taxa_debito),
      taxa_credito_vista: Number(op.taxa_credito_vista),
      taxa_credito_parc: Number(op.taxa_credito_parc),
      taxa_antecipacao: Number(op.taxa_antecipacao),
    });
    setIsModalOpen(true);
  };

  const handleOpenDelete = (op: IOperadoraCartao) => {
    setOpToDelete(op);
    setIsDeleteModalOpen(true);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      if (editingOp) {
        await api.put(`/operadora-cartao/${editingOp.id_operadora}`, formData);
        setStatusMsg({ type: "success", text: "Operadora atualizada!" });
      } else {
        await api.post("/operadora-cartao", formData);
        setStatusMsg({ type: "success", text: "Operadora cadastrada!" });
      }
      setIsModalOpen(false);
      loadData();
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: "error", text: "Erro ao salvar operadora." });
    }
  };

  const handleDelete = async () => {
    if (!opToDelete) return;
    try {
      await api.delete(`/operadora-cartao/${opToDelete.id_operadora}`);
      setStatusMsg({ type: "success", text: "Operadora removida." });
      setIsDeleteModalOpen(false);
      loadData();
    } catch (error) {
      console.error(error);
      setStatusMsg({
        type: "error",
        text: "Erro ao excluir operadora (possui v√≠nculo?).",
      });
    }
  };

  // Helper for custom input styling to match theme
  const inputClass =
    "w-full rounded-xl border border-neutral-200 text-sm font-bold bg-white focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all";

  return (
    <div className="p-6">
      <StatusBanner
        msg={statusMsg}
        onClose={() => setStatusMsg({ type: null, text: "" })}
      />

      <div className="flex justify-between items-center mb-8">
        <div>
          <h2 className="text-xl font-bold text-neutral-800">
            Operadoras de Cart√£o
          </h2>
          <p className="text-neutral-500 text-sm">
            Configure taxas e prazos das suas maquininhas.
          </p>
        </div>
        <Button
          onClick={handleOpenCreate}
          variant="primary"
          icon={Plus}
          className="shadow-lg shadow-primary-500/20"
        >
          Nova Operadora
        </Button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {operadoras.map((op) => (
          <div
            key={op.id_operadora}
            className="bg-surface p-6 rounded-xl border border-neutral-200 shadow-sm relative overflow-hidden group hover:border-blue-200 transition-all"
          >
            <div className="absolute top-0 left-0 w-1 h-full bg-neutral-200 group-hover:bg-blue-500 transition-colors"></div>

            <div className="flex justify-between items-start mb-6 pl-4">
              <div className="flex items-center gap-3">
                <div className="bg-neutral-100 p-2 rounded-lg text-neutral-600">
                  <CreditCard size={20} />
                </div>
                <div>
                  <h3 className="font-bold text-lg text-neutral-900">
                    {op.nome}
                  </h3>
                  <p className="text-xs text-neutral-500">
                    Conta Destino:{" "}
                    {contas.find((c) => c.id_conta === op.id_conta_destino)
                      ?.nome || "?"}
                  </p>
                </div>
              </div>
              <div className="flex gap-2">
                <ActionButton
                  onClick={() => handleOpenEdit(op)}
                  icon={Edit}
                  variant="neutral"
                  label="Editar"
                />
                <ActionButton
                  onClick={() => handleOpenDelete(op)}
                  icon={Trash2}
                  variant="danger"
                  label="Excluir"
                />
              </div>
            </div>

            <div className="grid grid-cols-3 gap-2 pl-4">
              <div className="bg-neutral-50 p-3 rounded-xl">
                <p className="text-[10px] font-bold text-neutral-400 uppercase mb-1">
                  D√©bito
                </p>
                <p className="font-bold text-neutral-900">{op.taxa_debito}%</p>
                <p className="text-[10px] text-neutral-500">
                  D+{op.prazo_debito}
                </p>
              </div>
              <div className="bg-neutral-50 p-3 rounded-xl">
                <p className="text-[10px] font-bold text-neutral-400 uppercase mb-1">
                  Cr√©d. Vista
                </p>
                <p className="font-bold text-neutral-900">
                  {op.taxa_credito_vista}%
                </p>
                <p className="text-[10px] text-neutral-500">
                  D+{op.prazo_credito_vista}
                </p>
              </div>
              <div className="bg-neutral-50 p-3 rounded-xl">
                <p className="text-[10px] font-bold text-neutral-400 uppercase mb-1">
                  Cr√©d. Parc
                </p>
                <p className="font-bold text-neutral-900">
                  {op.taxa_credito_parc}%
                </p>
                <p className="text-[10px] text-neutral-500">
                  D+{op.prazo_credito_parc}
                </p>
              </div>
            </div>

            {op.antecipacao_auto && (
              <div className="mt-4 pl-4 flex items-center gap-2 text-xs font-bold text-blue-600 bg-blue-50 w-fit px-3 py-1 rounded-full">
                <span>Antecipa√ß√£o Autom√°tica: {op.taxa_antecipacao}%</span>
              </div>
            )}
          </div>
        ))}
      </div>

      {/* CREATE/EDIT MODAL */}
      {isModalOpen && (
        <Modal
          title={editingOp ? "Editar Operadora" : "Nova Operadora"}
          onClose={() => setIsModalOpen(false)}
        >
          <form onSubmit={handleSubmit} className="space-y-6">
            <div className="grid grid-cols-2 gap-6">
              <div>
                <Input
                  label="Nome da Maquininha"
                  required
                  value={formData.nome}
                  onChange={(e) =>
                    setFormData({ ...formData, nome: e.target.value })
                  }
                  placeholder="Ex: Stone, PagSeguro..."
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                  Conta Banc√°ria de Destino
                </label>
                <select
                  required
                  value={formData.id_conta_destino}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      id_conta_destino: Number(e.target.value),
                    })
                  }
                  className={`${inputClass} px-3 py-2.5`}
                >
                  <option value={0} disabled>
                    Selecione uma conta...
                  </option>
                  {contas.map((c) => (
                    <option key={c.id_conta} value={c.id_conta}>
                      {c.nome} - {c.banco}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <div className="bg-neutral-50 p-6 rounded-2xl space-y-4">
              <h3 className="text-xs font-bold text-neutral-400 uppercase tracking-widest border-b border-neutral-200 pb-2 mb-4">
                Taxas e Prazos
              </h3>

              {/* DEBITO */}
              <div className="grid grid-cols-12 gap-4 items-center">
                <div className="col-span-4 text-sm font-bold text-neutral-700">
                  D√©bito
                </div>
                <div className="col-span-4">
                  <div className="relative">
                    <input
                      type="number"
                      step="0.01"
                      value={formData.taxa_debito}
                      onChange={(e) =>
                        setFormData({
                          ...formData,
                          taxa_debito: Number(e.target.value),
                        })
                      }
                      className={`${inputClass} pl-3 pr-8 py-2`}
                    />
                    <span className="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 text-xs">
                      %
                    </span>
                  </div>
                </div>
                <div className="col-span-4">
                  <div className="relative">
                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400 text-xs">
                      Dias
                    </span>
                    <input
                      type="number"
                      value={formData.prazo_debito}
                      onChange={(e) =>
                        setFormData({
                          ...formData,
                          prazo_debito: Number(e.target.value),
                        })
                      }
                      className={`${inputClass} pl-12 pr-3 py-2`}
                    />
                  </div>
                </div>
              </div>

              {/* CRED VISTA */}
              <div className="grid grid-cols-12 gap-4 items-center">
                <div className="col-span-4 text-sm font-bold text-neutral-700">
                  Cr√©dito √† Vista
                </div>
                <div className="col-span-4">
                  <div className="relative">
                    <input
                      type="number"
                      step="0.01"
                      value={formData.taxa_credito_vista}
                      onChange={(e) =>
                        setFormData({
                          ...formData,
                          taxa_credito_vista: Number(e.target.value),
                        })
                      }
                      className={`${inputClass} pl-3 pr-8 py-2`}
                    />
                    <span className="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 text-xs">
                      %
                    </span>
                  </div>
                </div>
                <div className="col-span-4">
                  <div className="relative">
                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400 text-xs">
                      Dias
                    </span>
                    <input
                      type="number"
                      value={formData.prazo_credito_vista}
                      onChange={(e) =>
                        setFormData({
                          ...formData,
                          prazo_credito_vista: Number(e.target.value),
                        })
                      }
                      className={`${inputClass} pl-12 pr-3 py-2`}
                    />
                  </div>
                </div>
              </div>

              {/* CRED PARC */}
              <div className="grid grid-cols-12 gap-4 items-center">
                <div className="col-span-4 text-sm font-bold text-neutral-700">
                  Cr√©dito Parcelado
                </div>
                <div className="col-span-4">
                  <div className="relative">
                    <input
                      type="number"
                      step="0.01"
                      value={formData.taxa_credito_parc}
                      onChange={(e) =>
                        setFormData({
                          ...formData,
                          taxa_credito_parc: Number(e.target.value),
                        })
                      }
                      className={`${inputClass} pl-3 pr-8 py-2`}
                    />
                    <span className="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 text-xs">
                      %
                    </span>
                  </div>
                </div>
                <div className="col-span-4">
                  <div className="relative">
                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400 text-xs">
                      Dias
                    </span>
                    <input
                      type="number"
                      value={formData.prazo_credito_parc}
                      onChange={(e) =>
                        setFormData({
                          ...formData,
                          prazo_credito_parc: Number(e.target.value),
                        })
                      }
                      className={`${inputClass} pl-12 pr-3 py-2`}
                    />
                  </div>
                </div>
              </div>
            </div>

            <div className="flex items-center gap-4 bg-blue-50 p-4 rounded-xl">
              <input
                type="checkbox"
                id="auto_antecipa"
                checked={formData.antecipacao_auto}
                onChange={(e) =>
                  setFormData({
                    ...formData,
                    antecipacao_auto: e.target.checked,
                  })
                }
                className="w-5 h-5 rounded text-blue-600 focus:ring-blue-500 border-gray-300"
              />
              <div className="flex-1">
                <label
                  htmlFor="auto_antecipa"
                  className="block text-sm font-bold text-neutral-900 cursor-pointer"
                >
                  Antecipa√ß√£o Autom√°tica
                </label>
                <p className="text-xs text-neutral-500">
                  O dinheiro cai no dia seguinte (com taxa extra).
                </p>
              </div>
              {formData.antecipacao_auto && (
                <div className="w-24 relative">
                  <input
                    type="number"
                    step="0.01"
                    value={formData.taxa_antecipacao}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        taxa_antecipacao: Number(e.target.value),
                      })
                    }
                    className={`${inputClass} pl-2 pr-6 py-1 h-8`}
                  />
                  <span className="absolute right-2 top-1/2 -translate-y-1/2 text-neutral-400 text-xs">
                    %
                  </span>
                </div>
              )}
            </div>

            <div className="pt-4 flex justify-end gap-3">
              <Button variant="ghost" onClick={() => setIsModalOpen(false)}>
                Cancelar
              </Button>
              <Button
                type="submit"
                variant="primary"
                className="shadow-lg shadow-primary-500/20"
              >
                Salvar Configura√ß√µes
              </Button>
            </div>
          </form>
        </Modal>
      )}

      {/* DELETE MODAL */}
      {isDeleteModalOpen && (
        <Modal
          title="Confirmar Exclus√£o"
          onClose={() => setIsDeleteModalOpen(false)}
        >
          <div className="space-y-4">
            <div className="bg-red-50 border border-red-100 p-4 rounded-xl flex items-start gap-3">
              <AlertTriangle className="text-red-600 shrink-0" size={24} />
              <div>
                <h3 className="font-bold text-red-900">Aten√ß√£o!</h3>
                <p className="text-sm text-red-700 mt-1">
                  Voc√™ tem certeza que deseja excluir esta operadora? <br />
                  <span className="font-black">{opToDelete?.nome}</span>
                </p>
              </div>
            </div>

            <div className="pt-4 flex gap-3 justify-end">
              <Button
                variant="ghost"
                onClick={() => setIsDeleteModalOpen(false)}
              >
                Cancelar
              </Button>
              <Button variant="danger" onClick={handleDelete} icon={Trash2}>
                Confirmar Exclus√£o
              </Button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\components\financeiro\RecebiveisTab.tsx
================================================================================
import { useState, useEffect } from "react";
import { formatCurrency } from "../../utils/formatCurrency";
import { api } from "../../services/api";
import {
  Calendar,
  CheckCircle,
  Search,
  FilterX,
  Clock,
  History,
  AlertCircle,
} from "lucide-react";
import type { IRecebivelCartao } from "../../types/backend";
import { StatusBanner } from "../ui/StatusBanner";
import { Button } from "../ui/Button";
import { Input } from "../ui/input";

export const RecebiveisTab = () => {
  const [recebiveis, setRecebiveis] = useState<IRecebivelCartao[]>([]);
  const [originalData, setOriginalData] = useState<IRecebivelCartao[]>([]);
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  // Filters
  const [filterStatus, setFilterStatus] = useState<
    "PENDENTE" | "RECEBIDO" | "ALL"
  >("PENDENTE");
  const [dateRange, setDateRange] = useState({ start: "", end: "" });
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedOperadoraId, setSelectedOperadoraId] = useState<
    number | "ALL"
  >("ALL");
  const [operadoras, setOperadoras] = useState<any[]>([]);

  // Selection
  const [selectedIds, setSelectedIds] = useState<number[]>([]);

  useEffect(() => {
    loadData();
    loadOperadoras();
  }, []);

  const loadOperadoras = async () => {
    try {
      const res = await api.get("/operadora-cartao");
      setOperadoras(res.data);
    } catch (error) {
      console.error("Erro ao carregar operadoras:", error);
    }
  };

  const loadData = async (start?: string, end?: string) => {
    try {
      const params: any = {};
      if (start) params.dataInicio = start;
      if (end) params.dataFim = end;

      const res = await api.get(
        start || end ? "/recebivel-cartao/date-range" : "/recebivel-cartao",
        {
          params,
        },
      );
      setOriginalData(res.data);
      applyFilters(res.data, filterStatus, searchTerm, selectedOperadoraId);
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: "error", text: "Erro ao carregar receb√≠veis." });
    }
  };

  const applyFilters = (
    data: IRecebivelCartao[],
    status: string,
    search: string,
    operadoraId: number | "ALL",
  ) => {
    let filtered = data;

    // 1. Status Filter
    if (status !== "ALL") {
      filtered = filtered.filter((r) => r.status === status);
    }

    // 2. Operadora Filter
    if (operadoraId !== "ALL") {
      filtered = filtered.filter((r) => r.id_operadora === Number(operadoraId));
    }

    // 3. Search Term (Dynamic "letra a letra" in all relevant columns)
    if (search.trim()) {
      const term = search.toLowerCase();
      const terms = term.split(" ").filter((t) => t.trim() !== "");

      // Helper para limpar termos de busca (ex: remover # para buscar numero OS)
      const cleanTerm = (t: string) => t.replace("#", "");

      filtered = filtered.filter((r) => {
        const searchString = [
          (r as any).codigo_autorizacao || "",
          (r as any).nsu || "",
          (r as any).ordem_de_servico?.veiculo?.placa || "",
          (r as any).ordem_de_servico?.veiculo?.modelo || "",
          (r as any).ordem_de_servico?.cliente?.pessoa_fisica?.pessoa?.nome ||
            "",
          (r as any).ordem_de_servico?.cliente?.pessoa_juridica?.razao_social ||
            "",
          (r as any).operadora?.nome || "",
          `#${r.id_os}`, // Permite busca exata "#22"
          r.id_os?.toString() || "", // Permite busca "22"
          r.valor_bruto?.toString() || "",
          r.valor_liquido?.toString() || "",
          r.num_parcela?.toString() || "",
          new Date(r.data_prevista).toLocaleDateString("pt-BR"),
        ]
          .join(" ")
          .toLowerCase();

        // Verifica se TODOS os termos digitados est√£o na string de busca
        return terms.every(
          (t) =>
            searchString.includes(t) || searchString.includes(cleanTerm(t)),
        );
      });
    }

    setRecebiveis(filtered);
  };

  useEffect(() => {
    applyFilters(originalData, filterStatus, searchTerm, selectedOperadoraId);
  }, [filterStatus, originalData, searchTerm, selectedOperadoraId]);

  const handleDateChange = (type: "start" | "end", val: string) => {
    const newRange = { ...dateRange, [type]: val };
    setDateRange(newRange);
    if (newRange.start && newRange.end) {
      loadData(newRange.start, newRange.end);
    }
  };

  const setPresetRange = (days: number) => {
    const today = new Date();
    const start = today.toISOString().split("T")[0];

    const futureDate = new Date();
    futureDate.setDate(today.getDate() + days);
    const end = futureDate.toISOString().split("T")[0];

    setDateRange({ start, end });
    loadData(start, end);
  };

  const clearFilters = () => {
    setFilterStatus("PENDENTE");
    setSelectedOperadoraId("ALL");
    setSearchTerm("");
    setDateRange({ start: "", end: "" });
    loadData();
  };

  const toggleSelect = (id: number) => {
    if (selectedIds.includes(id)) {
      setSelectedIds(selectedIds.filter((i) => i !== id));
    } else {
      setSelectedIds([...selectedIds, id]);
    }
  };

  const toggleSelectAll = () => {
    if (selectedIds.length === recebiveis.length) {
      setSelectedIds([]);
    } else {
      setSelectedIds(recebiveis.map((r) => r.id_recebivel));
    }
  };

  const handleConciliar = async () => {
    if (selectedIds.length === 0) return;
    if (
      !window.confirm(
        `Confirma o recebimento de ${selectedIds.length} transa√ß√µes? Isso lan√ßar√° o valor na conta banc√°ria.`,
      )
    )
      return;

    try {
      await api.post("/recebivel-cartao/confirmar", { ids: selectedIds });
      setStatusMsg({
        type: "success",
        text: "Recebimentos confirmados e conciliados!",
      });
      setSelectedIds([]);
      loadData(dateRange.start, dateRange.end);
    } catch (error: any) {
      console.error(error);
      const msg =
        error.response?.data?.details ||
        error.response?.data?.error ||
        "Erro ao conciliar receb√≠veis.";
      setStatusMsg({ type: "error", text: msg });
    }
  };

  const totalSelected = recebiveis
    .filter((r) => selectedIds.includes(r.id_recebivel))
    .reduce((acc, r) => acc + Number(r.valor_liquido), 0);

  const totalPrevisto = recebiveis.reduce(
    (acc, r) => acc + Number(r.valor_liquido),
    0,
  );

  const countPendente = originalData.filter(
    (r) => r.status === "PENDENTE",
  ).length;
  const countRecebido = originalData.filter(
    (r) => r.status === "RECEBIDO",
  ).length;
  const countTotal = originalData.length;

  const getStatusButtonClass = (
    isActive: boolean,
    type: "PENDENTE" | "RECEBIDO" | "ALL",
  ) => {
    let colorClass = "text-neutral-500 hover:bg-white/50";
    if (isActive) {
      if (type === "PENDENTE")
        colorClass =
          "bg-primary-500 text-neutral-25 shadow-md shadow-primary-500/20 scale-105";
      if (type === "RECEBIDO")
        colorClass =
          "bg-emerald-500 text-neutral-25 shadow-md shadow-emerald-500/20 scale-105";
      if (type === "ALL")
        colorClass = "bg-neutral-800 text-neutral-25 shadow-md scale-105";
    }
    return `flex flex-col items-center justify-center px-6 py-2.5 rounded-lg transition-all duration-300 ${colorClass}`;
  };

  return (
    <div className="p-6 space-y-6">
      <StatusBanner
        msg={statusMsg}
        onClose={() => setStatusMsg({ type: null, text: "" })}
      />

      {/* HEADER AREA */}
      <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
        <div>
          <h2 className="text-2xl font-bold text-neutral-800 tracking-tight">
            Concilia√ß√£o de Cart√µes
          </h2>
          <p className="text-neutral-500 font-medium text-sm">
            Gerencie seus receb√≠veis e fluxos de caixa de cart√µes.
          </p>
        </div>

        {/* Status Selection Cards */}
        <div className="flex gap-2 bg-neutral-100 p-1.5 rounded-xl border border-neutral-200 shadow-inner">
          <button
            onClick={() => setFilterStatus("PENDENTE")}
            className={getStatusButtonClass(
              filterStatus === "PENDENTE",
              "PENDENTE",
            )}
          >
            <Clock size={18} className="mb-1" />
            <span className="text-[10px] font-bold uppercase tracking-widest">
              Pendentes
            </span>
            <span
              className={`mt-1 text-xs font-black ${filterStatus === "PENDENTE" ? "text-neutral-25" : "text-neutral-400"}`}
            >
              {countPendente}
            </span>
          </button>
          <button
            onClick={() => setFilterStatus("RECEBIDO")}
            className={getStatusButtonClass(
              filterStatus === "RECEBIDO",
              "RECEBIDO",
            )}
          >
            <CheckCircle size={18} className="mb-1" />
            <span className="text-[10px] font-bold uppercase tracking-widest">
              Recebidos
            </span>
            <span
              className={`mt-1 text-xs font-black ${filterStatus === "RECEBIDO" ? "text-neutral-25" : "text-neutral-400"}`}
            >
              {countRecebido}
            </span>
          </button>
          <button
            onClick={() => setFilterStatus("ALL")}
            className={getStatusButtonClass(filterStatus === "ALL", "ALL")}
          >
            <History size={18} className="mb-1" />
            <span className="text-[10px] font-bold uppercase tracking-widest">
              Todos
            </span>
            <span
              className={`mt-1 text-xs font-black ${filterStatus === "ALL" ? "text-neutral-25" : "text-neutral-400"}`}
            >
              {countTotal}
            </span>
          </button>
        </div>
      </div>

      {/* FILTERS CONTAINER */}
      <div className="bg-surface p-6 rounded-xl border border-neutral-200 shadow-sm space-y-6">
        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-12 gap-6 items-end">
          {/* Search Field */}
          <div className="xl:col-span-4">
            <Input
              label="Filtro R√°pido (Placa, OS, Operadora...)"
              icon={Search}
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              placeholder="Busca inteligente..."
            />
          </div>

          {/* Operadora Select */}
          <div className="xl:col-span-3 space-y-1.5">
            <label className="text-sm font-semibold text-neutral-700 ml-1">
              Operadora
            </label>
            <div className="relative">
              <select
                value={selectedOperadoraId}
                onChange={(e) =>
                  setSelectedOperadoraId(
                    e.target.value === "ALL" ? "ALL" : Number(e.target.value),
                  )
                }
                className="w-full bg-neutral-50 border border-neutral-200 px-4 py-[11px] rounded-xl font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all appearance-none cursor-pointer"
              >
                <option value="ALL">Todas as Operadoras</option>
                {operadoras.map((op) => (
                  <option key={op.id_operadora} value={op.id_operadora}>
                    {op.nome}
                  </option>
                ))}
              </select>
              <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-neutral-500">
                {/* Could add an arrow icon here if needed */}
              </div>
            </div>
          </div>

          {/* Date Range Fields */}
          <div className="xl:col-span-3">
            <label className="text-sm font-semibold text-neutral-700 ml-1 mb-1.5 block">
              Per√≠odo Customizado
            </label>
            <div className="flex gap-2">
              <div className="flex-1 relative">
                <input
                  type="date"
                  value={dateRange.start}
                  onChange={(e) => handleDateChange("start", e.target.value)}
                  className="w-full bg-neutral-50 border border-neutral-200 px-3 py-2.5 rounded-xl font-bold text-[11px] outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all shadow-inner uppercase"
                />
              </div>
              <div className="flex-1 relative">
                <input
                  type="date"
                  value={dateRange.end}
                  onChange={(e) => handleDateChange("end", e.target.value)}
                  className="w-full bg-neutral-50 border border-neutral-200 px-3 py-2.5 rounded-xl font-bold text-[11px] outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all shadow-inner uppercase"
                />
              </div>
            </div>
          </div>

          {/* Clear Button */}
          <div className="xl:col-span-2">
            <Button
              variant="danger"
              onClick={clearFilters}
              className="w-full h-[46px]"
              icon={FilterX}
            >
              Limpar Filtro
            </Button>
          </div>
        </div>

        {/* QUICK DATE SHORTCARD CARDS */}
        <div className="flex flex-wrap gap-3 pt-4 border-t border-neutral-100">
          {[
            { label: "Hoje", days: 0 },
            { label: "7 Dias", days: 7 },
            { label: "15 Dias", days: 15 },
            { label: "30 Dias", days: 30 },
            { label: "60 Dias", days: 60 },
            { label: "90 Dias", days: 90 },
          ].map((card) => (
            <button
              key={card.label}
              onClick={() => setPresetRange(card.days)}
              className="bg-white border border-neutral-200 px-5 py-3 rounded-xl shadow-sm hover:border-primary-400 hover:bg-primary-50 transition-all flex flex-col items-center group min-w-[100px]"
            >
              <span className="text-[9px] font-bold text-neutral-400 uppercase tracking-widest group-hover:text-primary-500">
                Pr√≥ximos
              </span>
              <span className="text-sm font-bold text-neutral-700 group-hover:text-primary-700">
                {card.label}
              </span>
            </button>
          ))}
        </div>
      </div>

      {/* VALUE SUMMARY & ACTIONS */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {/* PREVIS√ÉO NO PER√çODO - DYNAMIC */}
        <div className="bg-neutral-800 p-6 rounded-xl border border-neutral-800 shadow-xl relative overflow-hidden group">
          {/* Background Glow */}
          <div className="absolute -right-4 -top-4 w-24 h-24 bg-primary-500/10 rounded-full blur-2xl group-hover:bg-primary-500/20 transition-all"></div>

          <div className="relative">
            <div className="flex items-center gap-2 mb-2">
              <AlertCircle size={14} className="text-primary-400" />
              <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest">
                Previs√£o no Per√≠odo (Filtrado)
              </p>
            </div>
            <p className="text-3xl font-black text-neutral-25 tracking-tighter">
              {formatCurrency(totalPrevisto)}
            </p>
            <p className="text-[10px] text-neutral-500 mt-2 font-bold uppercase tracking-wider italic">
              * Soma total dos itens vis√≠veis abaixo
            </p>
          </div>
        </div>

        {/* ACTION BOX (IF SELECTED) */}
        {selectedIds.length > 0 && (
          <div className="lg:col-span-2 bg-primary-600 p-6 rounded-xl border border-primary-500 shadow-xl shadow-primary-200 flex flex-col md:flex-row items-center justify-between gap-4 animate-in zoom-in-95 duration-300">
            <div className="flex items-center gap-4">
              <div className="bg-white/20 p-3 rounded-lg">
                <CheckCircle size={28} className="text-neutral-25" />
              </div>
              <div>
                <p className="text-[10px] font-bold text-primary-100 uppercase tracking-widest">
                  Confirmar Dep√≥sito
                </p>
                <p className="text-3xl font-black text-neutral-25 tracking-tighter">
                  {formatCurrency(totalSelected)}
                </p>
                <p className="text-xs font-bold text-primary-100 mt-1">
                  {selectedIds.length} transa√ß√µes selecionadas
                </p>
              </div>
            </div>
            <Button
              onClick={handleConciliar}
              className="w-full md:w-auto text-primary-700 bg-primary-100 hover:bg-neutral-50 shadow-lg border-none!"
              icon={Calendar}
              size="lg"
            >
              Dar Baixa no Banco
            </Button>
          </div>
        )}
      </div>

      {/* TABLE CONTAINER */}
      <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-neutral-50 text-[10px] font-bold text-neutral-400 uppercase tracking-widest">
                <th className="p-5 w-14 text-center">
                  <input
                    type="checkbox"
                    onChange={toggleSelectAll}
                    checked={
                      recebiveis.length > 0 &&
                      selectedIds.length === recebiveis.length
                    }
                    className="w-5 h-5 rounded-lg border-neutral-300 text-primary-600 focus:ring-primary-500 cursor-pointer"
                  />
                </th>
                <th className="p-5">Previs√£o</th>
                <th className="p-5">N¬∫ / Aut.</th>
                <th className="p-5">Operadora</th>
                <th className="p-5">Ve√≠culo / Cliente</th>
                <th className="p-5">Detalhes</th>
                <th className="p-5 text-right">Bruto</th>
                <th className="p-5 text-right">Taxa</th>
                <th className="p-5 text-right font-black text-neutral-900">
                  L√≠quido
                </th>
                <th className="p-5 text-center">Status</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-neutral-100">
              {recebiveis.length === 0 ? (
                <tr>
                  <td colSpan={10} className="p-20 text-center">
                    <div className="flex flex-col items-center opacity-30">
                      <Search size={48} className="mb-4" />
                      <p className="text-lg font-bold text-neutral-500">
                        Nenhum receb√≠vel encontrado
                      </p>
                      <p className="text-sm font-medium">
                        Tente ajustar os filtros ou pesquisar outro termo.
                      </p>
                    </div>
                  </td>
                </tr>
              ) : (
                recebiveis.map((r) => (
                  <tr
                    key={r.id_recebivel}
                    className={`group hover:bg-primary-50/30 transition-colors ${r.status === "RECEBIDO" ? "opacity-80" : ""}`}
                  >
                    <td className="p-5 text-center">
                      <input
                        type="checkbox"
                        checked={selectedIds.includes(r.id_recebivel)}
                        onChange={() => toggleSelect(r.id_recebivel)}
                        disabled={r.status === "RECEBIDO"}
                        className="w-5 h-5 rounded-lg border-neutral-300 text-primary-600 focus:ring-primary-500 cursor-pointer disabled:opacity-30 disabled:cursor-not-allowed"
                      />
                    </td>
                    <td className="p-5">
                      <div className="flex flex-col">
                        <span className="font-bold text-neutral-800 text-sm whitespace-nowrap">
                          {new Date(r.data_prevista).toLocaleDateString(
                            "pt-BR",
                          )}
                        </span>
                        <span className="text-[10px] font-bold text-neutral-400 uppercase">
                          Estimado
                        </span>
                      </div>
                    </td>
                    <td className="p-5">
                      <div className="text-xs text-neutral-600 font-mono font-bold bg-neutral-100 px-3 py-1.5 rounded-lg border border-neutral-200 w-fit">
                        {(r as any).codigo_autorizacao || (r as any).nsu || "-"}
                      </div>
                    </td>
                    <td className="p-5">
                      <div className="flex items-center gap-2">
                        <div className="w-8 h-8 rounded-full bg-primary-100 flex items-center justify-center text-primary-600 font-black text-[10px]">
                          {(r as any).operadora?.nome?.substring(0, 1) || "O"}
                        </div>
                        <span className="font-bold text-neutral-900 text-sm">
                          {(r as any).operadora?.nome || "Operadora"}
                        </span>
                      </div>
                    </td>
                    <td className="p-5">
                      <div className="flex flex-col">
                        <div className="flex items-center gap-2">
                          <span className="font-bold text-neutral-800 uppercase text-xs">
                            {(r as any).ordem_de_servico?.veiculo?.placa ||
                              "S/P"}
                          </span>
                          <span className="text-[10px] font-bold text-neutral-400 uppercase">
                            {(r as any).ordem_de_servico?.veiculo?.modelo ||
                              "S/M"}
                          </span>
                          <span className="text-[10px] font-bold text-neutral-400 uppercase">
                            {(r as any).ordem_de_servico?.veiculo?.cor || "S/M"}
                          </span>
                        </div>
                        <span className="text-[10px] text-neutral-500 font-medium mt-1">
                          {(r as any).ordem_de_servico?.cliente?.pessoa_fisica
                            ?.pessoa?.nome ||
                            (r as any).ordem_de_servico?.cliente
                              ?.pessoa_juridica?.razao_social ||
                            "Cliente n√£o identificado"}
                        </span>
                      </div>
                    </td>
                    <td className="p-5">
                      <div className="flex flex-col">
                        <span
                          className="text-xs font-bold text-primary-600 bg-primary-50 px-2 py-0.5 rounded-md w-fit mb-1 cursor-help"
                          title={`Data da Venda: ${new Date(r.data_venda).toLocaleDateString("pt-BR")}`}
                        >
                          OS #{r.id_os}
                        </span>
                        <span className="text-[10px] font-bold text-neutral-400 uppercase">
                          Parcela {r.num_parcela} de {r.total_parcelas}
                        </span>
                        <span className="text-[10px] font-bold text-neutral-500 uppercase mt-0.5 bg-neutral-100 px-1.5 py-0.5 rounded w-fit">
                          {(() => {
                            if (r.total_parcelas > 1)
                              return "Cr√©dito Parcelado";
                            const payments =
                              (r.ordem_de_servico as any)?.pagamentos_cliente ||
                              [];
                            const cardPayments = payments.filter((p: any) =>
                              ["CREDITO", "DEBITO"].includes(
                                p.metodo_pagamento,
                              ),
                            );

                            const match = cardPayments.find(
                              (p: any) =>
                                Math.abs(
                                  Number(p.valor) - Number(r.valor_bruto),
                                ) < 0.1,
                            );
                            if (match)
                              return match.metodo_pagamento === "CREDITO"
                                ? "Cr√©dito √† Vista"
                                : "D√©bito";

                            if (cardPayments.length === 1)
                              return cardPayments[0].metodo_pagamento ===
                                "CREDITO"
                                ? "Cr√©dito √† Vista"
                                : "D√©bito";

                            return "Cr√©dito a Vista ou D√©bito";
                          })()}
                        </span>
                      </div>
                    </td>
                    <td className="p-5 text-right font-medium text-neutral-500 text-sm">
                      {formatCurrency(Number(r.valor_bruto))}
                    </td>
                    <td className="p-5 text-right">
                      <span className="text-red-500 text-xs font-bold bg-red-50 px-2 py-1 rounded-lg">
                        - {formatCurrency(Number(r.taxa_aplicada))}
                      </span>
                    </td>
                    <td className="p-5 text-right">
                      <span className="font-black text-neutral-900 text-base">
                        {formatCurrency(Number(r.valor_liquido))}
                      </span>
                    </td>
                    <td className="p-5 text-center">
                      {r.status === "RECEBIDO" ? (
                        <div className="flex flex-col items-center">
                          <span className="bg-emerald-100 text-emerald-700 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider flex items-center gap-1.5">
                            <CheckCircle size={12} /> Recebido
                          </span>
                          {r.data_recebimento && (
                            <span className="text-[9px] text-neutral-400 font-bold mt-1">
                              {new Date(r.data_recebimento).toLocaleDateString(
                                "pt-BR",
                              )}
                            </span>
                          )}
                        </div>
                      ) : (
                        <span className="bg-primary-50 text-primary-600 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider flex items-center gap-1.5 border border-primary-100">
                          <Clock size={12} /> Aberto
                        </span>
                      )}
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};



================================================================================
FILE PATH: client\src\components\forms\ClienteForm.tsx
================================================================================
import { useState, useEffect, useRef } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';
import { formatNameTitleCase } from '../../utils/normalize';
import { CheckCircle, AlertCircle, CarFront } from 'lucide-react';

interface ClienteFormProps {
    clientId?: number;
    initialData?: any;
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
    onRegisterVehicle?: (client: any) => void;
}

export const ClienteForm = ({ clientId, initialData, onSuccess, onCancel, onRegisterVehicle }: ClienteFormProps) => {
    const [tipoPessoa, setTipoPessoa] = useState<'PF' | 'PJ'>('PF');
    const [loading, setLoading] = useState(false);
    const [formStatus, setFormStatus] = useState<{ type: 'success' | 'error' | null, message: string }>({ type: null, message: '' });
    const [createdClient, setCreatedClient] = useState<any>(null);

    const firstInputRef = useRef<HTMLInputElement>(null);

    // Form States
    const [nome, setNome] = useState('');
    const [cpf, setCpf] = useState('');
    const [razaoSocial, setRazaoSocial] = useState('');
    const [cnpj, setCnpj] = useState('');
    const [ie, setIe] = useState('');
    const [telefone, setTelefone] = useState('');
    const [email, setEmail] = useState('');
    
    // Address
    const [logradouro, setLogradouro] = useState('');
    const [numero, setNumero] = useState('');
    const [bairro, setBairro] = useState('');
    const [cidade, setCidade] = useState('S√£o Paulo');
    const [estado, setEstado] = useState('SP');

    // Optional Fields
    const [genero, setGenero] = useState('');
    const [dtNascimento, setDtNascimento] = useState('');
    const [obs, setObs] = useState('');
    
    // PJ Optional
    const [nomeFantasia, setNomeFantasia] = useState('');

    // Contacts
    const [telefone2, setTelefone2] = useState('');
    const [telefone3, setTelefone3] = useState('');
    
    // Address Optional
    const [complLogradouro, setComplLogradouro] = useState('');

    useEffect(() => {
        if (firstInputRef.current) {
            firstInputRef.current.focus();
        }
    }, [tipoPessoa]);

    useEffect(() => {
        if (initialData) {
            // Address & Contact (Always present on Cliente)
            setTelefone(initialData.telefone_1 || '');
            setTelefone2(initialData.telefone_2 || '');
            setTelefone3(initialData.telefone_3 || '');
            setEmail(initialData.email || '');
            setLogradouro(initialData.logradouro || '');
            setNumero(initialData.nr_logradouro || '');
            setComplLogradouro(initialData.compl_logradouro || '');
            setBairro(initialData.bairro || '');
            setCidade(initialData.cidade || '');
            setEstado(initialData.estado || '');

            // Person Type Specific
            if (initialData.pessoa_fisica) {
                setTipoPessoa('PF');
                const pf = initialData.pessoa_fisica;
                setNome(pf.pessoa?.nome || '');
                setCpf(pf.cpf || '');
                setGenero(pf.pessoa?.genero || '');
                 if (pf.pessoa?.dt_nascimento) {
                    setDtNascimento(new Date(pf.pessoa.dt_nascimento).toISOString().split('T')[0]);
                }
            } else if (initialData.pessoa_juridica) {
                setTipoPessoa('PJ');
                const pj = initialData.pessoa_juridica;
                setRazaoSocial(pj.razao_social || '');
                setNomeFantasia(pj.nome_fantasia || '');
                setCnpj(pj.cnpj || '');
                setIe(pj.inscricao_estadual || '');
            }
        }
    }, [initialData]);

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setFormStatus({ type: null, message: '' });

        // EDIT MODE
        if (clientId && initialData) {
             try {
                const clientePayload = {
                    telefone_1: telefone,
                    telefone_2: telefone2,
                    telefone_3: telefone3,
                    email,
                    logradouro,
                    nr_logradouro: numero,
                    compl_logradouro: complLogradouro,
                    bairro,
                    cidade,
                    estado
                };

                const response = await api.put(`/cliente/${clientId}`, clientePayload);
                setFormStatus({ type: 'success', message: 'Dados do cliente atualizados com sucesso!' });
                setTimeout(() => onSuccess(response.data), 1500);
             } catch (error: any) {
                 console.error(error);
                 setFormStatus({ type: 'error', message: 'Erro ao atualizar cliente: ' + (error.response?.data?.error || error.message) });
             } finally {
                 setLoading(false);
             }
             return;
        }

        // CREATE MODE
        try {
            // 1. Create Base Pessoa (normalize name to Title Case)
            const pessoaPayload = { 
                nome: formatNameTitleCase(tipoPessoa === 'PF' ? nome : razaoSocial),
                genero: tipoPessoa === 'PF' ? genero : null,
                dt_nascimento: dtNascimento ? new Date(dtNascimento) : null,
                obs
            };
            const pessoaRes = await api.post('/pessoa', pessoaPayload);
            const idPessoa = pessoaRes.data.id_pessoa;

            if (!idPessoa) throw new Error('Falha ao criar Pessoa base.');

            let fkId = null;
            let fkField = '';

            // 2. Create Specific Person Type (normalize CPF/CNPJ)
            if (tipoPessoa === 'PF') {
                const pfPayload = { 
                    id_pessoa: idPessoa, 
                    cpf: cpf ? cpf.replace(/\D/g, '') : null // Remove non-digits
                };
                const pfRes = await api.post('/pessoa-fisica', pfPayload);
                fkId = pfRes.data.id_pessoa_fisica;
                fkField = 'id_pessoa_fisica';
            } else {
                const pjPayload = { 
                    id_pessoa: idPessoa, 
                    razao_social: formatNameTitleCase(razaoSocial),
                    nome_fantasia: nomeFantasia ? formatNameTitleCase(nomeFantasia) : null,
                    cnpj: cnpj ? cnpj.replace(/\D/g, '') : null, // Remove non-digits
                    inscricao_estadual: ie 
                };
                const pjRes = await api.post('/pessoa-juridica', pjPayload);
                fkId = pjRes.data.id_pessoa_juridica;
                fkField = 'id_pessoa_juridica';
            }

            if (!fkId) {
                console.error(`Erro: FK ID n√£o retornado para ${fkField}`);
                throw new Error(`Falha ao criar registro de Pessoa ${tipoPessoa}.`);
            }

            // 3. Create Cliente
            const clientePayload = {
                [fkField]: fkId,
                tipo_pessoa: 1, // 1 implies generic type/active
                telefone_1: telefone,
                telefone_2: telefone2,
                telefone_3: telefone3,
                email,
                logradouro,
                nr_logradouro: numero,
                compl_logradouro: complLogradouro,
                bairro,
                cidade,
                estado
            };

            const clienteRes = await api.post('/cliente', clientePayload);
            if (!clienteRes.data || !clienteRes.data.id_cliente) {
                throw new Error('Cliente criado mas ID n√£o retornado.');
            }
            
            setCreatedClient(clienteRes.data);
            setFormStatus({ type: 'success', message: 'Cliente cadastrado com sucesso!' });
            
            // If the user doesn't want to register a vehicle, we auto-success in 3 seconds or they can click.
            if (!onRegisterVehicle) {
                setTimeout(() => onSuccess(clienteRes.data), 2000);
            }
            
        } catch (error: any) {
            console.error('Erro no cadastro:', error);
            setFormStatus({ type: 'error', message: 'Erro ao cadastrar cliente: ' + (error.response?.data?.error || error.message) });
        } finally {
            setLoading(false);
        }
    };

    if (formStatus.type === 'success' && createdClient && onRegisterVehicle) {
        return (
            <div className="py-8 px-4 text-center space-y-6">
                <div className="flex flex-col items-center gap-4">
                    <div className="w-16 h-16 bg-success-100 text-success-600 rounded-full flex items-center justify-center">
                        <CheckCircle size={40} />
                    </div>
                    <div>
                        <h3 className="text-xl font-black text-neutral-900">Cliente Cadastrado!</h3>
                        <p className="text-neutral-500">Deseja cadastrar um ve√≠culo para este cliente agora?</p>
                    </div>
                </div>

                <div className="flex flex-col gap-3 pt-4">
                    <button 
                        onClick={() => onRegisterVehicle(createdClient)}
                        className="w-full py-4 bg-primary-600 text-white font-black rounded-2xl hover:bg-primary-700 transition-all shadow-xl shadow-primary-500/20 flex items-center justify-center gap-3"
                    >
                        <CarFront size={20} /> CADASTRAR VE√çCULO
                    </button>
                    <button 
                        onClick={() => onSuccess(createdClient)}
                        className="w-full py-4 text-neutral-500 font-bold hover:bg-neutral-100 rounded-2xl transition-all"
                    >
                        Apenas concluir
                    </button>
                </div>
            </div>
        );
    }

    return (
        <form onSubmit={handleSubmit} className="space-y-4 text-neutral-900">
            {formStatus.type && (
                <div className={`p-4 rounded-xl flex items-center gap-3 animate-in fade-in slide-in-from-top-2 duration-300 ${formStatus.type === 'success' ? 'bg-success-50 text-success-700 border border-success-100' : 'bg-red-50 text-red-700 border border-red-100'}`}>
                    {formStatus.type === 'success' ? <CheckCircle size={20} /> : <AlertCircle size={20} />}
                    <p className="text-sm font-bold">{formStatus.message}</p>
                </div>
            )}

            <div className="flex bg-neutral-100 p-1 rounded-lg mb-4 w-fit">
                <button
                    type="button"
                    onClick={() => !clientId && setTipoPessoa('PF')}
                    disabled={!!clientId}
                    className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${tipoPessoa === 'PF' ? 'bg-surface shadow text-primary-600' : 'text-neutral-500'} ${clientId ? 'opacity-50 cursor-not-allowed' : ''}`}
                >
                    Pessoa F√≠sica
                </button>
                <button
                    type="button"
                    onClick={() => !clientId && setTipoPessoa('PJ')}
                    disabled={!!clientId}
                    className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${tipoPessoa === 'PJ' ? 'bg-surface shadow text-accent-600' : 'text-neutral-500'} ${clientId ? 'opacity-50 cursor-not-allowed' : ''}`}
                >
                    Pessoa Jur√≠dica
                </button>
            </div>

            {/* 1. Base Pessoa Data */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                {tipoPessoa === 'PF' ? (
                    <>
                        <div className="col-span-2">
                            <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Nome Completo {clientId && '(Leitura)'}</label>
                            <input ref={firstInputRef} value={nome} onChange={e => setNome(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300 disabled:bg-neutral-100" required disabled={!!clientId} />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">CPF {clientId && '(Leitura)'}</label>
                            <input value={cpf} onChange={e => setCpf(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300 disabled:bg-neutral-100" disabled={!!clientId} />
                        </div>
                        <div>
                             <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">G√™nero</label>
                             <select value={genero} onChange={e => setGenero(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300 disabled:bg-neutral-100" disabled={!!clientId}>
                                <option value="">Selecione...</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                                <option value="Outro">Outro</option>
                             </select>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Data Nascimento</label>
                            <input type="date" value={dtNascimento} onChange={e => setDtNascimento(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300 disabled:bg-neutral-100" disabled={!!clientId} />
                        </div>
                    </>
                ) : (
                    <>
                         <div className="col-span-2">
                            <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Raz√£o Social {clientId && '(Leitura)'}</label>
                            <input ref={firstInputRef} value={razaoSocial} onChange={e => setRazaoSocial(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-accent-500/20 outline-none border-neutral-300 disabled:bg-neutral-100" required disabled={!!clientId} />
                        </div>
                        <div className="col-span-2">
                            <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Nome Fantasia</label>
                            <input value={nomeFantasia} onChange={e => setNomeFantasia(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-accent-500/20 outline-none border-neutral-300 disabled:bg-neutral-100" disabled={!!clientId} />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">CNPJ {clientId && '(Leitura)'}</label>
                            <input value={cnpj} onChange={e => setCnpj(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-accent-500/20 outline-none border-neutral-300 disabled:bg-neutral-100" required disabled={!!clientId} />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Inscr. Estadual</label>
                            <input value={ie} onChange={e => setIe(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-accent-500/20 outline-none border-neutral-300 disabled:bg-neutral-100" disabled={!!clientId} />
                        </div>
                    </>
                )}
                
                <div className="col-span-2">
                    <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Observa√ß√µes (Pessoa)</label>
                    <input value={obs} onChange={e => setObs(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-neutral-100 outline-none border-neutral-300" />
                </div>
            </div>

            {/* 2. Contact Data */}
            <div className="border-t border-neutral-200 pt-2 mt-2">
                <h4 className="text-sm font-bold text-neutral-500 mb-3 uppercase">Contatos</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Telefone Principal *</label>
                        <input value={telefone} onChange={e => setTelefone(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300" required />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Telefone 2</label>
                        <input value={telefone2} onChange={e => setTelefone2(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300" />
                    </div>
                     <div>
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Telefone 3</label>
                        <input value={telefone3} onChange={e => setTelefone3(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300" />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Email</label>
                        <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300" />
                    </div>
                </div>
            </div>

            {/* 3. Address Data */}
            <div className="border-t border-neutral-200 pt-2 mt-2">
                <h4 className="text-sm font-bold text-neutral-500 mb-3 uppercase">Endere√ßo</h4>
                <div className="grid grid-cols-4 gap-4">
                     <div className="col-span-3">
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Logradouro</label>
                        <input value={logradouro} onChange={e => setLogradouro(e.target.value)} className="w-full border p-2 rounded border-neutral-300" />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">N√∫mero</label>
                        <input value={numero} onChange={e => setNumero(e.target.value)} className="w-full border p-2 rounded border-neutral-300" />
                    </div>
                     <div className="col-span-2">
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Complemento</label>
                        <input value={complLogradouro} onChange={e => setComplLogradouro(e.target.value)} className="w-full border p-2 rounded border-neutral-300" />
                    </div>
                    <div className="col-span-2">
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Bairro</label>
                        <input value={bairro} onChange={e => setBairro(e.target.value)} className="w-full border p-2 rounded border-neutral-300" />
                    </div>
                    <div className="col-span-3">
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Cidade</label>
                        <input value={cidade} onChange={e => setCidade(e.target.value)} className="w-full border p-2 rounded border-neutral-300" />
                    </div>
                    <div className="col-span-1">
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">UF</label>
                        <input value={estado} onChange={e => setEstado(e.target.value)} maxLength={2} className="w-full border p-2 rounded border-neutral-300 uppercase" />
                    </div>
                </div>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-neutral-600 font-bold hover:bg-neutral-100 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-primary-600 text-white font-black rounded-lg hover:bg-primary-700 disabled:opacity-50 transition-colors shadow-lg shadow-primary-500/30"
                >
                    {loading ? 'Salvando...' : (clientId ? 'Salvar Altera√ß√µes' : 'Salvar Cliente')}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\FechamentoFinanceiroForm.tsx
================================================================================
import { useState, useEffect, type FormEvent } from "react";
import { formatCurrency } from "../../utils/formatCurrency";
import { useNavigate } from "react-router-dom";
import { api } from "../../services/api";
import {
  Calculator,
  Save,
  Truck,
  Plus,
  BadgeCheck,
  Trash2,
  Pen,
  User,
  Car,
  AlertCircle,
  Wrench,
} from "lucide-react";
import { PagamentoClienteForm } from "./PagamentoClienteForm";
import { FornecedorForm } from "./FornecedorForm";
import { LaborManager } from "../os/LaborManager";
import { Modal } from "../ui/Modal";
import { StatusBanner } from "../ui/StatusBanner";
import { Button } from "../ui/Button";
import { ActionButton } from "../ui/ActionButton";

interface FechamentoFinanceiroFormProps {
  preSelectedOsId?: number | null;
  onSuccess: (newItem: any) => void;
  onCancel: () => void;
}

interface ItemOS {
  id_iten: number;
  id_pecas_estoque?: number;
  valor_total: number;
  descricao: string;
  quantidade: number;
  codigo_referencia?: string;
  pecas_estoque?: {
    valor_custo: number;
    nome: string;
  };
  pagamentos_peca?: {
    id_pagamento_peca: number;
    id_fornecedor: number;
    custo_real: number;
    pago_ao_fornecedor: boolean;
  }[];
}

interface IFornecedor {
  id_fornecedor: number;
  nome: string;
}

interface ItemFinanceiroState {
  id_pagamento_peca?: number; // ID se j√° existir
  id_fornecedor: string;
  custo_real: string;
  pago_fornecedor: boolean;
}

interface OSData {
  id_os: number;
  dt_abertura: string;
  status: string;
  valor_total_cliente: number;
  valor_mao_de_obra: number;
  valor_pecas: number;
  itens_os: ItemOS[];
  defeito_relatado?: string;
  diagnostico?: string;
  cliente: {
    pessoa_fisica?: { pessoa: { nome: string } };
    pessoa_juridica?: { nome_fantasia: string };
    telefone_1?: string;
  };
  veiculo: {
    placa: string;
    modelo: string;
    cor: string;
  };
  pagamentos_cliente?: {
    id_pagamento_cliente: number;
    metodo_pagamento: string;
    valor: number;
    data_pagamento: string;
    bandeira_cartao?: string;
    codigo_transacao?: string;
    qtd_parcelas?: number;
    deleted_at?: string;
  }[];
  fechamento_financeiro?: {
    id_fechamento_financeiro: number;
  };
  servicos_mao_de_obra?: {
    id_servico_mao_de_obra: number;
    valor: number;
    funcionario?: {
      pessoa_fisica?: {
        pessoa: {
          nome: string;
        };
      };
      cargo?: string;
    };
  }[];
}

export const FechamentoFinanceiroForm = ({
  preSelectedOsId,
  onSuccess,
  onCancel,
}: FechamentoFinanceiroFormProps) => {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(false);
  const [fetchingOs, setFetchingOs] = useState(false);
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  const [idOs, setIdOs] = useState(
    preSelectedOsId ? String(preSelectedOsId) : "",
  );
  const [osData, setOsData] = useState<OSData | null>(null);
  const [fornecedores, setFornecedores] = useState<IFornecedor[]>([]);

  const [itemsState, setItemsState] = useState<
    Record<number, ItemFinanceiroState>
  >({});
  const [showFornecedorModal, setShowFornecedorModal] = useState(false);
  const [editItem, setEditItem] = useState<ItemOS | null>(null);
  const [paymentModal, setPaymentModal] = useState<{
    isOpen: boolean;
    data: any;
  }>({ isOpen: false, data: null });

  const handleDeletePayment = (id: number) => {
    setConfirmModal({
      isOpen: true,
      title: "Excluir Pagamento",
      message: "Tem certeza que deseja excluir este pagamento?",
      onConfirm: async () => {
        try {
          await api.delete(`/pagamento-cliente/${id}`);
          setStatusMsg({ type: "success", text: "Pagamento removido!" });
          if (osData) fetchOsData(osData.id_os);
        } catch (error) {
          setStatusMsg({ type: "error", text: "Erro ao remover pagamento." });
        }
        setConfirmModal((prev) => ({ ...prev, isOpen: false }));
      },
    });
  };

  // Confirmation Modal State
  const [confirmModal, setConfirmModal] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    onConfirm: () => void;
  }>({ isOpen: false, title: "", message: "", onConfirm: () => {} });

  // Employees State (for LaborManager)
  const [employees, setEmployees] = useState<any[]>([]);

  useEffect(() => {
    loadFornecedores();
    loadEmployees();
    if (preSelectedOsId) {
      fetchOsData(preSelectedOsId);
    }
  }, [preSelectedOsId]);

  const loadFornecedores = async () => {
    try {
      const response = await api.get("/fornecedor");
      setFornecedores(response.data);
    } catch (error) {
      console.error("Erro ao carregar fornecedores");
    }
  };

  const loadEmployees = async () => {
    try {
      const response = await api.get("/funcionario");
      // Ensure we map to the format expected by select options or LaborManager
      setEmployees(response.data);
    } catch (error) {
      console.error("Erro ao carregar funcion√°rios");
    }
  };

  const fetchOsData = async (id: number) => {
    setFetchingOs(true);
    setStatusMsg({ type: null, text: "" });
    try {
      const response = await api.get(`/ordem-de-servico/${id}`);
      const os: OSData = response.data;
      setOsData(os);

      const initialItemsState: Record<number, ItemFinanceiroState> = {};
      os.itens_os.forEach((item) => {
        const existingPayment =
          item.pagamentos_peca && item.pagamentos_peca.length > 0
            ? item.pagamentos_peca[0]
            : null;

        const initialCost = existingPayment
          ? Number(existingPayment.custo_real).toFixed(2)
          : item.pecas_estoque?.valor_custo
            ? "0.00" // Stock parts are already paid, so cost for this closing is 0
            : "";

        initialItemsState[item.id_iten] = {
          id_pagamento_peca: existingPayment?.id_pagamento_peca,
          id_fornecedor: existingPayment
            ? String(existingPayment.id_fornecedor)
            : "",
          custo_real: initialCost,
          pago_fornecedor: existingPayment
            ? existingPayment.pago_ao_fornecedor
            : false,
        };
      });
      setItemsState(initialItemsState);
    } catch (error) {
      console.error(error);
      setStatusMsg({
        type: "error",
        text: "OS n√£o encontrada ou erro ao buscar dados.",
      });
    } finally {
      setFetchingOs(false);
    }
  };

  const handleSearchOs = () => {
    if (!idOs) return;
    fetchOsData(Number(idOs));
  };

  // Auto-save logic
  const saveItemCost = async (
    id_iten: number,
    partialState: ItemFinanceiroState,
  ) => {
    const item = osData?.itens_os.find((i) => i.id_iten === id_iten);
    // Don't save if stock item (double check)
    if (item?.pecas_estoque) return;

    if (!item || !partialState.id_fornecedor || !partialState.custo_real)
      return;

    try {
      const payload = {
        id_item_os: id_iten,
        id_fornecedor: Number(partialState.id_fornecedor),
        custo_real: Number(partialState.custo_real),
        data_compra: new Date().toISOString(),
        pago_ao_fornecedor: partialState.pago_fornecedor,
      };

      if (partialState.id_pagamento_peca) {
        await api.put(
          `/pagamento-peca/${partialState.id_pagamento_peca}`,
          payload,
        );
      } else {
        const res = await api.post("/pagamento-peca", payload);
        // Update the state with the new ID to avoid duplicates on next save
        setItemsState((prev) => ({
          ...prev,
          [id_iten]: {
            ...prev[id_iten],
            id_pagamento_peca: res.data.id_pagamento_peca,
          },
        }));
      }
    } catch (error) {
      console.error("Erro no auto-save do item", error);
    }
  };

  const handleItemChange = (
    id_iten: number,
    field: keyof ItemFinanceiroState,
    value: any,
  ) => {
    setItemsState((prev) => {
      const newState = {
        ...prev,
        [id_iten]: {
          ...prev[id_iten],
          [field]: value,
        },
      };
      return newState;
    });
  };

  const handleItemBlur = (id_iten: number) => {
    let state = itemsState[id_iten];
    if (state) {
      // Format to 2 decimals
      if (state.custo_real && !isNaN(Number(state.custo_real))) {
        const formatted = Number(state.custo_real).toFixed(2);
        if (formatted !== state.custo_real) {
          setItemsState((prev) => ({
            ...prev,
            [id_iten]: { ...prev[id_iten], custo_real: formatted },
          }));
          state = { ...state, custo_real: formatted };
        }
      }
      saveItemCost(id_iten, state);
    }
  };

  // ITEM EDITING
  const handleSaveItemEdit = async (e: FormEvent) => {
    e.preventDefault();
    if (!editItem || !osData) return;

    try {
      const valorTotal =
        Number(editItem.quantidade) *
        Number((editItem as any).valor_venda_unitario);

      await api.put(`/itens-os/${editItem.id_iten}`, {
        descricao: editItem.descricao,
        quantidade: Number(editItem.quantidade),
        valor_venda: Number((editItem as any).valor_venda_unitario),
        valor_total: valorTotal,
        codigo_referencia: editItem.codigo_referencia,
      });

      // Refresh Data
      fetchOsData(osData.id_os);
      setEditItem(null);
      setStatusMsg({ type: "success", text: "Item atualizado!" });
      setTimeout(() => setStatusMsg({ type: null, text: "" }), 2000);
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao atualizar item." });
    }
  };

  const handleDeleteItemOS = (id: number) => {
    setConfirmModal({
      isOpen: true,
      title: "Excluir Item",
      message: "Tem certeza que deseja remover este item da OS?",
      onConfirm: async () => {
        try {
          await api.delete(`/itens-os/${id}`);
          setStatusMsg({ type: "success", text: "Item removido com sucesso!" });
          if (osData) fetchOsData(osData.id_os);
        } catch (error) {
          setStatusMsg({ type: "error", text: "Erro ao remover item." });
        }
        setConfirmModal((prev) => ({ ...prev, isOpen: false }));
      },
    });
  };

  const calculateTotals = () => {
    if (!osData) return { totalReceita: 0, totalCusto: 0, lucro: 0, margem: 0 };

    // Recalculate total revenue based on items + labor (since items might have changed)
    const totalItemsRevenue = osData.itens_os.reduce(
      (acc, item) => acc + Number(item.valor_total),
      0,
    );
    const totalReceita =
      totalItemsRevenue + Number(osData.valor_mao_de_obra || 0);

    let totalCusto = 0;
    Object.values(itemsState).forEach((st) => {
      totalCusto += Number(st.custo_real || 0);
    });

    const lucro = totalReceita - totalCusto;
    const margem = totalReceita > 0 ? (lucro / totalReceita) * 100 : 0;

    return { totalReceita, totalCusto, lucro, margem, totalItemsRevenue };
  };

  const { totalReceita, totalCusto, lucro, totalItemsRevenue } =
    calculateTotals();

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setLoading(true);
    if (!osData) return;

    try {
      // Valida√ß√£o: Verificar se h√° pagamentos registrados (Receita)
      const totalPago =
        osData.pagamentos_cliente?.reduce(
          (acc, p) => (p.deleted_at ? acc : acc + Number(p.valor)),
          0,
        ) || 0;

      if (totalPago === 0) {
        setStatusMsg({
          type: "error",
          text: "Nenhum recebimento registrado. Adicione o pagamento do cliente (se√ß√£o Recebimentos) antes de finalizar.",
        });
        setLoading(false);
        return;
      }

      // 1. Processar Pagamentos (Upsert)
      const pagamentoPromises = osData.itens_os.map(async (item) => {
        const st = itemsState[item.id_iten];

        // Valida√ß√£o de preenchimento dos custos (Ignorar se for pe√ßa de estoque)
        if (
          (!st ||
            !st.id_fornecedor ||
            !st.custo_real ||
            Number(st.custo_real) <= 0) &&
          !item.pecas_estoque
        ) {
          throw new Error(
            `Item "${item.descricao}" est√° sem Fornecedor ou Custo Real definido.`,
          );
        }

        // Salvar apenas se N√ÉO for peca de estoque
        if (
          st &&
          st.id_fornecedor &&
          Number(st.custo_real) > 0 &&
          !item.pecas_estoque
        ) {
          const payload = {
            id_item_os: item.id_iten,
            id_fornecedor: Number(st.id_fornecedor),
            custo_real: Number(st.custo_real),
            data_compra: new Date().toISOString(),
            pago_ao_fornecedor: st.pago_fornecedor,
          };

          if (st.id_pagamento_peca) {
            return api.put(`/pagamento-peca/${st.id_pagamento_peca}`, payload);
          } else {
            return api.post("/pagamento-peca", payload);
          }
        }
        return null;
      });

      await Promise.all(pagamentoPromises);

      // 2. Atualizar status da OS para PRONTO PARA FINANCEIRO (ANTES de consolidar)
      if (
        osData.status !== "FINALIZADA" &&
        osData.status !== "PRONTO PARA FINANCEIRO"
      ) {
        try {
          await api.put(`/ordem-de-servico/${idOs}`, {
            status: "PRONTO PARA FINANCEIRO",
            valor_final: totalReceita,
            valor_pecas: totalItemsRevenue,
          });
        } catch (err) {
          console.error("Erro ao atualizar status da OS:", err);
        }
      }

      // 3. CONSOLIDAR FINANCEIRAMENTE (Novo endpoint que faz TUDO)
      const consolidarPayload = {
        idOs: Number(idOs),
        custoTotalPecasReal: totalCusto,
      };

      let response;
      if (osData.fechamento_financeiro) {
        // Se j√° existe fechamento, apenas atualiza os custos
        response = await api.put(
          `/fechamento-financeiro/${osData.fechamento_financeiro.id_fechamento_financeiro}`,
          {
            id_os: Number(idOs),
            custo_total_pecas_real: totalCusto,
          },
        );
      } else {
        // Se n√£o existe, CONSOLIDA (cria fechamento + lan√ßamentos no caixa + atualiza saldos + cria receb√≠veis)
        response = await api.post(
          "/fechamento-financeiro/consolidar",
          consolidarPayload,
        );
      }

      onSuccess(response.data);
      navigate("/");
    } catch (error: any) {
      console.error(error);
      setStatusMsg({
        type: "error",
        text: error.message || "Erro ao processar fechamento financeiro.",
      });
    } finally {
      setLoading(false);
    }
  };

  const getClientName = () =>
    osData?.cliente?.pessoa_fisica?.pessoa?.nome ||
    osData?.cliente?.pessoa_juridica?.nome_fantasia ||
    "Cliente";

  const getStatusStyle = (status: string) => {
    switch (status) {
      case "FINALIZADA":
        return "bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200";
      case "PAGA_CLIENTE":
        return "bg-neutral-100 text-neutral-600 ring-1 ring-neutral-200";
      case "PRONTO PARA FINANCEIRO":
        return "bg-amber-100 text-amber-700 ring-1 ring-amber-200";
      case "ABERTA":
        return "bg-blue-100 text-blue-700 ring-1 ring-blue-200";
      case "EM_ANDAMENTO":
        return "bg-cyan-100 text-cyan-700 ring-1 ring-cyan-200";
      default:
        return "bg-gray-50 text-gray-500 ring-1 ring-gray-200";
    }
  };

  return (
    <>
      <form onSubmit={handleSubmit} className="space-y-6 relative">
        <StatusBanner
          msg={statusMsg}
          onClose={() => setStatusMsg({ type: null, text: "" })}
        />

        <div className="bg-gray-50 p-4 rounded-xl text-sm text-gray-700 border border-gray-100 flex gap-3">
          <Calculator className="text-gray-400 shrink-0" />
          <div>
            <strong className="block text-gray-900 mb-1">
              Consolida√ß√£o Financeira
            </strong>
            {osData?.fechamento_financeiro
              ? "Edite os custos lan√ßados anteriormente."
              : "Lance os custos reais de cada pe√ßa para calcular o lucro exato desta OS."}
          </div>
        </div>

        {!preSelectedOsId && (
          <div className="flex gap-2">
            <input
              type="number"
              value={idOs}
              onChange={(e) => setIdOs(e.target.value)}
              className="flex-1 border-2 border-gray-100 p-3 rounded-xl focus:border-gray-900 focus:outline-none transition-colors font-bold"
              required
              placeholder="Digite o ID da OS..."
            />
            <button
              type="button"
              onClick={handleSearchOs}
              className="bg-gray-900 text-white px-6 rounded-xl font-bold hover:bg-gray-800 transition-colors"
            >
              Buscar OS
            </button>
          </div>
        )}

        {fetchingOs && (
          <div className="text-center p-4 text-gray-500">
            Carregando dados da OS...
          </div>
        )}

        {osData && (
          <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
            {/* OS Summary Card */}
            <div className="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden flex flex-col">
              {/* HEADER */}
              <div className="bg-gray-50/50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <span className="px-2.5 py-1 rounded-md text-xs font-black uppercase bg-gray-900 text-white tracking-wide">
                    OS #{osData.id_os}
                  </span>
                  <span
                    className={`px-3 py-1 rounded-md text-[10px] font-black uppercase whitespace-nowrap ${getStatusStyle(osData.status)}`}
                  >
                    {osData.status === "PRONTO PARA FINANCEIRO"
                      ? "FINANCEIRO"
                      : osData.status.replace(/_/g, " ")}
                  </span>
                </div>
                <div className="text-right">
                  <span className="text-[10px] font-bold uppercase text-gray-400">
                    Data de Entrada:{" "}
                  </span>
                  <span className="text-xs font-bold text-gray-700">
                    {new Date(
                      osData.dt_abertura || new Date(),
                    ).toLocaleDateString()}
                  </span>
                </div>
              </div>

              {/* GRID INFO */}
              <div className="p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                {/* COL 1: Client & Vehicle (Span 5) */}
                <div className="lg:col-span-5 space-y-6">
                  <div className="flex gap-4">
                    <div className="bg-blue-50 p-3 rounded-xl h-fit">
                      <User className="text-blue-600" size={24} />
                    </div>
                    <div>
                      <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">
                        Cliente
                      </p>
                      <h3 className="font-black text-lg text-gray-900 leading-tight">
                        {getClientName()}
                      </h3>
                      <p className="text-sm font-medium text-gray-500 mt-1">
                        {osData.cliente.telefone_1 || "Sem telefone"}
                      </p>
                    </div>
                  </div>
                  <div className="h-px bg-gray-100 w-full" />
                  <div className="flex gap-4">
                    <div className="bg-orange-50 p-3 rounded-xl h-fit">
                      <Car className="text-orange-600" size={24} />
                    </div>
                    <div>
                      <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">
                        Ve√≠culo
                      </p>
                      <div className="flex items-baseline gap-2">
                        <span className="font-black text-xl text-gray-800 uppercase">
                          {osData.veiculo.placa}
                        </span>
                        <span className="text-sm font-bold text-gray-500 uppercase">
                          {osData.veiculo.modelo}
                        </span>
                      </div>
                      {osData.veiculo.cor && (
                        <div className="flex items-center gap-1 mt-1">
                          <div className="w-2 h-2 rounded-full bg-gray-400" />
                          <span className="text-xs font-bold text-gray-500 uppercase">
                            {osData.veiculo.cor}
                          </span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                {/* COL 2: Defect & Diagnosis (Span 4) */}
                <div className="lg:col-span-4 space-y-4 lg:border-l lg:border-gray-100 lg:pl-8 lg:border-dashed">
                  <div>
                    <p className="text-[10px] font-black text-red-400 uppercase mb-1 tracking-wider flex items-center gap-2">
                      <AlertCircle size={12} /> Defeito Relatado
                    </p>
                    <div className="text-sm font-medium text-gray-700 leading-relaxed bg-red-50/30 p-3 rounded-lg border border-red-50">
                      {osData.defeito_relatado || (
                        <span className="italic text-gray-400">
                          N√£o informado
                        </span>
                      )}
                    </div>
                  </div>
                  <div>
                    <p className="text-[10px] font-black text-blue-400 uppercase mb-1 tracking-wider flex items-center gap-2">
                      <Wrench size={12} /> Diagn√≥stico T√©cnico
                    </p>
                    <div className="text-sm font-medium text-gray-700 leading-relaxed bg-blue-50/30 p-3 rounded-lg border border-blue-50">
                      {osData.diagnostico || (
                        <span className="italic text-gray-400">
                          N√£o informado
                        </span>
                      )}
                    </div>
                  </div>
                </div>

                {/* COL 3: Revenue (Span 3) */}
                <div className="lg:col-span-3 flex flex-col justify-center items-end text-right lg:border-l lg:border-gray-100 lg:border-dashed lg:pl-8">
                  <p className="text-xs font-black text-gray-400 uppercase tracking-widest mb-2">
                    Receita Total
                  </p>
                  <div className="bg-green-50 px-4 py-2 rounded-xl border border-green-100 mb-2">
                    <p className="text-4xl font-black text-green-600 tracking-tight">
                      {formatCurrency(totalReceita)}
                    </p>
                  </div>
                  <p className="text-[10px] font-bold text-gray-400">
                    Valor Final (Pe√ßas + M√£o de Obra)
                  </p>
                </div>
              </div>

              {/* SEPARATOR */}
              <div className="h-px bg-gray-100 mx-6 mb-6" />

              {/* LABOR MANAGER */}
              <div className="px-6 pb-6">
                <div className="border border-blue-100 rounded-xl overflow-hidden text-left bg-blue-50/30">
                  <div className="px-4 py-2 bg-blue-50/50 border-b border-blue-100 flex justify-between items-center">
                    <span className="text-xs font-black uppercase text-blue-600 flex items-center gap-2">
                      <BadgeCheck size={14} /> M√£o de Obra (Execu√ß√£o)
                    </span>
                  </div>
                  <div className="p-3">
                    <LaborManager
                      osId={osData.id_os}
                      mode="api"
                      employees={employees}
                      initialData={osData.servicos_mao_de_obra as any[]}
                      onChange={() => fetchOsData(osData.id_os)}
                      readOnly={false}
                      onTotalChange={(total) => {
                        setOsData((prev) => {
                          if (!prev || prev.valor_mao_de_obra === total)
                            return prev;
                          return { ...prev, valor_mao_de_obra: total };
                        });
                      }}
                    />
                  </div>
                </div>
              </div>
            </div>

            {/* ITEMS TABLE */}
            <div className="border border-gray-200 rounded-2xl overflow-hidden bg-white shadow-sm">
              <div className="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                <h4 className="font-bold text-sm text-gray-700 uppercase tracking-wide">
                  Detalhamento de Custos (Pe√ßas)
                </h4>
                <button
                  type="button"
                  onClick={() => setShowFornecedorModal(true)}
                  className="text-[10px] font-black uppercase text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100 transition-colors flex items-center gap-1"
                >
                  <Plus size={12} /> Novo Fornecedor
                </button>
              </div>
              <table className="w-full text-left">
                <thead className="bg-gray-50/50 text-xs font-bold text-gray-400 uppercase">
                  <tr>
                    <th className="p-4 w-1/3">Item / Pe√ßa</th>
                    <th className="p-4">Ref / Nota</th>
                    <th className="p-4">Fornecedor (Origem)</th>
                    <th className="p-4 w-32">Custo Real (R$)</th>
                    <th className="p-4 text-center w-20">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {osData.itens_os.map((item) => (
                    <tr
                      key={item.id_iten}
                      className="hover:bg-gray-50/50 transition-colors group"
                    >
                      <td className="p-4 relative">
                        <div className="flex justify-between items-start">
                          <div>
                            <p className="font-bold text-gray-800 text-sm">
                              {item.descricao}
                            </p>
                            <p className="text-xs text-gray-400">
                              Qtd: {item.quantidade} x{" "}
                              {formatCurrency(
                                Number(item.valor_total) / item.quantidade,
                              )}{" "}
                              ={" "}
                              <span className="text-green-600 font-bold">
                                {formatCurrency(Number(item.valor_total))}
                              </span>
                            </p>
                          </div>
                        </div>
                      </td>
                      <td className="p-4 text-xs font-mono font-bold text-gray-500">
                        {item.codigo_referencia || "-"}
                      </td>
                      <td className="p-4">
                        {item.pecas_estoque || item.id_pecas_estoque ? (
                          <div className="flex items-center gap-2 px-3 py-2 bg-neutral-100 rounded-lg border border-neutral-200 text-neutral-500 font-bold text-xs uppercase tracking-wider justify-center">
                            <Truck size={14} /> Estoque Pr√≥prio
                          </div>
                        ) : (
                          <select
                            className="w-full p-2.5 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                            value={
                              itemsState[item.id_iten]?.id_fornecedor || ""
                            }
                            onChange={(e) =>
                              handleItemChange(
                                item.id_iten,
                                "id_fornecedor",
                                e.target.value,
                              )
                            }
                            onBlur={() => handleItemBlur(item.id_iten)}
                          >
                            <option value="">-- Selecione --</option>
                            {fornecedores.map((f) => (
                              <option
                                key={f.id_fornecedor}
                                value={f.id_fornecedor}
                              >
                                {f.nome}
                              </option>
                            ))}
                          </select>
                        )}
                      </td>
                      <td className="p-4">
                        {item.pecas_estoque || item.id_pecas_estoque ? (
                          <div className="relative opacity-50">
                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs font-bold">
                              R$
                            </span>
                            <input
                              disabled
                              value="0.00"
                              className="w-full pl-8 pr-3 py-2 border border-gray-200 rounded-lg text-sm font-bold text-gray-400 bg-gray-50 cursor-not-allowed"
                            />
                            <div className="text-[9px] text-gray-400 mt-1 text-center font-medium">
                              {item.pecas_estoque
                                ? `Custo Orig: ${formatCurrency(Number(item.pecas_estoque.valor_custo))}`
                                : "Estoque"}
                            </div>
                          </div>
                        ) : (
                          <div className="relative">
                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs font-bold">
                              R$
                            </span>
                            <input
                              type="number"
                              step="0.01"
                              value={itemsState[item.id_iten]?.custo_real}
                              onChange={(e) =>
                                handleItemChange(
                                  item.id_iten,
                                  "custo_real",
                                  e.target.value,
                                )
                              }
                              onBlur={() => handleItemBlur(item.id_iten)}
                              className="w-full pl-8 pr-3 py-2 border border-gray-200 rounded-lg text-sm font-bold text-red-600 focus:ring-2 focus:ring-red-500 outline-none"
                              placeholder="0.00"
                            />
                          </div>
                        )}
                      </td>
                      <td className="p-4 text-center">
                        <div className="flex items-center justify-center gap-2">
                          <ActionButton
                            icon={Pen}
                            label="Editar Item"
                            onClick={() =>
                              setEditItem({
                                ...item,
                                valor_venda_unitario:
                                  Number(item.valor_total) / item.quantidade,
                              } as any)
                            }
                            variant="accent"
                          />
                          <ActionButton
                            icon={Trash2}
                            label="Excluir Item"
                            onClick={() => handleDeleteItemOS(item.id_iten)}
                            variant="danger"
                          />
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {osData.itens_os.length === 0 && (
                <div className="p-8 text-center text-gray-400 font-medium">
                  Nenhum item lan√ßado nesta OS.
                </div>
              )}
            </div>

            {/* PAGAMENTOS RECEBIDOS (CRUD) */}
            <div className="border border-green-200 rounded-2xl overflow-hidden bg-white shadow-sm mt-6">
              <div className="bg-green-50 px-4 py-3 border-b border-green-200 flex justify-between items-center">
                <h4 className="font-bold text-sm text-green-800 uppercase tracking-wide">
                  Recebimentos (Pagamentos do Cliente)
                </h4>
                <button
                  type="button"
                  onClick={() => setPaymentModal({ isOpen: true, data: null })}
                  className="text-[10px] font-black uppercase text-green-700 bg-white border border-green-200 px-3 py-1.5 rounded-lg hover:bg-green-100 transition-colors flex items-center gap-1"
                >
                  <Plus size={12} /> Novo Pagamento
                </button>
              </div>
              <table className="w-full text-left text-xs">
                <thead className="bg-white border-b border-green-100 text-green-400 font-bold uppercase">
                  <tr>
                    <th className="p-3">Data</th>
                    <th className="p-3">M√©todo</th>
                    <th className="p-3">Pars.</th>
                    <th className="p-3">NSU / C√≥d.</th>
                    <th className="p-3 text-right">Valor</th>
                    <th className="p-3 text-center">Status</th>
                    <th className="p-3 text-center">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-green-50">
                  {osData.pagamentos_cliente
                    ?.sort(
                      (a, b) =>
                        new Date(b.data_pagamento).getTime() -
                        new Date(a.data_pagamento).getTime(),
                    )
                    .map((pag) => {
                      const isDeleted = !!pag.deleted_at;
                      return (
                        <tr
                          key={pag.id_pagamento_cliente}
                          className={
                            isDeleted
                              ? "bg-red-50 opacity-60"
                              : "hover:bg-green-50/50"
                          }
                        >
                          <td
                            className={`p-3 ${isDeleted ? "line-through" : ""}`}
                          >
                            {new Date(pag.data_pagamento).toLocaleDateString()}
                          </td>
                          <td
                            className={`p-3 font-bold ${isDeleted ? "line-through" : ""}`}
                          >
                            {pag.metodo_pagamento}
                            {pag.bandeira_cartao && (
                              <span className="text-gray-400 font-normal ml-1">
                                ({pag.bandeira_cartao})
                              </span>
                            )}
                          </td>
                          <td
                            className={`p-3 font-bold text-center ${isDeleted ? "line-through" : ""}`}
                          >
                            {pag.qtd_parcelas && pag.qtd_parcelas > 1
                              ? `${pag.qtd_parcelas}x`
                              : "-"}
                          </td>
                          <td
                            className={`p-3 font-mono text-gray-500 ${isDeleted ? "line-through" : ""}`}
                          >
                            {pag.codigo_transacao || "-"}
                          </td>
                          <td
                            className={`p-3 text-right font-black ${isDeleted ? "line-through text-red-800" : "text-green-700"}`}
                          >
                            {formatCurrency(Number(pag.valor))}
                          </td>
                          <td className="p-3 text-center">
                            {isDeleted ? (
                              <span className="text-[9px] font-black text-red-500 uppercase rounded bg-white px-1">
                                Exclu√≠do
                              </span>
                            ) : (
                              <span className="text-[9px] font-black text-green-600 uppercase">
                                Ativo
                              </span>
                            )}
                          </td>
                          <td className="p-3 text-center">
                            {!isDeleted && (
                              <div className="flex justify-center gap-2">
                                <button
                                  type="button"
                                  onClick={() =>
                                    setPaymentModal({ isOpen: true, data: pag })
                                  }
                                  className="text-gray-400 hover:text-blue-600"
                                >
                                  <BadgeCheck size={14} />
                                </button>
                                <button
                                  type="button"
                                  onClick={() =>
                                    handleDeletePayment(
                                      pag.id_pagamento_cliente,
                                    )
                                  }
                                  className="text-gray-400 hover:text-red-600"
                                >
                                  <Trash2 size={14} />
                                </button>
                              </div>
                            )}
                          </td>
                        </tr>
                      );
                    })}
                  {(!osData.pagamentos_cliente ||
                    osData.pagamentos_cliente.length === 0) && (
                    <tr>
                      <td colSpan={6} className="p-4 text-center text-gray-400">
                        Nenhum pagamento registrado.
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
            <div
              className={`p-6 rounded-2xl border-2 transition-colors ${lucro >= 0 ? "bg-green-50 border-green-100" : "bg-red-50 border-red-100"}`}
            >
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
                <div>
                  <p className="text-xs font-bold uppercase text-gray-500 mb-1">
                    Valor Pe√ßas (Cobrado)
                  </p>
                  <p className="text-3xl font-black text-gray-900">
                    {formatCurrency(totalItemsRevenue || 0)}
                  </p>
                  <p className="text-[10px] uppercase font-bold text-gray-400 mt-1">
                    Ref:{" "}
                    <span
                      className={lucro >= 0 ? "text-green-600" : "text-red-600"}
                    >
                      {formatCurrency((totalItemsRevenue || 0) - totalCusto)}
                    </span>
                  </p>
                </div>

                <div className="md:text-center">
                  <p className="text-xs font-bold uppercase text-gray-500 mb-1">
                    M√£o de Obra Total
                  </p>
                  <p className="text-3xl font-black text-blue-600">
                    {formatCurrency(Number(osData.valor_mao_de_obra || 0))}
                  </p>
                </div>

                <div className="md:text-right">
                  <p className="text-xs font-bold uppercase text-gray-500 mb-1">
                    Valor Final (OS)
                  </p>
                  <p className="text-4xl font-black text-green-600">
                    {formatCurrency(totalReceita)}
                  </p>
                  {(() => {
                    const totalPago =
                      osData.pagamentos_cliente
                        ?.filter((p) => !p.deleted_at)
                        .reduce((acc, p) => acc + Number(p.valor), 0) || 0;
                    const restante = totalReceita - totalPago;
                    const isOk = restante <= 0.01;
                    return (
                      <div
                        className={`mt-2 inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-black uppercase ${isOk ? "bg-green-100 text-green-700" : "bg-red-100 text-red-700"}`}
                      >
                        {isOk ? (
                          <>
                            <BadgeCheck size={14} /> OK (QUITADO)
                          </>
                        ) : (
                          <>
                            <div className="w-2 h-2 rounded-full bg-red-600 animate-pulse" />{" "}
                            PENDENTE
                          </>
                        )}
                      </div>
                    );
                  })()}
                </div>
              </div>
            </div>

            <div className="flex gap-3 pt-4 border-t border-gray-100">
              <button
                type="button"
                onClick={onCancel}
                className="flex-1 py-4 text-gray-600 font-bold hover:bg-gray-50 rounded-xl transition-colors"
              >
                Cancelar
              </button>

              {osData.status === "FINALIZADA" && (
                <button
                  type="button"
                  onClick={async () => {
                    if (!osData) return;
                    try {
                      if (osData.fechamento_financeiro) {
                        await api.delete(
                          `/fechamento-financeiro/${osData.fechamento_financeiro.id_fechamento_financeiro}`,
                        );
                      }
                      await api.put(`/ordem-de-servico/${osData.id_os}`, {
                        status: "ABERTA",
                        valor_mao_de_obra: osData.valor_mao_de_obra,
                      });
                      setStatusMsg({
                        type: "success",
                        text: "OS Reaberta com sucesso!",
                      });
                      onSuccess(osData);
                    } catch (e) {
                      setStatusMsg({
                        type: "error",
                        text: "Erro ao reabrir OS.",
                      });
                    }
                  }}
                  className="flex-1 py-4 text-orange-600 font-bold hover:bg-orange-50 rounded-xl transition-colors border border-orange-100"
                >
                  Reabrir OS
                </button>
              )}

              <Button
                type="submit"
                isLoading={loading}
                variant="success"
                className="flex-1 py-4 shadow-xl shadow-green-200"
              >
                <Save size={18} />{" "}
                {osData.fechamento_financeiro
                  ? "Atualizar Dados"
                  : "Confirmar & Fechar OS"}
              </Button>
            </div>
          </div>
        )}
      </form>

      {/* MODALS OUTSIDE THE MAIN FORM */}

      {showFornecedorModal && (
        <Modal
          title="Novo Fornecedor"
          onClose={() => setShowFornecedorModal(false)}
        >
          <FornecedorForm
            onSuccess={() => {
              setShowFornecedorModal(false);
              loadFornecedores();
            }}
            onCancel={() => setShowFornecedorModal(false)}
          />
        </Modal>
      )}

      {paymentModal.isOpen && osData && (
        <Modal
          title={paymentModal.data ? "Editar Pagamento" : "Novo Pagamento"}
          onClose={() => setPaymentModal({ isOpen: false, data: null })}
        >
          <PagamentoClienteForm
            osId={osData.id_os}
            valorTotal={
              osData!.itens_os.reduce(
                (acc, i) => acc + Number(i.valor_total),
                0,
              ) +
              Number(osData!.valor_mao_de_obra || 0) -
              (osData!.pagamentos_cliente
                ?.filter(
                  (p) =>
                    !p.deleted_at &&
                    p.id_pagamento_cliente !==
                      paymentModal.data?.id_pagamento_cliente,
                )
                .reduce((acc, p) => acc + Number(p.valor), 0) || 0)
            }
            initialData={paymentModal.data}
            onSuccess={() => {
              setPaymentModal({ isOpen: false, data: null });
              fetchOsData(osData.id_os);
              setStatusMsg({ type: "success", text: "Pagamento salvo!" });
            }}
            onCancel={() => setPaymentModal({ isOpen: false, data: null })}
          />
        </Modal>
      )}

      {editItem && (
        <Modal title="Editar Item da OS" onClose={() => setEditItem(null)}>
          <div className="space-y-4">
            <div>
              <label className="text-xs font-bold text-gray-500 uppercase">
                Descri√ß√£o
              </label>
              <input
                value={editItem.descricao}
                onChange={(e) =>
                  setEditItem({ ...editItem, descricao: e.target.value })
                }
                className="w-full border p-3 rounded-xl font-bold"
              />
            </div>
            <div>
              <label className="text-xs font-bold text-gray-500 uppercase">
                Ref / Nota
              </label>
              <input
                value={editItem.codigo_referencia || ""}
                onChange={(e) =>
                  setEditItem({
                    ...editItem,
                    codigo_referencia: e.target.value,
                  })
                }
                className="w-full border p-3 rounded-xl font-bold"
              />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-xs font-bold text-gray-500 uppercase">
                  Quantidade
                </label>
                <input
                  type="number"
                  value={editItem.quantidade}
                  onChange={(e) =>
                    setEditItem({
                      ...editItem,
                      quantidade: Number(e.target.value),
                    })
                  }
                  className="w-full border p-3 rounded-xl font-bold"
                />
              </div>
              <div>
                <label className="text-xs font-bold text-gray-500 uppercase">
                  Valor Unit√°rio (Venda)
                </label>
                <input
                  type="number"
                  step="0.01"
                  value={(editItem as any).valor_venda_unitario}
                  onChange={(e) =>
                    setEditItem({
                      ...editItem,
                      valor_venda_unitario: e.target.value,
                    } as any)
                  }
                  className="w-full border p-3 rounded-xl font-bold"
                />
              </div>
            </div>
            <div className="flex justify-end gap-2 mt-4">
              <button
                onClick={() => setEditItem(null)}
                className="px-4 py-2 text-gray-500 font-bold"
              >
                Cancelar
              </button>
              <button
                onClick={handleSaveItemEdit}
                className="bg-green-600 text-white px-6 py-2 rounded-xl font-bold"
              >
                Salvar Altera√ß√µes
              </button>
            </div>
          </div>
        </Modal>
      )}

      {/* Confirmation Modal */}
      {confirmModal.isOpen && (
        <Modal
          title={confirmModal.title}
          onClose={() =>
            setConfirmModal((prev) => ({ ...prev, isOpen: false }))
          }
        >
          <div className="space-y-6">
            <p className="text-neutral-600 font-medium">
              {confirmModal.message}
            </p>
            <div className="flex justify-end gap-3 pt-2">
              <button
                type="button"
                onClick={() =>
                  setConfirmModal((prev) => ({ ...prev, isOpen: false }))
                }
                className="px-5 py-2.5 text-neutral-600 font-bold hover:bg-neutral-100 rounded-lg transition-colors"
              >
                Cancelar
              </button>
              <button
                type="button"
                onClick={confirmModal.onConfirm}
                className="px-5 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors shadow-lg shadow-red-500/30"
              >
                Confirmar
              </button>
            </div>
          </div>
        </Modal>
      )}
    </>
  );
};



================================================================================
FILE PATH: client\src\components\forms\FornecedorForm.tsx
================================================================================
import { useState, useEffect, type FormEvent } from "react";
import { api } from "../../services/api";
import {
  Phone,
  FileText,
  BadgeCheck,
  MapPin,
  DollarSign,
  ArrowLeft,
  Search,
  Building2,
} from "lucide-react";
import type { IFornecedor } from "../../types/backend";
import { Button } from "../ui/Button";
import { Input } from "../ui/input";

interface FornecedorFormProps {
  initialData?: IFornecedor | null;
  onSuccess: (data?: IFornecedor) => void;
  onCancel: () => void;
}

export const FornecedorForm = ({
  initialData,
  onSuccess,
  onCancel,
}: FornecedorFormProps) => {
  const [loading, setLoading] = useState(false);

  // Form State
  const [formData, setFormData] = useState({
    // Identifica√ß√£o
    tipo_pessoa: "JURIDICA",
    nome: "", // Raz√£o Social / Nome Completo
    nome_fantasia: "",
    documento: "", // CNPJ / CPF
    inscricao_estadual: "",
    inscricao_municipal: "",

    // Contato
    contato: "", // Nome Vendedor
    telefone: "",
    whatsapp: "",
    email: "",

    // Endere√ßo
    cep: "",
    logradouro: "",
    numero: "",
    complemento: "",
    bairro: "",
    cidade: "",
    uf: "",

    // Financeiro
    banco: "",
    agencia: "",
    conta: "",
    chave_pix: "",
    condicoes_pagamento: "",
    categoria_produto: "",

    // Extra
    obs: "",
  });

  useEffect(() => {
    if (initialData) {
      setFormData({
        tipo_pessoa: initialData.tipo_pessoa || "JURIDICA",
        nome: initialData.nome || "",
        nome_fantasia: initialData.nome_fantasia || "",
        documento: initialData.documento || "",
        inscricao_estadual: initialData.inscricao_estadual || "",
        inscricao_municipal: initialData.inscricao_municipal || "",

        contato: initialData.contato || "",
        telefone: initialData.telefone || "",
        whatsapp: initialData.whatsapp || "",
        email: initialData.email || "",

        cep: initialData.cep || "",
        logradouro: initialData.logradouro || "",
        numero: initialData.numero || "",
        complemento: initialData.complemento || "",
        bairro: initialData.bairro || "",
        cidade: initialData.cidade || "",
        uf: initialData.uf || "",

        banco: initialData.banco || "",
        agencia: initialData.agencia || "",
        conta: initialData.conta || "",
        chave_pix: initialData.chave_pix || "",
        condicoes_pagamento: initialData.condicoes_pagamento || "",
        categoria_produto: initialData.categoria_produto || "",

        obs: initialData.obs || "",
      });
    }
  }, [initialData]);

  const handleChange = (field: string, value: string) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
  };

  const handleCepBlur = async () => {
    const cepRaw = formData.cep.replace(/\D/g, "");
    if (cepRaw.length === 8) {
      try {
        const response = await fetch(
          `https://viacep.com.br/ws/${cepRaw}/json/`,
        );
        const data = await response.json();
        if (!data.erro) {
          setFormData((prev) => ({
            ...prev,
            logradouro: data.logradouro,
            bairro: data.bairro,
            cidade: data.localidade,
            uf: data.uf,
          }));
        }
      } catch (error) {
        console.error("Erro ao buscar CEP", error);
      }
    }
  };

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setLoading(true);
    try {
      let res;
      if (initialData?.id_fornecedor) {
        res = await api.put(
          `/fornecedor/${initialData.id_fornecedor}`,
          formData,
        );
      } else {
        res = await api.post("/fornecedor", formData);
      }
      onSuccess(res.data);
    } catch (error) {
      console.error(error);
      alert("Erro ao salvar fornecedor.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6 text-neutral-900">
      {/* Header / Actions */}
      <div className="flex items-center justify-between sticky top-0 bg-neutral-25 ackdrop-blur-md p-4 rounded-2xl border border-neutral-200 shadow-sm z-10">
        <div className="flex items-center gap-4">
          <button
            type="button"
            onClick={onCancel}
            className="p-2 hover:bg-neutral-100 rounded-xl transition-colors text-neutral-500"
          >
            <ArrowLeft size={24} />
          </button>
          <div>
            <h2 className="text-2xl font-bold text-neutral-500">
              {initialData ? "Editar Fornecedor" : "Novo Fornecedor"}
            </h2>
            <p className="text-neutral-500">
              Preencha os dados completos do parceiro.
            </p>
          </div>
        </div>
        <div className="flex gap-3">
          <Button variant="ghost" icon={ArrowLeft} onClick={onCancel}>
            Cancelar
          </Button>

          <Button
            variant="primary"
            icon={BadgeCheck}
            type="submit"
            disabled={loading}
          >
            Salvar Dados
          </Button>
        </div>
      </div>

      <div className="grid grid-cols-1 xl:grid-cols-3 gap-8">
        {/* LEFT COLUMN: Identification & Contact */}
        <div className="space-y-8 xl:col-span-2">
          {/* SECTION 1: IDENTIFICA√á√ÉO */}
          <div className="bg-neutral-25 p-6 sm:p-8 rounded-3xl border border-neutral-200 shadow-sm space-y-6">
            <div className="flex items-center gap-3 pb-4 border-b border-neutral-50">
              <div className="p-3 bg-orange-50 text-orange-600 rounded-xl">
                <Building2 size={24} />
              </div>
              <h3 className="text-lg font-bold text-neutral-500">
                Identifica√ß√£o
              </h3>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="md:col-span-2">
                <label className="block text-xs font-bold text-neutral-400 uppercase mb-2">
                  Tipo de Pessoa
                </label>
                <div className="flex gap-4">
                  <label
                    className={`flex-1 cursor-pointer border px-4 py-2.5 rounded-lg flex items-center justify-center gap-2 font-bold text-sm transition-all ${formData.tipo_pessoa === "JURIDICA" ? "border-orange-500 bg-orange-50 text-orange-700" : "border-neutral-200 text-neutral-500 hover:border-neutral-300"}`}
                  >
                    <input
                      type="radio"
                      name="tipo_pessoa"
                      value="JURIDICA"
                      checked={formData.tipo_pessoa === "JURIDICA"}
                      onChange={(e) =>
                        handleChange("tipo_pessoa", e.target.value)
                      }
                      className="hidden"
                    />
                    Jur√≠dica (CNPJ)
                  </label>
                  <label
                    className={`flex-1 cursor-pointer border px-4 py-2.5 rounded-lg flex items-center justify-center gap-2 font-bold text-sm transition-all ${formData.tipo_pessoa === "FISICA" ? "border-orange-500 bg-orange-50 text-orange-700" : "border-neutral-200 text-neutral-500 hover:border-neutral-300"}`}
                  >
                    <input
                      type="radio"
                      name="tipo_pessoa"
                      value="FISICA"
                      checked={formData.tipo_pessoa === "FISICA"}
                      onChange={(e) =>
                        handleChange("tipo_pessoa", e.target.value)
                      }
                      className="hidden"
                    />
                    F√≠sica (CPF)
                  </label>
                </div>
              </div>

              <div className="md:col-span-2">
                <Input
                  label="Raz√£o Social / Nome Completo *"
                  value={formData.nome}
                  onChange={(e) => handleChange("nome", e.target.value)}
                  placeholder="Nome oficial no documento"
                  required
                />
              </div>

              <div>
                <Input
                  label="Nome Fantasia"
                  value={formData.nome_fantasia}
                  onChange={(e) =>
                    handleChange("nome_fantasia", e.target.value)
                  }
                  placeholder="Como a empresa √© conhecida"
                />
              </div>

              <div>
                <Input
                  label={formData.tipo_pessoa === "JURIDICA" ? "CNPJ" : "CPF"}
                  value={formData.documento}
                  onChange={(e) => handleChange("documento", e.target.value)}
                  placeholder="Apenas n√∫meros"
                />
              </div>

              <div>
                <Input
                  label="Inscri√ß√£o Estadual"
                  value={formData.inscricao_estadual}
                  onChange={(e) =>
                    handleChange("inscricao_estadual", e.target.value)
                  }
                  placeholder="IE (Com√©rcio)"
                />
              </div>

              <div>
                <Input
                  label="Inscri√ß√£o Municipal"
                  value={formData.inscricao_municipal}
                  onChange={(e) =>
                    handleChange("inscricao_municipal", e.target.value)
                  }
                  placeholder="IM (Servi√ßos)"
                />
              </div>
            </div>
          </div>

          {/* SECTION 2: ENDERE√áO (LOG√çSTICA) */}
          <div className="bg-neutral-25 p-6 sm:p-8 rounded-3xl border border-neutral-200 shadow-sm space-y-6">
            <div className="flex items-center gap-3 pb-4 border-b border-neutral-50">
              <div className="p-3 bg-primary-50 text-primary-600 rounded-xl">
                <MapPin size={24} />
              </div>
              <h3 className="text-lg font-bold text-neutral-500">
                Endere√ßo e Log√≠stica
              </h3>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-6 gap-6">
              <div className="md:col-span-2">
                <Input
                  label="CEP"
                  value={formData.cep}
                  onChange={(e) => handleChange("cep", e.target.value)}
                  onBlur={handleCepBlur}
                  placeholder="00000-000"
                  icon={Search}
                />
              </div>

              <div className="md:col-span-4">
                <Input
                  label="Logradouro"
                  value={formData.logradouro}
                  onChange={(e) => handleChange("logradouro", e.target.value)}
                  placeholder="Rua, Avenida, etc."
                  className="uppercase"
                />
              </div>

              <div className="md:col-span-2">
                <Input
                  label="N√∫mero"
                  value={formData.numero}
                  onChange={(e) => handleChange("numero", e.target.value)}
                />
              </div>

              <div className="md:col-span-2">
                <Input
                  label="Complemento"
                  value={formData.complemento}
                  onChange={(e) => handleChange("complemento", e.target.value)}
                  placeholder="Sala, Bloco..."
                />
              </div>

              <div className="md:col-span-2">
                <Input
                  label="Bairro"
                  value={formData.bairro}
                  onChange={(e) => handleChange("bairro", e.target.value)}
                  className="uppercase"
                />
              </div>

              <div className="md:col-span-4">
                <Input
                  label="Cidade"
                  value={formData.cidade}
                  onChange={(e) => handleChange("cidade", e.target.value)}
                  className="uppercase"
                />
              </div>

              <div className="md:col-span-2">
                <Input
                  label="UF"
                  value={formData.uf}
                  onChange={(e) => handleChange("uf", e.target.value)}
                  className="uppercase"
                  maxLength={2}
                />
              </div>
            </div>
          </div>
        </div>

        {/* RIGHT COLUMN: Contact & Finance */}
        <div className="space-y-8">
          {/* SECTION 3: CONTATO */}
          <div className="bg-neutral-25 p-6 sm:p-8 rounded-3xl border border-neutral-200 shadow-sm space-y-6">
            <div className="flex items-center gap-3 pb-4 border-b border-neutral-50">
              <div className="p-3 bg-green-50 text-green-600 rounded-xl">
                <Phone size={24} />
              </div>
              <h3 className="text-lg font-bold text-neutral-500">
                Dados de Contato
              </h3>
            </div>

            <div className="space-y-4">
              <div>
                <Input
                  label="Vendedor / Contato"
                  value={formData.contato}
                  onChange={(e) => handleChange("contato", e.target.value)}
                  placeholder="Com quem falar"
                />
              </div>
              <div>
                <Input
                  label="Telefone Fixo"
                  value={formData.telefone}
                  onChange={(e) => handleChange("telefone", e.target.value)}
                />
              </div>
              <div>
                <Input
                  label="WhatsApp / Celular"
                  value={formData.whatsapp}
                  onChange={(e) => handleChange("whatsapp", e.target.value)}
                />
              </div>
              <div>
                <Input
                  label="E-mail (NFE/Boletos)"
                  type="email"
                  value={formData.email}
                  onChange={(e) => handleChange("email", e.target.value)}
                  placeholder="financeiro@empresa.com"
                />
              </div>
            </div>
          </div>

          {/* SECTION 4: FINANCEIRO */}
          <div className="bg-neutral-25 p-6 sm:p-8 rounded-3xl border border-neutral-200 shadow-sm space-y-6">
            <div className="flex items-center gap-3 pb-4 border-b border-neutral-50">
              <div className="p-3 bg-purple-50 text-purple-600 rounded-xl">
                <DollarSign size={24} />
              </div>
              <h3 className="text-lg font-bold text-neutral-500">Financeiro</h3>
            </div>

            <div className="space-y-4">
              <div>
                <label className="block text-xs font-bold text-neutral-400 uppercase mb-2">
                  Dados Banc√°rios / PIX
                </label>
                <div className="grid grid-cols-2 gap-2 mb-2">
                  <Input
                    value={formData.banco}
                    onChange={(e) => handleChange("banco", e.target.value)}
                    placeholder="Banco"
                  />
                  <Input
                    value={formData.agencia}
                    onChange={(e) => handleChange("agencia", e.target.value)}
                    placeholder="Ag√™ncia"
                  />
                  <div className="col-span-2">
                    <Input
                      value={formData.conta}
                      onChange={(e) => handleChange("conta", e.target.value)}
                      placeholder="Conta Corrente"
                    />
                  </div>
                </div>
                <Input
                  value={formData.chave_pix}
                  onChange={(e) => handleChange("chave_pix", e.target.value)}
                  placeholder="Chave PIX"
                />
              </div>

              <div>
                <Input
                  label="Condi√ß√£o de Pagamento"
                  value={formData.condicoes_pagamento}
                  onChange={(e) =>
                    handleChange("condicoes_pagamento", e.target.value)
                  }
                  placeholder="Ex: 28 dias, 30/60..."
                />
              </div>

              <div>
                <Input
                  label="Categoria de Produto"
                  value={formData.categoria_produto}
                  onChange={(e) =>
                    handleChange("categoria_produto", e.target.value)
                  }
                  placeholder="Ex: Pe√ßas Motor, Pneus..."
                />
              </div>
            </div>
          </div>
        </div>

        {/* FULL WIDTH: OBS */}
        <div className="xl:col-span-3 bg-white p-6 sm:p-8 rounded-3xl border border-neutral-100 shadow-sm space-y-6">
          <div className="flex items-center gap-3 pb-4 border-b border-neutral-50">
            <div className="p-3 bg-neutral-100 text-neutral-600 rounded-xl">
              <FileText size={24} />
            </div>
            <h3 className="text-lg font-bold text-neutral-500">
              Observa√ß√µes Gerais
            </h3>
          </div>
          <textarea
            value={formData.obs}
            onChange={(e) => handleChange("obs", e.target.value)}
            className="w-full bg-neutral-50 border border-neutral-200 p-4 rounded-xl focus:ring-4 focus:ring-neutral-500/10 focus:border-neutral-500 outline-none font-medium text-neutral-800 transition-all min-h-[120px] resize-none"
            placeholder="Informa√ß√µes adicionais importantes..."
          />
        </div>
      </div>
    </form>
  );
};



================================================================================
FILE PATH: client\src\components\forms\FuncionarioForm.tsx
================================================================================
import { useState, useEffect, type FormEvent } from "react";
import { api } from "../../services/api";
import {
  User,
  Briefcase,
  MapPin,
  DollarSign,
  BadgeCheck,
  ArrowLeft,
  Search,
  Smartphone,
  ShieldCheck,
} from "lucide-react";
import type { IFuncionario } from "../../types/backend";

import { Button } from "../ui/Button";
import { Input } from "../ui/input";
import { Modal } from "../ui/Modal";

interface FuncionarioFormProps {
  initialData?: IFuncionario | null;
  onSuccess: () => void;
  onCancel: () => void;
}

export const FuncionarioForm = ({
  initialData,
  onSuccess,
  onCancel,
}: FuncionarioFormProps) => {
  const [loading, setLoading] = useState(false);
  const [isDirty, setIsDirty] = useState(false);

  // Confirmation Modal State
  const [confirmModal, setConfirmModal] = useState<{
    show: boolean;
    type: "save" | "cancel";
  }>({ show: false, type: "save" });

  const [formData, setFormData] = useState({
    // Pessoa / PF (Base)
    nome: "",
    genero: "",
    dt_nascimento: "",
    cpf: "",
    rg: "",

    // Identifica√ß√£o Profissional (MEI) - Funcionario Table
    razao_social: "",
    nome_fantasia: "",
    cnpj_mei: "",
    inscricao_municipal: "",

    // Endere√ßo (Funcionario Table)
    cep: "",
    logradouro: "",
    numero: "",
    complemento: "",
    bairro: "",
    cidade: "",
    uf: "",

    // Contato Pessoal
    telefone_pessoal: "",
    email_pessoal: "",

    // Operacional
    cargo: "",
    ativo: "S",
    dt_admissao: new Date().toISOString().split("T")[0],
    especialidade: "",
    tipo_pagamento: "", // HORA / FIXO
    valor_pagamento: "",

    // Comiss√µes
    comissao: "", // MO %
    comissao_pecas: "", // Pe√ßas %

    // Financeiro
    banco: "",
    agencia: "",
    conta: "",
    chave_pix: "",
    periodicidade_pagamento: "",
    dia_vencimento: "",

    // Doc Links
    url_ccmei: "",
    url_cnh: "",
    equipamentos_epis: "",

    obs: "",
  });

  useEffect(() => {
    if (initialData) {
      const pf = initialData.pessoa_fisica;
      const p = pf?.pessoa;

      setFormData({
        nome: p?.nome || "",
        genero: p?.genero || "",
        dt_nascimento: p?.dt_nascimento
          ? new Date(p.dt_nascimento).toISOString().split("T")[0]
          : "",
        cpf: pf?.cpf || "",
        rg: initialData.rg || "",

        razao_social: initialData.razao_social || "",
        nome_fantasia: initialData.nome_fantasia || "",
        cnpj_mei: initialData.cnpj_mei || "",
        inscricao_municipal: initialData.inscricao_municipal || "",

        cep: initialData.cep || "",
        logradouro: initialData.logradouro || "",
        numero: initialData.numero || "",
        complemento: initialData.complemento || "",
        bairro: initialData.bairro || "",
        cidade: initialData.cidade || "",
        uf: initialData.uf || "",

        telefone_pessoal: initialData.telefone_pessoal || "",
        email_pessoal: initialData.email_pessoal || "",

        cargo: initialData.cargo || "",
        ativo: initialData.ativo || "S",
        dt_admissao: initialData.dt_admissao
          ? new Date(initialData.dt_admissao).toISOString().split("T")[0]
          : "",
        especialidade: initialData.especialidade || "",
        tipo_pagamento: initialData.tipo_pagamento || "",
        valor_pagamento: initialData.valor_pagamento
          ? String(initialData.valor_pagamento)
          : "",

        comissao: initialData.comissao ? String(initialData.comissao) : "",
        comissao_pecas: initialData.comissao_pecas
          ? String(initialData.comissao_pecas)
          : "",

        banco: initialData.banco || "",
        agencia: initialData.agencia || "",
        conta: initialData.conta || "",
        chave_pix: initialData.chave_pix || "",
        periodicidade_pagamento: initialData.periodicidade_pagamento || "",
        dia_vencimento: initialData.dia_vencimento
          ? String(initialData.dia_vencimento)
          : "",

        url_ccmei: initialData.url_ccmei || "",
        url_cnh: initialData.url_cnh || "",
        equipamentos_epis: initialData.equipamentos_epis || "",

        obs: initialData.obs || "",
      });
    }
  }, [initialData]);

  const handleChange = (field: string, value: string) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
    setIsDirty(true);
  };

  const handleCepBlur = async () => {
    const cepRaw = formData.cep.replace(/\D/g, "");
    if (cepRaw.length === 8) {
      try {
        const response = await fetch(
          `https://viacep.com.br/ws/${cepRaw}/json/`,
        );
        const data = await response.json();
        if (!data.erro) {
          setFormData((prev) => ({
            ...prev,
            logradouro: data.logradouro,
            bairro: data.bairro,
            cidade: data.localidade,
            uf: data.uf,
          }));
          setIsDirty(true);
        }
      } catch (error) {
        console.error("Erro CEP", error);
      }
    }
  };

  // Logic to execute the save action
  const executeSubmit = async () => {
    setConfirmModal((prev) => ({ ...prev, show: false }));
    setLoading(true);
    try {
      // Payload helper
      const getFuncionarioPayload = (_pId?: number, pfId?: number) => ({
        // Relations if new
        ...(pfId ? { id_pessoa_fisica: pfId } : {}),

        // Fields
        ativo: formData.ativo,
        cargo: formData.cargo,
        salario: null,
        valor_pagamento: formData.valor_pagamento
          ? Number(formData.valor_pagamento)
          : null,
        tipo_pagamento: formData.tipo_pagamento || null,

        comissao: formData.comissao ? Number(formData.comissao) : null,
        comissao_pecas: formData.comissao_pecas
          ? Number(formData.comissao_pecas)
          : null,

        dt_admissao: new Date(formData.dt_admissao).toISOString(),
        obs: formData.obs || null,

        // MEI
        razao_social: formData.razao_social || null,
        nome_fantasia: formData.nome_fantasia || null,
        cnpj_mei: formData.cnpj_mei || null,
        inscricao_municipal: formData.inscricao_municipal || null,

        // Personal / Address
        rg: formData.rg || null,
        cep: formData.cep || null,
        logradouro: formData.logradouro || null,
        numero: formData.numero || null,
        complemento: formData.complemento || null,
        bairro: formData.bairro || null,
        cidade: formData.cidade || null,
        uf: formData.uf || null,
        telefone_pessoal: formData.telefone_pessoal || null,
        email_pessoal: formData.email_pessoal || null,

        especialidade: formData.especialidade || null,

        // Finance
        banco: formData.banco || null,
        agencia: formData.agencia || null,
        conta: formData.conta || null,
        chave_pix: formData.chave_pix || null,
        periodicidade_pagamento: formData.periodicidade_pagamento || null,
        dia_vencimento: formData.dia_vencimento
          ? Number(formData.dia_vencimento)
          : null,

        // Docs
        url_ccmei: formData.url_ccmei || null,
        url_cnh: formData.url_cnh || null,
        equipamentos_epis: formData.equipamentos_epis || null,
      });

      if (initialData) {
        // UPDATE
        await api.put(
          `/funcionario/${initialData.id_funcionario}`,
          getFuncionarioPayload(),
        );

        const pId = initialData.pessoa_fisica?.pessoa?.id_pessoa;
        if (pId) {
          await api
            .put(`/pessoa/${pId}`, {
              nome: formData.nome,
              genero: formData.genero || null,
              dt_nascimento: formData.dt_nascimento
                ? new Date(formData.dt_nascimento).toISOString()
                : null,
            })
            .catch((err) => console.warn("Erro ao atualizar Pessoa Base", err));
        }
      } else {
        // CREATE
        const pessoaRes = await api.post("/pessoa", {
          nome: formData.nome,
          genero: formData.genero || null,
          dt_nascimento: formData.dt_nascimento
            ? new Date(formData.dt_nascimento).toISOString()
            : null,
        });
        const idPessoa = pessoaRes.data.id_pessoa;

        const pfRes = await api.post("/pessoa-fisica", {
          id_pessoa: idPessoa,
          cpf: formData.cpf.replace(/\D/g, "") || null,
        });
        const idPf = pfRes.data.id_pessoa_fisica;

        await api.post("/funcionario", getFuncionarioPayload(idPessoa, idPf));
      }

      onSuccess();
    } catch (error: any) {
      console.error(error);
      const msg = error.response?.data?.error || "Erro ao salvar colaborador.";
      alert(msg);
    } finally {
      setLoading(false);
    }
  };

  // Logic to execute cancel
  const executeCancel = () => {
    setConfirmModal((prev) => ({ ...prev, show: false }));
    onCancel();
  };

  const handleAttemptSubmit = (e: FormEvent) => {
    e.preventDefault();
    setConfirmModal({ show: true, type: "save" });
  };

  const handleAttemptCancel = () => {
    if (isDirty) {
      setConfirmModal({ show: true, type: "cancel" });
    } else {
      onCancel();
    }
  };

  return (
    <>
      <form
        onSubmit={handleAttemptSubmit}
        className="space-y-6 text-neutral-900"
      >
        {/* Header */}
        <div className="flex items-center justify-between sticky top-0 bg-neutral-25 ackdrop-blur-md p-4 rounded-2xl border border-neutral-200 shadow-sm z-10">
          <div className="flex items-center gap-4">
            <button
              type="button"
              onClick={handleAttemptCancel}
              className="p-2 hover:bg-neutral-100 rounded-xl transition-colors text-neutral-500"
            >
              <ArrowLeft size={24} />
            </button>
            <div>
              <h2 className="text-xl font-bold text-neutral-500 tracking-tight">
                {initialData ? "Editar Colaborador" : "Novo Colaborador"}
              </h2>
              <p className="text-neutral-500">
                {initialData
                  ? "Atualizando dados do MEI/Funcion√°rio."
                  : "Cadastro completo do MEI."}
              </p>
            </div>
          </div>
          <div className="flex gap-3">
            <Button
              variant="ghost"
              icon={ArrowLeft}
              onClick={handleAttemptCancel}
              type="button"
            >
              Cancelar
            </Button>
            <Button
              variant="primary"
              icon={BadgeCheck}
              type="submit"
              disabled={loading}
            >
              Salvar Cadastro
            </Button>
          </div>
        </div>

        <div className="grid grid-cols-1 xl:grid-cols-3 gap-8">
          {/* COL 1 & 2 */}
          <div className="space-y-8 xl:col-span-2">
            {/* ID PESSOAL */}
            <div className="bg-neutral-25 p-8 rounded-3xl border border-neutral-200 shadow-sm space-y-6">
              <div className="flex items-center gap-3 pb-4 border-b border-neutral-50">
                <div className="p-3 bg-primary-50 text-primary-600 rounded-xl">
                  <User size={24} />
                </div>
                <h3 className="text-lg font-bold text-neutral-500">
                  Dados Pessoais
                </h3>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="md:col-span-2">
                  <Input
                    label="Nome Completo *"
                    value={formData.nome}
                    onChange={(e) => handleChange("nome", e.target.value)}
                    required
                  />
                </div>
                <div>
                  <Input
                    label="CPF *"
                    value={formData.cpf}
                    onChange={(e) => handleChange("cpf", e.target.value)}
                    placeholder="000.000.000-00"
                    required={!initialData}
                    disabled={!!initialData}
                  />
                </div>
                <div>
                  <Input
                    label="RG"
                    value={formData.rg}
                    onChange={(e) => handleChange("rg", e.target.value)}
                  />
                </div>
                <div>
                  <Input
                    label="Data de Nascimento"
                    type="date"
                    value={formData.dt_nascimento}
                    onChange={(e) =>
                      handleChange("dt_nascimento", e.target.value)
                    }
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                    G√™nero
                  </label>
                  <select
                    value={formData.genero}
                    onChange={(e) => handleChange("genero", e.target.value)}
                    className="w-full transition-all outline-none rounded-lg border text-sm disabled:opacity-50 disabled:bg-neutral-100 border-neutral-200 focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 text-neutral-900 bg-neutral-25 px-4 py-2.5"
                  >
                    <option value="">Selecione...</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Feminino">Feminino</option>
                    <option value="Outro">Outro</option>
                  </select>
                </div>
              </div>
            </div>

            {/* ID PROFISSIONAL (MEI) */}
            <div className="bg-neutral-25 p-8 rounded-3xl border border-neutral-200 shadow-sm space-y-6">
              <div className="flex items-center gap-3 pb-4 border-b border-neutral-50">
                <div className="p-3 bg-neutral-900 text-neutral-50 rounded-xl">
                  <Briefcase size={24} />
                </div>
                <h3 className="text-lg font-bold text-neutral-500">
                  Identifica√ß√£o Profissional (MEI)
                </h3>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="md:col-span-2">
                  <Input
                    label="Raz√£o Social"
                    value={formData.razao_social}
                    onChange={(e) =>
                      handleChange("razao_social", e.target.value)
                    }
                  />
                </div>
                <div>
                  <Input
                    label="Nome Fantasia"
                    value={formData.nome_fantasia}
                    onChange={(e) =>
                      handleChange("nome_fantasia", e.target.value)
                    }
                  />
                </div>
                <div>
                  <Input
                    label="CNPJ MEI"
                    value={formData.cnpj_mei}
                    onChange={(e) => handleChange("cnpj_mei", e.target.value)}
                  />
                </div>
                <div>
                  <Input
                    label="Inscri√ß√£o Municipal"
                    value={formData.inscricao_municipal}
                    onChange={(e) =>
                      handleChange("inscricao_municipal", e.target.value)
                    }
                  />
                </div>
              </div>
            </div>

            {/* ADDRESS */}
            <div className="bg-neutral-25 p-8 rounded-3xl border border-neutral-200 shadow-sm space-y-6">
              <div className="flex items-center gap-3 pb-4 border-b border-neutral-50">
                <div className="p-3 bg-indigo-50 text-indigo-600 rounded-xl">
                  <MapPin size={24} />
                </div>
                <h3 className="text-lg font-bold text-neutral-500">
                  Endere√ßo Residencial
                </h3>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-6 gap-6">
                <div className="md:col-span-2">
                  <Input
                    label="CEP"
                    value={formData.cep}
                    onChange={(e) => handleChange("cep", e.target.value)}
                    onBlur={handleCepBlur}
                    placeholder="00000-000"
                    icon={Search}
                  />
                </div>
                <div className="md:col-span-4">
                  <Input
                    label="Logradouro"
                    value={formData.logradouro}
                    onChange={(e) => handleChange("logradouro", e.target.value)}
                  />
                </div>
                <div className="md:col-span-2">
                  <Input
                    label="N√∫mero"
                    value={formData.numero}
                    onChange={(e) => handleChange("numero", e.target.value)}
                  />
                </div>
                <div className="md:col-span-2">
                  <Input
                    label="Complemento"
                    value={formData.complemento}
                    onChange={(e) =>
                      handleChange("complemento", e.target.value)
                    }
                  />
                </div>
                <div className="md:col-span-2">
                  <Input
                    label="Bairro"
                    value={formData.bairro}
                    onChange={(e) => handleChange("bairro", e.target.value)}
                  />
                </div>
                <div className="md:col-span-4">
                  <Input
                    label="Cidade"
                    value={formData.cidade}
                    onChange={(e) => handleChange("cidade", e.target.value)}
                  />
                </div>
                <div className="md:col-span-2">
                  <Input
                    label="UF"
                    value={formData.uf}
                    onChange={(e) => handleChange("uf", e.target.value)}
                  />
                </div>
              </div>
            </div>
          </div>

          {/* COL 3: OPERACIONAL & FINANCEIRO & LINKS */}
          <div className="space-y-8">
            {/* CONTATO + OPERACIONAL */}
            <div className="bg-neutral-25 p-8 rounded-3xl border border-neutral-100 shadow-sm space-y-6">
              <div className="flex items-center gap-3 pb-4 border-b border-neutral-50">
                <div className="p-3 bg-amber-50 text-amber-600 rounded-xl">
                  <Smartphone size={24} />
                </div>
                <h3 className="text-lg font-neutral-900 text-neutral-900">
                  Contato & Cargo
                </h3>
              </div>
              <div className="space-y-4">
                <div>
                  <Input
                    label="Cargo / Fun√ß√£o *"
                    value={formData.cargo}
                    onChange={(e) => handleChange("cargo", e.target.value)}
                    required
                  />
                </div>
                <div>
                  <Input
                    label="Telefone / WhatsApp"
                    value={formData.telefone_pessoal}
                    onChange={(e) =>
                      handleChange("telefone_pessoal", e.target.value)
                    }
                  />
                </div>
                <div>
                  <Input
                    label="E-mail"
                    value={formData.email_pessoal}
                    onChange={(e) =>
                      handleChange("email_pessoal", e.target.value)
                    }
                  />
                </div>
                <div>
                  <Input
                    label="Especialidade"
                    value={formData.especialidade}
                    onChange={(e) =>
                      handleChange("especialidade", e.target.value)
                    }
                    placeholder="Ex: Inje√ß√£o, Suspens√£o"
                  />
                </div>
              </div>
            </div>

            {/* FINANCEIRO */}
            <div className="bg-neutral-25 p-8 rounded-3xl border border-neutral-200 shadow-sm space-y-6">
              <div className="flex items-center gap-3 pb-4 border-b border-neutral-50">
                <div className="p-3 bg-emerald-50 text-emerald-600 rounded-xl">
                  <DollarSign size={24} />
                </div>
                <h3 className="text-lg font-bold text-neutral-500">
                  Financeiro
                </h3>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                    Tipo Pagamento
                  </label>
                  <select
                    value={formData.tipo_pagamento}
                    onChange={(e) =>
                      handleChange("tipo_pagamento", e.target.value)
                    }
                    className="w-full transition-all outline-none rounded-lg border text-sm disabled:opacity-50 disabled:bg-neutral-100 border-neutral-200 focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 text-neutral-900 bg-neutral-25 px-4 py-2.5"
                  >
                    <option value="">Selecione...</option>
                    <option value="HORA">Valor Hora</option>
                    <option value="FIXO_MENSAL">Mensal Fixo</option>
                  </select>
                </div>
                <div>
                  <Input
                    label="Valor (R$)"
                    value={formData.valor_pagamento}
                    onChange={(e) =>
                      handleChange("valor_pagamento", e.target.value)
                    }
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Input
                    label="Comiss√£o M.O (%)"
                    value={formData.comissao}
                    onChange={(e) => handleChange("comissao", e.target.value)}
                  />
                </div>
                <div>
                  <Input
                    label="Comiss√£o Pe√ßa (%)"
                    value={formData.comissao_pecas}
                    onChange={(e) =>
                      handleChange("comissao_pecas", e.target.value)
                    }
                  />
                </div>
              </div>

              <div className="space-y-4">
                <div>
                  <Input
                    label="Chave PIX"
                    value={formData.chave_pix}
                    onChange={(e) => handleChange("chave_pix", e.target.value)}
                  />
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <Input
                    value={formData.banco}
                    onChange={(e) => handleChange("banco", e.target.value)}
                    placeholder="Banco"
                  />
                  <Input
                    value={formData.conta}
                    onChange={(e) => handleChange("conta", e.target.value)}
                    placeholder="Conta"
                  />
                </div>
              </div>
            </div>

            {/* DOCUMENTOS */}
            <div className="bg-neutral-25 p-8 rounded-3xl border border-neutral-100 shadow-sm space-y-6">
              <div className="flex items-center gap-3 pb-4 border-b border-neutral-50">
                <div className="p-3 bg-neutral-100 text-neutral-600 rounded-xl">
                  <ShieldCheck size={24} />
                </div>
                <h3 className="text-lg font-bold text-neutral-500">
                  Documenta√ß√£o
                </h3>
              </div>
              <div className="space-y-4">
                <div>
                  <Input
                    label="CCMEI (PDF URL)"
                    value={formData.url_ccmei}
                    onChange={(e) => handleChange("url_ccmei", e.target.value)}
                    placeholder="Link do Drive/Arquivo"
                  />
                </div>
                <div>
                  <Input
                    label="CNH (PDF URL)"
                    value={formData.url_cnh}
                    onChange={(e) => handleChange("url_cnh", e.target.value)}
                    placeholder="Link do Drive/Arquivo"
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                    Equipamentos / EPIs
                  </label>
                  <textarea
                    value={formData.equipamentos_epis}
                    onChange={(e) =>
                      handleChange("equipamentos_epis", e.target.value)
                    }
                    className="w-full bg-neutral-50 border border-neutral-200 p-4 rounded-xl focus:ring-4 focus:ring-neutral-500/10 focus:border-neutral-500 outline-none font-medium text-neutral-800 text-sm min-h-[80px]"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>

      {/* CONFIRMATION MODAL */}
      {confirmModal.show && (
        <Modal
          title={
            confirmModal.type === "save"
              ? "Salvar Altera√ß√µes"
              : "Descartar Altera√ß√µes?"
          }
          onClose={() => setConfirmModal((prev) => ({ ...prev, show: false }))}
          zIndex={60}
        >
          <div className="space-y-4">
            <div
              className={`p-4 rounded-xl border ${
                confirmModal.type === "save"
                  ? "bg-blue-50 border-blue-100 text-blue-700"
                  : "bg-amber-50 border-amber-100 text-amber-700"
              }`}
            >
              <p className="font-bold text-center">
                {confirmModal.type === "save"
                  ? "Deseja confirmar o cadastro/atualiza√ß√£o deste colaborador?"
                  : "Existem dados n√£o salvos. Deseja realmente sair?"}
              </p>
            </div>
            <div className="flex justify-end gap-2 pt-2">
              <Button
                variant="ghost"
                onClick={() =>
                  setConfirmModal((prev) => ({ ...prev, show: false }))
                }
              >
                Cancelar
              </Button>
              <Button
                variant={confirmModal.type === "save" ? "primary" : "danger"}
                onClick={
                  confirmModal.type === "save" ? executeSubmit : executeCancel
                }
              >
                {confirmModal.type === "save" ? "Confirmar" : "Sair sem Salvar"}
              </Button>
            </div>
          </div>
        </Modal>
      )}
    </>
  );
};



================================================================================
FILE PATH: client\src\components\forms\ItensOsForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface ItensOsFormProps {
    osId: number;
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const ItensOsForm = ({ osId, onSuccess, onCancel }: ItensOsFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // Schema: id_os, id_pecas_estoque?, descricao, quantidade, valor_venda, valor_total
    const [idPecasEstoque, setIdPecasEstoque] = useState('');
    const [descricao, setDescricao] = useState('');
    const [quantidade, setQuantidade] = useState('1');
    const [valorVenda, setValorVenda] = useState('');
    const [valorTotal, setValorTotal] = useState('');

    // Auto-calculate valor_total when quantidade or valor_venda changes
    const handleQuantidadeChange = (value: string) => {
        setQuantidade(value);
        if (valorVenda) {
            const total = Number(value) * Number(valorVenda);
            setValorTotal(total.toFixed(2));
        }
    };

    const handleValorVendaChange = (value: string) => {
        setValorVenda(value);
        if (quantidade) {
            const total = Number(quantidade) * Number(value);
            setValorTotal(total.toFixed(2));
        }
    };

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                id_os: osId,
                id_pecas_estoque: idPecasEstoque ? Number(idPecasEstoque) : null,
                descricao,
                quantidade: Number(quantidade),
                valor_venda: Number(valorVenda),
                valor_total: Number(valorTotal)
            };

            const response = await api.post('/itens-os', payload);
            alert('Item adicionado √† OS com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao adicionar item √† OS.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div className="bg-blue-50 p-3 rounded text-sm text-blue-800 border border-blue-100">
                <strong>OS #{osId}</strong> - Adicionando item/pe√ßa/servi√ßo
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">ID Pe√ßa Estoque (Opcional)</label>
                    <input 
                        type="number"
                        value={idPecasEstoque} 
                        onChange={e => setIdPecasEstoque(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        placeholder="Deixe vazio para servi√ßo"
                    />
                </div>

                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Descri√ß√£o *</label>
                    <input 
                        value={descricao} 
                        onChange={e => setDescricao(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                        placeholder="Ex: Troca de √≥leo, Filtro de ar..."
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Quantidade *</label>
                    <input 
                        type="number"
                        min="1"
                        value={quantidade} 
                        onChange={e => handleQuantidadeChange(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Valor Unit√°rio (R$) *</label>
                    <input 
                        type="number"
                        step="0.01"
                        value={valorVenda} 
                        onChange={e => handleValorVendaChange(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                    />
                </div>

                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Valor Total (R$)</label>
                    <input 
                        type="number"
                        step="0.01"
                        value={valorTotal} 
                        onChange={e => setValorTotal(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300 bg-gray-50 font-bold text-lg" 
                        required 
                        readOnly
                    />
                </div>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 disabled:opacity-50"
                >
                    {loading ? 'Adicionando...' : 'Adicionar Item'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\PagamentoClienteForm.tsx
================================================================================
import { useState, useEffect, type FormEvent } from "react";
import { api } from "../../services/api";
import { CreditCard, DollarSign, CheckCircle, Smartphone } from "lucide-react";
import type { IOperadoraCartao } from "../../types/backend";

import { Input } from "../ui/input";
import { Button } from "../ui/Button";

interface PagamentoClienteFormProps {
  osId: number;
  valorTotal: number;
  onSuccess: (payment: any) => void;
  onCancel: () => void;
}

export const PagamentoClienteForm = ({
  osId,
  valorTotal,
  initialData,
  onSuccess,
  onCancel,
}: PagamentoClienteFormProps & { initialData?: any }) => {
  const [loading, setLoading] = useState(false);
  const [metodo, setMetodo] = useState("CREDITO");
  const [valor, setValor] = useState(
    valorTotal.toLocaleString("pt-BR", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    }),
  );
  const [bandeira, setBandeira] = useState("");
  const [parcelas, setParcelas] = useState("1");
  const [codigoTransacao, setCodigoTransacao] = useState("");

  useEffect(() => {
    if (initialData) {
      setMetodo(initialData.metodo_pagamento || "CREDITO");
      setValor(
        Number(initialData.valor).toLocaleString("pt-BR", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }),
      );
      setBandeira(initialData.bandeira_cartao || "");
      setParcelas(String(initialData.qtd_parcelas || 1));
      setCodigoTransacao(initialData.codigo_transacao || "");

      // FIX: Inicializar IDs corretamente para edi√ß√£o
      if (initialData.id_operadora)
        setIdOperadora(Number(initialData.id_operadora));
      if (initialData.id_conta_bancaria)
        setIdContaBancaria(Number(initialData.id_conta_bancaria));
    }
  }, [initialData]);

  const [operadoras, setOperadoras] = useState<IOperadoraCartao[]>([]);
  const [idOperadora, setIdOperadora] = useState(0);

  const [contasBancarias, setContasBancarias] = useState<any[]>([]);
  const [idContaBancaria, setIdContaBancaria] = useState(0);

  const [error, setError] = useState("");

  useEffect(() => {
    loadOperadoras();
    loadContasBancarias();
  }, []);

  const loadOperadoras = async () => {
    try {
      const res = await api.get("/operadora-cartao");
      setOperadoras(res.data);

      // Priority: 1. Initial Data (Edit), 2. Single Operator Auto-Select
      if (initialData?.id_operadora) {
        setIdOperadora(Number(initialData.id_operadora));
      } else if (res.data.length === 1) {
        setIdOperadora(res.data[0].id_operadora);
      }
    } catch (error) {
      console.error("Erro ao carregar operadoras");
    }
  };

  const loadContasBancarias = async () => {
    try {
      const res = await api.get("/conta-bancaria");
      setContasBancarias(res.data.filter((c: any) => c.ativo));
      // Se houver apenas uma conta, seleciona automaticamente
      if (res.data.length === 1) {
        setIdContaBancaria(res.data[0].id_conta);
      }
    } catch (error) {
      console.error("Erro ao carregar contas banc√°rias");
    }
  };

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError("");

    try {
      const cleanValor = valor.replace(/\./g, "").replace(",", ".");
      if (isNaN(Number(cleanValor)) || Number(cleanValor) <= 0) {
        setError("Valor inv√°lido.");
        setLoading(false);
        return;
      }

      if (metodo === "PIX" && idContaBancaria === 0) {
        setError("Selecione a conta banc√°ria de destino.");
        setLoading(false);
        return;
      }

      if ((metodo === "CREDITO" || metodo === "DEBITO") && idOperadora === 0) {
        setError("Selecione a operadora/maquininha.");
        setLoading(false);
        return;
      }

      const payload = {
        id_os: osId,
        metodo_pagamento: metodo,
        valor: Number(cleanValor),
        data_pagamento: initialData?.data_pagamento || new Date().toISOString(),
        bandeira_cartao:
          metodo === "CREDITO" || metodo === "DEBITO" ? bandeira : null,
        codigo_transacao: codigoTransacao || null,
        qtd_parcelas: metodo === "CREDITO" ? Number(parcelas) : 1,
        id_operadora:
          metodo === "CREDITO" || metodo === "DEBITO" ? idOperadora : undefined,
        id_conta_bancaria: metodo === "PIX" ? idContaBancaria : undefined,
      };

      let response;
      if (initialData?.id_pagamento_cliente) {
        response = await api.put(
          `/pagamento-cliente/${initialData.id_pagamento_cliente}`,
          payload,
        );
      } else {
        response = await api.post("/pagamento-cliente", payload);
      }

      onSuccess(response.data);
    } catch (error) {
      console.error(error);
      setError("Erro ao salvar pagamento. Verifique os dados.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div className="bg-green-50 p-4 rounded-xl flex items-center gap-3 border border-green-100">
        <DollarSign className="text-green-600" />
        <div>
          <strong className="block text-green-900 text-sm">
            {initialData ? "Editar Pagamento" : "Registro de Pagamento"}
          </strong>
          <p className="text-xs text-green-700">
            Informe os detalhes do recebimento do cliente.
          </p>
        </div>
      </div>

      {error && (
        <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm font-bold border border-red-200">
          {error}
        </div>
      )}

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="md:col-span-2">
          <label className="text-xs font-bold text-neutral-600 uppercase mb-1 block">
            Valor do Pagamento (R$)
          </label>
          <Input
            type="text"
            value={valor}
            onChange={(e) => {
              let v = e.target.value.replace(/\D/g, "");
              const val = Number(v) / 100;
              setValor(
                val.toLocaleString("pt-BR", {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2,
                }),
              );
            }}
            className="w-full p-3 border border-neutral-200 rounded-xl font-black text-3xl! text-green-600! focus:border-green-500! focus:ring-2 focus:ring-green-500 outline-none h-16! tracking-tight"
          />
        </div>

        <div className="md:col-span-2">
          <label className="text-xs font-bold text-neutral-600 uppercase mb-1 block">
            Forma de Pagamento
          </label>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
            {["CREDITO", "DEBITO", "PIX", "DINHEIRO"].map((m) => (
              <button
                key={m}
                type="button"
                onClick={() => setMetodo(m)}
                className={`p-3 rounded-xl border flex flex-col items-center gap-2 transition-all ${metodo === m ? "bg-green-100 border-green-500 text-green-700 ring-2 ring-green-500/20" : "bg-neutral-25 border-neutral-200 text-neutral-600 hover:bg-neutral-25"}`}
              >
                {m === "CREDITO" && <CreditCard size={20} />}
                {m === "DEBITO" && <CreditCard size={20} />}
                {m === "PIX" && <Smartphone size={20} />}
                {m === "DINHEIRO" && <DollarSign size={20} />}
                <span className="text-[10px] font-bold">{m}</span>
              </button>
            ))}
          </div>
        </div>

        {(metodo === "CREDITO" || metodo === "DEBITO") && (
          <>
            <div>
              <label className="text-xs font-bold text-neutral-600 uppercase mb-1 block">
                Bandeira
              </label>
              <select
                value={bandeira}
                onChange={(e) => setBandeira(e.target.value)}
                className={`w-full p-3 bg-neutral-25 border border-neutral-200 rounded-xl outline-none focus:border-green-500 font-bold ${bandeira ? "text-neutral-600" : "text-neutral-400"}`}
              >
                <option value="">Selecione...</option>
                <option value="VISA">Visa</option>
                <option value="MASTER">Mastercard</option>
                <option value="ELO">Elo</option>
                <option value="AMEX">Amex</option>
                <option value="HIPER">Hipercard</option>
              </select>
            </div>
            {metodo === "CREDITO" && (
              <div>
                <label className="text-xs font-bold text-neutral-500 uppercase mb-1 block">
                  Parcelas
                </label>
                <select
                  value={parcelas}
                  onChange={(e) => setParcelas(e.target.value)}
                  className="w-full p-3 bg-neutral-25 border border-neutral-200 rounded-xl outline-none focus:border-green-500 font-bold text-neutral-600"
                >
                  {[1, 2, 3, 4, 5, 6, 10, 12].map((p) => (
                    <option key={p} value={p}>
                      {p}x
                    </option>
                  ))}
                </select>
              </div>
            )}
            <div className="md:col-span-2">
              <label className="text-xs font-bold text-neutral-500 uppercase mb-1 block">
                Maquininha / Operadora
              </label>
              <select
                value={idOperadora}
                onChange={(e) => setIdOperadora(Number(e.target.value))}
                className={`w-full p-3 bg-neutral-25 border border-neutral-200 rounded-xl outline-none focus:border-green-500 font-bold ${idOperadora ? "text-neutral-600" : "text-neutral-400"}`}
              >
                <option value={0}>Selecione a Maquininha...</option>
                {operadoras.map((op) => (
                  <option key={op.id_operadora} value={op.id_operadora}>
                    {op.nome}
                  </option>
                ))}
              </select>
              <p className="text-[10px] text-neutral-400 mt-1">
                Necess√°rio para c√°lculo de taxas e receb√≠veis.
              </p>
            </div>
          </>
        )}

        {metodo === "PIX" && (
          <div className="md:col-span-2">
            <label className="text-xs font-bold text-neutral-500 uppercase mb-1 block">
              Conta Banc√°ria / Destino
            </label>
            <select
              value={idContaBancaria}
              onChange={(e) => setIdContaBancaria(Number(e.target.value))}
              className="w-full p-3 bg-neutral-25 border border-neutral-200 rounded-xl outline-none focus:border-green-500 font-bold text-neutral-600"
            >
              <option value={0}>Selecione a Conta...</option>
              {contasBancarias.map((conta) => (
                <option key={conta.id_conta} value={conta.id_conta}>
                  {conta.nome} {conta.banco ? `- ${conta.banco}` : ""}
                </option>
              ))}
            </select>
            <p className="text-[10px] text-neutral-400 mt-1">
              Conta onde o valor ser√° depositado.
            </p>
          </div>
        )}

        <div className="md:col-span-2">
          <label className="text-xs font-bold text-neutral-500 uppercase mb-1 block">
            {metodo === "PIX"
              ? "ID da Transa√ß√£o (Pix)"
              : "C√≥digo de Autoriza√ß√£o / NSU"}
          </label>
          <Input
            value={codigoTransacao}
            onChange={(e) => setCodigoTransacao(e.target.value)}
            placeholder="Opcional"
            className="font-mono text-sm border-neutral-200 focus:border-green-500"
          />
        </div>
      </div>

      <div className="flex gap-3 pt-4 border-t border-neutral-200">
        <Button
          type="button"
          onClick={onCancel}
          variant="secondary"
          className="flex-1"
        >
          Cancelar
        </Button>
        <Button
          type="submit"
          disabled={
            loading ||
            (metodo === "PIX" && idContaBancaria === 0) ||
            (metodo !== "PIX" && metodo !== "DINHEIRO" && idOperadora === 0)
          }
          variant="success"
          className="flex-1 shadow-green-200 shadow-xl"
          isLoading={loading}
          icon={CheckCircle}
        >
          {initialData ? "Salvar Altera√ß√µes" : "Confirmar Pagamento"}
        </Button>
      </div>
    </form>
  );
};



================================================================================
FILE PATH: client\src\components\forms\PagamentoPecaForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface PagamentoPecaFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const PagamentoPecaForm = ({ onSuccess, onCancel }: PagamentoPecaFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // Schema: id_item_os, id_fornecedor, custo_real, data_compra, data_pagamento_fornecedor?, pago_ao_fornecedor
    const [idItemOs, setIdItemOs] = useState('');
    const [idFornecedor, setIdFornecedor] = useState('');
    const [custoReal, setCustoReal] = useState('');
    const [dataCompra, setDataCompra] = useState('');
    const [dataPagamentoFornecedor, setDataPagamentoFornecedor] = useState('');
    const [pagoAoFornecedor, setPagoAoFornecedor] = useState(false);

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                id_item_os: Number(idItemOs),
                id_fornecedor: Number(idFornecedor),
                custo_real: Number(custoReal),
                data_compra: new Date(dataCompra).toISOString(),
                data_pagamento_fornecedor: dataPagamentoFornecedor ? new Date(dataPagamentoFornecedor).toISOString() : null,
                pago_ao_fornecedor: pagoAoFornecedor
            };

            const response = await api.post('/pagamento-peca', payload);
            alert('Pagamento de pe√ßa registrado com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao registrar pagamento de pe√ßa.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div className="bg-orange-50 p-3 rounded text-sm text-orange-800 border border-orange-100">
                <strong>Rastreio de Custo Real:</strong> Registre o custo efetivo pago ao fornecedor.
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">ID Item OS *</label>
                    <input 
                        type="number"
                        value={idItemOs} 
                        onChange={e => setIdItemOs(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                        placeholder="ID do item da OS"
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">ID Fornecedor *</label>
                    <input 
                        type="number"
                        value={idFornecedor} 
                        onChange={e => setIdFornecedor(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                        placeholder="ID do fornecedor"
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Custo Real (R$) *</label>
                    <input 
                        type="number"
                        step="0.01"
                        value={custoReal} 
                        onChange={e => setCustoReal(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Data da Compra *</label>
                    <input 
                        type="date"
                        value={dataCompra} 
                        onChange={e => setDataCompra(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Data Pagamento Fornecedor</label>
                    <input 
                        type="date"
                        value={dataPagamentoFornecedor} 
                        onChange={e => setDataPagamentoFornecedor(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                    />
                </div>

                <div className="flex items-center">
                    <label className="flex items-center gap-2 cursor-pointer">
                        <input 
                            type="checkbox"
                            checked={pagoAoFornecedor} 
                            onChange={e => setPagoAoFornecedor(e.target.checked)} 
                            className="w-5 h-5 text-green-600"
                        />
                        <span className="text-sm font-bold text-gray-700">Pago ao Fornecedor</span>
                    </label>
                </div>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 disabled:opacity-50"
                >
                    {loading ? 'Salvando...' : 'Registrar Pagamento'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\PecasEstoqueForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface PecasEstoqueFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const PecasEstoqueForm = ({ onSuccess, onCancel }: PecasEstoqueFormProps) => {
    const [loading, setLoading] = useState(false);

    // Form States
    const [nome, setNome] = useState('');
    const [descricao, setDescricao] = useState('');

    const [unidadeMedida, setUnidadeMedida] = useState('');
    const [valorCusto, setValorCusto] = useState('');
    const [valorVenda, setValorVenda] = useState('');
    const [estoqueAtual, setEstoqueAtual] = useState('');
    const [custoUnitarioPadrao, setCustoUnitarioPadrao] = useState('');

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                nome,
                descricao,
                unidade_medida: unidadeMedida,
                valor_custo: Number(valorCusto),
                valor_venda: Number(valorVenda),
                estoque_atual: Number(estoqueAtual),
                custo_unitario_padrao: custoUnitarioPadrao ? Number(custoUnitarioPadrao) : 0
            };

            const response = await api.post('/pecas-estoque', payload);
            alert('Pe√ßa cadastrada com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao cadastrar pe√ßa.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Nome da Pe√ßa *</label>
                    <input value={nome} onChange={e => setNome(e.target.value)} className="w-full border p-2 rounded border-gray-300" required />
                </div>
                 <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Descri√ß√£o Detalhada *</label>
                    <input value={descricao} onChange={e => setDescricao(e.target.value)} className="w-full border p-2 rounded border-gray-300" required />
                </div>
                
                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Unidade Medida</label>
                    <input value={unidadeMedida} onChange={e => setUnidadeMedida(e.target.value)} className="w-full border p-2 rounded border-gray-300" placeholder="Ex: UN, KG, LT" />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Valor Custo (R$) *</label>
                    <input type="number" step="0.01" value={valorCusto} onChange={e => setValorCusto(e.target.value)} className="w-full border p-2 rounded border-gray-300" required />
                </div>
                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Valor Venda (R$) *</label>
                    <input type="number" step="0.01" value={valorVenda} onChange={e => setValorVenda(e.target.value)} className="w-full border p-2 rounded border-gray-300" required />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Estoque Atual *</label>
                    <input type="number" value={estoqueAtual} onChange={e => setEstoqueAtual(e.target.value)} className="w-full border p-2 rounded border-gray-300" required />
                </div>
                 <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Custo Padr√£o (Ref.)</label>
                    <input type="number" step="0.01" value={custoUnitarioPadrao} onChange={e => setCustoUnitarioPadrao(e.target.value)} className="w-full border p-2 rounded border-gray-300" />
                </div>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 disabled:opacity-50"
                >
                    {loading ? 'Salvando...' : 'Salvar Pe√ßa'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\PessoaFisicaForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface PessoaFisicaFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const PessoaFisicaForm = ({ onSuccess, onCancel }: PessoaFisicaFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // Schema: id_pessoa, cpf?
    const [idPessoa, setIdPessoa] = useState('');
    const [cpf, setCpf] = useState('');

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                id_pessoa: Number(idPessoa),
                cpf: cpf || null
            };

            const response = await api.post('/pessoa-fisica', payload);
            alert('Pessoa F√≠sica cadastrada com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao cadastrar. Verifique se o ID da Pessoa existe.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div className="bg-blue-50 p-3 rounded text-sm text-blue-800 border border-blue-100">
                <strong>Pr√©-requisito:</strong> A Pessoa base deve estar cadastrada primeiro.
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">ID Pessoa *</label>
                    <input 
                        type="number"
                        value={idPessoa} 
                        onChange={e => setIdPessoa(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                        placeholder="Ex: 10"
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">CPF</label>
                    <input 
                        value={cpf} 
                        onChange={e => setCpf(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        maxLength={11}
                        placeholder="Somente n√∫meros"
                    />
                </div>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 disabled:opacity-50"
                >
                    {loading ? 'Salvando...' : 'Salvar Pessoa F√≠sica'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\PessoaForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface PessoaFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const PessoaForm = ({ onSuccess, onCancel }: PessoaFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // Schema: nome, genero?, dt_nascimento?, obs?
    const [nome, setNome] = useState('');
    const [genero, setGenero] = useState('');
    const [dtNascimento, setDtNascimento] = useState('');
    const [obs, setObs] = useState('');

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                nome,
                genero: genero || null,
                dt_nascimento: dtNascimento ? new Date(dtNascimento) : null,
                obs: obs || null
            };

            const response = await api.post('/pessoa', payload);
            alert('Pessoa cadastrada com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao cadastrar pessoa.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Nome Completo *</label>
                    <input 
                        value={nome} 
                        onChange={e => setNome(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">G√™nero</label>
                    <select value={genero} onChange={e => setGenero(e.target.value)} className="w-full border p-2 rounded border-gray-300">
                        <option value="">Selecione...</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Feminino">Feminino</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Data Nascimento</label>
                    <input 
                        type="date" 
                        value={dtNascimento} 
                        onChange={e => setDtNascimento(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                    />
                </div>

                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Observa√ß√µes</label>
                    <textarea 
                        value={obs} 
                        onChange={e => setObs(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        rows={3}
                    />
                </div>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 disabled:opacity-50"
                >
                    {loading ? 'Salvando...' : 'Salvar Pessoa'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\PessoaJuridicaForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface PessoaJuridicaFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const PessoaJuridicaForm = ({ onSuccess, onCancel }: PessoaJuridicaFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // Schema: id_pessoa, razao_social, nome_fantasia?, cnpj?, inscricao_estadual?
    const [idPessoa, setIdPessoa] = useState('');
    const [razaoSocial, setRazaoSocial] = useState('');
    const [nomeFantasia, setNomeFantasia] = useState('');
    const [cnpj, setCnpj] = useState('');
    const [inscricaoEstadual, setInscricaoEstadual] = useState('');

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                id_pessoa: Number(idPessoa),
                razao_social: razaoSocial,
                nome_fantasia: nomeFantasia || null,
                cnpj: cnpj || null,
                inscricao_estadual: inscricaoEstadual || null
            };

            const response = await api.post('/pessoa-juridica', payload);
            alert('Pessoa Jur√≠dica cadastrada com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao cadastrar. Verifique se o ID da Pessoa existe.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div className="bg-purple-50 p-3 rounded text-sm text-purple-800 border border-purple-100">
                <strong>Pr√©-requisito:</strong> A Pessoa base deve estar cadastrada primeiro.
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">ID Pessoa *</label>
                    <input 
                        type="number"
                        value={idPessoa} 
                        onChange={e => setIdPessoa(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                        placeholder="Ex: 10"
                    />
                </div>

                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Raz√£o Social *</label>
                    <input 
                        value={razaoSocial} 
                        onChange={e => setRazaoSocial(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                    />
                </div>

                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Nome Fantasia</label>
                    <input 
                        value={nomeFantasia} 
                        onChange={e => setNomeFantasia(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">CNPJ</label>
                    <input 
                        value={cnpj} 
                        onChange={e => setCnpj(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        maxLength={14}
                        placeholder="Somente n√∫meros"
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Inscri√ß√£o Estadual</label>
                    <input 
                        value={inscricaoEstadual} 
                        onChange={e => setInscricaoEstadual(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                    />
                </div>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 disabled:opacity-50"
                >
                    {loading ? 'Salvando...' : 'Salvar Pessoa Jur√≠dica'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\TipoForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface TipoFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const TipoForm = ({ onSuccess, onCancel }: TipoFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // Schema: funcao?
    const [funcao, setFuncao] = useState('');

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                funcao: funcao || null
            };

            const response = await api.post('/tipo', payload);
            alert('Tipo cadastrado com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao cadastrar tipo.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div>
                <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Fun√ß√£o / Tipo</label>
                <input 
                    value={funcao} 
                    onChange={e => setFuncao(e.target.value)} 
                    className="w-full border p-2 rounded border-gray-300" 
                    placeholder="Ex: Cliente, Fornecedor, Parceiro..."
                />
                <p className="text-xs text-gray-500 mt-1">Define a fun√ß√£o/categoria da pessoa ou empresa.</p>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 disabled:opacity-50"
                >
                    {loading ? 'Salvando...' : 'Salvar Tipo'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\UnifiedOsForm.tsx
================================================================================

import React, { useState, useEffect } from 'react';
import { User, Car, Wrench, ArrowRight, Phone, AlertCircle, MapPin } from 'lucide-react';
import { api } from '../../services/api';
import { Button } from '../ui/Button';

interface UnifiedOsFormProps {
    onCancel: () => void;
    onSuccess: (osId: number) => void;
    employees: any[];
    initialClient?: any; // If we start from a found client
}

export const UnifiedOsForm: React.FC<UnifiedOsFormProps> = ({ onCancel, onSuccess, employees, initialClient }) => {
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');

    // --- FORM DATA ---
    const [clientData, setClientData] = useState({
        id_cliente: '',
        nome: '',
        telefone: '',
        cep: '',
        logradouro: '',
        numero: '',
        bairro: '',
        cidade: '',
        estado: '',
        isNew: true
    });
    
    const [vehicleData, setVehicleData] = useState({
        id_veiculo: '',
        placa: '',
        marca: '',
        modelo: '',
        cor: '',
        ano: new Date().getFullYear().toString(),
        combustivel: 'FLEX',
        isNew: true
    });

    const [osData, setOsData] = useState({
        km_entrada: '',
        id_funcionario: '',
        defeito: ''
    });

    // Client Search for Autocomplete
    const [clientQuery, setClientQuery] = useState('');
    const [clientResults, setClientResults] = useState<any[]>([]);

    useEffect(() => {
        if (initialClient) {
            selectClient(initialClient);
        }
    }, [initialClient]);

    // Search existing client
    const handleClientSearch = async (val: string) => {
        setClientQuery(val);
        setClientData(prev => ({ ...prev, nome: val, isNew: true, id_cliente: '' }));
        if (val.length < 3) {
            setClientResults([]);
            return;
        }
        try {
            const res = await api.get(`/cliente/search?q=${val}`);
            setClientResults(res.data);
        } catch (e) { console.error(e); }
    };

    const selectClient = (c: any) => {
        const nome = c.pessoa_fisica?.pessoa?.nome || c.pessoa_juridica?.razao_social;
        setClientData({
            id_cliente: c.id_cliente,
            nome: nome,
            telefone: c.telefone_1,
            cep: c.cep || '',
            logradouro: c.logradouro || '',
            numero: c.nr_logradouro || '',
            bairro: c.bairro || '',
            cidade: c.cidade || '',
            estado: c.estado || '',
            isNew: false
        });
        setClientQuery(nome);
        setClientResults([]);
    };

    // --- VALIDATION & SUBMIT ---
    const handleSubmit = async () => {
        setError('');
        if (!clientData.nome) return setError('Nome do cliente √© obrigat√≥rio.');
        if (!clientData.telefone) return setError('Telefone do cliente √© obrigat√≥rio.');
        if (!vehicleData.placa) return setError('Placa do ve√≠culo √© obrigat√≥ria.');
        if (!vehicleData.marca) return setError('Marca do ve√≠culo √© obrigat√≥ria.');
        if (!vehicleData.modelo) return setError('Modelo do ve√≠culo √© obrigat√≥rio.');
        if (!osData.km_entrada) return setError('KM √© obrigat√≥rio.');
        if (!osData.id_funcionario) return setError('Mec√¢nico √© obrigat√≥rio.');

        setLoading(true);
        try {
            // UNIFIED PAYLOAD
            const payload = {
                client: {
                    id_cliente: clientData.isNew ? null : Number(clientData.id_cliente),
                    nome: clientData.nome,
                    telefone: clientData.telefone,
                    tipo: 'FISICA', // Defaulting to Fisica as per UI simplicity
                    logradouro: clientData.logradouro,
                    numero: clientData.numero,
                    bairro: clientData.bairro,
                    cidade: clientData.cidade,
                    estado: clientData.estado
                    // CPF not in form yet, sending null implicitly by omission
                },
                vehicle: {
                    id_veiculo: vehicleData.isNew ? null : Number(vehicleData.id_veiculo),
                    placa: vehicleData.placa.toUpperCase(),
                    marca: vehicleData.marca,
                    modelo: vehicleData.modelo,
                    cor: vehicleData.cor || 'BRANCO',
                    ano_modelo: vehicleData.ano,
                    combustivel: vehicleData.combustivel
                },
                os: {
                    id_funcionario: Number(osData.id_funcionario),
                    km_entrada: Number(osData.km_entrada),
                    defeito_relatado: osData.defeito
                }
            };

            const response = await api.post('/ordem-de-servico/unified', payload);
            
            onSuccess(response.data.id_os);

        } catch (err: any) {
            console.error(err);
            setError(err.response?.data?.error || err.message || 'Erro ao salvar.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="space-y-6">
            {/* ERROR MSG */}
            {error && (
                <div className="bg-red-50 text-red-600 p-3 rounded-xl flex items-center gap-2 text-sm font-bold">
                    <AlertCircle size={16} /> {error}
                </div>
            )}

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* SECTION: CLIENTE */}
                <div className="p-4 bg-neutral-50 rounded-2xl border border-neutral-100 space-y-4">
                    <div className="flex items-center gap-2 text-primary-600 mb-2">
                        <User size={20} />
                        <h3 className="font-black text-neutral-400 uppercase tracking-widest text-xs">Dados do Cliente</h3>
                    </div>
                    
                    <div className="relative">
                        <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Nome Completo *</label>
                        <input 
                            value={clientQuery}
                            onChange={e => handleClientSearch(e.target.value)}
                            className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500"
                            placeholder="Buscar ou Digitar Novo..."
                        />
                        {clientResults.length > 0 && (
                            <div className="absolute top-16 left-0 w-full bg-white shadow-xl border border-neutral-100 rounded-xl z-20 max-h-40 overflow-y-auto">
                                {clientResults.map(c => (
                                    <button key={c.id_cliente} onClick={() => selectClient(c)} className="w-full text-left p-3 hover:bg-neutral-50 text-sm font-bold text-neutral-700">
                                        {c.pessoa_fisica?.pessoa?.nome || c.pessoa_juridica?.razao_social}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                    <div>
                        <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Telefone / Celular *</label>
                        <div className="relative">
                            <Phone className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" size={14} />
                            <input 
                                value={clientData.telefone}
                                onChange={e => setClientData({...clientData, telefone: e.target.value})}
                                disabled={!clientData.isNew}
                                className="w-full pl-9 pr-3 py-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500 disabled:bg-neutral-100"
                                placeholder="(00) 00000-0000"
                            />
                        </div>
                    </div>
                    
                    {/* Endere√ßo Simplificado */}
                    <div className="pt-2 border-t border-neutral-200">
                        <div className="flex items-center gap-1 mb-2">
                             <MapPin size={14} className="text-neutral-400" />
                             <span className="text-[10px] font-black text-neutral-400 uppercase">Endere√ßo</span>
                        </div>
                        <div className="grid grid-cols-3 gap-2 mb-2">
                             <input placeholder="CEP" className="col-span-1 p-2 border rounded-lg text-sm" value={clientData.cep} onChange={e => setClientData({...clientData, cep: e.target.value})} disabled={!clientData.isNew}/>
                             <input placeholder="Cidade" className="col-span-2 p-2 border rounded-lg text-sm" value={clientData.cidade} onChange={e => setClientData({...clientData, cidade: e.target.value})} disabled={!clientData.isNew}/>
                        </div>
                         <div className="grid grid-cols-4 gap-2">
                             <input placeholder="Logradouro" className="col-span-3 p-2 border rounded-lg text-sm" value={clientData.logradouro} onChange={e => setClientData({...clientData, logradouro: e.target.value})} disabled={!clientData.isNew}/>
                             <input placeholder="N¬∫" className="col-span-1 p-2 border rounded-lg text-sm" value={clientData.numero} onChange={e => setClientData({...clientData, numero: e.target.value})} disabled={!clientData.isNew}/>
                        </div>
                    </div>
                </div>

                {/* SECTION: VE√çCULO */}
                <div className="p-4 bg-neutral-50 rounded-2xl border border-neutral-100 space-y-4">
                    <div className="flex items-center gap-2 text-primary-600 mb-2">
                        <Car size={20} />
                        <h3 className="font-black text-neutral-400 uppercase tracking-widest text-xs">Dados do Ve√≠culo</h3>
                    </div>
                    
                    <div className="flex gap-3">
                        <div className="flex-1">
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Placa *</label>
                            <input 
                                value={vehicleData.placa}
                                onChange={e => setVehicleData({...vehicleData, placa: e.target.value.toUpperCase()})}
                                className="w-full p-3 rounded-xl border border-neutral-200 font-black text-neutral-800 outline-none focus:border-primary-500 uppercase"
                                placeholder="MER-0000"
                                maxLength={8}
                            />
                        </div>
                        <div className="w-24">
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Ano</label>
                            <input 
                                value={vehicleData.ano}
                                onChange={e => setVehicleData({...vehicleData, ano: e.target.value})}
                                className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500 text-center"
                                placeholder="2024"
                            />
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                         <div>
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Marca *</label>
                            <input 
                                value={vehicleData.marca}
                                onChange={e => setVehicleData({...vehicleData, marca: e.target.value})}
                                className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500"
                                placeholder="Ex: VW"
                            />
                        </div>
                         <div>
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Modelo *</label>
                            <input 
                                value={vehicleData.modelo}
                                onChange={e => setVehicleData({...vehicleData, modelo: e.target.value})}
                                className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500"
                                placeholder="Ex: Gol"
                            />
                        </div>
                    </div>
                     <div className="grid grid-cols-2 gap-3">
                         <div>
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Cor</label>
                            <input 
                                value={vehicleData.cor}
                                onChange={e => setVehicleData({...vehicleData, cor: e.target.value})}
                                className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500"
                                placeholder="Ex: Branco"
                            />
                        </div>
                         <div>
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Combust√≠vel *</label>
                            <select 
                                value={vehicleData.combustivel}
                                onChange={e => setVehicleData({...vehicleData, combustivel: e.target.value})}
                                className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500 bg-white"
                            >
                                <option value="FLEX">Flex</option>
                                <option value="GASOLINA">Gasolina</option>
                                <option value="ETANOL">Etanol</option>
                                <option value="DIESEL">Diesel</option>
                                <option value="GNV">GNV</option>
                                <option value="ELETRICO">El√©trico</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            {/* SECTION: OS BASICS */}
            <div className="p-4 bg-white rounded-2xl border border-neutral-200 shadow-sm grid grid-cols-1 md:grid-cols-3 gap-4">
                 <div className="col-span-1 md:col-span-3 pb-2 border-b border-neutral-100 mb-2">
                     <h3 className="font-black text-primary-600 uppercase tracking-widest text-xs flex items-center gap-2">
                         <Wrench size={16} /> Detalhes Iniciais
                     </h3>
                 </div>

                 <div>
                     <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">KM Entrada *</label>
                     <input 
                         type="number"
                         value={osData.km_entrada}
                         onChange={e => setOsData({...osData, km_entrada: e.target.value})}
                         className="w-full p-3 rounded-xl border border-neutral-200 font-black text-xl text-neutral-900 outline-none focus:border-primary-500"
                         placeholder="000000"
                     />
                 </div>
                 <div>
                     <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Mec√¢nico *</label>
                     <select 
                        value={osData.id_funcionario}
                        onChange={e => setOsData({...osData, id_funcionario: e.target.value})}
                        className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500 bg-white"
                     >
                         <option value="">Selecione...</option>
                         {employees.map(e => (
                             <option key={e.id_funcionario} value={e.id_funcionario}>
                                 {e.pessoa_fisica?.pessoa?.nome || 'Func'}
                             </option>
                         ))}
                     </select>
                 </div>
                 <div>
                     <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Defeito (Opcional)</label>
                     <input 
                         value={osData.defeito}
                         onChange={e => setOsData({...osData, defeito: e.target.value})}
                         className="w-full p-3 rounded-xl border border-neutral-200 font-medium text-neutral-800 outline-none focus:border-primary-500"
                         placeholder="Barulho no motor..."
                     />
                 </div>
            </div>

            {/* ACTIONS */}
            <div className="flex gap-4 pt-4">
                <Button variant="secondary" onClick={onCancel} className="flex-1 py-4 h-auto text-neutral-500">
                    Cancelar
                </Button>
                <Button variant="primary" onClick={handleSubmit} isLoading={loading} className="flex-2 w-full py-4 h-auto text-lg uppercase tracking-widest">
                    CRIAR ORDEM DE SERVI√áO <ArrowRight className="ml-2" />
                </Button>
            </div>
        </div>
    );
};



================================================================================
FILE PATH: client\src\components\forms\VeiculoForm.tsx
================================================================================
import { useState, useEffect, useRef } from "react";
import type { FormEvent } from "react";
import { api } from "../../services/api";
import { normalizePlate } from "../../utils/normalize";
import {
  Car,
  Search,
  User,
  Check,
  X,
  CheckCircle,
  AlertCircle,
  Save,
} from "lucide-react";
import { Button } from "../ui/Button";
import { Input } from "../ui/input";

interface VeiculoFormProps {
  clientId?: number | null;
  vehicleId?: number;
  initialData?: any;
  onSuccess: (newItem: any) => void;
  onCancel: () => void;
  onCreateClient?: () => void;
}

interface ClientResult {
  id_cliente: number;
  email: string;
  telefone_1: string;
  pessoa_fisica?: {
    pessoa: { nome: string };
    cpf: string;
  };
  pessoa_juridica?: {
    razao_social: string;
    nome_fantasia: string;
    cnpj: string;
  };
}

export const VeiculoForm = ({
  clientId,
  vehicleId,
  initialData,
  onSuccess,
  onCancel,
  onCreateClient,
}: VeiculoFormProps) => {
  const [loading, setLoading] = useState(false);
  const [formStatus, setFormStatus] = useState<{
    type: "success" | "error" | null;
    message: string;
  }>({ type: null, message: "" });

  // Client Search State
  const [clientSearchTerm, setClientSearchTerm] = useState("");
  const [clientResults, setClientResults] = useState<ClientResult[]>([]);
  const [selectedOwner, setSelectedOwner] = useState<{
    id: number;
    name: string;
  } | null>(null);
  const [isSearchingClient, setIsSearchingClient] = useState(false);

  const firstInputRef = useRef<HTMLInputElement>(null);

  // Form States
  const [placa, setPlaca] = useState("");
  const [marca, setMarca] = useState("");
  const [modelo, setModelo] = useState("");
  const [cor, setCor] = useState("");
  const [anoModelo, setAnoModelo] = useState("");
  const [combustivel, setCombustivel] = useState("Flex");
  const [chassi, setChassi] = useState("");

  useEffect(() => {
    if (firstInputRef.current) {
      firstInputRef.current.focus();
    }
  }, [clientId, vehicleId]);

  useEffect(() => {
    if (initialData) {
      setPlaca(initialData.placa || "");
      setMarca(initialData.marca || "");
      setModelo(initialData.modelo || "");
      setCor(initialData.cor || "");
      setAnoModelo(initialData.ano_modelo || "");
      setCombustivel(initialData.combustivel || "Flex");
      setChassi(initialData.chassi || "");
    }
  }, [initialData]);

  const [clientActiveIndex, setClientActiveIndex] = useState(-1);

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Escape") {
      setClientResults([]);
      setClientActiveIndex(-1);
      return;
    }

    if (clientResults.length === 0) return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      const next =
        clientActiveIndex + 1 >= clientResults.length
          ? 0
          : clientActiveIndex + 1;
      setClientActiveIndex(next);
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      const prev =
        clientActiveIndex - 1 < 0
          ? clientResults.length - 1
          : clientActiveIndex - 1;
      setClientActiveIndex(prev);
    } else if (e.key === "Enter" && clientActiveIndex !== -1) {
      e.preventDefault();
      selectClient(clientResults[clientActiveIndex]);
    }
  };

  const handleSearchClient = async (term: string) => {
    setClientSearchTerm(term);
    setClientActiveIndex(-1);
    if (term.length < 3) {
      setClientResults([]);
      return;
    }

    setIsSearchingClient(true);
    try {
      const response = await api.get(`/cliente/search?name=${term}`);
      setClientResults(response.data);
    } catch (error) {
      console.error("Erro ao buscar clientes", error);
    } finally {
      setIsSearchingClient(false);
    }
  };

  const selectClient = (client: ClientResult) => {
    const name =
      client.pessoa_fisica?.pessoa?.nome ||
      client.pessoa_juridica?.nome_fantasia ||
      client.pessoa_juridica?.razao_social ||
      "Cliente Sem Nome";

    setSelectedOwner({ id: client.id_cliente, name });
    setClientResults([]);
    setClientSearchTerm("");
    setClientActiveIndex(-1);
  };

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setFormStatus({ type: null, message: "" });

    const finalClientId = clientId || selectedOwner?.id;

    // For creation, clientId is required.
    if (!vehicleId && !finalClientId) {
      setFormStatus({
        type: "error",
        message: "√â necess√°rio selecionar um propriet√°rio.",
      });
      return;
    }

    setLoading(true);
    try {
      const payload = {
        id_cliente: finalClientId,
        placa: normalizePlate(placa),
        marca,
        modelo,
        cor,
        ano_modelo: anoModelo,
        combustivel,
        chassi,
      };

      if (vehicleId) {
        const response = await api.put(`/veiculo/${vehicleId}`, payload);
        setFormStatus({
          type: "success",
          message: "Ve√≠culo atualizado com sucesso!",
        });
        setTimeout(() => onSuccess(response.data), 1500);
      } else {
        const response = await api.post("/veiculo", payload);
        setFormStatus({
          type: "success",
          message: "Ve√≠culo cadastrado com sucesso!",
        });
        setTimeout(() => onSuccess(response.data), 1500);
      }
    } catch (error: any) {
      console.error(error);
      setFormStatus({
        type: "error",
        message:
          "Erro ao salvar ve√≠culo: " +
          (error.response?.data?.error || error.message),
      });
    } finally {
      setLoading(false);
    }
  };

  // Helper to determine if we need to show client selection
  const needsClientSelection = !vehicleId && !clientId;

  return (
    <form onSubmit={handleSubmit} className="space-y-6 text-neutral-900">
      {formStatus.type && (
        <div
          className={`p-4 rounded-xl flex items-center gap-3 animate-in fade-in slide-in-from-top-2 duration-300 ${formStatus.type === "success" ? "bg-success-50 text-success-700 border border-success-100" : "bg-red-50 text-red-700 border border-red-100"}`}
        >
          {formStatus.type === "success" ? (
            <CheckCircle size={20} />
          ) : (
            <AlertCircle size={20} />
          )}
          <p className="text-sm font-bold">{formStatus.message}</p>
        </div>
      )}

      {/* 1. Client Selection Section (Only for new vehicles where ID isn't pre-injected) */}
      {/* 1. Client Selection Section (Only for new vehicles where ID isn't pre-injected) */}
      {needsClientSelection && (
        <div className="space-y-3 p-4 bg-neutral-25 rounded-3xl border border-neutral-200">
          <div className="flex items-center gap-2 mb-2 pb-2 border-b border-neutral-100">
            <User className="text-primary-600" size={20} />
            <h3 className="font-bold text-neutral-500">
              Propriet√°rio do Ve√≠culo
            </h3>
          </div>

          {!selectedOwner ? (
            <div className="relative">
              <Input
                ref={firstInputRef}
                icon={Search}
                placeholder="Buscar cliente por nome..."
                value={clientSearchTerm}
                onChange={(e) => handleSearchClient(e.target.value)}
                onKeyDown={handleKeyDown}
                className="bg-neutral-25"
              />

              {/* Results Dropdown */}
              {clientResults.length > 0 && (
                <div className="absolute z-10 w-full mt-1 bg-neutral-25 border border-neutral-200 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                  {clientResults.map((client, idx) => {
                    const name =
                      client.pessoa_fisica?.pessoa?.nome ||
                      client.pessoa_juridica?.nome_fantasia ||
                      client.pessoa_juridica?.razao_social;
                    const contact =
                      client.telefone_1 || client.email || "Sem Contato";
                    return (
                      <button
                        key={client.id_cliente}
                        type="button"
                        onClick={() => selectClient(client)}
                        className={`w-full text-left p-3 hover:bg-primary-50 transition-colors border-b border-neutral-100 last:border-0 ${idx === clientActiveIndex ? "bg-primary-100" : ""}`}
                      >
                        <div className="font-bold text-sm text-neutral-500">
                          {name}
                        </div>
                        <div className="text-xs text-neutral-500">
                          {contact}
                        </div>
                      </button>
                    );
                  })}
                </div>
              )}
              {clientSearchTerm.length > 2 &&
                clientResults.length === 0 &&
                !isSearchingClient && (
                  <div className="mt-2 text-center">
                    <p className="text-xs text-neutral-500 mb-2">
                      Nenhum cliente encontrado.
                    </p>
                    {onCreateClient && (
                      <button
                        type="button"
                        onClick={onCreateClient}
                        className="text-sm text-primary-600 font-bold hover:underline"
                      >
                        + Cadastrar Novo Cliente
                      </button>
                    )}
                  </div>
                )}
            </div>
          ) : (
            <div className="flex items-center justify-between bg-primary-50 p-3 rounded-lg border border-primary-100">
              <div className="flex items-center gap-3">
                <div className="bg-primary-600 text-neutral-25 p-2 rounded-full">
                  <Check size={16} />
                </div>
                <div>
                  <p className="text-xs text-primary-600 font-bold uppercase">
                    Cliente Selecionado
                  </p>
                  <p className="font-bold text-primary-900">
                    {selectedOwner.name}
                  </p>
                </div>
              </div>
              <button
                type="button"
                onClick={() => setSelectedOwner(null)}
                className="p-2 text-primary-600 hover:bg-primary-100 rounded-lg transition-colors"
                title="Alterar Cliente"
              >
                <X size={18} />
              </button>
            </div>
          )}
        </div>
      )}

      {/* 2. Vehicle Info Section */}
      <div className="bg-neutral-25 p-6 rounded-3xl border border-neutral-200">
        <div className="flex items-center gap-3 mb-6 pb-4 border-b border-neutral-100">
          <div className="p-3 bg-primary-50 text-primary-600 rounded-xl">
            <Car size={24} />
          </div>
          <div>
            <h3 className="font-bold text-neutral-500 text-lg">
              Dados do Ve√≠culo
            </h3>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <Input
              label="Placa *"
              ref={needsClientSelection ? null : firstInputRef}
              value={placa}
              onChange={(e) => setPlaca(e.target.value.toUpperCase())}
              maxLength={7}
              placeholder="ABC1234"
              required
              className="bg-neutral-25"
            />
          </div>
          <div>
            <Input
              label="Marca *"
              value={marca}
              onChange={(e) => setMarca(e.target.value)}
              required
              className="bg-neutral-25"
            />
          </div>
          <div>
            <Input
              label="Modelo *"
              value={modelo}
              onChange={(e) => setModelo(e.target.value)}
              required
              className="bg-neutral-25"
            />
          </div>
          <div>
            <Input
              label="Cor *"
              value={cor}
              onChange={(e) => setCor(e.target.value)}
              required
              className="bg-neutral-25"
            />
          </div>
          <div>
            <Input
              label="Ano Modelo (YYYY)"
              type="number"
              value={anoModelo}
              onChange={(e) => setAnoModelo(e.target.value)}
              className="bg-neutral-25"
            />
          </div>
          <div>
            <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
              Combust√≠vel
            </label>
            <select
              value={combustivel}
              onChange={(e) => setCombustivel(e.target.value)}
              className="w-full transition-all outline-none rounded-lg border text-sm disabled:opacity-50 disabled:bg-neutral-100 border-neutral-200 focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 text-neutral-900 bg-neutral-25 px-4 py-2.5"
            >
              <option value="Flex">Flex</option>
              <option value="Gasolina">Gasolina</option>
              <option value="Etanol">Etanol</option>
              <option value="Diesel">Diesel</option>
              <option value="GNV">GNV</option>
              <option value="El√©trico">El√©trico</option>
            </select>
          </div>
          <div className="col-span-2">
            <Input
              label="Chassi"
              value={chassi}
              onChange={(e) => setChassi(e.target.value)}
              className="bg-neutral-25"
            />
          </div>
        </div>
      </div>

      <div className="flex gap-2 pt-4 border-t border-neutral-100">
        <Button
          type="button"
          variant="ghost"
          onClick={onCancel}
          className="flex-1"
        >
          Cancelar
        </Button>
        <Button
          type="submit"
          variant="primary"
          disabled={loading || (!clientId && !selectedOwner && !vehicleId)}
          className="flex-1"
          icon={Save}
        >
          {loading
            ? "Salvando..."
            : vehicleId
              ? "Salvar Altera√ß√µes"
              : "Salvar Ve√≠culo"}
        </Button>
      </div>
    </form>
  );
};



================================================================================
FILE PATH: client\src\components\layouts\MainLayout.tsx
================================================================================
import { Outlet } from "react-router-dom";
import { Sidebar } from "../Sidebar";

export function MainLayout() {
  return (
    <div className="flex bg-background min-h-screen w-full">
      <Sidebar />
      <main className="flex-1 ml-64 p-8 overflow-y-auto">
        <div className="w-full">
          {/* Breadcrumbs ou Header Global poderiam entrar aqui */}
          <Outlet />
        </div>
      </main>
    </div>
  );
}



================================================================================
FILE PATH: client\src\components\os\LaborManager.tsx
================================================================================
import React, { useState, useEffect } from "react";
import { formatCurrency } from "../../utils/formatCurrency";
import { Plus, Check, X, Trash2, Edit } from "lucide-react";
import { api } from "../../services/api";
import type { FormEvent } from "react";
import { Button } from "../ui/Button";
import { ActionButton } from "../ui/ActionButton";

// Tipagem b√°sica para garantir o funcionamento
interface LaborService {
  id_servico_mao_de_obra?: number;
  id_temporary?: string; // Para modo draft
  id_funcionario: number | string;
  valor: number | string;
  descricao?: string;
  funcionario?: {
    pessoa_fisica?: {
      pessoa?: {
        nome: string;
      };
    };
  };
}

interface LaborManagerProps {
  osId?: number;
  mode: "api" | "draft";
  initialData?: LaborService[]; // Para carregar dados ou estado inicial
  onChange?: (services: LaborService[]) => void; // Para retornar dados no modo draft
  employees: any[];
  readOnly?: boolean;
  onTotalChange?: (total: number) => void;
}

export const LaborManager: React.FC<LaborManagerProps> = ({
  osId,
  mode,
  initialData = [],
  onChange,
  employees,
  readOnly = false,
  onTotalChange,
}) => {
  const [laborServices, setLaborServices] =
    useState<LaborService[]>(initialData);
  const [newLaborService, setNewLaborService] = useState({
    id_funcionario: "",
    valor: "",
    descricao: "",
  });
  const [editingLaborId, setEditingLaborId] = useState<number | string | null>(
    null,
  );
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  // Sincroniza com dados externos se mudarem
  useEffect(() => {
    if (initialData) {
      setLaborServices(initialData);
    }
  }, [initialData]);

  // Recalcula total sempre que laborServices mudar
  useEffect(() => {
    const total = laborServices.reduce(
      (acc, svc) => acc + Number(svc.valor),
      0,
    );
    if (onTotalChange) onTotalChange(total);
  }, [laborServices, onTotalChange]);

  const handleAddLabor = async (e?: FormEvent) => {
    if (e) e.preventDefault();

    const val = Number(newLaborService.valor);
    if (isNaN(val) || val < 0) {
      setStatusMsg({ type: "error", text: "Valor inv√°lido." });
      return;
    }
    if (!newLaborService.id_funcionario) {
      setStatusMsg({ type: "error", text: "Selecione um funcion√°rio." });
      return;
    }

    const employee = employees.find(
      (emp) =>
        String(emp.id_funcionario) === String(newLaborService.id_funcionario),
    );

    const newItem: LaborService = {
      id_funcionario: newLaborService.id_funcionario,
      valor: val,
      descricao: newLaborService.descricao,
      funcionario: employee,
    };

    if (mode === "api") {
      if (!osId) return;
      try {
        if (editingLaborId) {
          const payload = {
            id_funcionario: newItem.id_funcionario,
            valor: newItem.valor,
            descricao: newItem.descricao,
          };
          await api.put(`/servico-mao-de-obra/${editingLaborId}`, payload);
          setStatusMsg({ type: "success", text: "M√£o de obra atualizada!" });
        } else {
          const payload = {
            id_os: osId,
            id_funcionario: newItem.id_funcionario,
            valor: newItem.valor,
            descricao: newItem.descricao,
          };
          await api.post("/servico-mao-de-obra", payload);
          setStatusMsg({ type: "success", text: "M√£o de obra adicionada!" });
        }

        if (onChange) onChange([]); // Trigger reload request

        // Reset form
        setNewLaborService({ id_funcionario: "", valor: "", descricao: "" });
        setEditingLaborId(null);
        setTimeout(() => setStatusMsg({ type: null, text: "" }), 1500);
      } catch (error) {
        setStatusMsg({ type: "error", text: "Erro ao salvar m√£o de obra." });
      }
    } else {
      // DRAFT MODE
      if (editingLaborId) {
        const updatedList = laborServices.map((item) =>
          item.id_temporary === editingLaborId ||
          item.id_servico_mao_de_obra === editingLaborId
            ? { ...item, ...newItem }
            : item,
        );
        setLaborServices(updatedList);
        if (onChange) onChange(updatedList);
      } else {
        const newItemWithId = {
          ...newItem,
          id_temporary: Date.now().toString(),
        };
        const newList = [...laborServices, newItemWithId];
        setLaborServices(newList);
        if (onChange) onChange(newList);
      }
      setNewLaborService({ id_funcionario: "", valor: "", descricao: "" });
      setEditingLaborId(null);
    }
  };

  const handleEditLabor = (service: LaborService) => {
    setNewLaborService({
      id_funcionario: String(service.id_funcionario),
      valor: String(service.valor),
      descricao: service.descricao || "",
    });
    // Important: Store the correct ID depending on mode/existence
    const idToEdit = service.id_servico_mao_de_obra || service.id_temporary;
    setEditingLaborId(idToEdit || null);
  };

  const handleDeleteLabor = async (id: number | string) => {
    if (mode === "api") {
      // In API mode, we expect a real numeric ID
      if (!id || typeof id !== "number") return;
      try {
        await api.delete(`/servico-mao-de-obra/${id}`);
        setStatusMsg({ type: "success", text: "Removido!" });
        if (onChange) onChange([]); // Trigger parent reload
        setTimeout(() => setStatusMsg({ type: null, text: "" }), 1500);
      } catch (error) {
        setStatusMsg({ type: "error", text: "Erro ao remover." });
      }
    } else {
      // In Draft mode, filter by whatever ID we have
      const newList = laborServices.filter(
        (s) => s.id_temporary !== id && s.id_servico_mao_de_obra !== id,
      );
      setLaborServices(newList);
      if (onChange) onChange(newList);
    }
  };

  return (
    <div className="space-y-4">
      {statusMsg.text && (
        <div
          className={`text-xs font-bold p-2 rounded-lg text-center ${statusMsg.type === "error" ? "bg-red-50 text-red-600" : "bg-green-50 text-green-600"}`}
        >
          {statusMsg.text}
        </div>
      )}

      {!readOnly && (
        <div className="p-4 bg-neutral-25 rounded-2xl border border-primary-100 grid grid-cols-12 gap-3 items-end">
          <div className="col-span-12 md:col-span-5">
            <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1 block">
              Profissional / Mec√¢nico
            </label>
            <select
              value={newLaborService.id_funcionario}
              onChange={(e) =>
                setNewLaborService({
                  ...newLaborService,
                  id_funcionario: e.target.value,
                })
              }
              className="w-full p-3 rounded-xl border border-primary-200 outline-none focus:border-primary-500 font-bold text-sm bg-neutral-25"
            >
              <option value="">Selecione...</option>
              {employees.map((emp) => (
                <option key={emp.id_funcionario} value={emp.id_funcionario}>
                  {emp.pessoa_fisica?.pessoa?.nome} ({emp.cargo})
                </option>
              ))}
            </select>
          </div>
          <div className="col-span-12 md:col-span-3">
            <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1 block">
              Descri√ß√£o (Opcional)
            </label>
            <input
              value={newLaborService.descricao}
              onChange={(e) =>
                setNewLaborService({
                  ...newLaborService,
                  descricao: e.target.value,
                })
              }
              placeholder="Ex: Troca de √≥leo..."
              className="w-full p-3 rounded-xl border border-primary-200 outline-none focus:border-primary-500 font-bold text-sm bg-neutral-25"
            />
          </div>
          <div className="col-span-12 md:col-span-2">
            <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1 block">
              Valor (R$)
            </label>
            <input
              type="number"
              step="0.01"
              value={newLaborService.valor}
              onChange={(e) =>
                setNewLaborService({
                  ...newLaborService,
                  valor: e.target.value,
                })
              }
              placeholder="0.00"
              className="w-full p-3 rounded-xl border border-primary-200 outline-none focus:border-primary-500 font-bold text-sm bg-neutral-25"
            />
          </div>
          <div className="col-span-12 md:col-span-2 flex gap-1 h-[46px] items-end">
            <Button
              type="button"
              onClick={handleAddLabor}
              disabled={
                !newLaborService.id_funcionario || !newLaborService.valor
              }
              variant="primary"
              className="w-full h-[46px] flex items-center justify-center p-0"
            >
              {editingLaborId ? (
                <Check size={20} strokeWidth={3} />
              ) : (
                <Plus size={20} strokeWidth={3} />
              )}
            </Button>
            {editingLaborId && (
              <Button
                type="button"
                onClick={() => {
                  setNewLaborService({
                    id_funcionario: "",
                    valor: "",
                    descricao: "",
                  });
                  setEditingLaborId(null);
                }}
                variant="secondary"
                className="h-[46px] w-[46px] flex items-center justify-center px-0 min-w-[46px]"
              >
                <X size={20} />
              </Button>
            )}
          </div>
        </div>
      )}

      {/* Lista M√£o de Obra */}
      <div className="bg-neutral-25 border border-neutral-100 rounded-2xl overflow-hidden shadow-sm">
        {laborServices.length === 0 ? (
          <div className="p-6 text-center text-neutral-400 text-xs italic">
            Nenhum servi√ßo de m√£o de obra lan√ßado.
          </div>
        ) : (
          <table className="w-full text-xs text-left">
            <thead className="bg-neutral-50 border-b border-neutral-100">
              <tr>
                <th className="p-3 font-bold text-neutral-400 uppercase text-[9px] tracking-widest">
                  Profissional
                </th>
                <th className="p-3 font-bold text-neutral-400 uppercase text-[9px] tracking-widest">
                  Descri√ß√£o
                </th>
                <th className="p-3 font-bold text-neutral-400 uppercase text-[9px] tracking-widest text-right">
                  Valor
                </th>
                <th className="p-3 text-center"></th>
              </tr>
            </thead>
            <tbody className="divide-y divide-neutral-50 bg-primary-100 ">
              {laborServices.map((svc) => (
                <tr
                  className="hover:bg-neutral-50/50 transition-colors group"
                  key={svc.id_servico_mao_de_obra || svc.id_temporary}
                >
                  <td className="p-3 font-bold text-neutral-700">
                    {svc.funcionario?.pessoa_fisica?.pessoa?.nome ||
                      employees.find(
                        (e) =>
                          String(e.id_funcionario) ===
                          String(svc.id_funcionario),
                      )?.pessoa_fisica?.pessoa?.nome ||
                      "Mec√¢nico"}
                  </td>
                  <td className="p-3 text-neutral-600">
                    {svc.descricao || "-"}
                  </td>
                  <td className="p-3 text-right font-bold text-neutral-900">
                    {formatCurrency(Number(svc.valor))}
                  </td>
                  <td className="p-3 text-center">
                    {!readOnly && (
                      <div className="flex items-center justify-center gap-1">
                        <ActionButton
                          icon={Edit}
                          label="Editar"
                          onClick={() => handleEditLabor(svc)}
                          variant="neutral"
                        />
                        <ActionButton
                          icon={Trash2}
                          label="Excluir"
                          onClick={() =>
                            handleDeleteLabor(
                              svc.id_servico_mao_de_obra || svc.id_temporary!,
                            )
                          }
                          variant="danger"
                        />
                      </div>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>
    </div>
  );
};



================================================================================
FILE PATH: client\src\components\os\OrdemDeServicoNova.tsx
================================================================================

import React, { useState, useEffect } from 'react';
import { Search, Plus, Car, User, AlertTriangle, ArrowRight, Loader2 } from 'lucide-react';
import { api } from '../../services/api';
import { UnifiedOsForm } from '../forms/UnifiedOsForm';
import { Modal } from '../ui/Modal';
import { Button } from '../ui/Button';

interface OrdemDeServicoNovaProps {
    employees: any[];
    onSuccess: (osId: number) => void;
}

export const OrdemDeServicoNova: React.FC<OrdemDeServicoNovaProps> = ({ employees, onSuccess }) => {
    // MODE: 'search' (default) or 'create' (modal)
    const [searchQuery, setSearchQuery] = useState('');
    const [results, setResults] = useState<{ vehicles: any[], clients: any[] }>({ vehicles: [], clients: [] });
    const [loadingSearch, setLoadingSearch] = useState(false);

    const [createModalOpen, setCreateModalOpen] = useState(false);
    
    // If a client is selected from search, we show their vehicles
    const [selectedClient, setSelectedClient] = useState<any | null>(null);
    const [clientVehicles, setClientVehicles] = useState<any[]>([]);

    // Confirmation Modal for "Quick Start"
    const [quickStartModal, setQuickStartModal] = useState<{ isOpen: boolean, vehicle: any, client: any }>({ isOpen: false, vehicle: null, client: null });
    const [quickStartData, setQuickStartData] = useState({ km: '', mechanic: '', defect: '' });
    const [quickLoading, setQuickLoading] = useState(false);

    // --- SEARCH LOGIC ---
    useEffect(() => {
        const timer = setTimeout(() => {
            if (searchQuery.length >= 2) {
                performSearch(searchQuery);
            } else {
                setResults({ vehicles: [], clients: [] });
                setSelectedClient(null);
            }
        }, 300); // Fast debounce
        return () => clearTimeout(timer);
    }, [searchQuery]);

    const performSearch = async (q: string) => {
        setLoadingSearch(true);
        try {
            const [vRes, cRes] = await Promise.all([
                api.get(`/veiculo/search?q=${q}`),
                api.get(`/cliente/search?q=${q}`)
            ]);
            setResults({
                vehicles: vRes.data || [],
                clients: cRes.data || []
            });
        } catch (e) { console.error(e); }
        finally { setLoadingSearch(false); }
    };

    const handleSelectVehicle = (v: any) => {
        // Find client info if not populated (search vehicle endpoint usually populates, let's assume it does or we fetch)
        // vehicle search usually returns client relation.
         if (v.cliente) {
             setQuickStartModal({ isOpen: true, vehicle: v, client: v.cliente });
         } else {
             // Fetch client if missing? Assuming robust backend response for now.
             // If missing client, we can't really start OS easily. 
             console.error("Vehicle has no client data", v);
         }
    };

    const handleSelectClient = async (c: any) => {
        setSelectedClient(c);
        // Fetch vehicles for this client specifically if not already present or if we want to be sure
        // Ideally we search vehicles by client ID.
        try {
            const res = await api.get('/veiculo'); // Filtering client side as fallback or specific endpoint
            const myVehicles = res.data.filter((v: any) => v.id_cliente === c.id_cliente);
            setClientVehicles(myVehicles);
        } catch(e) { console.error(e); }
    };

    const handleQuickCreate = async () => {
        if (!quickStartData.km || !quickStartData.mechanic) return;
        setQuickLoading(true);
        try {
            const payload = {
                id_veiculo: quickStartModal.vehicle.id_veiculo,
                id_cliente: quickStartModal.client.id_cliente,
                id_funcionario: Number(quickStartData.mechanic),
                km_entrada: Number(quickStartData.km),
                defeito_relatado: quickStartData.defect,
                status: 'ABERTA',
                dt_abertura: new Date().toISOString(),
                valor_total_cliente: 0,
                valor_mao_de_obra: 0,
                parcelas: 1
            };
            const res = await api.post('/ordem-de-servico', payload);
            setQuickStartModal({ isOpen: false, vehicle: null, client: null });
            onSuccess(res.data.id_os);
        } catch (e) {
            console.error(e);
            alert('Erro ao criar OS.');
        } finally {
            setQuickLoading(false);
        }
    };

    const handleNewVehicleForSelectedClient = () => {
        // Open Unified Form but pre-fill client
        setCreateModalOpen(true);
        // The UnifiedForm should handle "InitialClient" prop.
    };

    return (
        <div className="max-w-4xl mx-auto py-10 px-4">
            
            {/* BIG SEARCH BAR */}
            <div className="relative mb-8">
                <div className="flex gap-2">
                    <div className="relative flex-1 group">
                        <Search className="absolute left-6 top-1/2 -translate-y-1/2 text-neutral-400 group-focus-within:text-primary-500 transition-colors" size={24} />
                        <input 
                            value={searchQuery}
                            onChange={e => setSearchQuery(e.target.value)}
                            className="w-full h-[72px] pl-16 pr-6 rounded-2xl bg-white border-2 border-neutral-100 shadow-xl shadow-neutral-100/50 text-2xl font-black text-neutral-800 placeholder:text-neutral-300 outline-none focus:border-primary-500 transition-all"
                            placeholder="Busque por Placa, Cliente ou Modelo..."
                            autoFocus
                        />
                         {loadingSearch && <div className="absolute right-6 top-1/2 -translate-y-1/2"><Loader2 className="animate-spin text-primary-500" /></div>}
                    </div>
                    
                    <button 
                        onClick={() => { setSelectedClient(null); setCreateModalOpen(true); }}
                        className="h-[72px] px-8 bg-primary-600 hover:bg-primary-700 text-white rounded-2xl font-black text-lg flex items-center gap-2 shadow-lg shadow-primary-500/30 transition-all active:scale-95"
                    >
                        <Plus strokeWidth={3} /> <span className="hidden md:inline">CRIAR NOVO</span>
                    </button>
                </div>
            </div>

            {/* RESULTS AREA */}
            <div className="space-y-6">
                {selectedClient && (
                    <div className="bg-primary-50 border border-primary-100 p-6 rounded-2xl animate-in fade-in slide-in-from-top-4">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <p className="text-xs font-black text-primary-400 uppercase tracking-widest">Cliente Selecionado</p>
                                <h3 className="text-2xl font-black text-primary-900">{selectedClient.pessoa_fisica?.pessoa?.nome || selectedClient.pessoa_juridica?.razao_social}</h3>
                                <p className="text-primary-700 font-bold">{selectedClient.telefone_1 || 'Sem telefone'}</p>
                            </div>
                            <button onClick={() => setSelectedClient(null)} className="text-primary-400 hover:text-primary-700 font-bold text-sm">Trocar</button>
                        </div>
                        
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                            {clientVehicles.map(v => (
                                <button 
                                    key={v.id_veiculo}
                                    onClick={() => handleSelectVehicle({...v, cliente: selectedClient})} // Inject client to be safe
                                    className="p-4 bg-white rounded-xl border border-primary-200 text-left hover:border-primary-500 hover:shadow-md transition-all group"
                                >
                                    <p className="font-black text-lg text-neutral-800 group-hover:text-primary-600">{v.placa}</p>
                                    <p className="text-sm font-bold text-neutral-500">{v.modelo} ‚Ä¢ {v.cor}</p>
                                    <div className="mt-2 text-xs font-bold text-primary-600 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        Abrir OS <ArrowRight size={12} />
                                    </div>
                                </button>
                            ))}
                            <button 
                                onClick={handleNewVehicleForSelectedClient}
                                className="p-4 bg-white/50 border-2 border-dashed border-primary-300 rounded-xl text-primary-600 font-bold flex flex-col items-center justify-center gap-2 hover:bg-white hover:border-solid hover:shadow-md transition-all"
                            >
                                <Plus size={24} /> Novo Ve√≠culo
                            </button>
                        </div>
                    </div>
                )}

                {/* SEARCH RESULTS LIST */}
                {!selectedClient && (results.vehicles.length > 0 || results.clients.length > 0) && (
                   <div className="bg-white rounded-2xl border border-neutral-100 shadow-sm overflow-hidden animate-in fade-in">
                       {/* VEHICLES RESULTS */}
                       {results.vehicles.map(v => (
                           <button 
                                key={`v-${v.id_veiculo}`} 
                                onClick={() => handleSelectVehicle(v)}
                                className="w-full text-left p-6 border-b border-neutral-50 hover:bg-neutral-50 transition-colors flex items-center justify-between group"
                           >
                                <div className="flex items-center gap-4">
                                    <div className="h-12 w-12 rounded-full bg-neutral-100 text-neutral-500 flex items-center justify-center group-hover:bg-primary-100 group-hover:text-primary-600 transition-colors">
                                        <Car size={24} />
                                    </div>
                                    <div>
                                        <h4 className="font-black text-xl text-neutral-800">{v.placa}</h4>
                                        <p className="text-sm font-bold text-neutral-500">{v.modelo} ‚Ä¢ {v.cor}</p>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <p className="text-xs font-bold text-neutral-400 uppercase">Propriet√°rio</p>
                                    <p className="font-bold text-neutral-700">{v.cliente?.pessoa_fisica?.pessoa?.nome || v.cliente?.pessoa_juridica?.razao_social || 'Desconhecido'}</p>
                                </div>
                           </button>
                       ))}

                       {/* CLIENTS RESULTS */}
                       {results.clients.map(c => (
                            <button 
                                key={`c-${c.id_cliente}`} 
                                onClick={() => handleSelectClient(c)}
                                className="w-full text-left p-6 border-b border-neutral-50 hover:bg-neutral-50 transition-colors flex items-center justify-between group"
                            >
                                <div className="flex items-center gap-4">
                                    <div className="h-12 w-12 rounded-full bg-neutral-100 text-neutral-500 flex items-center justify-center group-hover:bg-primary-100 group-hover:text-primary-600 transition-colors">
                                        <User size={24} />
                                    </div>
                                    <div>
                                        <h4 className="font-black text-xl text-neutral-800">{c.pessoa_fisica?.pessoa?.nome || c.pessoa_juridica?.razao_social}</h4>
                                        <p className="text-sm font-bold text-neutral-500">{c.telefone_1 || 'Sem telefone'}</p>
                                    </div>
                                </div>
                                <div className="px-4 py-2 rounded-lg bg-neutral-100 text-xs font-bold text-neutral-500 group-hover:bg-white group-hover:text-primary-600 transition-colors">
                                    Ver Ve√≠culos
                                </div>
                            </button>
                       ))}
                   </div>
                )}
                
                {searchQuery.length > 2 && !selectedClient && results.vehicles.length === 0 && results.clients.length === 0 && !loadingSearch && (
                    <div className="text-center py-10 opacity-50">
                        <AlertTriangle className="mx-auto mb-2 text-neutral-400" size={48} />
                        <p className="font-bold text-neutral-500">Nenhum resultado encontrado.</p>
                        <p className="text-sm">Tente buscar por outro termo ou clique em "Criar Novo".</p>
                    </div>
                )}

                {!searchQuery && !selectedClient && (
                    <div className="text-center py-12">
                         <div className="inline-block p-4 bg-primary-50 rounded-full text-primary-300 mb-4">
                             <Search size={48} />
                         </div>
                         <h2 className="text-xl font-black text-neutral-900 mb-2">Comece a digitar...</h2>
                         <p className="text-neutral-500 max-w-sm mx-auto">Busque rapidamente por placa ou nome para iniciar um atendimento.</p>
                    </div>
                )}
            </div>

            {/* MODAL: UNIFIED FORM */}
            {createModalOpen && (
                <Modal title="Novo Cadastro" onClose={() => setCreateModalOpen(false)}>
                    <UnifiedOsForm 
                        employees={employees} 
                        initialClient={selectedClient}
                        onCancel={() => setCreateModalOpen(false)}
                        onSuccess={(id) => { setCreateModalOpen(false); onSuccess(id); }}
                    />
                </Modal>
            )}

            {/* MODAL: QUICK START OS (KM/MECH Input) */}
            {quickStartModal.isOpen && (
                <Modal title="Iniciar Servi√ßo" onClose={() => setQuickStartModal({ isOpen: false, vehicle: null, client: null })}>
                    <div className="space-y-6">
                        <div className="bg-primary-50 p-4 rounded-xl border border-primary-100">
                             <p className="text-xs font-black text-primary-400 uppercase">Ve√≠culo</p>
                             <p className="text-lg font-black text-primary-900">{quickStartModal.vehicle?.placa} - {quickStartModal.vehicle?.modelo}</p>
                             <p className="text-sm font-bold text-primary-700">{quickStartModal.client?.pessoa_fisica?.pessoa?.nome || quickStartModal.client?.pessoa_juridica?.razao_social}</p>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">KM Entrada *</label>
                                <input 
                                    type="number"
                                    autoFocus
                                    value={quickStartData.km}
                                    onChange={e => setQuickStartData({...quickStartData, km: e.target.value})}
                                    className="w-full p-3 rounded-xl border border-neutral-300 font-black text-xl text-neutral-900 outline-none focus:border-primary-500"
                                    placeholder="000000"
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Mec√¢nico *</label>
                                <select 
                                    value={quickStartData.mechanic}
                                    onChange={e => setQuickStartData({...quickStartData, mechanic: e.target.value})}
                                    className="w-full p-3 rounded-xl border border-neutral-300 font-bold text-neutral-800 outline-none focus:border-primary-500"
                                >
                                    <option value="">Selecione...</option>
                                    {employees.map(e => (
                                        <option key={e.id_funcionario} value={e.id_funcionario}>
                                            {e.pessoa_fisica?.pessoa?.nome}
                                        </option>
                                    ))}
                                </select>
                            </div>
                        </div>

                         <div>
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Defeito Relatado (Opcional)</label>
                            <input 
                                value={quickStartData.defect}
                                onChange={e => setQuickStartData({...quickStartData, defect: e.target.value})}
                                className="w-full p-3 rounded-xl border border-neutral-300 font-medium text-neutral-800 outline-none focus:border-primary-500"
                            />
                        </div>

                        <Button 
                            onClick={handleQuickCreate}
                            disabled={!quickStartData.km || !quickStartData.mechanic}
                            isLoading={quickLoading}
                            variant="primary"
                            className="w-full h-[54px] text-lg uppercase tracking-widest"
                        >
                            ABRIR OS
                        </Button>
                    </div>
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\components\ui\ActionButton.tsx
================================================================================
import React from "react";
import { type LucideIcon } from "lucide-react";

interface ActionButtonProps {
  icon: LucideIcon;
  label: string;
  onClick: (e: React.MouseEvent) => void;
  variant?: "primary" | "danger" | "accent" | "neutral";
  className?: string;
}

export const ActionButton = ({
  icon: Icon,
  label,
  onClick,
  variant = "neutral",
  className = "",
}: ActionButtonProps) => {
  const variants = {
    primary: "text-primary-600 hover:bg-primary-50 hover:text-primary-700",
    accent: "text-blue-600 hover:bg-blue-50 hover:text-blue-700",
    danger: "text-red-500 hover:bg-red-50 hover:text-red-600",
    neutral: "text-neutral-400 hover:bg-neutral-100 hover:text-neutral-600",
  };

  return (
    <div
      className={`group/action relative inline-flex items-center justify-center ${className}`}
    >
      <button
        type="button"
        onClick={(e) => {
          e.stopPropagation();
          onClick(e);
        }}
        className={`p-2 rounded-lg transition-all duration-200 ${variants[variant]}`}
      >
        <Icon size={18} />
      </button>

      {/* TOOLTIP: Otimizado */}
      <div className="absolute bottom-full mb-2 hidden group-hover/action:flex flex-col items-center pointer-events-none z-100 animate-in fade-in zoom-in-95 duration-200">
        <span className="px-2 py-1 text-[10px] font-bold text-white bg-neutral-800 rounded shadow-md whitespace-nowrap uppercase tracking-wider">
          {label}
        </span>
        {/* Tri√¢ngulo invertido */}
        <div className="w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-4 border-t-neutral-800" />
      </div>
    </div>
  );
};



================================================================================
FILE PATH: client\src\components\ui\Badge.tsx
================================================================================
import React from "react";

// Definindo os tipos de status que fazem sentido para sua oficina
export type BadgeVariant =
  | "primary"
  | "accent"
  | "success"
  | "danger"
  | "warning"
  | "neutral";

interface BadgeProps {
  children: React.ReactNode;
  variant?: BadgeVariant;
  className?: string;
}

export const Badge = ({
  children,
  variant = "neutral",
  className = "",
}: BadgeProps) => {
  // Aqui usamos o que voc√™ aprendeu: cores s√≥lidas para o texto e opacidade (/10 ou /20) para o fundo
  const variants = {
    // Laranja (Primary)
    primary: "bg-primary-500/10 text-primary-700 border-primary-500/20",

    // Cyan (Accent)
    accent: "bg-accent-500/10 text-accent-700 border-accent-500/20",

    // Verde (Sucesso)
    success: "bg-green-500/10 text-green-700 border-green-500/20",

    // Vermelho (Erro/Aten√ß√£o)
    danger: "bg-red-500/10 text-red-700 border-red-500/20",

    // Amarelo/Dourado (Aviso)
    warning: "bg-yellow-500/10 text-yellow-700 border-yellow-500/20",

    // Cinza (Neutro)
    neutral: "bg-neutral-500/10 text-neutral-700 border-neutral-500/20",
  };

  return (
    <span
      className={`
      inline-flex items-center px-2.5 py-0.5 
      rounded-full text-[10px] font-bold uppercase tracking-wider 
      border ${variants[variant]} ${className}
    `}
    >
      {children}
    </span>
  );
};



================================================================================
FILE PATH: client\src\components\ui\Button.tsx
================================================================================
import React from "react";
import { type LucideIcon } from "lucide-react";

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: "primary" | "secondary" | "danger" | "ghost" | "success" | "dark";
  size?: "sm" | "md" | "lg" | "blocks";
  icon?: LucideIcon;
  isLoading?: boolean;
  children: React.ReactNode;
}

export const Button = ({
  variant = "primary",
  size = "md",
  icon: Icon,
  isLoading = false,
  children,
  className = "",
  ...props
}: ButtonProps) => {
  const baseStyles =
    "font-black uppercase tracking-wide rounded-xl transition-all flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";

  const variants = {
    primary:
      "bg-primary-900 hover:bg-primary-800 hover:scale-105 transition-all shadow-xl shadow-primary-500/20 text-white px-4 py-2.5 rounded-lg font-medium transition-all shadow-sm",
    secondary:
      "bg-gray-100 text-gray-600 hover:bg-gray-200 hover:scale-105 transition-all ",
    danger:
      "bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 hover:scale-105 transition-all",
    ghost:
      "bg-transparent text-gray-500 hover:text-gray-900 border border-transparent hover:border-gray-200 hover:scale-105 transition-all",
    success:
      "bg-green-600 text-white hover:bg-green-700 hover:scale-105 transition-all shadow-lg shadow-green-200",
    dark: "bg-gray-900 text-white hover:bg-gray-800 hover:scale-105 transition-all shadow-lg shadow-gray-200",
  };

  const sizes = {
    sm: "px-3 py-1.5 text-[10px]",
    md: "px-5 py-2.5 text-xs",
    lg: "px-8 py-4 text-sm",
    blocks: "w-full py-4 text-sm",
  };

  return (
    <button
      className={`${baseStyles} ${variants[variant]} ${sizes[size]} ${className}`}
      disabled={isLoading || props.disabled}
      {...props}
    >
      {isLoading ? (
        <>
          <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
          Processing...
        </>
      ) : (
        <>
          {Icon && <Icon size={size === "sm" ? 14 : size === "lg" ? 20 : 18} />}
          {children}
        </>
      )}
    </button>
  );
};



================================================================================
FILE PATH: client\src\components\ui\input.tsx
================================================================================
import React, { forwardRef } from "react";
import { type LucideIcon } from "lucide-react";

interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  icon?: LucideIcon;
  error?: string;
  variant?: "default" | "filled" | "error";
}

export const Input = forwardRef<HTMLInputElement, InputProps>(
  (
    { label, icon: Icon, error, variant = "default", className = "", ...props },
    ref
  ) => {
    // Estilos base do container e do input
    const containerStyles = "flex flex-col gap-1.5 w-full";

    const baseInputStyles =
      "w-full transition-all outline-none rounded-lg border text-sm disabled:opacity-50 disabled:bg-neutral-100";

    const variants = {
      default:
        "border-neutral-200 focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 text-neutral-900 bg-white",
      filled:
        "border-transparent bg-neutral-200 focus:bg-white focus:border-primary-500 text-neutral-900",
      error:
        "border-red-500 focus:ring-4 focus:ring-red-500/10 text-red-900 bg-red-50",
    };

    // Ajuste de padding se houver √≠cone
    const paddingStyles = Icon ? "pl-10 pr-4 py-2.5" : "px-4 py-2.5";

    return (
      <div className={containerStyles}>
        {label && (
          <label className="text-sm font-semibold text-neutral-700 ml-1">
            {label}
          </label>
        )}

        <div className="relative">
          {Icon && (
            <Icon
              className={`absolute left-3 top-1/2 -translate-y-1/2 transition-colors ${
                error ? "text-red-400" : "text-neutral-400"
              }`}
              size={20}
            />
          )}

          <input
            ref={ref}
            className={`${baseInputStyles} ${
              variants[error ? "error" : variant]
            } ${paddingStyles} ${className}`}
            {...props}
          />
        </div>

        {error && (
          <span className="text-xs font-medium text-red-500 ml-1">{error}</span>
        )}
      </div>
    );
  }
);

Input.displayName = "Input";



================================================================================
FILE PATH: client\src\components\ui\Modal.tsx
================================================================================
import React, { useEffect } from 'react';
import { X } from 'lucide-react';

interface ModalProps {
    title: React.ReactNode;
    children: React.ReactNode;
    onClose: () => void;
    className?: string;
    zIndex?: number;
}

export const Modal = ({ title, children, onClose, className = 'max-w-2xl', zIndex = 50 }: ModalProps) => {
    // Close on Escape key
    useEffect(() => {
        const handleEsc = (e: KeyboardEvent) => {
            if (e.key === 'Escape') onClose();
        };
        window.addEventListener('keydown', handleEsc);
        return () => window.removeEventListener('keydown', handleEsc);
    }, [onClose]);

    return (
        <div 
            className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200"
            style={{ zIndex }}
        >
            <div className={`bg-white rounded-xl shadow-2xl w-full max-h-[90vh] flex flex-col animate-in zoom-in-95 duration-200 ${className}`}>
                {/* Header */}
                <div className="flex items-center justify-between p-4 border-b border-neutral-100">
                    <h2 className="text-xl font-bold text-neutral-900">{title}</h2>
                    <button 
                        onClick={onClose}
                        className="p-2 text-neutral-400 hover:text-error hover:bg-error-50 rounded-lg transition-colors"
                    >
                        <X size={20} />
                    </button>
                </div>

                {/* Content */}
                <div className="p-6 overflow-y-auto custom-scrollbar">
                    {children}
                </div>
            </div>
        </div>
    );
};



================================================================================
FILE PATH: client\src\components\ui\StatusBanner.tsx
================================================================================
import { CheckCircle, AlertCircle, X } from 'lucide-react';

interface StatusBannerProps {
    msg: {
        type: 'success' | 'error' | null;
        text: string;
    };
    onClose: () => void;
}

export const StatusBanner = ({ msg, onClose }: StatusBannerProps) => {
    if (!msg.text) return null;
    const isSuccess = msg.type === 'success';
    
    return (
        <div className={`mb-6 p-4 rounded-xl flex items-center justify-between gap-3 animate-in fade-in slide-in-from-top-2 duration-300 font-bold border ${
            isSuccess ? 'bg-success/10 text-success border-success/20' : 'bg-error/10 text-error border-error/20'
        }`}>
            <div className="flex items-center gap-3">
                {isSuccess ? <CheckCircle size={20} className="shrink-0" /> : <AlertCircle size={20} className="shrink-0" />}
                <span className="uppercase text-xs tracking-wider">{msg.text}</span>
            </div>
            <button 
                type="button"
                onClick={onClose} 
                className="opacity-40 hover:opacity-100 transition-opacity p-1"
            >
                <X size={16} />
            </button>
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\CadastroUnificadoPage.tsx
================================================================================
import { useState, useEffect, useRef } from "react";
import { useNavigate, useParams } from "react-router-dom";
import { api } from "../services/api";
import { formatNameTitleCase, normalizePlate } from "../utils/normalize";
import {
  User,
  Car,
  CheckCircle,
  Save,
  ArrowLeft,
  Plus,
  Trash2,
  Edit,
  Search,
  Mail,
  Phone,
  Hash,
  MapPin,
  Building2,
  Calendar,
  Palette,
} from "lucide-react";

import { StatusBanner } from "../components/ui/StatusBanner";
import { Modal } from "../components/ui/Modal";
import { ActionButton } from "../components/ui/ActionButton";
import { VeiculoForm } from "../components/forms/VeiculoForm";
import type { FormEvent } from "react";
// Importando seus componentes customizados
import { Input } from "../components/ui/input";
import { Button } from "../components/ui/Button";

interface IVeiculo {
  id_veiculo: number;
  placa: string;
  marca: string;
  modelo: string;
  cor: string;
  ano_modelo: string;
  id_cliente: number;
}

export const CadastroUnificadoPage = () => {
  const navigate = useNavigate();
  const { clienteId } = useParams();
  const isEditMode = !!clienteId;

  const [loading, setLoading] = useState(false);
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  // Estados do Cliente e Ve√≠culo mantidos...
  const [tipoPessoa, setTipoPessoa] = useState<"PF" | "PJ">("PF");
  const [nome, setNome] = useState("");
  const [cpf, setCpf] = useState("");
  const [razaoSocial, setRazaoSocial] = useState("");
  const [cnpj, setCnpj] = useState("");
  const [ie, setIe] = useState("");
  const [nomeFantasia, setNomeFantasia] = useState("");
  const [telefone, setTelefone] = useState("");
  const [telefone2, setTelefone2] = useState("");
  const [email, setEmail] = useState("");
  const [logradouro, setLogradouro] = useState("");
  const [numero, setNumero] = useState("");
  const [complLogradouro, setComplLogradouro] = useState("");
  const [bairro, setBairro] = useState("");
  const [cidade, setCidade] = useState("S√£o Paulo");
  const [estado, setEstado] = useState("SP");
  const [cep, setCep] = useState("");
  const [placa, setPlaca] = useState("");
  const [marca, setMarca] = useState("");
  const [modelo, setModelo] = useState("");
  const [cor, setCor] = useState("");
  const [anoModelo, setAnoModelo] = useState("");
  const [combustivel, setCombustivel] = useState("Flex");
  const [veiculos, setVeiculos] = useState<IVeiculo[]>([]);
  const [showVehicleModal, setShowVehicleModal] = useState(false);
  const [editingVehicle, setEditingVehicle] = useState<IVeiculo | null>(null);
  const [confirmDeleteVehicle, setConfirmDeleteVehicle] = useState<
    number | null
  >(null);

  const nameRef = useRef<HTMLInputElement>(null);

  // Initial Load (Edit Mode)
  useEffect(() => {
    if (isEditMode) {
      loadClienteData();
    } else {
      if (nameRef.current) nameRef.current.focus();
    }
  }, [clienteId]);

  const loadClienteData = async () => {
    try {
      setLoading(true);
      const response = await api.get(`/cliente/${clienteId}`);
      const data = response.data;

      // Fill Client Data
      setTelefone(data.telefone_1 || "");
      setTelefone2(data.telefone_2 || "");
      setEmail(data.email || "");
      setLogradouro(data.logradouro || "");
      setNumero(data.nr_logradouro || "");
      setComplLogradouro(data.compl_logradouro || "");
      setBairro(data.bairro || "");
      setCidade(data.cidade || "");
      setEstado(data.estado || "");
      setCep(data.cep || "");

      if (data.pessoa_fisica) {
        setTipoPessoa("PF");
        setNome(data.pessoa_fisica.pessoa?.nome || "");
        setCpf(data.pessoa_fisica.cpf || "");
      } else if (data.pessoa_juridica) {
        setTipoPessoa("PJ");
        setRazaoSocial(data.pessoa_juridica.razao_social || "");
        setNomeFantasia(data.pessoa_juridica.nome_fantasia || "");
        setCnpj(data.pessoa_juridica.cnpj || "");
        setIe(data.pessoa_juridica.inscricao_estadual || "");
      }

      // Load Vehicles
      if (data.veiculos) {
        setVeiculos(data.veiculos);
      }
    } catch (error) {
      console.error(error);
      setStatusMsg({
        type: "error",
        text: "Erro ao carregar dados do cliente.",
      });
    } finally {
      setLoading(false);
    }
  };

  const handleCepBlur = async () => {
    const cepRaw = cep.replace(/\D/g, "");
    if (cepRaw.length === 8) {
      try {
        const response = await fetch(
          `https://viacep.com.br/ws/${cepRaw}/json/`,
        );
        const data = await response.json();
        if (!data.erro) {
          setLogradouro(data.logradouro);
          setBairro(data.bairro);
          setCidade(data.localidade);
          setEstado(data.uf);
          // Focus number input after auto-fill
          const numeroInput = document.getElementById("nr_logradouro");
          if (numeroInput) numeroInput.focus();
        }
      } catch (error) {
        console.error("Erro ao buscar CEP", error);
      }
    }
  };

  const handleSave = async (e: FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      // 1. Save/Update Client
      let finalClientId = clienteId ? Number(clienteId) : null;

      if (isEditMode && finalClientId) {
        // UPDATE CLIENT
        const clientePayload = {
          telefone_1: telefone,
          telefone_2: telefone2,
          email,
          logradouro,
          nr_logradouro: numero,
          compl_logradouro: complLogradouro,
          bairro,
          cidade,
          estado,
          cep,
        };
        await api.put(`/cliente/${finalClientId}`, clientePayload);
        setStatusMsg({
          type: "success",
          text: "Dados atualizados com sucesso!",
        });
      } else {
        // CREATE CLIENT (Logic from ClienteForm)
        // A. Base Pessoa
        const pessoaPayload = {
          nome: formatNameTitleCase(tipoPessoa === "PF" ? nome : razaoSocial),
          genero: null,
          dt_nascimento: null,
          obs: "",
        };
        const pessoaRes = await api.post("/pessoa", pessoaPayload);
        const idPessoa = pessoaRes.data.id_pessoa;

        // B. Specific Type
        let fkId = null;
        let fkField = "";
        if (tipoPessoa === "PF") {
          const pfPayload = {
            id_pessoa: idPessoa,
            cpf: cpf ? cpf.replace(/\D/g, "") : null,
          };
          const pfRes = await api.post("/pessoa-fisica", pfPayload);
          fkId = pfRes.data.id_pessoa_fisica;
          fkField = "id_pessoa_fisica";
        } else {
          const pjPayload = {
            id_pessoa: idPessoa,
            razao_social: formatNameTitleCase(razaoSocial),
            nome_fantasia: nomeFantasia
              ? formatNameTitleCase(nomeFantasia)
              : null,
            cnpj: cnpj ? cnpj.replace(/\D/g, "") : null,
            inscricao_estadual: ie,
          };
          const pjRes = await api.post("/pessoa-juridica", pjPayload);
          fkId = pjRes.data.id_pessoa_juridica;
          fkField = "id_pessoa_juridica";
        }

        // C. Create Cliente
        const clientePayload = {
          [fkField]: fkId,
          tipo_pessoa: 1,
          telefone_1: telefone,
          telefone_2: telefone2,
          email,
          logradouro,
          nr_logradouro: numero,
          compl_logradouro: complLogradouro,
          bairro,
          cidade,
          estado,
          cep,
        };
        const clienteRes = await api.post("/cliente", clientePayload);
        finalClientId = clienteRes.data.id_cliente;
      }

      // 2. Create Vehicle (Only in Creation Mode or if filled)
      let finalVehicleId = null;
      if (!isEditMode && finalClientId && (placa || modelo)) {
        const vehiclePayload = {
          id_cliente: finalClientId,
          placa: normalizePlate(placa),
          marca,
          modelo,
          cor,
          ano_modelo: anoModelo,
          combustivel,
          chassi: "", // Optional for quick registry
        };
        const vehicleRes = await api.post("/veiculo", vehiclePayload);
        finalVehicleId = vehicleRes.data.id_veiculo;
      }

      // 3. Redirect Logic
      // "Ap√≥s salvar o novo cadastro, vai direto para o passo 3 para valida√ß√£o"
      // Path: /ordem-de-servico?startWizard=true&clientId=X&vehicleId=Y&step=CONFIRM
      if (!isEditMode && finalClientId) {
        setStatusMsg({
          type: "success",
          text: "Cadastro realizado! Redirecionando...",
        });
        setTimeout(() => {
          let url = `/ordem-de-servico?clientId=${finalClientId}`;
          if (finalVehicleId) {
            url += `&vehicleId=${finalVehicleId}`;
          }
          navigate(url);
        }, 1000);
      }
    } catch (error: any) {
      console.error(error);
      setStatusMsg({
        type: "error",
        text:
          "Erro ao salvar cadastro: " +
          (error.response?.data?.error || error.message),
      });
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteVehicle = async (vId: number) => {
    try {
      await api.delete(`/veiculo/${vId}`);
      setVeiculos((prev) => prev.filter((v) => v.id_veiculo !== vId));
      setConfirmDeleteVehicle(null);
      setStatusMsg({ type: "success", text: "Ve√≠culo removido." });
    } catch (error: any) {
      const errorMessage =
        error.response?.data?.message ||
        error.response?.data?.error ||
        "Erro ao remover ve√≠culo.";
      setStatusMsg({ type: "error", text: errorMessage });
      setConfirmDeleteVehicle(null);
    }
  };

  return (
    <div className="space-y-6 pb-20">
      {statusMsg.text && (
        <div className="fixed bottom-8 right-8 z-50">
          <StatusBanner
            msg={statusMsg}
            onClose={() => setStatusMsg({ type: null, text: "" })}
          />
        </div>
      )}

      {/* Header */}
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="sm" onClick={() => navigate(-1)}>
          <ArrowLeft size={20} />
        </Button>
        <div>
          <h1 className="text-2xl font-bold text-neutral-800">
            {isEditMode ? "Editar Cadastro" : "Novo Cadastro"}
          </h1>
          <p className="text-neutral-500 text-sm">
            {isEditMode
              ? "Atualize os dados do cliente e seus ve√≠culos."
              : "Cadastre o cliente e o ve√≠culo para abrir a OS."}
          </p>
        </div>
      </div>

      <form
        onSubmit={handleSave}
        className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start"
      >
        {/* --- COLUNA ESQUERDA: CLIENTE --- */}
        <div className="space-y-6">
          <div className="bg-neutral-25 p-6 rounded-2xl border border-neutral-200 shadow-sm space-y-6">
            <div className="flex items-center gap-2 border-b border-neutral-100 pb-4">
              <div className="bg-primary-100 p-2 rounded-lg text-primary-600">
                <User size={20} />
              </div>
              <h2 className="font-bold text-lg text-neutral-800">
                Dados do Cliente
              </h2>
            </div>

            {/* Tipo Pessoa Switch */}
            <div className="flex bg-neutral-100 p-1 rounded-lg w-fit">
              <button
                type="button"
                onClick={() => !isEditMode && setTipoPessoa("PF")}
                disabled={isEditMode}
                className={`px-4 py-2 rounded-md text-xs font-bold transition-all ${tipoPessoa === "PF" ? "bg-neutral-25 shadow text-primary-600" : "text-neutral-500"} ${isEditMode ? "opacity-50 cursor-not-allowed" : ""}`}
              >
                Pessoa F√≠sica
              </button>
              <button
                type="button"
                onClick={() => !isEditMode && setTipoPessoa("PJ")}
                disabled={isEditMode}
                className={`px-4 py-2 rounded-md text-xs font-bold transition-all ${tipoPessoa === "PJ" ? "bg-neutral-25 shadow text-accent-600" : "text-neutral-500"} ${isEditMode ? "opacity-50 cursor-not-allowed" : ""}`}
              >
                Pessoa Jur√≠dica
              </button>
            </div>

            <div className="grid grid-cols-1 gap-4">
              {tipoPessoa === "PF" ? (
                <>
                  <Input
                    label="Nome Completo *"
                    icon={User}
                    ref={nameRef}
                    value={nome}
                    onChange={(e) => setNome(e.target.value)}
                    placeholder="Nome do cliente"
                    required
                    disabled={isEditMode}
                  />
                  <Input
                    label="CPF"
                    icon={Hash}
                    value={cpf}
                    onChange={(e) => setCpf(e.target.value)}
                    placeholder="000.000.000-00"
                    disabled={isEditMode}
                  />
                </>
              ) : (
                <>
                  <Input
                    label="Raz√£o Social *"
                    icon={Building2}
                    ref={nameRef}
                    value={razaoSocial}
                    onChange={(e) => setRazaoSocial(e.target.value)}
                    placeholder="Nome da Empresa"
                    required
                    disabled={isEditMode}
                  />
                  <Input
                    label="Nome Fantasia"
                    value={nomeFantasia}
                    onChange={(e) => setNomeFantasia(e.target.value)}
                    placeholder="Nome Comercial"
                    disabled={isEditMode}
                  />
                  <div className="grid grid-cols-2 gap-4">
                    <Input
                      label="CNPJ"
                      value={cnpj}
                      onChange={(e) => setCnpj(e.target.value)}
                      placeholder="00.000.000/0000-00"
                    />
                    <Input
                      label="IE"
                      value={ie}
                      onChange={(e) => setIe(e.target.value)}
                      placeholder="Inscri√ß√£o Estadual"
                    />
                  </div>
                </>
              )}
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4 border-t border-neutral-100">
              <Input
                label="Telefone Principal *"
                icon={Phone}
                value={telefone}
                onChange={(e) => setTelefone(e.target.value)}
                placeholder="(00) 00000-0000"
                required
              />
              <Input
                label="Telefone 2"
                icon={Phone}
                value={telefone2}
                onChange={(e) => setTelefone2(e.target.value)}
                placeholder="(00) 00000-0000"
              />
              <div className="sm:col-span-2">
                <Input
                  label="Email"
                  icon={Mail}
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="cliente@email.com"
                />
              </div>
            </div>

            <div className="space-y-4 pt-4 border-t border-neutral-100">
              <div className="grid grid-cols-3 gap-4">
                <Input
                  label="CEP"
                  icon={Search}
                  value={cep}
                  onChange={(e) => setCep(e.target.value)}
                  onBlur={handleCepBlur}
                  placeholder="00000-000"
                />
                <div className="col-span-2">
                  <Input
                    label="Logradouro"
                    icon={MapPin}
                    value={logradouro}
                    onChange={(e) => setLogradouro(e.target.value)}
                  />
                </div>
                <Input
                  id="nr_logradouro"
                  label="N√∫mero"
                  value={numero}
                  onChange={(e) => setNumero(e.target.value)}
                />
                <div className="col-span-2">
                  <Input
                    label="Complemento"
                    value={complLogradouro}
                    onChange={(e) => setComplLogradouro(e.target.value)}
                  />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <Input
                  label="Bairro"
                  value={bairro}
                  onChange={(e) => setBairro(e.target.value)}
                />
                <Input
                  label="Cidade"
                  value={cidade}
                  onChange={(e) => setCidade(e.target.value)}
                />
              </div>
            </div>
          </div>
        </div>

        {/* --- COLUNA DIREITA: VE√çCULO --- */}
        <div className="space-y-6">
          <div className="bg-neutral-25 p-6 rounded-2xl border border-neutral-200 shadow-sm space-y-6 h-full">
            <div className="flex items-center justify-between border-b border-neutral-100 pb-4">
              <div className="flex items-center gap-2">
                <div className="bg-primary-100 p-2 rounded-lg text-primary-600">
                  <Car size={20} />
                </div>
                <h2 className="font-bold text-lg text-neutral-800">
                  {isEditMode ? "Ve√≠culos Cadastrados" : "Dados do Ve√≠culo"}
                </h2>
              </div>
              {isEditMode && (
                <Button
                  variant="primary"
                  size="sm"
                  icon={Plus}
                  onClick={() => {
                    setEditingVehicle(null);
                    setShowVehicleModal(true);
                  }}
                >
                  NOVO VE√çCULO
                </Button>
              )}
            </div>

            {isEditMode ? (
              <div className="space-y-3">
                {veiculos.length > 0 ? (
                  veiculos.map((v) => (
                    <div
                      key={v.id_veiculo}
                      className="p-4 rounded-xl border border-neutral-200 bg-neutral-50 flex justify-between items-center group hover:border-primary-300 hover:bg-neutral-25 transition-all"
                    >
                      <div>
                        <p className="font-bold text-primary-900 uppercase font-mono">
                          {v.placa}
                        </p>
                        <p className="text-xs font-bold text-neutral-500 uppercase">
                          {v.marca} {v.modelo} ‚Ä¢ {v.cor}
                        </p>
                      </div>
                      <div className="flex gap-1">
                        <ActionButton
                          icon={Edit}
                          label="Editar"
                          variant="neutral"
                          onClick={() => {
                            setEditingVehicle(v);
                            setShowVehicleModal(true);
                          }}
                        />
                        <ActionButton
                          icon={Trash2}
                          label="Excluir"
                          variant="danger"
                          onClick={() => setConfirmDeleteVehicle(v.id_veiculo)}
                        />
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="text-center py-8 text-neutral-400 italic text-sm">
                    Nenhum ve√≠culo cadastrado.
                  </div>
                )}
              </div>
            ) : (
              <div className="space-y-4">
                <div className="p-4 bg-primary-50 rounded-xl border border-primary-100 text-xs text-primary-800 font-medium">
                  Preencha os dados do ve√≠culo agora para agilizar a abertura da
                  OS.
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <Input
                    label="Placa *"
                    icon={Hash}
                    value={placa}
                    onChange={(e) => setPlaca(e.target.value.toUpperCase())}
                    maxLength={7}
                    placeholder="ABC1234"
                    required={!isEditMode}
                    className="font-mono font-bold tracking-widest uppercase"
                  />
                  <Input
                    label="Marca *"
                    icon={Car}
                    value={marca}
                    onChange={(e) => setMarca(e.target.value)}
                    required={!isEditMode && !!placa}
                  />
                  <div className="col-span-2">
                    <Input
                      label="Modelo *"
                      value={modelo}
                      onChange={(e) => setModelo(e.target.value)}
                      required={!isEditMode && !!placa}
                    />
                  </div>
                  <Input
                    label="Cor *"
                    icon={Palette}
                    value={cor}
                    onChange={(e) => setCor(e.target.value)}
                    required={!isEditMode && !!placa}
                  />
                  <Input
                    label="Ano"
                    icon={Calendar}
                    type="number"
                    value={anoModelo}
                    onChange={(e) => setAnoModelo(e.target.value)}
                  />
                  <div className="col-span-2">
                    <label className="text-sm font-semibold text-neutral-700 ml-1 mb-1 block">
                      Combust√≠vel
                    </label>
                    <select
                      value={combustivel}
                      onChange={(e) => setCombustivel(e.target.value)}
                      className="select select-bordered w-full bg-neutral-25 border-neutral-200 focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all rounded-xl"
                    >
                      <option value="Flex">Flex</option>
                      <option value="Gasolina">Gasolina</option>
                      <option value="Etanol">Etanol</option>
                      <option value="Diesel">Diesel</option>
                      <option value="GNV">GNV</option>
                    </select>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Footer Save Button */}
        <div className="col-span-1 lg:col-span-2 flex justify-end pt-4 border-t border-neutral-200">
          <Button
            type="submit"
            variant="primary"
            size="lg"
            isLoading={loading}
            icon={isEditMode ? Save : CheckCircle}
            className="px-12"
          >
            {isEditMode ? "SALVAR ALTERA√á√ïES" : "SALVAR NOVO CADASTRO"}
          </Button>
        </div>
      </form>

      {/* MODAL EDIT VEHICLE (ONLY IN EDIT MODE) */}
      {showVehicleModal && clienteId && (
        <Modal
          title={editingVehicle ? "Editar Ve√≠culo" : "Novo Ve√≠culo"}
          onClose={() => setShowVehicleModal(false)}
        >
          <VeiculoForm
            clientId={Number(clienteId)}
            vehicleId={editingVehicle?.id_veiculo}
            initialData={editingVehicle}
            onSuccess={() => {
              setShowVehicleModal(false);
              loadClienteData(); // Reload to update list
              setStatusMsg({
                type: "success",
                text: "Ve√≠culo salvo com sucesso!",
              });
            }}
            onCancel={() => setShowVehicleModal(false)}
          />
        </Modal>
      )}

      {/* CONFIRM DELETE VEHICLE */}
      {confirmDeleteVehicle && (
        <Modal
          title="Excluir Ve√≠culo"
          onClose={() => setConfirmDeleteVehicle(null)}
        >
          <div className="space-y-4">
            <p>Tem certeza que deseja excluir este ve√≠culo?</p>
            <div className="flex justify-end gap-2">
              <Button
                variant="ghost"
                onClick={() => setConfirmDeleteVehicle(null)}
              >
                Cancelar
              </Button>
              <Button
                variant="danger"
                onClick={() => handleDeleteVehicle(confirmDeleteVehicle)}
              >
                Excluir
              </Button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\ClientePage.tsx
================================================================================
import { useState, useEffect, useRef, Fragment } from "react";
import { useNavigate } from "react-router-dom";
import { api } from "../services/api";
import {
  Search,
  Plus,
  Trash2,
  Edit,
  MapPin,
  Phone,
  Mail,
  User,
  Wrench,
} from "lucide-react";
import { VeiculoForm } from "../components/forms/VeiculoForm";
import { Modal } from "../components/ui/Modal";
import { StatusBanner } from "../components/ui/StatusBanner";
import { Button } from "../components/ui/Button";
import { Input } from "../components/ui/input";
import { ActionButton } from "../components/ui/ActionButton";

// Extended Interface for View (assuming backend returns relations)
interface IClienteView {
  id_cliente: number;
  telefone_1: string;
  telefone_2?: string;
  email?: string;
  logradouro: string;
  nr_logradouro: string;
  compl_logradouro?: string;
  bairro: string;
  cidade: string;
  estado: string;
  id_pessoa_juridica?: number | null;
  pessoa_fisica?: {
    id_pessoa_fisica: number;
    cpf?: string;
    pessoa: {
      nome: string;
    };
  };
  pessoa_juridica?: {
    id_pessoa_juridica: number;
    razao_social: string;
    nome_fantasia?: string;
    cnpj?: string;
  };
  veiculos?: Array<{
    id_veiculo: number;
    placa: string;
    marca: string;
    modelo: string;
    cor: string;
    ano_modelo: string;
    combustivel: string;
    chassi: string;
  }>;
}

export const ClientePage = () => {
  const navigate = useNavigate();
  const [clientes, setClientes] = useState<IClienteView[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");

  const [expandedRows, setExpandedRows] = useState<Set<number>>(new Set());
  const [showVehicleModal, setShowVehicleModal] = useState(false);
  const [selectedClientIdForVehicle, setSelectedClientIdForVehicle] = useState<
    number | null
  >(null);

  // New states for Vehicle CRUD and Confirmation
  const [editingVehicle, setEditingVehicle] = useState<any | null>(null);
  const [confirmModal, setConfirmModal] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    onConfirm: () => void;
  }>({ isOpen: false, title: "", message: "", onConfirm: () => {} });

  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  useEffect(() => {
    loadClientes();
  }, []);

  const loadClientes = async () => {
    try {
      setLoading(true);
      const response = await api.get("/cliente");
      setClientes(response.data);
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: "error", text: "Erro ao carregar clientes." });
    } finally {
      setLoading(false);
    }
  };

  const getNome = (c: IClienteView) => {
    if (c.pessoa_fisica) return c.pessoa_fisica.pessoa.nome;
    if (c.pessoa_juridica) return c.pessoa_juridica.razao_social; // or nome_fantasia
    return "Nome Indispon√≠vel";
  };

  const handleDelete = (id: number) => {
    setConfirmModal({
      isOpen: true,
      title: "Excluir Cliente",
      message:
        "Tem certeza que deseja excluir este cliente? Todos os v√≠nculos ser√£o perdidos.",
      onConfirm: async () => {
        try {
          await api.delete(`/cliente/${id}`);
          setStatusMsg({
            type: "success",
            text: "Cliente removido com sucesso!",
          });
          loadClientes();
        } catch (error) {
          setStatusMsg({ type: "error", text: "Erro ao excluir cliente." });
        }
        setConfirmModal((prev) => ({ ...prev, isOpen: false }));
      },
    });
  };

  const handleDeleteVehicle = (id: number) => {
    setConfirmModal({
      isOpen: true,
      title: "Excluir Ve√≠culo",
      message: "Tem certeza que deseja remover este ve√≠culo do cliente?",
      onConfirm: async () => {
        try {
          await api.delete(`/veiculo/${id}`);
          setStatusMsg({
            type: "success",
            text: "Ve√≠culo removido com sucesso!",
          });
          loadClientes();
        } catch (error) {
          setStatusMsg({ type: "error", text: "Erro ao deletar ve√≠culo." });
        }
        setConfirmModal((prev) => ({ ...prev, isOpen: false }));
      },
    });
  };

  const openCreateModal = () => {
    navigate("/novo-cadastro");
  };

  const openEditModal = (client: IClienteView) => {
    navigate(`/cadastro/${client.id_cliente}`);
  };

  const openEditVehicleModal = (vehicle: any, clientId: number) => {
    setEditingVehicle(vehicle);
    setSelectedClientIdForVehicle(clientId);
    setShowVehicleModal(true);
  };

  const toggleRow = (id: number) => {
    const newExpanded = new Set(expandedRows);
    if (newExpanded.has(id)) newExpanded.delete(id);
    else newExpanded.add(id);
    setExpandedRows(newExpanded);
  };

  const handleRegisterVehicle = (clientId: number) => {
    setSelectedClientIdForVehicle(clientId);
    setEditingVehicle(undefined);
    setShowVehicleModal(true);
  };

  const filteredClientes = clientes.filter((c) => {
    const search = searchTerm.toLowerCase();
    const nome = getNome(c).toLowerCase();
    const email = c.email?.toLowerCase() || "";
    const cidade = (c.cidade || "").toLowerCase();
    const id = c.id_cliente.toString();

    return (
      nome.includes(search) ||
      email.includes(search) ||
      cidade.includes(search) ||
      id.includes(search)
    );
  });

  const [activeIndex, setActiveIndex] = useState(-1);
  const searchInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if (searchInputRef.current) searchInputRef.current.focus();
  }, []);

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (filteredClientes.length === 0) return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      setActiveIndex((prev) =>
        prev + 1 >= filteredClientes.length ? 0 : prev + 1,
      );
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      setActiveIndex((prev) =>
        prev - 1 < 0 ? filteredClientes.length - 1 : prev - 1,
      );
    } else if (e.key === "Enter") {
      if (activeIndex !== -1) {
        e.preventDefault();
        toggleRow(filteredClientes[activeIndex].id_cliente);
      }
    } else if (e.key === "Escape") {
      setSearchTerm("");
      setActiveIndex(-1);
    }
  };

  useEffect(() => {
    setActiveIndex(-1);
  }, [searchTerm]);

  return (
    <div className="w-full mx-auto px-4 md:px-8 py-6 space-y-6">
      {/* Header da P√°gina */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl font-bold text-neutral-500">Clientes</h1>
          <p className="text-neutral-500">
            Gerencie sua base de clientes e contatos.
          </p>
        </div>
        <Button variant="primary" icon={Plus} onClick={openCreateModal}>
          Novo Cliente
        </Button>
      </div>

      {/* Confirm Modal */}
      {confirmModal.isOpen && (
        <Modal
          title={confirmModal.title}
          onClose={() =>
            setConfirmModal((prev) => ({ ...prev, isOpen: false }))
          }
        >
          <div className="space-y-6">
            <p className="text-neutral-600">{confirmModal.message}</p>
            <div className="flex justify-end gap-3">
              <button
                onClick={() =>
                  setConfirmModal((prev) => ({ ...prev, isOpen: false }))
                }
                className="px-4 py-2 text-neutral-600 font-bold hover:bg-neutral-100 rounded-lg transition-colors"
              >
                Cancelar
              </button>
              <button
                onClick={confirmModal.onConfirm}
                className="px-4 py-2 bg-red-600 text-neutral-25 font-bold rounded-lg hover:bg-red-700 transition-colors shadow-lg shadow-red-500/30"
              >
                Confirmar Exclus√£o
              </button>
            </div>
          </div>
        </Modal>
      )}

      {/* Barra de Filtros */}
      <div className="bg-surface p-4 rounded-xl shadow-sm border border-neutral-200 flex gap-4">
        <Input
          variant="default"
          ref={searchInputRef}
          icon={Search}
          placeholder="Buscar por nome, email ou cidade..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          onKeyDown={handleKeyDown}
        />
      </div>

      {/* Tabela */}
      <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden">
        {loading ? (
          <div className="p-8 text-center text-neutral-500">
            Carregando dados...
          </div>
        ) : (
          <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr className="bg-neutral-50 border-b border-neutral-200 text-xs uppercase tracking-wider text-neutral-500 font-semibold">
                  <th className="p-4">Cliente</th>
                  <th className="p-4">Contato</th>
                  <th className="p-4">Localiza√ß√£o</th>
                  <th className="p-4">Tipo</th>
                  <th className="p-4 text-right">A√ß√µes</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-neutral-100">
                {filteredClientes.map((c, idx) => (
                  <Fragment key={c.id_cliente}>
                    <tr
                      className={`transition-colors hover:bg-neutral-25 cursor-pointer ${
                        idx === activeIndex
                          ? "bg-primary-50 ring-2 ring-primary-500 ring-inset"
                          : ""
                      }`}
                    >
                      <td
                        className="p-4 cursor-pointer"
                        onClick={() => toggleRow(c.id_cliente)}
                      >
                        <div className="flex items-center gap-3">
                          <div
                            className={`p-2 rounded-full transition-colors ${
                              expandedRows.has(c.id_cliente)
                                ? "bg-primary-100 text-neutral-25"
                                : "bg-primary-50 text-primary-600"
                            }`}
                          >
                            <User size={16} />
                          </div>
                          <div>
                            <span className="font-bold text-neutral-500 block">
                              {getNome(c)}
                            </span>
                          </div>
                        </div>
                      </td>
                      <td className="p-4">
                        <div className="flex flex-col gap-1">
                          {c.email && (
                            <div className="flex items-center gap-2 text-sm font-bold text-neutral-500">
                              <Phone size={12} /> {c.telefone_1}
                            </div>
                          )}
                          <div className="flex items-center gap-2 text-sm  text-neutral-500">
                            <Mail size={12} /> {c.email}
                          </div>
                        </div>
                      </td>
                      <td className="p-4">
                        <div className="flex items-center gap-2 text-sm text-neutral-500">
                          <MapPin size={14} className="text-neutral-400" />
                          {c.cidade}, {c.estado}
                        </div>
                        <span className="text-xs font-bold text-neutral-400 ml-6">
                          {c.bairro}
                        </span>
                      </td>
                      <td className="p-4">
                        <span
                          className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                          ${
                            c.id_pessoa_juridica
                              ? "bg-accent-50 text-accent-600"
                              : "bg-primary-50 text-primary-600"
                          }`}
                        >
                          {c.id_pessoa_juridica ? "Jur√≠dica" : "F√≠sica"}
                        </span>
                      </td>
                      <td className="p-4">
                        <div className="flex items-center justify-end gap-1">
                          <ActionButton
                            icon={Plus}
                            label="Add Ve√≠culo"
                            variant="primary"
                            onClick={() => handleRegisterVehicle(c.id_cliente)}
                          />
                          <ActionButton
                            icon={Edit}
                            label="Editar"
                            variant="neutral"
                            onClick={() => openEditModal(c)}
                          />
                          <ActionButton
                            icon={Trash2}
                            label="Excluir"
                            variant="danger"
                            onClick={() => handleDelete(c.id_cliente)}
                          />
                        </div>
                      </td>
                    </tr>
                    {expandedRows.has(c.id_cliente) && (
                      <tr className="bg-neutral-50/50 animate-in fade-in slide-in-from-top-1 duration-200">
                        <td colSpan={5} className="p-4 pt-0">
                          <div className="ml-12 border-l-2 border-primary-200 pl-6 py-2 space-y-3">
                            <div className="flex items-center justify-between">
                              <h4 className="text-[10px] font-neutral-900 uppercase text-neutral-400 tracking-widest">
                                Ve√≠culos do Cliente ({c.veiculos?.length || 0})
                              </h4>
                              <button
                                onClick={() =>
                                  handleRegisterVehicle(c.id_cliente)
                                }
                                className="text-[10px] font-bold text-primary-600 hover:underline uppercase"
                              >
                                + Adicionar Ve√≠culo
                              </button>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                              {c.veiculos?.length ? (
                                c.veiculos.map((v) => (
                                  <div
                                    key={v.id_veiculo}
                                    className="bg-neutral-25 p-3 rounded-xl border border-neutral-200 shadow-sm flex items-center justify-between group hover:border-primary-300 transition-all"
                                  >
                                    <div>
                                      <p className="text-xs font-neutral-900 text-neutral-500 tracking-widest uppercase">
                                        {v.placa}
                                      </p>
                                      <p className="text-[10px] text-neutral-500 font-bold uppercase">
                                        {v.marca} {v.modelo} ‚Ä¢ {v.cor}
                                      </p>
                                    </div>
                                    <div className="flex items-center gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                      <button
                                        onClick={() =>
                                          navigate(
                                            `/ordem-de-servico?clientId=${c.id_cliente}&vehicleId=${v.id_veiculo}`,
                                          )
                                        }
                                        className="p-1.5 text-neutral-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg"
                                        title="Abrir OS"
                                      >
                                        <Wrench size={14} />
                                      </button>
                                      <button
                                        onClick={() =>
                                          openEditVehicleModal(v, c.id_cliente)
                                        }
                                        className="p-1.5 text-neutral-400 hover:text-primary-600 hover:bg-primary-50 rounded-lg"
                                        title="Editar Ve√≠culo"
                                      >
                                        <Edit size={14} />
                                      </button>
                                      <button
                                        onClick={() =>
                                          handleDeleteVehicle(v.id_veiculo)
                                        }
                                        className="p-1.5 text-neutral-400 hover:text-red-600 hover:bg-red-50 rounded-lg"
                                        title="Excluir Ve√≠culo"
                                      >
                                        <Trash2 size={14} />
                                      </button>
                                    </div>
                                  </div>
                                ))
                              ) : (
                                <p className="text-xs text-neutral-400 italic">
                                  Nenhum ve√≠culo cadastrado.
                                </p>
                              )}
                            </div>
                          </div>
                        </td>
                      </tr>
                    )}
                  </Fragment>
                ))}
                {filteredClientes.length === 0 && (
                  <tr>
                    <td
                      colSpan={5}
                      className="p-8 text-center text-neutral-400"
                    >
                      Nenhum cliente encontrado.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {showVehicleModal && selectedClientIdForVehicle && (
        <Modal
          title={
            editingVehicle ? "Editar Ve√≠culo" : "Cadastrar Ve√≠culo para Cliente"
          }
          onClose={() => setShowVehicleModal(false)}
        >
          <VeiculoForm
            clientId={selectedClientIdForVehicle}
            vehicleId={editingVehicle?.id_veiculo}
            initialData={editingVehicle}
            onSuccess={() => {
              setShowVehicleModal(false);
              setEditingVehicle(null);
              loadClientes();
            }}
            onCancel={() => {
              setShowVehicleModal(false);
              setEditingVehicle(null);
            }}
          />
        </Modal>
      )}
      <div className="fixed bottom-8 right-8 z-100 min-w-[320px]">
        <StatusBanner
          msg={statusMsg}
          onClose={() => setStatusMsg({ type: null, text: "" })}
        />
      </div>
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\ContasAPagarPage.tsx
================================================================================
import { useState, useEffect } from "react";
import { formatCurrency } from "../utils/formatCurrency";
import { api } from "../services/api";
import { StatusBanner } from "../components/ui/StatusBanner";
import { Modal } from "../components/ui/Modal";
import { ActionButton } from "../components/ui/ActionButton";
import { Button } from "../components/ui/Button";
import { Input } from "../components/ui/input";
import {
  Plus,
  Calendar,
  CheckCircle,
  Search,
  Trash2,
  Edit,
  FileText,
  Upload,
  User,
  Link,
  ArrowDownCircle,
} from "lucide-react";
import type { IContasPagar } from "../types/backend";

export const ContasAPagarPage = () => {
  const [contas, setContas] = useState<IContasPagar[]>([]);
  const [loading, setLoading] = useState(false);
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  // Filters
  const [filterStatus, setFilterStatus] = useState("TODOS"); // TODOS, PENDENTE, PAGO
  const [searchTerm, setSearchTerm] = useState("");
  const [activeFilter, setActiveFilter] = useState<
    "TODAY" | "WEEK" | "MONTH" | "CUSTOM"
  >("WEEK");

  // Date Filters - Default to Current Week
  const [filterStart, setFilterStart] = useState(() => {
    const now = new Date();
    const weekAgo = new Date(now);
    weekAgo.setDate(now.getDate() - 7);
    return weekAgo.toLocaleDateString("en-CA");
  });

  const [filterEnd, setFilterEnd] = useState(() => {
    return new Date().toLocaleDateString("en-CA");
  });

  // Modal & Form
  const [modalOpen, setModalOpen] = useState(false);
  const [editingId, setEditingId] = useState<number | null>(null);
  const [formData, setFormData] = useState({
    descricao: "",
    credor: "",
    categoria: "OUTROS",
    valor: "",
    dt_emissao: "",
    dt_vencimento: "",
    num_documento: "",
    status: "PENDENTE",
    forma_pagamento: "",
    dt_pagamento: "",
    url_anexo: "",
    obs: "",
  });

  // Payment Confirmation Modal
  const [payModalOpen, setPayModalOpen] = useState(false);
  const [selectedConta, setSelectedConta] = useState<any>(null);
  const [paymentDate, setPaymentDate] = useState("");
  const [bankAccounts, setBankAccounts] = useState<any[]>([]);
  const [selectedBank, setSelectedBank] = useState("");

  useEffect(() => {
    loadContas();
    loadAccounts();
  }, []);

  const loadAccounts = async () => {
    try {
      const res = await api.get("/conta-bancaria");
      setBankAccounts(res.data);
    } catch (e) {
      console.error(e);
    }
  };

  const loadContas = async () => {
    try {
      setLoading(true);
      const res = await api.get("/contas-pagar");
      setContas(res.data);
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao carregar contas." });
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const payload = {
        ...formData,
        valor: Number(formData.valor),
        // Enforce NULL payment date if status is not PAGO
        dt_pagamento:
          formData.status === "PAGO"
            ? formData.dt_pagamento
              ? new Date(formData.dt_pagamento).toISOString()
              : new Date().toISOString()
            : null,
        dt_vencimento: new Date(formData.dt_vencimento).toISOString(),
        dt_emissao: formData.dt_emissao
          ? new Date(formData.dt_emissao).toISOString()
          : null,
      };

      if (editingId) {
        await api.put(`/contas-pagar/${editingId}`, payload);
        setStatusMsg({
          type: "success",
          text: "Conta atualizada com sucesso!",
        });
      } else {
        await api.post("/contas-pagar", payload);
        setStatusMsg({ type: "success", text: "Conta lan√ßada com sucesso!" });
      }
      setModalOpen(false);
      resetForm();
      loadContas();
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: "error", text: "Erro ao salvar conta." });
    }
  };

  const handleDelete = async (id: number) => {
    if (!confirm("Tem certeza que deseja excluir esta conta?")) return;
    try {
      await api.delete(`/contas-pagar/${id}`);
      setStatusMsg({ type: "success", text: "Conta exclu√≠da." });
      loadContas();
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao excluir conta." });
    }
  };

  const handleQuickPay = (conta: any) => {
    setSelectedConta(conta);
    setPaymentDate(new Date().toISOString().split("T")[0]); // Default to today
    setSelectedBank(""); // Reset bank selection
    setPayModalOpen(true);
  };

  const executePay = async () => {
    if (!selectedConta) return;
    try {
      await api.put(`/contas-pagar/${selectedConta.id_conta_pagar}`, {
        status: "PAGO",
        dt_pagamento: new Date(paymentDate).toISOString(),
        id_conta_bancaria: selectedBank || null,
      });
      setStatusMsg({ type: "success", text: "Conta marcada como PAGA." });
      loadContas();
      setPayModalOpen(false);
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao atualizar pagamento." });
    }
  };

  const handleEdit = (conta: IContasPagar) => {
    setEditingId(conta.id_conta_pagar);
    setFormData({
      descricao: conta.descricao,
      credor: conta.credor || "",
      categoria: conta.categoria || "OUTROS",
      valor: Number(conta.valor).toFixed(2),
      dt_emissao: conta.dt_emissao
        ? new Date(conta.dt_emissao).toISOString().split("T")[0]
        : "",
      dt_vencimento: new Date(conta.dt_vencimento).toISOString().split("T")[0],
      num_documento: conta.num_documento || "",
      status: conta.status,
      forma_pagamento: conta.forma_pagamento || "",
      dt_pagamento: conta.dt_pagamento
        ? new Date(conta.dt_pagamento).toISOString().split("T")[0]
        : "",
      url_anexo: conta.url_anexo || "",
      obs: conta.obs || "",
    });
    setModalOpen(true);
  };

  const resetForm = () => {
    setEditingId(null);
    setFormData({
      descricao: "",
      credor: "",
      categoria: "OUTROS",
      valor: "",
      dt_emissao: new Date().toISOString().split("T")[0],
      dt_vencimento: new Date().toISOString().split("T")[0],
      num_documento: "",
      status: "PENDENTE",
      forma_pagamento: "",
      dt_pagamento: "",
      url_anexo: "",
      obs: "",
    });
  };

  const openNewModal = () => {
    resetForm();
    setModalOpen(true);
  };

  const applyQuickFilter = (type: "TODAY" | "WEEK" | "MONTH") => {
    setActiveFilter(type);
    const now = new Date();
    const todayStr = now.toLocaleDateString("en-CA"); // Local YYYY-MM-DD

    if (type === "TODAY") {
      setFilterStart(todayStr);
      setFilterEnd(todayStr);
    } else if (type === "WEEK") {
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - 7); // Last 7 days
      setFilterStart(weekStart.toLocaleDateString("en-CA"));
      setFilterEnd(todayStr);
    } else if (type === "MONTH") {
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      setFilterStart(firstDay.toLocaleDateString("en-CA"));
      setFilterEnd(lastDay.toLocaleDateString("en-CA"));
    }
  };

  // Calculations
  const filteredContas = contas.filter((c) => {
    // Date Filter (Vencimento)
    if (filterStart) {
      if (c.dt_vencimento < filterStart) return false;
    }
    if (filterEnd) {
      const vencC = c.dt_vencimento.split("T")[0];
      if (vencC > filterEnd) return false;
    }

    if (filterStatus !== "TODOS" && c.status !== filterStatus) return false;
    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      return (
        c.descricao.toLowerCase().includes(term) ||
        c.categoria?.toLowerCase().includes(term) ||
        c.credor?.toLowerCase().includes(term)
      );
    }
    return true;
  });

  const totalPending = contas
    .filter((c) => c.status === "PENDENTE")
    .reduce((acc, c) => acc + Number(c.valor), 0);
  const totalPaidMonth = contas
    .filter((c) => {
      if (c.status !== "PAGO" || !c.dt_pagamento) return false;
      const d = new Date(c.dt_pagamento);
      const now = new Date();
      return (
        d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()
      );
    })
    .reduce((acc, c) => acc + Number(c.valor), 0);

  const categories = [
    "AGUA",
    "LUZ",
    "ALUGUEL",
    "INTERNET",
    "CONTADOR",
    "SALARIO",
    "MANUTENCAO",
    "OUTROS",
  ];

  return (
    <div className="w-full mx-auto px-4 md:px-8 py-6 space-y-6">
      <StatusBanner
        msg={statusMsg}
        onClose={() => setStatusMsg({ type: null, text: "" })}
      />

      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl font-bold text-neutral-600 tracking-tight">
            Contas a Pagar (Geral)
          </h1>
          <p className="text-neutral-500">
            Ger√™ncia de despesas operacionais da oficina.
          </p>
        </div>
        <Button
          onClick={openNewModal}
          variant="primary"
          icon={Plus}
          className="text-neutral-200"
        >
          Nova Conta
        </Button>
      </div>

      {/* Summary */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div className="bg-red-50 border border-red-100 p-6 rounded-2xl">
          <p className="text-xs font-bold text-red-400 uppercase tracking-widest mb-1">
            Total Pendente
          </p>
          <p className="text-3xl font-bold text-red-600">
            {formatCurrency(totalPending)}
          </p>
        </div>
        <div className="bg-primary-50 border border-success-100 p-6 rounded-2xl">
          <p className="text-xs font-bold text-success-400 uppercase tracking-widest mb-1">
            Pago este M√™s
          </p>
          <p className="text-3xl font-bold text-success-600">
            {formatCurrency(totalPaidMonth)}
          </p>
        </div>
      </div>

      {/* FILTERS */}
      {/* FILTERS & SEARCH */}
      <div className="bg-surface p-4 rounded-xl shadow-sm border border-neutral-200 flex flex-col md:flex-row items-center justify-between gap-4">
        <div className="flex-1 w-full relative">
          <Input
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            placeholder="Buscar por Descri√ß√£o, Credor..."
            icon={Search}
          />
        </div>

        <div className="flex items-center gap-2 overflow-x-auto pb-2 md:pb-0">
          {/* Quick Filters Group */}
          <div className="flex bg-neutral-100 p-1 rounded-xl shrink-0">
            <button
              onClick={() => applyQuickFilter("TODAY")}
              className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                activeFilter === "TODAY"
                  ? "bg-primary-200 text-primary-500 shadow-sm"
                  : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
              }`}
            >
              Hoje
            </button>
            <button
              onClick={() => applyQuickFilter("WEEK")}
              className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                activeFilter === "WEEK"
                  ? "bg-primary-200 text-primary-500 shadow-sm"
                  : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
              }`}
            >
              Semana
            </button>
            <button
              onClick={() => applyQuickFilter("MONTH")}
              className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                activeFilter === "MONTH"
                  ? "bg-primary-200 text-primary-500 shadow-sm"
                  : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
              }`}
            >
              M√™s
            </button>
          </div>

          {/* Manual Date Inputs */}
          <div className="flex gap-2 items-center">
            <input
              type="date"
              value={filterStart}
              onChange={(e) => {
                setFilterStart(e.target.value);
                setActiveFilter("CUSTOM");
              }}
              className={`h-10 px-3 rounded-lg border text-xs font-bold bg-white focus:outline-none focus:ring-2 focus:ring-primary-200 transition-colors ${
                activeFilter === "CUSTOM"
                  ? "border-primary-300 text-primary-700"
                  : "border-neutral-200 text-neutral-600"
              }`}
            />
            <span className="text-neutral-400 self-center">-</span>
            <input
              type="date"
              value={filterEnd}
              onChange={(e) => {
                setFilterEnd(e.target.value);
                setActiveFilter("CUSTOM");
              }}
              className={`h-10 px-3 rounded-lg border text-xs font-bold bg-white focus:outline-none focus:ring-2 focus:ring-primary-200 transition-colors ${
                activeFilter === "CUSTOM"
                  ? "border-primary-300 text-primary-700"
                  : "border-neutral-200 text-neutral-600"
              }`}
            />
          </div>

          {/* Status Type */}
          <div className="flex bg-neutral-100 p-1.5 rounded-xl h-[42px] items-center ml-2">
            {["TODOS", "PENDENTE", "PAGO"].map((s) => {
              let activeClass = "bg-primary-200 text-primary-600 shadow-sm"; // Default/Todos (Blue like Date Filters)
              if (filterStatus === s) {
                if (s === "PENDENTE")
                  activeClass = "bg-red-100 text-red-600 shadow-sm";
                if (s === "PAGO")
                  activeClass = "bg-success-100 text-success-600 shadow-sm";
              }

              return (
                <button
                  key={s}
                  onClick={() => setFilterStatus(s)}
                  className={`px-3 py-1 rounded-lg text-[10px] font-bold uppercase whitespace-nowrap transition-colors ${
                    filterStatus === s
                      ? activeClass
                      : "text-neutral-400 hover:text-neutral-700"
                  }`}
                >
                  {s}
                </button>
              );
            })}
          </div>
        </div>
      </div>

      {/* TABLE */}
      <div className="bg-surface border border-neutral-200 rounded-2xl overflow-hidden shadow-sm">
        <table className="w-full text-left border-collapse">
          <thead className="bg-neutral-50 border-b border-neutral-100">
            <tr>
              <th className="p-4 text-[10px] font-bold text-neutral-500 uppercase tracking-widest">
                Vencimento
              </th>
              <th className="p-4 text-[10px] font-bold text-neutral-500 uppercase tracking-widest">
                Descri√ß√£o
              </th>
              <th className="p-4 text-[10px] font-bold text-neutral-500 uppercase tracking-widest">
                Credor / Docs
              </th>
              <th className="p-4 text-[10px] font-bold text-neutral-500 uppercase tracking-widest text-right">
                Valor
              </th>
              <th className="p-4 text-[10px] font-bold text-neutral-500 uppercase tracking-widest text-center">
                Status
              </th>
              <th className="p-4 text-[10px] font-bold text-neutral-500 uppercase tracking-widest text-right">
                A√ß√µes
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-neutral-50">
            {loading ? (
              <tr>
                <td colSpan={6} className="p-8 text-center text-neutral-400">
                  Carregando...
                </td>
              </tr>
            ) : filteredContas.length === 0 ? (
              <tr>
                <td
                  colSpan={6}
                  className="p-8 text-center text-neutral-400 italic"
                >
                  Nenhuma conta encontrada.
                </td>
              </tr>
            ) : (
              filteredContas.map((conta) => (
                <tr
                  key={conta.id_conta_pagar}
                  className="hover:bg-neutral-25 group"
                >
                  <td className="p-4">
                    <div className="font-bold text-neutral-700 text-sm flex items-center gap-2">
                      <Calendar size={14} className="text-neutral-400" />
                      {/* Fix Timezone Display: Use UTC to calculate date */}
                      {new Date(conta.dt_vencimento)
                        .getUTCDate()
                        .toString()
                        .padStart(2, "0")}
                      /
                      {(new Date(conta.dt_vencimento).getUTCMonth() + 1)
                        .toString()
                        .padStart(2, "0")}
                      /{new Date(conta.dt_vencimento).getUTCFullYear()}
                    </div>
                    {conta.dt_pagamento && conta.status === "PAGO" && (
                      <div className="text-[10px] text-success-600 font-bold mt-1">
                        Pago em{" "}
                        {new Date(conta.dt_pagamento)
                          .getUTCDate()
                          .toString()
                          .padStart(2, "0")}
                        /
                        {(new Date(conta.dt_pagamento).getUTCMonth() + 1)
                          .toString()
                          .padStart(2, "0")}
                      </div>
                    )}
                  </td>
                  <td className="p-4">
                    <div className="font-bold text-neutral-900">
                      {conta.descricao}
                    </div>
                    <div className="text-[10px] font-bold text-neutral-400 uppercase bg-neutral-100 px-2 py-0.5 rounded w-fit mt-1">
                      {conta.categoria}
                    </div>
                    {conta.obs && (
                      <div className="text-[10px] text-neutral-500 mt-1 italic max-w-[200px] truncate">
                        {conta.obs}
                      </div>
                    )}
                  </td>
                  <td className="p-4">
                    {conta.credor && (
                      <div className="flex items-center gap-1.5 text-xs font-bold text-neutral-700 mb-1">
                        <User size={12} className="text-neutral-400" />{" "}
                        {conta.credor}
                      </div>
                    )}
                    {conta.num_documento && (
                      <div className="flex items-center gap-1.5 text-[10px] text-neutral-500 font-bold">
                        <FileText size={12} className="text-neutral-400" /> Doc:{" "}
                        {conta.num_documento}
                      </div>
                    )}
                    {conta.url_anexo && (
                      <a
                        href={conta.url_anexo}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center gap-1.5 text-[10px] text-blue-500 font-bold hover:underline mt-1"
                      >
                        <Link size={12} /> Ver Anexo
                      </a>
                    )}
                  </td>
                  <td className="p-4 text-right font-bold text-neutral-600">
                    {formatCurrency(Number(conta.valor))}
                  </td>
                  <td className="p-4 text-center">
                    <span
                      className={`px-2 py-1 rounded-md text-[10px] font-bold uppercase ${
                        conta.status === "PAGO"
                          ? "bg-success-100 text-success-700"
                          : // Check overdue
                            new Date(conta.dt_vencimento) < new Date() &&
                              conta.status !== "PAGO"
                            ? "bg-red-100 text-red-600"
                            : "bg-warning-100 text-warning-700"
                      }`}
                    >
                      {conta.status === "PAGO"
                        ? "PAGO"
                        : new Date(conta.dt_vencimento) < new Date() &&
                            conta.status !== "PAGO"
                          ? "ATRASADO"
                          : "PENDENTE"}
                    </span>
                  </td>
                  <td className="p-4 text-right">
                    <div className="flex justify-end gap-2 transition-opacity">
                      {conta.status !== "PAGO" && (
                        <ActionButton
                          onClick={() => handleQuickPay(conta)}
                          icon={CheckCircle}
                          label="Marcar como Pago"
                          variant="primary" // Changed from bg-success-50 text-success-600 to component variant
                        />
                      )}
                      <ActionButton
                        onClick={() => handleEdit(conta)}
                        icon={Edit}
                        label="Editar"
                        variant="accent"
                      />
                      <ActionButton
                        onClick={() => handleDelete(conta.id_conta_pagar)}
                        icon={Trash2}
                        label="Excluir"
                        variant="danger"
                      />
                    </div>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      {/* MODAL */}
      {modalOpen && (
        <Modal
          title={editingId ? "Editar Conta" : "Nova Conta a Pagar"}
          onClose={() => setModalOpen(false)}
          className="max-w-2xl"
        >
          <form onSubmit={handleSave} className="space-y-6 pt-4">
            {/* 1. Descri√ß√£o & Credor */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Input
                label="Descri√ß√£o / T√≠tulo"
                required
                value={formData.descricao}
                onChange={(e) =>
                  setFormData({ ...formData, descricao: e.target.value })
                }
                placeholder="Ex: Compra Material Limpeza"
                className="font-bold text-neutral-600"
              />
              <Input
                label="Credor"
                value={formData.credor}
                onChange={(e) =>
                  setFormData({ ...formData, credor: e.target.value })
                }
                placeholder="Ex: Fornecedor X"
                className="font-bold text-neutral-600"
              />
            </div>

            {/* 2. Categoria & Valor */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                  Categoria
                </label>
                <select
                  className="w-full px-4 py-2.5 rounded-lg border border-neutral-200 focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 text-neutral-600 font-bold text-sm h-[42px] outline-none bg-white transition-all"
                  value={formData.categoria}
                  onChange={(e) =>
                    setFormData({ ...formData, categoria: e.target.value })
                  }
                >
                  {categories.map((c) => (
                    <option key={c} value={c}>
                      {c}
                    </option>
                  ))}
                </select>
              </div>
              <Input
                label="Valor do T√≠tulo (R$)"
                type="number"
                step="0.01"
                required
                value={formData.valor}
                onChange={(e) =>
                  setFormData({ ...formData, valor: e.target.value })
                }
                placeholder="0.00"
                className="font-bold text-neutral-600"
              />
            </div>

            {/* 3. Datas */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Input
                label="Data de Emiss√£o"
                type="date"
                value={formData.dt_emissao}
                onChange={(e) =>
                  setFormData({ ...formData, dt_emissao: e.target.value })
                }
                className="font-bold text-neutral-600"
              />
              <Input
                label="Data de Vencimento"
                type="date"
                required
                value={formData.dt_vencimento}
                onChange={(e) =>
                  setFormData({ ...formData, dt_vencimento: e.target.value })
                }
                className="font-bold text-neutral-600"
              />
            </div>

            {/* 4. Documento & Status */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Input
                label="N√∫mero do Documento"
                value={formData.num_documento}
                onChange={(e) =>
                  setFormData({ ...formData, num_documento: e.target.value })
                }
                placeholder="Nota Fiscal / Boleto"
                className="font-bold text-neutral-600"
              />
              <div>
                <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                  Status
                </label>
                <select
                  className="w-full px-4 py-2.5 rounded-lg border border-neutral-200 focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 text-neutral-600 font-bold text-sm h-[42px] outline-none bg-white transition-all"
                  value={formData.status}
                  onChange={(e) =>
                    setFormData({ ...formData, status: e.target.value })
                  }
                >
                  <option value="PENDENTE">Pendente</option>
                  <option value="PAGO">Pago</option>
                </select>
              </div>
            </div>

            {/* 5. Forma Pagto & Anexos */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                  Forma de Pagamento Prevista
                </label>
                <select
                  className="w-full px-4 py-2.5 rounded-lg border border-neutral-200 focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 text-neutral-600 font-bold text-sm h-[42px] outline-none bg-white transition-all"
                  value={formData.forma_pagamento}
                  onChange={(e) =>
                    setFormData({
                      ...formData,
                      forma_pagamento: e.target.value,
                    })
                  }
                >
                  <option value="">Selecione...</option>
                  <option value="BOLETO">Boleto</option>
                  <option value="PIX">Pix</option>
                  <option value="DINHEIRO">Dinheiro</option>
                  <option value="TRANSFERENCIA">Transfer√™ncia</option>
                  <option value="CARTAO">Cart√£o</option>
                </select>
              </div>
              <Input
                label="Arquivos / Anexos (URL)"
                icon={Upload}
                value={formData.url_anexo}
                onChange={(e) =>
                  setFormData({ ...formData, url_anexo: e.target.value })
                }
                placeholder="http://..."
                className="font-bold text-neutral-600"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                Observa√ß√µes
              </label>
              <textarea
                className="w-full px-4 py-3 rounded-lg border border-neutral-200 focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 text-neutral-600 font-medium text-sm h-20 resize-none outline-none bg-white transition-all"
                value={formData.obs}
                onChange={(e) =>
                  setFormData({ ...formData, obs: e.target.value })
                }
                placeholder="Observa√ß√µes adicionais..."
              />
            </div>

            <Button
              variant="primary"
              size="blocks"
              icon={CheckCircle}
              className="text-neutral-200"
            >
              Salvar Conta
            </Button>
          </form>
        </Modal>
      )}

      {/* PAYMENT DATE MODAL */}
      {payModalOpen && selectedConta && (
        <Modal
          title="Confirmar Pagamento"
          onClose={() => setPayModalOpen(false)}
          className="max-w-md"
        >
          <div className="space-y-4 pt-2">
            <div>
              <p className="text-sm text-neutral-600 mb-4">
                Confirmar pagamento de{" "}
                <span className="font-bold">{selectedConta.descricao}</span>?
              </p>
              <Input
                label="Data do Pagamento"
                type="date"
                required
                value={paymentDate}
                onChange={(e) => setPaymentDate(e.target.value)}
                className="font-bold text-neutral-600"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                Conta Banc√°ria (Opcional)
              </label>
              <div className="relative">
                <select
                  value={selectedBank}
                  onChange={(e) => setSelectedBank(e.target.value)}
                  className="w-full h-[42px] bg-neutral-50 border border-neutral-200 px-3 rounded-lg font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all appearance-none cursor-pointer text-neutral-600"
                >
                  <option value="">Sem v√≠nculo (Apenas Caixa)</option>
                  {bankAccounts.map((acc: any) => (
                    <option key={acc.id_conta} value={acc.id_conta}>
                      {acc.nome} ({acc.banco})
                    </option>
                  ))}
                </select>
                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-neutral-500">
                  <ArrowDownCircle size={14} />
                </div>
              </div>
            </div>

            <div className="flex justify-end gap-2 pt-2">
              <Button variant="ghost" onClick={() => setPayModalOpen(false)}>
                Cancelar
              </Button>
              <Button variant="primary" onClick={executePay}>
                Confirmar
              </Button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\DaschboardPage.tsx
================================================================================
import { useEffect, useState } from "react";
import {
  Plus,
  Wrench,
  CreditCard,
  Wallet,
  Package,
  CheckCircle,
} from "lucide-react";
import { api } from "../services/api";
import { useNavigate } from "react-router-dom";
import { Button } from "../components/ui/Button";

// Updated StatCard to match "Summary Card" style from MovimentacoesTab
const StatCard = ({
  title,
  value,
  color,
  icon: Icon,
  onClick,
  subtext,
}: any) => (
  <div
    onClick={onClick}
    className="bg-white p-6 rounded-xl shadow-sm border border-neutral-200 cursor-pointer hover:shadow-md hover:-translate-y-1 transition-all duration-300 group"
  >
    <div className="flex flex-col justify-between h-full">
      <div className="flex items-center gap-3 mb-2">
        <div className={`p-2 rounded-lg ${color.bg} ${color.text}`}>
          <Icon size={20} />
        </div>
        <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest">
          {title}
        </p>
      </div>

      <div className="mt-2">
        <h3
          className={`text-3xl font-bold ${color.textValue || "text-neutral-900"}`}
        >
          {value}
        </h3>
        {subtext && (
          <p className="text-[10px] text-neutral-400 font-bold uppercase mt-1">
            {subtext}
          </p>
        )}
      </div>
    </div>
  </div>
);

export function DaschboardPage() {
  const navigate = useNavigate();
  const [recentOss, setRecentOss] = useState<any[]>([]);
  const [filterPeriod, setFilterPeriod] = useState<
    "HOJE" | "SEMANA" | "MES" | "STATUS"
  >("HOJE");

  const [stats, setStats] = useState({
    osAberta: 0,
    contasPagar: 0,
    livroCaixaEntries: 0,
    livroCaixaExits: 0,
    autoPecasPendentes: 0,
    consolidacao: 0,
  });

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    try {
      const [osRes, contasRes, pagPecaRes, pagCliRes] = await Promise.all([
        api.get("/ordem-de-servico"),
        api.get("/contas-pagar"),
        api.get("/pagamento-peca"),
        api.get("/pagamento-cliente"),
      ]);

      const oss = osRes.data;
      const contas = contasRes.data;
      const pagPecas = pagPecaRes.data;
      const pagClients = pagCliRes.data;

      // 1. Servi√ßos em Aberto
      const osAberta = oss.filter(
        (o: any) => o.status === "ABERTA" || o.status === "EM_ANDAMENTO",
      ).length;

      // 2. Contas a Pagar (Geral) -> Status PENDENTE
      const contasPagar = contas.filter(
        (c: any) => c.status === "PENDENTE",
      ).length;

      const isToday = (dateStr: string) => {
        if (!dateStr) return false;
        const date = new Date(dateStr);
        const localDateStr = date.toLocaleDateString("en-CA");
        const todayStr = new Date().toLocaleDateString("en-CA");
        return localDateStr === todayStr;
      };

      const todayEntries = pagClients.filter(
        (p: any) => isToday(p.data_pagamento) && !p.deleted_at,
      ).length;

      const todayExits = pagPecas.filter((p: any) => {
        if (!p.pago_ao_fornecedor) return false;
        if (!p.data_pagamento_fornecedor) return false;
        return isToday(p.data_pagamento_fornecedor) && !p.deleted_at;
      }).length;

      const autoPecasPendentes = pagPecas.filter(
        (p: any) => !p.pago_ao_fornecedor && !p.deleted_at,
      ).length;

      const consolidacao = oss.filter(
        (o: any) =>
          o.status === "PRONTO PARA FINANCEIRO" && !o.fechamento_financeiro,
      ).length;

      setStats({
        osAberta,
        contasPagar,
        livroCaixaEntries: todayEntries,
        livroCaixaExits: todayExits,
        autoPecasPendentes,
        consolidacao,
      });

      setRecentOss(oss);
    } catch (error) {
      console.error("Erro ao carregar dados", error);
    }
  };

  const getFilteredRecentServices = () => {
    const now = new Date();
    const startOfToday = new Date(
      now.getFullYear(),
      now.getMonth(),
      now.getDate(),
    );

    let filtered = recentOss;

    if (filterPeriod !== "STATUS") {
      filtered = recentOss.filter((os) => {
        const dateRef = os.updated_at
          ? new Date(os.updated_at)
          : new Date(os.dt_abertura);
        if (filterPeriod === "HOJE") {
          if (os.status === "ABERTA") return true;
          return dateRef >= startOfToday;
        } else if (filterPeriod === "SEMANA") {
          const weekAgo = new Date(startOfToday);
          weekAgo.setDate(startOfToday.getDate() - 7);
          if (os.status === "ABERTA") return true;
          return dateRef >= weekAgo;
        } else {
          // MES
          const firstDayMonth = new Date(now.getFullYear(), now.getMonth(), 1);
          if (os.status === "ABERTA") return true;
          return dateRef >= firstDayMonth;
        }
      });
    }

    return filtered.sort((a, b) => {
      if (filterPeriod === "STATUS") {
        const priority: Record<string, number> = {
          ABERTA: 1,
          EM_ANDAMENTO: 1,
          "PRONTO PARA FINANCEIRO": 2,
          finalizada: 3,
          FINALIZADA: 3,
          PAGA_CLIENTE: 4,
        };
        const pA = priority[a.status] || 99;
        const pB = priority[b.status] || 99;
        if (pA !== pB) return pA - pB;
      }
      const dateA = a.updated_at
        ? new Date(a.updated_at).getTime()
        : new Date(a.dt_abertura).getTime();
      const dateB = b.updated_at
        ? new Date(b.updated_at).getTime()
        : new Date(b.dt_abertura).getTime();
      return dateB - dateA;
    });
  };

  const getStatusStyle = (status: string) => {
    switch (status) {
      case "FINALIZADA":
        return "bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200";
      case "PAGA_CLIENTE":
        return "bg-neutral-100 text-neutral-600 ring-1 ring-neutral-200";
      case "PRONTO PARA FINANCEIRO":
        return "bg-amber-100 text-amber-700 ring-1 ring-amber-200";
      case "ABERTA":
        return "bg-blue-100 text-blue-700 ring-1 ring-blue-200";
      case "EM_ANDAMENTO":
        return "bg-cyan-100 text-cyan-700 ring-1 ring-cyan-200";
      default:
        return "bg-gray-50 text-gray-500 ring-1 ring-gray-200";
    }
  };

  const filteredServices = getFilteredRecentServices();

  const getFilterButtonClass = (isActive: boolean) =>
    `px-4 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all ${
      isActive
        ? "bg-primary-200 text-primary-500 shadow-sm"
        : "text-neutral-500 hover:text-neutral-700 hover:bg-white"
    }`;

  return (
    <div className="w-full mx-auto px-4 md:px-8 py-6 space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-bold text-neutral-600 tracking-tight">
            Vis√£o Geral
          </h1>
          <p className="text-neutral-500">Acompanhamento di√°rio da oficina.</p>
        </div>
        <span className="text-sm font-bold text-neutral-400 bg-neutral-100 px-3 py-1 rounded-lg uppercase">
          {new Date().toLocaleDateString("pt-BR", {
            weekday: "long",
            day: "numeric",
            month: "long",
          })}
        </span>
      </div>

      {/* Stats Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <StatCard
          title="Servi√ßos Abertos"
          value={stats.osAberta}
          color={{
            bg: "bg-blue-50",
            text: "text-blue-600",
            textValue: "text-blue-600",
          }}
          icon={Wrench}
          onClick={() => navigate("/ordem-de-servico")}
          subtext="Em produ√ß√£o"
        />
        <StatCard
          title="Contas a Pagar"
          value={stats.contasPagar}
          color={{
            bg: "bg-red-50",
            text: "text-red-600",
            textValue: "text-red-600",
          }}
          icon={CreditCard}
          onClick={() => navigate("/financeiro/contas-pagar")}
          subtext="Geral / Fixas"
        />
        <StatCard
          title="Mov. de Caixa"
          value={stats.livroCaixaEntries + stats.livroCaixaExits}
          color={{
            bg: "bg-neutral-100",
            text: "text-neutral-600",
            textValue: "text-neutral-800",
          }}
          icon={Wallet}
          onClick={() => navigate("/financeiro/livro-caixa")}
          subtext={`Ent: ${stats.livroCaixaEntries} | Sai: ${stats.livroCaixaExits}`}
        />
        <StatCard
          title="Auto Pe√ßas"
          value={stats.autoPecasPendentes}
          color={{
            bg: "bg-orange-50",
            text: "text-orange-600",
            textValue: "text-orange-600",
          }}
          icon={Package}
          onClick={() => navigate("/financeiro/pagamento-pecas")}
          subtext="Pendentes Pagto"
        />
        <StatCard
          title="Consolida√ß√£o"
          value={stats.consolidacao}
          color={{
            bg: "bg-emerald-50",
            text: "text-emerald-600",
            textValue: "text-emerald-600",
          }}
          icon={CheckCircle}
          onClick={() => navigate("/fechamento-financeiro")}
          subtext="Aguardando Financ."
        />
      </div>

      {/* Shortcuts */}
      <div className="flex items-center gap-4">
        <Button
          onClick={() => navigate("/ordem-de-servico?new=true")}
          variant="primary"
          size="lg"
          icon={Plus}
          className="shadow-lg shadow-primary-500/20"
        >
          Nova Ordem de Servi√ßo
        </Button>
      </div>

      {/* Recent Services - FULL WIDTH */}
      <div className="bg-white rounded-2xl shadow-sm border border-neutral-100 overflow-hidden">
        <div className="p-6 border-b border-neutral-100 flex flex-col sm:flex-row justify-between items-center gap-4">
          <h2 className="text-lg font-bold text-neutral-900 tracking-tight">
            Ordens de Servi√ßos Recentes
          </h2>

          {/* Date Tabs */}
          <div className="flex bg-neutral-100 p-1 rounded-xl">
            {["HOJE", "SEMANA", "MES", "STATUS"].map((p) => (
              <button
                key={p}
                onClick={() => setFilterPeriod(p as any)}
                className={getFilterButtonClass(filterPeriod === p)}
              >
                {p === "MES" ? "M√™s" : p}
              </button>
            ))}
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-left">
            <thead className="bg-neutral-50 border-b border-neutral-100">
              <tr>
                <th className="p-4 text-[10px] font-bold uppercase text-neutral-400 tracking-widest">
                  OS / Data
                </th>
                <th className="p-4 text-[10px] font-bold uppercase text-neutral-400 tracking-widest">
                  Ve√≠culo
                </th>
                <th className="p-4 text-[10px] font-bold uppercase text-neutral-400 tracking-widest">
                  Diagn√≥stico
                </th>
                <th className="p-4 text-[10px] font-bold uppercase text-neutral-400 tracking-widest">
                  Colaborador
                </th>
                <th className="p-4 text-[10px] font-bold uppercase text-neutral-400 tracking-widest">
                  Cliente
                </th>
                <th className="p-4 text-[10px] font-bold uppercase text-neutral-400 tracking-widest text-center">
                  Status
                </th>
                <th className="p-4 text-[10px] font-bold uppercase text-neutral-400 tracking-widest text-right">
                  A√ß√µes
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-neutral-50">
              {filteredServices.length === 0 ? (
                <tr>
                  <td
                    colSpan={7}
                    className="p-12 text-center text-neutral-400 font-medium italic"
                  >
                    Nenhuma atualiza√ß√£o neste per√≠odo.
                  </td>
                </tr>
              ) : (
                filteredServices.map((os: any) => (
                  <tr
                    key={os.id_os}
                    onClick={() =>
                      navigate(
                        os.status === "PRONTO PARA FINANCEIRO"
                          ? `/fechamento-financeiro?id_os=${os.id_os}`
                          : `/ordem-de-servico?id=${os.id_os}`,
                      )
                    }
                    className="hover:bg-neutral-50 cursor-pointer transition-colors group"
                  >
                    <td className="p-4">
                      <div className="font-bold text-neutral-800">
                        #{os.id_os}
                      </div>
                      <div className="text-[10px] text-neutral-400 font-bold">
                        {new Date(os.dt_abertura).toLocaleDateString()}
                      </div>
                    </td>
                    <td className="p-4">
                      <div className="flex flex-col">
                        <span className="font-bold text-neutral-700 uppercase text-xs">
                          {os.veiculo?.modelo || "Modelo N/I"}{" "}
                          {os.veiculo?.cor ? os.veiculo.cor : ""}
                        </span>
                        <span className="text-[10px] font-bold text-neutral-400 uppercase">
                          {os.veiculo?.placa || "---"}
                        </span>
                      </div>
                    </td>
                    <td className="p-4 max-w-[250px]">
                      <p className="text-xs font-medium text-neutral-600 line-clamp-1">
                        {os.diagnostico || os.defeito_relatado || (
                          <span className="text-neutral-300 italic">---</span>
                        )}
                      </p>
                    </td>
                    <td className="p-4">
                      <p className="text-[10px] font-bold text-neutral-600 uppercase">
                        {(() => {
                          const mechanics = os.servicos_mao_de_obra
                            ?.map(
                              (s: any) =>
                                s.funcionario?.pessoa_fisica?.pessoa?.nome?.split(
                                  " ",
                                )[0],
                            )
                            .filter(Boolean);
                          const uniqueMechanics = [...new Set(mechanics || [])];
                          if (uniqueMechanics.length > 0)
                            return uniqueMechanics.join(", ");
                          return <span className="text-neutral-300">---</span>;
                        })()}
                      </p>
                    </td>
                    <td className="p-4">
                      <div className="font-bold text-neutral-700 text-xs truncate max-w-[150px]">
                        {os.cliente?.pessoa_fisica?.pessoa?.nome ||
                          os.cliente?.pessoa_juridica?.razao_social}
                      </div>
                      <div className="text-[10px] text-neutral-400 font-medium">
                        {os.cliente?.telefone_1 || ""}
                      </div>
                    </td>
                    <td className="p-4 text-center">
                      <span
                        className={`px-3 py-1 rounded-md text-[10px] font-bold uppercase whitespace-nowrap ${getStatusStyle(os.status)}`}
                      >
                        {os.status === "PRONTO PARA FINANCEIRO"
                          ? "FINANCEIRO"
                          : os.status.replace(/_/g, " ")}
                      </span>
                    </td>
                    <td className="p-4 text-right">
                      <Button
                        onClick={(e) => {
                          e.stopPropagation(); // Prevent row click
                          navigate(`/ordem-de-servico?id=${os.id_os}`);
                        }}
                        variant="secondary"
                        size="sm"
                      >
                        Gerenciar
                      </Button>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}



================================================================================
FILE PATH: client\src\pages\EntradaEstoquePage.tsx
================================================================================
import { useState, useEffect } from "react";
import { formatCurrency } from "../utils/formatCurrency";
import { api } from "../services/api";
import { StatusBanner } from "../components/ui/StatusBanner";
import { Button } from "../components/ui/Button";
import { Modal } from "../components/ui/Modal";
import { Input } from "../components/ui/input";
import { FornecedorForm } from "../components/forms/FornecedorForm";
import { Plus, Search, Trash2, Save, ShoppingCart, Edit } from "lucide-react";

export const EntradaEstoquePage = () => {
  // Header State
  const [suppliers, setSuppliers] = useState<any[]>([]);
  const [selectedSupplierId, setSelectedSupplierId] = useState("");
  const [invoice, setInvoice] = useState("");
  const [date, setDate] = useState(new Date().toISOString().split("T")[0]);
  const [obs, setObs] = useState("");
  const [showNewSupplierModal, setShowNewSupplierModal] = useState(false);

  // Items Logic
  const [items, setItems] = useState<any[]>([]);

  // New Item Input State
  const [partSearch, setPartSearch] = useState("");
  const [partResults, setPartResults] = useState<any[]>([]);
  const [selectedStockPart, setSelectedStockPart] = useState<any | null>(null);
  const [isNewPart, setIsNewPart] = useState(false);

  // Row Inputs
  const [rowQtd, setRowQtd] = useState("");
  const [rowCost, setRowCost] = useState("");
  const [rowMargin, setRowMargin] = useState("");
  const [rowSale, setRowSale] = useState("");
  const [rowRef, setRowRef] = useState("");
  const [rowObs, setRowObs] = useState("");

  // New Part Fields (if isNewPart)
  const [newPartName, setNewPartName] = useState("");
  const [newPartDesc, setNewPartDesc] = useState("");
  const [newPartFab, setNewPartFab] = useState("");
  const [newPartUnit, setNewPartUnit] = useState("UN");

  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  // Load Suppliers
  useEffect(() => {
    api
      .get("/fornecedor")
      .then((res) => setSuppliers(res.data))
      .catch(console.error);
  }, []);

  // Price Calc Effect
  useEffect(() => {
    if (rowCost && rowMargin) {
      const cost = Number(rowCost);
      const margin = Number(rowMargin);
      const sale = cost + cost * (margin / 100);
      setRowSale(sale.toFixed(2));
    }
  }, [rowCost, rowMargin]);

  useEffect(() => {
    if (rowCost && rowSale && !rowMargin) {
      const cost = Number(rowCost);
      const sale = Number(rowSale);
      if (cost > 0) {
        const margin = ((sale - cost) / cost) * 100;
        setRowMargin(margin.toFixed(2));
      }
    }
  }, [rowSale, rowCost]);

  const handleRecalcMargin = (saleVal: string) => {
    setRowSale(saleVal);
    const cost = Number(rowCost);
    const sale = Number(saleVal);
    if (cost > 0 && sale > 0) {
      const m = ((sale - cost) / cost) * 100;
      setRowMargin(m.toFixed(2));
    }
  };

  const handleSearchPart = async (q: string) => {
    setPartSearch(q);
    if (q.length < 2) {
      setPartResults([]);
      return;
    }
    try {
      const res = await api.get(`/pecas-estoque/search?q=${q}`);
      setPartResults(res.data);
    } catch (e) {
      console.error(e);
    }
  };

  const selectPart = (p: any) => {
    setSelectedStockPart(p);
    setPartSearch(p.nome);
    setPartResults([]);
    setIsNewPart(false);

    setRowSale(Number(p.valor_venda || 0).toFixed(2));
    setRowCost(Number(p.valor_custo || 0).toFixed(2)); // Suggest last cost
  };

  const handleAddItem = () => {
    if (!selectedStockPart && !isNewPart) return;
    if (!rowQtd || !rowCost || !rowSale) {
      setStatusMsg({
        type: "error",
        text: "Preencha quantidade, custo e venda.",
      });
      return;
    }

    const newItem = {
      tempId: Date.now(),
      id_pecas_estoque: selectedStockPart
        ? selectedStockPart.id_pecas_estoque
        : null,
      new_part_data: isNewPart
        ? {
            nome: newPartName || partSearch,
            descricao: newPartDesc || newPartName || partSearch,
            fabricante: newPartFab,
            unidade_medida: newPartUnit,
          }
        : null,
      displayName: isNewPart
        ? newPartName || partSearch
        : selectedStockPart.nome,
      quantidade: Number(rowQtd),
      valor_custo: Number(rowCost),
      margem_lucro: Number(rowMargin),
      valor_venda: Number(rowSale),
      ref_cod: rowRef,
      obs: rowObs,
    };

    setItems([...items, newItem]);

    // Reset Inputs
    setRowQtd("");
    setRowCost("");
    setRowMargin("");
    setRowSale("");
    setRowRef("");
    setRowObs("");
    setSelectedStockPart(null);
    setPartSearch("");
    setIsNewPart(false);
    setNewPartName("");
    setNewPartDesc("");
    setNewPartFab("");
  };

  const handleRemoveItem = (tempId: number) => {
    setItems(items.filter((i) => i.tempId !== tempId));
  };

  const handleEditItem = (item: any) => {
    // Load item back into inputs
    if (item.new_part_data) {
      setIsNewPart(true);
      setPartSearch(item.new_part_data.nome);
      setNewPartName(item.new_part_data.nome);
      setNewPartFab(item.new_part_data.fabricante || "");
      setNewPartUnit(item.new_part_data.unidade_medida || "UN");
      setSelectedStockPart(null);
    } else {
      setIsNewPart(false);
      setPartSearch(item.displayName);
      setSelectedStockPart({
        id_pecas_estoque: item.id_pecas_estoque,
        nome: item.displayName,
        valor_custo: item.valor_custo,
        valor_venda: item.valor_venda,
      });
    }

    setRowQtd(String(item.quantidade));
    setRowCost(String(item.valor_custo));
    setRowMargin(String(item.margem_lucro));
    setRowSale(String(item.valor_venda));
    setRowRef(item.ref_cod || "");
    setRowObs(item.obs || "");

    // Remove from list so it can be re-added
    handleRemoveItem(item.tempId);
  };

  // --- FINANCIAL MODAL STATE ---
  const [showFinancialModal, setShowFinancialModal] = useState(false);
  const [finDesc, setFinDesc] = useState("");
  const [finValue, setFinValue] = useState("");
  const [finDueDate, setFinDueDate] = useState("");
  const [finPaid, setFinPaid] = useState(false);
  const [finPayDate, setFinPayDate] = useState("");

  const handlePreSubmit = () => {
    if (!selectedSupplierId) {
      setStatusMsg({ type: "error", text: "Selecione um Fornecedor." });
      return;
    }
    if (items.length === 0) {
      setStatusMsg({ type: "error", text: "Adicione pelo menos um item." });
      return;
    }

    // Pre-fill Financial Data
    const supplierObj = suppliers.find(
      (s) => s.id_fornecedor === Number(selectedSupplierId),
    );
    const supplierName =
      supplierObj?.nome_fantasia || supplierObj?.nome || "Fornecedor";
    setFinDesc(`Compra Estoque - NF ${invoice || "S/N"} - ${supplierName}`);
    const total = items.reduce(
      (acc, i) => acc + i.quantidade * i.valor_custo,
      0,
    );
    setFinValue(total.toFixed(2));
    setFinDueDate(date); // Default due date = purchase date
    setFinPayDate(new Date().toISOString().split("T")[0]); // Default pay date = today
    setFinPaid(false); // Default to Unpaid as per user request

    setShowFinancialModal(true);
  };

  const handleFinalSubmit = async () => {
    try {
      const payload = {
        id_fornecedor: Number(selectedSupplierId),
        nota_fiscal: invoice,
        data_compra: new Date(date),
        obs: obs,
        itens: items,
        financeiro: {
          descricao: finDesc,
          valor: Number(finValue),
          dt_vencimento: finDueDate,
          dt_pagamento: finPaid ? finPayDate : null,
          status: finPaid ? "PAGO" : "PENDENTE",
        },
      };

      await api.post("/pecas-estoque/entry", payload);

      setStatusMsg({
        type: "success",
        text: "Entrada e Financeiro Registrados com Sucesso!",
      });
      setShowFinancialModal(false);

      // Clear All
      setItems([]);
      setInvoice("");
      setObs("");
    } catch (e) {
      console.error(e);
      setStatusMsg({ type: "error", text: "Erro ao processar entrada." });
    }
  };

  return (
    <div className="w-full mx-auto px-4 md:px-8 py-6 space-y-6">
      {statusMsg.text && (
        <div className="fixed bottom-8 right-8 z-50">
          <StatusBanner
            msg={statusMsg}
            onClose={() => setStatusMsg({ type: null, text: "" })}
          />
        </div>
      )}

      {/* NEW FINANCIAL MODAL */}
      {showFinancialModal && (
        <Modal
          title="Registrar Contas a Pagar / Pagamento"
          onClose={() => setShowFinancialModal(false)}
        >
          <div className="space-y-4">
            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4">
              <p className="text-sm text-blue-800 font-bold">
                Confirme os dados financeiros desta compra.
              </p>
              <p className="text-xs text-blue-600">
                Isso ir√° gerar um registro em Contas a Pagar e, se pago, no
                Livro Caixa.
              </p>
            </div>

            <div>
              <Input
                label="Descri√ß√£o"
                value={finDesc}
                onChange={(e) => setFinDesc(e.target.value)}
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Input
                  label="Valor Total (R$)"
                  type="number"
                  value={finValue}
                  readOnly
                  className="bg-neutral-100 font-bold text-neutral-600"
                />
              </div>
              <div>
                <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">
                  Vencimento
                </label>
                <input
                  type="date"
                  value={finDueDate}
                  onChange={(e) => setFinDueDate(e.target.value)}
                  className="w-full border border-neutral-200 p-3 rounded-xl outline-none focus:border-blue-500 font-medium h-[46px]"
                />
              </div>
            </div>

            <div className="flex items-center gap-3 p-4 border border-neutral-100 rounded-xl bg-neutral-50">
              <input
                type="checkbox"
                id="chkPaid"
                checked={finPaid}
                onChange={(e) => setFinPaid(e.target.checked)}
                className="w-5 h-5 accent-blue-600 rounded"
              />
              <label
                htmlFor="chkPaid"
                className="font-bold text-neutral-700 cursor-pointer select-none"
              >
                √Å vista / J√° Pago?
              </label>
            </div>

            {finPaid && (
              <div className="animate-in fade-in slide-in-from-top-2">
                <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">
                  Data do Pagamento
                </label>
                <input
                  type="date"
                  value={finPayDate}
                  onChange={(e) => setFinPayDate(e.target.value)}
                  className="w-full border p-3 rounded-xl outline-none focus:border-green-500 font-medium border-green-200 bg-green-50 h-[46px]"
                />
              </div>
            )}

            <div className="flex justify-end pt-4 gap-2">
              <Button
                variant="ghost"
                onClick={() => setShowFinancialModal(false)}
              >
                Cancelar
              </Button>
              <Button variant="primary" onClick={handleFinalSubmit}>
                CONFIRMAR
              </Button>
            </div>
          </div>
        </Modal>
      )}

      <div className="space-y-2">
        <h1 className="text-2xl font-bold text-neutral-900 flex items-center gap-2">
          <ShoppingCart className="text-primary-600" /> Nova Compra / Entrada de
          Estoque
        </h1>
        <p className="text-neutral-500">
          Registre novas aquisi√ß√µes de pe√ßas e atualize o estoque
          automaticamente.
        </p>
      </div>

      {/* HEADER CARD */}
      <div className="bg-white p-6 rounded-2xl border border-neutral-200 shadow-sm grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="md:col-span-2 relative">
          <div className="flex justify-between items-baseline mb-1">
            <label className="block text-xs font-bold text-neutral-400 uppercase">
              Fornecedor
            </label>
            <button
              onClick={() => setShowNewSupplierModal(true)}
              className="text-[10px] font-bold text-primary-600 hover:text-primary-800 flex items-center gap-1 uppercase bg-primary-50 px-2 py-0.5 rounded cursor-pointer transition-colors"
            >
              <Plus size={10} /> Novo Fornecedor
            </button>
          </div>
          <select
            className="w-full p-3 rounded-xl border border-neutral-200 bg-neutral-50 font-bold text-neutral-700 outline-none focus:border-primary-500 transition-all h-[46px]"
            value={selectedSupplierId}
            onChange={(e) => setSelectedSupplierId(e.target.value)}
          >
            <option value="">Selecione...</option>
            {suppliers.map((s) => (
              <option key={s.id_fornecedor} value={s.id_fornecedor}>
                {s.nome_fantasia || s.nome}
              </option>
            ))}
          </select>
        </div>

        <div>
          <label className="block text-xs font-bold text-neutral-400 uppercase mb-1">
            Data Compra
          </label>
          <input
            type="date"
            className="w-full p-3 rounded-xl border border-neutral-200 bg-neutral-50 font-bold text-neutral-700 outline-none focus:border-primary-500 h-[46px]"
            value={date}
            onChange={(e) => setDate(e.target.value)}
          />
        </div>

        <div>
          <Input
            label="Nota Fiscal / Recibo"
            value={invoice}
            onChange={(e) => setInvoice(e.target.value)}
            placeholder="N¬∫ NF"
          />
        </div>
      </div>

      {/* ITEM INPUT CARD */}
      <div className="bg-white p-6 rounded-2xl border border-neutral-200 shadow-sm space-y-4 relative overflow-visible">
        <h3 className="text-sm font-bold text-neutral-600 uppercase tracking-widest border-b border-neutral-100 pb-2">
          Adicionar Item √† Compra
        </h3>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {/* Part Search / New Part Toggle */}
          <div className="relative z-20">
            <label className="block text-xs font-bold text-neutral-400 uppercase mb-1">
              Buscar Pe√ßa ou Cadastrar Nova
            </label>
            <div className="relative">
              <Search
                className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"
                size={18}
              />
              <input
                className={`w-full pl-10 pr-4 py-3 rounded-xl border ${selectedStockPart ? "border-primary-500 bg-primary-50 text-primary-700" : "border-neutral-200 bg-neutral-50"} font-bold outline-none focus:border-primary-500 transition-all h-[46px]`}
                placeholder="Digite o nome da pe√ßa..."
                value={partSearch}
                onChange={(e) => {
                  handleSearchPart(e.target.value);
                  if (selectedStockPart) setSelectedStockPart(null); // Clear selection if typing again
                  // If unknown, allow switch to new
                }}
              />
              {partResults.length > 0 && !selectedStockPart && (
                <div className="absolute w-full mt-2 bg-white border border-neutral-100 rounded-xl shadow-xl max-h-60 overflow-y-auto z-50">
                  {partResults.map((p) => (
                    <button
                      key={p.id_pecas_estoque}
                      onClick={() => selectPart(p)}
                      className="w-full text-left p-3 hover:bg-neutral-50 flex justify-between border-b border-neutral-50 last:border-0"
                    >
                      <span className="font-bold text-neutral-700">
                        {p.nome}
                      </span>
                      <span className="text-xs font-medium text-neutral-400">
                        {p.fabricante} ‚Ä¢ {p.estoque_atual} un
                      </span>
                    </button>
                  ))}
                  <button
                    onClick={() => {
                      setIsNewPart(true);
                      setNewPartName(partSearch);
                      setPartResults([]);
                      setSelectedStockPart(null);
                    }}
                    className="w-full text-left p-3 bg-primary-50 text-primary-700 font-bold hover:bg-primary-100 flex items-center gap-2"
                  >
                    <Plus size={16} /> Cadastrar Nova Pe√ßa: "{partSearch}"
                  </button>
                </div>
              )}
              {partResults.length === 0 &&
                partSearch.length > 2 &&
                !selectedStockPart &&
                !isNewPart && (
                  <div className="absolute w-full mt-2 bg-white border border-neutral-100 rounded-xl shadow-xl p-2 z-50">
                    <button
                      onClick={() => {
                        setIsNewPart(true);
                        setNewPartName(partSearch);
                        setPartResults([]);
                        setSelectedStockPart(null);
                      }}
                      className="w-full text-left p-3 bg-primary-50 text-primary-700 font-bold hover:bg-primary-100 flex items-center gap-2 rounded-lg"
                    >
                      <Plus size={16} /> Cadastrar Nova Pe√ßa: "{partSearch}"
                    </button>
                  </div>
                )}
            </div>
          </div>

          {/* If New Part: Extra Fields */}
          {isNewPart && (
            <div className="grid grid-cols-2 gap-2 animate-in fade-in slide-in-from-top-2">
              <div>
                <Input
                  label="Fabricante"
                  placeholder="Marca"
                  value={newPartFab}
                  onChange={(e) => setNewPartFab(e.target.value)}
                />
              </div>
              <div>
                <label className="block text-xs font-bold text-neutral-400 uppercase mb-1">
                  Unidade
                </label>
                <select
                  className="w-full p-3 rounded-xl border border-neutral-200 bg-white font-medium h-[46px]"
                  value={newPartUnit}
                  onChange={(e) => setNewPartUnit(e.target.value)}
                >
                  <option value="UN">Unidade (UN)</option>
                  <option value="L">Litro (L)</option>
                  <option value="KG">Quilo (KG)</option>
                  <option value="KIT">Kit</option>
                  <option value="PAR">Par</option>
                </select>
              </div>
            </div>
          )}
        </div>

        {/* Values Row */}
        <div className="grid grid-cols-1 md:grid-cols-5 gap-4 pt-2">
          <div>
            <Input
              label="Quantidade"
              type="number"
              className="text-center font-bold"
              value={rowQtd}
              onChange={(e) => setRowQtd(e.target.value)}
            />
          </div>
          <div>
            <Input
              label="Custo Unit (R$)"
              type="number"
              className="text-right font-medium"
              placeholder="0.00"
              value={rowCost}
              onChange={(e) => setRowCost(e.target.value)}
            />
          </div>
          <div className="relative">
            <Input
              label="Margem (%)"
              type="number"
              className="text-center font-medium"
              placeholder="%"
              value={rowMargin}
              onChange={(e) => setRowMargin(e.target.value)}
            />
          </div>
          <div>
            <Input
              label="Venda Unit (R$)"
              type="number"
              className="text-right border-primary-200 bg-primary-50 text-primary-800 font-bold"
              placeholder="0.00"
              value={rowSale}
              onChange={(e) => handleRecalcMargin(e.target.value)}
            />
          </div>
          <div className="flex items-end">
            <Button
              onClick={handleAddItem}
              className="w-full"
              variant="primary"
              icon={Plus}
            >
              ADICIONAR
            </Button>
          </div>
        </div>

        {/* Extra Details Row */}
        <div className="grid grid-cols-2 gap-4">
          <Input
            placeholder="C√≥digo Ref/Fabricante (Opcional)"
            value={rowRef}
            onChange={(e) => setRowRef(e.target.value)}
          />
          <Input
            placeholder="Observa√ß√µes do item (Opcional)"
            value={rowObs}
            onChange={(e) => setRowObs(e.target.value)}
          />
        </div>
      </div>

      {/* CART LIST */}
      <div className="bg-white rounded-2xl border border-neutral-200 overflow-hidden shadow-sm">
        <div className="p-4 bg-neutral-50 border-b border-neutral-100 flex justify-between items-center">
          <h3 className="text-sm font-bold text-neutral-600 uppercase tracking-widest">
            Itens na Lista
          </h3>
          <span className="text-xs font-bold text-neutral-400">
            {items.length} itens
          </span>
        </div>

        <table className="w-full text-left">
          <thead className="bg-neutral-50 text-[10px] uppercase font-bold text-neutral-400 tracking-wider">
            <tr>
              <th className="p-3">Produto</th>
              <th className="p-3 text-center">Qtd</th>
              <th className="p-3 text-right">Custo</th>
              <th className="p-3 text-right">Margem</th>
              <th className="p-3 text-right">Venda</th>
              <th className="p-3 text-right">Total Custo</th>
              <th className="p-3"></th>
            </tr>
          </thead>
          <tbody className="divide-y divide-neutral-50">
            {items.map((i) => (
              <tr
                key={i.tempId}
                className="hover:bg-neutral-50 transition-colors"
              >
                <td className="p-3">
                  <div className="font-bold text-neutral-800">
                    {i.displayName}
                  </div>
                  <div className="text-xs text-neutral-400">
                    {i.ref_cod} {i.obs}
                  </div>
                  {i.new_part_data && (
                    <span className="text-[9px] bg-green-100 text-green-700 px-1 rounded uppercase font-bold">
                      NOVO CADASTRO
                    </span>
                  )}
                </td>
                <td className="p-3 text-center font-bold text-neutral-700">
                  {i.quantidade}
                </td>
                <td className="p-3 text-right text-neutral-600">
                  {formatCurrency(i.valor_custo)}
                </td>
                <td className="p-3 text-right text-blue-600 font-medium">
                  {i.margem_lucro?.toFixed(1)}%
                </td>
                <td className="p-3 text-right font-bold text-neutral-800">
                  {formatCurrency(i.valor_venda)}
                </td>
                <td className="p-3 text-right text-neutral-500">
                  {formatCurrency(i.quantidade * i.valor_custo)}
                </td>
                <td className="p-3 text-right">
                  <button
                    onClick={() => handleEditItem(i)}
                    className="text-primary-400 hover:text-primary-600 p-1 mr-2 transition-colors"
                  >
                    <Edit size={16} />
                  </button>
                  <button
                    onClick={() => handleRemoveItem(i.tempId)}
                    className="text-red-400 hover:text-red-600 p-1 transition-colors"
                  >
                    <Trash2 size={16} />
                  </button>
                </td>
              </tr>
            ))}
            {items.length === 0 && (
              <tr>
                <td
                  colSpan={7}
                  className="p-8 text-center text-neutral-400 italic"
                >
                  Nenhum item adicionado.
                </td>
              </tr>
            )}
          </tbody>
        </table>

        {items.length > 0 && (
          <div className="p-4 bg-neutral-100 flex justify-end items-center gap-6">
            <div className="text-right">
              <p className="text-xs font-bold text-neutral-500 uppercase">
                Total da Compra
              </p>
              <p className="text-2xl font-bold text-neutral-800">
                {formatCurrency(
                  items.reduce(
                    (acc, i) => acc + i.quantidade * i.valor_custo,
                    0,
                  ),
                )}
              </p>
            </div>
            <Button
              onClick={handlePreSubmit}
              variant="primary"
              className="h-12 px-8 text-lg shadow-xl shadow-primary-500/20"
              icon={Save}
            >
              FINALIZAR ENTRADA
            </Button>
          </div>
        )}
      </div>

      {/* NEW SUPPLIER MODAL */}
      {showNewSupplierModal && (
        <Modal
          title="Novo Fornecedor"
          onClose={() => setShowNewSupplierModal(false)}
          className="max-w-5xl"
        >
          <FornecedorForm
            onSuccess={(newSupplier) => {
              if (newSupplier) {
                setSuppliers((prev) => [...prev, newSupplier]);
                setSelectedSupplierId(String(newSupplier.id_fornecedor));
                setStatusMsg({
                  type: "success",
                  text: "Fornecedor Cadastrado e Selecionado!",
                });
              } else {
                // Fallback reload if no data returned
                api
                  .get("/fornecedor")
                  .then((res) => setSuppliers(res.data))
                  .catch(console.error);
              }
              setShowNewSupplierModal(false);
            }}
            onCancel={() => setShowNewSupplierModal(false)}
          />
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\ExtratoBancarioPage.tsx
================================================================================
import { useState, useEffect } from "react";
import { formatCurrency } from "../utils/formatCurrency";
import { useParams, useNavigate } from "react-router-dom";
import { api } from "../services/api";
import {
  ArrowLeft,
  ArrowUpCircle,
  ArrowDownCircle,
  Plus,
  Search,
  Calendar,
  Wallet,
  ArrowRight,
} from "lucide-react";
import type { IContaBancaria } from "../types/backend";
import { Button } from "../components/ui/Button";
import { Input } from "../components/ui/input";
import { Modal } from "../components/ui/Modal";

export const ExtratoBancarioPage = () => {
  const { idConta } = useParams();
  const navigate = useNavigate();

  // State
  const [conta, setConta] = useState<IContaBancaria | null>(null);
  const [movimentacoes, setMovimentacoes] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  // Filters
  const [searchTerm, setSearchTerm] = useState("");
  const [dateRange, setDateRange] = useState<{ start: string; end: string }>({
    start: new Date(new Date().setDate(new Date().getDate() - 30))
      .toISOString()
      .split("T")[0], // Last 30 days
    end: new Date().toISOString().split("T")[0],
  });
  const [selectedCategory, setSelectedCategory] = useState("");
  const [selectedType, setSelectedType] = useState("");

  // Modal & Form State
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [categories, setCategories] = useState<any[]>([]);
  const [formLoading, setFormLoading] = useState(false);
  const [formData, setFormData] = useState({
    descricao: "",
    valor: "",
    tipo_movimentacao: "SAIDA",
    categoria: "OUTROS",
    obs: "",
  });

  useEffect(() => {
    if (idConta) {
      loadData();
      loadCategories();
    }
  }, [idConta]);

  const loadCategories = async () => {
    try {
      const res = await api.get("/categoria-financeira");
      setCategories(res.data);
    } catch (error) {
      console.error("Erro ao carregar categorias:", error);
    }
  };

  const loadData = async () => {
    try {
      setLoading(true);
      const [contaRes, movRes] = await Promise.all([
        api.get("/conta-bancaria"),
        api.get("/livro-caixa"),
      ]);

      const contaFound = contaRes.data.find(
        (c: any) => c.id_conta === Number(idConta),
      );
      setConta(contaFound || null);

      // 1. Livro Caixa (Manuais ou Autom√°ticos que geraram registro) - FONTE √öNICA
      const entriesLivro = movRes.data
        .filter((m: any) => m.id_conta_bancaria === Number(idConta))
        .map((m: any) => ({
          id: `cx-${m.id_livro_caixa}`,
          id_livro_caixa: m.id_livro_caixa,
          dt_movimentacao: m.dt_movimentacao,
          descricao: m.descricao,
          categoria: m.categoria,
          tipo_movimentacao: m.tipo_movimentacao,
          valor: Number(m.valor),
          obs: m.obs || "",
          deleted_at: m.deleted_at,
          origem: "LIVRO_CAIXA",
          paymentMethod:
            m.categoria === "CONCILIACAO_CARTAO"
              ? "CART√ÉO"
              : m.descricao.includes("PIX")
                ? "PIX"
                : m.origem === "MANUAL"
                  ? "MANUAL"
                  : "OUTROS",
        }));

      const allMovs = entriesLivro.sort(
        (a: any, b: any) =>
          new Date(b.dt_movimentacao).getTime() -
          new Date(a.dt_movimentacao).getTime(),
      );

      setMovimentacoes(allMovs);
    } catch (error) {
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  // Apply Filters
  const filteredMovimentacoes = movimentacoes.filter((mov) => {
    const matchesSearch =
      mov.descricao.toLowerCase().includes(searchTerm.toLowerCase()) ||
      (mov.obs && mov.obs.toLowerCase().includes(searchTerm.toLowerCase()));

    const matchesCategory = selectedCategory
      ? mov.categoria === selectedCategory
      : true;
    const matchesType = selectedType
      ? mov.tipo_movimentacao === selectedType
      : true;

    const movDate = new Date(mov.dt_movimentacao).toISOString().split("T")[0];
    const matchesDate =
      (!dateRange.start || movDate >= dateRange.start) &&
      (!dateRange.end || movDate <= dateRange.end);

    return matchesSearch && matchesCategory && matchesType && matchesDate;
  });

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen bg-neutral-50">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"></div>
      </div>
    );
  }

  if (!conta) {
    return (
      <div className="p-8 text-center bg-surface min-h-screen">
        <h2 className="text-xl font-bold text-neutral-800">
          Conta n√£o encontrada
        </h2>
        <Button
          onClick={() => navigate("/financeiro/livro-caixa")}
          variant="ghost"
          className="mt-4"
        >
          Voltar
        </Button>
      </div>
    );
  }

  // Apply Totals (Based on Filtered Data)
  const totalEntradas = filteredMovimentacoes
    .filter((m) => m.tipo_movimentacao === "ENTRADA")
    .reduce((acc: any, m: any) => acc + Number(m.valor), 0);

  const totalSaidas = filteredMovimentacoes
    .filter((m) => m.tipo_movimentacao === "SAIDA")
    .reduce((acc: any, m: any) => acc + Number(m.valor), 0);

  return (
    <div className="min-h-screen bg-neutral-50 p-6 animate-in fade-in duration-500">
      {/* Header */}
      <div className="mb-8 max-w-7xl mx-auto space-y-6">
        <button
          onClick={() => navigate("/financeiro/livro-caixa")}
          className="flex items-center gap-2 text-neutral-500 hover:text-neutral-900 transition-colors font-bold text-sm"
        >
          <ArrowLeft size={16} />
          Voltar para Gest√£o Financeira
        </button>

        <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 bg-surface p-8 rounded-2xl border border-neutral-200 shadow-sm relative overflow-hidden">
          {/* Decorative Background */}
          <div className="absolute top-0 right-0 w-64 h-64 bg-primary-100/50 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

          <div className="relative z-10">
            <div className="flex items-center gap-3 mb-2">
              <div className="p-2 bg-primary-50 text-primary-600 rounded-lg">
                <Wallet size={24} />
              </div>
              <h1 className="text-3xl font-bold text-neutral-900">
                {conta.nome}
              </h1>
              <span className="px-3 py-1 bg-neutral-100 rounded-lg text-xs font-bold text-neutral-600 uppercase tracking-wide border border-neutral-200">
                {conta.banco}
              </span>
            </div>
            <p className="text-neutral-500 font-medium ml-1">
              {conta.agencia && `Ag: ${conta.agencia}`}{" "}
              {conta.conta && `CC: ${conta.conta}`}
            </p>
          </div>

          <div className="text-right flex items-center gap-6 relative z-10">
            <div>
              <p className="text-xs font-bold text-neutral-400 uppercase tracking-widest mb-1">
                Saldo Atual
              </p>
              <p
                className={`text-4xl font-black ${Number(conta.saldo_atual) >= 0 ? "text-neutral-900" : "text-red-500"}`}
              >
                {formatCurrency(Number(conta.saldo_atual))}
              </p>
            </div>

            <div className="h-12 w-px bg-neutral-200 hidden md:block"></div>

            <Button
              onClick={() => setIsModalOpen(true)}
              variant="primary"
              size="lg"
              icon={Plus}
              className="shadow-xl shadow-primary-500/20"
            >
              Novo Lan√ßamento
            </Button>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto space-y-6">
        {/* Filter Bar */}
        <div className="bg-surface p-6 rounded-xl border border-neutral-200 shadow-sm flex flex-col xl:flex-row gap-4 items-end">
          <div className="flex-1 w-full xl:w-auto">
            <Input
              label="Buscar"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              placeholder="Descri√ß√£o ou observa√ß√£o..."
              icon={Search}
            />
          </div>
          <div className="w-full xl:w-auto flex gap-2">
            <div>
              <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1.5 block">
                De
              </label>
              <input
                type="date"
                value={dateRange.start}
                onChange={(e) =>
                  setDateRange({ ...dateRange, start: e.target.value })
                }
                className="h-[42px] bg-neutral-50 border border-neutral-200 px-3 rounded-lg font-bold text-[11px] outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all uppercase w-full"
              />
            </div>
            <div>
              <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1.5 block">
                At√©
              </label>
              <input
                type="date"
                value={dateRange.end}
                onChange={(e) =>
                  setDateRange({ ...dateRange, end: e.target.value })
                }
                className="h-[42px] bg-neutral-50 border border-neutral-200 px-3 rounded-lg font-bold text-[11px] outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all uppercase w-full"
              />
            </div>
          </div>
          <div className="w-full xl:w-48">
            <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1.5 block">
              Tipo
            </label>
            <div className="relative">
              <select
                value={selectedType}
                onChange={(e) => setSelectedType(e.target.value)}
                className="w-full h-[42px] bg-neutral-50 border border-neutral-200 px-3 rounded-lg font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all appearance-none cursor-pointer"
              >
                <option value="">Todos</option>
                <option value="ENTRADA">Entradas</option>
                <option value="SAIDA">Sa√≠das</option>
              </select>
              <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-neutral-500">
                <ArrowDownCircle size={14} />
              </div>
            </div>
          </div>
          <div className="w-full xl:w-56">
            <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1.5 block">
              Categoria
            </label>
            <div className="relative">
              <select
                value={selectedCategory}
                onChange={(e) => setSelectedCategory(e.target.value)}
                className="w-full h-[42px] bg-neutral-50 border border-neutral-200 px-3 rounded-lg font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all appearance-none cursor-pointer"
              >
                <option value="">Todas</option>
                {categories.map((cat) => (
                  <option key={cat.id_categoria} value={cat.nome}>
                    {cat.nome}
                  </option>
                ))}
              </select>
              <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-neutral-500">
                <ArrowDownCircle size={14} />
              </div>
            </div>
          </div>
          <div className="w-full xl:w-auto">
            <Button
              variant="ghost"
              onClick={() => {
                setSearchTerm("");
                setDateRange({
                  start: new Date(new Date().setDate(new Date().getDate() - 30))
                    .toISOString()
                    .split("T")[0],
                  end: new Date().toISOString().split("T")[0],
                });
                setSelectedCategory("");
                setSelectedType("");
              }}
              className="h-[42px] w-full"
            >
              Limpar
            </Button>
          </div>
        </div>

        {/* Summary Area */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="bg-surface p-6 rounded-xl border border-neutral-200 shadow-sm flex items-center justify-between">
            <div>
              <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest mb-1">
                Entradas
              </p>
              <p className="text-2xl font-black text-emerald-600">
                {formatCurrency(totalEntradas)}
              </p>
            </div>
            <div className="p-3 bg-emerald-50 text-emerald-600 rounded-xl">
              <ArrowUpCircle size={24} />
            </div>
          </div>
          <div className="bg-surface p-6 rounded-xl border border-neutral-200 shadow-sm flex items-center justify-between">
            <div>
              <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest mb-1">
                Sa√≠das
              </p>
              <p className="text-2xl font-black text-red-600">
                {formatCurrency(totalSaidas)}
              </p>
            </div>
            <div className="p-3 bg-red-50 text-red-600 rounded-xl">
              <ArrowDownCircle size={24} />
            </div>
          </div>
          <div className="bg-neutral-900 p-6 rounded-xl shadow-xl flex items-center justify-between text-neutral-25">
            <div>
              <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest mb-1">
                Resultado
              </p>
              <p
                className={`text-2xl font-black ${totalEntradas - totalSaidas >= 0 ? "text-neutral-25" : "text-red-400"}`}
              >
                {formatCurrency(totalEntradas - totalSaidas)}
              </p>
            </div>
            <div className="p-3 bg-neutral-800 text-neutral-400 rounded-xl">
              <ArrowRight size={24} />
            </div>
          </div>
        </div>

        {/* Transactions Table */}
        <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-neutral-50 text-[10px] font-bold text-neutral-400 uppercase tracking-widest border-b border-neutral-200">
                <th className="p-4 w-40">Data</th>
                <th className="p-4">Descri√ß√£o</th>
                <th className="p-4 w-32">Forma Pagto</th>
                <th className="p-4 w-40">Categoria</th>
                <th className="p-4 w-32 text-center">Tipo</th>
                <th className="p-4 w-40 text-right">Valor</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-neutral-100">
              {filteredMovimentacoes.length === 0 ? (
                <tr>
                  <td colSpan={6} className="p-12 text-center text-neutral-400">
                    <div className="flex flex-col items-center gap-2">
                      <Search size={32} className="opacity-20 mb-2" />
                      <p className="font-bold">
                        Nenhuma movimenta√ß√£o encontrada.
                      </p>
                      <p className="text-xs">Tente ajustar os filtros.</p>
                    </div>
                  </td>
                </tr>
              ) : (
                filteredMovimentacoes.map((mov) => (
                  <tr
                    key={mov.id_livro_caixa}
                    className={`hover:bg-neutral-50 transition-colors group ${mov.deleted_at ? "opacity-50" : ""}`}
                  >
                    <td className="p-4">
                      <div className="flex flex-col gap-1">
                        <div className="flex items-center gap-1.5 text-sm font-bold text-neutral-700">
                          <Calendar size={14} className="text-neutral-400" />
                          {new Date(mov.dt_movimentacao).toLocaleDateString()}
                        </div>
                        <span className="text-[10px] font-bold text-neutral-400 pl-5">
                          {new Date(mov.dt_movimentacao).toLocaleTimeString(
                            [],
                            {
                              hour: "2-digit",
                              minute: "2-digit",
                            },
                          )}
                        </span>
                      </div>
                    </td>
                    <td className="p-4">
                      <div className="flex flex-col">
                        <span
                          className={`text-sm font-bold text-neutral-900 ${mov.deleted_at ? "line-through" : ""}`}
                        >
                          {mov.descricao}
                        </span>
                        {mov.obs && (
                          <span className="text-xs font-medium text-neutral-500 mt-0.5 italic truncate max-w-[300px]">
                            {mov.obs}
                          </span>
                        )}
                      </div>
                    </td>
                    <td className="p-4">
                      <span
                        className={`text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded bg-neutral-100 ${!mov.paymentMethod || mov.paymentMethod === "MANUAL" ? "text-neutral-500" : "text-primary-600 bg-primary-50"}`}
                      >
                        {mov.paymentMethod || "MANUAL"}
                      </span>
                    </td>
                    <td className="p-4">
                      <span className="bg-neutral-100 text-neutral-600 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide border border-neutral-200">
                        {mov.categoria === "CONCILIACAO_CARTAO"
                          ? "Recebimento (Cart√£o)"
                          : mov.categoria === "VENDA"
                            ? "Faturamento"
                            : mov.categoria}
                      </span>
                    </td>
                    <td className="p-4 text-center">
                      {mov.tipo_movimentacao === "ENTRADA" ? (
                        <div className="inline-flex items-center justify-center w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 border border-emerald-100">
                          <ArrowUpCircle size={16} />
                        </div>
                      ) : (
                        <div className="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-50 text-red-600 border border-red-100">
                          <ArrowDownCircle size={16} />
                        </div>
                      )}
                    </td>
                    <td
                      className={`p-4 text-right font-black text-sm whitespace-nowrap ${
                        mov.deleted_at
                          ? "text-neutral-400 line-through"
                          : mov.tipo_movimentacao === "ENTRADA"
                            ? "text-emerald-600"
                            : "text-red-600"
                      }`}
                    >
                      {mov.tipo_movimentacao === "SAIDA" ? "- " : "+ "}
                      {formatCurrency(Number(mov.valor))}
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* CREATE MODAL */}
      {isModalOpen && (
        <Modal
          title="Novo Lan√ßamento Banc√°rio"
          onClose={() => setIsModalOpen(false)}
        >
          <form
            onSubmit={async (e) => {
              e.preventDefault();
              try {
                setFormLoading(true);
                await api.post("/livro-caixa", {
                  ...formData,
                  id_conta_bancaria: Number(idConta),
                  origem: "MANUAL",
                });
                setIsModalOpen(false);
                setFormData({
                  descricao: "",
                  valor: "",
                  tipo_movimentacao: "SAIDA",
                  categoria: "OUTROS",
                  obs: "",
                });
                loadData(); // Recarrega extrato e saldo
              } catch (error) {
                console.error(error);
                alert("Erro ao criar lan√ßamento.");
              } finally {
                setFormLoading(false);
              }
            }}
            className="space-y-4"
          >
            <div>
              <Input
                label="Descri√ß√£o"
                required
                value={formData.descricao}
                onChange={(e) =>
                  setFormData({ ...formData, descricao: e.target.value })
                }
                placeholder="Ex: Taxa Banc√°ria, Material de Limpeza..."
              />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Input
                  label="Valor (R$)"
                  required
                  type="number"
                  step="0.01"
                  value={formData.valor}
                  onChange={(e) =>
                    setFormData({ ...formData, valor: e.target.value })
                  }
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                  Tipo
                </label>
                <div className="relative">
                  <select
                    value={formData.tipo_movimentacao}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        tipo_movimentacao: e.target.value,
                      })
                    }
                    className="w-full bg-neutral-50 border border-neutral-200 px-3 py-[11px] rounded-lg font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all appearance-none cursor-pointer"
                  >
                    <option value="ENTRADA">Entrada (+)</option>
                    <option value="SAIDA">Sa√≠da (-)</option>
                  </select>
                  <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-neutral-500">
                    <ArrowDownCircle size={14} />
                  </div>
                </div>
              </div>
            </div>
            <div>
              <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                Categoria
              </label>
              <div className="relative">
                <select
                  value={formData.categoria}
                  onChange={(e) =>
                    setFormData({ ...formData, categoria: e.target.value })
                  }
                  className="w-full bg-neutral-50 border border-neutral-200 px-3 py-[11px] rounded-lg font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all appearance-none cursor-pointer"
                >
                  {categories.map((cat) => (
                    <option key={cat.id_categoria} value={cat.nome}>
                      {cat.nome}
                    </option>
                  ))}
                </select>
                <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-neutral-500">
                  <ArrowDownCircle size={14} />
                </div>
              </div>
            </div>
            <div>
              <label className="block text-sm font-semibold text-neutral-700 ml-1 mb-1.5">
                Observa√ß√£o (Opcional)
              </label>
              <textarea
                rows={3}
                value={formData.obs}
                onChange={(e) =>
                  setFormData({ ...formData, obs: e.target.value })
                }
                className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-lg font-medium text-neutral-900 outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all"
              />
            </div>
            <div className="pt-4 flex gap-3 justify-end">
              <Button
                type="button"
                variant="ghost"
                onClick={() => setIsModalOpen(false)}
              >
                Cancelar
              </Button>
              <Button
                type="submit"
                variant="primary"
                disabled={formLoading}
                className="shadow-lg shadow-primary-500/20"
              >
                {formLoading ? "Salvando..." : "Confirmar Lan√ßamento"}
              </Button>
            </div>
          </form>
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\FechamentoFinanceiroDetalhePage.tsx
================================================================================
import { useState, useEffect, useCallback } from "react";
import { useNavigate, useParams, useBlocker } from "react-router-dom";
import { formatCurrency } from "../utils/formatCurrency";
import { api } from "../services/api";
import {
  Save,
  Plus,
  BadgeCheck,
  Trash2,
  ArrowLeft,
  Edit,
  AlertCircle,
  Truck,
  Phone,
} from "lucide-react";
import { PagamentoClienteForm } from "../components/forms/PagamentoClienteForm";
import { FornecedorForm } from "../components/forms/FornecedorForm";
import { LaborManager } from "../components/os/LaborManager";
import { Modal } from "../components/ui/Modal";
import { StatusBanner } from "../components/ui/StatusBanner";
import { Button } from "../components/ui/Button";
import { ActionButton } from "../components/ui/ActionButton";

interface ItemOS {
  id_iten: number;
  id_pecas_estoque?: number;
  valor_total: number;
  valor_venda: number;
  descricao: string;
  quantidade: number;
  codigo_referencia?: string;
  pecas_estoque?: {
    valor_custo: number;
    nome: string;
  };
  pagamentos_peca?: {
    id_pagamento_peca: number;
    id_fornecedor: number;
    custo_real: number;
    pago_ao_fornecedor: boolean;
  }[];
}

interface IFornecedor {
  id_fornecedor: number;
  nome: string;
}

interface ItemFinanceiroState {
  id_pagamento_peca?: number;
  id_fornecedor: string;
  custo_real: string;
  pago_fornecedor: boolean;
}

interface OSData {
  id_os: number;
  dt_abertura: string;
  status: string;
  valor_total_cliente: number;
  valor_mao_de_obra: number;
  valor_pecas: number;
  itens_os: ItemOS[];
  defeito_relatado?: string;
  diagnostico?: string;
  cliente: {
    pessoa_fisica?: { pessoa: { nome: string } };
    pessoa_juridica?: { nome_fantasia: string };
    telefone_1?: string;
  };
  veiculo: {
    placa: string;
    modelo: string;
    cor: string;
  };
  cliente_telefone?: string;
  pagamentos_cliente?: {
    id_pagamento_cliente: number;
    metodo_pagamento: string;
    valor: number;
    data_pagamento: string;
    bandeira_cartao?: string;
    codigo_transacao?: string;
    qtd_parcelas?: number;
    deleted_at?: string;
  }[];
  fechamento_financeiro?: {
    id_fechamento_financeiro: number;
  };
  servicos_mao_de_obra?: {
    id_servico_mao_de_obra: number;
    valor: number;
    funcionario?: {
      pessoa_fisica?: {
        pessoa: {
          nome: string;
        };
      };
      cargo?: string;
    };
  }[];
}

export const FechamentoFinanceiroDetalhePage = () => {
  const { id } = useParams(); // Get ID from URL
  const navigate = useNavigate();

  const [loading, setLoading] = useState(false);
  const [fetchingOs, setFetchingOs] = useState(false);
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  const [osData, setOsData] = useState<OSData | null>(null);
  const [fornecedores, setFornecedores] = useState<IFornecedor[]>([]);

  const [itemsState, setItemsState] = useState<
    Record<number, ItemFinanceiroState>
  >({});
  const [showFornecedorModal, setShowFornecedorModal] = useState(false);
  const [paymentModal, setPaymentModal] = useState<{
    isOpen: boolean;
    data: any;
  }>({ isOpen: false, data: null });

  // Item Edit State
  const [editItemModal, setEditItemModal] = useState<{
    isOpen: boolean;
    item: ItemOS | null;
  }>({ isOpen: false, item: null });
  const [editItemForm, setEditItemForm] = useState({
    descricao: "",
    quantidade: 1,
    valor_venda: 0,
    codigo_referencia: "",
  });

  // Dirty Check State
  const [isDirty, setIsDirty] = useState(false);

  const blocker = useBlocker(
    ({ currentLocation, nextLocation }) =>
      isDirty && currentLocation.pathname !== nextLocation.pathname,
  );

  const [confirmModal, setConfirmModal] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    onConfirm: () => void;
  }>({ isOpen: false, title: "", message: "", onConfirm: () => {} });

  const [employees, setEmployees] = useState<any[]>([]);

  const handleLaborTotalChange = useCallback((total: number) => {
    setOsData((prev) =>
      prev
        ? {
            ...prev,
            valor_mao_de_obra: total,
            valor_total_cliente: (prev.valor_pecas || 0) + total,
          }
        : null,
    );
  }, []);

  useEffect(() => {
    loadFornecedores();
    loadEmployees();
    if (id) {
      fetchOsData(Number(id));
    }
  }, [id]);

  const loadFornecedores = async () => {
    try {
      const response = await api.get("/fornecedor");
      setFornecedores(response.data);
    } catch (error) {
      console.error("Erro ao carregar fornecedores");
    }
  };

  const loadEmployees = async () => {
    try {
      const response = await api.get("/funcionario");
      setEmployees(response.data);
    } catch (error) {
      console.error("Erro ao carregar funcion√°rios");
    }
  };

  const fetchOsData = async (osId: number) => {
    setFetchingOs(true);
    setStatusMsg({ type: null, text: "" });
    try {
      const response = await api.get(`/ordem-de-servico/${osId}`);
      const os: OSData = response.data;
      setOsData(os);

      const initialItemsState: Record<number, ItemFinanceiroState> = {};
      os.itens_os.forEach((item) => {
        const existingPayment =
          item.pagamentos_peca && item.pagamentos_peca.length > 0
            ? item.pagamentos_peca[0]
            : null;

        const initialCost = existingPayment
          ? String(existingPayment.custo_real)
          : item.pecas_estoque?.valor_custo
            ? (
                Number(item.pecas_estoque.valor_custo) * item.quantidade
              ).toFixed(2)
            : "";

        initialItemsState[item.id_iten] = {
          id_pagamento_peca: existingPayment?.id_pagamento_peca,
          id_fornecedor: existingPayment
            ? String(existingPayment.id_fornecedor)
            : "",
          custo_real: initialCost,
          pago_fornecedor: existingPayment
            ? existingPayment.pago_ao_fornecedor
            : false,
        };
      });
      setItemsState(initialItemsState);
      setIsDirty(false); // Reset dirty after fetch
    } catch (error) {
      console.error(error);
      setStatusMsg({
        type: "error",
        text: "OS n√£o encontrada ou erro ao buscar dados.",
      });
    } finally {
      setFetchingOs(false);
    }
  };

  const handleDeletePayment = (paymentId: number) => {
    setConfirmModal({
      isOpen: true,
      title: "Excluir Pagamento",
      message: "Tem certeza que deseja excluir este pagamento?",
      onConfirm: async () => {
        try {
          await api.delete(`/pagamento-cliente/${paymentId}`);
          setStatusMsg({ type: "success", text: "Pagamento removido!" });
          if (osData) fetchOsData(osData.id_os);
        } catch (error) {
          setStatusMsg({ type: "error", text: "Erro ao remover pagamento." });
        }
        setConfirmModal((prev) => ({ ...prev, isOpen: false }));
      },
    });
  };

  const handleItemChange = (
    id_iten: number,
    field: keyof ItemFinanceiroState,
    value: any,
  ) => {
    setItemsState((prev) => {
      const newState = {
        ...prev,
        [id_iten]: {
          ...prev[id_iten],
          [field]: value,
        },
      };
      return newState;
    });
    setIsDirty(true);
  };

  // --- ITEM CRUD ---
  const handleOpenEditItem = (item: ItemOS) => {
    setEditItemForm({
      descricao: item.descricao,
      quantidade: item.quantidade,
      valor_venda:
        Number(item.valor_venda) || Number(item.valor_total) / item.quantidade,
      codigo_referencia: item.codigo_referencia || "",
    });
    setEditItemModal({ isOpen: true, item });
  };

  const handleDeleteItemOS = async (itemId: number) => {
    setConfirmModal({
      isOpen: true,
      title: "Excluir Item",
      message: "Tem certeza que deseja excluir este item da OS?",
      onConfirm: async () => {
        try {
          await api.delete(`/itens-os/${itemId}`);
          setStatusMsg({ type: "success", text: "Item removido com sucesso!" });
          if (osData) fetchOsData(osData.id_os);
        } catch (error) {
          console.error(error);
          setStatusMsg({ type: "error", text: "Erro ao excluir item." });
        }
        setConfirmModal((prev) => ({ ...prev, isOpen: false }));
      },
    });
  };

  const handleSaveEditItem = async () => {
    if (!editItemModal.item || !osData) return;
    try {
      const valorTotal =
        Number(editItemForm.quantidade) * Number(editItemForm.valor_venda);
      await api.put(`/itens-os/${editItemModal.item.id_iten}`, {
        descricao: editItemForm.descricao,
        quantidade: Number(editItemForm.quantidade),
        valor_venda: Number(editItemForm.valor_venda),
        valor_total: valorTotal,
        codigo_referencia: editItemForm.codigo_referencia,
      });

      setEditItemModal({ isOpen: false, item: null });
      fetchOsData(osData.id_os);
      setStatusMsg({ type: "success", text: "Item atualizado!" });
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: "error", text: "Erro ao atualizar item." });
    }
  };

  const calculateTotals = () => {
    if (!osData)
      return {
        totalReceita: 0,
        totalCusto: 0,
        lucro: 0,
        margem: 0,
        totalItemsRevenue: 0,
        totalItemsCost: 0,
        totalLaborRevenue: 0,
      };

    const totalItemsRevenue = osData.itens_os.reduce(
      (acc, i) => acc + Number(i.valor_total),
      0,
    );
    const totalItemsCost = osData.itens_os.reduce(
      (acc, i) => acc + Number(itemsState[i.id_iten]?.custo_real || 0),
      0,
    );
    const totalLaborRevenue =
      osData.servicos_mao_de_obra?.reduce(
        (acc, s) => acc + Number(s.valor),
        0,
      ) || 0;
    const totalReceita = totalItemsRevenue + totalLaborRevenue;
    const totalCusto = totalItemsCost; // Updated to use totalItemsCost

    const lucro = totalReceita - totalCusto;
    const margem = totalReceita > 0 ? (lucro / totalReceita) * 100 : 0;

    return {
      totalReceita,
      totalCusto,
      lucro,
      margem,
      totalItemsRevenue,
      totalItemsCost,
      totalLaborRevenue,
    };
  };

  const {
    totalReceita,
    totalCusto,
    totalItemsRevenue,
    totalItemsCost,
    totalLaborRevenue,
  } = calculateTotals();

  const handleSave = async (finalize: boolean = false) => {
    setLoading(true);
    if (!osData) return;

    try {
      // Upsert Payments (Costs)
      const pagamentoPromises = osData.itens_os.map(async (item) => {
        const st = itemsState[item.id_iten];
        if (!st || !st.id_fornecedor) return null; // Skip incomplete items? Or strictly require?
        // If finalize is true, we might strictly require. If just saving, allow partial?
        // Let's allow partial save if not finalizing.

        if (st && st.id_fornecedor && st.custo_real) {
          const payload = {
            id_item_os: item.id_iten,
            id_fornecedor: Number(st.id_fornecedor),
            custo_real: Number(st.custo_real),
            data_compra: new Date().toISOString(),
            pago_ao_fornecedor: st.pago_fornecedor,
          };

          if (st.id_pagamento_peca) {
            return api.put(`/pagamento-peca/${st.id_pagamento_peca}`, payload);
          } else {
            return api.post("/pagamento-peca", payload);
          }
        }
        return null;
      });

      await Promise.all(pagamentoPromises);

      await Promise.all(pagamentoPromises);

      // Finalize OS if requested
      if (finalize) {
        // Upsert Fechamento ONLY when finalizing
        const fechamentoPayload = {
          id_os: Number(osData.id_os),
          custo_total_pecas_real: totalCusto,
        };
        if (osData.fechamento_financeiro) {
          await api.put(
            `/fechamento-financeiro/${osData.fechamento_financeiro.id_fechamento_financeiro}`,
            fechamentoPayload,
          );
        } else {
          await api.post("/fechamento-financeiro", fechamentoPayload);
        }

        // Validation: Check Revenue
        const totalPago =
          osData.pagamentos_cliente?.reduce(
            (acc, p) => (p.deleted_at ? acc : acc + Number(p.valor)),
            0,
          ) || 0;
        if (totalPago === 0) {
          setStatusMsg({
            type: "error",
            text: "Aviso: Nenhum recebimento registrado.",
          });
        }

        if (osData.status !== "FINALIZADA") {
          await api.put(`/ordem-de-servico/${osData.id_os}`, {
            status: "FINALIZADA",
            valor_final: totalReceita,
            valor_pecas: totalItemsRevenue,
          });
        }
        setStatusMsg({ type: "success", text: "OS Finalizada com Sucesso!" });
        setIsDirty(false);
        setTimeout(() => navigate("/fechamento-financeiro"), 1000);
      } else {
        setStatusMsg({ type: "success", text: "Dados Salvos!" });
        setIsDirty(false);
        // Refresh data
        fetchOsData(osData.id_os);
      }
    } catch (error: any) {
      console.error(error);
      setStatusMsg({ type: "error", text: error.message || "Erro ao salvar." });
    } finally {
      setLoading(false);
    }
  };

  const getClientName = () =>
    osData?.cliente?.pessoa_fisica?.pessoa?.nome ||
    osData?.cliente?.pessoa_juridica?.nome_fantasia ||
    "Cliente";

  const getStatusStyle = (st: string) => {
    switch (st) {
      case "FINALIZADA":
        return "bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200";
      case "PAGA_CLIENTE":
        return "bg-neutral-100 text-neutral-600 ring-1 ring-neutral-200";
      case "PRONTO PARA FINANCEIRO":
        return "bg-amber-100 text-amber-700 ring-1 ring-amber-200";
      case "ABERTA":
        return "bg-blue-100 text-blue-700 ring-1 ring-blue-200";
      case "EM_ANDAMENTO":
        return "bg-cyan-100 text-cyan-700 ring-1 ring-cyan-200";
      default:
        return "bg-gray-50 text-gray-500 ring-1 ring-gray-200";
    }
  };

  // --- RENDER ---
  if (fetchingOs)
    return (
      <div className="p-10 text-center text-neutral-500">
        Carregando detalhes...
      </div>
    );
  if (!osData)
    return (
      <div className="p-10 text-center text-neutral-500">
        OS n√£o encontrada.
      </div>
    );

  return (
    <div className="space-y-6 pb-20">
      {statusMsg.text && (
        <div className="fixed bottom-8 right-8 z-60 animate-in fade-in slide-in-from-bottom-5">
          <StatusBanner
            msg={statusMsg}
            onClose={() => setStatusMsg({ type: null, text: "" })}
          />
        </div>
      )}

      {blocker.state === "blocked" && (
        <Modal
          title="Salvar Altera√ß√µes?"
          onClose={() => blocker.reset && blocker.reset()}
        >
          <div className="space-y-4">
            <p className="text-neutral-600">
              Voc√™ tem altera√ß√µes n√£o salvas. Deseja salvar antes de sair?
            </p>
            <div className="flex gap-2 justify-end">
              <Button
                variant="secondary"
                onClick={() => blocker.proceed && blocker.proceed()}
              >
                Descartar e Sair
              </Button>
              <Button
                variant="primary"
                onClick={async () => {
                  await handleSave(false);
                  blocker.proceed && blocker.proceed();
                }}
              >
                Salvar e Sair
              </Button>
            </div>
          </div>
        </Modal>
      )}

      {/* HEADER */}
      <div className="flex items-center gap-4">
        <button
          onClick={() => navigate(-1)}
          className="p-2 hover:bg-neutral-100 rounded-lg transition-colors text-neutral-600"
        >
          <ArrowLeft size={24} />
        </button>
        <div className="flex-1">
          <div className="flex items-center gap-3">
            <h1 className="text-2xl font-bold text-neutral-900 tracking-tight">
              Fechamento Financeiro
            </h1>
            <span className="text-neutral-400 font-medium">
              OS #{osData.id_os}
            </span>
            <span
              className={`px-3 py-1 rounded-md text-[10px] font-black uppercase whitespace-nowrap ${getStatusStyle(osData.status)}`}
            >
              {osData.status === "PRONTO PARA FINANCEIRO"
                ? "FINANCEIRO"
                : osData.status.replace(/_/g, " ")}
            </span>
            {isDirty && (
              <span className="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full font-bold flex items-center gap-1">
                <AlertCircle size={10} /> Altera√ß√µes Pendentes
              </span>
            )}
          </div>
        </div>
      </div>

      <div className="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          {/* Col 1: Vehicle */}
          <div className="space-y-1">
            <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-wider">
              Ve√≠culo
            </p>
            <div className="flex flex-col">
              <h3 className="text-2xl font-bold text-neutral-600 leading-none tracking-tight">
                {osData.veiculo?.modelo} - {osData.veiculo?.cor || "Cor N/I"}
              </h3>
              <div className="flex items-center gap-2 mt-1">
                <span className="text-sm font-bold text-primary-600 uppercase tracking-widest  px-2 py-0.5 rounded-md">
                  {osData.veiculo?.placa}
                </span>
              </div>
            </div>
          </div>

          {/* Col 2: Client */}
          <div className="md:border-l md:border-gray-100 md:pl-8">
            <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">
              Cliente
            </p>
            <h3 className="font-bold text-gray-800 text-lg leading-tight mb-1">
              {getClientName()}
            </h3>
            <p className="text-gray-600 font-medium text-sm flex items-center gap-2">
              <Phone size={14} className="text-gray-400" />
              {osData.cliente.telefone_1 || "Sem telefone"}
            </p>
          </div>

          {/* Col 3: Defect / Diagnosis */}
          <div className="md:border-l md:border-gray-100 md:pl-8 space-y-4">
            <div>
              <p className="text-[10px] font-bold text-gray-400 uppercase mb-1">
                Defeito
              </p>
              <p className="text-sm font-medium text-gray-700 leading-snug">
                {osData.defeito_relatado || (
                  <span className="text-gray-300 italic">N√£o informado</span>
                )}
              </p>
            </div>
            <div>
              <p className="text-[10px] font-bold text-gray-400 uppercase mb-1">
                Diagn√≥stico
              </p>
              <p className="text-sm font-medium text-blue-700 leading-snug">
                {osData.diagnostico || (
                  <span className="text-gray-300 italic">N√£o informado</span>
                )}
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* LABOR MANAGER (Separated) */}
      <div className="mt-4 border border-blue-100 rounded-xl overflow-hidden text-left bg-blue-50/30">
        <div className="px-4 py-2 bg-blue-50/50 border-b border-blue-100 flex justify-between items-center">
          <span className="text-xs font-black uppercase text-blue-600 flex items-center gap-2">
            <BadgeCheck size={14} /> M√£o de Obra (Execu√ß√£o)
          </span>
        </div>
        <div className="p-3">
          <LaborManager
            osId={osData.id_os}
            mode="api"
            employees={employees}
            initialData={osData.servicos_mao_de_obra as any[]}
            onChange={() => {
              fetchOsData(osData.id_os);
              setIsDirty(true);
            }}
            readOnly={false}
            onTotalChange={handleLaborTotalChange}
          />
        </div>
      </div>

      {/* PARTS COSTS */}
      <div className="border border-gray-200 rounded-2xl overflow-hidden bg-white shadow-sm">
        <div className="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
          <h4 className="font-bold text-sm text-gray-700 uppercase tracking-wide">
            Custos de Pe√ßas (Fornecedores)
          </h4>
          <button
            type="button"
            onClick={() => setShowFornecedorModal(true)}
            className="text-[10px] font-black uppercase text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100 transition-colors flex items-center gap-1"
          >
            <Plus size={12} /> Novo Fornecedor
          </button>
        </div>
        <table className="w-full text-left">
          <thead className="bg-gray-50/50 text-xs font-bold text-gray-400 uppercase">
            <tr>
              <th className="p-4 w-1/3">Pe√ßa</th>
              <th className="p-4">Ref / Nota</th>
              <th className="p-4">Fornecedor</th>
              <th className="p-4 w-44">Custo (R$)</th>
              <th className="p-4 text-center w-20">A√ß√µes</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100">
            {osData.itens_os.map((item) => (
              <tr
                key={item.id_iten}
                className="hover:bg-gray-50/50 transition-colors group"
              >
                <td className="p-4 relative">
                  <div className="flex justify-between items-start">
                    <div>
                      <p className="font-bold text-gray-800 text-sm">
                        {item.descricao}
                      </p>
                      <p className="text-xs text-gray-400">
                        Qtd: {item.quantidade} x{" "}
                        {formatCurrency(
                          Number(item.valor_total) / item.quantidade,
                        )}{" "}
                        ={" "}
                        <span className="text-green-600 font-bold">
                          {formatCurrency(Number(item.valor_total))}
                        </span>
                      </p>
                    </div>
                  </div>
                </td>
                <td className="p-4 text-xs font-mono font-bold text-gray-500">
                  {item.codigo_referencia || "-"}
                </td>
                <td className="p-4">
                  {item.pecas_estoque || item.id_pecas_estoque ? (
                    <div className="flex items-center gap-2 px-3 py-2 bg-neutral-100 rounded-lg border border-neutral-200 text-neutral-500 font-bold text-xs uppercase tracking-wider justify-center">
                      <Truck size={14} /> Estoque Pr√≥prio
                    </div>
                  ) : (
                    <select
                      className="w-full p-2.5 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 outline-none focus:ring-2 focus:ring-blue-500"
                      value={itemsState[item.id_iten]?.id_fornecedor || ""}
                      onChange={(e) =>
                        handleItemChange(
                          item.id_iten,
                          "id_fornecedor",
                          e.target.value,
                        )
                      }
                    >
                      <option value="">-- Selecione --</option>
                      {fornecedores.map((f) => (
                        <option key={f.id_fornecedor} value={f.id_fornecedor}>
                          {f.nome}
                        </option>
                      ))}
                    </select>
                  )}
                </td>
                <td className="p-4">
                  {item.pecas_estoque || item.id_pecas_estoque ? (
                    <div className="opacity-50">
                      <div className="flex items-center border border-gray-200 rounded-lg bg-gray-50 px-3 py-2 w-full">
                        <span className="text-gray-400 text-xs font-bold mr-2">
                          R$
                        </span>
                        <input
                          disabled
                          value="0.00"
                          className="w-full bg-transparent text-sm font-bold text-gray-400 cursor-not-allowed outline-none"
                        />
                      </div>
                      <div className="text-[9px] text-gray-400 mt-1 text-center font-medium">
                        {item.pecas_estoque
                          ? `Custo Orig: ${formatCurrency(Number(item.pecas_estoque.valor_custo))}`
                          : "Estoque"}
                      </div>
                    </div>
                  ) : (
                    <div className="flex items-center border border-gray-200 rounded-lg bg-white px-3 py-2 w-full focus-within:ring-2 focus-within:ring-red-500 focus-within:border-transparent transition-all shadow-sm">
                      <span className="text-gray-400 text-xs font-bold mr-2">
                        R$
                      </span>
                      <input
                        type="number"
                        step="0.01"
                        value={itemsState[item.id_iten]?.custo_real}
                        onChange={(e) =>
                          handleItemChange(
                            item.id_iten,
                            "custo_real",
                            e.target.value,
                          )
                        }
                        onBlur={(e) => {
                          const val = parseFloat(e.target.value);
                          if (!isNaN(val))
                            handleItemChange(
                              item.id_iten,
                              "custo_real",
                              val.toFixed(2),
                            );
                        }}
                        className="w-full text-sm font-bold text-red-600 outline-none placeholder-gray-300"
                        placeholder="0.00"
                      />
                    </div>
                  )}
                </td>
                <td className="p-4 text-center">
                  <div className="flex items-center justify-center gap-1">
                    <ActionButton
                      icon={Edit}
                      label="Editar"
                      onClick={() => handleOpenEditItem(item)}
                      variant="neutral"
                    />
                    <ActionButton
                      icon={Trash2}
                      label="Excluir"
                      onClick={() => handleDeleteItemOS(item.id_iten)}
                      variant="danger"
                    />
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* RECEBIMENTOS */}
      <div className="border border-green-200 rounded-2xl overflow-hidden bg-white shadow-sm">
        <div className="bg-green-50 px-4 py-3 border-b border-green-200 flex justify-between items-center">
          <h4 className="font-bold text-sm text-green-800 uppercase tracking-wide">
            Recebimentos
          </h4>
          <button
            type="button"
            onClick={() => setPaymentModal({ isOpen: true, data: null })}
            className="text-[10px] font-black uppercase text-green-700 bg-white border border-green-200 px-3 py-1.5 rounded-lg hover:bg-green-100 transition-colors flex items-center gap-1"
          >
            <Plus size={12} /> Novo Pagamento
          </button>
        </div>
        <div className="p-4">
          {/* Using a simplified list here or reuse Table logic */}
          {osData.pagamentos_cliente?.filter((p) => !p.deleted_at).length ===
          0 ? (
            <p className="text-gray-400 text-sm text-center">
              Nenhum recebimento.
            </p>
          ) : (
            <div className="space-y-2">
              {osData.pagamentos_cliente
                ?.filter((p) => !p.deleted_at)
                .map((pag) => (
                  <div
                    key={pag.id_pagamento_cliente}
                    className="flex justify-between items-center bg-green-50/50 p-2 rounded-lg text-sm border border-green-100 group"
                  >
                    <span className="font-bold text-green-800">
                      {formatCurrency(Number(pag.valor))}
                    </span>
                    <span className="text-gray-500">
                      {pag.metodo_pagamento} -{" "}
                      {new Date(pag.data_pagamento).toLocaleDateString()}
                    </span>
                    <div className="flex gap-2">
                      <button
                        onClick={() =>
                          setPaymentModal({ isOpen: true, data: pag })
                        }
                        className="text-neutral-400 hover:text-blue-600"
                      >
                        <Edit size={14} />
                      </button>
                      <button
                        onClick={() =>
                          handleDeletePayment(pag.id_pagamento_cliente)
                        }
                        className="text-neutral-400 hover:text-red-600"
                      >
                        <Trash2 size={14} />
                      </button>
                    </div>
                  </div>
                ))}
            </div>
          )}
        </div>
      </div>

      {/* BOTTOM SUMMARY CARD */}
      <div className="bg-neutral-900 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
        <div className="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/2 blur-2xl"></div>
        <div className="relative z-10 grid grid-cols-1 md:grid-cols-4 gap-6 items-center">
          <div>
            <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest mb-1">
              Total Pe√ßas
            </p>
            <p className="text-2xl font-black text-white">
              {formatCurrency(totalItemsRevenue)}
            </p>
            <p className="text-[10px] font-bold text-emerald-400 mt-1">
              Ref: {formatCurrency(Number(totalItemsRevenue) - totalItemsCost)}
            </p>
          </div>
          <div>
            <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest mb-1">
              Total M√£o de Obra
            </p>
            <p className="text-2xl font-black text-white">
              {formatCurrency(totalLaborRevenue)}
            </p>
          </div>
          <div>
            <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest mb-1">
              Total Geral
            </p>
            <p className="text-3xl font-black text-white">
              {formatCurrency(totalReceita)}
            </p>
          </div>
          <div className="text-right">
            <div
              className={`inline-block px-4 py-2 rounded-xl font-black uppercase text-xs tracking-wider ${
                (osData.pagamentos_cliente?.reduce(
                  (acc, p) => (p.deleted_at ? acc : acc + Number(p.valor)),
                  0,
                ) || 0) >= totalReceita
                  ? "bg-emerald-500 text-emerald-950"
                  : "bg-amber-500 text-amber-950"
              }`}
            >
              {(osData.pagamentos_cliente?.reduce(
                (acc, p) => (p.deleted_at ? acc : acc + Number(p.valor)),
                0,
              ) || 0) >= totalReceita
                ? "QUITADO"
                : "PENDENTE"}
            </div>
          </div>
        </div>
      </div>

      {/* ACTIONS (Inline now) */}
      <div className="flex justify-end gap-3 pt-6 border-t border-gray-100">
        <Button variant="secondary" onClick={() => navigate(-1)}>
          Voltar
        </Button>

        <Button
          onClick={() => handleSave(false)}
          variant="primary"
          isLoading={loading}
        >
          <Save size={18} className="mr-2" /> Salvar Altera√ß√µes
        </Button>

        <Button
          onClick={() => handleSave(true)}
          variant="success"
          isLoading={loading}
        >
          <BadgeCheck size={18} className="mr-2" /> Salvar e Consolidar
        </Button>
      </div>

      {/* MODALS */}
      {showFornecedorModal && (
        <Modal
          title="Novo Fornecedor"
          onClose={() => setShowFornecedorModal(false)}
        >
          <FornecedorForm
            onSuccess={() => {
              setShowFornecedorModal(false);
              loadFornecedores();
            }}
            onCancel={() => setShowFornecedorModal(false)}
          />
        </Modal>
      )}
      {paymentModal.isOpen && osData && (
        <Modal
          title={paymentModal.data ? "Editar Pagamento" : "Novo Pagamento"}
          onClose={() => setPaymentModal({ isOpen: false, data: null })}
        >
          <PagamentoClienteForm
            osId={osData.id_os}
            valorTotal={
              totalReceita -
              (osData.pagamentos_cliente
                ?.filter((p) => !p.deleted_at)
                .reduce((acc, p) => acc + Number(p.valor), 0) || 0) +
              (paymentModal.data ? Number(paymentModal.data.valor) : 0)
            }
            initialData={paymentModal.data}
            onSuccess={() => {
              setPaymentModal({ isOpen: false, data: null });
              fetchOsData(osData.id_os);
            }}
            onCancel={() => setPaymentModal({ isOpen: false, data: null })}
          />
        </Modal>
      )}

      {/* Edit Item Modal */}
      {editItemModal.isOpen && (
        <Modal
          title="Editar Item OS"
          onClose={() => setEditItemModal({ isOpen: false, item: null })}
        >
          <div className="space-y-4">
            <div>
              <label className="block text-xs font-bold text-gray-500 uppercase mb-1">
                Descri√ß√£o
              </label>
              <input
                type="text"
                value={editItemForm.descricao}
                onChange={(e) =>
                  setEditItemForm({
                    ...editItemForm,
                    descricao: e.target.value,
                  })
                }
                className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">
                  Quantidade
                </label>
                <input
                  type="number"
                  value={editItemForm.quantidade}
                  onChange={(e) =>
                    setEditItemForm({
                      ...editItemForm,
                      quantidade: Number(e.target.value),
                    })
                  }
                  className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div>
                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">
                  Valor Unit. Venda
                </label>
                <input
                  type="number"
                  step="0.1"
                  value={editItemForm.valor_venda}
                  onChange={(e) =>
                    setEditItemForm({
                      ...editItemForm,
                      valor_venda: Number(e.target.value),
                    })
                  }
                  className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>
            <div>
              <label className="block text-xs font-bold text-gray-500 uppercase mb-1">
                Ref / Nota
              </label>
              <input
                type="text"
                value={editItemForm.codigo_referencia}
                onChange={(e) =>
                  setEditItemForm({
                    ...editItemForm,
                    codigo_referencia: e.target.value,
                  })
                }
                className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Opcional"
              />
            </div>
            <div className="pt-2 flex justify-end gap-2">
              <Button
                variant="secondary"
                onClick={() => setEditItemModal({ isOpen: false, item: null })}
              >
                Cancelar
              </Button>
              <Button variant="primary" onClick={handleSaveEditItem}>
                Salvar
              </Button>
            </div>
          </div>
        </Modal>
      )}

      {confirmModal.isOpen && (
        <Modal
          title={confirmModal.title}
          onClose={() =>
            setConfirmModal((prev) => ({ ...prev, isOpen: false }))
          }
        >
          <p className="mb-6">{confirmModal.message}</p>
          <div className="flex justify-end gap-2">
            <Button
              variant="secondary"
              onClick={() =>
                setConfirmModal((prev) => ({ ...prev, isOpen: false }))
              }
            >
              Cancelar
            </Button>
            <Button variant="danger" onClick={confirmModal.onConfirm}>
              Confirmar
            </Button>
          </div>
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\FechamentoFinanceiroPage.tsx
================================================================================
import { useState, useEffect } from "react";
import { formatCurrency } from "../utils/formatCurrency";
import { api } from "../services/api";
import { ActionButton } from "../components/ui/ActionButton";
import { Button } from "../components/ui/Button";
import { Input } from "../components/ui/input";
import { Modal } from "../components/ui/Modal";
import { Search, Trash2, Edit, CheckCircle } from "lucide-react";
import { useLocation, useNavigate } from "react-router-dom";
import { StatusBanner } from "../components/ui/StatusBanner";

interface IFechamentoFinanceiro {
  id_fechamento_financeiro: number;
  id_os: number;
  custo_total_pecas_real: number;
  data_fechamento_financeiro: string;
  ordem_de_servico: IOS;
}

interface IOS {
  id_os: number;
  status: string;
  valor_total_cliente: number;
  cliente: {
    pessoa_fisica?: { pessoa: { nome: string } };
    pessoa_juridica?: { nome_fantasia: string; razao_social: string };
    telefone_1?: string;
  };
  veiculo: {
    placa: string;
    marca?: string;
    modelo: string;
    cor: string;
  };
  fechamento_financeiro?: IFechamentoFinanceiro;
  servicos_mao_de_obra?: {
    funcionario: {
      pessoa_fisica: {
        pessoa: {
          nome: string;
        };
      };
    };
  }[];
  defeito_relatado?: string;
  diagnostico?: string;
}

export const FechamentoFinanceiroPage = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const [fechamentos, setFechamentos] = useState<IFechamentoFinanceiro[]>([]);
  const [pendingOss, setPendingOss] = useState<IOS[]>([]);
  // Removed showModal state
  // Removed selectedOsId state
  const [searchTerm, setSearchTerm] = useState("");
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });
  const [confirmModal, setConfirmModal] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    onConfirm: () => void;
  }>({ isOpen: false, title: "", message: "", onConfirm: () => {} });

  // Date Filters
  const [activeFilter, setActiveFilter] = useState<
    "TODAY" | "WEEK" | "MONTH" | "CUSTOM"
  >("WEEK");

  const [filterStart, setFilterStart] = useState(() => {
    const now = new Date();
    const weekAgo = new Date(now);
    weekAgo.setDate(now.getDate() - 7);
    return weekAgo.toLocaleDateString("en-CA");
  });

  const [filterEnd, setFilterEnd] = useState(() => {
    return new Date().toLocaleDateString("en-CA");
  });

  useEffect(() => {
    loadData();
  }, []);

  useEffect(() => {
    const params = new URLSearchParams(location.search);
    const urlIdOs = params.get("id_os");
    if (urlIdOs) {
      handleOpenFechamento(Number(urlIdOs));
    }
  }, [location.search]);

  const loadData = async () => {
    try {
      const [fechamentosRes, osRes] = await Promise.all([
        api.get("/fechamento-financeiro"),
        api.get("/ordem-de-servico"),
      ]);

      setFechamentos(fechamentosRes.data);

      const allOss = osRes.data;
      // Filter OSs: Em Andamento, Aberta, Pronto Para Financeiro (and Finalizada if pending logic applies, usually Finalizada has fechamento)
      // But if Finalizada DOES NOT have Fechamento, we show it too.
      const pending = allOss.filter(
        (os: IOS) =>
          [
            "ABERTA",
            "EM_ANDAMENTO",
            "PRONTO PARA FINANCEIRO",
            "FINALIZADA",
          ].includes(os.status) &&
          !os.fechamento_financeiro &&
          !fechamentosRes.data.some(
            (f: IFechamentoFinanceiro) => f.id_os === os.id_os,
          ),
      );
      setPendingOss(pending);
    } catch (error) {
      console.error("Erro ao carregar dados", error);
      setStatusMsg({
        type: "error",
        text: "Erro ao carregar dados financeiros",
      });
    }
  };

  const handleOpenFechamento = (id_os: number) => {
    navigate(`/fechamento-financeiro/${id_os}`);
  };

  const handleEditFechamento = (fechamento: IFechamentoFinanceiro) => {
    navigate(`/fechamento-financeiro/${fechamento.id_os}`);
  };

  const handleDelete = async (id: number) => {
    setConfirmModal({
      isOpen: true,
      title: "Cancelar Fechamento",
      message:
        "Tem certeza que deseja cancelar este fechamento financeiro? Isso n√£o apaga a OS, apenas a consolida√ß√£o.",
      onConfirm: async () => {
        try {
          await api.delete(`/fechamento-financeiro/${id}`);
          setStatusMsg({
            type: "success",
            text: "Fechamento cancelado com sucesso!",
          });
          loadData();
          setConfirmModal((prev) => ({ ...prev, isOpen: false }));
        } catch (error) {
          setStatusMsg({ type: "error", text: "Erro ao deletar fechamento" });
        }
      },
    });
  };

  const getClientName = (os: IOS) => {
    return (
      os.cliente?.pessoa_fisica?.pessoa?.nome ||
      os.cliente?.pessoa_juridica?.nome_fantasia ||
      os.cliente?.pessoa_juridica?.razao_social ||
      "Cliente N/I"
    );
  };

  const applyQuickFilter = (type: "TODAY" | "WEEK" | "MONTH") => {
    setActiveFilter(type);
    const now = new Date();
    const todayStr = now.toLocaleDateString("en-CA");

    if (type === "TODAY") {
      setFilterStart(todayStr);
      setFilterEnd(todayStr);
    } else if (type === "WEEK") {
      const weekAgo = new Date(now);
      weekAgo.setDate(now.getDate() - 7);
      setFilterStart(weekAgo.toLocaleDateString("en-CA"));
      setFilterEnd(todayStr);
    } else if (type === "MONTH") {
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      setFilterStart(firstDay.toLocaleDateString("en-CA"));
      setFilterEnd(todayStr);
    }
  };

  const filteredFechamentos = fechamentos
    .filter((f) => {
      if (filterStart) {
        const recordDate = new Date(f.data_fechamento_financeiro);
        const recordDateLocal = recordDate.toLocaleDateString("en-CA");
        if (recordDateLocal < filterStart) return false;
      }
      if (filterEnd) {
        const recordDate = new Date(f.data_fechamento_financeiro);
        const recordDateLocal = recordDate.toLocaleDateString("en-CA");
        if (recordDateLocal > filterEnd) return false;
      }

      if (!searchTerm) return true;
      const q = searchTerm.toLowerCase();

      const id = String(f.id_fechamento_financeiro);
      const fullId = `#${id}`;
      const osId = String(f.id_os);
      const fullOsId = `#${osId}`;
      const plate = f.ordem_de_servico?.veiculo?.placa?.toLowerCase() || "";
      const model = f.ordem_de_servico?.veiculo?.modelo?.toLowerCase() || "";
      const color = f.ordem_de_servico?.veiculo?.cor?.toLowerCase() || "";

      return [id, fullId, osId, fullOsId, plate, model, color]
        .join(" ")
        .includes(q);
    })
    .sort((a, b) => b.id_fechamento_financeiro - a.id_fechamento_financeiro);

  const getStatusStyle = (status: string) => {
    switch (status) {
      case "FINALIZADA":
        return "bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200";
      case "PAGA_CLIENTE":
        return "bg-neutral-100 text-neutral-600 ring-1 ring-neutral-200";
      case "PRONTO PARA FINANCEIRO":
        return "bg-amber-100 text-amber-700 ring-1 ring-amber-200";
      case "ABERTA":
        return "bg-blue-100 text-blue-700 ring-1 ring-blue-200";
      case "EM_ANDAMENTO":
        return "bg-cyan-100 text-cyan-700 ring-1 ring-cyan-200";
      default:
        return "bg-gray-50 text-gray-500 ring-1 ring-gray-200";
    }
  };

  return (
    <div className="w-full max-w-[1440px] mx-auto px-4 md:px-8 py-6 space-y-6 animate-in fade-in duration-500">
      <StatusBanner
        msg={statusMsg}
        onClose={() => setStatusMsg({ type: null, text: "" })}
      />

      {/* HEADER */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl font-bold text-neutral-500">Consolida√ß√£o</h1>
          <p className="text-neutral-500">Consolida√ß√£o de custos e servi√ßos.</p>
        </div>
      </div>

      {/* PENDING OS LIST */}
      <div className="space-y-4">
        <h2 className="text-xl font-bold text-neutral-600 flex items-center gap-2">
          <span className="w-2 h-8 bg-orange-500 rounded-full"></span>
          Aguardando Consolida√ß√£o
        </h2>

        {pendingOss.length === 0 ? (
          <div className="bg-surface p-8 rounded-xl border border-neutral-200 text-center text-neutral-400 italic font-medium">
            Nenhum fechamento pendente
          </div>
        ) : (
          <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full text-left border-collapse">
                <thead>
                  <tr className="bg-neutral-50 border-b border-neutral-200 text-xs uppercase tracking-wider text-neutral-500 font-semibold">
                    <th className="p-4">OS</th>
                    <th className="p-4">Cliente</th>
                    <th className="p-4">Ve√≠culo</th>
                    <th className="p-4 w-1/4">Defeito / Diagn√≥stico</th>
                    <th className="p-4 text-center">Status</th>
                    <th className="p-4 text-right">A√ß√£o</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-neutral-100">
                  {pendingOss.map((os) => (
                    <tr
                      key={os.id_os}
                      className="hover:bg-neutral-25 transition-colors"
                    >
                      <td className="p-4 font-bold text-neutral-600">
                        #{os.id_os}
                      </td>
                      <td className="p-4 text-neutral-600 font-medium text-sm">
                        <div className="font-bold text-neutral-700 text-sm truncate max-w-[150px]">
                          {getClientName(os)}
                        </div>
                        <div className="text-[12px] text-neutral-400 font-medium">
                          {os.cliente?.telefone_1 || "Sem telefone"}
                        </div>
                      </td>
                      <td className="p-4">
                        <div className="flex flex-col">
                          <span className="font-bold text-neutral-700 tracking-tight text-sm uppercase">
                            {os.veiculo?.marca} {os.veiculo?.modelo} -{" "}
                            {os.veiculo?.cor}
                          </span>
                          <span className="text-[14px] text-primary-500 font-bold uppercase">
                            {os.veiculo?.placa || "Placa N/I"}
                          </span>
                        </div>
                      </td>
                      <td className="p-4">
                        <div className="flex flex-col gap-2 max-w-xs transition-opacity hover:opacity-100 opacity-80">
                          <div className="leading-tight">
                            <span className="text-[10px] font-bold text-neutral-600 uppercase block">
                              Defeito
                            </span>
                            <span
                              className="text-xs text-primary-500 font-medium line-clamp-2"
                              title={os.defeito_relatado}
                            >
                              {os.defeito_relatado || "-"}
                            </span>
                          </div>
                          <div className="leading-tight">
                            <span className="text-[10px] font-bold text-neutral-600 uppercase block">
                              Diagn√≥stico
                            </span>
                            <span
                              className="text-xs text-primary-500 font-medium line-clamp-2"
                              title={os.diagnostico}
                            >
                              {os.diagnostico || "-"}
                            </span>
                          </div>
                        </div>
                      </td>
                      <td className="p-4 text-center">
                        <span
                          className={`px-3 py-1 rounded-md text-[10px] font-bold uppercase whitespace-nowrap ${getStatusStyle(os.status)}`}
                        >
                          {os.status === "PRONTO PARA FINANCEIRO"
                            ? "FINANCEIRO"
                            : os.status.replace(/_/g, " ")}
                        </span>
                      </td>
                      <td className="p-4 text-right">
                        <div className="flex items-center justify-end gap-2">
                          <Button
                            onClick={() => handleOpenFechamento(os.id_os)}
                            variant="primary"
                            size="sm"
                            icon={CheckCircle}
                          >
                            Fechar Financeiro
                          </Button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>

      {/* HISTORY LIST */}
      <div className="space-y-4">
        <h2 className="text-xl font-bold text-neutral-600 flex items-center gap-2">
          <span className="w-2 h-8 bg-green-600 rounded-full"></span>
          Hist√≥rico de Fechamentos
        </h2>

        {/* FILTERS & SEARCH */}
        <div className="bg-surface p-4 rounded-xl shadow-sm border border-neutral-200 flex flex-col md:flex-row items-center justify-between gap-4">
          <div className="flex-1 w-full relative">
            <Input
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              placeholder="Buscar por ID ou Placa..."
              icon={Search}
            />
          </div>

          <div className="flex items-center gap-2 overflow-x-auto pb-2 md:pb-0">
            {/* Quick Filters Group */}
            <div className="flex bg-neutral-100 p-1 rounded-xl shrink-0">
              <button
                onClick={() => applyQuickFilter("TODAY")}
                className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                  activeFilter === "TODAY"
                    ? "bg-primary-200 text-primary-500 shadow-sm"
                    : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
                }`}
              >
                Hoje
              </button>
              <button
                onClick={() => applyQuickFilter("WEEK")}
                className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                  activeFilter === "WEEK"
                    ? "bg-primary-200 text-primary-500 shadow-sm"
                    : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
                }`}
              >
                Semana
              </button>
              <button
                onClick={() => applyQuickFilter("MONTH")}
                className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                  activeFilter === "MONTH"
                    ? "bg-primary-200 text-primary-500 shadow-sm"
                    : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
                }`}
              >
                M√™s
              </button>
            </div>

            {/* Manual Date Inputs */}
            <div className="flex gap-2 items-center">
              <input
                type="date"
                value={filterStart}
                onChange={(e) => {
                  setFilterStart(e.target.value);
                  setActiveFilter("CUSTOM");
                }}
                className={`h-10 px-3 rounded-lg border text-xs font-bold bg-white focus:outline-none focus:ring-2 focus:ring-primary-200 transition-colors ${
                  activeFilter === "CUSTOM"
                    ? "border-primary-300 text-primary-700"
                    : "border-neutral-200 text-neutral-600"
                }`}
              />
              <span className="text-neutral-400 self-center">-</span>
              <input
                type="date"
                value={filterEnd}
                onChange={(e) => {
                  setFilterEnd(e.target.value);
                  setActiveFilter("CUSTOM");
                }}
                className={`h-10 px-3 rounded-lg border text-xs font-bold bg-white focus:outline-none focus:ring-2 focus:ring-primary-200 transition-colors ${
                  activeFilter === "CUSTOM"
                    ? "border-primary-300 text-primary-700"
                    : "border-neutral-200 text-neutral-600"
                }`}
              />
            </div>
          </div>
        </div>

        <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden min-h-[300px]">
          <div className="overflow-x-auto">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr className="bg-neutral-50 border-b border-neutral-200 text-xs uppercase tracking-wider text-neutral-500 font-semibold">
                  <th className="p-4">OS</th>
                  <th className="p-4">Cliente</th>
                  <th className="p-4">Ve√≠culo (Placa/Cor)</th>
                  <th className="p-4">Valor Servi√ßo</th>
                  <th className="p-4">M√£o de Obra (Execu√ß√£o)</th>
                  <th className="p-4">Data</th>
                  <th className="p-4 text-right">A√ß√µes</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-neutral-100">
                {filteredFechamentos.length === 0 ? (
                  <tr>
                    <td
                      colSpan={6}
                      className="p-12 text-center text-neutral-500"
                    >
                      <div className="flex flex-col items-center gap-4">
                        <p className="font-bold text-neutral-400 mb-2">
                          {searchTerm || filterStart
                            ? "Nenhum registro encontrado para a busca."
                            : "Nenhum fechamento realizado ainda."}
                        </p>
                      </div>
                    </td>
                  </tr>
                ) : (
                  filteredFechamentos.map((fech) => (
                    <tr
                      key={fech.id_fechamento_financeiro}
                      className="hover:bg-neutral-25 transition-colors"
                    >
                      <td className="p-4">
                        <span className="font-bold text-neutral-600 px-2 py-1 rounded text-sm">
                          #{fech.id_os}
                        </span>
                      </td>
                      <td className="p-4">
                        <div className="font-bold text-neutral-700 text-sm truncate max-w-[150px]">
                          {getClientName(fech.ordem_de_servico)}
                        </div>
                        <div className="text-[12px] text-neutral-400 font-medium">
                          {fech.ordem_de_servico?.cliente?.telefone_1 ||
                            "Sem telefone"}
                        </div>
                      </td>
                      <td className="p-4">
                        <div className="flex flex-col">
                          <span className="font-bold text-neutral-700 tracking-tight text-sm uppercase">
                            {fech.ordem_de_servico?.veiculo?.marca}{" "}
                            {fech.ordem_de_servico?.veiculo?.modelo} -{" "}
                            {fech.ordem_de_servico?.veiculo?.cor}
                          </span>
                          <span className="text-[14px] text-primary-500 font-bold uppercase">
                            {fech.ordem_de_servico?.veiculo?.placa ||
                              "Placa N/I"}
                          </span>
                        </div>
                      </td>
                      <td className="p-4">
                        <div className="flex items-center gap-1 text-primary-600 font-bold bg-primary-50 w-fit px-3 py-1 rounded-lg">
                          {formatCurrency(
                            Number(
                              fech.ordem_de_servico?.valor_total_cliente || 0,
                            ),
                          )}
                        </div>
                      </td>
                      <td className="p-4">
                        <div className="flex flex-wrap gap-1">
                          {fech.ordem_de_servico?.servicos_mao_de_obra &&
                          fech.ordem_de_servico.servicos_mao_de_obra.length >
                            0 ? (
                            Array.from(
                              new Set(
                                fech.ordem_de_servico.servicos_mao_de_obra
                                  .map(
                                    (svc) =>
                                      svc.funcionario?.pessoa_fisica?.pessoa?.nome?.split(
                                        " ",
                                      )[0],
                                  )
                                  .filter(Boolean),
                              ),
                            ).map((name, idx) => (
                              <span
                                key={idx}
                                className="text-xs font-bold text-neutral-600 bg-neutral-100 px-2 py-0.5 rounded"
                              >
                                {name}
                              </span>
                            ))
                          ) : (
                            <span className="text-xs text-neutral-400 italic">
                              N√£o informado
                            </span>
                          )}
                        </div>
                      </td>
                      <td className="p-4 text-sm font-medium text-neutral-500">
                        {new Date(
                          fech.data_fechamento_financeiro,
                        ).toLocaleDateString("pt-BR")}
                      </td>
                      <td className="p-4 text-right">
                        <div className="flex justify-end gap-1">
                          <ActionButton
                            onClick={() => handleEditFechamento(fech)}
                            icon={Edit}
                            label="Editar"
                            variant="primary"
                          />
                          <ActionButton
                            onClick={() =>
                              handleDelete(fech.id_fechamento_financeiro)
                            }
                            icon={Trash2}
                            label="Cancelar"
                            variant="danger"
                          />
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {confirmModal.isOpen && (
        <Modal
          title={confirmModal.title}
          onClose={() =>
            setConfirmModal((prev) => ({ ...prev, isOpen: false }))
          }
        >
          <p className="mb-6 text-neutral-600">{confirmModal.message}</p>
          <div className="flex justify-end gap-2">
            <Button
              onClick={() =>
                setConfirmModal((prev) => ({ ...prev, isOpen: false }))
              }
              variant="ghost"
              size="md"
            >
              Cancelar
            </Button>
            <Button onClick={confirmModal.onConfirm} variant="danger" size="md">
              Confirmar
            </Button>
          </div>
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\FinanceiroPage.tsx
================================================================================
import { useState, useEffect } from "react";
import { formatCurrency } from "../utils/formatCurrency";
import { useLocation, useNavigate } from "react-router-dom";
import { api } from "../services/api";
import { StatusBanner } from "../components/ui/StatusBanner";
import {
  Search,
  Truck,
  Calendar,
  CheckSquare,
  Square,
  ArrowUpCircle,
  ArrowDownCircle,
  Wallet,
  Edit,
  Filter,
  Trash2,
  Plus,
} from "lucide-react";

import { Modal } from "../components/ui/Modal";

export const FinanceiroPage = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState<
    "AUTO_PECAS" | "LIVRO_CAIXA" | "CONTAS_PAGAR"
  >("LIVRO_CAIXA");
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });
  const [, setLoading] = useState(false);

  // --- STATES FOR ACCOUNTS PAYABLE (PE√áAS) ---
  const [payments, setPayments] = useState<any[]>([]);
  const [fornecedores, setFornecedores] = useState<any[]>([]);
  const [filterSupplier, setFilterSupplier] = useState("");
  const [filterPlate, setFilterPlate] = useState("");
  const [filterStatus, setFilterStatus] = useState<"PENDING" | "PAID" | "ALL">(
    "PENDING",
  );
  const [filterStart, setFilterStart] = useState("");
  const [filterEnd, setFilterEnd] = useState("");

  // --- STATES FOR CASH BOOK (LIVRO CAIXA) ---
  const [cashBookEntries, setCashBookEntries] = useState<any[]>([]);
  const [cashFilterStart, setCashFilterStart] = useState("");
  const [cashFilterEnd, setCashFilterEnd] = useState("");
  const [cashSearch, setCashSearch] = useState("");

  // --- SHARED STATES ---
  const [editPayment, setEditPayment] = useState<any | null>(null);
  const [showEditModal, setShowEditModal] = useState(false);
  const [confirmModal, setConfirmModal] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    onConfirm: () => void;
  }>({ isOpen: false, title: "", message: "", onConfirm: () => {} });

  useEffect(() => {
    const params = new URLSearchParams(location.search);
    const tab = params.get("tab");
    if (tab === "AUTO_PECAS") setActiveTab("AUTO_PECAS");
    else if (tab === "LIVRO_CAIXA") setActiveTab("LIVRO_CAIXA");
    else if (tab === "CONTAS_PAGAR") setActiveTab("CONTAS_PAGAR");

    loadData();
  }, [location.search]);

  const loadData = async () => {
    try {
      setLoading(true);
      const [paymentsRes, fornecedoresRes, inflowsRes] = await Promise.all([
        api.get("/pagamento-peca"),
        api.get("/fornecedor"),
        api.get("/pagamento-cliente"), // Assuming this endpoint exists, need to verify
      ]);

      setPayments(paymentsRes.data);
      setFornecedores(fornecedoresRes.data);

      // Process Cash Book
      // Map Outflows (Payments to Suppliers)
      const outflows = paymentsRes.data
        .filter((p: any) => p.pago_ao_fornecedor && p.data_pagamento_fornecedor) // Only actual paid items count as outflow in cash book? Or simplified view? User said "Control everything that enters and exits"
        .map((p: any) => ({
          id: `out-${p.id_pagamento_peca}`,
          date: p.data_pagamento_fornecedor || p.data_compra,
          description: `Pagamento Fornecedor - ${p.item_os?.descricao || "Pe√ßa"}`,
          type: "OUT",
          value: Number(p.custo_real),
          details: `OS #${p.item_os?.id_os} - ${p.fornecedor?.nome}`,
        }));

      // Map Inflows (Payments from Clients)
      // Need to verify the structure of payment-cliente
      const inflows = (inflowsRes.data || []).map((p: any) => ({
        id: `in-${p.id_pagamento_cliente}`,
        date: p.data_pagamento,
        description: `Recebimento OS #${p.id_os}`,
        type: "IN",
        value: Number(p.valor),
        details: `Forma: ${p.metodo_pagamento}`,
      }));

      const combined = [...outflows, ...inflows].sort(
        (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime(),
      );
      setCashBookEntries(combined);
    } catch (error) {
      console.error(error);
      setStatusMsg({
        type: "error",
        text: "Erro ao carregar dados financeiros.",
      });
    } finally {
      setLoading(false);
    }
  };

  // --- ACTIONS ---
  const handleTogglePayment = async (
    paymentId: number,
    currentStatus: boolean,
  ) => {
    try {
      setLoading(true);
      await api.put(`/pagamento-peca/${paymentId}`, {
        pago_ao_fornecedor: !currentStatus,
        data_pagamento_fornecedor: !currentStatus ? new Date() : null,
      });
      setStatusMsg({
        type: "success",
        text: !currentStatus
          ? "Pagamento marcado como realizado!"
          : "Pagamento reaberto.",
      });
      loadData(); // Reload to update both lists
      setTimeout(() => setStatusMsg({ type: null, text: "" }), 3000);
    } catch (error) {
      setStatusMsg({
        type: "error",
        text: "Erro ao atualizar status do pagamento.",
      });
    } finally {
      setLoading(false);
    }
  };

  const handleDeletePayment = (id: number) => {
    setConfirmModal({
      isOpen: true,
      title: "Excluir Pagamento",
      message:
        "Tem certeza que deseja excluir este registro de conta a pagar? Esta a√ß√£o √© irrevers√≠vel.",
      onConfirm: async () => {
        try {
          setLoading(true);
          await api.delete(`/pagamento-peca/${id}`);
          setStatusMsg({
            type: "success",
            text: "Pagamento exclu√≠do com sucesso!",
          });
          loadData();
        } catch (error) {
          setStatusMsg({ type: "error", text: "Erro ao excluir pagamento." });
        } finally {
          setLoading(false);
          setConfirmModal((prev) => ({ ...prev, isOpen: false }));
        }
      },
    });
  };

  const handleUpdatePayment = async () => {
    if (!editPayment) return;
    try {
      setLoading(true);
      await api.put(`/pagamento-peca/${editPayment.id_pagamento_peca}`, {
        custo_real: Number(editPayment.custo_real),
        id_fornecedor: Number(editPayment.id_fornecedor),
        data_compra: new Date(editPayment.data_compra),
        data_pagamento_fornecedor: editPayment.data_pagamento_fornecedor
          ? new Date(editPayment.data_pagamento_fornecedor)
          : null,
        pago_ao_fornecedor: editPayment.pago_ao_fornecedor,
      });

      // Also update item_os reference if changed
      if (editPayment.item_os && editPayment.ref_nota) {
        await api.put(`/itens-os/${editPayment.item_os.id_iten}`, {
          codigo_referencia: editPayment.ref_nota,
        });
      }

      setStatusMsg({ type: "success", text: "Dados atualizados com sucesso!" });
      loadData();
      setShowEditModal(false);
      setEditPayment(null);
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao atualizar pagamento." });
    } finally {
      setLoading(false);
    }
  };

  const openEditModal = (payment: any) => {
    setEditPayment({
      ...payment,
      data_compra: new Date(payment.data_compra).toISOString().split("T")[0],
      data_pagamento_fornecedor: payment.data_pagamento_fornecedor
        ? new Date(payment.data_pagamento_fornecedor)
            .toISOString()
            .split("T")[0]
        : "",
      ref_nota: payment.item_os?.codigo_referencia || "",
    });
    setShowEditModal(true);
  };

  // --- FILTERS LOGIC ---
  const filteredPayments = payments
    .filter((p) => {
      if (filterStatus === "PENDING" && p.pago_ao_fornecedor) return false;
      if (filterStatus === "PAID" && !p.pago_ao_fornecedor) return false;

      if (filterStart) {
        const start = new Date(filterStart);
        const date = new Date(p.data_compra);
        if (date < start) return false;
      }
      if (filterEnd) {
        const end = new Date(filterEnd);
        end.setHours(23, 59, 59, 999);
        const date = new Date(p.data_compra);
        if (date > end) return false;
      }

      const supplierMatch = filterSupplier
        ? String(p.id_fornecedor) === filterSupplier
        : true;
      const plateMatch = filterPlate
        ? p.item_os?.ordem_de_servico?.veiculo?.placa
            ?.toLowerCase()
            .includes(filterPlate.toLowerCase())
        : true;

      return supplierMatch && plateMatch;
    })
    .sort(
      (a, b) =>
        new Date(b.data_compra).getTime() - new Date(a.data_compra).getTime(),
    );

  const totalPending = filteredPayments
    .filter((p) => !p.pago_ao_fornecedor)
    .reduce((acc, p) => acc + Number(p.custo_real), 0);
  const totalPaid = filteredPayments
    .filter((p) => p.pago_ao_fornecedor)
    .reduce((acc, p) => acc + Number(p.custo_real), 0);

  // --- FILTERS LOGIC ---
  // ... (Existing Payment Filters)

  // Cash Book Filters
  const filteredCashBook = cashBookEntries.filter((entry) => {
    if (cashFilterStart) {
      const start = new Date(cashFilterStart);
      const date = new Date(entry.date);
      if (date < start) return false;
    }
    if (cashFilterEnd) {
      const end = new Date(cashFilterEnd);
      end.setHours(23, 59, 59, 999);
      const date = new Date(entry.date);
      if (date > end) return false;
    }
    if (cashSearch) {
      const searchLower = cashSearch.toLowerCase();
      const matchDesc = entry.description.toLowerCase().includes(searchLower);
      const matchDetails = entry.details.toLowerCase().includes(searchLower);
      if (!matchDesc && !matchDetails) return false;
    }
    return true;
  });

  const totalInflow = filteredCashBook
    .filter((e) => e.type === "IN")
    .reduce((acc, e) => acc + e.value, 0);
  const totalOutflow = filteredCashBook
    .filter((e) => e.type === "OUT")
    .reduce((acc, e) => acc + e.value, 0);
  const balance = totalInflow - totalOutflow;

  return (
    <div className="space-y-6 animate-in fade-in duration-500">
      <StatusBanner
        msg={statusMsg}
        onClose={() => setStatusMsg({ type: null, text: "" })}
      />

      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl font-black text-neutral-900 tracking-tight">
            Financeiro
          </h1>
          <p className="text-neutral-500">
            Controle de caixa, contas a pagar e receber.
          </p>
        </div>
      </div>

      {/* TABS */}
      <div className="flex gap-4 border-b border-neutral-200 overflow-x-auto">
        <button
          onClick={() => navigate("/financeiro?tab=AUTO_PECAS")}
          className={`pb-4 px-2 font-black text-sm uppercase tracking-widest transition-colors relative whitespace-nowrap ${activeTab === "AUTO_PECAS" ? "text-neutral-900" : "text-neutral-400 hover:text-neutral-600"}`}
        >
          Pagamento de Auto Pe√ßas
          {activeTab === "AUTO_PECAS" && (
            <div className="absolute bottom-0 left-0 w-full h-1 bg-neutral-900 rounded-t-full" />
          )}
        </button>
        <button
          onClick={() => navigate("/financeiro?tab=CONTAS_PAGAR")}
          className={`pb-4 px-2 font-black text-sm uppercase tracking-widest transition-colors relative whitespace-nowrap ${activeTab === "CONTAS_PAGAR" ? "text-neutral-900" : "text-neutral-400 hover:text-neutral-600"}`}
        >
          Contas a Pagar (Geral)
          {activeTab === "CONTAS_PAGAR" && (
            <div className="absolute bottom-0 left-0 w-full h-1 bg-red-500 rounded-t-full" />
          )}
        </button>
        <button
          onClick={() => navigate("/financeiro?tab=LIVRO_CAIXA")}
          className={`pb-4 px-2 font-black text-sm uppercase tracking-widest transition-colors relative whitespace-nowrap ${activeTab === "LIVRO_CAIXA" ? "text-neutral-900" : "text-neutral-400 hover:text-neutral-600"}`}
        >
          Movimenta√ß√£o de Caixa (Fluxo)
          {activeTab === "LIVRO_CAIXA" && (
            <div className="absolute bottom-0 left-0 w-full h-1 bg-success-500 rounded-t-full" />
          )}
        </button>
      </div>

      {activeTab === "AUTO_PECAS" && (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
          {/* Filters */}
          <div className="bg-white p-6 rounded-2xl border border-neutral-100 shadow-sm grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div>
              <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">
                Status
              </label>
              <div className="flex bg-neutral-100 rounded-xl p-1 gap-2">
                <button
                  onClick={() => setFilterStatus("PENDING")}
                  className={`flex-1 py-2 rounded-lg text-xs font-black transition-all ${filterStatus === "PENDING" ? "bg-white shadow text-neutral-900" : "text-neutral-400 hover:text-neutral-600"}`}
                >
                  PENDENTES
                </button>
                <button
                  onClick={() => setFilterStatus("PAID")}
                  className={`flex-1 py-2 rounded-lg text-xs font-black transition-all ${filterStatus === "PAID" ? "bg-white shadow text-green-600" : "text-neutral-400 hover:text-neutral-600"}`}
                >
                  PAGAS
                </button>
                <button
                  onClick={() => setFilterStatus("ALL")}
                  className={`flex-1 py-2 rounded-lg text-xs font-black transition-all ${filterStatus === "ALL" ? "bg-white shadow text-neutral-900" : "text-neutral-400 hover:text-neutral-600"}`}
                >
                  TODAS
                </button>
              </div>
            </div>
            <div>
              <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">
                Fornecedor
              </label>
              <select
                value={filterSupplier}
                onChange={(e) => setFilterSupplier(e.target.value)}
                className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400 transition-colors"
              >
                <option value="">Todos</option>
                {fornecedores.map((f) => (
                  <option key={f.id_fornecedor} value={f.id_fornecedor}>
                    {f.nome}
                  </option>
                ))}
              </select>
            </div>
            <div className="md:col-span-2">
              <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">
                Buscar por Placa
              </label>
              <div className="relative">
                <Search
                  className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"
                  size={16}
                />
                <input
                  value={filterPlate}
                  onChange={(e) => setFilterPlate(e.target.value)}
                  placeholder="Digite a placa do ve√≠culo da OS..."
                  className="w-full pl-10 pr-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold text-sm outline-none focus:border-neutral-400 transition-colors uppercase"
                />
              </div>
            </div>
            <div className="md:col-span-4 grid grid-cols-2 gap-4 bg-neutral-50 p-4 rounded-xl border border-neutral-200">
              <div className="col-span-2 flex items-center gap-2 mb-2">
                <Filter size={16} className="text-neutral-500" />
                <span className="text-xs font-black text-neutral-500 uppercase">
                  Filtrar por Per√≠odo de Compra
                </span>
              </div>
              <div>
                <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1 block">
                  De
                </label>
                <input
                  type="date"
                  value={filterStart}
                  onChange={(e) => setFilterStart(e.target.value)}
                  className="w-full bg-white border border-neutral-200 p-2 rounded-lg font-bold text-sm outline-none focus:border-neutral-400 transition-colors uppercase"
                />
              </div>
              <div>
                <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1 block">
                  At√©
                </label>
                <input
                  type="date"
                  value={filterEnd}
                  onChange={(e) => setFilterEnd(e.target.value)}
                  className="w-full bg-white border border-neutral-200 p-2 rounded-lg font-bold text-sm outline-none focus:border-neutral-400 transition-colors uppercase"
                />
              </div>
            </div>
          </div>

          {/* Totals Summary */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="bg-red-50 p-6 rounded-2xl border border-red-100 flex items-center justify-between">
              <div>
                <p className="text-[10px] font-black text-red-400 uppercase tracking-widest">
                  Total Pendente (Selecionado)
                </p>
                <p className="text-2xl font-black text-red-600">
                  {formatCurrency(totalPending)}
                </p>
              </div>
              <div className="p-3 bg-white rounded-xl text-red-200">
                <Square size={24} />
              </div>
            </div>
            <div className="bg-green-50 p-6 rounded-2xl border border-green-100 flex items-center justify-between">
              <div>
                <p className="text-[10px] font-black text-green-400 uppercase tracking-widest">
                  Total Pago (Selecionado)
                </p>
                <p className="text-2xl font-black text-green-600">
                  {formatCurrency(totalPaid)}
                </p>
              </div>
              <div className="p-3 bg-white rounded-xl text-green-200">
                <CheckSquare size={24} />
              </div>
            </div>
          </div>

          {/* Table */}
          <div className="bg-white rounded-3xl shadow-sm border border-neutral-100 overflow-hidden w-full">
            <table className="w-full text-left border-collapse min-w-[800px]">
              <thead>
                <tr className="bg-neutral-50 text-[10px] font-black text-neutral-400 uppercase tracking-widest">
                  <th className="p-5">Data Compra</th>
                  <th className="p-5">Ref / Nota</th>
                  <th className="p-5">Pe√ßa</th>
                  <th className="p-5">Fornecedor</th>
                  <th className="p-5">Ve√≠culo / OS</th>
                  <th className="p-5 text-right w-32">Valor Custo</th>
                  <th className="p-5 text-center w-24">Pago?</th>
                  <th className="p-5 text-center w-16">Editar</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-neutral-50">
                {filteredPayments.length === 0 ? (
                  <tr>
                    <td
                      colSpan={7}
                      className="p-10 text-center text-neutral-400 italic font-medium"
                    >
                      Nenhum registro encontrado.
                    </td>
                  </tr>
                ) : (
                  filteredPayments.map((p) => (
                    <tr
                      key={p.id_pagamento_peca}
                      className={`hover:bg-neutral-25 transition-colors ${p.pago_ao_fornecedor ? "opacity-75" : ""}`}
                    >
                      <td className="p-5">
                        <div className="flex items-center gap-2 font-bold text-neutral-600 text-xs">
                          <Calendar size={14} />
                          {new Date(p.data_compra).toLocaleDateString()}
                        </div>
                      </td>
                      <td className="p-5">
                        <span className="font-mono text-xs font-black text-neutral-600 bg-neutral-100 px-2 py-1 rounded w-fit">
                          {p.item_os?.codigo_referencia || "---"}
                        </span>
                      </td>
                      <td className="p-5">
                        <p className="font-bold text-neutral-900 text-sm">
                          {p.item_os?.descricao}
                        </p>
                      </td>
                      <td className="p-5">
                        <div className="flex items-center gap-2">
                          <Truck size={14} className="text-orange-500" />
                          <span className="font-bold text-neutral-700 text-xs uppercase">
                            {p.fornecedor?.nome}
                          </span>
                        </div>
                      </td>
                      <td className="p-5">
                        <div>
                          <p className="font-black text-neutral-800 text-xs uppercase tracking-widest bg-neutral-100 px-2 py-1 rounded w-fit">
                            {p.item_os?.ordem_de_servico?.veiculo?.placa ||
                              "N/A"}
                          </p>
                          <p className="text-[10px] text-neutral-400 font-bold mt-1">
                            OS #{String(p.item_os?.id_os).padStart(4, "0")}
                          </p>
                        </div>
                      </td>
                      <td className="p-5 text-right font-black text-neutral-900">
                        {formatCurrency(Number(p.custo_real))}
                      </td>
                      <td className="p-5 text-center">
                        <button
                          onClick={() =>
                            handleTogglePayment(
                              p.id_pagamento_peca,
                              p.pago_ao_fornecedor,
                            )
                          }
                          className="hover:scale-110 transition-transform active:scale-95 text-neutral-400 hover:text-neutral-600"
                          title={
                            p.pago_ao_fornecedor
                              ? "Desmarcar como pago"
                              : "Marcar como pago"
                          }
                        >
                          {p.pago_ao_fornecedor ? (
                            <CheckSquare
                              size={32}
                              className="text-green-500 fill-green-500/20"
                            />
                          ) : (
                            <Square
                              size={32}
                              className="text-neutral-300 stroke-[2.5]"
                            />
                          )}
                        </button>
                      </td>
                      <td className="p-5 text-center">
                        <div className="flex justify-center gap-2">
                          <button
                            onClick={() => openEditModal(p)}
                            className="p-2 text-neutral-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                            title="Editar Detalhes"
                          >
                            <Edit size={18} />
                          </button>
                          <button
                            onClick={() =>
                              handleDeletePayment(p.id_pagamento_peca)
                            }
                            className="p-2 text-neutral-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                            title="Excluir Pagamento"
                          >
                            <Trash2 size={18} />
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {activeTab === "CONTAS_PAGAR" && (
        <div className="bg-neutral-50 border-2 border-dashed border-neutral-200 rounded-3xl p-12 text-center animate-in fade-in duration-500">
          <div className="w-16 h-16 bg-neutral-100 rounded-full flex items-center justify-center mx-auto mb-4 text-neutral-400">
            <Wallet size={32} />
          </div>
          <h2 className="text-xl font-black text-neutral-800 mb-2">
            Contas a Pagar (Geral) em Constru√ß√£o
          </h2>
          <p className="text-neutral-500 max-w-md mx-auto">
            Aqui voc√™ poder√° gerenciar contas de luz, √°gua, aluguel, internet e
            outras despesas fixas ou vari√°veis da oficina.
          </p>
          <button className="mt-6 px-6 py-3 bg-neutral-900 text-white font-bold rounded-xl shadow-lg opacity-50 cursor-not-allowed">
            Nova Conta a Pagar (Em Breve)
          </button>
        </div>
      )}

      {activeTab === "LIVRO_CAIXA" && (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
          {/* Manual Entry & Filters */}
          <div className="bg-white p-6 rounded-2xl border border-neutral-100 shadow-sm flex flex-col md:flex-row justify-between items-end gap-4">
            <div className="w-full grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">
                  Buscar Detalhes
                </label>
                <div className="relative">
                  <Search
                    className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"
                    size={16}
                  />
                  <input
                    value={cashSearch}
                    onChange={(e) => setCashSearch(e.target.value)}
                    placeholder="Ex: OS 123, Pix..."
                    className="w-full pl-10 pr-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold text-sm outline-none focus:border-neutral-400 transition-colors"
                  />
                </div>
              </div>
              <div>
                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">
                  De
                </label>
                <input
                  type="date"
                  value={cashFilterStart}
                  onChange={(e) => setCashFilterStart(e.target.value)}
                  className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400 transition-colors uppercase"
                />
              </div>
              <div>
                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">
                  At√©
                </label>
                <input
                  type="date"
                  value={cashFilterEnd}
                  onChange={(e) => setCashFilterEnd(e.target.value)}
                  className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400 transition-colors uppercase"
                />
              </div>
            </div>
            <button
              className="bg-neutral-900 text-white px-5 py-3 rounded-xl font-bold flex items-center gap-2 whitespace-nowrap shadow-lg hover:bg-neutral-800 transition-transform hover:-translate-y-0.5"
              onClick={() =>
                alert(
                  "Funcionalidade de Lan√ßamento Manual ser√° implementada em breve.",
                )
              }
            >
              <Plus size={18} />
              Novo Lan√ßamento
            </button>
          </div>

          {/* SUMMARY CARDS */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-neutral-100">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 bg-success-50 text-success-600 rounded-lg">
                  <ArrowDownCircle size={20} />
                </div>
                <p className="text-xs font-black text-neutral-400 uppercase tracking-widest">
                  Entradas
                </p>
              </div>
              <p className="text-3xl font-black text-success-600">
                {formatCurrency(totalInflow)}
              </p>
            </div>
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-neutral-100">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 bg-red-50 text-red-600 rounded-lg">
                  <ArrowUpCircle size={20} />
                </div>
                <p className="text-xs font-black text-neutral-400 uppercase tracking-widest">
                  Sa√≠das
                </p>
              </div>
              <p className="text-3xl font-black text-red-600">
                {formatCurrency(totalOutflow)}
              </p>
            </div>
            <div className="bg-neutral-900 p-6 rounded-2xl shadow-xl text-white">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 bg-neutral-800 text-neutral-400 rounded-lg">
                  <Wallet size={20} />
                </div>
                <p className="text-xs font-black text-neutral-400 uppercase tracking-widest">
                  Saldo
                </p>
              </div>
              <p
                className={`text-3xl font-black ${balance >= 0 ? "text-white" : "text-red-400"}`}
              >
                {formatCurrency(balance)}
              </p>
            </div>
          </div>

          {/* TRANSACTIONS TABLE */}
          <div className="bg-white rounded-3xl shadow-sm border border-neutral-100 overflow-hidden w-full">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr className="bg-neutral-50 text-[10px] font-black text-neutral-400 uppercase tracking-widest">
                  <th className="p-5">Data</th>
                  <th className="p-5">Descri√ß√£o</th>
                  <th className="p-5">Detalhes</th>
                  <th className="p-5 text-right">Valor</th>
                  <th className="p-5 text-center">Tipo</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-neutral-50">
                {filteredCashBook.length === 0 ? (
                  <tr>
                    <td
                      colSpan={5}
                      className="p-10 text-center text-neutral-400 italic font-medium"
                    >
                      Nenhuma movimenta√ß√£o encontrada para o filtro.
                    </td>
                  </tr>
                ) : (
                  filteredCashBook.map((entry) => (
                    <tr
                      key={entry.id}
                      className="hover:bg-neutral-25 transition-colors"
                    >
                      <td className="p-5">
                        <div className="flex items-center gap-2 font-bold text-neutral-600 text-xs">
                          <Calendar size={14} />
                          {new Date(entry.date).toLocaleDateString()}
                        </div>
                      </td>
                      <td className="p-5 font-bold text-neutral-900">
                        {entry.description}
                      </td>
                      <td className="p-5 text-xs font-medium text-neutral-500">
                        {entry.details}
                      </td>
                      <td className="p-5 text-right font-black text-neutral-900">
                        {formatCurrency(entry.value)}
                      </td>
                      <td className="p-5 text-center">
                        <span
                          className={`px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider ${
                            entry.type === "IN"
                              ? "bg-success-100 text-success-700"
                              : "bg-red-100 text-red-700"
                          }`}
                        >
                          {entry.type === "IN" ? "ENTRADA" : "SA√çDA"}
                        </span>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {showEditModal && editPayment && (
        <Modal
          title="Editar Pagamento (Pe√ßa)"
          onClose={() => setShowEditModal(false)}
        >
          <div className="space-y-6">
            <div className="bg-neutral-50 p-4 rounded-xl mb-4">
              <p className="text-xs font-bold text-neutral-400 uppercase">
                Item da OS
              </p>
              <p className="font-bold text-neutral-800">
                {editPayment.item_os?.descricao}
              </p>
              <div className="mt-2">
                <label className="text-[10px] font-black text-neutral-400 uppercase mb-1 block">
                  Ref / Nota
                </label>
                <input
                  value={editPayment.ref_nota || ""}
                  onChange={(e) =>
                    setEditPayment({ ...editPayment, ref_nota: e.target.value })
                  }
                  className="w-full bg-white border border-neutral-200 p-2 rounded-lg font-bold text-sm outline-none focus:border-neutral-400"
                  placeholder="N√∫mero da Nota / Refer√™ncia"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">
                  Data Compra
                </label>
                <input
                  type="date"
                  value={editPayment.data_compra}
                  onChange={(e) =>
                    setEditPayment({
                      ...editPayment,
                      data_compra: e.target.value,
                    })
                  }
                  className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                />
              </div>
              <div>
                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">
                  Data Pagamento
                </label>
                <input
                  type="date"
                  value={editPayment.data_pagamento_fornecedor || ""}
                  onChange={(e) =>
                    setEditPayment({
                      ...editPayment,
                      data_pagamento_fornecedor: e.target.value,
                    })
                  }
                  className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">
                  Custo Real (R$)
                </label>
                <input
                  type="number"
                  step="0.01"
                  value={editPayment.custo_real}
                  onChange={(e) =>
                    setEditPayment({
                      ...editPayment,
                      custo_real: e.target.value,
                    })
                  }
                  className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                />
              </div>
              <div>
                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">
                  Fornecedor
                </label>
                <select
                  value={editPayment.id_fornecedor}
                  onChange={(e) =>
                    setEditPayment({
                      ...editPayment,
                      id_fornecedor: e.target.value,
                    })
                  }
                  className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                >
                  {fornecedores.map((f) => (
                    <option key={f.id_fornecedor} value={f.id_fornecedor}>
                      {f.nome}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <div className="flex gap-3 pt-4 border-t border-neutral-100">
              <button
                onClick={() => setShowEditModal(false)}
                className="flex-1 py-3 text-neutral-500 font-bold hover:bg-neutral-50 rounded-xl transition-colors"
              >
                Cancelar
              </button>
              <button
                onClick={handleUpdatePayment}
                className="flex-1 py-3 bg-neutral-900 text-white font-bold rounded-xl hover:bg-neutral-800 transition-colors shadow-lg"
              >
                Salvar Altera√ß√µes
              </button>
            </div>
          </div>
        </Modal>
      )}

      {/* Confirmation Modal */}
      {confirmModal.isOpen && (
        <Modal
          title={confirmModal.title}
          onClose={() =>
            setConfirmModal((prev) => ({ ...prev, isOpen: false }))
          }
        >
          <div className="space-y-6">
            <p className="text-neutral-600 font-medium">
              {confirmModal.message}
            </p>
            <div className="flex justify-end gap-3 pt-2">
              <button
                type="button"
                onClick={() =>
                  setConfirmModal((prev) => ({ ...prev, isOpen: false }))
                }
                className="px-5 py-2.5 text-neutral-600 font-bold hover:bg-neutral-100 rounded-lg transition-colors"
              >
                Cancelar
              </button>
              <button
                type="button"
                onClick={confirmModal.onConfirm}
                className="px-5 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors shadow-lg shadow-red-500/30"
              >
                Confirmar Exclus√£o
              </button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\FornecedorPage.tsx
================================================================================
import { useState, useEffect, useRef } from "react";
import { api } from "../services/api";
import type { IFornecedor } from "../types/backend";
import { FornecedorForm } from "../components/forms/FornecedorForm";
import { Button } from "../components/ui/Button";
import { StatusBanner } from "../components/ui/StatusBanner";
import {
  Plus,
  Search,
  Trash2,
  Edit,
  Truck,
  MapPin,
  Phone,
  User,
} from "lucide-react";
import { Input } from "../components/ui/input";
import { ActionButton } from "../components/ui/ActionButton";

export const FornecedorPage = () => {
  const [view, setView] = useState<"list" | "form">("list");
  const [fornecedores, setFornecedores] = useState<IFornecedor[]>([]);
  const [editData, setEditData] = useState<IFornecedor | null>(null);
  const [searchTerm, setSearchTerm] = useState("");
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  const searchInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if (view === "list") {
      loadFornecedores();
      if (searchInputRef.current) {
        searchInputRef.current.focus();
      }
    }
  }, [view]);

  const loadFornecedores = async () => {
    try {
      const response = await api.get("/fornecedor");
      setFornecedores(response.data);
    } catch (error) {
      setStatusMsg({
        type: "error",
        text: "Erro ao carregar lista de fornecedores.",
      });
    }
  };

  const handleDeleteFornecedor = async (id: number) => {
    if (!confirm("Deseja realmente remover este fornecedor?")) return;
    try {
      await api.delete(`/fornecedor/${id}`);
      setStatusMsg({ type: "success", text: "Fornecedor removido." });
      loadFornecedores();
      setTimeout(() => setStatusMsg({ type: null, text: "" }), 3000);
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao deletar fornecedor." });
    }
  };

  const handleNew = () => {
    setEditData(null);
    setView("form");
  };

  const handleEdit = (f: IFornecedor) => {
    setEditData(f);
    setView("form");
  };

  const handleFormSuccess = () => {
    setStatusMsg({
      type: "success",
      text: editData ? "Fornecedor atualizado!" : "Fornecedor cadastrado!",
    });
    setView("list");
    setEditData(null);
    setTimeout(() => setStatusMsg({ type: null, text: "" }), 3000);
  };

  const filteredFornecedores = fornecedores.filter((f) => {
    const searchText = searchTerm.toLowerCase();
    return (
      (f.nome && f.nome.toLowerCase().includes(searchText)) ||
      (f.nome_fantasia && f.nome_fantasia.toLowerCase().includes(searchText)) ||
      (f.documento && f.documento.includes(searchTerm))
    );
  });

  // RENDER: FORM VIEW
  if (view === "form") {
    return (
      <div className="space-y-6">
        <StatusBanner
          msg={statusMsg}
          onClose={() => setStatusMsg({ type: null, text: "" })}
        />
        <FornecedorForm
          initialData={editData}
          onSuccess={handleFormSuccess}
          onCancel={() => {
            setView("list");
            setEditData(null);
          }}
        />
      </div>
    );
  }

  return (
    <div className="w-full max-w-[1440px] mx-auto px-4 md:px-8 py-6 space-y-6">
      <StatusBanner
        msg={statusMsg}
        onClose={() => setStatusMsg({ type: null, text: "" })}
      />

      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl font-bold text-neutral-500">
            Gest√£o de Fornecedores
          </h1>
          <p className="text-neutral-500">
            Cadastro de parceiros de pe√ßas e servi√ßos.
          </p>
        </div>
        <Button variant="primary" onClick={handleNew}>
          <Plus size={20} /> Novo Fornecedor
        </Button>
      </div>

      <div className="bg-surface p-4 rounded-xl shadow-sm border border-neutral-200 flex gap-4">
        <Input
          ref={searchInputRef}
          variant="default"
          value={searchTerm}
          icon={Search}
          onChange={(e) => setSearchTerm(e.target.value)}
          placeholder="Buscar por nome ou documento..."
        />
      </div>

      {/* Tabela */}
      <div className="grid grid-cols-1 gap-4">
        {filteredFornecedores.length === 0 ? (
          <div className="p-20 text-center bg-neutral-25 rounded-3xl border border-neutral-100">
            <div className="flex flex-col items-center gap-4">
              <div className="bg-neutral-50 p-6 rounded-full text-neutral-200">
                <Truck size={40} />
              </div>
              <p className="font-bold text-neutral-400">
                Nenhum fornecedor encontrado.
              </p>
            </div>
          </div>
        ) : (
          <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full text-left border-collapse">
                <thead>
                  <tr className="bg-neutral-50 border-b border-neutral-200 text-xs uppercase tracking-wider text-neutral-500 font-semibold">
                    <th className="p-4">Fornecedor</th>
                    <th className="p-4">Documento</th>
                    <th className="p-4">Localiza√ß√£o</th>
                    <th className="p-4">Contato</th>
                    <th className="p-4 text-right">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-neutral-100">
                  {filteredFornecedores.map((f) => (
                    <tr
                      key={f.id_fornecedor}
                      className="hover:bg-neutral-25 transition-colors"
                    >
                      <td className="p-4">
                        <div className="flex items-center gap-4">
                          <div className="w-10 h-10 bg-primary-50 rounded-xl flex items-center justify-center text-primary-600 font-black">
                            {f.tipo_pessoa === "FISICA" ? (
                              <User size={20} />
                            ) : (
                              <Truck size={20} />
                            )}
                          </div>
                          <div>
                            <p className="font-bold text-neutral-500">
                              {f.nome_fantasia || f.nome}
                            </p>
                            {f.nome_fantasia && f.nome_fantasia !== f.nome && (
                              <p className="text-xs text-neutral-500 font-medium">
                                {f.nome}
                              </p>
                            )}
                          </div>
                        </div>
                      </td>
                      <td className="p-4">
                        <p className="font-mono text-xs font-bold text-neutral-500 bg-neutral-100 px-2 py-1 rounded w-fit">
                          {f.documento || "N/A"}
                        </p>
                      </td>
                      <td className="p-4">
                        <div className="flex items-center gap-2 text-neutral-500 text-sm font-medium">
                          <MapPin size={14} className="text-neutral-500" />
                          {f.cidade ? `${f.cidade}/${f.uf}` : "-"}
                        </div>
                      </td>
                      <td className="p-4">
                        <div className="flex flex-col gap-1">
                          <div className="flex items-center gap-2 text-neutral-600 text-sm font-medium">
                            <Phone size={14} className="text-neutral-400" />
                            {f.telefone || f.whatsapp || "-"}
                          </div>
                          <span className="text-[10px] text-neutral-400 font-bold uppercase">
                            {f.contato}
                          </span>
                        </div>
                      </td>
                      <td className="p-4">
                        <div className="flex items-center justify-end gap-1">
                          <ActionButton
                            icon={Edit}
                            label="Editar"
                            variant="neutral"
                            onClick={() => handleEdit(f)}
                          />
                          <ActionButton
                            icon={Trash2}
                            label="Excluir"
                            variant="danger"
                            onClick={() =>
                              handleDeleteFornecedor(f.id_fornecedor)
                            }
                          />
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\FuncionarioPage.tsx
================================================================================
import { useState, useEffect, useRef } from "react";
import { api } from "../services/api";
// import { Modal } from '../components/ui/Modal'; // Removed
import { Button } from "../components/ui/Button";
import { FuncionarioForm } from "../components/forms/FuncionarioForm";
import { StatusBanner } from "../components/ui/StatusBanner";
import { ActionButton } from "../components/ui/ActionButton";
import { Input } from "../components/ui/input";
import { Plus, Search, Trash2, Edit, Users, User, Phone } from "lucide-react";
import type { IFuncionario } from "../types/backend";

export const FuncionarioPage = () => {
  const [view, setView] = useState<"list" | "form">("list");
  const [funcionarios, setFuncionarios] = useState<IFuncionario[]>([]);
  const [editData, setEditData] = useState<IFuncionario | null>(null);
  const [searchTerm, setSearchTerm] = useState("");
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  const searchInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if (view === "list") {
      loadFuncionarios();
    }
  }, [view]);

  useEffect(() => {
    if (searchInputRef.current) {
      searchInputRef.current.focus();
    }
  }, []);

  const loadFuncionarios = async () => {
    try {
      const response = await api.get("/funcionario");
      setFuncionarios(response.data);
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: "error", text: "Erro ao carregar colaboradores." });
    }
  };

  const handleDeleteFuncionario = async (id: number) => {
    if (!confirm("Tem certeza que deseja remover este colaborador?")) return;
    try {
      await api.delete(`/funcionario/${id}`);
      setStatusMsg({ type: "success", text: "Colaborador removido." });
      loadFuncionarios();
      setTimeout(() => setStatusMsg({ type: null, text: "" }), 3000);
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: "error", text: "Erro ao remover colaborador." });
    }
  };

  const handleNew = () => {
    setEditData(null);
    setView("form");
  };

  const handleEdit = (func: IFuncionario) => {
    setEditData(func);
    setView("form");
  };

  const handleFormSuccess = () => {
    setStatusMsg({
      type: "success",
      text: editData ? "Cadastro atualizado!" : "Novo colaborador cadastrado!",
    });
    setView("list");
    setEditData(null);
    setTimeout(() => setStatusMsg({ type: null, text: "" }), 3000);
  };

  const filteredFuncionarios = funcionarios.filter((f) => {
    const nome = f.pessoa_fisica?.pessoa?.nome?.toLowerCase() || "";
    const cpf = f.pessoa_fisica?.cpf || "";
    const search = searchTerm.toLowerCase();
    return nome.includes(search) || cpf.includes(search);
  });

  // RENDER FORM
  if (view === "form") {
    return (
      <div className="w-full max-w-[1440px] mx-auto px-4 md:px-8 py-6 space-y-6">
        <FuncionarioForm
          initialData={editData}
          onSuccess={handleFormSuccess}
          onCancel={() => {
            setView("list");
            setEditData(null);
          }}
        />
        <div className="fixed bottom-8 right-8 z-100 min-w-[320px]">
          <StatusBanner
            msg={statusMsg}
            onClose={() => setStatusMsg({ type: null, text: "" })}
          />
        </div>
      </div>
    );
  }

  return (
    <div className="w-full max-w-[1440px] mx-auto px-4 md:px-8 py-6 space-y-6 animate-in fade-in duration-500">
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl font-bold text-neutral-500">Equipe & MEI</h1>
          <p className="text-neutral-500">
            Gest√£o de colaboradores e prestadores de servi√ßo.
          </p>
        </div>
        <Button variant="primary" icon={Plus} onClick={handleNew}>
          Novo Colaborador
        </Button>
      </div>

      {/* Barra de Filtros */}
      <div className="bg-surface p-4 rounded-xl shadow-sm border border-neutral-200 flex gap-4">
        <Input
          ref={searchInputRef}
          variant="default"
          icon={Search}
          placeholder="Buscar por nome ou CPF..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
        />
      </div>

      <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden">
        {filteredFuncionarios.length === 0 ? (
          <div className="p-8 text-center text-neutral-500">
            <div className="flex flex-col items-center gap-4">
              <div className="bg-neutral-50 p-6 rounded-full text-neutral-200">
                <Users size={40} />
              </div>
              <p className="font-bold text-neutral-400">
                Nenhum colaborador encontrado.
              </p>
            </div>
          </div>
        ) : (
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-neutral-50 border-b border-neutral-200 text-xs uppercase tracking-wider text-neutral-500 font-semibold">
                <th className="p-4">Colaborador</th>
                <th className="p-4">Cargo / Fun√ß√£o</th>
                <th className="p-4">Contato</th>
                <th className="p-4">Status</th>
                <th className="p-4 text-right">A√ß√µes</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-neutral-100">
              {filteredFuncionarios.map((f) => (
                <tr
                  key={f.id_funcionario}
                  className="transition-colors hover:bg-neutral-25"
                >
                  <td className="p-4">
                    <div className="flex items-center gap-3">
                      <div className="p-2 bg-primary-50 text-primary-600 rounded-full">
                        <User size={16} />
                      </div>
                      <div>
                        <p className="font-bold text-neutral-500 block">
                          {f.pessoa_fisica?.pessoa?.nome}
                        </p>
                        <p className="text-[10px] font-bold text-neutral-400 uppercase">
                          CPF: {f.pessoa_fisica?.cpf || "N/A"}
                        </p>
                      </div>
                    </div>
                  </td>
                  <td className="p-4">
                    <div className="flex items-center gap-2">
                      <div className="p-1 px-2 bg-neutral-100 text-neutral-600 rounded-lg">
                        <span className="font-bold text-xs">{f.cargo}</span>
                      </div>
                    </div>
                    {f.especialidade && (
                      <p className="text-[10px] text-neutral-400 font-medium ml-2 mt-1">
                        {f.especialidade}
                      </p>
                    )}
                  </td>
                  <td className="p-4">
                    <div className="flex flex-col gap-1">
                      <div className="flex items-center gap-2 text-neutral-500 text-sm">
                        <Phone size={12} className="text-neutral-400" />
                        {f.telefone_pessoal || "-"}
                      </div>
                    </div>
                  </td>
                  <td className="p-4">
                    {f.ativo === "S" ? (
                      <span className="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full bg-emerald-50 text-emerald-600 text-xs font-medium">
                        Ativo
                      </span>
                    ) : (
                      <span className="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full bg-red-50 text-red-600 text-xs font-medium">
                        Inativo
                      </span>
                    )}
                  </td>
                  <td className="p-4 text-right">
                    <div className="flex justify-end gap-1">
                      <ActionButton
                        icon={Edit}
                        label="Editar"
                        variant="neutral"
                        onClick={() => handleEdit(f)}
                      />
                      <ActionButton
                        icon={Trash2}
                        label="Excluir"
                        variant="danger"
                        onClick={() =>
                          handleDeleteFuncionario(f.id_funcionario)
                        }
                      />
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      <div className="fixed bottom-8 right-8 z-100 min-w-[320px]">
        <StatusBanner
          msg={statusMsg}
          onClose={() => setStatusMsg({ type: null, text: "" })}
        />
      </div>
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\ItensOsPage.tsx
================================================================================
import { useState, useEffect } from "react";
import { formatCurrency } from "../utils/formatCurrency";
import { api } from "../services/api";
import type { IItensOs } from "../types/backend";
import { ItensOsForm } from "../components/forms/ItensOsForm";
import { Modal } from "../components/ui/Modal";
import { Plus, Search, Trash2, Edit, Package } from "lucide-react";

export const ItensOsPage = () => {
  const [itens, setItens] = useState<IItensOs[]>([]);
  const [showModal, setShowModal] = useState(false);
  const [searchId, setSearchId] = useState("");
  const [editData, setEditData] = useState<IItensOs | null>(null);
  const [selectedOsId, setSelectedOsId] = useState<number | null>(null);

  useEffect(() => {
    loadItens();
  }, []);

  const loadItens = async () => {
    try {
      const response = await api.get("/itens-os");
      setItens(response.data);
    } catch (error) {
      alert("Erro ao carregar itens");
    }
  };

  const handleSearch = async () => {
    try {
      const response = await api.get(`/itens-os/${searchId}`);
      setEditData(response.data);
    } catch (error) {
      alert("Item n√£o encontrado");
      setEditData(null);
    }
  };

  const handleUpdate = async () => {
    if (!editData) return;
    try {
      await api.put(`/itens-os/${editData.id_iten}`, editData);
      alert("Item atualizado!");
      loadItens();
    } catch (error) {
      alert("Erro ao atualizar item");
    }
  };

  const handleDelete = async () => {
    if (!searchId) return;
    try {
      await api.delete(`/itens-os/${searchId}`);
      alert("Item deletado!");
      loadItens();
      setEditData(null);
      setSearchId("");
    } catch (error) {
      alert("Erro ao deletar item");
    }
  };

  const openCreateModal = () => {
    const osId = prompt("Digite o ID da OS para adicionar item:");
    if (osId) {
      setSelectedOsId(Number(osId));
      setShowModal(true);
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-bold text-slate-800">
            Itens de Ordem de Servi√ßo
          </h1>
          <p className="text-slate-500">Pe√ßas e servi√ßos aplicados nas OS.</p>
        </div>
        <button
          onClick={openCreateModal}
          className="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2.5 rounded-lg font-medium shadow-sm transition-all"
        >
          <Plus size={20} />
          Novo Item
        </button>
      </div>

      {/* LIST */}
      <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
        <table className="w-full text-left border-collapse">
          <thead className="bg-slate-50">
            <tr>
              <th className="p-4 text-xs font-bold text-gray-500 uppercase">
                ID
              </th>
              <th className="p-4 text-xs font-bold text-gray-500 uppercase">
                OS
              </th>
              <th className="p-4 text-xs font-bold text-gray-500 uppercase">
                Descri√ß√£o
              </th>
              <th className="p-4 text-xs font-bold text-gray-500 uppercase">
                Qtd
              </th>
              <th className="p-4 text-xs font-bold text-gray-500 uppercase">
                Valor Unit.
              </th>
              <th className="p-4 text-xs font-bold text-gray-500 uppercase">
                Total
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100">
            {itens.map((item) => (
              <tr key={item.id_iten} className="hover:bg-slate-50">
                <td className="p-4 text-gray-500 font-mono">#{item.id_iten}</td>
                <td className="p-4 text-slate-600">OS #{item.id_os}</td>
                <td className="p-4">
                  <div className="flex items-center gap-3">
                    <div className="bg-green-50 p-2 rounded-lg text-green-600">
                      <Package size={18} />
                    </div>
                    <div>
                      <div className="font-medium text-slate-900">
                        {item.descricao}
                      </div>
                      {item.id_pecas_estoque && (
                        <div className="text-xs text-slate-500">
                          Pe√ßa ID: {item.id_pecas_estoque}
                        </div>
                      )}
                    </div>
                  </div>
                </td>
                <td className="p-4 text-slate-700 font-bold">
                  {item.quantidade}
                </td>
                <td className="p-4 text-slate-700">
                  {formatCurrency(Number(item.valor_venda))}
                </td>
                <td className="p-4 text-green-700 font-bold">
                  {formatCurrency(Number(item.valor_total))}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* MANAGE */}
      <div className="bg-white p-4 rounded-xl border border-gray-200">
        <h2 className="text-lg font-bold mb-4 text-gray-700 border-b pb-2">
          Manuten√ß√£o de Item (Por ID)
        </h2>
        <div className="flex gap-4 mb-4">
          <input
            type="number"
            value={searchId}
            onChange={(e) => setSearchId(e.target.value)}
            placeholder="Digite o ID do Item..."
            className="border p-2 rounded w-64"
          />
          <button
            onClick={handleSearch}
            className="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700"
          >
            <Search size={18} /> Localizar
          </button>
          {searchId && (
            <button
              onClick={handleDelete}
              className="flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200"
            >
              <Trash2 size={18} /> Excluir
            </button>
          )}
        </div>

        {editData && (
          <div className="bg-slate-50 p-4 rounded border animate-in fade-in">
            <h3 className="font-bold mb-2">Editando: {editData.descricao}</h3>
            <div className="grid grid-cols-2 gap-4 mb-4">
              <div className="col-span-2">
                <label className="text-xs font-bold block mb-1">
                  Descri√ß√£o
                </label>
                <input
                  value={editData.descricao}
                  onChange={(e) =>
                    setEditData({ ...editData, descricao: e.target.value })
                  }
                  className="border p-2 w-full rounded"
                />
              </div>
              <div>
                <label className="text-xs font-bold block mb-1">
                  Quantidade
                </label>
                <input
                  type="number"
                  value={editData.quantidade}
                  onChange={(e) =>
                    setEditData({
                      ...editData,
                      quantidade: Number(e.target.value),
                    })
                  }
                  className="border p-2 w-full rounded"
                />
              </div>
            </div>
            <button
              onClick={handleUpdate}
              className="flex items-center gap-2 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold"
            >
              <Edit size={18} /> Salvar Altera√ß√µes
            </button>
          </div>
        )}
      </div>

      {showModal && selectedOsId && (
        <Modal title="Novo Item na OS" onClose={() => setShowModal(false)}>
          <ItensOsForm
            osId={selectedOsId}
            onSuccess={() => {
              setShowModal(false);
              loadItens();
            }}
            onCancel={() => setShowModal(false)}
          />
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\LivroCaixaPage.tsx
================================================================================
import { useState } from "react";
import {
  LayoutDashboard,
  CreditCard,
  Landmark,
  ArrowRightLeft,
} from "lucide-react";
import { MovimentacoesTab } from "../components/financeiro/MovimentacoesTab";
import { ContasTab } from "../components/financeiro/ContasTab";
import { OperadorasTab } from "../components/financeiro/OperadorasTab";
import { RecebiveisTab } from "../components/financeiro/RecebiveisTab";

export const LivroCaixaPage = () => {
  const [activeTab, setActiveTab] = useState<
    "MOVIMENTACOES" | "CONTAS" | "OPERADORAS" | "RECEBIVEIS"
  >("MOVIMENTACOES");

  const getTabClass = (isActive: boolean) =>
    `flex items-center gap-2 px-6 py-3 rounded-xl font-bold text-sm transition-all duration-300 ${
      isActive
        ? "bg-primary-200 text-primary-500 shadow-sm"
        : "text-neutral-500 hover:text-neutral-900 hover:bg-white"
    }`;

  return (
    <div className="p-8 max-w-[1600px] mx-auto animate-in fade-in duration-500">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-neutral-900 tracking-tight mb-2">
          Gest√£o Financeira
        </h1>
        <p className="text-neutral-500 text-lg">
          Controle consolidado de caixa, bancos e receb√≠veis.
        </p>
      </div>

      {/* TAB NAVIGATION */}
      <div className="flex flex-wrap gap-2 mb-8 bg-neutral-100 p-1.5 rounded-2xl w-fit">
        <button
          onClick={() => setActiveTab("MOVIMENTACOES")}
          className={getTabClass(activeTab === "MOVIMENTACOES")}
        >
          <ArrowRightLeft size={18} />
          Movimenta√ß√µes
        </button>
        <button
          onClick={() => setActiveTab("CONTAS")}
          className={getTabClass(activeTab === "CONTAS")}
        >
          <Landmark size={18} />
          Contas Banc√°rias
        </button>
        <button
          onClick={() => setActiveTab("OPERADORAS")}
          className={getTabClass(activeTab === "OPERADORAS")}
        >
          <CreditCard size={18} />
          Operadoras
        </button>
        <button
          onClick={() => setActiveTab("RECEBIVEIS")}
          className={getTabClass(activeTab === "RECEBIVEIS")}
        >
          <LayoutDashboard size={18} />
          Receb√≠veis
        </button>
      </div>

      {/* CONTENT AREA */}
      <div className="bg-surface rounded-3xl min-h-[500px] border border-neutral-200 shadow-sm overflow-hidden">
        {activeTab === "MOVIMENTACOES" && <MovimentacoesTab />}
        {activeTab === "CONTAS" && <ContasTab />}
        {activeTab === "OPERADORAS" && <OperadorasTab />}
        {activeTab === "RECEBIVEIS" && <RecebiveisTab />}
      </div>
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\NotFoundPage.tsx
================================================================================
import { Link } from 'react-router-dom';
import { Home } from 'lucide-react';

export function NotFoundPage() {
  return (
    <div className="min-h-[80vh] flex flex-col items-center justify-center text-center p-4">
      <h1 className="text-9xl font-black text-slate-200">404</h1>
      <h2 className="text-2xl font-bold text-slate-800 mt-4">P√°gina n√£o encontrada</h2>
      <p className="text-slate-500 mt-2 max-w-md">
        Ops! A rota que voc√™ tentou acessar n√£o existe ou foi movida.
      </p>
      <Link 
        to="/" 
        className="mt-8 flex items-center gap-2 px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium"
      >
        <Home size={20} />
        Voltar para o In√≠cio
      </Link>
    </div>
  );
}


================================================================================
FILE PATH: client\src\pages\NovoPagamentoPage.tsx
================================================================================
import { useState, useEffect, useMemo } from "react";
import { formatCurrency } from "../utils/formatCurrency";
import { api } from "../services/api";
import { StatusBanner } from "../components/ui/StatusBanner";
import {
  User,
  ArrowRight,
  Calculator,
  CheckCircle2,
  Circle,
  DollarSign,
  CheckSquare,
  Square,
} from "lucide-react";
import { useNavigate, useLocation } from "react-router-dom";
import { Input } from "../components/ui/input";
import { Button } from "../components/ui/Button";

export const NovoPagamentoPage = () => {
  const navigate = useNavigate();

  // --- STATE ---
  const [funcionarios, setFuncionarios] = useState<any[]>([]);
  const [selectedFuncionarioId, setSelectedFuncionarioId] = useState("");
  const location = useLocation();

  const [funcPendentes, setFuncPendentes] = useState<any[]>([]); // Comiss√µes Pendentes
  const [valesPendentes, setValesPendentes] = useState<any[]>([]); // Vales Pendentes

  // Selection
  const [selectedItems, setSelectedItems] = useState<number[]>([]); // IDs Comiss√µes
  const [selectedVales, setSelectedVales] = useState<number[]>([]); // IDs Vales

  // MODE: 'PAGAMENTO' (Full) or 'ADIANTAMENTO' (Simple Vale)
  const [mode, setMode] = useState<"PAGAMENTO" | "ADIANTAMENTO">("PAGAMENTO");

  // Values
  const [valorSalario, setValorSalario] = useState(""); // Sal√°rio Base (Editable)
  const [includeSalary, setIncludeSalary] = useState(false); // Checkbox state
  const [valorPremio, setValorPremio] = useState(""); // Pr√™mio Extra

  // Common Inputs
  const [obsExtra, setObsExtra] = useState(""); // Obs Pr√™mio
  const [obsPagamento, setObsPagamento] = useState(""); // Obs Geral
  const [paymentMethod, setPaymentMethod] = useState("DINHEIRO");

  // Simple Adiantamento Inputs
  const [valorAdiantamento, setValorAdiantamento] = useState("");
  const [dataAdiantamento, setDataAdiantamento] = useState(
    new Date().toISOString().split("T")[0],
  );

  // Date Filters (Comiss√µes)
  const [filterStart, setFilterStart] = useState("");
  const [filterEnd, setFilterEnd] = useState("");

  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  const [isLoading, setIsLoading] = useState(false);

  // --- EFFECTS ---
  useEffect(() => {
    loadFuncionarios();
  }, []);

  // Auto-select from navigation state
  useEffect(() => {
    if (location.state?.funcionarioId && funcionarios.length > 0) {
      setSelectedFuncionarioId(String(location.state.funcionarioId));
      // Clear state to avoid re-triggering if needed, but react-router handles this cleanly ideally
      // window.history.replaceState({}, document.title);
    }
  }, [location.state, funcionarios]);

  useEffect(() => {
    if (selectedFuncionarioId) {
      loadData(selectedFuncionarioId);

      // Auto-fill Salary from selected Funcionario
      const func = funcionarios.find(
        (f) => String(f.id_funcionario) === String(selectedFuncionarioId),
      );
      if (func) {
        const val = func.valor_pagamento || func.salario;
        setValorSalario(val ? String(val) : "");
      } else {
        setValorSalario("");
      }
    } else {
      setFuncPendentes([]);
      setValesPendentes([]);
      setSelectedItems([]);
      setSelectedVales([]);
      setValorSalario("");
    }
  }, [selectedFuncionarioId, funcionarios]);

  // --- LOADERS ---
  const loadFuncionarios = async () => {
    try {
      const res = await api.get("/funcionario");
      setFuncionarios(res.data);
    } catch (e) {
      console.error(e);
    }
  };

  const loadData = async (id: string) => {
    try {
      // 1. Comiss√µes
      const resComissao = await api.get(`/pagamento-equipe/pendentes/${id}`);
      setFuncPendentes(resComissao.data);
      // Auto-select Finalized Commissions
      setSelectedItems(
        resComissao.data
          .filter((i: any) => i.ordem_de_servico?.status === "FINALIZADA")
          .map((i: any) => i.id_servico_mao_de_obra),
      );

      // 2. Vales Pendentes
      const resVales = await api.get(`/pagamento-equipe/vales/${id}`);
      setValesPendentes(resVales.data);
      // Auto-select ALL Vales by default for Deduction
      setSelectedVales(resVales.data.map((v: any) => v.id_pagamento_equipe));
    } catch (error) {
      console.error(error);
    }
  };

  // --- FILTERS ---
  const filteredComissioes = useMemo(() => {
    return funcPendentes.filter((item: any) => {
      if (!filterStart && !filterEnd) return true;
      const dateStr =
        item.ordem_de_servico?.dt_finalizacao ||
        item.ordem_de_servico?.dt_entrega ||
        item.ordem_de_servico?.dt_abertura;
      const osDate = dateStr ? new Date(dateStr) : null;
      if (!osDate) return true;

      const start = filterStart
        ? new Date(filterStart)
        : new Date("1900-01-01");
      const end = filterEnd ? new Date(filterEnd) : new Date("2100-01-01");
      end.setHours(23, 59, 59);

      return osDate >= start && osDate <= end;
    });
  }, [funcPendentes, filterStart, filterEnd]);

  // --- TOTALS (Mode PAGAMENTO) ---
  // Helper to calculate commission value per item
  const getCommissionValue = (itemVal: number) => {
    const func = funcionarios.find(
      (f) => String(f.id_funcionario) === String(selectedFuncionarioId),
    );
    const pct = func?.comissao || 0;
    return (itemVal * pct) / 100;
  };

  const totalComissoes = useMemo(() => {
    return funcPendentes
      .filter((i) => selectedItems.includes(i.id_servico_mao_de_obra))
      .reduce((acc, curr) => {
        const comissao = getCommissionValue(Number(curr.valor));
        return acc + comissao;
      }, 0);
  }, [funcPendentes, selectedItems, funcionarios, selectedFuncionarioId]);

  const totalDescontos = useMemo(() => {
    // Sum of SELECTED Vales to deduct
    return valesPendentes
      .filter((v) => selectedVales.includes(v.id_pagamento_equipe))
      .reduce((acc, v) => acc + Number(v.valor_total), 0);
  }, [valesPendentes, selectedVales]);

  const finalTotalPagamento = useMemo(() => {
    const salario = includeSalary ? Number(valorSalario) || 0 : 0;
    const premios = Number(valorPremio) || 0;
    return salario + totalComissoes + premios - totalDescontos;
  }, [
    valorSalario,
    totalComissoes,
    valorPremio,
    totalDescontos,
    includeSalary,
  ]);

  // --- HANDLERS ---
  const handleSelectAllComissoes = () => {
    const payables = filteredComissioes.filter(
      (i: any) => i.ordem_de_servico?.status === "FINALIZADA",
    );
    const allSelected =
      payables.length > 0 &&
      payables.every((p: any) =>
        selectedItems.includes(p.id_servico_mao_de_obra),
      );
    if (allSelected) setSelectedItems([]);
    else setSelectedItems(payables.map((i: any) => i.id_servico_mao_de_obra));
  };

  const handleSelectAllVales = () => {
    if (valesPendentes.length === selectedVales.length) setSelectedVales([]);
    else setSelectedVales(valesPendentes.map((v) => v.id_pagamento_equipe));
  };

  const handlePay = async () => {
    if (!selectedFuncionarioId) return;

    try {
      setIsLoading(true);
      if (mode === "ADIANTAMENTO") {
        // Post ADIANTAMENTO (Vale)
        await api.post("/pagamento-equipe", {
          id_funcionario: selectedFuncionarioId,
          servicos_ids: [],
          vales_ids: [], // No deduction when creating a vale
          valor_total: valorAdiantamento,
          obs: obsPagamento, // General Obs
          forma_pagamento: paymentMethod,
          premio_valor: null,
          tipo_lancamento: "VALE", // Backend uses VALE for Adiantamento
          referencia_inicio: dataAdiantamento
            ? new Date(dataAdiantamento)
            : null, // Use ref date as creation date override if needed, or just obs
        });
      } else {
        // Post PAGAMENTO (Full)
        await api.post("/pagamento-equipe", {
          id_funcionario: selectedFuncionarioId,
          servicos_ids: selectedItems,
          vales_ids: selectedVales, // Deduct these vales
          valor_total: finalTotalPagamento, // Net Value
          obs: obsPagamento,
          forma_pagamento: paymentMethod,
          premio_valor: valorPremio || null,
          premio_descricao: obsExtra || null,
          tipo_lancamento: "COMISSAO", // Or 'PAGAMENTO' if backend supports, keeping 'COMISSAO' for now as it consolidates OSs
          referencia_inicio: null,
          include_salary: includeSalary, // Helper for backend if needed, or simply logic handles it by value passed
        });
      }

      setStatusMsg({
        type: "success",
        text: "Lan√ßamento realizado com sucesso!",
      });
      setTimeout(() => navigate("/pagamento-equipe"), 1500);
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao processar lan√ßamento." });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="space-y-6 animate-in fade-in duration-500">
      <StatusBanner
        msg={statusMsg}
        onClose={() => setStatusMsg({ type: null, text: "" })}
      />

      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <button
            onClick={() => navigate("/pagamento-equipe")}
            className="text-sm font-bold text-neutral-500 hover:text-neutral-800 mb-1 flex items-center gap-1"
          >
            <ArrowRight className="rotate-180" size={14} /> Voltar
          </button>
          <h1 className="text-2xl font-black text-neutral-900 tracking-tight">
            Novo Pagamento / Adiantamento
          </h1>
        </div>
      </div>

      <div className="bg-white p-6 rounded-3xl shadow-sm border border-neutral-100 grid grid-cols-1 md:grid-cols-3 gap-6">
        {/* 1. SELE√á√ÉO DE COLABORADOR */}
        <div className="md:col-span-1">
          <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-2">
            Colaborador
          </label>
          <div className="relative">
            <User
              className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"
              size={18}
            />
            <select
              value={selectedFuncionarioId}
              onChange={(e) => setSelectedFuncionarioId(e.target.value)}
              className="w-full pl-10 pr-4 py-3 bg-white border border-neutral-200 rounded-lg font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-colors text-neutral-600 appearance-none"
            >
              <option value="">Selecione...</option>
              {funcionarios.map((f: any) => (
                <option key={f.id_funcionario} value={f.id_funcionario}>
                  {f.pessoa_fisica?.pessoa?.nome}
                </option>
              ))}
            </select>
          </div>
        </div>

        {/* 2. TIPO DE LAN√áAMENTO (MODE) */}
        <div className="md:col-span-2">
          <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-2">
            Modo de Lan√ßamento
          </label>
          <div className="flex bg-neutral-100 p-1 rounded-xl w-fit">
            <button
              onClick={() => setMode("PAGAMENTO")}
              className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                mode === "PAGAMENTO"
                  ? "bg-primary-200 text-primary-500 shadow-sm"
                  : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
              }`}
            >
              Pagamento (Sal√°rio/Comiss√µes)
            </button>
            <button
              onClick={() => setMode("ADIANTAMENTO")}
              className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                mode === "ADIANTAMENTO"
                  ? "bg-primary-200 text-primary-500 shadow-sm"
                  : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
              }`}
            >
              Adiantamento (Novo Vale)
            </button>
          </div>
        </div>
      </div>

      {selectedFuncionarioId && (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
          {/* LEFT COLUMN: DETAILS */}
          <div className="lg:col-span-2 space-y-6">
            {/* CARD COMISS√ïES (Only in PAGAMENTO mode) */}
            {mode === "PAGAMENTO" && (
              <div className="bg-white rounded-xl shadow-sm border border-neutral-100 overflow-hidden">
                <div className="p-4 bg-neutral-50 border-b border-neutral-100 flex items-center justify-between">
                  <h3 className="font-black text-neutral-700 flex items-center gap-2">
                    <Calculator size={18} className="text-primary-500" />{" "}
                    Comiss√µes
                    <span className="text-xs font-normal text-neutral-400 bg-neutral-100 px-2 py-0.5 rounded-full">
                      {funcionarios.find(
                        (f) =>
                          String(f.id_funcionario) ===
                          String(selectedFuncionarioId),
                      )?.comissao || 0}
                      %
                    </span>
                  </h3>
                  <div className="flex items-center gap-3">
                    <button
                      onClick={handleSelectAllComissoes}
                      className="text-[10px] font-black uppercase tracking-widest text-primary-600 hover:text-primary-700"
                    >
                      {selectedItems.length > 0 &&
                      selectedItems.length >=
                        filteredComissioes.filter(
                          (i: any) =>
                            i.ordem_de_servico?.status === "FINALIZADA",
                        ).length
                        ? "Desmarcar Todas"
                        : "Marcar Todas"}
                    </button>
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4 p-4 border-b border-neutral-100 bg-white">
                  <div>
                    <label className="text-[9px] font-bold text-neutral-400 uppercase tracking-widest block mb-1">
                      De
                    </label>
                    <Input
                      type="date"
                      value={filterStart}
                      onChange={(e) => setFilterStart(e.target.value)}
                      className="bg-neutral-50 border-neutral-200 text-xs font-bold"
                    />
                  </div>
                  <div>
                    <label className="text-[9px] font-bold text-neutral-400 uppercase tracking-widest block mb-1">
                      At√©
                    </label>
                    <Input
                      type="date"
                      value={filterEnd}
                      onChange={(e) => setFilterEnd(e.target.value)}
                      className="bg-neutral-50 border-neutral-200 text-xs font-bold"
                    />
                  </div>
                </div>

                <div className="max-h-[400px] overflow-y-auto p-2 space-y-2 bg-neutral-50/30">
                  {filteredComissioes.length === 0 ? (
                    <div className="p-8 text-center text-neutral-400 text-sm italic">
                      Nenhuma comiss√£o pendente.
                    </div>
                  ) : (
                    filteredComissioes.map((item: any) => {
                      const isPayable =
                        item.ordem_de_servico?.status === "FINALIZADA";
                      const isSelected = selectedItems.includes(
                        item.id_servico_mao_de_obra,
                      );
                      const os = item.ordem_de_servico;
                      const valorComissao = getCommissionValue(
                        Number(item.valor),
                      );

                      return (
                        <div
                          key={item.id_servico_mao_de_obra}
                          onClick={() => {
                            if (isPayable)
                              isSelected
                                ? setSelectedItems((prev) =>
                                    prev.filter(
                                      (id) =>
                                        id !== item.id_servico_mao_de_obra,
                                    ),
                                  )
                                : setSelectedItems((prev) => [
                                    ...prev,
                                    item.id_servico_mao_de_obra,
                                  ]);
                          }}
                          className={`p-4 rounded-xl border transition-all cursor-pointer flex gap-4 ${isSelected ? "bg-primary-50 border-primary-200 ring-1 ring-primary-100" : isPayable ? "bg-white border-neutral-200 hover:border-primary-200" : "bg-neutral-100 border-neutral-100 opacity-60 cursor-not-allowed"}`}
                        >
                          <div
                            className={`mt-1 ${isSelected ? "text-primary-600" : isPayable ? "text-neutral-300" : "text-neutral-200"}`}
                          >
                            {isSelected ? (
                              <CheckCircle2 size={24} />
                            ) : (
                              <Circle size={24} />
                            )}
                          </div>
                          <div className="flex-1 space-y-2">
                            {/* ROW 1: Header */}
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-2">
                                <span className="text-xs font-black bg-neutral-100 px-2 py-0.5 rounded text-neutral-600 uppercase">
                                  OS #{item.id_os}
                                </span>
                                <span
                                  className={`text-[10px] font-black px-2 py-0.5 rounded uppercase border ${
                                    os?.status === "FINALIZADA"
                                      ? "bg-emerald-50 text-emerald-600 border-emerald-100"
                                      : os?.status === "ABERTA"
                                        ? "bg-blue-50 text-blue-600 border-blue-100"
                                        : os?.status === "CANCELADA"
                                          ? "bg-red-50 text-red-600 border-red-100"
                                          : os?.status === "PAGA_CLIENTE"
                                            ? "bg-cyan-50 text-cyan-600 border-cyan-100"
                                            : "bg-gray-50 text-gray-500 border-gray-100"
                                  }`}
                                >
                                  {os?.status
                                    ? os.status.replace(/_/g, " ")
                                    : "N/A"}
                                </span>
                                {!isPayable && (
                                  <span className="text-[10px] font-bold text-red-400 uppercase ml-2">
                                    (N√£o Finalizada)
                                  </span>
                                )}
                              </div>
                              <div className="text-right">
                                <span className="font-black text-emerald-600 text-lg">
                                  {formatCurrency(valorComissao)}
                                </span>
                                <div className="text-[9px] text-neutral-400 font-bold uppercase tracking-wide">
                                  Valor Servi√ßo:{" "}
                                  {formatCurrency(Number(item.valor))}
                                </div>
                              </div>
                            </div>

                            {/* ROW 2: Vehicle */}
                            <div className="flex items-center gap-2 text-sm text-neutral-800">
                              <span className="font-bold">
                                {os?.veiculo?.modelo}
                              </span>
                              <span className="text-neutral-300">‚Ä¢</span>
                              <span className="text-neutral-600">
                                {os?.veiculo?.cor}
                              </span>
                              <span className="text-neutral-300">‚Ä¢</span>
                              <span className="font-mono bg-neutral-100 px-1 rounded text-neutral-600 text-xs">
                                {os?.veiculo?.placa}
                              </span>
                            </div>

                            {/* ROW 3: Client */}
                            <div className="text-xs font-bold text-neutral-500">
                              Cliente:{" "}
                              <span className="text-neutral-700">
                                {os?.cliente?.pessoa_fisica?.pessoa?.nome ||
                                  os?.cliente?.pessoa_juridica?.razao_social ||
                                  "Desconhecido"}
                              </span>
                            </div>

                            {/* ROW 4: Defect/Diag */}
                            {(os?.defeito_relatado || os?.diagnostico) && (
                              <div className="bg-neutral-50 p-2 rounded-lg text-[11px] space-y-1 mt-1 border border-neutral-100/50">
                                {os?.defeito_relatado && (
                                  <div className="text-neutral-600">
                                    <strong className="text-neutral-400 uppercase tracking-wider text-[9px]">
                                      Defeito:
                                    </strong>{" "}
                                    {os.defeito_relatado}
                                  </div>
                                )}
                                {os?.diagnostico && (
                                  <div className="text-neutral-600">
                                    <strong className="text-neutral-400 uppercase tracking-wider text-[9px]">
                                      Diag:
                                    </strong>{" "}
                                    {os.diagnostico}
                                  </div>
                                )}
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    })
                  )}
                </div>
              </div>
            )}

            {/* CARD ADIANTAMENTOS PENDENTES (Hist√≥rico) */}
            <div className="bg-white rounded-xl shadow-sm border border-neutral-100 overflow-hidden">
              <div className="p-4 bg-orange-50 border-b border-orange-100 flex items-center justify-between">
                <h3 className="font-bold text-orange-800 flex items-center gap-2">
                  <DollarSign size={18} className="text-orange-600" />
                  {mode === "PAGAMENTO"
                    ? "Descontar Adiantamentos Pendentes"
                    : "Hist√≥rico de Adiantamentos Pendentes"}
                </h3>
                {mode === "PAGAMENTO" && (
                  <button
                    onClick={handleSelectAllVales}
                    className="text-[10px] font-black uppercase tracking-widest text-amber-700 hover:text-amber-900"
                  >
                    {valesPendentes.length > 0 &&
                    selectedVales.length === valesPendentes.length
                      ? "Desmarcar Todos"
                      : "Marcar Todos"}
                  </button>
                )}
              </div>
              <div className="max-h-[250px] overflow-y-auto p-2 space-y-2 bg-neutral-50/30">
                {valesPendentes.length === 0 ? (
                  <div className="p-6 text-center text-neutral-400 text-sm italic">
                    O colaborador n√£o possui adiantamentos pendentes.
                  </div>
                ) : (
                  valesPendentes.map((vale: any) => {
                    const isSelected = selectedVales.includes(
                      vale.id_pagamento_equipe,
                    );
                    // In Adiantamento mode, items are not selectable (read-only list)
                    const isReadOnly = mode === "ADIANTAMENTO";

                    return (
                      <div
                        key={vale.id_pagamento_equipe}
                        onClick={() =>
                          !isReadOnly &&
                          (isSelected
                            ? setSelectedVales((prev) =>
                                prev.filter(
                                  (id) => id !== vale.id_pagamento_equipe,
                                ),
                              )
                            : setSelectedVales((prev) => [
                                ...prev,
                                vale.id_pagamento_equipe,
                              ]))
                        }
                        className={`p-3 rounded-xl border transition-all flex gap-3 ${!isReadOnly ? "cursor-pointer hover:border-amber-200" : ""} ${isSelected && !isReadOnly ? "bg-amber-50/50 border-amber-200 ring-1 ring-amber-100" : "bg-white border-neutral-200"}`}
                      >
                        {!isReadOnly && (
                          <div
                            className={`mt-1 ${isSelected ? "text-amber-600" : "text-neutral-300"}`}
                          >
                            {isSelected ? (
                              <CheckSquare size={18} />
                            ) : (
                              <Square size={18} />
                            )}
                          </div>
                        )}
                        <div className="flex-1 flex justify-between items-center">
                          <div>
                            <div className="text-xs font-bold text-neutral-800">
                              Lan√ßado em{" "}
                              {new Date(vale.dt_pagamento).toLocaleDateString()}
                            </div>
                            <div className="text-[10px] text-neutral-500 italic mt-0.5">
                              {vale.obs || "Sem observa√ß√£o"}
                            </div>
                          </div>
                          <span className="font-black text-red-500 text-sm font-mono">
                            - {formatCurrency(Number(vale.valor_total))}
                          </span>
                        </div>
                      </div>
                    );
                  })
                )}
              </div>
              {valesPendentes.length > 0 && mode === "PAGAMENTO" && (
                <div className="p-3 bg-neutral-50 border-t border-neutral-100 text-right">
                  <span className="text-[10px] font-bold uppercase tracking-widest text-orange-700">
                    Total a Descontar:{" "}
                  </span>
                  <span className="text-sm font-bold text-red-600">
                    {formatCurrency(totalDescontos)}
                  </span>
                </div>
              )}
            </div>
          </div>

          {/* RIGHT COLUMN: SUMMARY & ACTIONS */}
          <div className="lg:col-span-1 space-y-6">
            {/* CARD FORMUL√ÅRIO (Context Sensitive) */}
            <div className="bg-white rounded-xl shadow-sm border border-neutral-100 p-6 space-y-4">
              <h3 className="font-bold text-neutral-900 text-lg">Detalhes</h3>

              {mode === "PAGAMENTO" ? (
                <>
                  {/* PAGAMENTO MODE INPUTS */}
                  <div>
                    <div className="flex items-center gap-2 mb-2">
                      <input
                        type="checkbox"
                        id="chkSalary"
                        checked={includeSalary}
                        onChange={(e) => setIncludeSalary(e.target.checked)}
                        className="w-4 h-4 rounded border-neutral-300 text-neutral-900 focus:ring-neutral-900"
                      />
                      <label
                        htmlFor="chkSalary"
                        className="text-[10px] font-black text-neutral-400 uppercase tracking-widest cursor-pointer select-none"
                      >
                        Incluir Pagamento de Contrato?
                      </label>
                    </div>
                    <Input
                      type="number"
                      disabled={!includeSalary}
                      value={valorSalario}
                      onChange={(e) => setValorSalario(e.target.value)}
                      placeholder="0.00"
                    />
                  </div>
                  <div>
                    <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-1">
                      Pr√™mios / Extras (R$)
                    </label>
                    <Input
                      type="number"
                      value={valorPremio}
                      onChange={(e) => setValorPremio(e.target.value)}
                      placeholder="0.00"
                    />
                  </div>
                  {valorPremio && (
                    <div>
                      <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-1">
                        Motivo do Pr√™mio
                      </label>
                      <Input
                        value={obsExtra}
                        onChange={(e) => setObsExtra(e.target.value)}
                        placeholder="Ex: Meta Batida"
                      />
                    </div>
                  )}
                </>
              ) : (
                <>
                  {/* ADIANTAMENTO MODE INPUTS */}
                  <div>
                    <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-1">
                      Valor do Novo Adiantamento (R$)
                    </label>
                    <Input
                      type="number"
                      value={valorAdiantamento}
                      onChange={(e) => setValorAdiantamento(e.target.value)}
                      placeholder="0.00"
                      autoFocus
                      className="border-orange-200 focus:border-orange-500 focus:ring-orange-500/20"
                    />
                  </div>
                  <div>
                    <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-1">
                      Data do Lan√ßamento
                    </label>
                    <Input
                      type="date"
                      value={dataAdiantamento}
                      onChange={(e) => setDataAdiantamento(e.target.value)}
                    />
                  </div>
                </>
              )}

              <div>
                <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-1">
                  Forma Pagto
                </label>
                <select
                  value={paymentMethod}
                  onChange={(e) => setPaymentMethod(e.target.value)}
                  className="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-lg font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-colors"
                >
                  <option value="DINHEIRO">Dinheiro</option>
                  <option value="PIX">Pix</option>
                  <option value="TRANSFERENCIA">Transfer√™ncia</option>
                </select>
              </div>

              <div>
                <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-1">
                  Obs Geral
                </label>
                <textarea
                  value={obsPagamento}
                  onChange={(e) => setObsPagamento(e.target.value)}
                  className="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-lg font-bold text-xs outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-all resize-none"
                  rows={2}
                />
              </div>
            </div>

            {/* TOTAL FINAL CARD (Only in PAGAMENTO mode, or just Button in Adiantamento) */}
            {mode === "PAGAMENTO" ? (
              <div className="bg-neutral-900 text-white rounded-xl shadow-xl shadow-neutral-900/10 p-6 space-y-4">
                <div className="space-y-1">
                  <div className="flex justify-between text-xs text-neutral-400">
                    <span>(+) Pagamento</span>
                    <span
                      className={`font-bold ${includeSalary ? "text-emerald-400" : "text-neutral-600 line-through opacity-50"}`}
                    >
                      {formatCurrency(
                        includeSalary ? Number(valorSalario) || 0 : 0,
                      )}
                    </span>
                  </div>
                  <div className="flex justify-between text-xs text-neutral-400">
                    <span>(+) Comiss√µes</span>
                    <span className="font-bold text-emerald-400">
                      {formatCurrency(totalComissoes)}
                    </span>
                  </div>
                  <div className="flex justify-between text-xs text-neutral-400">
                    <span>(+) Pr√™mios</span>
                    <span className="font-bold text-emerald-400">
                      {formatCurrency(Number(valorPremio) || 0)}
                    </span>
                  </div>
                  <div className="flex justify-between text-xs text-neutral-400 pt-1 border-t border-dashed border-neutral-800">
                    <span>(-) Descontos</span>
                    <span className="font-bold text-red-400">
                      {formatCurrency(totalDescontos)}
                    </span>
                  </div>

                  <div className="border-t border-neutral-800 my-2 pt-3 flex justify-between items-end">
                    <span className="font-bold uppercase tracking-widest text-xs text-white">
                      Total a Pagar
                    </span>
                    <span className="font-black text-3xl">
                      {formatCurrency(finalTotalPagamento)}
                    </span>
                  </div>
                </div>

                <Button
                  onClick={handlePay}
                  variant="success"
                  className="w-full py-4 rounded-xl font-bold uppercase tracking-widest text-sm"
                  disabled={isLoading}
                >
                  Confirmar Pagamento
                </Button>
              </div>
            ) : (
              <div className="bg-orange-500 text-white rounded-xl shadow-xl shadow-orange-900/10 p-6 space-y-4">
                <div className="flex justify-between items-end border-b border-white/20 pb-4">
                  <span className="font-bold uppercase tracking-widest text-xs text-orange-100">
                    Valor Adiantamento
                  </span>
                  <span className="font-black text-3xl">
                    {formatCurrency(Number(valorAdiantamento))}
                  </span>
                </div>
                <Button
                  onClick={handlePay}
                  className="w-full bg-white text-orange-600 hover:bg-orange-50 border-transparent py-4 rounded-xl font-bold uppercase tracking-widest text-sm"
                  disabled={isLoading}
                >
                  Confirmar Lan√ßamento
                </Button>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\OrdemDeServicoDetalhePage.tsx
================================================================================
import { useState, useEffect, useRef } from "react";
import type { FormEvent } from "react";
import { formatCurrency } from "../utils/formatCurrency";

import { useParams, useNavigate } from "react-router-dom";
import { api } from "../services/api";
import type { IOrdemDeServico } from "../types/backend";
import {
  Search,
  Plus,
  Trash2,
  Package,
  Wrench,
  CheckCircle,
  BadgeCheck,
  DollarSign,
  ArrowLeft,
  Save,
  Edit,
} from "lucide-react";

import { StatusBanner } from "../components/ui/StatusBanner";
import { Modal } from "../components/ui/Modal";
import { Button } from "../components/ui/Button";
import { ActionButton } from "../components/ui/ActionButton";
import { PagamentoClienteForm } from "../components/forms/PagamentoClienteForm";
import { LaborManager } from "../components/os/LaborManager";

export const OrdemDeServicoDetalhePage = () => {
  const { id } = useParams();
  const navigate = useNavigate();

  // --- STATE ---
  const [os, setOs] = useState<IOrdemDeServico | null>(null);
  const [osItems, setOsItems] = useState<any[]>([]);
  const [laborServices, setLaborServices] = useState<any[]>([]);
  const [employees, setEmployees] = useState<any[]>([]);
  const [availableParts, setAvailableParts] = useState<any[]>([]);
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });
  const [isDirty, setIsDirty] = useState(false);

  // Confirm Modal
  const [confirmModal, setConfirmModal] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    onConfirm: () => void;
  }>({ isOpen: false, title: "", message: "", onConfirm: () => {} });

  // Items / Parts Management
  const [partSearch, setPartSearch] = useState("");
  const [partResults, setPartResults] = useState<any[]>([]);
  const [newItem, setNewItem] = useState({
    id_pecas_estoque: "",
    quantidade: "1",
    valor_venda: "",
    descricao: "",
    codigo_referencia: "",
    id_fornecedor: "",
  });
  const [editingItemId, setEditingItemId] = useState<number | null>(null);
  const [highlightIndex, setHighlightIndex] = useState(-1);

  // Refs
  const partInputRef = useRef<HTMLInputElement>(null);
  const quantityInputRef = useRef<HTMLInputElement>(null);
  const referenceInputRef = useRef<HTMLInputElement>(null);

  // Edit Item Modal
  const [editItemModalOpen, setEditItemModalOpen] = useState(false);
  const [editingItemData, setEditingItemData] = useState<any>(null);

  // Payment Modal
  const [showPaymentModal, setShowPaymentModal] = useState(false);

  const [selectedStockInfo, setSelectedStockInfo] = useState<{
    qtd: number;
    reserved: number;
  } | null>(null);

  // --- LOADING ---
  const loadOsData = async () => {
    if (!id) return;
    try {
      const response = await api.get(`/ordem-de-servico/${id}`);
      setOs(response.data);
      setOsItems(response.data.itens_os || []);
      setLaborServices(response.data.servicos_mao_de_obra || []);
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao carregar OS." });
    }
  };

  const loadEmployees = async () => {
    try {
      const response = await api.get("/funcionario");
      setEmployees(response.data);
    } catch (error) {
      console.error(error);
    }
  };

  const loadParts = async () => {
    try {
      const response = await api.get("/pecas-estoque");
      setAvailableParts(response.data);
    } catch (error) {
      console.error(error);
    }
  };

  const loadOsItems = async (idOs: number) => {
    try {
      const response = await api.get(`/itens-os/os/${idOs}`);
      setOsItems(response.data);
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao carregar itens." });
    }
  };

  useEffect(() => {
    loadOsData();
    loadEmployees();
    loadParts();
  }, [id]);

  // --- HANDLERS ---

  const updateOSField = async (field: string, value: any) => {
    if (!os || os.status === "FINALIZADA" || os.status === "PAGA_CLIENTE")
      return;

    try {
      setOs((prev) => (prev ? { ...prev, [field]: value } : null));
      await api.put(`/ordem-de-servico/${os.id_os}`, { [field]: value });
      setIsDirty(false);
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao salvar altera√ß√£o." });
    }
  };

  const handlePartSearch = async (val: string) => {
    setPartSearch(val);
    if (val.length < 2) {
      setPartResults([]);
      return;
    }
    try {
      const [stockRes, historyRes] = await Promise.all([
        api.get(`/pecas-estoque/search?q=${val}`),
        api.get(`/itens-os/search/desc?q=${val}`),
      ]);
      const historyFormatted = historyRes.data.map((h: any) => ({
        id_pecas_estoque: null,
        nome: h.descricao,
        valor_venda: h.valor_venda,
        fabricante: "Hist√≥rico",
        isHistory: true,
      }));
      const combined = [...stockRes.data, ...historyFormatted];
      const unique = combined.filter(
        (v, i, a) => a.findIndex((t) => t.nome === v.nome) === i,
      );
      setPartResults(unique);
    } catch (e) {
      console.error(e);
    }
  };

  const selectPart = (p: any) => {
    setNewItem({
      ...newItem,
      id_pecas_estoque: String(p.id_pecas_estoque),
      valor_venda: String(p.valor_venda),
      descricao: p.nome,
    });
    setPartSearch(p.nome);
    setPartResults([]);
    setHighlightIndex(-1);
    setIsDirty(true);
    requestAnimationFrame(() => referenceInputRef.current?.focus());
  };

  const handleAddItem = async (e?: FormEvent) => {
    if (e) e.preventDefault();
    if (!os) return;
    try {
      const part = availableParts.find(
        (p) => p.id_pecas_estoque === Number(newItem.id_pecas_estoque),
      );
      const description = part
        ? part.nome
        : newItem.descricao || partSearch || "Item Diverso";
      const qtd = Number(newItem.quantidade);
      const val = Number(newItem.valor_venda);

      if (editingItemId) {
        await api.put(`/itens-os/${editingItemId}`, {
          descricao: description,
          quantidade: qtd,
          valor_venda: val,
          valor_total: qtd * val,
          codigo_referencia: newItem.codigo_referencia,
          id_fornecedor: newItem.id_fornecedor || null,
        });
        setStatusMsg({ type: "success", text: "Item adicionado/atualizado!" });
      } else {
        await api.post("/itens-os", {
          id_os: os.id_os,
          id_pecas_estoque: newItem.id_pecas_estoque
            ? Number(newItem.id_pecas_estoque)
            : null,
          descricao: description,
          quantidade: qtd,
          valor_venda: val,
          valor_total: qtd * val,
          codigo_referencia: newItem.codigo_referencia,
          id_fornecedor: newItem.id_fornecedor || null,
        });
        setStatusMsg({ type: "success", text: "Item adicionado!" });
      }
      setNewItem({
        id_pecas_estoque: "",
        quantidade: "1",
        valor_venda: "",
        descricao: "",
        codigo_referencia: "",
        id_fornecedor: "",
      });
      setSelectedStockInfo(null);
      setPartSearch("");
      setEditingItemId(null);
      loadOsItems(os.id_os);
      setTimeout(() => setStatusMsg({ type: null, text: "" }), 1500);
      requestAnimationFrame(() => partInputRef.current?.focus());
      setTimeout(() => partInputRef.current?.focus(), 100);
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao salvar item." });
    }
  };

  const handleDeleteItem = (itemId: number) => {
    if (!os) return;
    setConfirmModal({
      isOpen: true,
      title: "Excluir Item",
      message: "Deseja excluir este item?",
      onConfirm: async () => {
        await api.delete(`/itens-os/${itemId}`);
        loadOsItems(os.id_os);
        setConfirmModal((prev) => ({ ...prev, isOpen: false }));
      },
    });
  };

  const handleEditItem = (item: any) => {
    setEditingItemData({
      ...item,
      id_fornecedor: item.pagamentos_peca?.[0]?.id_fornecedor || "",
    });
    setEditItemModalOpen(true);
  };

  const handleSaveItemEdit = async () => {
    if (!editingItemData || !os) return;
    try {
      const qtd = Number(editingItemData.quantidade);
      const val = Number(editingItemData.valor_venda);
      await api.put(`/itens-os/${editingItemData.id_iten}`, {
        descricao: editingItemData.descricao,
        quantidade: qtd,
        valor_venda: val,
        valor_total: qtd * val,
        codigo_referencia: editingItemData.codigo_referencia,
        id_fornecedor: editingItemData.id_fornecedor
          ? Number(editingItemData.id_fornecedor)
          : null,
        id_pecas_estoque: editingItemData.id_pecas_estoque
          ? Number(editingItemData.id_pecas_estoque)
          : null,
      });
      loadOsItems(os.id_os);
      setEditItemModalOpen(false);
      setEditingItemData(null);
    } catch (e) {
      setStatusMsg({ type: "error", text: "Erro ao editar item." });
    }
  };

  const handleFinishService = async () => {
    if (!os) return;

    setConfirmModal({
      isOpen: true,
      title: "Finalizar OS",
      message:
        "Deseja Finalizar a OS? Isso ir√° gerar o financeiro e mudar o status.",
      onConfirm: async () => executeFinish(),
    });
  };

  const executeFinish = async () => {
    if (!os) return;
    const totalItems = osItems.reduce(
      (acc, item) => acc + Number(item.valor_total),
      0,
    );

    const sumLaborServices = laborServices.reduce(
      (acc, l) => acc + Number(l.valor),
      0,
    );
    const finalLaborValue =
      laborServices.length > 0
        ? sumLaborServices
        : Number(os.valor_mao_de_obra || 0);

    try {
      await api.put(`/ordem-de-servico/${os.id_os}`, {
        valor_pecas: totalItems,
        valor_mao_de_obra: finalLaborValue,
        valor_total_cliente: totalItems + finalLaborValue,
        status: "PRONTO PARA FINANCEIRO",
        dt_entrega: os.dt_entrega
          ? new Date(os.dt_entrega).toISOString()
          : new Date().toISOString(),
      });
      setStatusMsg({
        type: "success",
        text: "OS Finalizada! Enviada para Financeiro.",
      });
      setIsDirty(false);
      setConfirmModal((prev) => ({ ...prev, isOpen: false }));
      setTimeout(() => {
        setStatusMsg({ type: null, text: "" });
        navigate("/");
      }, 1000);
    } catch (e) {
      setStatusMsg({ type: "error", text: "Erro ao finalizar OS." });
    }
  };

  const handleSaveAndClose = async () => {
    if (!os) return;
    try {
      await api.put(`/ordem-de-servico/${os.id_os}`, {
        defeito_relatado: os.defeito_relatado,
        diagnostico: os.diagnostico,
        km_entrada: os.km_entrada,
      });
      setIsDirty(false);
      setStatusMsg({ type: "success", text: "Altera√ß√µes Salvas!" });
      setTimeout(() => navigate("/"), 500);
    } catch (e) {
      setStatusMsg({ type: "error", text: "Erro ao salvar." });
    }
  };

  const handleBack = () => {
    if (isDirty) {
      setConfirmModal({
        isOpen: true,
        title: "Altera√ß√µes Pendentes",
        message: "Deseja Salvar as altera√ß√µes?",
        onConfirm: () => {
          setConfirmModal((prev) => ({ ...prev, isOpen: false }));
          handleSaveAndClose();
        },
      });
    } else {
      navigate("/");
    }
  };

  const getStatusStyle = (status: string) => {
    switch (status) {
      case "FINALIZADA":
        return "bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200";
      case "PAGA_CLIENTE":
        return "bg-neutral-100 text-neutral-600 ring-1 ring-neutral-200";
      case "PRONTO PARA FINANCEIRO":
        return "bg-amber-100 text-amber-700 ring-1 ring-amber-200";
      case "ABERTA":
        return "bg-blue-100 text-blue-700 ring-1 ring-blue-200";
      case "EM_ANDAMENTO":
        return "bg-cyan-100 text-cyan-700 ring-1 ring-cyan-200";
      default:
        return "bg-gray-50 text-gray-500 ring-1 ring-gray-200";
    }
  };

  if (!os) {
    return (
      <div className="p-8 text-center text-neutral-500">
        Carregando detalhes da OS...
      </div>
    );
  }

  return (
    <div className="space-y-6 pb-20">
      {statusMsg.text && (
        <div className="fixed bottom-8 right-8 z-60">
          <StatusBanner
            msg={statusMsg}
            onClose={() => setStatusMsg({ type: null, text: "" })}
          />
        </div>
      )}

      {/* HEADER with Back Button */}
      <div className="flex items-center gap-4">
        <button
          onClick={handleBack}
          className="p-2 hover:bg-neutral-100 rounded-lg transition-colors text-neutral-600"
        >
          <ArrowLeft size={24} />
        </button>
        <div className="flex-1">
          <div className="flex items-baseline gap-3">
            <h1 className="text-2xl font-bold text-neutral-600 tracking-tight">
              OS #{os.id_os}
            </h1>
            <span
              className={`px-3 py-1 rounded-md text-[10px] font-bold uppercase whitespace-nowrap ${getStatusStyle(os.status)}`}
            >
              {os.status === "PRONTO PARA FINANCEIRO"
                ? "FINANCEIRO"
                : os.status.replace(/_/g, " ")}
            </span>
          </div>
        </div>
      </div>

      <div className="space-y-8">
        {/* Header Info */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 p-6 bg-neutral-25 rounded-2xl border border-neutral-200 items-center shadow-sm">
          {/* Coluna 1: Ve√≠culo */}
          <div className="space-y-1">
            <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-wider">
              Ve√≠culo
            </p>
            <div className="flex flex-col">
              <h3 className="text-2xl font-bold text-neutral-600 leading-none tracking-tight">
                {os.veiculo?.modelo} - {os.veiculo?.cor || "Cor N/I"}
              </h3>
              <div className="flex items-center gap-2 mt-1">
                <span className="text-sm font-medium text-neutral-600 uppercase tracking-widest  px-2 py-0.5 rounded-md">
                  {os.veiculo?.placa}
                </span>
              </div>
            </div>
          </div>

          {/* Coluna 2: Cliente */}
          <div className="space-y-1">
            <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-wider">
              Cliente / Contato
            </p>
            <div className="flex flex-col">
              <p className="font-bold text-lg text-neutral-600 leading-tight">
                {os.cliente?.pessoa_fisica?.pessoa?.nome ||
                  os.cliente?.pessoa_juridica?.razao_social}
              </p>
              <p className="text-sm font-medium text-neutral-600 flex items-center gap-1">
                {os.cliente?.telefone_1 || "Sem telefone"}
              </p>
            </div>
          </div>

          {/* Coluna 3: Entrada */}
          <div className="flex flex-col gap-1 border-l-2 border-neutral-200 pl-3">
            <span className="text-[10px] font-semibold uppercase tracking-wider text-neutral-400">
              Data de Entrada
            </span>
            <div className="flex items-baseline gap-1">
              <span className="text-lg font-bold text-neutral-700 tabular-nums">
                {new Date(os.dt_abertura).getDate()}
              </span>
              <span className="text-sm font-medium text-neutral-500 capitalize">
                {new Date(os.dt_abertura).toLocaleString("pt-BR", {
                  month: "long",
                })}
              </span>
              <span className="text-sm font-normal text-neutral-400">
                {new Date(os.dt_abertura).getFullYear()}
              </span>
            </div>
          </div>

          {/* Coluna 4: KM */}
          <div className="space-y-1">
            <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-wider block">
              KM Atual
            </label>
            <div className="relative group">
              <input
                className="w-full bg-neutral-50 border border-neutral-200 text-neutral-600 font-bold text-xl rounded-xl px-4 py-2 outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-50 transition-all"
                type="number"
                value={os.km_entrada}
                onChange={(e) =>
                  setOs({ ...os, km_entrada: Number(e.target.value) })
                }
                onBlur={(e) =>
                  updateOSField("km_entrada", Number(e.target.value))
                }
              />
              <span className="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-neutral-300 group-focus-within:text-primary-500 uppercase tracking-wider">
                KM
              </span>
            </div>
          </div>
        </div>

        {/* SPLIT LAYOUT: Defects/Diagnosis (Left) & Labor (Right) */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
          {/* LEFT COL: Text Areas */}
          <div className="space-y-4">
            <div className="space-y-1">
              <label className="flex items-center gap-2 text-[10px] font-bold text-neutral-400 uppercase tracking-wider">
                <span className="w-1.5 h-1.5 rounded-full bg-red-400"></span>{" "}
                Defeito Relatado
              </label>
              <textarea
                className="w-full bg-neutral-25 p-3 rounded-xl border border-neutral-200 text-xs font-medium text-neutral-700 h-24 outline-none focus:border-red-300 focus:bg-neutral-25 resize-none transition-all focus:shadow-sm"
                placeholder="Descreva o defeito..."
                value={os.defeito_relatado || ""}
                onChange={(e) => {
                  setOs({ ...os, defeito_relatado: e.target.value });
                  setIsDirty(true);
                }}
                onBlur={(e) =>
                  updateOSField("defeito_relatado", e.target.value)
                }
              />
            </div>
            <div className="space-y-1">
              <label className="flex items-center gap-2 text-[10px] font-bold text-neutral-400 uppercase tracking-wider">
                <span className="w-1.5 h-1.5 rounded-full bg-blue-400"></span>{" "}
                Diagn√≥stico T√©cnico
              </label>
              <textarea
                className="w-full bg-neutral-25 p-3 rounded-xl border border-neutral-200 text-xs font-medium text-neutral-700 h-24 outline-none focus:border-neutral-200 focus:bg-neutral-25 resize-none transition-all focus:shadow-sm"
                placeholder="Insira o diagn√≥stico..."
                value={os.diagnostico || ""}
                onChange={(e) => {
                  setOs({ ...os, diagnostico: e.target.value });
                  setIsDirty(true);
                }}
                onBlur={(e) => updateOSField("diagnostico", e.target.value)}
              />
            </div>
          </div>

          {/* RIGHT COL: Labor Manager */}
          <div className="w-full space-y-2 h-full">
            <h3 className="text-xs font-bold text-neutral-400  uppercase tracking-widest flex items-center gap-2 pl-1">
              <div className="p-1.5 bg-primary-100 rounded-lg text-primary-600">
                <Wrench size={14} />
              </div>
              M√£o de Obra
            </h3>
            <div className="h-full neutral-25bg-neutral-25 rounded-xl  overflow-hidden">
              <LaborManager
                mode="api"
                osId={os.id_os}
                initialData={laborServices}
                employees={employees}
                onChange={() => loadOsData()}
                readOnly={
                  os.status === "FINALIZADA" || os.status === "PAGA_CLIENTE"
                }
              />
            </div>
          </div>
        </div>

        {/* ITENS (PE√áAS) - FULL WIDTH */}
        <div className="space-y-4 pt-4 border-t border-dashed border-neutral-200">
          <h3 className="text-sm font-bold text-neutral-600 uppercase tracking-widest flex items-center gap-3 pb-2 border-b border-neutral-100">
            <div className="p-1.5 bg-orange-100 rounded-lg text-orange-600">
              <Package size={16} />
            </div>
            Pe√ßas e Produtos
          </h3>
          {/* Form Add Item */}
          {os.status !== "FINALIZADA" && os.status !== "PAGA_CLIENTE" && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* LEFT: MANUAL FORM / SELECTED ITEM */}
              <div className="p-4 rounded-2xl border border-neutral-200 bg-neutral-50 shadow-sm relative">
                <h4 className="text-[10px] font-bold text-neutral-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                  <Package size={14} /> Item a Inserir
                </h4>
                <form onSubmit={handleAddItem} className="space-y-3">
                  <div className="relative">
                    <label className="text-[9px] font-bold text-neutral-400 uppercase">
                      Descri√ß√£o / Nome
                    </label>
                    <input
                      ref={partInputRef}
                      className="w-full p-2.5 rounded-xl border border-neutral-200 bg-neutral-25 font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-50 transition-all"
                      placeholder="Nome do Item ou Servi√ßo"
                      value={newItem.descricao}
                      onChange={(e) =>
                        setNewItem({ ...newItem, descricao: e.target.value })
                      }
                    />
                    {newItem.id_pecas_estoque && (
                      <div className="absolute right-2 top-6 flex items-center gap-1">
                        {selectedStockInfo && (
                          <span className="text-[9px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded font-bold uppercase tracking-wider border border-blue-200">
                            Disp: {selectedStockInfo.qtd}
                          </span>
                        )}
                        <span className="text-[9px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded font-bold uppercase tracking-wider border border-green-200">
                          Estoque
                        </span>
                      </div>
                    )}
                  </div>

                  <div className="flex gap-2">
                    <div className="w-1/3">
                      <label className="text-[9px] font-bold text-neutral-400 uppercase">
                        Ref / Obs
                      </label>
                      <input
                        ref={referenceInputRef}
                        className="w-full p-2.5 rounded-xl border border-neutral-200 bg-neutral-25 font-bold text-sm outline-none focus:border-primary-500"
                        placeholder="..."
                        value={newItem.codigo_referencia}
                        onChange={(e) =>
                          setNewItem({
                            ...newItem,
                            codigo_referencia: e.target.value,
                          })
                        }
                      />
                    </div>
                    <div className="w-1/4">
                      <label className="text-[9px] font-bold text-neutral-400 uppercase">
                        Qtd
                      </label>
                      <input
                        ref={quantityInputRef}
                        type="number"
                        className="w-full p-2.5 rounded-xl border border-neutral-200 bg-neutral-25 font-bold text-center text-sm outline-none focus:border-primary-500"
                        placeholder="1"
                        value={newItem.quantidade}
                        onChange={(e) =>
                          setNewItem({ ...newItem, quantidade: e.target.value })
                        }
                      />
                    </div>
                    <div className="flex-1">
                      <label className="text-[9px] font-bold text-neutral-400 uppercase">
                        Valor (R$)
                      </label>
                      <input
                        type="number"
                        className="w-full p-2.5 rounded-xl border border-neutral-200 bg-neutral-25 font-bold text-right text-sm outline-none focus:border-primary-500"
                        placeholder="0.00"
                        value={newItem.valor_venda}
                        onChange={(e) =>
                          setNewItem({
                            ...newItem,
                            valor_venda: e.target.value,
                          })
                        }
                      />
                    </div>
                  </div>

                  <div className="flex items-center justify-between pt-1">
                    <div className="text-xs font-bold text-neutral-400 uppercase tracking-wider">
                      Total:{" "}
                      {formatCurrency(
                        Number(newItem.quantidade) *
                          Number(newItem.valor_venda || 0),
                      )}
                    </div>
                    <Button
                      type="submit"
                      variant="primary"
                      className="px-6 py-2 h-auto text-xs font-bold uppercase shadow-lg flex items-center gap-2"
                    >
                      <Plus size={16} /> Adicionar
                    </Button>
                  </div>
                </form>
              </div>

              {/* RIGHT: STOCK SEARCH */}
              <div className="p-4 rounded-2xl border border-blue-100 bg-blue-50/30 shadow-sm relative">
                <h4 className="text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                  <Search size={14} /> Buscar no Estoque
                </h4>
                <div className="relative group">
                  <Search
                    className="absolute left-3 top-1/2 -translate-y-1/2 text-blue-300 group-focus-within:text-blue-500 transition-colors"
                    size={18}
                  />
                  <input
                    className="w-full pl-10 pr-4 py-3 rounded-xl border border-blue-100 bg-neutral-25 outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-100 font-bold text-sm text-blue-600 transition-all shadow-sm placeholder:text-blue-200"
                    placeholder="Digite para buscar pe√ßas..."
                    value={partSearch}
                    onChange={(e) => {
                      handlePartSearch(e.target.value);
                      setHighlightIndex(-1);
                    }}
                    onKeyDown={(e) => {
                      if (partResults.length === 0) return;
                      if (e.key === "ArrowDown") {
                        e.preventDefault();
                        setHighlightIndex((prev) =>
                          Math.min(prev + 1, partResults.length - 1),
                        );
                      } else if (e.key === "ArrowUp") {
                        e.preventDefault();
                        setHighlightIndex((prev) => Math.max(prev - 1, -1)); // -1 means input focus
                      } else if (e.key === "Enter") {
                        if (
                          highlightIndex >= 0 &&
                          partResults[highlightIndex]
                        ) {
                          e.preventDefault();
                          selectPart(partResults[highlightIndex]);
                          setHighlightIndex(-1);
                        }
                      }
                    }}
                  />
                  {partResults.length > 0 && (
                    <div className="absolute z-50 w-full mt-2 bg-neutral-25 border border-blue-100 rounded-xl shadow-2xl max-h-60 overflow-y-auto overflow-x-hidden animate-in fade-in slide-in-from-top-2">
                      {partResults.map((p, idx) => (
                        <button
                          key={p.id_pecas_estoque || p.nome}
                          onClick={async () => {
                            // Custom Select Logic for Stock Items
                            try {
                              const res = await api.get(
                                `/pecas-estoque/${p.id_pecas_estoque}/availability`,
                              );
                              const partDetails = res.data;

                              setNewItem({
                                ...newItem,
                                id_pecas_estoque: String(
                                  partDetails.id_pecas_estoque,
                                ),
                                valor_venda: Number(
                                  partDetails.valor_venda,
                                ).toFixed(2),
                                descricao: partDetails.nome,
                                codigo_referencia: "",
                              });

                              const freeStock =
                                (partDetails.estoque_atual || 0) -
                                (partDetails.reserved || 0);
                              setSelectedStockInfo({
                                qtd: freeStock,
                                reserved: partDetails.reserved,
                              }); // Store stock info

                              if (freeStock < 2) {
                                setStatusMsg({
                                  type: "error",
                                  text: `‚ö†Ô∏è Estoque Baixo! Disp: ${freeStock} (Reservado: ${partDetails.reserved || 0})`,
                                });
                              } else if (partDetails.reserved > 0) {
                                setStatusMsg({
                                  type: "success",
                                  text: `Item selecionado. Disp: ${freeStock} (Reservado em outras OS: ${partDetails.reserved})`,
                                });
                              } else {
                                setStatusMsg({
                                  type: "success",
                                  text: `Item selecionado do estoque.`,
                                });
                                setTimeout(
                                  () => setStatusMsg({ type: null, text: "" }),
                                  1500,
                                );
                              }

                              setPartSearch("");
                              setPartResults([]);
                              requestAnimationFrame(() =>
                                referenceInputRef.current?.focus(),
                              );
                            } catch (e) {
                              console.error(e);
                            }
                          }}
                          className={`w-full text-left p-3 text-sm font-medium border-b border-neutral-50 flex justify-between group/item transition-colors ${idx === highlightIndex ? "bg-blue-50 ring-1 ring-inset ring-blue-100 z-10" : "hover:bg-neutral-50"}`}
                        >
                          <span className="text-neutral-700 group-hover/item:text-blue-600 flex-1">
                            {p.nome}
                          </span>
                          {p.estoque_atual !== undefined && (
                            <span className="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded mr-2">
                              Qt: {p.estoque_atual}
                            </span>
                          )}
                          <span className="font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-md">
                            {formatCurrency(Number(p.valor_venda))}
                          </span>
                        </button>
                      ))}
                    </div>
                  )}
                </div>
                <div className="mt-2 text-[9px] text-blue-400 font-medium">
                  Use as setas para navegar e Enter para selecionar.
                </div>
              </div>
            </div>
          )}
          {/* List Items */}
          <div className="border border-neutral-200 rounded-2xl overflow-hidden bg-neutral-25 shadow-sm">
            <table className="w-full text-left">
              <thead className="bg-neutral-50 border-b border-neutral-100">
                <tr>
                  <th className="p-3 pl-4 text-[10px] uppercase font-bold text-neutral-400 tracking-wider">
                    Item
                  </th>
                  <th className="p-3 text-[10px] uppercase font-bold text-neutral-400 tracking-wider">
                    Ref/C√≥digo
                  </th>
                  <th className="p-3 text-[10px] uppercase font-bold text-neutral-400 tracking-wider text-center">
                    Qtd
                  </th>
                  <th className="p-3 text-[10px] uppercase font-bold text-neutral-400 tracking-wider text-right">
                    Unit.
                  </th>
                  <th className="p-3 text-[10px] uppercase font-bold text-neutral-400 tracking-wider text-right">
                    Total
                  </th>
                  <th className="p-3 w-20"></th>
                </tr>
              </thead>
              <tbody className="divide-y divide-neutral-50 bg-primary-100">
                {osItems.map((item) => (
                  <tr
                    key={item.id_iten}
                    className="hover:bg-neutral-50/50 transition-colors group"
                  >
                    <td className="p-3 pl-4">
                      <div className="font-bold text-sm text-neutral-700">
                        {item.descricao}
                        {/* STATUS PAGO */}
                        {item.pagamentos_peca &&
                          item.pagamentos_peca.length > 0 &&
                          item.pagamentos_peca.some(
                            (pp: any) => pp.pago_ao_fornecedor,
                          ) && (
                            <span className="ml-2 px-1.5 py-0.5 rounded text-[9px] font-bold uppercase bg-green-100 text-green-700 tracking-wider border border-green-200">
                              PAGO
                            </span>
                          )}
                      </div>
                    </td>
                    <td className="p-3">
                      <div className="text-[10px] text-neutral-400 font-medium font-mono px-2 py-0.5 rounded-md w-fit">
                        {item.codigo_referencia || "-"}
                      </div>
                    </td>
                    <td className="p-3 text-center font-bold text-neutral-600 text-xs">
                      {item.quantidade}
                    </td>
                    <td className="p-3 text-right text-neutral-500 text-xs">
                      {formatCurrency(Number(item.valor_venda))}
                    </td>
                    <td className="p-3 text-right font-bold text-neutral-600 text-xs">
                      {formatCurrency(Number(item.valor_total))}
                    </td>
                    <td className="p-3 text-right pr-4">
                      {os.status !== "FINALIZADA" &&
                        os.status !== "PAGA_CLIENTE" && (
                          <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            {/* Lock actions if paid */}
                            {item.pagamentos_peca &&
                            item.pagamentos_peca.length > 0 &&
                            item.pagamentos_peca.some(
                              (pp: any) => pp.pago_ao_fornecedor,
                            ) ? (
                              <span className="text-[9px] font-bold text-neutral-400 uppercase flex items-center gap-1">
                                <DollarSign size={10} /> Pago
                              </span>
                            ) : (
                              <>
                                <ActionButton
                                  icon={Edit}
                                  label="Editar Item"
                                  onClick={() => handleEditItem(item)}
                                  variant="accent"
                                />
                                <ActionButton
                                  icon={Trash2}
                                  label="Excluir Item"
                                  onClick={() => handleDeleteItem(item.id_iten)}
                                  variant="danger"
                                />
                              </>
                            )}
                          </div>
                        )}
                    </td>
                  </tr>
                ))}
                {osItems.length === 0 && (
                  <tr>
                    <td
                      colSpan={6}
                      className="p-8 text-center text-neutral-300 text-xs italic"
                    >
                      Nenhum item adicionado √† lista.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* SAVE & CLOSE BUTTON (New) */}
        {["ABERTA", "EM_ANDAMENTO"].includes(os.status) && (
          <div className="flex justify-end">
            <Button
              variant="primary"
              onClick={handleSaveAndClose}
              className="bg-neutral-600 text-neutral-200 border border-neutral-700 hover:bg-neutral-600 shadow-lg px-8 py-4 text-sm font-bold uppercase tracking-wider flex items-center gap-2"
            >
              <Save size={18} /> Salvar e Fechar
            </Button>
          </div>
        )}

        {os.status !== "CANCELADA" && (
          <div className="mt-8 pt-8 border-t border-dashed border-red-200 flex justify-center opacity-50 hover:opacity-100 transition-opacity">
            <button
              onClick={() => {
                setConfirmModal({
                  isOpen: true,
                  title: "Cancelar Ordem de Servi√ßo",
                  message:
                    "Tem certeza que deseja CANCELAR esta OS? Todos os itens ser√£o devolvidos ao estoque automaticamente.",
                  onConfirm: async () => {
                    try {
                      await api.put(`/ordem-de-servico/${os.id_os}`, {
                        status: "CANCELADA",
                      });
                      setStatusMsg({
                        type: "success",
                        text: "OS Cancelada e Estoque Estornado.",
                      });
                      loadOsData();
                    } catch (e) {
                      setStatusMsg({
                        type: "error",
                        text: "Erro ao cancelar.",
                      });
                    }
                    setConfirmModal((prev) => ({ ...prev, isOpen: false }));
                  },
                });
              }}
              className="text-primary-500 font-bold text-xs uppercase hover:text-primary-700 flex items-center gap-2"
            >
              <Trash2 size={14} /> Apenas o Financeiro pode cancelar uma OS
            </button>
          </div>
        )}

        {/* Totals & Actions - Keep as is (below everything) */}
        <div className="relative overflow-hidden rounded-3xl bg-neutral-900 border border-neutral-600 shadow-2xl">
          {/* Background Glow Effect */}
          <div className="absolute top-0 right-0 -mt-20 -mr-20 w-96 h-96 bg-primary-600/20 rounded-full blur-3xl pointer-events-none"></div>

          <div className="relative p-8 text-neutral-25 space-y-8">
            {/* Totals Row */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-8 pb-8 border-b border-neutral-600">
              <div className="flex gap-12">
                <div>
                  <p className="text-[10px] font-bold text-neutral-500 uppercase tracking-widest mb-1">
                    Pe√ßas
                  </p>
                  <p className="font-medium text-lg text-neutral-300">
                    {formatCurrency(
                      osItems.reduce(
                        (acc, i) => acc + Number(i.valor_total),
                        0,
                      ),
                    )}
                  </p>
                </div>
                <div>
                  <p className="text-[10px] font-bold text-neutral-500 uppercase tracking-widest mb-1">
                    M√£o de Obra
                  </p>
                  <p className="font-medium text-lg text-neutral-300">
                    {formatCurrency(
                      Number(
                        laborServices.length > 0
                          ? laborServices.reduce(
                              (acc, l) => acc + Number(l.valor),
                              0,
                            )
                          : os.valor_mao_de_obra || 0,
                      ),
                    )}
                  </p>
                </div>
              </div>
              <div className="text-right">
                <p className="text-xs font-bold text-success-500 uppercase tracking-widest mb-1">
                  VALOR TOTAL
                </p>
                <p className="font-bold text-5xl tracking-tighter text-neutral-25 drop-shadow-lg">
                  {formatCurrency(
                    osItems.reduce((acc, i) => acc + Number(i.valor_total), 0) +
                      (laborServices.length > 0
                        ? laborServices.reduce(
                            (acc, l) => acc + Number(l.valor),
                            0,
                          )
                        : Number(os.valor_mao_de_obra || 0)),
                  )}
                </p>
              </div>
            </div>

            {/* Footer Actions Row */}
            <div className="flex flex-col lg:flex-row justify-between items-center gap-6">
              {/* Payment Card - HIGH VISIBILITY REDESIGN */}
              <div className="w-full lg:w-auto flex-1 max-w-2xl bg-yellow-600/60 rounded-2xl p-2 pr-4 flex items-center justify-between border border-neutral-700/50 hover:bg-yellow-600/80 transition-colors group">
                <div className="flex items-center gap-4">
                  <div className="bg-grenn-400/20 border border-neutral-600 p-3 rounded-xl shadow-lg">
                    <DollarSign
                      className="text-success-500"
                      size={24}
                      strokeWidth={2.5}
                    />
                  </div>
                  <div>
                    <div className="flex items-center gap-2 mb-1">
                      <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-wider">
                        Pagamentos Recebidos
                      </p>
                      {(() => {
                        const totalItemsVal = osItems.reduce(
                          (acc, i) => acc + Number(i.valor_total || 0),
                          0,
                        );
                        const totalLaborVal =
                          laborServices.length > 0
                            ? laborServices.reduce(
                                (acc, l) => acc + Number(l.valor || 0),
                                0,
                              )
                            : Number(os.valor_mao_de_obra || 0);
                        const totalOS = totalItemsVal + totalLaborVal;

                        const payments = os.pagamentos_cliente || [];
                        const totalPago = payments
                          .filter((p) => !p.deleted_at)
                          .reduce((acc, p) => acc + Number(p.valor), 0);

                        const isOk = totalOS - totalPago <= 0.05; // Margem de 5 centavos

                        return (
                          <span
                            className={`px-2 py-1 rounded text-[10px] font-black uppercase tracking-wider shadow-lg ${
                              isOk
                                ? "bg-emerald-500 text-white shadow-emerald-500/40"
                                : "bg-red-500 text-white shadow-red-500/40 animate-pulse"
                            }`}
                          >
                            {isOk ? "QUITADO" : "PENDENTE"}
                          </span>
                        );
                      })()}
                    </div>
                    <p className="font-bold text-2xl text-neutral-25 tracking-tight">
                      {formatCurrency(
                        (os.pagamentos_cliente || [])
                          .filter((p) => !p.deleted_at)
                          .reduce((acc, p) => acc + Number(p.valor), 0),
                      )}
                    </p>
                  </div>
                </div>
                <Button
                  variant="primary"
                  onClick={() => setShowPaymentModal(true)}
                  size="sm"
                  className="bg-neutral-700 text-neutral-200 border-none hover:bg-neutral-600 font-bold uppercase text-xs h-9 px-4 ml-4"
                >
                  Gerenciar
                </Button>
              </div>

              <div className="flex gap-4 w-full lg:w-auto justify-end">
                {["ABERTA", "EM_ANDAMENTO"].includes(os.status) ? (
                  <Button
                    onClick={handleFinishService}
                    variant="success"
                    className="w-full lg:w-auto px-8 py-5 h-auto text-lg font-bold uppercase tracking-widest shadow-xl shadow-success-500/20 hover:scale-105 transition-all flex-1 lg:flex-none justify-center"
                  >
                    <CheckCircle className="mr-3" size={24} strokeWidth={3} />{" "}
                    FINALIZAR OS
                  </Button>
                ) : (
                  <div className="flex flex-col sm:flex-row items-center gap-3 w-full">
                    {(os.status === "PRONTO PARA FINANCEIRO" ||
                      os.status === "FINALIZADA") && (
                      <Button
                        variant="secondary"
                        onClick={async () => {
                          try {
                            if (os.fechamento_financeiro) {
                              await api.delete(
                                `/fechamento-financeiro/${os.fechamento_financeiro.id_fechamento_financeiro}`,
                              );
                            }
                            await api.put(`/ordem-de-servico/${os.id_os}`, {
                              status: "ABERTA",
                            });
                            loadOsData();
                            setStatusMsg({
                              type: "success",
                              text: "OS Reaberta com sucesso!",
                            });
                          } catch (e) {
                            setStatusMsg({
                              type: "error",
                              text: "Erro ao reabrir OS.",
                            });
                          }
                        }}
                        className="bg-transparent border-2 border-dashed border-neutral-600 text-neutral-500 hover:text-neutral-25 hover:bg-neutral-600 hover:border-neutral-500 px-6 py-4 h-auto w-full sm:w-auto font-bold uppercase transition-all"
                      >
                        REABRIR OS
                      </Button>
                    )}
                    <div className="flex items-center justify-center gap-3 text-success-400 font-bold bg-success-500/10 px-8 py-4 rounded-xl border border-success-500/20 w-full sm:w-auto">
                      <BadgeCheck size={28} />
                      <div className="flex flex-col text-left">
                        <span className="text-[10px] text-success-600/70 uppercase leading-none">
                          Status Atual
                        </span>
                        <span className="text-lg leading-none mt-1">
                          {os.status}
                        </span>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* SHARED MODALS */}
      {confirmModal.isOpen && (
        <Modal
          title={confirmModal.title}
          onClose={() =>
            setConfirmModal((prev) => ({ ...prev, isOpen: false }))
          }
        >
          <p className="mb-6">{confirmModal.message}</p>
          <div className="flex justify-end gap-2">
            <Button
              variant="secondary"
              onClick={() =>
                setConfirmModal((prev) => ({ ...prev, isOpen: false }))
              }
            >
              Cancelar
            </Button>
            <Button variant="primary" onClick={confirmModal.onConfirm}>
              Confirmar
            </Button>
          </div>
        </Modal>
      )}

      {editItemModalOpen && editingItemData && (
        <Modal title="Editar Item" onClose={() => setEditItemModalOpen(false)}>
          <div className="space-y-4">
            <div>
              <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">
                Descri√ß√£o do Item
              </label>
              <input
                className="w-full border p-2 rounded text-sm font-medium"
                value={editingItemData.descricao}
                onChange={(e) =>
                  setEditingItemData({
                    ...editingItemData,
                    descricao: e.target.value,
                  })
                }
              />
            </div>
            <div>
              <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">
                Mais Informa√ß√µes (C√≥digo/Nota/Refer√™ncia)
              </label>
              <input
                className="w-full border p-2 rounded text-sm font-medium"
                placeholder="Ex: N√∫mero da pe√ßa, c√≥digo de refer√™ncia..."
                value={editingItemData.codigo_referencia || ""}
                onChange={(e) =>
                  setEditingItemData({
                    ...editingItemData,
                    codigo_referencia: e.target.value,
                  })
                }
              />
            </div>
            <div className="flex gap-2">
              <div className="flex-1">
                <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">
                  Quantidade
                </label>
                <input
                  type="number"
                  className="w-full border p-2 rounded text-sm font-bold text-center"
                  value={editingItemData.quantidade}
                  onChange={(e) =>
                    setEditingItemData({
                      ...editingItemData,
                      quantidade: e.target.value,
                    })
                  }
                />
              </div>
              <div className="flex-1">
                <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">
                  Valor Unit. (R$)
                </label>
                <input
                  type="number"
                  className="w-full border p-2 rounded text-sm font-bold text-right"
                  value={editingItemData.valor_venda}
                  onChange={(e) =>
                    setEditingItemData({
                      ...editingItemData,
                      valor_venda: e.target.value,
                    })
                  }
                />
              </div>
            </div>
            <div className="p-3 bg-neutral-50 rounded-lg">
              <p className="text-[10px] font-bold text-neutral-400 uppercase mb-1">
                Valor Total
              </p>
              <p className="text-xl font-bold text-primary-600">
                {formatCurrency(
                  Number(editingItemData.quantidade || 0) *
                    Number(editingItemData.valor_venda || 0),
                )}
              </p>
            </div>
            <Button onClick={handleSaveItemEdit} className="w-full mt-2">
              Salvar Altera√ß√µes
            </Button>
          </div>
        </Modal>
      )}
      {showPaymentModal && os && (
        <Modal title="Pagamentos" onClose={() => setShowPaymentModal(false)}>
          {/* Lista de pagamentos existentes */}
          {os.pagamentos_cliente && os.pagamentos_cliente.length > 0 && (
            <div className="mb-6">
              <h4 className="text-xs font-bold text-neutral-500 uppercase mb-2">
                Pagamentos Registrados
              </h4>
              <div className="border rounded-xl overflow-hidden">
                <table className="w-full text-xs">
                  <thead className="bg-neutral-50">
                    <tr>
                      <th className="p-2 text-left">Data</th>
                      <th className="p-2 text-left">M√©todo</th>
                      <th className="p-2 text-left">
                        Detalhes (Banco / Operadora)
                      </th>
                      <th className="p-2 text-right">Valor</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {os.pagamentos_cliente
                      .sort(
                        (a, b) =>
                          new Date(b.data_pagamento).getTime() -
                          new Date(a.data_pagamento).getTime(),
                      )
                      .map((pag) => {
                        const isDeleted = !!pag.deleted_at;
                        return (
                          <tr
                            key={pag.id_pagamento_cliente}
                            className={isDeleted ? "bg-red-50 opacity-60" : ""}
                          >
                            <td
                              className={`p-2 ${isDeleted ? "line-through" : ""}`}
                            >
                              {new Date(
                                pag.data_pagamento,
                              ).toLocaleDateString()}
                            </td>
                            <td
                              className={`p-2 font-bold ${isDeleted ? "line-through" : ""}`}
                            >
                              {pag.metodo_pagamento}
                            </td>
                            <td
                              className={`p-2 ${isDeleted ? "line-through" : ""}`}
                            >
                              {pag.metodo_pagamento === "PIX" ? (
                                pag.conta_bancaria ? (
                                  <span className="text-[10px] bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded font-bold uppercase">
                                    {pag.conta_bancaria.nome}
                                  </span>
                                ) : (
                                  <span className="text-neutral-400">-</span>
                                )
                              ) : pag.metodo_pagamento === "CREDITO" ||
                                pag.metodo_pagamento === "DEBITO" ? (
                                <div className="flex flex-col">
                                  <span className="font-bold">
                                    {pag.operadora?.nome || "Operadora N/I"}
                                  </span>
                                  <span className="text-[10px] text-neutral-500">
                                    {pag.bandeira_cartao}{" "}
                                    {pag.qtd_parcelas > 1
                                      ? `(${pag.qtd_parcelas}x)`
                                      : ""}
                                  </span>
                                </div>
                              ) : pag.metodo_pagamento === "DINHEIRO" &&
                                pag.conta_bancaria ? (
                                <span className="text-[10px] bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded font-bold uppercase">
                                  {pag.conta_bancaria.nome}
                                </span>
                              ) : (
                                <span className="text-neutral-400">-</span>
                              )}
                              {pag.codigo_transacao && (
                                <div className="text-[9px] text-neutral-400 font-mono mt-0.5">
                                  ID: {pag.codigo_transacao}
                                </div>
                              )}
                            </td>
                            <td
                              className={`p-2 text-right font-bold ${isDeleted ? "line-through text-red-600" : "text-green-600"}`}
                            >
                              {formatCurrency(Number(pag.valor))}
                            </td>
                          </tr>
                        );
                      })}
                  </tbody>
                  <tfoot className="bg-green-50">
                    <tr>
                      <td colSpan={3} className="p-2 font-bold text-green-700">
                        TOTAL PAGO
                      </td>
                      <td className="p-2 text-right font-bold text-green-700">
                        {formatCurrency(
                          os.pagamentos_cliente
                            .filter((p) => !p.deleted_at)
                            .reduce((acc, p) => acc + Number(p.valor), 0),
                        )}
                      </td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          )}

          <PagamentoClienteForm
            osId={os.id_os}
            valorTotal={
              osItems.reduce((acc, i) => acc + Number(i.valor_total), 0) +
              laborServices.reduce((acc, l) => acc + Number(l.valor), 0) -
              (os.pagamentos_cliente || [])
                .filter((p) => !p.deleted_at)
                .reduce((acc, p) => acc + Number(p.valor), 0)
            }
            onSuccess={() => {
              setShowPaymentModal(false);
              loadOsData();
            }}
            onCancel={() => setShowPaymentModal(false)}
          />
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\OrdemDeServicoPage.tsx
================================================================================
import { useState, useEffect, useCallback, useRef } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { api } from "../services/api";
import type { IOrdemDeServico } from "../types/backend";
import { Search, Plus, Phone, CheckCircle, Wrench } from "lucide-react";

import { ActionButton } from "../components/ui/ActionButton";
import { Button } from "../components/ui/Button";
import { Input } from "../components/ui/input";
import { StatusBanner } from "../components/ui/StatusBanner";
import { Modal } from "../components/ui/Modal";

export const OrdemDeServicoPage = () => {
  const navigate = useNavigate();

  // --- STATE ---
  const [searchTerm, setSearchTerm] = useState(""); // NEW: Localizar Search
  const [dateFilter, setDateFilter] = useState<
    "ALL" | "HOJE" | "SEMANA" | "MES"
  >("SEMANA");

  const [oss, setOss] = useState<IOrdemDeServico[]>([]);

  // Status Feedback
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  const location = useLocation();

  // --- DATA LOADING ---
  const loadOss = useCallback(async () => {
    try {
      const response = await api.get("/ordem-de-servico");
      setOss(response.data);
    } catch (error) {
      setStatusMsg({
        type: "error",
        text: "Erro ao carregar Ordens de Servi√ßo.",
      });
    }
  }, []);

  // Wizard State for New OS
  const [newOsWizardStep, setNewOsWizardStep] = useState<"NONE" | "OS">("NONE");
  const [wizardClient, setWizardClient] = useState<any>(null);
  const [wizardVehicle, setWizardVehicle] = useState<any>(null);

  const searchInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if (searchInputRef.current) {
      searchInputRef.current.focus();
    }
  }, []);

  useEffect(() => {
    loadOss();

    const params = new URLSearchParams(location.search);
    const osId = params.get("id");
    const paramClientId = params.get("clientId");
    const paramVehicleId = params.get("vehicleId");

    if (osId) {
      handleOpenFromId(Number(osId));
    } else if (paramClientId && paramVehicleId) {
      const loadForDirectOpen = async () => {
        try {
          const [cRes, vRes] = await Promise.all([
            api.get(`/cliente/${paramClientId}`),
            api.get(`/veiculo/${paramVehicleId}`),
          ]);
          setWizardClient(cRes.data);
          setWizardVehicle(vRes.data);
          setNewOsWizardStep("OS");
        } catch (e) {
          console.error("Error loading for direct open", e);
        }
      };
      loadForDirectOpen();
    }
  }, [loadOss, location.search]);

  const handleOpenNewOsForExisting = (vehicle: any, client: any) => {
    if (!vehicle || !client) return;
    setWizardClient(client);
    setWizardVehicle(vehicle);
    setNewOsWizardStep("OS");
  };

  const handleCreateOsFinal = async (
    mechanicId: number | null = null,
    km: number = 0,
    defect: string = "",
    overrideVehicle: any = null,
    overrideClient: any = null,
  ) => {
    const client = overrideClient || wizardClient;
    const vehicle = overrideVehicle || wizardVehicle;

    if (!client || !vehicle) return;

    try {
      const payload = {
        id_cliente: client.id_cliente,
        id_veiculo: vehicle.id_veiculo,
        id_funcionario: mechanicId || null,
        km_entrada: km,
        defeito_relatado: defect,
        status: "ABERTA",
        valor_total_cliente: 0,
        valor_mao_de_obra: 0,
        parcelas: 1,
      };
      const res = await api.post("/ordem-de-servico", payload);
      setNewOsWizardStep("NONE");
      setWizardClient(null);
      setWizardVehicle(null);
      handleNewOsSuccess(res.data.id_os);
      setStatusMsg({ type: "success", text: "OS Criada com Sucesso!" });
    } catch (e) {
      setStatusMsg({ type: "error", text: "Erro ao criar OS." });
    }
  };

  // --- HANDLERS ---

  const handleOpenFromId = (id: number) => {
    navigate(`/ordem-de-servico/${id}`);
  };

  const handleNewOsSuccess = async (newOsId: number) => {
    handleOpenFromId(newOsId);
  };

  const handleManageItem = (os: IOrdemDeServico) => {
    handleOpenFromId(os.id_os);
  };

  // FILTER LOGIC
  const filteredOss = (Array.isArray(oss) ? oss : []).filter((os) => {
    // 1. Date Filter
    if (dateFilter !== "ALL") {
      const now = new Date();
      const startOfToday = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
      );
      const osDate = new Date(os.dt_abertura);

      if (dateFilter === "HOJE") {
        if (osDate < startOfToday) return false;
      } else if (dateFilter === "SEMANA") {
        const weekAgo = new Date(startOfToday);
        weekAgo.setDate(startOfToday.getDate() - 7);
        if (osDate < weekAgo) return false;
      } else if (dateFilter === "MES") {
        const firstDayMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        if (osDate < firstDayMonth) return false;
      }
    }

    if (!searchTerm) {
      // User requested to show ALL OSs (subject to Date Filter)
      // Previously restricted to 'ABERTA'. Now we show everything matching the date filter.
      return true;
    }

    const q = searchTerm.toLowerCase();
    const plate = os.veiculo?.placa?.toLowerCase() || "";
    const model = os.veiculo?.modelo?.toLowerCase() || "";
    const brand = os.veiculo?.marca?.toLowerCase() || "";
    const color = os.veiculo?.cor?.toLowerCase() || "";
    const owner = (
      os.cliente?.pessoa_fisica?.pessoa?.nome ||
      os.cliente?.pessoa_juridica?.razao_social ||
      ""
    ).toLowerCase();
    const id = String(os.id_os);
    const fullIdHash = `#${os.id_os}`;

    return [plate, model, brand, color, owner, id, fullIdHash]
      .join(" ")
      .includes(q);
  });

  // --- RENDER ---
  const getStatusStyle = (status: string) => {
    switch (status) {
      case "FINALIZADA":
        return "bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200";
      case "PAGA_CLIENTE":
        return "bg-neutral-100 text-neutral-600 ring-1 ring-neutral-200";
      case "PRONTO PARA FINANCEIRO":
        return "bg-amber-100 text-amber-700 ring-1 ring-amber-200";
      case "ABERTA":
        return "bg-blue-100 text-blue-700 ring-1 ring-blue-200";
      case "EM_ANDAMENTO":
        return "bg-cyan-100 text-cyan-700 ring-1 ring-cyan-200";
      default:
        return "bg-gray-50 text-gray-500 ring-1 ring-gray-200";
    }
  };

  return (
    <div className="w-full max-w-[1440px] mx-auto px-4 md:px-8 py-6 space-y-6 animate-in fade-in duration-500">
      {statusMsg.text && (
        <div className="fixed bottom-8 right-8 z-60">
          <StatusBanner
            msg={statusMsg}
            onClose={() => setStatusMsg({ type: null, text: "" })}
          />
        </div>
      )}

      {/* HEADER */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl font-bold text-neutral-500">
            Ordens de Servi√ßo
          </h1>
          <p className="text-neutral-500">
            Gest√£o centralizada de atendimentos.
          </p>
        </div>
        <Button
          variant="primary"
          icon={Plus}
          onClick={() => navigate("/novo-cadastro")}
        >
          Novo Cadastro
        </Button>
      </div>

      {/* MAIN INTERFACE: SEARCH & LIST */}
      <div className="bg-surface p-4 rounded-xl shadow-sm border border-neutral-200 flex flex-col md:flex-row items-center justify-between gap-4">
        <div className="flex-1 w-full relative">
          <Input
            ref={searchInputRef}
            variant="default"
            icon={Search}
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            placeholder="Buscar por Placa, Cliente ou Modelo..."
          />
        </div>

        {/* Date Filters */}
        <div className="flex bg-neutral-100 p-1 rounded-xl shrink-0">
          {["ALL", "HOJE", "SEMANA", "MES"].map((f) => (
            <button
              key={f}
              onClick={() => setDateFilter(f as any)}
              className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${dateFilter === f ? "bg-primary-200 text-primary-500 shadow-sm" : "text-neutral-500 hover:text-neutral-700"}`}
            >
              {f === "ALL" ? "Todos" : f === "MES" ? "M√™s" : f}
            </button>
          ))}
        </div>
      </div>

      {/* SEARCH RESULTS */}
      <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-neutral-50 border-b border-neutral-200 text-xs uppercase tracking-wider text-neutral-500 font-semibold">
                <th className="p-4">OS / Data</th>
                <th className="p-4">Ve√≠culo</th>
                <th className="p-4">Diagn√≥stico / A√ß√µes</th>
                <th className="p-4">T√©cnico</th>
                <th className="p-4">Cliente</th>
                <th className="p-4 text-center">Status</th>
                <th className="p-4 text-right">A√ß√µes</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-neutral-100">
              {filteredOss
                .sort((a, b) => b.id_os - a.id_os)
                .map((os) => (
                  <tr
                    key={os.id_os}
                    className="hover:bg-neutral-25 transition-colors"
                  >
                    <td className="p-4">
                      <div className="font-bold text-neutral-600">
                        #{os.id_os}
                      </div>
                      <div className="text-[13px] text-neutral-600 font-medium">
                        {new Date(os.dt_abertura).toLocaleDateString()}
                      </div>
                    </td>
                    <td className="p-4">
                      <div className="font-bold text-neutral-700 tracking-tight text-sm uppercase">
                        {os.veiculo?.marca} {os.veiculo?.modelo} -{" "}
                        {os.veiculo?.cor}
                      </div>
                      <div className="text-[14px] text-primary-500 font-bold uppercase">
                        {os.veiculo?.placa || "Placa N/I"}
                      </div>
                    </td>
                    <td
                      className="p-4 max-w-[200px]"
                      title={
                        os.diagnostico ||
                        os.defeito_relatado ||
                        "Sem diagn√≥stico registrado"
                      }
                    >
                      <p className="text-xs font-medium text-neutral-600 line-clamp-2">
                        {os.diagnostico || os.defeito_relatado || (
                          <span className="text-neutral-300 italic">
                            Pendente
                          </span>
                        )}
                      </p>
                    </td>
                    <td className="p-4">
                      <p
                        className="text-xs font-bold text-neutral-700 uppercase truncate max-w-[120px]"
                        title="Respons√°vel T√©cnico"
                      >
                        {(() => {
                          // @ts-ignore
                          const mechanics = os.servicos_mao_de_obra
                            ?.map(
                              (s) =>
                                s.funcionario?.pessoa_fisica?.pessoa?.nome?.split(
                                  " ",
                                )[0],
                            )
                            .filter(Boolean);
                          const uniqueMechanics = [...new Set(mechanics || [])];

                          if (uniqueMechanics.length > 0) {
                            return uniqueMechanics.join(", ");
                          }
                          // Fallback to OS Creator/Owner
                          return (
                            os.funcionario?.pessoa_fisica?.pessoa?.nome?.split(
                              " ",
                            )[0] || (
                              <span className="text-neutral-300">---</span>
                            )
                          );
                        })()}
                      </p>
                    </td>
                    <td className="p-4">
                      <div className="font-bold text-neutral-700 text-sm truncate max-w-[150px]">
                        {os.cliente?.pessoa_fisica?.pessoa?.nome ||
                          os.cliente?.pessoa_juridica?.razao_social ||
                          "Desconhecido"}
                      </div>
                      <div className="text-[10px] text-neutral-400 font-medium">
                        {os.cliente?.telefone_1}
                      </div>
                    </td>
                    <td className="p-4 text-center">
                      <span
                        className={`px-3 py-1 rounded-md text-[10px] font-bold uppercase whitespace-nowrap ${getStatusStyle(os.status)}`}
                      >
                        {os.status === "PRONTO PARA FINANCEIRO"
                          ? "FINANCEIRO"
                          : os.status.replace(/_/g, " ")}
                      </span>
                    </td>
                    <td className="p-4 text-right">
                      <div className="flex justify-end gap-1">
                        <ActionButton
                          onClick={() => handleManageItem(os)}
                          label="Gerenciar"
                          variant="neutral"
                          icon={Wrench}
                        />

                        {(os.status === "FINALIZADA" ||
                          os.status === "PRONTO PARA FINANCEIRO" ||
                          os.status === "PAGA_CLIENTE") && (
                          <ActionButton
                            onClick={() =>
                              handleOpenNewOsForExisting(os.veiculo, os.cliente)
                            }
                            icon={Plus}
                            label="Nova OS"
                            variant="primary"
                          />
                        )}
                      </div>
                    </td>
                  </tr>
                ))}
              {/* Empty/No Results: Show 'INICIAR NOVA OS' Button */}
              {filteredOss.length === 0 && (
                <tr>
                  <td colSpan={7} className="p-12 text-center text-neutral-500">
                    <div className="flex flex-col items-center gap-4">
                      <p className="font-bold text-neutral-400 mb-2">
                        Nenhum registro encontrado.
                      </p>
                      <p className="text-sm text-neutral-400 mb-4">
                        Deseja iniciar um novo atendimento?
                      </p>
                      <Button
                        onClick={() => navigate("/novo-cadastro")}
                        variant="primary"
                        icon={Plus}
                      >
                        NOVO CADASTRO
                      </Button>
                    </div>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* --- MODALS (SHARED) --- */}
      {/* WIZARD MODALS */}

      {/* WIZARD MODALS */}
      {/* Step 1 & 2 replaced by CadastroUnificadoPage. Only Step 3 (OS Confirmation) remains. */}

      {newOsWizardStep === "OS" && wizardClient && wizardVehicle && (
        <Modal
          title={
            <span className="text-neutral-600">
              Passo 3: Confirmar Abertura
            </span>
          }
          onClose={() => setNewOsWizardStep("NONE")}
          className="max-w-xl"
        >
          <div className="space-y-6">
            <div className="bg-primary-50 p-6 rounded-xl border border-primary-100 space-y-4">
              <div className="flex justify-between items-start border-b border-primary-100 pb-4">
                <div>
                  <p className="text-[10px] font-bold text-primary-400 uppercase mb-1">
                    Cliente
                  </p>
                  <p className="font-bold text-primary-900 text-lg leading-tight">
                    {wizardClient.pessoa_fisica?.pessoa?.nome ||
                      wizardClient.pessoa_juridica?.razao_social}
                  </p>
                  <p className="text-sm text-primary-600 font-bold mt-1 flex items-center gap-1">
                    <Phone size={14} className="text-primary-400" />{" "}
                    {wizardClient.telefone_1 ||
                      wizardClient.telefone_2 ||
                      "Sem telefone"}
                  </p>
                </div>
              </div>

              <div className="flex items-center gap-4">
                <div className="flex-1">
                  <p className="text-[10px] font-bold text-primary-400 uppercase mb-1">
                    Ve√≠culo
                  </p>
                  <div className="flex items-center gap-3">
                    {/* Gray Circle Removed */}
                    <div>
                      <p className="font-bold text-primary-900 text-xl tracking-tight">
                        {wizardVehicle.placa}
                      </p>
                      <p className="text-xs text-primary-600 font-bold uppercase">
                        {wizardVehicle.modelo} ‚Ä¢ {wizardVehicle.cor}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div className="bg-neutral-50 p-4 rounded-xl border border-neutral-100 text-center">
              <p className="text-neutral-500 text-sm font-medium">
                Confirme os dados acima para iniciar a Ordem de Servi√ßo.
              </p>
            </div>

            <form
              onSubmit={(e) => {
                e.preventDefault();
                handleCreateOsFinal(null, 0, ""); // No mechanic, No KM, No Defect for now
              }}
            >
              <div className="pt-2 flex gap-3">
                <Button
                  type="button"
                  onClick={() => setNewOsWizardStep("NONE")}
                  variant="ghost"
                  className="flex-1"
                  size="lg"
                >
                  CANCELAR
                </Button>
                <Button
                  type="submit"
                  variant="primary"
                  className="flex-[2]"
                  size="lg"
                  icon={CheckCircle}
                >
                  ABRIR ORDEM DE SERVI√áO
                </Button>
              </div>
            </form>
          </div>
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\PagamentoEquipePage.tsx
================================================================================
import { useState, useEffect, useMemo } from "react";
import { formatCurrency } from "../utils/formatCurrency";
import { api } from "../services/api";
import { StatusBanner } from "../components/ui/StatusBanner";
import { Button } from "../components/ui/Button";
import { Input } from "../components/ui/input";
import { DollarSign, User, Search, AlertCircle } from "lucide-react";
import { useNavigate } from "react-router-dom";

export const PagamentoEquipePage = () => {
  const navigate = useNavigate();
  // --- STATE ---
  const [selectedFuncId, setSelectedFuncId] = useState("");
  const [activeTab, setActiveTab] = useState<"PENDENTE" | "PAGO">("PENDENTE");

  // Data States
  const [funcionarios, setFuncionarios] = useState<any[]>([]);
  const [pendentes, setPendentes] = useState<any[]>([]);
  const [valesPendentes, setValesPendentes] = useState<any[]>([]);
  const [historico, setHistorico] = useState<any[]>([]);

  // UI
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  // Filters (History Tab)
  // Default to "WEEK" logic if desired, or keep generic dates. User asked for "hj, semana e mes" filters.
  const [activeFilter, setActiveFilter] = useState<
    "TODAY" | "WEEK" | "MONTH" | "CUSTOM"
  >("WEEK");
  const [filterHistStart, setFilterHistStart] = useState("");
  const [filterHistEnd, setFilterHistEnd] = useState("");
  const [historySearchTerm, setHistorySearchTerm] = useState("");

  // --- EFFECTS ---
  useEffect(() => {
    loadFuncionarios();
    // Initialize Week Filter
    applyQuickFilter("WEEK");
  }, []);

  useEffect(() => {
    if (!selectedFuncId) {
      setPendentes([]);
      setValesPendentes([]);
      setHistorico([]);
      return;
    }

    if (activeTab === "PENDENTE") {
      loadPendentes(selectedFuncId);
      loadVales(selectedFuncId);
    } else {
      loadHistorico(selectedFuncId);
    }
  }, [selectedFuncId, activeTab]);

  // --- LOADERS ---
  const loadFuncionarios = async () => {
    try {
      const res = await api.get("/funcionario");
      setFuncionarios(res.data);
    } catch (e) {
      console.error(e);
    }
  };

  const loadPendentes = async (id: string) => {
    try {
      const res = await api.get(`/pagamento-equipe/pendentes/${id}`);
      setPendentes(res.data);
    } catch (e) {
      console.error(e);
    }
  };

  const loadVales = async (id: string) => {
    try {
      const res = await api.get(`/pagamento-equipe/vales/${id}`);
      setValesPendentes(res.data);
    } catch (e) {
      console.error(e);
    }
  };

  const loadHistorico = async (id: string) => {
    try {
      const res = await api.get("/pagamento-equipe");
      const filtered = res.data.filter(
        (h: any) => String(h.id_funcionario) === String(id),
      );
      setHistorico(filtered);
    } catch (e) {
      console.error(e);
    }
  };

  // --- HELPERS ---
  const getComissaoInfo = (funcId: any, valorTotal: number) => {
    const func = funcionarios.find(
      (f) => String(f.id_funcionario) === String(funcId),
    );
    const porcentagem = func?.comissao || 0;
    const valorComissao = (valorTotal * porcentagem) / 100;
    return { porcentagem, valorComissao };
  };

  const applyQuickFilter = (type: "TODAY" | "WEEK" | "MONTH") => {
    setActiveFilter(type);
    const now = new Date();
    const todayStr = now.toLocaleDateString("en-CA");

    if (type === "TODAY") {
      setFilterHistStart(todayStr);
      setFilterHistEnd(todayStr);
    } else if (type === "WEEK") {
      const weekAgo = new Date(now);
      weekAgo.setDate(now.getDate() - 7);
      setFilterHistStart(weekAgo.toLocaleDateString("en-CA"));
      setFilterHistEnd(todayStr);
    } else if (type === "MONTH") {
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      setFilterHistStart(firstDay.toLocaleDateString("en-CA"));
      setFilterHistEnd(todayStr);
    }
  };

  // --- FILTERS & FLATTENING ---
  const flattenedHistorico = useMemo(() => {
    const flatList: any[] = [];

    historico.forEach((h) => {
      const dtPagamento = h.dt_pagamento ? h.dt_pagamento.split("T")[0] : "";

      // Check Date Range Filter
      if (filterHistStart && dtPagamento < filterHistStart) return;
      if (filterHistEnd && dtPagamento > filterHistEnd) return;

      // 1. Add Commission Items (OSs)
      if (h.servicos_pagos && h.servicos_pagos.length > 0) {
        h.servicos_pagos.forEach((s: any) => {
          flatList.push({
            type: "COMISSAO",
            id: s.id_servico_mao_de_obra,
            date: h.dt_pagamento,
            os: s.ordem_de_servico,
            value: s.valor, // Base labor value
            commissionValue: getComissaoInfo(selectedFuncId, Number(s.valor))
              .valorComissao,
            percentage: getComissaoInfo(selectedFuncId, Number(s.valor))
              .porcentagem,
            paymentId: h.id_pagamento_equipe,
            paymentMethod: h.forma_pagamento,
          });
        });
      }

      // 2. Add Bonus (Pr√™mio) if exists
      if (Number(h.premio_valor) > 0) {
        flatList.push({
          type: "PREMIO",
          id: `premio-${h.id_pagamento_equipe}`,
          date: h.dt_pagamento,
          description: h.premio_descricao || "Pr√™mio / B√¥nus",
          value: Number(h.premio_valor),
          paymentId: h.id_pagamento_equipe,
          paymentMethod: h.forma_pagamento,
        });
      }

      // 3. Add Vales (Adiantamentos) paid
      if (h.tipo_lancamento === "VALE") {
        flatList.push({
          type: "VALE",
          id: `vale-${h.id_pagamento_equipe}`,
          date: h.dt_pagamento,
          description: `Adiantamento (Vale)${h.obs ? " - " + h.obs : ""}`,
          value: Number(h.valor_total),
          paymentId: h.id_pagamento_equipe,
          paymentMethod: h.forma_pagamento,
        });
      }

      // 4. Add Salary/Other Check (Residual Value)
      // If the payment total is greater than the sum of commissions + bonuses, the remainder is Sal√°rio/Contrato
      const commissionTotal = h.servicos_pagos
        ? h.servicos_pagos.reduce(
            (acc: number, s: any) => acc + Number(s.valor),
            0,
          )
        : 0;
      const premioVal = Number(h.premio_valor) || 0;

      // If it is NOT a Vale record, we check for residuals
      if (h.tipo_lancamento !== "VALE") {
        const totalExplained = commissionTotal + premioVal;
        const residual = Number(h.valor_total) - totalExplained;

        if (residual > 0.05) {
          // Tolerance for float math
          flatList.push({
            type: "SALARIO",
            id: `salario-${h.id_pagamento_equipe}`,
            date: h.dt_pagamento,
            description: h.obs || "Pagamento / Sal√°rio",
            value: residual,
            paymentId: h.id_pagamento_equipe,
            paymentMethod: h.forma_pagamento,
          });
        }
      }
    });

    // Search Filter
    if (!historySearchTerm) return flatList;

    const lowSearch = historySearchTerm.toLowerCase();

    return flatList.filter((item) => {
      // Common fields
      if (item.date && item.date.includes(lowSearch)) return true;
      if (String(item.value).includes(lowSearch)) return true;
      if (
        item.paymentMethod &&
        item.paymentMethod.toLowerCase().includes(lowSearch)
      )
        return true;

      // OS Specific
      if (item.type === "COMISSAO" && item.os) {
        if (String(item.os.id_os).includes(lowSearch)) return true;
        if (item.os.veiculo?.placa?.toLowerCase().includes(lowSearch))
          return true;
        if (item.os.veiculo?.modelo?.toLowerCase().includes(lowSearch))
          return true;
        if (item.os.veiculo?.cor?.toLowerCase().includes(lowSearch))
          return true;
        if (
          item.os.cliente?.pessoa_fisica?.pessoa?.nome
            ?.toLowerCase()
            .includes(lowSearch)
        )
          return true;
        if (
          item.os.cliente?.pessoa_juridica?.razao_social
            ?.toLowerCase()
            .includes(lowSearch)
        )
          return true;
      }

      // Description Specific (Vale/Premio)
      if (
        item.description &&
        item.description.toLowerCase().includes(lowSearch)
      )
        return true;

      return false;
    });
  }, [
    historico,
    filterHistStart,
    filterHistEnd,
    historySearchTerm,
    selectedFuncId,
    funcionarios,
  ]);

  // Recalculate total based on filtered view
  const totalHistorico = useMemo(() => {
    return flattenedHistorico.reduce((acc, item) => {
      if (item.type === "COMISSAO") return acc + (item.commissionValue || 0);
      return acc + (item.value || 0);
    }, 0);
  }, [flattenedHistorico]);

  const getStatusStyle = (status: string) => {
    switch (status) {
      case "FINALIZADA":
        return "bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200";
      case "PAGA_CLIENTE":
        return "bg-neutral-100 text-neutral-600 ring-1 ring-neutral-200";
      case "PRONTO_PARA_FINANCEIRO":
      case "PRONTO PARA FINANCEIRO":
        return "bg-amber-100 text-amber-700 ring-1 ring-amber-200";
      case "ABERTA":
        return "bg-blue-100 text-blue-700 ring-1 ring-blue-200";
      case "EM_ANDAMENTO":
        return "bg-cyan-100 text-cyan-700 ring-1 ring-cyan-200";
      case "CANCELADA":
        return "bg-red-100 text-red-700 ring-1 ring-red-200";
      default:
        return "bg-gray-50 text-gray-500 ring-1 ring-gray-200";
    }
  };

  return (
    <div className="space-y-6 animate-in fade-in duration-500">
      <StatusBanner
        msg={statusMsg}
        onClose={() => setStatusMsg({ type: null, text: "" })}
      />

      {/* HEADER */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl font-bold text-neutral-600 tracking-tight">
            Pagamento da Equipe
          </h1>
          <p className="text-neutral-500">
            Gest√£o individual de comiss√µes e pagamentos.
          </p>
        </div>
      </div>

      {/* SELE√á√ÉO COLABORADOR */}
      <div className="bg-surface p-6 rounded-xl shadow-sm border border-neutral-200">
        <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-2">
          Selecione o Colaborador
        </label>
        <div className="relative max-w-md">
          <select
            value={selectedFuncId}
            onChange={(e) => setSelectedFuncId(e.target.value)}
            className="w-full pl-4 pr-10 py-3 bg-white border border-neutral-200 rounded-lg font-bold text-sm outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-500/10 transition-colors text-neutral-600"
          >
            <option value="">Selecione um colaborador...</option>
            {funcionarios.map((f: any) => (
              <option key={f.id_funcionario} value={f.id_funcionario}>
                {f.pessoa_fisica?.pessoa?.nome}
              </option>
            ))}
          </select>
        </div>
      </div>

      {selectedFuncId ? (
        <div className="animate-in slide-in-from-bottom-4 duration-500 space-y-6">
          {/* ACTION & TABS */}
          <div className="flex flex-col sm:flex-row justify-between items-end gap-4">
            <div className="flex bg-neutral-100 p-1 rounded-xl w-fit">
              <button
                onClick={() => setActiveTab("PENDENTE")}
                className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                  activeTab === "PENDENTE"
                    ? "bg-primary-200 text-primary-500 shadow-sm"
                    : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
                }`}
              >
                Vis√£o Geral / Pend√™ncias
              </button>
              <button
                onClick={() => setActiveTab("PAGO")}
                className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                  activeTab === "PAGO"
                    ? "bg-primary-200 text-primary-500 shadow-sm"
                    : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
                }`}
              >
                Hist√≥rico (Pagos)
              </button>
            </div>

            <Button
              onClick={() =>
                navigate("/pagamento-equipe/novo", {
                  state: { funcionarioId: selectedFuncId },
                })
              }
              variant="primary"
              className="shadow-lg shadow-primary-500/20"
              icon={DollarSign}
            >
              Novo Lan√ßamento
            </Button>
          </div>

          {/* CONTENT AREA */}
          <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden min-h-[400px]">
            {/* TAB: PENDENTE */}
            {activeTab === "PENDENTE" && (
              <div className="p-0">
                {/* ADIANTAMENTOS EM ABERTO */}
                {valesPendentes.length > 0 && (
                  <div className="mb-6 border-b border-neutral-100 pb-2">
                    <div className="px-6 py-4 bg-amber-50/50 flex items-center gap-2">
                      <AlertCircle size={16} className="text-amber-500" />
                      <h3 className="text-xs font-bold text-amber-700 uppercase tracking-widest">
                        Adiantamentos (Vales) em Aberto
                      </h3>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-left">
                        <thead className="bg-neutral-50 border-b border-neutral-200 text-xs uppercase tracking-wider text-neutral-500 font-semibold">
                          <tr>
                            <th className="p-4">Data</th>
                            <th className="p-4">Descri√ß√£o</th>
                            <th className="p-4 text-right">Valor</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-neutral-100">
                          {valesPendentes.map((vale, idx) => (
                            <tr key={`vale-${idx}`} className="text-sm">
                              <td className="px-6 py-3 font-bold text-neutral-600">
                                {new Date(
                                  vale.dt_pagamento,
                                ).toLocaleDateString()}
                              </td>
                              <td className="p-4 px-6 text-neutral-600">
                                {vale.obs || "Adiantamento (Sem descri√ß√£o)"}
                              </td>
                              <td className="p-4 px-6 text-right font-bold text-orange-600">
                                {formatCurrency(Number(vale.valor_total))}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                <div className="px-6 py-4 bg-neutral-50/50 border-b border-neutral-100">
                  <h3 className="text-xs font-bold text-neutral-500 uppercase tracking-widest">
                    Comiss√µes Pendentes
                  </h3>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-left">
                    <thead className="bg-neutral-50 border-b border-neutral-200 text-xs uppercase tracking-wider text-neutral-500 font-semibold">
                      <tr>
                        <th className="p-4">OS / Data</th>
                        <th className="p-4">Ve√≠culo / Cliente</th>
                        <th className="p-4 text-right">Valor Servi√ßo</th>
                        <th className="p-4 text-center">%</th>
                        <th className="p-4 text-right">Valor A Receber</th>
                        <th className="p-4 text-center">Status OS</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-100">
                      {pendentes.length === 0 ? (
                        <tr>
                          <td
                            colSpan={6}
                            className="p-12 text-center text-neutral-400 font-bold"
                          >
                            Nenhuma comiss√£o pendente encontrada.
                          </td>
                        </tr>
                      ) : (
                        pendentes.map((item, idx) => {
                          const { porcentagem, valorComissao } =
                            getComissaoInfo(selectedFuncId, Number(item.valor));
                          return (
                            <tr
                              key={`${item.id_os}-${idx}`}
                              className="hover:bg-neutral-25 transition-colors"
                            >
                              <td className="p-4">
                                <div className="font-bold text-neutral-600">
                                  #{item.id_os}
                                </div>
                                <div className="text-[10px] text-neutral-400">
                                  {new Date(
                                    item.ordem_de_servico?.dt_abertura,
                                  ).toLocaleDateString()}
                                </div>
                              </td>
                              <td className="p-4">
                                <div className="text-xs font-bold text-neutral-600">
                                  {item.ordem_de_servico?.veiculo?.modelo}
                                  {item.ordem_de_servico?.veiculo?.cor && (
                                    <span className="text-neutral-500 font-normal ml-1">
                                      ‚Ä¢ {item.ordem_de_servico?.veiculo?.cor}
                                    </span>
                                  )}
                                </div>
                                <div className="text-[10px] font-bold text-neutral-500 uppercase tracking-wider mt-0.5">
                                  {item.ordem_de_servico?.veiculo?.placa}
                                </div>
                                <div className="text-[10px] text-neutral-400 mt-0.5">
                                  {item.ordem_de_servico?.cliente?.pessoa_fisica
                                    ?.pessoa?.nome ||
                                    item.ordem_de_servico?.cliente
                                      ?.pessoa_juridica?.razao_social}
                                </div>
                              </td>
                              <td className="p-4 text-right">
                                <span className="text-xs font-bold text-neutral-400">
                                  {formatCurrency(Number(item.valor))}
                                </span>
                              </td>
                              <td className="p-4 text-center">
                                <span className="text-xs font-bold text-neutral-500 bg-neutral-100 px-2 py-1 rounded">
                                  {porcentagem ? porcentagem : "0"}%
                                </span>
                              </td>
                              <td className="p-4 text-right">
                                <span className="font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded">
                                  {formatCurrency(valorComissao)}
                                </span>
                              </td>
                              <td className="p-4 text-center">
                                <span
                                  className={`px-3 py-1 rounded-md text-[10px] font-bold uppercase whitespace-nowrap ${getStatusStyle(item.ordem_de_servico?.status || "")}`}
                                >
                                  {item.ordem_de_servico?.status
                                    ? item.ordem_de_servico.status ===
                                        "PRONTO_PARA_FINANCEIRO" ||
                                      item.ordem_de_servico.status ===
                                        "PRONTO PARA FINANCEIRO"
                                      ? "FINANCEIRO"
                                      : item.ordem_de_servico.status.replace(
                                          /_/g,
                                          " ",
                                        )
                                    : "N/A"}
                                </span>
                              </td>
                            </tr>
                          );
                        })
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* TAB: PAGO (HISTORICO) */}
            {activeTab === "PAGO" && (
              <div>
                {/* FILTROS E BUSCA */}
                <div className="bg-surface p-4 rounded-xl shadow-sm border border-neutral-200 flex flex-col md:flex-row items-center justify-between gap-4 m-4">
                  <div className="flex-1 w-full relative">
                    <Input
                      placeholder="Buscar por OS, Placa, Cliente..."
                      value={historySearchTerm}
                      onChange={(e) => setHistorySearchTerm(e.target.value)}
                      icon={Search}
                    />
                  </div>

                  <div className="flex items-center gap-2 overflow-x-auto pb-2 md:pb-0">
                    {/* Quick Filters Group */}
                    <div className="flex bg-neutral-100 p-1 rounded-xl shrink-0">
                      <button
                        onClick={() => applyQuickFilter("TODAY")}
                        className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                          activeFilter === "TODAY"
                            ? "bg-primary-200 text-primary-500 shadow-sm"
                            : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
                        }`}
                      >
                        Hoje
                      </button>
                      <button
                        onClick={() => applyQuickFilter("WEEK")}
                        className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                          activeFilter === "WEEK"
                            ? "bg-primary-200 text-primary-500 shadow-sm"
                            : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
                        }`}
                      >
                        Semana
                      </button>
                      <button
                        onClick={() => applyQuickFilter("MONTH")}
                        className={`px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${
                          activeFilter === "MONTH"
                            ? "bg-primary-200 text-primary-500 shadow-sm"
                            : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
                        }`}
                      >
                        M√™s
                      </button>
                    </div>

                    {/* Manual Date Inputs */}
                    <div className="flex gap-2 items-center">
                      <input
                        type="date"
                        value={filterHistStart}
                        onChange={(e) => {
                          setFilterHistStart(e.target.value);
                          setActiveFilter("CUSTOM");
                        }}
                        className={`h-10 px-3 rounded-lg border text-xs font-bold bg-white focus:outline-none focus:ring-2 focus:ring-primary-200 transition-colors ${
                          activeFilter === "CUSTOM"
                            ? "border-primary-300 text-primary-700"
                            : "border-neutral-200 text-neutral-600"
                        }`}
                      />
                      <span className="text-neutral-400 self-center">-</span>
                      <input
                        type="date"
                        value={filterHistEnd}
                        onChange={(e) => {
                          setFilterHistEnd(e.target.value);
                          setActiveFilter("CUSTOM");
                        }}
                        className={`h-10 px-3 rounded-lg border text-xs font-bold bg-white focus:outline-none focus:ring-2 focus:ring-primary-200 transition-colors ${
                          activeFilter === "CUSTOM"
                            ? "border-primary-300 text-primary-700"
                            : "border-neutral-200 text-neutral-600"
                        }`}
                      />
                    </div>

                    <div className="flex flex-col items-end min-w-max ml-4 px-4 border-l border-neutral-200">
                      <span className="text-[10px] font-bold uppercase tracking-widest text-neutral-400">
                        Total Pago
                      </span>
                      <span className="text-lg font-bold text-neutral-600">
                        {formatCurrency(totalHistorico)}
                      </span>
                    </div>
                  </div>
                </div>

                <div className="overflow-x-auto">
                  <table className="w-full text-left">
                    <thead className="bg-neutral-50 border-b border-neutral-200 text-xs uppercase tracking-wider text-neutral-500 font-semibold">
                      <tr>
                        <th className="p-4">Data Pagto</th>
                        <th className="p-4">Tipo</th>
                        <th className="p-4">OS / Detalhe</th>
                        <th className="p-4">Ve√≠culo</th>
                        <th className="p-4">Cliente</th>
                        <th className="p-4 text-right">Valor Pago</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-100">
                      {flattenedHistorico.length === 0 ? (
                        <tr>
                          <td
                            colSpan={6}
                            className="p-12 text-center text-neutral-400 font-bold"
                          >
                            Nenhum hist√≥rico encontrado.
                          </td>
                        </tr>
                      ) : (
                        flattenedHistorico.map((item, idx) => (
                          <tr
                            key={`${item.id}-${idx}`}
                            className="hover:bg-neutral-50 transition-colors"
                          >
                            <td className="p-4 text-xs font-bold text-neutral-600">
                              {new Date(item.date).toLocaleDateString()}
                            </td>
                            <td className="p-4">
                              <span
                                className={`px-2 py-1 rounded text-[9px] font-bold uppercase tracking-wider ${
                                  item.type === "COMISSAO"
                                    ? "bg-emerald-50 text-emerald-600"
                                    : item.type === "VALE"
                                      ? "bg-amber-50 text-amber-600"
                                      : "bg-blue-50 text-blue-600"
                                }`}
                              >
                                {item.type}
                              </span>
                            </td>
                            <td className="p-4">
                              {item.type === "COMISSAO" ? (
                                <div className="flex flex-col gap-1">
                                  <span className="font-bold text-neutral-600">
                                    OS #{item.os.id_os}
                                  </span>
                                  {(item.os.defeito_relatado ||
                                    item.os.diagnostico) && (
                                    <div className="text-[10px] text-neutral-500 leading-tight bg-neutral-100/50 p-1.5 rounded-md border border-neutral-100 max-w-[200px]">
                                      {item.os.defeito_relatado && (
                                        <div className="mb-0.5">
                                          <span className="font-bold text-neutral-600">
                                            Def:
                                          </span>{" "}
                                          {item.os.defeito_relatado}
                                        </div>
                                      )}
                                      {item.os.diagnostico && (
                                        <div>
                                          <span className="font-bold text-neutral-600">
                                            Diag:
                                          </span>{" "}
                                          {item.os.diagnostico}
                                        </div>
                                      )}
                                    </div>
                                  )}
                                </div>
                              ) : (
                                <span className="text-xs font-medium text-neutral-600">
                                  {item.description}
                                </span>
                              )}
                            </td>
                            <td className="p-4">
                              {item.type === "COMISSAO" ? (
                                <div className="text-xs">
                                  <div className="font-bold text-neutral-600">
                                    {item.os.veiculo?.modelo}
                                  </div>
                                  <div className="text-[10px] text-neutral-500">
                                    {item.os.veiculo?.placa} ‚Ä¢{" "}
                                    {item.os.veiculo?.cor}
                                  </div>
                                </div>
                              ) : (
                                <span className="text-neutral-300 transform scale-150 block w-4 h-px bg-neutral-200 is-dash"></span>
                              )}
                            </td>
                            <td className="p-4">
                              {item.type === "COMISSAO" ? (
                                <div className="text-xs font-medium text-neutral-600">
                                  {item.os.cliente?.pessoa_fisica?.pessoa
                                    ?.nome ||
                                    item.os.cliente?.pessoa_juridica
                                      ?.razao_social}
                                </div>
                              ) : (
                                <span className="text-neutral-300 transform scale-150 block w-4 h-px bg-neutral-200 is-dash"></span>
                              )}
                            </td>
                            <td className="p-4 text-right">
                              <div className="font-bold text-neutral-600 text-xs">
                                {formatCurrency(
                                  item.type === "COMISSAO"
                                    ? item.commissionValue
                                    : item.value,
                                )}
                              </div>
                              {item.type === "COMISSAO" && (
                                <div className="text-[9px] text-neutral-400">
                                  ({item.percentage}%)
                                </div>
                              )}
                            </td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>
        </div>
      ) : (
        // EMPTY STATE
        <div className="bg-surface rounded-xl border border-dashed border-neutral-200 p-12 flex flex-col items-center justify-center text-center mt-6">
          <div className="w-16 h-16 bg-neutral-100 rounded-full flex items-center justify-center text-neutral-400 mb-4">
            <User size={32} />
          </div>
          <h3 className="font-bold text-lg text-neutral-600">
            Nenhum Colaborador Selecionado
          </h3>
          <p className="text-neutral-500 max-w-sm mt-2">
            Selecione um colaborador na lista acima para visualizar suas
            comiss√µes, hist√≥rico e realizar pagamentos.
          </p>
        </div>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\PagamentoPecaPage.tsx
================================================================================
import { useState, useEffect } from "react";
import { formatCurrency } from "../utils/formatCurrency";
import { api } from "../services/api";
import { StatusBanner } from "../components/ui/StatusBanner";
import { ActionButton } from "../components/ui/ActionButton";
import { Button } from "../components/ui/Button";
import { Input } from "../components/ui/input";
import {
  Search,
  Truck,
  Calendar,
  CheckSquare,
  Square,
  Edit,
  Trash2,
  Save,
  DollarSign,
  X,
} from "lucide-react";
import { Modal } from "../components/ui/Modal";

export const PagamentoPecaPage = () => {
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });
  const [loading, setLoading] = useState(false);

  // --- STATES FOR ACCOUNTS PAYABLE (PE√áAS) ---
  const [payments, setPayments] = useState<any[]>([]);
  const [fornecedores, setFornecedores] = useState<any[]>([]);
  const [accounts, setAccounts] = useState<any[]>([]); // Bank Accounts

  const [filterSupplier, setFilterSupplier] = useState("");
  const [filterPlate, setFilterPlate] = useState("");
  const [filterStatus, setFilterStatus] = useState<"PENDING" | "PAID" | "ALL">(
    "PENDING",
  );

  // NEW FILTERS & QUICK FILTER
  const [activeFilter, setActiveFilter] = useState<
    "TODAY" | "WEEK" | "MONTH" | "CUSTOM"
  >("WEEK");

  const [filterOSStart, setFilterOSStart] = useState(() => {
    const now = new Date();
    const weekAgo = new Date(now);
    weekAgo.setDate(now.getDate() - 7);
    return weekAgo.toLocaleDateString("en-CA");
  });
  const [filterOSEnd, setFilterOSEnd] = useState(() => {
    return new Date().toLocaleDateString("en-CA");
  });

  const [filterPayStart, setFilterPayStart] = useState("");
  const [filterPayEnd, setFilterPayEnd] = useState("");

  // Batch Selection State
  const [selectedIds, setSelectedIds] = useState<number[]>([]);

  const [editPayment, setEditPayment] = useState<any | null>(null);
  const [showEditModal, setShowEditModal] = useState(false);
  const [confirmModal, setConfirmModal] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    onConfirm: () => void;
  }>({ isOpen: false, title: "", message: "", onConfirm: () => {} });

  // Payment Confirmation Modal
  const [paymentModal, setPaymentModal] = useState({
    isOpen: false,
    accountId: "",
    date: new Date().toISOString().split("T")[0],
  });

  useEffect(() => {
    loadData();
  }, []);

  // Clear selection when filters change (optional, but safer to avoid hidden selections)
  useEffect(() => {
    setSelectedIds([]);
  }, [
    filterStatus,
    filterSupplier,
    filterPlate,
    filterOSStart,
    filterOSEnd,
    filterPayStart,
    filterPayEnd,
  ]);

  const loadData = async () => {
    try {
      setLoading(true);
      const [paymentsRes, fornecedoresRes, accountsRes] = await Promise.all([
        api.get("/pagamento-peca"),
        api.get("/fornecedor"),
        api.get("/conta-bancaria"),
      ]);
      setPayments(paymentsRes.data);
      setFornecedores(fornecedoresRes.data);
      setAccounts(accountsRes.data.filter((a: any) => a.ativo));
    } catch (error) {
      console.error(error);
      setStatusMsg({
        type: "error",
        text: "Erro ao carregar dados financeiros.",
      });
    } finally {
      setLoading(false);
    }
  };

  const toggleSelection = (id: number) => {
    setSelectedIds((prev) =>
      prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id],
    );
  };

  const clearFilters = () => {
    setFilterStatus("PENDING");
    setFilterSupplier("");
    setFilterPlate("");
    // Reset to week default logic or clear all?
    // Usually "Clear" implies reset to default state
    setActiveFilter("WEEK");
    const now = new Date();
    const weekAgo = new Date(now);
    weekAgo.setDate(now.getDate() - 7);
    setFilterOSStart(weekAgo.toLocaleDateString("en-CA"));
    setFilterOSEnd(now.toLocaleDateString("en-CA"));
    setFilterPayStart("");
    setFilterPayEnd("");
    setSelectedIds([]);
  };

  const applyQuickFilter = (type: "TODAY" | "WEEK" | "MONTH") => {
    setActiveFilter(type);
    const now = new Date();
    const todayStr = now.toLocaleDateString("en-CA");

    if (type === "TODAY") {
      setFilterOSStart(todayStr);
      setFilterOSEnd(todayStr);
    } else if (type === "WEEK") {
      const weekAgo = new Date(now);
      weekAgo.setDate(now.getDate() - 7);
      setFilterOSStart(weekAgo.toLocaleDateString("en-CA"));
      setFilterOSEnd(todayStr);
    } else if (type === "MONTH") {
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      setFilterOSStart(firstDay.toLocaleDateString("en-CA"));
      setFilterOSEnd(todayStr);
    }
  };

  const handleUnpay = async (id: number) => {
    if (
      !window.confirm(
        "Deseja realmente estornar este pagamento? O valor retornar√° para a conta e o registro sair√° do Livro Caixa.",
      )
    )
      return;

    try {
      setLoading(true);
      await api.put(`/pagamento-peca/${id}`, {
        pago_ao_fornecedor: false,
        // revert: true // Backend logic handles default 'false' as revert if implemented properly or explicit flag
      });
      setStatusMsg({
        type: "success",
        text: "Pagamento estornado com sucesso!",
      });
      loadData();
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: "error", text: "Erro ao desfazer pagamento." });
    } finally {
      setLoading(false);
    }
  };

  const handleBatchConfirmClick = () => {
    if (selectedIds.length === 0) {
      setStatusMsg({
        type: "error",
        text: "Nenhum item selecionado para pagamento.",
      });
      return;
    }
    setPaymentModal((prev) => ({ ...prev, isOpen: true }));
  };

  const processBatchPayment = async () => {
    if (!paymentModal.accountId) {
      setStatusMsg({
        type: "error",
        text: "Selecione uma conta banc√°ria de origem.",
      });
      return;
    }

    try {
      setLoading(true);

      // Process updates in parallel
      await Promise.all(
        selectedIds.map((id) => {
          return api.put(`/pagamento-peca/${id}`, {
            pago_ao_fornecedor: true,
            id_conta_bancaria: Number(paymentModal.accountId),
            data_pagamento_fornecedor: paymentModal.date,
          });
        }),
      );

      setStatusMsg({
        type: "success",
        text: `${selectedIds.length} pagamentos confirmados e debitados!`,
      });

      // Clear selection and reload
      setSelectedIds([]);
      setPaymentModal((prev) => ({ ...prev, isOpen: false }));
      loadData();
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: "error", text: "Erro ao processar pagamentos." });
    } finally {
      setLoading(false);
    }
  };

  const handleDeletePayment = (id: number) => {
    setConfirmModal({
      isOpen: true,
      title: "Excluir Pagamento",
      message:
        "Tem certeza que deseja excluir este registro de conta a pagar? Esta a√ß√£o √© irrevers√≠vel.",
      onConfirm: async () => {
        try {
          setLoading(true);
          await api.delete(`/pagamento-peca/${id}`);
          setStatusMsg({
            type: "success",
            text: "Pagamento exclu√≠do com sucesso!",
          });
          loadData();
        } catch (error) {
          setStatusMsg({ type: "error", text: "Erro ao excluir pagamento." });
        } finally {
          setLoading(false);
          setConfirmModal((prev) => ({ ...prev, isOpen: false }));
        }
      },
    });
  };

  const handleUpdatePayment = async () => {
    if (!editPayment) return;
    try {
      setLoading(true);
      await api.put(`/pagamento-peca/${editPayment.id_pagamento_peca}`, {
        custo_real: Number(editPayment.custo_real),
        id_fornecedor: Number(editPayment.id_fornecedor),
        // Keep data_compra managed if needed, but for now we focus on payment date
        data_compra: new Date(editPayment.data_compra),
        data_pagamento_fornecedor: editPayment.data_pagamento_fornecedor
          ? new Date(editPayment.data_pagamento_fornecedor)
          : null,
        pago_ao_fornecedor: editPayment.pago_ao_fornecedor,
      });

      if (editPayment.item_os && editPayment.ref_nota) {
        await api.put(`/itens-os/${editPayment.item_os.id_iten}`, {
          codigo_referencia: editPayment.ref_nota,
        });
      }

      setStatusMsg({ type: "success", text: "Dados atualizados com sucesso!" });
      loadData();
      setShowEditModal(false);
      setEditPayment(null);
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao atualizar pagamento." });
    } finally {
      setLoading(false);
    }
  };

  const openEditModal = (payment: any) => {
    setEditPayment({
      ...payment,
      data_compra: new Date(payment.data_compra).toISOString().split("T")[0],
      data_pagamento_fornecedor: payment.data_pagamento_fornecedor
        ? new Date(payment.data_pagamento_fornecedor)
            .toISOString()
            .split("T")[0]
        : "",
      ref_nota: payment.item_os?.codigo_referencia || "",
    });
    setShowEditModal(true);
  };

  const filteredPayments = payments
    .filter((p) => {
      // --- HELPER FOR ROBUST LOCAL DATE COMPARISON ---
      // Converts "YYYY-MM-DD" string to a local Date object at 00:00:00 or 23:59:59
      const getLocalStart = (dateStr: string) => {
        if (!dateStr) return null;
        const [y, m, d] = dateStr.split("-").map(Number);
        return new Date(y, m - 1, d, 0, 0, 0, 0);
      };
      const getLocalEnd = (dateStr: string) => {
        if (!dateStr) return null;
        const [y, m, d] = dateStr.split("-").map(Number);
        return new Date(y, m - 1, d, 23, 59, 59, 999);
      };

      // 1. Status Filter
      if (filterStatus === "PENDING" && p.pago_ao_fornecedor) return false;
      if (filterStatus === "PAID" && !p.pago_ao_fornecedor) return false;

      // 2. OS Finish Date Filter (dt_entrega)
      if (filterOSStart || filterOSEnd) {
        // Cannot filter by OS date if OS date doesn't exist
        if (!p.item_os?.ordem_de_servico?.dt_entrega) return false;

        const osDate = new Date(p.item_os.ordem_de_servico.dt_entrega);

        if (filterOSStart) {
          const start = getLocalStart(filterOSStart);
          if (start && osDate < start) return false;
        }
        if (filterOSEnd) {
          const end = getLocalEnd(filterOSEnd);
          if (end && osDate > end) return false;
        }
      }

      // 3. Payment to Supplier Date Filter (data_pagamento_fornecedor)
      if (filterPayStart || filterPayEnd) {
        // If we are filtering by payment date, the item MUST have a payment date
        if (!p.data_pagamento_fornecedor) return false;

        const payDate = new Date(p.data_pagamento_fornecedor);

        if (filterPayStart) {
          const start = getLocalStart(filterPayStart);
          if (start && payDate < start) return false;
        }
        if (filterPayEnd) {
          const end = getLocalEnd(filterPayEnd);
          if (end && payDate > end) return false;
        }
      }

      // 4. Supplier Filter
      if (filterSupplier && filterSupplier !== "") {
        if (String(p.id_fornecedor) !== String(filterSupplier)) return false;
      }

      // 5. General Search (was Plate Filter)
      if (filterPlate) {
        const q = filterPlate.toLowerCase();
        const plate =
          p.item_os?.ordem_de_servico?.veiculo?.placa?.toLowerCase() || "";
        const model =
          p.item_os?.ordem_de_servico?.veiculo?.modelo?.toLowerCase() || "";
        const color =
          p.item_os?.ordem_de_servico?.veiculo?.cor?.toLowerCase() || "";
        const supplier = (
          p.fornecedor?.nome_fantasia ||
          p.fornecedor?.nome ||
          ""
        ).toLowerCase();
        const desc = p.item_os?.descricao?.toLowerCase() || "";
        const osId = String(p.item_os?.id_os || "");
        const fullOsId = `#${osId}`;

        const searchable = [
          plate,
          model,
          color,
          supplier,
          desc,
          osId,
          fullOsId,
        ].join(" ");

        if (!searchable.includes(q)) return false;
      }

      return true;
    })
    .sort(
      (a, b) =>
        new Date(b.data_compra || 0).getTime() -
        new Date(a.data_compra || 0).getTime(),
    );

  // Calculate totals
  const totalSelected = filteredPayments
    .filter((p) => selectedIds.includes(p.id_pagamento_peca))
    .reduce((acc, p) => acc + Number(p.custo_real), 0);

  return (
    <div className="w-full mx-auto px-4 md:px-8 py-6 space-y-6">
      <StatusBanner
        msg={statusMsg}
        onClose={() => setStatusMsg({ type: null, text: "" })}
      />
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl font-bold text-neutral-600 tracking-tight">
            Pagamento de Auto Pe√ßas
          </h1>
          <p className="text-neutral-500">
            Controle de pagamento de pe√ßas para fornecedores.
          </p>
        </div>
      </div>
      <div className="space-y-6">
        {/* Filters */}
        <div className="bg-surface p-4 rounded-xl border border-neutral-200 shadow-sm flex flex-col gap-4">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {/* Status */}
            <div>
              <label className="text-[10px] font-bold text-neutral-400 uppercase mb-2 block">
                Status
              </label>
              <div className="flex bg-neutral-100 rounded-xl p-1 gap-1">
                {["PENDING", "PAID", "ALL"].map((st) => (
                  <button
                    key={st}
                    onClick={() => setFilterStatus(st as any)}
                    className={`flex-1 py-2 rounded-lg text-[10px] font-bold transition-all ${
                      filterStatus === st
                        ? "bg-primary-200 text-primary-500 shadow-sm"
                        : "text-neutral-400 hover:text-neutral-600"
                    }`}
                  >
                    {st === "PENDING"
                      ? "PENDENTES"
                      : st === "PAID"
                        ? "PAGAS"
                        : "TODAS"}
                  </button>
                ))}
              </div>
            </div>

            {/* Search */}
            <div className="lg:col-span-2">
              <label className="text-[10px] font-bold text-neutral-400 uppercase mb-2 block">
                Buscar
              </label>
              <Input
                value={filterPlate}
                onChange={(e) => setFilterPlate(e.target.value)}
                placeholder="Placa, OS, Fornecedor..."
                icon={Search}
              />
            </div>

            {/* Supplier */}
            <div>
              <label className="text-[10px] font-bold text-neutral-400 uppercase mb-2 block">
                Fornecedor
              </label>
              <select
                value={filterSupplier}
                onChange={(e) => setFilterSupplier(e.target.value)}
                className="w-full h-[42px] px-3 bg-white border border-neutral-200 rounded-xl font-bold text-sm text-neutral-600 outline-none focus:border-primary-500 transition-colors"
              >
                <option value="">Todos</option>
                {fornecedores.map((f) => (
                  <option key={f.id_fornecedor} value={f.id_fornecedor}>
                    {f.nome_fantasia || f.nome}
                  </option>
                ))}
              </select>
            </div>
          </div>

          {/* Date Filters Row */}
          <div className="flex flex-col lg:flex-row items-start lg:items-center gap-4 border-t border-neutral-100 pt-4">
            {/* Start OS Date */}
            <div className="flex flex-col sm:flex-row items-start sm:items-center gap-2">
              <span className="text-[10px] font-bold text-neutral-400 uppercase whitespace-nowrap min-w-[90px]">
                Finaliza√ß√£o OS:
              </span>
              <div className="flex bg-neutral-100 p-1 rounded-xl shrink-0">
                <button
                  onClick={() => applyQuickFilter("TODAY")}
                  className={`px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all ${
                    activeFilter === "TODAY"
                      ? "bg-primary-200 text-primary-500 shadow-sm"
                      : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
                  }`}
                >
                  Hoje
                </button>
                <button
                  onClick={() => applyQuickFilter("WEEK")}
                  className={`px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all ${
                    activeFilter === "WEEK"
                      ? "bg-primary-200 text-primary-500 shadow-sm"
                      : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
                  }`}
                >
                  Semana
                </button>
                <button
                  onClick={() => applyQuickFilter("MONTH")}
                  className={`px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all ${
                    activeFilter === "MONTH"
                      ? "bg-primary-200 text-primary-500 shadow-sm"
                      : "text-neutral-500 hover:text-neutral-700 hover:bg-white/50"
                  }`}
                >
                  M√™s
                </button>
              </div>

              <div className="flex gap-2 items-center">
                <div className="w-32">
                  <Input
                    type="date"
                    value={filterOSStart}
                    onChange={(e) => {
                      setFilterOSStart(e.target.value);
                      setActiveFilter("CUSTOM");
                    }}
                    className={`h-9 px-2 text-[10px] uppercase font-bold ${activeFilter === "CUSTOM" ? "border-primary-300 text-primary-700" : ""}`}
                  />
                </div>
                <span className="text-neutral-400">-</span>
                <div className="w-32">
                  <Input
                    type="date"
                    value={filterOSEnd}
                    onChange={(e) => {
                      setFilterOSEnd(e.target.value);
                      setActiveFilter("CUSTOM");
                    }}
                    className={`h-9 px-2 text-[10px] uppercase font-bold ${activeFilter === "CUSTOM" ? "border-primary-300 text-primary-700" : ""}`}
                  />
                </div>
              </div>
            </div>

            {/* Payment Date */}
            <div className="flex flex-col sm:flex-row items-start sm:items-center gap-2 lg:ml-auto">
              <span className="text-[10px] font-bold text-neutral-400 uppercase whitespace-nowrap min-w-[130px]">
                Pagamento Fornecedor:
              </span>
              <div className="flex gap-2 items-center">
                <div className="w-32">
                  <Input
                    type="date"
                    value={filterPayStart}
                    onChange={(e) => setFilterPayStart(e.target.value)}
                    className="h-9 px-2 text-[10px] uppercase font-bold"
                  />
                </div>
                <span className="text-neutral-400">-</span>
                <div className="w-32">
                  <Input
                    type="date"
                    value={filterPayEnd}
                    onChange={(e) => setFilterPayEnd(e.target.value)}
                    className="h-9 px-2 text-[10px] uppercase font-bold"
                  />
                </div>
              </div>
            </div>

            <Button
              onClick={clearFilters}
              variant="ghost"
              size="sm"
              icon={X}
              className="hidden lg:flex"
            >
              Limpar
            </Button>
          </div>

          <div className="lg:hidden flex justify-end">
            <Button onClick={clearFilters} variant="ghost" size="sm" icon={X}>
              Limpar Filtros
            </Button>
          </div>
        </div>

        {/* Totals Summary */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {/* CARD 1: SELETOR DE BAIXA (Checkboxes) - Show only if items selected */}
          {selectedIds.length > 0 ? (
            <div className="bg-blue-900 p-6 rounded-2xl flex items-center justify-between shadow-xl shadow-blue-500/20 text-white animate-in zoom-in duration-300">
              <div>
                <p className="text-[10px] font-black uppercase tracking-widest mb-1 opacity-80">
                  Selecionado para Baixa ({selectedIds.length})
                </p>
                <p className="text-3xl font-black tracking-tighter">
                  {formatCurrency(totalSelected)}
                </p>
              </div>
              <div className="flex flex-col items-end gap-2">
                <Button
                  onClick={handleBatchConfirmClick}
                  className="bg-neutral-200 text-blue-600 hover:bg-neutral-50 border-none shadow-none"
                  icon={Save}
                >
                  Confirmar Baixa
                </Button>
              </div>
            </div>
          ) : (
            // Display Total Filtered
            <div className="bg-surface p-6 rounded-2xl border border-neutral-200 flex items-center justify-between">
              <div>
                <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest">
                  Total Listado (Status Atual)
                </p>
                <p className="text-3xl font-bold text-neutral-600">
                  {formatCurrency(
                    filteredPayments.reduce(
                      (acc, p) => acc + Number(p.custo_real || 0),
                      0,
                    ),
                  )}
                </p>
              </div>
              <div className="h-10 w-10 bg-neutral-100 rounded-full flex items-center justify-center text-neutral-400">
                <DollarSign size={20} />
              </div>
            </div>
          )}

          {/* CARD 2: Total Geral (Todos) */}
          <div className="bg-neutral-800 p-6 rounded-2xl flex items-center justify-between shadow-lg text-white">
            <div>
              <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest">
                Total Geral (Todos Pendentes)
              </p>
              <p className="text-3xl font-bold">
                {formatCurrency(
                  payments
                    .filter((p) => !p.pago_ao_fornecedor)
                    .reduce((acc, p) => acc + Number(p.custo_real || 0), 0),
                )}
              </p>
            </div>
            <div className="h-10 w-10 bg-white/10 rounded-full flex items-center justify-center text-white/50">
              <DollarSign size={20} />
            </div>
          </div>
        </div>
      </div>{" "}
      {/* Table */}
      <div className="bg-surface rounded-3xl shadow-sm border border-neutral-200 overflow-hidden w-full">
        <table className="w-full text-left border-collapse min-w-[800px]">
          <thead>
            <tr className="bg-neutral-50 text-[10px] font-bold text-neutral-500 uppercase tracking-widest">
              <th className="p-5">Ref / Nota</th>
              <th className="p-5">Pe√ßa</th>
              <th className="p-5">Fornecedor</th>
              <th className="p-5">Ve√≠culo / OS</th>
              <th className="p-5">Status OS</th>
              <th className="p-5 text-right w-32">Valor Custo</th>
              <th className="p-5 text-center w-24">Pagar</th>
              <th className="p-5 text-right w-32">A√ß√µes</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-neutral-50">
            {filteredPayments.length === 0 ? (
              <tr>
                <td
                  colSpan={7}
                  className="p-10 text-center text-neutral-400 italic font-medium"
                >
                  Nenhum registro encontrado.
                </td>
              </tr>
            ) : (
              filteredPayments.map((p) => (
                <tr
                  key={p.id_pagamento_peca}
                  className={`hover:bg-neutral-25 transition-colors ${p.pago_ao_fornecedor ? "bg-neutral-50/50" : ""}`}
                >
                  <td className="p-5">
                    <div className="flex items-center gap-2 font-bold text-neutral-600 text-xs">
                      <Calendar size={14} />
                      {/* DATA INSER√á√ÉO NA OS (from item_os.dt_cadastro) */}
                      {p.item_os?.dt_cadastro
                        ? new Date(p.item_os.dt_cadastro).toLocaleDateString()
                        : "N/A"}
                    </div>
                  </td>
                  <td className="p-5">
                    <span className="font-mono text-xs font-black text-neutral-600 bg-neutral-100 px-2 py-1 rounded w-fit">
                      {p.item_os?.codigo_referencia || "---"}
                    </span>
                  </td>
                  <td className="p-5">
                    <p className="font-bold text-neutral-600 text-sm">
                      {p.item_os?.descricao}
                    </p>
                  </td>
                  <td className="p-5">
                    <div className="flex items-center gap-2">
                      <Truck size={14} className="text-orange-500" />
                      <span className="font-bold text-neutral-700 text-xs uppercase">
                        {p.fornecedor?.nome_fantasia || p.fornecedor?.nome}
                      </span>
                    </div>
                  </td>
                  <td className="p-5">
                    <div className="flex flex-col">
                      <p className="font-black text-neutral-800 text-xs uppercase tracking-widest bg-neutral-100 px-2 py-1 rounded w-fit">
                        {p.item_os?.ordem_de_servico?.veiculo?.placa || "---"}
                      </p>
                      <p className="text-[10px] text-neutral-500 font-bold mt-1 uppercase">
                        {p.item_os?.ordem_de_servico?.veiculo?.modelo || "N/A"}{" "}
                        {p.item_os?.ordem_de_servico?.veiculo?.cor
                          ? `‚Ä¢ ${p.item_os.ordem_de_servico.veiculo.cor}`
                          : ""}
                      </p>

                      <p className="text-[10px] text-neutral-400 font-bold mt-0.5">
                        OS #{p.item_os?.id_os}
                      </p>
                      {/* Optional: Show OS Finish Date if available */}
                      {p.item_os?.ordem_de_servico?.dt_entrega && (
                        <p className="text-[9px] text-green-600 font-bold mt-1">
                          Fim OS:{" "}
                          {new Date(
                            p.item_os.ordem_de_servico.dt_entrega,
                          ).toLocaleDateString()}
                        </p>
                      )}
                    </div>
                  </td>
                  <td className="p-5">
                    {(() => {
                      const st =
                        p.item_os?.ordem_de_servico?.status || "ABERTA";
                      const styles: Record<string, string> = {
                        FINALIZADA:
                          "bg-emerald-100 text-emerald-700 ring-emerald-200",
                        PAGA_CLIENTE:
                          "bg-neutral-100 text-neutral-600 ring-neutral-200",
                        "PRONTO PARA FINANCEIRO":
                          "bg-amber-100 text-amber-700 ring-amber-200",
                        ABERTA: "bg-blue-100 text-blue-700 ring-blue-200",
                        EM_ANDAMENTO: "bg-cyan-100 text-cyan-700 ring-cyan-200",
                        CANCELADA: "bg-red-100 text-red-700 ring-red-200",
                      };
                      const style =
                        styles[st] || "bg-gray-50 text-gray-500 ring-gray-200";

                      return (
                        <span
                          className={`px-3 py-1 rounded-md text-[10px] font-black uppercase ring-1 whitespace-nowrap ${style}`}
                        >
                          {st === "PRONTO PARA FINANCEIRO"
                            ? "FINANCEIRO"
                            : st.replace(/_/g, " ")}
                        </span>
                      );
                    })()}
                  </td>
                  <td className="p-5 text-right font-bold text-neutral-600">
                    {formatCurrency(Number(p.custo_real))}
                  </td>
                  <td className="p-5 text-center">
                    {p.pago_ao_fornecedor ? (
                      <div className="flex flex-col items-center">
                        <button
                          onClick={() => handleUnpay(p.id_pagamento_peca)}
                          className="hover:scale-110 transition-transform active:scale-95 text-neutral-400 hover:text-green-600"
                          title={`Pago em: ${p.data_pagamento_fornecedor ? new Date(p.data_pagamento_fornecedor).toLocaleDateString() : "N/A"} (Clique para desfazer)`}
                        >
                          <CheckSquare
                            size={32}
                            className="text-green-500 fill-green-500/20"
                          />
                        </button>
                        {p.data_pagamento_fornecedor && (
                          <span className="text-[9px] font-bold text-green-600 mt-1">
                            {new Date(
                              p.data_pagamento_fornecedor,
                            ).toLocaleDateString()}
                          </span>
                        )}
                      </div>
                    ) : (
                      <button
                        onClick={() => toggleSelection(p.id_pagamento_peca)}
                        className="hover:scale-110 transition-transform active:scale-95 text-neutral-300 hover:text-blue-500"
                        title={
                          selectedIds.includes(p.id_pagamento_peca)
                            ? "Desmarcar"
                            : "Selecionar para pagamento"
                        }
                      >
                        {selectedIds.includes(p.id_pagamento_peca) ? (
                          <CheckSquare
                            size={32}
                            className="text-green-500 fill-green-500/20"
                          />
                        ) : (
                          <Square size={32} className="stroke-[2.5]" />
                        )}
                      </button>
                    )}
                  </td>
                  <td className="p-5 text-right">
                    <div className="flex justify-end gap-2">
                      <ActionButton
                        onClick={() => openEditModal(p)}
                        icon={Edit}
                        label="Editar"
                        variant="accent"
                      />
                      <ActionButton
                        onClick={() => handleDeletePayment(p.id_pagamento_peca)}
                        icon={Trash2}
                        label="Excluir"
                        variant="danger"
                      />
                    </div>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
      {showEditModal && editPayment && (
        <Modal
          title="Editar Pagamento (Pe√ßa)"
          onClose={() => setShowEditModal(false)}
        >
          <div className="space-y-6">
            <div className="bg-neutral-50 p-4 rounded-xl mb-4">
              <p className="text-xs font-bold text-neutral-400 uppercase">
                Item da OS
              </p>
              <p className="font-bold text-neutral-800">
                {editPayment.item_os?.descricao}
              </p>
              <div className="mt-2 text-[10px] text-neutral-400 font-mono">
                Inserido em:{" "}
                {editPayment.item_os?.dt_cadastro
                  ? new Date(editPayment.item_os.dt_cadastro).toLocaleString()
                  : "N/A"}
              </div>
              <div className="mt-2">
                <Input
                  label="Ref / Nota"
                  value={editPayment.ref_nota || ""}
                  onChange={(e) =>
                    setEditPayment({ ...editPayment, ref_nota: e.target.value })
                  }
                  placeholder="N√∫mero da Nota / Refer√™ncia"
                />
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Read-Only Insertion Date */}
              <div>
                <Input
                  label="Data de Inser√ß√£o na OS (Auto)"
                  disabled
                  value={
                    editPayment.item_os?.dt_cadastro
                      ? new Date(
                          editPayment.item_os.dt_cadastro,
                        ).toLocaleDateString()
                      : "N/A"
                  }
                />
              </div>

              {/* Read-Only OS Finish Date */}
              <div>
                <Input
                  label="Data de Finaliza√ß√£o da OS"
                  disabled
                  value={
                    editPayment.item_os?.ordem_de_servico?.dt_entrega
                      ? new Date(
                          editPayment.item_os.ordem_de_servico.dt_entrega,
                        ).toLocaleDateString()
                      : "OS em Aberto"
                  }
                />
              </div>

              {/* Editable Payment Date */}
              <div className="md:col-span-2">
                <Input
                  label="Data de Pagamento √† Auto Pe√ßas (Edit√°vel)"
                  type="date"
                  value={editPayment.data_pagamento_fornecedor || ""}
                  onChange={(e) =>
                    setEditPayment({
                      ...editPayment,
                      data_pagamento_fornecedor: e.target.value,
                    })
                  }
                  className="text-green-700 font-bold"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Input
                  label="Custo Real (R$)"
                  type="number"
                  step="0.01"
                  value={editPayment.custo_real}
                  onChange={(e) =>
                    setEditPayment({
                      ...editPayment,
                      custo_real: e.target.value,
                    })
                  }
                />
              </div>
              <div>
                <label className="text-sm font-semibold text-neutral-700 mb-1.5 block">
                  Fornecedor
                </label>
                <select
                  value={editPayment.id_fornecedor}
                  onChange={(e) =>
                    setEditPayment({
                      ...editPayment,
                      id_fornecedor: e.target.value,
                    })
                  }
                  className="w-full bg-white border border-neutral-200 px-3 py-2.5 rounded-lg font-bold text-sm text-neutral-600 outline-none focus:border-primary-500 transition-colors h-[42px]"
                >
                  {fornecedores.map((f) => (
                    <option key={f.id_fornecedor} value={f.id_fornecedor}>
                      {f.nome_fantasia || f.nome}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* Revert Payment Option */}
            {editPayment.data_pagamento_fornecedor && (
              <div className="mt-4 p-4 bg-orange-50 border border-orange-100 rounded-xl flex items-center gap-3">
                <input
                  type="checkbox"
                  id="revertPayment"
                  checked={!editPayment.pago_ao_fornecedor}
                  onChange={(e) =>
                    setEditPayment({
                      ...editPayment,
                      pago_ao_fornecedor: !e.target.checked,
                    })
                  }
                  className="w-5 h-5 text-orange-600 rounded focus:ring-orange-500 border-gray-300 cursor-pointer"
                />
                <label htmlFor="revertPayment" className="cursor-pointer">
                  <p className="text-sm font-bold text-orange-800">
                    Estornar Pagamento
                  </p>
                  <p className="text-xs text-orange-600">
                    Ao marcar, o pagamento voltar√° para "Pendente" e o valor
                    ser√° estornado no caixa/banco (mantendo registro riscado).
                  </p>
                </label>
              </div>
            )}

            <div className="flex gap-3 pt-4 border-t border-neutral-100">
              <Button
                variant="ghost"
                onClick={() => setShowEditModal(false)}
                className="flex-1"
              >
                Cancelar
              </Button>
              <Button
                variant="dark"
                onClick={handleUpdatePayment}
                className="flex-1 shadow-lg"
              >
                Salvar Altera√ß√µes
              </Button>
            </div>
          </div>
        </Modal>
      )}
      {/* CONFIRM PAYMENT MODAL (WITH ACCOUNT SELECTION) */}
      {paymentModal.isOpen && (
        <Modal
          title="Confirmar Pagamento e Baixa"
          onClose={() =>
            setPaymentModal((prev) => ({ ...prev, isOpen: false }))
          }
        >
          <div className="space-y-6">
            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
              <p className="text-sm font-bold text-blue-800 mb-1">
                Resumo da Opera√ß√£o
              </p>
              <p className="text-xs text-blue-600">
                Voc√™ est√° confirmando <strong>{selectedIds.length}</strong>{" "}
                pagamentos no valor total de{" "}
                <strong>
                  R${" "}
                  {totalSelected.toLocaleString("pt-BR", {
                    minimumFractionDigits: 2,
                  })}
                </strong>
                .
              </p>
            </div>

            <div className="space-y-4">
              <Input
                label="Data do Pagamento"
                type="date"
                value={paymentModal.date}
                onChange={(e) =>
                  setPaymentModal({ ...paymentModal, date: e.target.value })
                }
              />

              <div>
                <label className="text-sm font-semibold text-neutral-700 mb-1.5 block">
                  Conta de Origem (D√©bito)
                </label>
                <select
                  value={paymentModal.accountId}
                  onChange={(e) =>
                    setPaymentModal({
                      ...paymentModal,
                      accountId: e.target.value,
                    })
                  }
                  className="w-full bg-white border border-neutral-200 px-3 py-2.5 rounded-lg font-bold text-sm text-neutral-600 outline-none focus:border-primary-500 transition-colors h-[42px]"
                >
                  <option value="">Selecione uma conta...</option>
                  {accounts.map((acc) => (
                    <option key={acc.id_conta} value={acc.id_conta}>
                      {acc.nome} {acc.banco ? `(${acc.banco})` : ""} - Saldo:{" "}
                      {formatCurrency(Number(acc.saldo_atual))}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <div className="pt-4 flex gap-3">
              <Button
                variant="ghost"
                onClick={() =>
                  setPaymentModal((prev) => ({ ...prev, isOpen: false }))
                }
                className="flex-1"
              >
                Cancelar
              </Button>
              <Button
                variant="success"
                onClick={processBatchPayment}
                disabled={loading}
                isLoading={loading}
                className="flex-1 shadow-lg shadow-green-500/20"
                icon={DollarSign}
              >
                Confirmar Pagamento
              </Button>
            </div>
          </div>
        </Modal>
      )}
      {/* Confirmation Modal */}
      {confirmModal.isOpen && (
        <Modal
          title={confirmModal.title}
          onClose={() =>
            setConfirmModal((prev) => ({ ...prev, isOpen: false }))
          }
        >
          <div className="space-y-6">
            <p className="text-neutral-600 font-medium">
              {confirmModal.message}
            </p>
            <div className="flex justify-end gap-3 pt-2">
              <Button
                variant="ghost"
                onClick={() =>
                  setConfirmModal((prev) => ({ ...prev, isOpen: false }))
                }
              >
                Cancelar
              </Button>
              <Button
                variant="danger"
                onClick={confirmModal.onConfirm}
                className="shadow-lg shadow-red-500/30"
              >
                Confirmar Exclus√£o
              </Button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\PecasEstoquePage.tsx
================================================================================
import { useState, useEffect } from "react";
import { formatCurrency } from "../utils/formatCurrency";
import { api } from "../services/api";
import type { IPecasEstoque } from "../types/backend";
import { Modal } from "../components/ui/Modal";
import {
  Search,
  Trash2,
  Edit,
  Package,
  CheckCircle,
  ShoppingCart,
} from "lucide-react";
import { StatusBanner } from "../components/ui/StatusBanner";
import { useNavigate } from "react-router-dom";
import { Button } from "../components/ui/Button";
import { Input } from "../components/ui/input";

export const PecasEstoquePage = () => {
  const navigate = useNavigate();
  const [pecas, setPecas] = useState<IPecasEstoque[]>([]);

  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });

  // Search
  const [searchId, setSearchId] = useState("");
  const [listSearchTerm, setListSearchTerm] = useState(""); // Global filter

  // Edit Modal State
  const [editModalOpen, setEditModalOpen] = useState(false);
  const [editData, setEditData] = useState<IPecasEstoque | null>(null);
  const [formData, setFormData] = useState({
    nome: "",
    fabricante: "",
    descricao: "",
    unidade_medida: "UN",
    valor_custo: "",
    margem_lucro: "",
    valor_venda: "",
    estoque_atual: "",
  });

  useEffect(() => {
    loadPecas();
  }, []);

  // FILTERED LIST
  const filteredPecas = pecas.filter((p) => {
    if (!listSearchTerm) return true;
    const term = listSearchTerm.toLowerCase();
    return (
      p.nome.toLowerCase().includes(term) ||
      p.descricao.toLowerCase().includes(term) ||
      (p.fabricante && p.fabricante.toLowerCase().includes(term)) ||
      String(p.id_pecas_estoque).includes(term)
    );
  });

  const handleRecalcMargin = (saleVal: string) => {
    setFormData((prev) => {
      const sale = Number(saleVal);
      const cost = Number(prev.valor_custo);
      let margin = prev.margem_lucro;
      if (cost > 0 && sale > 0) {
        margin = (((sale - cost) / cost) * 100).toFixed(2);
      }
      return { ...prev, valor_venda: saleVal, margem_lucro: margin };
    });
  };

  const handleRecalcSale = (marginVal: string) => {
    setFormData((prev) => {
      const margin = Number(marginVal);
      const cost = Number(prev.valor_custo);
      let sale = prev.valor_venda;
      if (cost > 0) {
        sale = (cost + cost * (margin / 100)).toFixed(2);
      }
      return { ...prev, margem_lucro: marginVal, valor_venda: sale };
    });
  };

  const loadPecas = async () => {
    try {
      const response = await api.get("/pecas-estoque");
      setPecas(response.data);
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao carregar estoque." });
    }
  };

  const handleSearch = async () => {
    if (!searchId) return;
    try {
      const response = await api.get(`/pecas-estoque/${searchId}`);
      // Setup Form Data
      const p = response.data;
      setEditData(p);

      // Calc Margin
      let margin = "";
      if (Number(p.valor_custo) > 0) {
        margin = (
          ((Number(p.valor_venda) - Number(p.valor_custo)) /
            Number(p.valor_custo)) *
          100
        ).toFixed(2);
      }

      setFormData({
        nome: p.nome,
        fabricante: p.fabricante || "",
        descricao: p.descricao || "",
        unidade_medida: p.unidade_medida || "UN",
        valor_custo: Number(p.valor_custo).toFixed(2),
        margem_lucro: margin,
        valor_venda: Number(p.valor_venda).toFixed(2),
        estoque_atual: String(p.estoque_atual),
      });

      setEditModalOpen(true);
      setSearchId(""); // Clear search ID after opening
    } catch (error) {
      setStatusMsg({ type: "error", text: "Pe√ßa n√£o encontrada por ID." });
      setEditData(null);
    }
  };

  const handleOpenEdit = (p: IPecasEstoque) => {
    setEditData(p);
    // Calc Margin
    let margin = "";
    if (Number(p.valor_custo) > 0) {
      margin = (
        ((Number(p.valor_venda) - Number(p.valor_custo)) /
          Number(p.valor_custo)) *
        100
      ).toFixed(2);
    }

    setFormData({
      nome: p.nome,
      fabricante: p.fabricante || "",
      descricao: p.descricao || "",
      unidade_medida: p.unidade_medida || "UN",
      valor_custo: Number(p.valor_custo).toFixed(2),
      margem_lucro: margin,
      valor_venda: Number(p.valor_venda).toFixed(2),
      estoque_atual: String(p.estoque_atual),
    });
    setEditModalOpen(true);
  };

  // Confirm Modal State
  const [confirmModal, setConfirmModal] = useState<{
    show: boolean;
    title: string;
    msg: string;
    onConfirm: () => void;
    type: "warning" | "info" | "danger";
  }>({ show: false, title: "", msg: "", onConfirm: () => {}, type: "info" });

  const handleCloseModal = () => {
    if (editData) {
      setConfirmModal({
        show: true,
        title: "Descartar Altera√ß√µes?",
        msg: "Existem dados carregados. Deseja sair sem salvar?",
        type: "warning",
        onConfirm: () => {
          setEditModalOpen(false);
          setEditData(null);
          setConfirmModal((prev) => ({ ...prev, show: false }));
        },
      });
    } else {
      setEditModalOpen(false);
    }
  };

  const executeUpdate = async () => {
    if (!editData) return;
    try {
      // Build a clean payload with only editable fields
      const payload = {
        nome: formData.nome,
        fabricante: formData.fabricante,
        descricao: formData.descricao,
        unidade_medida: formData.unidade_medida,
        valor_custo: Number(formData.valor_custo),
        valor_venda: Number(formData.valor_venda),
        estoque_atual: Number(formData.estoque_atual),
      };

      await api.put(`/pecas-estoque/${editData.id_pecas_estoque}`, payload);

      setStatusMsg({ type: "success", text: "Pe√ßa atualizada com sucesso!" });
      setEditModalOpen(false); // Close edit modal
      setEditData(null);
      loadPecas(); // Refresh list
    } catch (error: any) {
      console.error(error);
      const errorMsg =
        error.response?.data?.error ||
        "Erro ao atualizar pe√ßa. Verifique os dados.";
      setStatusMsg({ type: "error", text: errorMsg });
      // Do NOT close edit modal so user can fix
    }
    setConfirmModal((prev) => ({ ...prev, show: false })); // Always close confirm modal
  };

  const handleUpdate = (e: React.FormEvent) => {
    e.preventDefault();
    setConfirmModal({
      show: true,
      title: "Salvar Altera√ß√µes",
      msg: "Deseja confirmar as atualiza√ß√µes neste item?",
      type: "info",
      onConfirm: executeUpdate,
    });
  };

  const executeDelete = async () => {
    if (!editData) return;
    try {
      await api.delete(`/pecas-estoque/${editData.id_pecas_estoque}`);
      setStatusMsg({ type: "success", text: "Pe√ßa removida do sistema." });
      loadPecas();
      setEditModalOpen(false);
      setEditData(null);
      setSearchId("");
    } catch (error) {
      setStatusMsg({ type: "error", text: "Erro ao deletar pe√ßa." });
    }
    setConfirmModal((prev) => ({ ...prev, show: false }));
  };

  const handleDelete = () => {
    if (!editData) return;
    setConfirmModal({
      show: true,
      title: "Excluir Item",
      msg: "Tem certeza que deseja remover este item permanentemente?",
      type: "danger",
      onConfirm: executeDelete,
    });
  };

  return (
    <div className="w-full mx-auto px-4 md:px-8 py-6 space-y-6">
      <StatusBanner
        msg={statusMsg}
        onClose={() => setStatusMsg({ type: null, text: "" })}
      />

      {/* CONFIRMATION MODAL */}
      {confirmModal.show && (
        <Modal
          title={confirmModal.title}
          onClose={() => setConfirmModal((prev) => ({ ...prev, show: false }))}
          zIndex={60}
        >
          <div className="space-y-4">
            <div
              className={`p-4 rounded-xl border ${confirmModal.type === "danger" ? "bg-red-50 border-red-100 text-red-700" : "bg-blue-50 border-blue-100 text-blue-700"}`}
            >
              <p className="font-bold text-center">{confirmModal.msg}</p>
            </div>
            <div className="flex justify-end gap-2 pt-2">
              <Button
                variant="ghost"
                onClick={() =>
                  setConfirmModal((prev) => ({ ...prev, show: false }))
                }
              >
                Cancelar
              </Button>
              <Button
                variant={confirmModal.type === "danger" ? "danger" : "primary"}
                onClick={confirmModal.onConfirm}
              >
                Confirmar
              </Button>
            </div>
          </div>
        </Modal>
      )}

      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl font-bold text-neutral-900 tracking-tight">
            Estoque de Pe√ßas
          </h1>
          <p className="text-neutral-500">
            Gerencie o invent√°rio de pe√ßas e servi√ßos.
          </p>
        </div>
        <Button
          onClick={() => navigate("/entrada-estoque")}
          variant="primary"
          icon={ShoppingCart}
          className="shadow-lg shadow-primary-500/20"
        >
          Nova Compra / Entrada
        </Button>
      </div>

      {/* ACTION CARDS ROW */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* 1. Maintenance By ID (Left) */}
        <div className="bg-white p-6 rounded-2xl border border-neutral-200 shadow-sm flex flex-col justify-between">
          <h2 className="text-sm font-bold text-neutral-600 uppercase tracking-widest border-b border-neutral-100 pb-2 mb-4">
            Manuten√ß√£o de Item (Por ID)
          </h2>
          <div className="flex gap-4 items-end">
            <div className="flex-1">
              <Input
                label="ID da Pe√ßa"
                type="number"
                value={searchId}
                onChange={(e) => setSearchId(e.target.value)}
                placeholder="123"
              />
            </div>
            <Button
              onClick={handleSearch}
              disabled={!searchId}
              variant="primary"
              className="mb-1"
              icon={Search}
            >
              ABRIR
            </Button>
          </div>
        </div>

        {/* 2. Global Search / Filtering (Right) */}
        <div className="bg-white p-6 rounded-2xl border border-neutral-200 shadow-sm flex flex-col justify-between">
          <h2 className="text-sm font-bold text-neutral-600 uppercase tracking-widest border-b border-neutral-100 pb-2 mb-4">
            Localizar / Filtrar Lista
          </h2>
          <div className="relative">
            <Input
              label="Buscar em todas as colunas"
              value={listSearchTerm}
              onChange={(e) => setListSearchTerm(e.target.value)}
              placeholder="Nome, Fabricante, Descri√ß√£o..."
            />
            <Search
              className="absolute right-3 top-[34px] text-neutral-400 pointer-events-none"
              size={18}
            />
          </div>
        </div>
      </div>

      {/* LIST */}
      <div className="bg-white rounded-2xl shadow-sm border border-neutral-200 overflow-hidden">
        <table className="w-full text-left border-collapse">
          <thead className="bg-neutral-50 border-b border-neutral-100">
            <tr>
              <th className="p-4 text-[10px] font-bold text-neutral-400 uppercase tracking-widest">
                ID
              </th>
              <th className="p-4 text-[10px] font-bold text-neutral-400 uppercase tracking-widest">
                Produto / Pe√ßa
              </th>
              <th className="p-4 text-[10px] font-bold text-neutral-400 uppercase tracking-widest">
                Fornecedor / Data
              </th>
              <th className="p-4 text-[10px] font-bold text-neutral-400 uppercase tracking-widest text-right">
                Estoque
              </th>
              <th className="p-4 text-[10px] font-bold text-neutral-400 uppercase tracking-widest text-right">
                Custo Unit.
              </th>
              <th className="p-4 text-[10px] font-bold text-neutral-400 uppercase tracking-widest text-right">
                Valor Venda
              </th>
              <th className="p-4 text-[10px] font-bold text-neutral-400 uppercase tracking-widest text-right">
                A√ß√µes
              </th>
            </tr>
          </thead>
          <tbody className="divide-y divide-neutral-50">
            {filteredPecas.length === 0 ? (
              <tr>
                <td
                  colSpan={7}
                  className="p-8 text-center text-neutral-400 italic"
                >
                  Nenhum item encontrado.
                </td>
              </tr>
            ) : (
              filteredPecas.map((p) => {
                const lastEntry = (p as any).itens_entrada?.[0]?.entrada;
                const fornecedorName = lastEntry?.fornecedor?.nome || "-";
                const dataCompra = lastEntry?.data_compra
                  ? new Date(lastEntry.data_compra).toLocaleDateString()
                  : "-";
                const nf = lastEntry?.nota_fiscal || "-";

                return (
                  <tr
                    key={p.id_pecas_estoque}
                    className="hover:bg-neutral-50 group transition-colors"
                  >
                    <td className="p-4 text-neutral-500 font-mono text-xs font-bold">
                      #{p.id_pecas_estoque}
                    </td>
                    <td className="p-4 font-medium">
                      <div className="flex items-center gap-3">
                        <div className="bg-primary-50 p-2.5 rounded-xl text-primary-600">
                          <Package size={20} />
                        </div>
                        <div>
                          <div className="font-bold text-neutral-900">
                            {p.nome}
                          </div>
                          <div className="text-xs text-neutral-500 max-w-[200px] truncate">
                            {p.descricao}
                          </div>
                          {p.fabricante && (
                            <div className="text-[10px] text-neutral-400 uppercase font-bold">
                              {p.fabricante}
                            </div>
                          )}
                        </div>
                      </div>
                    </td>
                    <td className="p-4">
                      <div className="text-xs">
                        <div className="font-bold text-neutral-700">
                          {fornecedorName}
                        </div>
                        <div className="text-neutral-400 font-medium">
                          {dataCompra} ‚Ä¢ NF: {nf}
                        </div>
                      </div>
                    </td>
                    <td className="p-4 text-right">
                      <span
                        className={`px-2 py-1 rounded-md text-xs font-bold ${p.estoque_atual > 0 ? "bg-emerald-50 text-emerald-600" : "bg-red-50 text-red-600"}`}
                      >
                        {p.estoque_atual} {p.unidade_medida || "UN"}
                      </span>
                    </td>
                    <td className="p-4 text-right font-medium text-neutral-600">
                      {formatCurrency(Number(p.valor_custo))}
                    </td>
                    <td className="p-4 text-right font-bold text-neutral-900">
                      {formatCurrency(Number(p.valor_venda))}
                    </td>
                    <td className="p-4 text-right">
                      <Button
                        onClick={() => handleOpenEdit(p)}
                        variant="secondary"
                        size="sm"
                        icon={Edit}
                        className="py-1 px-2"
                      >
                        Editar
                      </Button>
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>

      {/* EDIT MODAL */}
      {editModalOpen && (
        <Modal
          title={`Manuten√ß√£o de Item: ${editData?.nome}`}
          onClose={handleCloseModal}
          className="max-w-4xl"
        >
          <form onSubmit={handleUpdate} className="space-y-6 pt-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Input
                  label="Nome do Item"
                  value={formData.nome}
                  onChange={(e) =>
                    setFormData({ ...formData, nome: e.target.value })
                  }
                  required
                />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <Input
                    label="Fabricante"
                    value={formData.fabricante}
                    onChange={(e) =>
                      setFormData({ ...formData, fabricante: e.target.value })
                    }
                    placeholder="Marca..."
                  />
                </div>
                <div>
                  <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">
                    Unidade
                  </label>
                  <select
                    value={formData.unidade_medida}
                    onChange={(e) =>
                      setFormData({
                        ...formData,
                        unidade_medida: e.target.value,
                      })
                    }
                    className="w-full p-[10px] rounded-lg border border-neutral-200 bg-neutral-50 focus:bg-white outline-none focus:border-primary-500 font-bold text-sm h-[42px] transition-all"
                  >
                    <option value="UN">Unidade (UN)</option>
                    <option value="L">Litro (L)</option>
                    <option value="KG">Quilo (KG)</option>
                    <option value="KIT">Kit</option>
                    <option value="PAR">Par</option>
                  </select>
                </div>
              </div>
            </div>

            {/* Values Row */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <Input
                  label="Estoque Atual"
                  type="number"
                  value={formData.estoque_atual}
                  onChange={(e) =>
                    setFormData({ ...formData, estoque_atual: e.target.value })
                  }
                  className="text-center font-bold"
                />
              </div>
              <div>
                <Input
                  label="Custo Unit (R$)"
                  type="number"
                  step="0.01"
                  value={formData.valor_custo}
                  onChange={(e) =>
                    setFormData({ ...formData, valor_custo: e.target.value })
                  }
                  className="text-right font-medium"
                />
              </div>
              <div>
                <Input
                  label="Margem (%)"
                  type="number"
                  step="0.5"
                  value={formData.margem_lucro}
                  onChange={(e) => handleRecalcSale(e.target.value)}
                  className="text-center font-medium"
                />
              </div>
              <div>
                <Input
                  label="Venda Unit (R$)"
                  type="number"
                  step="0.01"
                  value={formData.valor_venda}
                  onChange={(e) => handleRecalcMargin(e.target.value)}
                  className="text-right font-bold border-primary-200 bg-primary-50 text-primary-800"
                />
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="col-span-2">
                <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">
                  Descri√ß√£o / Aplica√ß√£o / Obs
                </label>
                <textarea
                  value={formData.descricao}
                  onChange={(e) =>
                    setFormData({ ...formData, descricao: e.target.value })
                  }
                  className="w-full p-3 rounded-lg border border-neutral-200 bg-neutral-50 focus:bg-white outline-none focus:border-primary-500 font-medium text-sm h-24 resize-none transition-all"
                  placeholder="Detalhes adicionais..."
                />
              </div>
            </div>

            <div className="flex justify-between items-center pt-2">
              <Button
                type="button"
                onClick={handleDelete}
                variant="danger"
                icon={Trash2}
              >
                Excluir Item
              </Button>

              <Button
                type="submit"
                variant="primary"
                icon={CheckCircle}
                className="px-8 shadow-lg shadow-primary-500/20"
              >
                Salvar Altera√ß√µes
              </Button>
            </div>
          </form>
        </Modal>
      )}
    </div>
  );
};



================================================================================
FILE PATH: client\src\pages\PessoaFisicaPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import type { IPessoaFisica } from '../types/backend';
import { PessoaFisicaForm } from '../components/forms/PessoaFisicaForm';
import { Modal } from '../components/ui/Modal';
import { Plus, Search, Trash2, Edit, UserCheck } from 'lucide-react';

export const PessoaFisicaPage = () => {
    const [pessoasFisicas, setPessoasFisicas] = useState<IPessoaFisica[]>([]);
    const [showModal, setShowModal] = useState(false);
    const [searchId, setSearchId] = useState('');
    const [editData, setEditData] = useState<IPessoaFisica | null>(null);

    useEffect(() => {
        loadPessoasFisicas();
    }, []);

    const loadPessoasFisicas = async () => {
        try {
            const response = await api.get('/pessoa-fisica');
            setPessoasFisicas(response.data);
        } catch (error) {
            alert('Erro ao carregar pessoas f√≠sicas');
        }
    };

    const handleSearch = async () => {
        try {
            const response = await api.get(`/pessoa-fisica/${searchId}`);
            setEditData(response.data);
        } catch (error) {
            alert('Pessoa F√≠sica n√£o encontrada');
            setEditData(null);
        }
    };

    const handleUpdate = async () => {
        if (!editData) return;
        try {
            await api.put(`/pessoa-fisica/${editData.id_pessoa_fisica}`, editData);
            alert('Pessoa F√≠sica atualizada!');
            loadPessoasFisicas();
        } catch (error) {
            alert('Erro ao atualizar pessoa f√≠sica');
        }
    };

    const handleDelete = async () => {
        if (!searchId) return;
        try {
            await api.delete(`/pessoa-fisica/${searchId}`);
            alert('Pessoa F√≠sica deletada!');
            loadPessoasFisicas();
            setEditData(null);
            setSearchId('');
        } catch (error) {
            alert('Erro ao deletar pessoa f√≠sica');
        }
    };

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-2xl font-bold text-slate-800">Pessoas F√≠sicas</h1>
                    <p className="text-slate-500">Especializa√ß√£o de Pessoa com CPF.</p>
                </div>
                <button 
                    onClick={() => setShowModal(true)}
                    className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-medium shadow-sm transition-all"
                >
                    <Plus size={20} />
                    Nova Pessoa F√≠sica
                </button>
            </div>

            {/* LIST */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">ID PF</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">ID Pessoa</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">CPF</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Cadastro</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {pessoasFisicas.map((pf) => (
                            <tr key={pf.id_pessoa_fisica} className="hover:bg-slate-50">
                                <td className="p-4 text-gray-500 font-mono">#{pf.id_pessoa_fisica}</td>
                                <td className="p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-blue-50 p-2 rounded-lg text-blue-600">
                                            <UserCheck size={18} />
                                        </div>
                                        <span className="font-medium text-slate-900">ID: {pf.id_pessoa}</span>
                                    </div>
                                </td>
                                <td className="p-4 font-mono text-slate-700">{pf.cpf || '-'}</td>
                                <td className="p-4 text-xs text-slate-500">
                                    {new Date(pf.dt_cadastro).toLocaleDateString('pt-BR')}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* MANAGE */}
            <div className="bg-white p-4 rounded-xl border border-gray-200">
                <h2 className="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Manuten√ß√£o (Por ID)</h2>
                <div className="flex gap-4 mb-4">
                    <input 
                        type="number" 
                        value={searchId} 
                        onChange={(e) => setSearchId(e.target.value)} 
                        placeholder="Digite o ID da Pessoa F√≠sica..." 
                        className="border p-2 rounded w-64"
                    />
                    <button onClick={handleSearch} className="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                        <Search size={18} /> Localizar
                    </button>
                    {searchId && <button onClick={handleDelete} className="flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200">
                        <Trash2 size={18} /> Excluir
                    </button>}
                </div>

                {editData && (
                    <div className="bg-slate-50 p-4 rounded border animate-in fade-in">
                        <h3 className="font-bold mb-2">Editando PF #{editData.id_pessoa_fisica}</h3>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label className="text-xs font-bold block mb-1">CPF</label>
                                <input 
                                    value={editData.cpf || ''} 
                                    onChange={(e) => setEditData({...editData, cpf: e.target.value})} 
                                    className="border p-2 w-full rounded" 
                                    maxLength={11}
                                />
                            </div>
                        </div>
                        <button onClick={handleUpdate} className="flex items-center gap-2 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">
                            <Edit size={18} /> Salvar Altera√ß√µes
                        </button>
                    </div>
                )}
            </div>

            {showModal && (
                <Modal title="Nova Pessoa F√≠sica" onClose={() => setShowModal(false)}>
                    <PessoaFisicaForm 
                        onSuccess={() => {
                            setShowModal(false);
                            loadPessoasFisicas();
                        }}
                        onCancel={() => setShowModal(false)}
                    />
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\PessoaJuridicaPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import type { IPessoaJuridica } from '../types/backend';
import { PessoaJuridicaForm } from '../components/forms/PessoaJuridicaForm';
import { Modal } from '../components/ui/Modal';
import { Plus, Search, Trash2, Edit, Building2 } from 'lucide-react';

export const PessoaJuridicaPage = () => {
    const [pessoasJuridicas, setPessoasJuridicas] = useState<IPessoaJuridica[]>([]);
    const [showModal, setShowModal] = useState(false);
    const [searchId, setSearchId] = useState('');
    const [editData, setEditData] = useState<IPessoaJuridica | null>(null);

    useEffect(() => {
        loadPessoasJuridicas();
    }, []);

    const loadPessoasJuridicas = async () => {
        try {
            const response = await api.get('/pessoa-juridica');
            setPessoasJuridicas(response.data);
        } catch (error) {
            alert('Erro ao carregar pessoas jur√≠dicas');
        }
    };

    const handleSearch = async () => {
        try {
            const response = await api.get(`/pessoa-juridica/${searchId}`);
            setEditData(response.data);
        } catch (error) {
            alert('Pessoa Jur√≠dica n√£o encontrada');
            setEditData(null);
        }
    };

    const handleUpdate = async () => {
        if (!editData) return;
        try {
            await api.put(`/pessoa-juridica/${editData.id_pessoa_juridica}`, editData);
            alert('Pessoa Jur√≠dica atualizada!');
            loadPessoasJuridicas();
        } catch (error) {
            alert('Erro ao atualizar pessoa jur√≠dica');
        }
    };

    const handleDelete = async () => {
        if (!searchId) return;
        try {
            await api.delete(`/pessoa-juridica/${searchId}`);
            alert('Pessoa Jur√≠dica deletada!');
            loadPessoasJuridicas();
            setEditData(null);
            setSearchId('');
        } catch (error) {
            alert('Erro ao deletar pessoa jur√≠dica');
        }
    };

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-2xl font-bold text-slate-800">Pessoas Jur√≠dicas</h1>
                    <p className="text-slate-500">Especializa√ß√£o de Pessoa com CNPJ.</p>
                </div>
                <button 
                    onClick={() => setShowModal(true)}
                    className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2.5 rounded-lg font-medium shadow-sm transition-all"
                >
                    <Plus size={20} />
                    Nova Pessoa Jur√≠dica
                </button>
            </div>

            {/* LIST */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">ID PJ</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Empresa</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">CNPJ</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">ID Pessoa</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Cadastro</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {pessoasJuridicas.map((pj) => (
                            <tr key={pj.id_pessoa_juridica} className="hover:bg-slate-50">
                                <td className="p-4 text-gray-500 font-mono">#{pj.id_pessoa_juridica}</td>
                                <td className="p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-purple-50 p-2 rounded-lg text-purple-600">
                                            <Building2 size={18} />
                                        </div>
                                        <div>
                                            <div className="font-medium text-slate-900">{pj.razao_social}</div>
                                            {pj.nome_fantasia && <div className="text-xs text-slate-500">{pj.nome_fantasia}</div>}
                                        </div>
                                    </div>
                                </td>
                                <td className="p-4 font-mono text-slate-700">{pj.cnpj || '-'}</td>
                                <td className="p-4 text-slate-600">ID: {pj.id_pessoa}</td>
                                <td className="p-4 text-xs text-slate-500">
                                    {new Date(pj.dt_cadastro).toLocaleDateString('pt-BR')}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* MANAGE */}
            <div className="bg-white p-4 rounded-xl border border-gray-200">
                <h2 className="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Manuten√ß√£o (Por ID)</h2>
                <div className="flex gap-4 mb-4">
                    <input 
                        type="number" 
                        value={searchId} 
                        onChange={(e) => setSearchId(e.target.value)} 
                        placeholder="Digite o ID da Pessoa Jur√≠dica..." 
                        className="border p-2 rounded w-64"
                    />
                    <button onClick={handleSearch} className="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                        <Search size={18} /> Localizar
                    </button>
                    {searchId && <button onClick={handleDelete} className="flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200">
                        <Trash2 size={18} /> Excluir
                    </button>}
                </div>

                {editData && (
                    <div className="bg-slate-50 p-4 rounded border animate-in fade-in">
                        <h3 className="font-bold mb-2">Editando: {editData.razao_social}</h3>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="col-span-2">
                                <label className="text-xs font-bold block mb-1">Raz√£o Social</label>
                                <input 
                                    value={editData.razao_social} 
                                    onChange={(e) => setEditData({...editData, razao_social: e.target.value})} 
                                    className="border p-2 w-full rounded" 
                                />
                            </div>
                            <div>
                                <label className="text-xs font-bold block mb-1">CNPJ</label>
                                <input 
                                    value={editData.cnpj || ''} 
                                    onChange={(e) => setEditData({...editData, cnpj: e.target.value})} 
                                    className="border p-2 w-full rounded" 
                                    maxLength={14}
                                />
                            </div>
                        </div>
                        <button onClick={handleUpdate} className="flex items-center gap-2 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">
                            <Edit size={18} /> Salvar Altera√ß√µes
                        </button>
                    </div>
                )}
            </div>

            {showModal && (
                <Modal title="Nova Pessoa Jur√≠dica" onClose={() => setShowModal(false)}>
                    <PessoaJuridicaForm 
                        onSuccess={() => {
                            setShowModal(false);
                            loadPessoasJuridicas();
                        }}
                        onCancel={() => setShowModal(false)}
                    />
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\PessoaPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import type { IPessoa } from '../types/backend';
import { PessoaForm } from '../components/forms/PessoaForm';
import { Modal } from '../components/ui/Modal';
import { Plus, Search, Trash2, Edit, User } from 'lucide-react';

export const PessoaPage = () => {
    const [pessoas, setPessoas] = useState<IPessoa[]>([]);
    const [showModal, setShowModal] = useState(false);
    const [searchId, setSearchId] = useState('');
    const [editData, setEditData] = useState<IPessoa | null>(null);

    useEffect(() => {
        loadPessoas();
    }, []);

    const loadPessoas = async () => {
        try {
            const response = await api.get('/pessoa');
            setPessoas(response.data);
        } catch (error) {
            alert('Erro ao carregar pessoas');
        }
    };

    const handleSearch = async () => {
        try {
            const response = await api.get(`/pessoa/${searchId}`);
            setEditData(response.data);
        } catch (error) {
            alert('Pessoa n√£o encontrada');
            setEditData(null);
        }
    };

    const handleUpdate = async () => {
        if (!editData) return;
        try {
            await api.put(`/pessoa/${editData.id_pessoa}`, editData);
            alert('Pessoa atualizada!');
            loadPessoas();
        } catch (error) {
            alert('Erro ao atualizar pessoa');
        }
    };

    const handleDelete = async () => {
        if (!searchId) return;
        try {
            await api.delete(`/pessoa/${searchId}`);
            alert('Pessoa deletada!');
            loadPessoas();
            setEditData(null);
            setSearchId('');
        } catch (error) {
            alert('Erro ao deletar pessoa');
        }
    };

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-2xl font-bold text-slate-800">Gerenciar Pessoas</h1>
                    <p className="text-slate-500">Cadastro base de pessoas (antes de PF/PJ).</p>
                </div>
                <button 
                    onClick={() => setShowModal(true)}
                    className="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2.5 rounded-lg font-medium shadow-sm transition-all"
                >
                    <Plus size={20} />
                    Nova Pessoa
                </button>
            </div>

            {/* LIST */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">ID</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Nome</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">G√™nero</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Data Nascimento</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Cadastro</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {pessoas.map((p) => (
                            <tr key={p.id_pessoa} className="hover:bg-slate-50">
                                <td className="p-4 text-gray-500 font-mono">#{p.id_pessoa}</td>
                                <td className="p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-blue-50 p-2 rounded-lg text-blue-600">
                                            <User size={18} />
                                        </div>
                                        <div className="font-medium text-slate-900">{p.nome}</div>
                                    </div>
                                </td>
                                <td className="p-4 text-slate-600">{p.genero || '-'}</td>
                                <td className="p-4 text-slate-600">
                                    {p.dt_nascimento ? new Date(p.dt_nascimento).toLocaleDateString('pt-BR') : '-'}
                                </td>
                                <td className="p-4 text-xs text-slate-500">
                                    {new Date(p.dt_cadastro).toLocaleDateString('pt-BR')}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* MANAGE */}
            <div className="bg-white p-4 rounded-xl border border-gray-200">
                <h2 className="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Manuten√ß√£o de Pessoa (Por ID)</h2>
                <div className="flex gap-4 mb-4">
                    <input 
                        type="number" 
                        value={searchId} 
                        onChange={(e) => setSearchId(e.target.value)} 
                        placeholder="Digite o ID da Pessoa..." 
                        className="border p-2 rounded w-64"
                    />
                    <button onClick={handleSearch} className="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                        <Search size={18} /> Localizar
                    </button>
                    {searchId && <button onClick={handleDelete} className="flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200">
                        <Trash2 size={18} /> Excluir
                    </button>}
                </div>

                {editData && (
                    <div className="bg-slate-50 p-4 rounded border animate-in fade-in">
                        <h3 className="font-bold mb-2">Editando: {editData.nome}</h3>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="col-span-2">
                                <label className="text-xs font-bold block mb-1">Nome</label>
                                <input 
                                    value={editData.nome} 
                                    onChange={(e) => setEditData({...editData, nome: e.target.value})} 
                                    className="border p-2 w-full rounded" 
                                />
                            </div>
                            <div>
                                <label className="text-xs font-bold block mb-1">G√™nero</label>
                                <select 
                                    value={editData.genero || ''} 
                                    onChange={(e) => setEditData({...editData, genero: e.target.value})} 
                                    className="border p-2 w-full rounded"
                                >
                                    <option value="">Selecione...</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Feminino">Feminino</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                        </div>
                        <button onClick={handleUpdate} className="flex items-center gap-2 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">
                            <Edit size={18} /> Salvar Altera√ß√µes
                        </button>
                    </div>
                )}
            </div>

            {showModal && (
                <Modal title="Nova Pessoa" onClose={() => setShowModal(false)}>
                    <PessoaForm 
                        onSuccess={() => {
                            setShowModal(false);
                            loadPessoas();
                        }}
                        onCancel={() => setShowModal(false)}
                    />
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\SearchClientePage.tsx
================================================================================
import { useState } from 'react';
import { api } from '../services/api';
import { Search, User, Car, Edit, Trash2, MapPin, Phone, Mail } from 'lucide-react';

interface ICliente {
    id_cliente: number;
    telefone_1: string;
    telefone_2?: string;
    email?: string;
    logradouro: string;
    nr_logradouro: string;
    compl_logradouro?: string;
    bairro: string;
    cidade: string;
    estado: string;
    pessoa_fisica?: {
        id_pessoa_fisica: number;
        cpf?: string;
        pessoa: {
            nome: string;
            genero?: string;
            dt_nascimento?: string;
        };
    };
    pessoa_juridica?: {
        id_pessoa_juridica: number;
        razao_social: string;
        nome_fantasia?: string;
        cnpj?: string;
    };
    veiculos?: IVeiculo[];
}

interface IVeiculo {
    id_veiculo: number;
    placa: string;
    marca: string;
    modelo: string;
    cor: string;
    ano_modelo?: string;
}

export const SearchClientePage = () => {
    const [searchTerm, setSearchTerm] = useState('');
    const [clientes, setClientes] = useState<ICliente[]>([]);
    const [selectedCliente, setSelectedCliente] = useState<ICliente | null>(null);
    const [loading, setLoading] = useState(false);

    const handleSearch = async () => {
        if (!searchTerm.trim()) {
            alert('Digite um nome para buscar');
            return;
        }

        setLoading(true);
        try {
            const response = await api.get(`/cliente/search?name=${searchTerm}`);
            setClientes(response.data);
            if (response.data.length === 0) {
                alert('Nenhum cliente encontrado');
            }
        } catch (error) {
            console.error(error);
            alert('Erro ao buscar clientes');
        } finally {
            setLoading(false);
        }
    };

    const loadClienteDetails = async (id: number) => {
        try {
            const response = await api.get(`/cliente/${id}`);
            setSelectedCliente(response.data);
        } catch (error) {
            alert('Erro ao carregar detalhes do cliente');
        }
    };

    const getNome = (cliente: ICliente) => {
        if (cliente.pessoa_fisica) {
            return cliente.pessoa_fisica.pessoa.nome;
        }
        if (cliente.pessoa_juridica) {
            return cliente.pessoa_juridica.razao_social;
        }
        return 'Nome n√£o dispon√≠vel';
    };

    return (
        <div className="space-y-6">
            <div>
                <h1 className="text-2xl font-bold text-slate-800">Pesquisar Cliente</h1>
                <p className="text-slate-500">Busque por nome (PF ou PJ)</p>
            </div>

            {/* SEARCH BAR */}
            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <div className="flex gap-4">
                    <input
                        type="text"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                        placeholder="Digite o nome do cliente... (ex: Jo√£o Silva, Tania, ACME Ltda)"
                        className="flex-1 border p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-primary-500 outline-none"
                    />
                    <button
                        onClick={handleSearch}
                        disabled={loading}
                        className="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-medium shadow-sm transition-all disabled:opacity-50"
                    >
                        <Search size={20} />
                        {loading ? 'Buscando...' : 'Buscar'}
                    </button>
                </div>
            </div>

            {/* RESULTS LIST */}
            {clientes.length > 0 && (
                <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div className="p-4 bg-slate-50 border-b">
                        <h2 className="font-bold text-slate-700">Resultados ({clientes.length})</h2>
                    </div>
                    <div className="divide-y">
                        {clientes.map((cliente) => (
                            <div
                                key={cliente.id_cliente}
                                onClick={() => loadClienteDetails(cliente.id_cliente)}
                                className="p-4 hover:bg-slate-50 cursor-pointer transition-colors"
                            >
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-primary-50 p-3 rounded-lg text-primary-600">
                                            <User size={20} />
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-slate-800">{getNome(cliente)}</h3>
                                            <p className="text-sm text-slate-500">
                                                {cliente.pessoa_fisica && `CPF: ${cliente.pessoa_fisica.cpf || 'N/A'}`}
                                                {cliente.pessoa_juridica && `CNPJ: ${cliente.pessoa_juridica.cnpj || 'N/A'}`}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-sm text-slate-600">{cliente.telefone_1}</p>
                                        <p className="text-xs text-slate-400">{cliente.cidade} - {cliente.estado}</p>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {/* SELECTED CLIENTE DETAILS */}
            {selectedCliente && (
                <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div className="bg-gradient-to-r from-primary-600 to-primary-700 p-6 text-white">
                        <div className="flex justify-between items-start">
                            <div>
                                <h2 className="text-2xl font-bold mb-1">{getNome(selectedCliente)}</h2>
                                <p className="text-primary-100">
                                    {selectedCliente.pessoa_fisica && `CPF: ${selectedCliente.pessoa_fisica.cpf || 'N√£o informado'}`}
                                    {selectedCliente.pessoa_juridica && `CNPJ: ${selectedCliente.pessoa_juridica.cnpj || 'N√£o informado'}`}
                                </p>
                            </div>
                            <div className="flex gap-2">
                                <button className="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors">
                                    <Edit size={20} />
                                </button>
                                <button className="bg-red-500/80 hover:bg-red-600 p-2 rounded-lg transition-colors">
                                    <Trash2 size={20} />
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="p-6 space-y-6">
                        {/* CONTACT INFO */}
                        <div>
                            <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <Phone size={18} className="text-primary-600" />
                                Contato
                            </h3>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs text-slate-500">Telefone Principal</label>
                                    <p className="font-medium">{selectedCliente.telefone_1}</p>
                                </div>
                                {selectedCliente.telefone_2 && (
                                    <div>
                                        <label className="text-xs text-slate-500">Telefone 2</label>
                                        <p className="font-medium">{selectedCliente.telefone_2}</p>
                                    </div>
                                )}
                                {selectedCliente.email && (
                                    <div className="col-span-2">
                                        <label className="text-xs text-slate-500 flex items-center gap-1">
                                            <Mail size={14} /> Email
                                        </label>
                                        <p className="font-medium">{selectedCliente.email}</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* ADDRESS */}
                        <div>
                            <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <MapPin size={18} className="text-primary-600" />
                                Endere√ßo
                            </h3>
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <p className="font-medium">
                                    {selectedCliente.logradouro}, {selectedCliente.nr_logradouro}
                                    {selectedCliente.compl_logradouro && ` - ${selectedCliente.compl_logradouro}`}
                                </p>
                                <p className="text-slate-600">
                                    {selectedCliente.bairro} - {selectedCliente.cidade}/{selectedCliente.estado}
                                </p>
                            </div>
                        </div>

                        {/* VEHICLES */}
                        {selectedCliente.veiculos && selectedCliente.veiculos.length > 0 && (
                            <div>
                                <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
                                    <Car size={18} className="text-primary-600" />
                                    Ve√≠culos ({selectedCliente.veiculos.length})
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {selectedCliente.veiculos.map((veiculo) => (
                                        <div key={veiculo.id_veiculo} className="border border-slate-200 p-4 rounded-lg hover:border-primary-300 transition-colors">
                                            <div className="flex items-center gap-3">
                                                <div className="bg-slate-100 p-2 rounded">
                                                    <Car size={20} className="text-slate-600" />
                                                </div>
                                                <div>
                                                    <p className="font-bold text-slate-800">{veiculo.placa}</p>
                                                    <p className="text-sm text-slate-600">{veiculo.marca} {veiculo.modelo}</p>
                                                    <p className="text-xs text-slate-500">{veiculo.cor} ‚Ä¢ {veiculo.ano_modelo || 'Ano N/A'}</p>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\SearchVeiculoPage.tsx
================================================================================
import { useState } from 'react';
import { api } from '../services/api';
import { Search, Car, User, Edit, Trash2, MapPin, Phone } from 'lucide-react';
import { normalizePlate } from '../utils/normalize';

interface IVeiculo {
    id_veiculo: number;
    placa: string;
    marca: string;
    modelo: string;
    cor: string;
    ano_modelo?: string;
    combustivel?: string;
    chassi?: string;
    cliente: {
        id_cliente: number;
        telefone_1: string;
        email?: string;
        logradouro: string;
        nr_logradouro: string;
        bairro: string;
        cidade: string;
        estado: string;
        pessoa_fisica?: {
            pessoa: {
                nome: string;
            };
            cpf?: string;
        };
        pessoa_juridica?: {
            pessoa: {
                nome: string;
            };
            cnpj?: string;
        };
    };
}

export const SearchVeiculoPage = () => {
    const [searchPlaca, setSearchPlaca] = useState('');
    const [veiculo, setVeiculo] = useState<IVeiculo | null>(null);
    const [loading, setLoading] = useState(false);

    const handleSearch = async () => {
        if (!searchPlaca.trim()) {
            alert('Digite uma placa para buscar');
            return;
        }

        setLoading(true);
        try {
            // Normalize plate before searching
            const normalized = normalizePlate(searchPlaca);
            const response = await api.get(`/veiculo/placa/${normalized}`);
            setVeiculo(response.data);
        } catch (error) {
            console.error(error);
            alert('Ve√≠culo n√£o encontrado');
            setVeiculo(null);
        } finally {
            setLoading(false);
        }
    };

    const getClienteNome = (cliente: IVeiculo['cliente']) => {
        if (cliente.pessoa_fisica) {
            return cliente.pessoa_fisica.pessoa.nome;
        }
        if (cliente.pessoa_juridica) {
            return cliente.pessoa_juridica.pessoa.nome;
        }
        return 'Nome n√£o dispon√≠vel';
    };

    return (
        <div className="space-y-6">
            <div>
                <h1 className="text-2xl font-bold text-slate-800">Pesquisar Ve√≠culo</h1>
                <p className="text-slate-500">Busque pela placa (com ou sem h√≠fen)</p>
            </div>

            {/* SEARCH BAR */}
            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <div className="flex gap-4">
                    <input
                        type="text"
                        value={searchPlaca}
                        onChange={(e) => setSearchPlaca(e.target.value.toUpperCase())}
                        onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                        placeholder="Digite a placa... (ex: GIN1175 ou GIN-1175)"
                        className="flex-1 border p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-primary-500 outline-none font-mono text-lg tracking-wider"
                        maxLength={8}
                    />
                    <button
                        onClick={handleSearch}
                        disabled={loading}
                        className="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-medium shadow-sm transition-all disabled:opacity-50"
                    >
                        <Search size={20} />
                        {loading ? 'Buscando...' : 'Buscar'}
                    </button>
                </div>
                <p className="text-xs text-slate-400 mt-2">
                    üí° Dica: Voc√™ pode digitar com ou sem h√≠fen (GIN1175 = GIN-1175)
                </p>
            </div>

            {/* VEHICLE DETAILS */}
            {veiculo && (
                <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div className="bg-gradient-to-r from-blue-600 to-blue-700 p-6 text-white">
                        <div className="flex justify-between items-start">
                            <div>
                                <div className="flex items-center gap-3 mb-2">
                                    <Car size={32} />
                                    <h2 className="text-3xl font-bold font-mono tracking-wider">{veiculo.placa}</h2>
                                </div>
                                <p className="text-blue-100 text-lg">{veiculo.marca} {veiculo.modelo}</p>
                                <p className="text-blue-200 text-sm">{veiculo.cor} ‚Ä¢ {veiculo.ano_modelo || 'Ano N/A'}</p>
                            </div>
                            <div className="flex gap-2">
                                <button className="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors">
                                    <Edit size={20} />
                                </button>
                                <button className="bg-red-500/80 hover:bg-red-600 p-2 rounded-lg transition-colors">
                                    <Trash2 size={20} />
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="p-6 space-y-6">
                        {/* VEHICLE INFO */}
                        <div>
                            <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <Car size={18} className="text-blue-600" />
                                Informa√ß√µes do Ve√≠culo
                            </h3>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="text-xs text-slate-500">Marca</label>
                                    <p className="font-medium">{veiculo.marca}</p>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-500">Modelo</label>
                                    <p className="font-medium">{veiculo.modelo}</p>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-500">Cor</label>
                                    <p className="font-medium">{veiculo.cor}</p>
                                </div>
                                {veiculo.ano_modelo && (
                                    <div>
                                        <label className="text-xs text-slate-500">Ano/Modelo</label>
                                        <p className="font-medium">{veiculo.ano_modelo}</p>
                                    </div>
                                )}
                                {veiculo.combustivel && (
                                    <div>
                                        <label className="text-xs text-slate-500">Combust√≠vel</label>
                                        <p className="font-medium">{veiculo.combustivel}</p>
                                    </div>
                                )}
                                {veiculo.chassi && (
                                    <div className="col-span-2">
                                        <label className="text-xs text-slate-500">Chassi</label>
                                        <p className="font-medium font-mono text-sm">{veiculo.chassi}</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* OWNER INFO */}
                        <div className="border-t pt-6">
                            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <User size={18} className="text-primary-600" />
                                Propriet√°rio
                            </h3>
                            
                            <div className="bg-primary-50 p-5 rounded-lg border border-primary-100">
                                <div className="flex items-start justify-between mb-4">
                                    <div>
                                        <h4 className="text-xl font-bold text-slate-800 mb-1">
                                            {getClienteNome(veiculo.cliente)}
                                        </h4>
                                        <p className="text-sm text-slate-600">
                                            {veiculo.cliente.pessoa_fisica && `CPF: ${veiculo.cliente.pessoa_fisica.cpf || 'N√£o informado'}`}
                                            {veiculo.cliente.pessoa_juridica && `CNPJ: ${veiculo.cliente.pessoa_juridica.cnpj || 'N√£o informado'}`}
                                        </p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs text-slate-500 flex items-center gap-1 mb-1">
                                            <Phone size={12} /> Telefone
                                        </label>
                                        <p className="font-medium text-slate-800">{veiculo.cliente.telefone_1}</p>
                                    </div>
                                    {veiculo.cliente.email && (
                                        <div>
                                            <label className="text-xs text-slate-500 mb-1 block">Email</label>
                                            <p className="font-medium text-slate-800">{veiculo.cliente.email}</p>
                                        </div>
                                    )}
                                    <div className="col-span-2">
                                        <label className="text-xs text-slate-500 flex items-center gap-1 mb-1">
                                            <MapPin size={12} /> Endere√ßo
                                        </label>
                                        <p className="font-medium text-slate-800">
                                            {veiculo.cliente.logradouro}, {veiculo.cliente.nr_logradouro}
                                        </p>
                                        <p className="text-sm text-slate-600">
                                            {veiculo.cliente.bairro} - {veiculo.cliente.cidade}/{veiculo.cliente.estado}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\TipoPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import type { ITipo } from '../types/backend';
import { TipoForm } from '../components/forms/TipoForm';
import { Modal } from '../components/ui/Modal';
import { Plus, Search, Trash2, Edit, Tag } from 'lucide-react';

export const TipoPage = () => {
    const [tipos, setTipos] = useState<ITipo[]>([]);
    const [showModal, setShowModal] = useState(false);
    const [searchId, setSearchId] = useState('');
    const [editData, setEditData] = useState<ITipo | null>(null);

    useEffect(() => {
        loadTipos();
    }, []);

    const loadTipos = async () => {
        try {
            const response = await api.get('/tipo');
            setTipos(response.data);
        } catch (error) {
            alert('Erro ao carregar tipos');
        }
    };

    const handleSearch = async () => {
        try {
            const response = await api.get(`/tipo/${searchId}`);
            setEditData(response.data);
        } catch (error) {
            alert('Tipo n√£o encontrado');
            setEditData(null);
        }
    };

    const handleUpdate = async () => {
        if (!editData) return;
        try {
            await api.put(`/tipo/${editData.id_tipo}`, editData);
            alert('Tipo atualizado!');
            loadTipos();
        } catch (error) {
            alert('Erro ao atualizar tipo');
        }
    };

    const handleDelete = async () => {
        if (!searchId) return;
        try {
            await api.delete(`/tipo/${searchId}`);
            alert('Tipo deletado!');
            loadTipos();
            setEditData(null);
            setSearchId('');
        } catch (error) {
            alert('Erro ao deletar tipo');
        }
    };

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-2xl font-bold text-slate-800">Tipos / Fun√ß√µes</h1>
                    <p className="text-slate-500">Categorias e fun√ß√µes de pessoas/empresas.</p>
                </div>
                <button 
                    onClick={() => setShowModal(true)}
                    className="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2.5 rounded-lg font-medium shadow-sm transition-all"
                >
                    <Plus size={20} />
                    Novo Tipo
                </button>
            </div>

            {/* LIST */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">ID</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Fun√ß√£o</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Cadastro</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {tipos.map((t) => (
                            <tr key={t.id_tipo} className="hover:bg-slate-50">
                                <td className="p-4 text-gray-500 font-mono">#{t.id_tipo}</td>
                                <td className="p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-green-50 p-2 rounded-lg text-green-600">
                                            <Tag size={18} />
                                        </div>
                                        <span className="font-medium text-slate-900">{t.funcao || 'Sem fun√ß√£o definida'}</span>
                                    </div>
                                </td>
                                <td className="p-4 text-xs text-slate-500">
                                    {new Date(t.dt_cadastro).toLocaleDateString('pt-BR')}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* MANAGE */}
            <div className="bg-white p-4 rounded-xl border border-gray-200">
                <h2 className="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Manuten√ß√£o de Tipo (Por ID)</h2>
                <div className="flex gap-4 mb-4">
                    <input 
                        type="number" 
                        value={searchId} 
                        onChange={(e) => setSearchId(e.target.value)} 
                        placeholder="Digite o ID do Tipo..." 
                        className="border p-2 rounded w-64"
                    />
                    <button onClick={handleSearch} className="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                        <Search size={18} /> Localizar
                    </button>
                    {searchId && <button onClick={handleDelete} className="flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200">
                        <Trash2 size={18} /> Excluir
                    </button>}
                </div>

                {editData && (
                    <div className="bg-slate-50 p-4 rounded border animate-in fade-in">
                        <h3 className="font-bold mb-2">Editando Tipo #{editData.id_tipo}</h3>
                        <div className="mb-4">
                            <label className="text-xs font-bold block mb-1">Fun√ß√£o</label>
                            <input 
                                value={editData.funcao || ''} 
                                onChange={(e) => setEditData({...editData, funcao: e.target.value})} 
                                className="border p-2 w-full rounded" 
                            />
                        </div>
                        <button onClick={handleUpdate} className="flex items-center gap-2 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">
                            <Edit size={18} /> Salvar Altera√ß√µes
                        </button>
                    </div>
                )}
            </div>

            {showModal && (
                <Modal title="Novo Tipo" onClose={() => setShowModal(false)}>
                    <TipoForm 
                        onSuccess={() => {
                            setShowModal(false);
                            loadTipos();
                        }}
                        onCancel={() => setShowModal(false)}
                    />
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\VeiculoPage.tsx
================================================================================
import { useState, useEffect, useRef } from "react";
import { useNavigate } from "react-router-dom";
import { api } from "../services/api";
import type { IVeiculo } from "../types/backend";
import { ClienteForm } from "../components/forms/ClienteForm";
import { VeiculoForm } from "../components/forms/VeiculoForm";
import { Modal } from "../components/ui/Modal";
import { Plus, Search, Trash2, Edit, Car, Wrench } from "lucide-react";
import { StatusBanner } from "../components/ui/StatusBanner";
import { ActionButton } from "../components/ui/ActionButton";
import { Input } from "../components/ui/input";

export const VeiculoPage = () => {
  const navigate = useNavigate();
  const [veiculos, setVeiculos] = useState<IVeiculo[]>([]);
  const [showModal, setShowModal] = useState(false);
  const [modalMode, setModalMode] = useState<"vehicle" | "client">("vehicle");
  const [searchTerm, setSearchTerm] = useState("");
  const [editingVehicle, setEditingVehicle] = useState<IVeiculo | undefined>(
    undefined,
  );
  const [selectedClientId, setSelectedClientId] = useState<number | null>(null);
  const [statusMsg, setStatusMsg] = useState<{
    type: "success" | "error" | null;
    text: string;
  }>({ type: null, text: "" });
  const [confirmModal, setConfirmModal] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    onConfirm: () => void;
  }>({ isOpen: false, title: "", message: "", onConfirm: () => {} });
  const [activeIndex, setActiveIndex] = useState(-1);
  const searchInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if (searchInputRef.current) searchInputRef.current.focus();
  }, []);

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (filteredVeiculos.length === 0) return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      setActiveIndex((prev) =>
        prev + 1 >= filteredVeiculos.length ? 0 : prev + 1,
      );
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      setActiveIndex((prev) =>
        prev - 1 < 0 ? filteredVeiculos.length - 1 : prev - 1,
      );
    } else if (e.key === "Enter") {
      if (activeIndex !== -1) {
        e.preventDefault();
        openEditModal(filteredVeiculos[activeIndex]);
      }
    } else if (e.key === "Escape") {
      setSearchTerm("");
      setActiveIndex(-1);
    }
  };

  useEffect(() => {
    setActiveIndex(-1);
  }, [searchTerm]);

  useEffect(() => {
    loadVeiculos();
  }, []);

  const loadVeiculos = async () => {
    try {
      const response = await api.get("/veiculo");
      setVeiculos(response.data);
    } catch (error) {
      console.error(error);
      // alert('Erro ao carregar ve√≠culos'); // Suppress initial load error alert to avoid noise if empty
    }
  };

  const handleDelete = (id: number) => {
    setConfirmModal({
      isOpen: true,
      title: "Excluir Ve√≠culo",
      message: "Tem certeza que deseja excluir este ve√≠culo?",
      onConfirm: async () => {
        try {
          await api.delete(`/veiculo/${id}`);
          setStatusMsg({
            type: "success",
            text: "Ve√≠culo removido com sucesso!",
          });
          setTimeout(() => setStatusMsg({ type: null, text: "" }), 3000);
          loadVeiculos();
        } catch (error) {
          setStatusMsg({
            type: "error",
            text: "Erro ao deletar ve√≠culo. Verifique se h√° O.S. vinculadas.",
          });
        }
        setConfirmModal((prev) => ({ ...prev, isOpen: false }));
      },
    });
  };

  const openCreateModal = () => {
    navigate("/novo-cadastro");
  };

  const openEditModal = (vehicle: IVeiculo) => {
    setModalMode("vehicle");
    setEditingVehicle(vehicle);
    setSelectedClientId(null); // Not needed for edit usually, or implicitly part of vehicle
    setShowModal(true);
  };

  const filteredVeiculos = veiculos.filter(
    (v) =>
      v.placa.toLowerCase().includes(searchTerm.toLowerCase()) ||
      v.modelo.toLowerCase().includes(searchTerm.toLowerCase()) ||
      v.marca.toLowerCase().includes(searchTerm.toLowerCase()),
  );

  return (
    <div className="w-full max-w-[1440px] mx-auto px-4 md:px-8 py-6 space-y-6">
      {/* Header da P√°gina */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl font-bold text-neutral-500">
            Gerenciar Ve√≠culos
          </h1>
          <p className="text-neutral-500">
            Cadastro e manuten√ß√£o da frota de ve√≠culos.
          </p>
        </div>
        <button
          onClick={openCreateModal}
          className="flex items-center gap-2 bg-primary-900 hover:bg-primary-800 hover:scale-105 transition-all shadow-xl shadow-primary-500/20 text-white px-4 py-2.5 rounded-lg font-medium transition-all shadow-sm"
        >
          <Plus size={20} />
          Novo Ve√≠culo
        </button>
      </div>

      {/* Barra de Filtros */}
      <div className="bg-surface p-4 rounded-xl shadow-sm border border-neutral-200 flex gap-4">
        <Input
          variant="default"
          ref={searchInputRef}
          icon={Search}
          placeholder="Buscar por fabricante, modelo ou placa"
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          onKeyDown={handleKeyDown}
        />
      </div>

      {/* Tabela */}
      <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden">
        <div>
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-neutral-50 border-b border-neutral-200 text-xs uppercase tracking-wider text-neutral-500 font-semibold">
                <th className="p-4">Ve√≠culo</th>
                <th className="p-4">Placa</th>
                <th className="p-4">Cliente</th>
                <th className="p-4">A√ß√µes</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-neutral-100">
              {filteredVeiculos.map((v, idx) => (
                <tr
                  key={v.id_veiculo}
                  className={`transition-colors hover:bg-neutral-25 ${
                    idx === activeIndex
                      ? "bg-primary-50 ring-2 ring-primary-500 ring-inset"
                      : ""
                  }`}
                >
                  <td className="p-4">
                    <div className="flex items-center gap-3">
                      <div className="bg-primary-50 p-2 rounded-lg text-primary-600">
                        <Car size={18} />
                      </div>
                      <div className="font-bold text-neutral-700 tracking-tight text-sm uppercase">
                        {v.marca} {v.modelo} - {v.cor}
                      </div>
                    </div>
                  </td>
                  <td className="p-4 font-mono font-bold text-primary-500">
                    {v.placa}{" "}
                  </td>
                  <td className="p-4">
                    <div className="flex flex-col">
                      <span className="font-bold text-neutral-500">
                        {(v.cliente as any)?.pessoa_fisica?.pessoa?.nome ||
                          (v.cliente as any)?.pessoa_juridica?.nome_fantasia ||
                          "Cliente n√£o identificado"}
                      </span>
                      <span className="text-xs text-neutral-500">
                        {(v.cliente as any)?.pessoa_fisica?.pessoa?.telefone ||
                          (v.cliente as any)?.pessoa_juridica?.pessoa
                            ?.telefone ||
                          ""}
                      </span>
                    </div>
                  </td>
                  <td className="p-4">
                    <div className="flex gap-1 justify-end">
                      <ActionButton
                        icon={Edit}
                        label="Editar"
                        variant="neutral"
                        onClick={() => openEditModal(v)}
                      />
                      <ActionButton
                        icon={Wrench}
                        label="Abrir OS"
                        variant="accent"
                        onClick={() =>
                          navigate(
                            `/ordem-de-servico?clientId=${v.id_cliente}&vehicleId=${v.id_veiculo}`,
                          )
                        }
                      />
                      <ActionButton
                        icon={Trash2}
                        label="Excluir"
                        variant="danger"
                        onClick={() => handleDelete(v.id_veiculo)}
                      />
                    </div>
                  </td>
                </tr>
              ))}
              {filteredVeiculos.length === 0 && (
                <tr>
                  <td colSpan={5} className="p-8 text-center text-neutral-400">
                    Nenhum ve√≠culo encontrado.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>

      {showModal && (
        <Modal
          title={
            modalMode === "client"
              ? "Novo Cliente"
              : editingVehicle
                ? "Editar Ve√≠culo"
                : "Novo Ve√≠culo"
          }
          onClose={() => setShowModal(false)}
        >
          {modalMode === "vehicle" ? (
            <VeiculoForm
              clientId={selectedClientId}
              vehicleId={editingVehicle?.id_veiculo}
              initialData={editingVehicle}
              onSuccess={() => {
                setShowModal(false);
                loadVeiculos();
              }}
              onCancel={() => setShowModal(false)}
              onCreateClient={() => setModalMode("client")}
            />
          ) : (
            <ClienteForm
              onSuccess={(newClient) => {
                setSelectedClientId(newClient.id_cliente);
                setModalMode("vehicle");
              }}
              onCancel={() => setModalMode("vehicle")}
            />
          )}
        </Modal>
      )}

      {/* Confirmation Modal */}
      {confirmModal.isOpen && (
        <Modal
          title={confirmModal.title}
          onClose={() =>
            setConfirmModal((prev) => ({ ...prev, isOpen: false }))
          }
        >
          <div className="space-y-6">
            <p className="text-neutral-600 font-medium">
              {confirmModal.message}
            </p>
            <div className="flex justify-end gap-3 pt-2">
              <button
                onClick={() =>
                  setConfirmModal((prev) => ({ ...prev, isOpen: false }))
                }
                className="px-5 py-2.5 text-neutral-600 font-bold hover:bg-neutral-100 rounded-lg transition-colors"
              >
                Cancelar
              </button>
              <button
                onClick={confirmModal.onConfirm}
                className="px-5 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors shadow-lg shadow-red-500/30"
              >
                Confirmar
              </button>
            </div>
          </div>
        </Modal>
      )}
      <div className="fixed bottom-8 right-8 z-100 min-w-[320px]">
        <StatusBanner
          msg={statusMsg}
          onClose={() => setStatusMsg({ type: null, text: "" })}
        />
      </div>
    </div>
  );
};



================================================================================
FILE PATH: client\src\services\api.ts
================================================================================
import axios from 'axios';

export const api = axios.create({
  baseURL: 'http://localhost:3000/api',
});



================================================================================
FILE PATH: client\src\types\backend.d.ts
================================================================================
export interface IPessoa {
    id_pessoa: number;
    nome: string;
    genero?: string | null;
    dt_nascimento?: string | null; // Date sent as string
    obs?: string | null;
    dt_cadastro: string;
}

export interface IPessoaFisica {
    id_pessoa_fisica: number;
    id_pessoa: number;
    cpf?: string | null;
    dt_cadastro: string;
}

export interface IPessoaJuridica {
    id_pessoa_juridica: number;
    id_pessoa: number;
    razao_social: string;
    nome_fantasia?: string | null;
    cnpj?: string | null;
    inscricao_estadual?: string | null;
    dt_cadastro: string;
}

export interface ITipo {
    id_tipo: number;
    funcao?: string | null;
    dt_cadastro: string;
}

export interface ICliente {
    id_cliente: number;
    id_pessoa_fisica?: number | null;
    id_pessoa_juridica?: number | null;
    tipo_pessoa: number;
    telefone_1: string;
    telefone_2?: string | null;
    telefone_3?: string | null;
    email?: string | null;
    logradouro: string;
    nr_logradouro: string;
    compl_logradouro?: string | null;
    bairro: string;
    cidade: string;
    estado: string;
    dt_cadastro: string;

    // Optional Joins
    pessoa_fisica?: IPessoaFisica & { pessoa: IPessoa };
    pessoa_juridica?: IPessoaJuridica & { pessoa: IPessoa };
    veiculos?: IVeiculo[];
}

export interface IFuncionario {
    id_funcionario: number;
    id_pessoa_fisica: number;
    ativo: string;
    cargo: string;
    
    // Antigos
    salario?: number | null;
    comissao?: number | null; // M√£o de Obra
    
    dt_admissao: string;
    dt_recisao?: string | null;
    motivo_saida?: string | null;
    obs?: string | null;
    dt_cadastro: string;
    
    // MEI / Identifica√ß√£o
    razao_social?: string | null;
    nome_fantasia?: string | null;
    cnpj_mei?: string | null;
    inscricao_municipal?: string | null;

    // Dados Pessoais / Endere√ßo
    rg?: string | null;
    cep?: string | null;
    logradouro?: string | null;
    numero?: string | null;
    complemento?: string | null;
    bairro?: string | null;
    cidade?: string | null;
    uf?: string | null;
    telefone_pessoal?: string | null;
    email_pessoal?: string | null;

    // Operacional / Financeiro Extra
    especialidade?: string | null;
    tipo_pagamento?: string | null;
    valor_pagamento?: number | null;
    comissao_pecas?: number | null;

    banco?: string | null;
    agencia?: string | null;
    conta?: string | null;
    chave_pix?: string | null;
    periodicidade_pagamento?: string | null;
    dia_vencimento?: number | null;

    // Docs
    url_ccmei?: string | null;
    url_cnh?: string | null;
    equipamentos_epis?: string | null;

    // Optional Joins
    pessoa_fisica?: IPessoaFisica & { pessoa: IPessoa };
}

export interface IPecasEstoque {
    id_pecas_estoque: number;
    fabricante?: string | null;
    nome: string;
    descricao: string;
    valor_custo: number; // Decimal
    valor_venda: number; // Decimal
    estoque_atual: number;
    unidade_medida?: string | null;
    custo_unitario_padrao: number; // Decimal
    dt_ultima_compra?: string | null;
    dt_cadastro: string;
}

export interface IVeiculo {
    id_veiculo: number;
    id_cliente: number;
    placa: string;
    chassi?: string | null;
    marca: string;
    modelo: string;
    versao?: string | null;
    ano_modelo: string;
    cor: string;
    combustivel: string;
    obs?: string | null;
    dt_cadastro: string;

    // Optional Joins
    cliente?: ICliente;
}

export interface IOrdemDeServico {
    id_os: number;
    id_cliente: number;
    id_veiculo: number;
    id_funcionario: number;
    dt_abertura: string;
    dt_entrega?: string | null;
    km_entrada: number;
    status: string;
    defeito_relatado?: string | null;
    diagnostico?: string | null;
    valor_servico?: number | null;
    valor_pecas?: number | null;
    valor_final?: number | null;
    
    valor_total_cliente?: number | null;
    valor_mao_de_obra?: number | null;

    modo_pagamento?: string | null;
    cod_pagamento?: string | null;
    parcelas: number;
    obs?: string | null;
    obs_final?: string | null;
    dt_cadastro: string;
    
    // Optional Joins
    cliente?: ICliente;
    veiculo?: IVeiculo;
    itens_os?: IItensOs[];
    pagamentos_cliente?: IPagamentoCliente[];
    funcionario?: IFuncionario;
    fechamento_financeiro?: IFechamentoFinanceiro;
    servicos_mao_de_obra?: IServicoMaoDeObra[];
}

export interface IServicoMaoDeObra {
    id_servico_mao_de_obra: number;
    id_os: number;
    id_funcionario: number;
    valor: number;
    descricao?: string | null;
    dt_cadastro: string;

    // Optional Joins
    funcionario?: IFuncionario;
}

export interface IPagamentoCliente {
    id_pagamento_cliente: number;
    id_os: number;
    metodo_pagamento: string;
    valor: number;
    data_pagamento: string;
    bandeira_cartao?: string | null;
    codigo_transacao?: string | null;
    qtd_parcelas: number;
    deleted_at?: string | null;

    id_operadora?: number | null;
    operadora?: IOperadoraCartao;
    id_conta_bancaria?: number | null;
    conta_bancaria?: IContaBancaria;
}

export interface IItensOs {
    id_iten: number;
    id_os: number;
    id_pecas_estoque?: number | null;
    descricao: string;
    codigo_referencia?: string | null;
    quantidade: number;
    valor_venda: number;
    valor_total: number;
    dt_cadastro: string;
}

export interface IFechamentoFinanceiro {
    id_fechamento_financeiro: number;
    id_os: number;
    custo_total_pecas_real: number;
    data_fechamento_financeiro: string;
}

export interface IFornecedor {
    id_fornecedor: number;
    // Identifica√ß√£o
    tipo_pessoa?: string | null;
    nome: string;
    nome_fantasia?: string | null;
    documento?: string | null;
    inscricao_estadual?: string | null;
    inscricao_municipal?: string | null;

    // Contato
    contato?: string | null;
    telefone?: string | null;
    whatsapp?: string | null;
    email?: string | null;

    // Endere√ßo
    cep?: string | null;
    logradouro?: string | null;
    numero?: string | null;
    complemento?: string | null;
    bairro?: string | null;
    cidade?: string | null;
    uf?: string | null;

    // Financeiro
    banco?: string | null;
    agencia?: string | null;
    conta?: string | null;
    chave_pix?: string | null;
    condicoes_pagamento?: string | null;
    categoria_produto?: string | null;

    obs?: string | null;
    dt_cadastro: string;
}

export interface IPagamentoPeca {
    id_pagamento_peca: number;
    id_item_os: number;
    id_fornecedor: number;
    custo_real: number;
    data_compra: string;
    data_pagamento_fornecedor?: string | null;
    pago_ao_fornecedor: boolean;
}

export interface IContasPagar {
    id_conta_pagar: number;
    descricao: string;
    valor: number;
    dt_vencimento: string;
    dt_pagamento?: string | null;
    status: string;
    categoria?: string | null;
    
    // New
    credor?: string | null;
    dt_emissao?: string | null;
    num_documento?: string | null;
    forma_pagamento?: string | null;
    url_anexo?: string | null;
    
    obs?: string | null;
    dt_cadastro: string;
}

// ---------------------------------------------------------
// INTELIG√äNCIA FINANCEIRA
// ---------------------------------------------------------

export interface IContaBancaria {
    id_conta: number;
    nome: string;
    banco?: string | null;
    agencia?: string | null;
    conta?: string | null;
    saldo_atual: number;
    ativo: boolean;
    dt_cadastro: string;
}

export interface IOperadoraCartao {
    id_operadora: number;
    nome: string;
    
    taxa_debito: number;
    prazo_debito: number;

    taxa_credito_vista: number;
    prazo_credito_vista: number;

    taxa_credito_parc: number;
    prazo_credito_parc: number;

    taxa_antecipacao: number;
    antecipacao_auto: boolean;

    id_conta_destino: number;
    conta_destino?: IContaBancaria;
}

export interface IRecebivelCartao {
    id_recebivel: number;
    id_os?: number | null;
    id_operadora: number;
    
    num_parcela: number;
    total_parcelas: number;
    
    valor_bruto: number;
    valor_liquido: number;
    taxa_aplicada: number;
    
    data_venda: string;
    data_prevista: string;
    data_recebimento?: string | null;
    
    status: string; // 'PENDENTE', 'RECEBIDO'
    
    operadora?: IOperadoraCartao;
    ordem_de_servico?: IOrdemDeServico;
}

export interface ILivroCaixa {
    id_livro_caixa: number;
    descricao: string;
    valor: number; // Decimal string in UI usually, but number here
    tipo_movimentacao: string; // 'ENTRADA' | 'SAIDA'
    categoria: string;
    dt_movimentacao: string;
    obs?: string | null;
    origem: string;
    id_conta_bancaria?: number | null;
    conta?: IContaBancaria;
}



================================================================================
FILE PATH: client\src\utils\formatCurrency.ts
================================================================================
export const formatCurrency = (
  value: number | string | undefined | null,
): string => {
  if (value === undefined || value === null || value === "") return "R$ 0,00";
  const numberValue = Number(value);
  if (isNaN(numberValue)) return "R$ 0,00";

  return numberValue.toLocaleString("pt-BR", {
    style: "currency",
    currency: "BRL",
  });
};



================================================================================
FILE PATH: client\src\utils\normalize.ts
================================================================================
// Utility functions for data normalization and search

/**
 * Normaliza uma placa de ve√≠culo removendo h√≠fens e convertendo para mai√∫sculas
 * Exemplos: "GIN-1175" -> "GIN1175", "gin1175" -> "GIN1175"
 */
export const normalizePlate = (plate: string): string => {
  return plate.replace(/-/g, '').toUpperCase().trim();
};

/**
 * Normaliza um nome para busca case-insensitive
 * Remove espa√ßos extras e converte para mai√∫sculas
 * Exemplos: "Tania" -> "TANIA", "  jo√£o silva  " -> "JO√ÉO SILVA"
 */
export const normalizeName = (name: string): string => {
  return name.trim().toUpperCase();
};

/**
 * Formata um nome seguindo o padr√£o Title Case (primeira letra mai√∫scula)
 * Exemplo: "JO√ÉO SILVA" -> "Jo√£o Silva", "tania" -> "Tania"
 */
export const formatNameTitleCase = (name: string): string => {
  return name
    .toLowerCase()
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
};

/**
 * Formata uma placa no padr√£o brasileiro (XXX-0000 ou XXX0X00)
 * Exemplo: "GIN1175" -> "GIN-1175"
 */
export const formatPlate = (plate: string): string => {
  const normalized = normalizePlate(plate);
  if (normalized.length === 7) {
    return `${normalized.slice(0, 3)}-${normalized.slice(3)}`;
  }
  return normalized;
};

/**
 * Compara duas strings de forma case-insensitive
 */
export const caseInsensitiveMatch = (str1: string, str2: string): boolean => {
  return str1.toUpperCase() === str2.toUpperCase();
};

/**
 * Verifica se uma string cont√©m outra (case-insensitive)
 */
export const caseInsensitiveIncludes = (haystack: string, needle: string): boolean => {
  return haystack.toUpperCase().includes(needle.toUpperCase());
};



================================================================================
FILE PATH: server\.dockerignore
================================================================================
node_modules
npm-debug.log
dist
build
.git
.gitignore
README.md


================================================================================
FILE PATH: server\check_accounts.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const accounts = await prisma.$queryRaw`SELECT id_conta, nome FROM conta_bancaria`;
    console.log('ACCOUNTS:', JSON.stringify(accounts, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\check_cashbook.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const cashbook = await prisma.$queryRaw`SELECT * FROM livro_caixa`;
    console.log('CASHBOOK ALL:', JSON.stringify(cashbook, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\check_cashbook_by_pay.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const cashbook = await prisma.$queryRaw`SELECT * FROM livro_caixa WHERE id_pagamento_cliente IN (17, 18)`;
    console.log('CASHBOOK FOR PAYMENTS:', JSON.stringify(cashbook, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\check_db.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const accounts = await prisma.contaBancaria.findMany();
    console.log('ACCOUNTS:', JSON.stringify(accounts, null, 2));
    const os13 = await prisma.ordemDeServico.findUnique({
        where: { id_os: 13 },
        include: { pagamentos_cliente: true }
    });
    console.log('OS13:', JSON.stringify(os13, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\check_db.ts
================================================================================
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
    console.log('--- Funcionarios ---');
    const funcionarios = await prisma.funcionario.findMany();
    console.log(JSON.stringify(funcionarios, null, 2));

    console.log('--- ServicoMaoDeObra ---');
    const servicos = await prisma.servicoMaoDeObra.findMany();
    console.log(JSON.stringify(servicos, null, 2));
}

main()
  .catch(e => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });



================================================================================
FILE PATH: server\check_db_schema.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const tableInfoPay = await prisma.$queryRaw`
    SELECT column_name, data_type 
    FROM information_schema.columns 
    WHERE table_name = 'pagamento_cliente'
  `;
    console.log('COLUMNS pagamento_cliente:', tableInfoPay);

    const tableInfoLC = await prisma.$queryRaw`
    SELECT column_name, data_type 
    FROM information_schema.columns 
    WHERE table_name = 'livro_caixa'
  `;
    console.log('COLUMNS livro_caixa:', tableInfoLC);
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\check_fechamento_os13.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const fechamentos = await prisma.$queryRaw`SELECT * FROM fechamento_financeiro WHERE id_os = 13`;
    console.log('FECHAMENTOS:', JSON.stringify(fechamentos, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\check_os_status.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const os = await prisma.$queryRaw`SELECT id_os, status FROM ordem_de_servico WHERE id_os = 13`;
    console.log('OS:', JSON.stringify(os, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\check_payments_deleted.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const payments = await prisma.$queryRaw`SELECT id_pagamento_cliente, metodo_pagamento, valor, deleted_at FROM pagamento_cliente WHERE id_os = 13`;
    console.log('PAYMENTS WITH DELETED:', JSON.stringify(payments, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\check_payments_lc.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const payments = await prisma.$queryRaw`SELECT id_pagamento_cliente, id_livro_caixa FROM pagamento_cliente WHERE id_os = 13`;
    console.log('PAYMENTS LC:', JSON.stringify(payments, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\check_times.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const p1 = await prisma.$queryRaw`SELECT id_pagamento_cliente, dt_cadastro FROM pagamento_cliente WHERE id_pagamento_cliente IN (17, 18)`;
    console.log('PAYMENTS TIMES:', JSON.stringify(p1, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\check_times_fixed.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const p1 = await prisma.$queryRaw`SELECT id_pagamento_cliente, data_pagamento FROM pagamento_cliente WHERE id_pagamento_cliente IN (17, 18)`;
    console.log('PAYMENTS TIMES:', JSON.stringify(p1, null, 2));

    const f1 = await prisma.$queryRaw`SELECT id_fechamento_financeiro, data_fechamento_financeiro FROM fechamento_financeiro WHERE id_os = 13`;
    console.log('FECHAMENTO TIME:', JSON.stringify(f1, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\debug_lc_today.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const lc = await prisma.livroCaixa.findMany({
        where: {
            dt_movimentacao: {
                gte: today
            }
        },
        orderBy: {
            dt_movimentacao: 'desc'
        }
    });

    console.log('LIVRO CAIXA HOJE:', JSON.stringify(lc, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\debug_os13.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const payments = await prisma.$queryRaw`SELECT id_pagamento_cliente, metodo_pagamento, valor, id_conta_bancaria, id_operadora FROM pagamento_cliente WHERE id_os = 13`;
    console.log('PAYMENTS:', JSON.stringify(payments, null, 2));

    const receivables = await prisma.$queryRaw`SELECT id_recebivel, valor_bruto, status, data_prevista FROM recebivel_cartao WHERE id_os = 13`;
    console.log('RECEIVABLES:', JSON.stringify(receivables, null, 2));

    const cashbook = await prisma.$queryRaw`SELECT id_livro_caixa, descricao, valor, id_conta_bancaria FROM livro_caixa WHERE descricao LIKE '%OS #13%'`;
    console.log('CASHBOOK:', JSON.stringify(cashbook, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\debug_os14.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const payments = await prisma.$queryRaw`SELECT * FROM pagamento_cliente WHERE id_os = 14`;
    console.log('PAYMENTS OS 14:', JSON.stringify(payments, null, 2));

    const cashbook = await prisma.$queryRaw`SELECT * FROM livro_caixa WHERE descricao LIKE '%OS #14%'`;
    console.log('CASHBOOK OS 14:', JSON.stringify(cashbook, null, 2));

    const accounts = await prisma.$queryRaw`SELECT id_conta, nome, saldo_atual FROM conta_bancaria`;
    console.log('ACCOUNTS:', JSON.stringify(accounts, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\debug_os14_report.js
================================================================================
import { PrismaClient } from '@prisma/client';
import fs from 'fs';
const prisma = new PrismaClient();
async function main() {
    const os14 = await prisma.ordemDeServico.findUnique({
        where: { id_os: 14 },
        include: {
            pagamentos_cliente: {
                include: {
                    livro_caixa: true
                }
            }
        }
    });

    const lc = await prisma.livroCaixa.findMany({
        where: { descricao: { contains: 'OS #14' } }
    });

    const accounts = await prisma.contaBancaria.findMany();

    const report = {
        os14,
        livro_caixa_all: lc,
        accounts
    };

    fs.writeFileSync('os14_report.json', JSON.stringify(report, null, 2));
    console.log('Report saved to os14_report.json');
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\debug_os14_v2.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const os14 = await prisma.ordemDeServico.findUnique({
        where: { id_os: 14 },
        include: {
            pagamentos_cliente: true
        }
    });
    console.log('OS 14:', JSON.stringify(os14, null, 2));

    const lc = await prisma.livroCaixa.findMany({
        where: { descricao: { contains: 'OS #14' } }
    });
    console.log('LIVRO CAIXA OS 14:', JSON.stringify(lc, null, 2));

    const accounts = await prisma.contaBancaria.findMany();
    console.log('ACCOUNTS:', JSON.stringify(accounts, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\debug_os_output.json
================================================================================
{
  "os17": {
    "id_os": 17,
    "id_cliente": 4,
    "id_veiculo": 4,
    "id_funcionario": null,
    "dt_abertura": "2026-01-13T14:02:54.108Z",
    "dt_entrega": "2026-01-13T14:03:21.204Z",
    "km_entrada": 0,
    "status": "FINALIZADA",
    "defeito_relatado": "",
    "diagnostico": null,
    "valor_servico": null,
    "valor_pecas": "0",
    "valor_final": "1000",
    "valor_total_cliente": "1000",
    "valor_mao_de_obra": "1000",
    "modo_pagamento": null,
    "cod_pagamento": null,
    "parcelas": 1,
    "obs": null,
    "obs_final": null,
    "dt_cadastro": "2026-01-13T14:02:54.108Z",
    "deleted_at": null,
    "updated_at": "2026-01-13T16:55:45.529Z",
    "pagamentos_cliente": [
      {
        "id_pagamento_cliente": 28,
        "id_os": 17,
        "metodo_pagamento": "PIX",
        "valor": "1000",
        "data_pagamento": "2026-01-13T16:55:37.711Z",
        "deleted_at": null,
        "bandeira_cartao": null,
        "codigo_transacao": null,
        "qtd_parcelas": 1,
        "id_operadora": null,
        "id_conta_bancaria": 1,
        "id_livro_caixa": null,
        "livro_caixa": null
      }
    ]
  },
  "os18": {
    "id_os": 18,
    "id_cliente": 4,
    "id_veiculo": 4,
    "id_funcionario": null,
    "dt_abertura": "2026-01-13T16:52:07.886Z",
    "dt_entrega": "2026-01-13T16:52:50.554Z",
    "km_entrada": 0,
    "status": "FINALIZADA",
    "defeito_relatado": "todos",
    "diagnostico": "todos",
    "valor_servico": null,
    "valor_pecas": "0",
    "valor_final": "300",
    "valor_total_cliente": "300",
    "valor_mao_de_obra": "300",
    "modo_pagamento": null,
    "cod_pagamento": null,
    "parcelas": 1,
    "obs": null,
    "obs_final": null,
    "dt_cadastro": "2026-01-13T16:52:07.886Z",
    "deleted_at": null,
    "updated_at": "2026-01-13T16:55:03.131Z",
    "pagamentos_cliente": [
      {
        "id_pagamento_cliente": 26,
        "id_os": 18,
        "metodo_pagamento": "PIX",
        "valor": "100",
        "data_pagamento": "2026-01-13T16:52:35.602Z",
        "deleted_at": null,
        "bandeira_cartao": null,
        "codigo_transacao": "65456",
        "qtd_parcelas": 1,
        "id_operadora": null,
        "id_conta_bancaria": 1,
        "id_livro_caixa": null,
        "livro_caixa": null
      },
      {
        "id_pagamento_cliente": 27,
        "id_os": 18,
        "metodo_pagamento": "CREDITO",
        "valor": "200",
        "data_pagamento": "2026-01-13T16:52:46.690Z",
        "deleted_at": null,
        "bandeira_cartao": "VISA",
        "codigo_transacao": "65456",
        "qtd_parcelas": 3,
        "id_operadora": null,
        "id_conta_bancaria": null,
        "id_livro_caixa": null,
        "livro_caixa": null
      }
    ]
  },
  "extrato_last_20": [
    {
      "id_livro_caixa": 6,
      "descricao": "Rec. Confirmado (Lote) - PagSeguro (OS #18) Parc 1/3 [REC_ID:35]",
      "valor": "62.94",
      "tipo_movimentacao": "ENTRADA",
      "categoria": "CONCILIACAO_CARTAO",
      "dt_movimentacao": "2026-01-13T16:56:37.028Z",
      "obs": null,
      "origem": "AUTOMATICA",
      "deleted_at": null,
      "id_conta_bancaria": 1,
      "id_pagamento_equipe": null
    },
    {
      "id_livro_caixa": 5,
      "descricao": "Rec. Confirmado (Lote) - PagSeguro (OS #14) Parc 1/3 [REC_ID:29]",
      "valor": "178.94",
      "tipo_movimentacao": "ENTRADA",
      "categoria": "CONCILIACAO_CARTAO",
      "dt_movimentacao": "2026-01-13T16:56:37.025Z",
      "obs": null,
      "origem": "AUTOMATICA",
      "deleted_at": null,
      "id_conta_bancaria": 1,
      "id_pagamento_equipe": null
    },
    {
      "id_livro_caixa": 4,
      "descricao": "Rec. Confirmado (Lote) - PagSeguro (OS #13) Parc 1/3 [REC_ID:26]",
      "valor": "251.13",
      "tipo_movimentacao": "ENTRADA",
      "categoria": "CONCILIACAO_CARTAO",
      "dt_movimentacao": "2026-01-13T16:56:37.021Z",
      "obs": null,
      "origem": "AUTOMATICA",
      "deleted_at": null,
      "id_conta_bancaria": 1,
      "id_pagamento_equipe": null
    },
    {
      "id_livro_caixa": 3,
      "descricao": "Rec. Confirmado (Lote) - PagSeguro (OS #14) Parc 3/3 [REC_ID:31]",
      "valor": "178.94",
      "tipo_movimentacao": "ENTRADA",
      "categoria": "CONCILIACAO_CARTAO",
      "dt_movimentacao": "2026-01-13T13:20:34.098Z",
      "obs": null,
      "origem": "AUTOMATICA",
      "deleted_at": null,
      "id_conta_bancaria": 1,
      "id_pagamento_equipe": null
    }
  ]
}


================================================================================
FILE PATH: server\debug_os_pix.js
================================================================================

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function checkOSData(osId) {
    console.log(`\n========= ANALISANDO OS #${osId} =========`);

    // 1. Buscar a OS e pagamentos
    const os = await prisma.ordemDeServico.findUnique({
        where: { id_os: osId },
        include: {
            pagamentos_cliente: {
                include: {
                    livro_caixa: true // Ver se tem v√≠nculo
                }
            }
        }
    });

    if (!os) {
        console.log(`‚ùå OS ${osId} n√£o encontrada.`);
        return;
    }

    console.log(`Status: ${os.status}`);
    console.log(`Valor Final: ${os.valor_final}`);

    if (os.pagamentos_cliente.length === 0) {
        console.log(`‚ö†Ô∏è Nenhum pagamento registrado para esta OS.`);
    } else {
        for (const p of os.pagamentos_cliente) {
            console.log(`\n--- Pagamento ID: ${p.id_pagamento_cliente} ---`);
            console.log(`   M√©todo: ${p.metodo_pagamento}`);
            console.log(`   Valor: ${p.valor}`);
            console.log(`   ID Conta Banc√°ria (Original do Form): ${p.id_conta_bancaria}`);
            console.log(`   ID Livro Caixa (V√≠nculo): ${p.id_livro_caixa}`);

            if (p.livro_caixa) {
                console.log(`   >>> Dados do Livro Caixa Vinculado:`);
                console.log(`       ID: ${p.livro_caixa.id_livro_caixa}`);
                console.log(`       Descri√ß√£o: ${p.livro_caixa.descricao}`);
                console.log(`       Valor: ${p.livro_caixa.valor}`);
                console.log(`       ID Conta Banc√°ria (No Livro): ${p.livro_caixa.id_conta_bancaria}  <-- IMPORTANTE`);
                console.log(`       Data: ${p.livro_caixa.dt_movimentacao}`);
            } else {
                console.log(`   ‚ùå ESTE PAGAMENTO N√ÉO TEM REGISTRO NO LIVRO CAIXA!`);
            }
        }
    }
}

async function main() {
    await checkOSData(17);
    await checkOSData(18);

    // Listar √∫ltimas movimenta√ß√µes da conta Nubank (assumindo id 1, mas vamos listar todas)
    console.log('\n========= √öLTIMAS 10 MOVIMENTA√á√ïES DE CONTA BANC√ÅRIA (LIVRO CAIXA) =========');
    const movs = await prisma.livroCaixa.findMany({
        where: {
            id_conta_bancaria: { not: null }
        },
        orderBy: { dt_movimentacao: 'desc' },
        take: 10
    });

    movs.forEach(m => {
        console.log(`[${m.dt_movimentacao.toISOString()}] Conta: ${m.id_conta_bancaria} | Valor: ${m.valor} | Desc: ${m.descricao}`);
    });
}

main()
    .catch(e => console.error(e))
    .finally(async () => {
        await prisma.$disconnect();
    });



================================================================================
FILE PATH: server\debug_os_pix_file.js
================================================================================

import { PrismaClient } from '@prisma/client';
import fs from 'fs';

const prisma = new PrismaClient();

async function getOSData(osId) {
    const os = await prisma.ordemDeServico.findUnique({
        where: { id_os: osId },
        include: {
            pagamentos_cliente: {
                include: {
                    livro_caixa: true
                }
            }
        }
    });
    return os;
}

async function main() {
    try {
        const os17 = await getOSData(17);
        const os18 = await getOSData(18);

        // Buscar todas as movimenta√ß√µes de conta banc√°ria recentes
        const extrato = await prisma.livroCaixa.findMany({
            where: { id_conta_bancaria: { not: null } },
            orderBy: { dt_movimentacao: 'desc' },
            take: 20
        });

        const report = {
            os17,
            os18,
            extrato_last_20: extrato
        };

        fs.writeFileSync('debug_os_output.json', JSON.stringify(report, null, 2));
        console.log('Report saved to debug_os_output.json');
    } catch (error) {
        console.error(error);
    } finally {
        await prisma.$disconnect();
    }
}

main();



================================================================================
FILE PATH: server\debug_rec_31.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const rec = await prisma.recebivelCartao.findUnique({
        where: { id_recebivel: 31 },
        include: { operadora: true }
    });
    console.log('RECEBIVEL 31:', JSON.stringify(rec, null, 2));

    const recs_os14 = await prisma.recebivelCartao.findMany({
        where: { id_os: 14 }
    });
    console.log('RECS OS 14:', JSON.stringify(recs_os14, null, 2));
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\delete_caixa_geral.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();
async function main() {
    const res = await prisma.$executeRaw`DELETE FROM conta_bancaria WHERE nome = 'Caixa Geral'`;
    console.log('DELETED:', res);
}
main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\Dockerfile
================================================================================
# Usa uma imagem base Node.js (Debian-based para melhor compatibilidade c/ Prisma)
FROM node:20

# Define o diret√≥rio de trabalho dentro do cont√™iner
WORKDIR /app/server

# Copia os arquivos de configura√ß√£o de depend√™ncias
COPY package*.json ./

# Instala as depend√™ncias (incluindo o Prisma, express, etc.)
RUN npm install

# Copia o restante do c√≥digo para o diret√≥rio de trabalho
COPY . .

# Comando de inicializa√ß√£o n√£o √© o principal, pois o Docker Compose o sobrescreve
CMD [ "npm", "run", "dev" ]


================================================================================
FILE PATH: server\fix_os17_18.js
================================================================================

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function repairOS17() {
    console.log('>>> REPARANDO OS 17 (PIX R$ 1000)...');

    // 1. Check if already repaired
    const os = await prisma.ordemDeServico.findUnique({
        where: { id_os: 17 },
        include: { pagamentos_cliente: true }
    });

    const pix = os.pagamentos_cliente.find(p => p.metodo_pagamento === 'PIX');
    if (pix && !pix.id_livro_caixa) {
        console.log('   Encontrado PIX sem Livro Caixa. Criando...');

        // Criar Livro Caixa com v√≠nculo banc√°rio (Extrato)
        const lc = await prisma.livroCaixa.create({
            data: {
                descricao: `Venda PIX - OS #17 (Reparo Manual)`,
                valor: 1000,
                tipo_movimentacao: 'ENTRADA',
                categoria: 'VENDA',
                dt_movimentacao: new Date(), // Agora
                origem: 'AUTOMATICA',
                id_conta_bancaria: 1 // Nubank
            }
        });

        // Atualizar Saldo
        await prisma.contaBancaria.update({
            where: { id_conta: 1 },
            data: { saldo_atual: { increment: 1000 } }
        });
        console.log('   ‚úÖ Saldo Nubank atualizado (+1000)');

        // Vincular
        await prisma.pagamentoCliente.update({
            where: { id_pagamento_cliente: pix.id_pagamento_cliente },
            data: { id_livro_caixa: lc.id_livro_caixa }
        });
        console.log('   ‚úÖ V√≠nculo criado.');
    } else {
        console.log('   ‚ö†Ô∏è PIX da OS 17 j√° parece estar correto ou n√£o encontrado.');
    }
}

async function repairOS18() {
    console.log('\n>>> REPARANDO OS 18 (PIX R$ 100 + CART√ÉO R$ 200)...');

    const os = await prisma.ordemDeServico.findUnique({
        where: { id_os: 18 },
        include: { pagamentos_cliente: true }
    });

    // --- REPARO PIX (100) ---
    const pix = os.pagamentos_cliente.find(p => p.metodo_pagamento === 'PIX');
    if (pix && !pix.id_livro_caixa) {
        console.log('   [PIX] Encontrado sem Livro Caixa. Criando...');
        const lc = await prisma.livroCaixa.create({
            data: {
                descricao: `Venda PIX - OS #18 (Reparo Manual)`,
                valor: 100,
                tipo_movimentacao: 'ENTRADA',
                categoria: 'VENDA',
                dt_movimentacao: new Date(),
                origem: 'AUTOMATICA',
                id_conta_bancaria: 1 // Nubank
            }
        });
        await prisma.contaBancaria.update({
            where: { id_conta: 1 },
            data: { saldo_atual: { increment: 100 } }
        });
        await prisma.pagamentoCliente.update({
            where: { id_pagamento_cliente: pix.id_pagamento_cliente },
            data: { id_livro_caixa: lc.id_livro_caixa }
        });
        console.log('   ‚úÖ [PIX] Reparado.');
    }

    // --- REPARO CART√ÉO (200) ---
    const card = os.pagamentos_cliente.find(p => p.metodo_pagamento === 'CREDITO');
    if (card && !card.id_livro_caixa) {
        console.log('   [CART√ÉO] Encontrado sem Livro Caixa/Receb√≠veis. Criando...');

        // 1. Livro Caixa (Faturamento - Sem Banco)
        const lc = await prisma.livroCaixa.create({
            data: {
                descricao: `Venda Cart√£o CREDITO (Reparo OS #18)`,
                valor: 200,
                tipo_movimentacao: 'ENTRADA',
                categoria: 'VENDA',
                dt_movimentacao: new Date(),
                origem: 'AUTOMATICA',
                id_conta_bancaria: null // NAO AFETA BANCO AINDA
            }
        });

        // 2. Vincular
        await prisma.pagamentoCliente.update({
            where: { id_pagamento_cliente: card.id_pagamento_cliente },
            data: { id_livro_caixa: lc.id_livro_caixa }
        });

        // 3. Criar Receb√≠veis (Simulando Stone/Taxa Padr√£o pois id_operadora estava null)
        // Vou buscar a operadora 'Stone' ou a primeira disponivel para vincular
        const operadora = await prisma.operadoraCartao.findFirst();
        if (operadora) {
            const parcelas = 3;
            const valorTotal = 200;
            const valorParc = valorTotal / parcelas;

            // Taxa Padrao (Simulada)
            const taxa = Number(operadora.taxa_credito_parc || 3);
            const taxaAplicada = (valorTotal * taxa) / 100;
            const valorLiqTotal = valorTotal - taxaAplicada;
            const valorLiqParc = valorLiqTotal / parcelas;
            const taxaParc = taxaAplicada / parcelas;

            for (let i = 1; i <= parcelas; i++) {
                const dt = new Date();
                dt.setMonth(dt.getMonth() + i);

                await prisma.recebivelCartao.create({
                    data: {
                        id_os: 18,
                        id_operadora: operadora.id_operadora,
                        num_parcela: i,
                        total_parcelas: parcelas,
                        valor_bruto: valorParc,
                        valor_liquido: valorLiqParc,
                        taxa_aplicada: taxaParc,
                        data_venda: new Date(),
                        data_prevista: dt,
                        status: 'PENDENTE'
                    }
                });
            }
            console.log(`   ‚úÖ [CART√ÉO] 3 Receb√≠veis criados na operadora ${operadora.nome}.`);

            // Vincular operadora ao pagamento para corrigir
            await prisma.pagamentoCliente.update({
                where: { id_pagamento_cliente: card.id_pagamento_cliente },
                data: { id_operadora: operadora.id_operadora }
            });
        }

        console.log('   ‚úÖ [CART√ÉO] Reparado.');
    }
}

async function main() {
    await repairOS17();
    await repairOS18();
}

main()
    .catch(e => console.error(e))
    .finally(async () => {
        await prisma.$disconnect();
    });



================================================================================
FILE PATH: server\lc_dump.json
================================================================================



================================================================================
FILE PATH: server\lc_dump_docker.json
================================================================================
[{"id_livro_caixa":9,"descricao":"Venda Cart+˙o CREDITO (Reparo OS #18)","valor":"200","tipo_movimentacao":"ENTRADA","categoria":"VENDA","dt_movimentacao":"2026-01-13T17:04:02.141Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":null,"id_pagamento_equipe":null,"conta":null},{"id_livro_caixa":8,"descricao":"Venda PIX - OS #18 (Reparo Manual)","valor":"100","tipo_movimentacao":"ENTRADA","categoria":"VENDA","dt_movimentacao":"2026-01-13T17:04:02.133Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":1,"id_pagamento_equipe":null,"conta":{"id_conta":1,"nome":"Nubank","banco":"Oficina","agencia":"0001","conta":"4521369","saldo_atual":"11183.83","ativo":true,"vincular_caixa":false,"dt_cadastro":"2026-01-12T14:21:31.852Z"}},{"id_livro_caixa":7,"descricao":"Venda PIX - OS #17 (Reparo Manual)","valor":"1000","tipo_movimentacao":"ENTRADA","categoria":"VENDA","dt_movimentacao":"2026-01-13T17:04:02.101Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":1,"id_pagamento_equipe":null,"conta":{"id_conta":1,"nome":"Nubank","banco":"Oficina","agencia":"0001","conta":"4521369","saldo_atual":"11183.83","ativo":true,"vincular_caixa":false,"dt_cadastro":"2026-01-12T14:21:31.852Z"}},{"id_livro_caixa":6,"descricao":"Rec. Confirmado (Lote) - PagSeguro (OS #18) Parc 1/3 [REC_ID:35]","valor":"62.94","tipo_movimentacao":"ENTRADA","categoria":"CONCILIACAO_CARTAO","dt_movimentacao":"2026-01-13T16:56:37.028Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":1,"id_pagamento_equipe":null,"conta":{"id_conta":1,"nome":"Nubank","banco":"Oficina","agencia":"0001","conta":"4521369","saldo_atual":"11183.83","ativo":true,"vincular_caixa":false,"dt_cadastro":"2026-01-12T14:21:31.852Z"}},{"id_livro_caixa":5,"descricao":"Rec. Confirmado (Lote) - PagSeguro (OS #14) Parc 1/3 [REC_ID:29]","valor":"178.94","tipo_movimentacao":"ENTRADA","categoria":"CONCILIACAO_CARTAO","dt_movimentacao":"2026-01-13T16:56:37.025Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":1,"id_pagamento_equipe":null,"conta":{"id_conta":1,"nome":"Nubank","banco":"Oficina","agencia":"0001","conta":"4521369","saldo_atual":"11183.83","ativo":true,"vincular_caixa":false,"dt_cadastro":"2026-01-12T14:21:31.852Z"}},{"id_livro_caixa":4,"descricao":"Rec. Confirmado (Lote) - PagSeguro (OS #13) Parc 1/3 [REC_ID:26]","valor":"251.13","tipo_movimentacao":"ENTRADA","categoria":"CONCILIACAO_CARTAO","dt_movimentacao":"2026-01-13T16:56:37.021Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":1,"id_pagamento_equipe":null,"conta":{"id_conta":1,"nome":"Nubank","banco":"Oficina","agencia":"0001","conta":"4521369","saldo_atual":"11183.83","ativo":true,"vincular_caixa":false,"dt_cadastro":"2026-01-12T14:21:31.852Z"}},{"id_livro_caixa":3,"descricao":"Rec. Confirmado (Lote) - PagSeguro (OS #14) Parc 3/3 [REC_ID:31]","valor":"178.94","tipo_movimentacao":"ENTRADA","categoria":"CONCILIACAO_CARTAO","dt_movimentacao":"2026-01-13T13:20:34.098Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":1,"id_pagamento_equipe":null,"conta":{"id_conta":1,"nome":"Nubank","banco":"Oficina","agencia":"0001","conta":"4521369","saldo_atual":"11183.83","ativo":true,"vincular_caixa":false,"dt_cadastro":"2026-01-12T14:21:31.852Z"}},{"id_livro_caixa":2,"descricao":"Pagamento Equipe - Sinomar de Souza Cabral","valor":"600","tipo_movimentacao":"SAIDA","categoria":"EQUIPE","dt_movimentacao":"2026-01-13T10:49:02.851Z","obs":null,"origem":"MANUAL","deleted_at":null,"id_conta_bancaria":null,"id_pagamento_equipe":2,"conta":null},{"id_livro_caixa":1,"descricao":"Pagamento Equipe - Sinomar de Souza Cabral","valor":"250","tipo_movimentacao":"SAIDA","categoria":"EQUIPE","dt_movimentacao":"2026-01-13T10:48:07.785Z","obs":null,"origem":"MANUAL","deleted_at":null,"id_conta_bancaria":null,"id_pagamento_equipe":1,"conta":null}]



================================================================================
FILE PATH: server\lc_dump_utf8.json
================================================================================
[{"id_livro_caixa":9,"descricao":"Venda Cart+˙o CREDITO (Reparo OS #18)","valor":"200","tipo_movimentacao":"ENTRADA","categoria":"VENDA","dt_movimentacao":"2026-01-13T17:04:02.141Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":null,"id_pagamento_equipe":null,"conta":null},{"id_livro_caixa":8,"descricao":"Venda PIX - OS #18 (Reparo Manual)","valor":"100","tipo_movimentacao":"ENTRADA","categoria":"VENDA","dt_movimentacao":"2026-01-13T17:04:02.133Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":1,"id_pagamento_equipe":null,"conta":{"id_conta":1,"nome":"Nubank","banco":"Oficina","agencia":"0001","conta":"4521369","saldo_atual":"11183.83","ativo":true,"vincular_caixa":false,"dt_cadastro":"2026-01-12T14:21:31.852Z"}},{"id_livro_caixa":7,"descricao":"Venda PIX - OS #17 (Reparo Manual)","valor":"1000","tipo_movimentacao":"ENTRADA","categoria":"VENDA","dt_movimentacao":"2026-01-13T17:04:02.101Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":1,"id_pagamento_equipe":null,"conta":{"id_conta":1,"nome":"Nubank","banco":"Oficina","agencia":"0001","conta":"4521369","saldo_atual":"11183.83","ativo":true,"vincular_caixa":false,"dt_cadastro":"2026-01-12T14:21:31.852Z"}},{"id_livro_caixa":6,"descricao":"Rec. Confirmado (Lote) - PagSeguro (OS #18) Parc 1/3 [REC_ID:35]","valor":"62.94","tipo_movimentacao":"ENTRADA","categoria":"CONCILIACAO_CARTAO","dt_movimentacao":"2026-01-13T16:56:37.028Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":1,"id_pagamento_equipe":null,"conta":{"id_conta":1,"nome":"Nubank","banco":"Oficina","agencia":"0001","conta":"4521369","saldo_atual":"11183.83","ativo":true,"vincular_caixa":false,"dt_cadastro":"2026-01-12T14:21:31.852Z"}},{"id_livro_caixa":5,"descricao":"Rec. Confirmado (Lote) - PagSeguro (OS #14) Parc 1/3 [REC_ID:29]","valor":"178.94","tipo_movimentacao":"ENTRADA","categoria":"CONCILIACAO_CARTAO","dt_movimentacao":"2026-01-13T16:56:37.025Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":1,"id_pagamento_equipe":null,"conta":{"id_conta":1,"nome":"Nubank","banco":"Oficina","agencia":"0001","conta":"4521369","saldo_atual":"11183.83","ativo":true,"vincular_caixa":false,"dt_cadastro":"2026-01-12T14:21:31.852Z"}},{"id_livro_caixa":4,"descricao":"Rec. Confirmado (Lote) - PagSeguro (OS #13) Parc 1/3 [REC_ID:26]","valor":"251.13","tipo_movimentacao":"ENTRADA","categoria":"CONCILIACAO_CARTAO","dt_movimentacao":"2026-01-13T16:56:37.021Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":1,"id_pagamento_equipe":null,"conta":{"id_conta":1,"nome":"Nubank","banco":"Oficina","agencia":"0001","conta":"4521369","saldo_atual":"11183.83","ativo":true,"vincular_caixa":false,"dt_cadastro":"2026-01-12T14:21:31.852Z"}},{"id_livro_caixa":3,"descricao":"Rec. Confirmado (Lote) - PagSeguro (OS #14) Parc 3/3 [REC_ID:31]","valor":"178.94","tipo_movimentacao":"ENTRADA","categoria":"CONCILIACAO_CARTAO","dt_movimentacao":"2026-01-13T13:20:34.098Z","obs":null,"origem":"AUTOMATICA","deleted_at":null,"id_conta_bancaria":1,"id_pagamento_equipe":null,"conta":{"id_conta":1,"nome":"Nubank","banco":"Oficina","agencia":"0001","conta":"4521369","saldo_atual":"11183.83","ativo":true,"vincular_caixa":false,"dt_cadastro":"2026-01-12T14:21:31.852Z"}},{"id_livro_caixa":2,"descricao":"Pagamento Equipe - Sinomar de Souza Cabral","valor":"600","tipo_movimentacao":"SAIDA","categoria":"EQUIPE","dt_movimentacao":"2026-01-13T10:49:02.851Z","obs":null,"origem":"MANUAL","deleted_at":null,"id_conta_bancaria":null,"id_pagamento_equipe":2,"conta":null},{"id_livro_caixa":1,"descricao":"Pagamento Equipe - Sinomar de Souza Cabral","valor":"250","tipo_movimentacao":"SAIDA","categoria":"EQUIPE","dt_movimentacao":"2026-01-13T10:48:07.785Z","obs":null,"origem":"MANUAL","deleted_at":null,"id_conta_bancaria":null,"id_pagamento_equipe":1,"conta":null}]



================================================================================
FILE PATH: server\lc_today.json
================================================================================
LIVRO CAIXA HOJE: [
  {
    "id_livro_caixa": 3,
    "descricao": "Rec. Confirmado (Lote) - PagSeguro (OS #14) Parc 3/3 [REC_ID:31]",
    "valor": "178.94",
    "tipo_movimentacao": "ENTRADA",
    "categoria": "CONCILIACAO_CARTAO",
    "dt_movimentacao": "2026-01-13T13:20:34.098Z",
    "obs": null,
    "origem": "AUTOMATICA",
    "deleted_at": null,
    "id_conta_bancaria": 1,
    "id_pagamento_equipe": null
  },
  {
    "id_livro_caixa": 2,
    "descricao": "Pagamento Equipe - Sinomar de Souza Cabral",
    "valor": "600",
    "tipo_movimentacao": "SAIDA",
    "categoria": "EQUIPE",
    "dt_movimentacao": "2026-01-13T10:49:02.851Z",
    "obs": null,
    "origem": "MANUAL",
    "deleted_at": null,
    "id_conta_bancaria": null,
    "id_pagamento_equipe": 2
  },
  {
    "id_livro_caixa": 1,
    "descricao": "Pagamento Equipe - Sinomar de Souza Cabral",
    "valor": "250",
    "tipo_movimentacao": "SAIDA",
    "categoria": "EQUIPE",
    "dt_movimentacao": "2026-01-13T10:48:07.785Z",
    "obs": null,
    "origem": "MANUAL",
    "deleted_at": null,
    "id_conta_bancaria": null,
    "id_pagamento_equipe": 1
  }
]



================================================================================
FILE PATH: server\os14_report.json
================================================================================
{
  "os14": {
    "id_os": 14,
    "id_cliente": 4,
    "id_veiculo": 4,
    "id_funcionario": null,
    "dt_abertura": "2026-01-13T13:18:09.297Z",
    "dt_entrega": "2026-01-13T13:19:37.383Z",
    "km_entrada": 0,
    "status": "FINALIZADA",
    "defeito_relatado": "Troca de Pastilhas e Disco",
    "diagnostico": "Troca de Pastilhas e Disco",
    "valor_servico": null,
    "valor_pecas": "378.6",
    "valor_final": "678.6",
    "valor_total_cliente": "678.6",
    "valor_mao_de_obra": "300",
    "modo_pagamento": null,
    "cod_pagamento": null,
    "parcelas": 1,
    "obs": null,
    "obs_final": null,
    "dt_cadastro": "2026-01-13T13:18:09.297Z",
    "deleted_at": null,
    "updated_at": "2026-01-13T13:21:06.073Z",
    "pagamentos_cliente": [
      {
        "id_pagamento_cliente": 19,
        "id_os": 14,
        "metodo_pagamento": "PIX",
        "valor": "110",
        "data_pagamento": "2026-01-13T13:19:20.230Z",
        "deleted_at": null,
        "bandeira_cartao": null,
        "codigo_transacao": "4985654",
        "qtd_parcelas": 1,
        "id_operadora": null,
        "id_conta_bancaria": 1,
        "id_livro_caixa": null,
        "livro_caixa": null
      },
      {
        "id_pagamento_cliente": 20,
        "id_os": 14,
        "metodo_pagamento": "CREDITO",
        "valor": "568.6",
        "data_pagamento": "2026-01-13T13:19:33.223Z",
        "deleted_at": null,
        "bandeira_cartao": "VISA",
        "codigo_transacao": "79856451",
        "qtd_parcelas": 3,
        "id_operadora": null,
        "id_conta_bancaria": null,
        "id_livro_caixa": null,
        "livro_caixa": null
      }
    ]
  },
  "livro_caixa_all": [
    {
      "id_livro_caixa": 3,
      "descricao": "Rec. Confirmado (Lote) - PagSeguro (OS #14) Parc 3/3 [REC_ID:31]",
      "valor": "178.94",
      "tipo_movimentacao": "ENTRADA",
      "categoria": "CONCILIACAO_CARTAO",
      "dt_movimentacao": "2026-01-13T13:20:34.098Z",
      "obs": null,
      "origem": "AUTOMATICA",
      "deleted_at": null,
      "id_conta_bancaria": 1,
      "id_pagamento_equipe": null
    }
  ],
  "accounts": [
    {
      "id_conta": 3,
      "nome": "Caixa Economica",
      "banco": "",
      "agencia": "12589",
      "conta": "45219863",
      "saldo_atual": "1400",
      "ativo": true,
      "vincular_caixa": false,
      "dt_cadastro": "2026-01-13T10:39:31.643Z"
    },
    {
      "id_conta": 1,
      "nome": "Nubank",
      "banco": "Oficina",
      "agencia": "0001",
      "conta": "4521369",
      "saldo_atual": "9590.82",
      "ativo": true,
      "vincular_caixa": false,
      "dt_cadastro": "2026-01-12T14:21:31.852Z"
    }
  ]
}


================================================================================
FILE PATH: server\package.json
================================================================================
{
  "name": "server",
  "version": "1.0.0",
  "description": "",
  "type": "module",
  "main": "index.js",
  "scripts": {
    "dev": "tsx watch src/server.ts",
    "migrate:host": "set DATABASE_URL=postgresql://user:password@localhost:5434/automotivo_db&& npx prisma migrate dev",
    "db:seed": "tsx prisma/seed.ts",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "@prisma/client": "5.22.0",
    "@types/cors": "^2.8.19",
    "@types/express": "^5.0.6",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.2.1",
    "ts-node": "^10.9.2",
    "typescript": "^5.9.3"
  },
  "devDependencies": {
    "prisma": "^5.22.0",
    "tsx": "^4.21.0"
  },
  "prisma": {
    "seed": "tsx prisma/seed.ts"
  }
}



================================================================================
FILE PATH: server\test_consolidate_os14_v2.js
================================================================================
import { PrismaClient } from '@prisma/client';
import { FechamentoFinanceiroRepository } from './src/repositories/fechamentoFinanceiro.repository.js';

const prisma = new PrismaClient();
const repo = new FechamentoFinanceiroRepository();

async function main() {
    console.log('--- TEST CONSOLIDATION OS 14 ---');

    // 1. Reset OS 14 status to testing state
    await prisma.ordemDeServico.update({
        where: { id_os: 14 },
        data: { status: 'PRONTO PARA FINANCEIRO' }
    });

    // 2. Remove any previous fechamento for OS 14 to allow re-consolidation
    await prisma.fechamentoFinanceiro.deleteMany({
        where: { id_os: 14 }
    });

    // 3. Clear LC links from payments
    await prisma.pagamentoCliente.updateMany({
        where: { id_os: 14 },
        data: { id_livro_caixa: null }
    });

    try {
        const result = await repo.consolidarOS(14, 0);
        console.log('CONSOLIDATION SUCCESSFUL:', JSON.stringify(result, null, 2));
    } catch (err) {
        console.error('CONSOLIDATION FAILED:', err);
    }
}

main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\test_pix_logic.js
================================================================================
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();

async function main() {
    console.log('--- TESTING PIX LOGIC FOR OS 14 ---');
    const idOs = 14;

    const result = await prisma.$transaction(async (tx) => {
        // 1. Fetch OS and payments
        const os = await tx.ordemDeServico.findUnique({
            where: { id_os: idOs },
            include: {
                pagamentos_cliente: {
                    where: { deleted_at: null }
                }
            }
        });

        if (!os) throw new Error('OS not found');
        console.log(`Processing OS #${idOs} with ${os.pagamentos_cliente.length} payments`);

        for (const pagamento of os.pagamentos_cliente) {
            const metodo = pagamento.metodo_pagamento.toUpperCase();
            console.log(`Payment ID ${pagamento.id_pagamento_cliente}, Method: ${metodo}, Value: ${pagamento.valor}`);

            if (metodo === 'PIX') {
                console.log(`Creating LivroCaixa for PIX. Account: ${pagamento.id_conta_bancaria}`);

                try {
                    const libroCaixa = await tx.livroCaixa.create({
                        data: {
                            descricao: `Venda PIX - OS #${idOs} (TEST)`,
                            valor: pagamento.valor,
                            tipo_movimentacao: 'ENTRADA',
                            categoria: 'VENDA',
                            dt_movimentacao: new Date(),
                            origem: 'AUTOMATICA',
                            id_conta_bancaria: (pagamento as any).id_conta_bancaria
                        }
                    });
                    console.log(`LivroCaixa created: ID ${libroCaixa.id_livro_caixa}`);

                    await tx.pagamentoCliente.update({
                        where: { id_pagamento_cliente: pagamento.id_pagamento_cliente },
                        data: { id_livro_caixa: libroCaixa.id_livro_caixa }
                    });
                    console.log(`Payment updated with LC ID`);

                    if (pagamento.id_conta_bancaria) {
                        await tx.contaBancaria.update({
                            where: { id_conta: pagamento.id_conta_bancaria },
                            data: { saldo_atual: { increment: Number(pagamento.valor) } }
                        });
                        console.log(`Account ${pagamento.id_conta_bancaria} balance updated (+ ${pagamento.valor})`);
                    }
                } catch (e) {
                    console.error(`Error in PIX block for ID ${pagamento.id_pagamento_cliente}:`, e);
                    throw e;
                }
            }
        }

        return { success: true };
    });

    console.log('RESULT:', JSON.stringify(result, null, 2));
}

main().catch(console.error).finally(() => prisma.$disconnect());



================================================================================
FILE PATH: server\tsconfig.json
================================================================================
{
  // Visit https://aka.ms/tsconfig to read more about this file
  "compilerOptions": {
    // File Layout
    // "rootDir": "./src",
    // "outDir": "./dist",

    // Environment Settings
    // See also https://aka.ms/tsconfig/module
    "module": "nodenext",
    "target": "esnext",
    "types": [],
    // For nodejs:
    // "lib": ["esnext"],
    // "types": ["node"],
    // and npm install -D @types/node

    // Other Outputs
    "sourceMap": true,
    "declaration": true,
    "declarationMap": true,

    // Stricter Typechecking Options
    "noUncheckedIndexedAccess": true,
    "exactOptionalPropertyTypes": true,

    // Style Options
    // "noImplicitReturns": true,
    // "noImplicitOverride": true,
    // "noUnusedLocals": true,
    // "noUnusedParameters": true,
    // "noFallthroughCasesInSwitch": true,
    // "noPropertyAccessFromIndexSignature": true,

    // Recommended Options
    "strict": true,
    "jsx": "react-jsx",
    //"verbatimModuleSyntax": true,
    "isolatedModules": true,
    "noUncheckedSideEffectImports": true,
    "moduleDetection": "force",
    "skipLibCheck": true,
  }
}



================================================================================
FILE PATH: server\prisma\schema.prisma
================================================================================
// server/prisma/schema.prisma

// 1. Configura√ß√£o do Client: Deve ser 'prisma-client-js'
generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// 2. Configura√ß√£o do Banco de Dados
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- TABELAS DE GENERALIZA√á√ÉO ---

// Tabela 1: Pessoa (Base)
model Pessoa {
  id_pessoa       Int      @id @default(autoincrement())
  nome            String   @db.VarChar(100)
  genero          String?  @db.VarChar(20)
  dt_nascimento   DateTime? @db.Date // DATE
  obs             String?  @db.VarChar(500)
  dt_cadastro     DateTime @default(now()) @db.Timestamp()

  // Relacionamentos 1:1 (Para Especializa√ß√£o)
  pessoa_fisica   PessoaFisica?
  pessoa_juridica PessoaJuridica?

  @@map("pessoa")
}

// Tabela 2: Pessoa F√≠sica (Especializa√ß√£o)
model PessoaFisica {
  id_pessoa_fisica Int      @id @default(autoincrement())
  id_pessoa        Int      @unique
  cpf              String?  @db.VarChar(11)
  dt_cadastro      DateTime @default(now()) @db.Timestamp()

  // Relacionamento com Pessoa
  pessoa           Pessoa   @relation(fields: [id_pessoa], references: [id_pessoa])

  // Relacionamentos para outras tabelas
  funcionario      Funcionario?
  clientes         Cliente[] // Mapeamento 1:N
  
  @@map("pessoa_fisica")
}

// Tabela 3: Pessoa Jur√≠dica (Especializa√ß√£o)
model PessoaJuridica {
  id_pessoa_juridica Int      @id @default(autoincrement())
  id_pessoa          Int      @unique
  razao_social       String   @db.VarChar(100)
  nome_fantasia      String?  @db.VarChar(100)
  cnpj               String?  @unique @db.VarChar(14)
  inscricao_estadual String?  @db.VarChar(50)
  dt_cadastro        DateTime @default(now()) @db.Timestamp()

  // Relacionamento com Pessoa
  pessoa             Pessoa   @relation(fields: [id_pessoa], references: [id_pessoa])

  // Relacionamentos para outras tabelas
  clientes           Cliente[]

  @@map("pessoa_juridica")
}

// Tabela 4: Tipo (Fun√ß√£o da Pessoa/Empresa)
model Tipo {
  id_tipo     Int      @id @default(autoincrement())
  funcao      String?  @db.VarChar(50)
  dt_cadastro DateTime @default(now()) @db.Timestamp()
  
  // Relacionamento com Cliente
  clientes    Cliente[]
  
  @@map("tipo")
}

// --- TABELAS PRINCIPAIS ---

// Tabela 5: Cliente (Endere√ßo e Contato)
model Cliente {
  id_cliente          Int       @id @default(autoincrement())
  
  // FKs OPCIONAIS (NULLABLE)
  id_pessoa_fisica    Int?      
  id_pessoa_juridica  Int?      
  tipo_pessoa         Int       // FK
  
  telefone_1          String    @db.VarChar(15)
  telefone_2          String?   @db.VarChar(15)
  telefone_3          String?   @db.VarChar(15)
  email               String?   @db.VarChar(100)
  logradouro          String?   @db.VarChar(150)
  nr_logradouro       String?   @db.VarChar(10)
  compl_logradouro    String?   @db.VarChar(50)
  bairro              String?   @db.VarChar(100)
  cidade              String?   @db.VarChar(100)
  estado              String?   @db.Char(2)
  cep                 String?   @db.VarChar(10)
  dt_cadastro         DateTime  @default(now()) @db.Timestamp()
  
  // Relacionamentos (Chaves Estrangeiras)
  pessoa_fisica       PessoaFisica?  @relation(fields: [id_pessoa_fisica], references: [id_pessoa_fisica])
  pessoa_juridica     PessoaJuridica? @relation(fields: [id_pessoa_juridica], references: [id_pessoa_juridica])
  tipo                Tipo          @relation(fields: [tipo_pessoa], references: [id_tipo])
  
  // Relacionamentos de Volta
  veiculos            Veiculo[]
  ordens_de_servico   OrdemDeServico[]

  // √çndices para as FKs para otimiza√ß√£o
  @@index([id_pessoa_fisica])
  @@index([id_pessoa_juridica])
  @@index([tipo_pessoa])
  
  @@map("cliente")
}

// Tabela 6: Funcion√°rio
// Tabela 6: Funcion√°rio
model Funcionario {
  id_funcionario      Int      @id @default(autoincrement())
  id_pessoa_fisica    Int      @unique 
  ativo               String   @db.Char(1) 
  cargo               String   @db.VarChar(50)
  dt_admissao         DateTime @db.Timestamp()
  dt_recisao          DateTime? @db.Timestamp()
  motivo_saida        String?  @db.VarChar(200)
  obs                 String?  @db.VarChar(500) // Observa√ß√µes gerais
  dt_cadastro         DateTime @default(now()) @db.Timestamp()
  
  // Identifica√ß√£o Profissional (MEI)
  razao_social        String?  @db.VarChar(100)
  nome_fantasia       String?  @db.VarChar(100)
  cnpj_mei            String?  @db.VarChar(20)
  inscricao_municipal String?  @db.VarChar(50)

  // Dados Pessoais Extras (Endere√ßo e Docs)
  rg                  String?  @db.VarChar(20)
  cep                 String?  @db.VarChar(10)
  logradouro          String?  @db.VarChar(150)
  numero              String?  @db.VarChar(20)
  complemento         String?  @db.VarChar(100)
  bairro              String?  @db.VarChar(100)
  cidade              String?  @db.VarChar(100)
  uf                  String?  @db.Char(2)
  telefone_pessoal    String?  @db.VarChar(20)
  email_pessoal       String?  @db.VarChar(100)

  // Operacional
  especialidade       String?  @db.VarChar(100)
  tipo_pagamento      String?  @db.VarChar(50) // 'HORA', 'FIXO_MENSAL'
  valor_pagamento     Decimal? @db.Decimal(10, 2)
  
  // Comiss√µes
  salario             Decimal? @db.Decimal(10, 2) // Mantido como refer√™ncia base se necess√°rio
  comissao            Int?     // Mantido (Comiss√£o M√£o de Obra %)
  comissao_pecas      Decimal? @db.Decimal(5, 2) // Novo (Comiss√£o Pe√ßas %)

  // Financeiro e Pagamento
  banco               String?  @db.VarChar(50)
  agencia             String?  @db.VarChar(20)
  conta               String?  @db.VarChar(20)
  chave_pix           String?  @db.VarChar(100)
  periodicidade_pagamento String? @db.VarChar(50)
  dia_vencimento      Int?
  
  // Documenta√ß√£o (Links)
  url_ccmei           String?  @db.VarChar(500)
  url_cnh             String?  @db.VarChar(500)
  equipamentos_epis   String?  @db.Text
  
  // Relacionamento 1:1 com PessoaFisica
  pessoa_fisica       PessoaFisica @relation(fields: [id_pessoa_fisica], references: [id_pessoa_fisica])
  
  // Relacionamento de Volta
  ordens_de_servico   OrdemDeServico[]
  servicos_mao_de_obra ServicoMaoDeObra[]
  pagamentos           PagamentoEquipe[]

  @@map("funcionario")
}

// Tabela 7: Pe√ßas Estoque
model PecasEstoque {
    id_pecas_estoque    Int      @id @default(autoincrement())
    fabricante          String?  @db.VarChar(50)
    nome                String   @db.VarChar(255)
    descricao           String   @db.VarChar(255)
    valor_custo         Decimal    @db.Decimal(10, 2)
    valor_venda         Decimal    @db.Decimal(10, 2)
    estoque_atual       Int      
    unidade_medida      String?  @db.VarChar(20)
    dt_ultima_compra    DateTime? @db.Timestamp()
    
    // Novo Campo
    custo_unitario_padrao Decimal @default(0) @db.Decimal(10, 2)
    
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    
    // Relacionamento de Volta (M:N com OS)
    itens_os            ItensOs[]
    itens_entrada       ItemEntrada[] // Hist√≥rico de Compras desse item

    @@map("pecas_estoque")
}

// Tabela 8: Ve√≠culo
model Veiculo {
    id_veiculo          Int      @id @default(autoincrement())
    id_cliente          Int      
    placa               String   @unique @db.VarChar(8)
    chassi              String?  @db.VarChar(20)
    marca               String   @db.VarChar(50)
    modelo              String   @db.VarChar(50)
    versao              String?  @db.VarChar(50)
    ano_modelo          String   @db.VarChar(10)
    cor                 String   @db.VarChar(30)
    combustivel         String   @db.VarChar(20)
    obs                 String?  @db.VarChar(500)
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    
    // Relacionamento 1:N com Cliente
    cliente             Cliente  @relation(fields: [id_cliente], references: [id_cliente])
    
    // Relacionamento de Volta
    ordens_de_servico   OrdemDeServico[]

    @@map("veiculo")
}

// Tabela 9: Ordem de Servi√ßo (OS)
model OrdemDeServico {
    id_os               Int      @id @default(autoincrement())
    id_cliente          Int
    id_veiculo          Int
    id_funcionario      Int?
    dt_abertura         DateTime @default(now()) @db.Timestamp()
    dt_entrega          DateTime? @db.Timestamp()
    km_entrada          Int      
    status              String   @db.VarChar(50)
    defeito_relatado    String?  @db.VarChar(500)
    diagnostico         String?  @db.VarChar(500)
    
    // Campos Existentes de Valores
    valor_servico       Decimal?   @db.Decimal(10, 2)
    valor_pecas         Decimal?   @db.Decimal(10, 2)
    valor_final         Decimal?   @db.Decimal(12, 2)
    
    // Novos Campos Solicitados
    valor_total_cliente Decimal?   @db.Decimal(10, 2) // Receita do Cliente
    valor_mao_de_obra   Decimal?   @db.Decimal(10, 2) // Valor M.O. padr√£o
    
    modo_pagamento      String?  @db.VarChar(50)
    cod_pagamento       String?  @db.VarChar(80)
    parcelas            Int      
    obs                 String?  @db.VarChar(500)
    obs_final           String?  @db.VarChar(500)
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    deleted_at          DateTime? @db.Timestamp() // Soft Delete Marker
    
    // Relacionamentos (Chaves Estrangeiras)
    cliente             Cliente    @relation(fields: [id_cliente], references: [id_cliente])
    veiculo             Veiculo    @relation(fields: [id_veiculo], references: [id_veiculo])
    funcionario         Funcionario? @relation(fields: [id_funcionario], references: [id_funcionario])
    
    // Relacionamentos de Volta
    itens_os            ItensOs[]
    servicos_mao_de_obra ServicoMaoDeObra[]
    fechamento_financeiro FechamentoFinanceiro?
    pagamentos_cliente  PagamentoCliente[]
    recebiveis_cartao   RecebivelCartao[]

    @@map("ordem_de_servico")
    
    @@index([id_cliente])
    @@index([id_veiculo])
    @@index([status])
    @@index([deleted_at])
    
    updated_at          DateTime @default(now()) @updatedAt @db.Timestamp()
}

// Tabela 10: Tabela Associativa M:N (ITENS_OS)
model ItensOs {
    id_iten             Int      @id @default(autoincrement())
    id_os               Int      
    id_pecas_estoque    Int?      
    descricao           String   @db.VarChar(500) 
    codigo_referencia   String?  @db.VarChar(50) // Identifica√ß√£o da Pe√ßa (Nota) 
    
    // Campos Renomeados/Garantidos
    quantidade          Int      
    valor_venda         Decimal    @db.Decimal(10, 2)
    valor_total         Decimal    @db.Decimal(12, 2)
    
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    deleted_at          DateTime? @db.Timestamp()
    
    // Relacionamentos (Chaves Estrangeiras)
    ordem_de_servico    OrdemDeServico @relation(fields: [id_os], references: [id_os])
    pecas_estoque       PecasEstoque?   @relation(fields: [id_pecas_estoque], references: [id_pecas_estoque])
    
    // Relacionamento com PagamentoPeca
    pagamentos_peca     PagamentoPeca[]

    @@map("itens_os")
}

// Nova Entidade: Fornecedor
model Fornecedor {
    id_fornecedor Int      @id @default(autoincrement())
    
    // Identifica√ß√£o
    tipo_pessoa   String?  @default("JURIDICA") @db.VarChar(20) // FISICA ou JURIDICA
    nome          String   @db.VarChar(100) // Raz√£o Social / Nome Completo
    nome_fantasia String?  @db.VarChar(100)
    documento     String?  @db.VarChar(20) // CPF ou CNPJ
    inscricao_estadual String? @db.VarChar(50)
    inscricao_municipal String? @db.VarChar(50)

    // Contato
    contato       String?  @db.VarChar(100) // Nome do vendedor/contato
    telefone      String?  @db.VarChar(20)
    whatsapp      String?  @db.VarChar(20)
    email         String?  @db.VarChar(100)

    // Endere√ßo
    cep           String?  @db.VarChar(10)
    logradouro    String?  @db.VarChar(150)
    numero        String?  @db.VarChar(20)
    complemento   String?  @db.VarChar(100)
    bairro        String?  @db.VarChar(100)
    cidade        String?  @db.VarChar(100)
    uf            String?  @db.Char(2)

    // Financeiro
    banco         String?  @db.VarChar(50)
    agencia       String?  @db.VarChar(20)
    conta         String?  @db.VarChar(20)
    chave_pix     String?  @db.VarChar(100)
    condicoes_pagamento String? @db.VarChar(100)
    categoria_produto   String? @db.VarChar(100)

    // Extras
    obs           String?  @db.VarChar(500)
    dt_cadastro   DateTime @default(now()) @db.Timestamp()
    
    pagamentos_peca PagamentoPeca[]
    entradas_estoque EntradaEstoque[] 

    @@map("fornecedor")
}

// Nova Entidade: PagamentoPeca (Rastreio de Custo Real)
model PagamentoPeca {
    id_pagamento_peca     Int      @id @default(autoincrement())
    id_item_os            Int
    id_fornecedor         Int
    
    custo_real            Decimal  @db.Decimal(10, 2)
    data_compra           DateTime @db.Timestamp()
    data_pagamento_fornecedor DateTime? @db.Timestamp()
    pago_ao_fornecedor    Boolean  @default(false)
    deleted_at            DateTime? @db.Timestamp()
    
    id_livro_caixa        Int?     @unique
    livro_caixa           LivroCaixa? @relation(fields: [id_livro_caixa], references: [id_livro_caixa])

    item_os               ItensOs  @relation(fields: [id_item_os], references: [id_iten])
    fornecedor            Fornecedor @relation(fields: [id_fornecedor], references: [id_fornecedor])

    @@map("pagamento_peca")
}

// Nova Entidade: FechamentoFinanceiro (Substitui Finalizacao)
model FechamentoFinanceiro {
    id_fechamento_financeiro Int      @id @default(autoincrement())
    id_os                    Int      @unique
    custo_total_pecas_real   Decimal  @db.Decimal(10, 2)
    data_fechamento_financeiro DateTime @default(now()) @db.Timestamp()
    deleted_at               DateTime? @db.Timestamp()
    
    ordem_de_servico         OrdemDeServico @relation(fields: [id_os], references: [id_os])

    @@map("fechamento_financeiro")
}

// Nova Entidade: PagamentoCliente (Recebimentos)
model PagamentoCliente {
    id_pagamento_cliente  Int      @id @default(autoincrement())
    id_os                 Int      
    
    metodo_pagamento      String   @db.VarChar(50) // 'CREDITO', 'DEBITO', 'PIX', 'DINHEIRO'
    valor                 Decimal  @db.Decimal(10, 2)
    data_pagamento        DateTime @default(now()) @db.Timestamp()
    deleted_at            DateTime? @db.Timestamp()
    
    // Detalhes
    bandeira_cartao       String?  @db.VarChar(50) // 'VISA', 'MASTER', 'ELO'
    codigo_transacao      String?  @db.VarChar(100) // NSU, ID PIX
    qtd_parcelas          Int      @default(1)
    id_operadora          Int?     // Operadora de cart√£o (se aplic√°vel)
    operadora             OperadoraCartao? @relation(fields: [id_operadora], references: [id_operadora])

    id_conta_bancaria     Int?     // Conta banc√°ria (para PIX e Dinheiro)
    conta_bancaria        ContaBancaria? @relation(fields: [id_conta_bancaria], references: [id_conta])
    
    // V√≠nculo com Livro Caixa (lan√ßamento de faturamento)
    id_livro_caixa        Int?     @unique
    livro_caixa           LivroCaixa? @relation(fields: [id_livro_caixa], references: [id_livro_caixa])
    
    ordem_de_servico      OrdemDeServico @relation(fields: [id_os], references: [id_os])

    @@map("pagamento_cliente")
}

model ServicoMaoDeObra {
    id_servico_mao_de_obra Int      @id @default(autoincrement())
    id_os                 Int
    id_funcionario        Int
    valor                 Decimal  @db.Decimal(10, 2)
    descricao             String?  @db.VarChar(255)
    
    dt_cadastro           DateTime @default(now()) @db.Timestamp()
    deleted_at            DateTime? @db.Timestamp()

    // Controle Financeiro
    status_pagamento      String   @default("PENDENTE") @db.VarChar(20) // 'PENDENTE', 'PAGO'
    id_pagamento_equipe   Int?
    pagamento_equipe      PagamentoEquipe? @relation(fields: [id_pagamento_equipe], references: [id_pagamento_equipe])
    
    ordem_de_servico      OrdemDeServico @relation(fields: [id_os], references: [id_os])
    funcionario           Funcionario    @relation(fields: [id_funcionario], references: [id_funcionario])

    @@map("servico_mao_de_obra")
}

model AuditLog {
    id_log          Int      @id @default(autoincrement())
    tabela          String   @db.VarChar(50)
    registro_id     Int
    acao            String   @db.VarChar(50) 
    valor_antigo    String?  @db.Text
    valor_novo      String?  @db.Text
    usuario_id      Int?
    dt_criacao      DateTime @default(now()) @db.Timestamp()

    @@map("audit_log")
}

// Nova Tabela: Contas a Pagar (Despesas Gerais)
model ContasPagar {
    id_conta_pagar      Int      @id @default(autoincrement())
    descricao           String   @db.VarChar(255)
    valor               Decimal  @db.Decimal(10, 2)
    dt_vencimento       DateTime @db.Date
    dt_pagamento        DateTime? @db.Date
    status              String   @db.VarChar(20) // 'PENDENTE', 'PAGO'
    categoria           String?  @db.VarChar(50) // 'AGUA', 'LUZ', 'ALUGUEL', 'INTERNET', 'OUTROS'
    
    // Novos campos
    credor              String?  @db.VarChar(100)
    dt_emissao          DateTime? @db.Date
    num_documento       String?  @db.VarChar(50)
    forma_pagamento     String?  @db.VarChar(50)
    url_anexo           String?  @db.VarChar(500)
    
    obs                 String?  @db.VarChar(500)
    
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    updated_at          DateTime @default(now()) @updatedAt @db.Timestamp()
    deleted_at          DateTime? @db.Timestamp()

    @@map("contas_pagar")
}

// ---------------------------------------------------------
// M√ìDULO FINANCEIRO AVAN√áADO (LIVRO CAIXA E EQUIPE)
// ---------------------------------------------------------

// Tabela 13: Pagamento de Equipe (Comiss√µes e Sal√°rios Consolidados)
model PagamentoEquipe {
    id_pagamento_equipe Int      @id @default(autoincrement())
    id_funcionario      Int
    
    valor_total         Decimal  @db.Decimal(10, 2)
    forma_pagamento     String?  @db.VarChar(50) 
    premio_valor        Decimal? @db.Decimal(10, 2)
    premio_descricao    String?  @db.VarChar(255)
    dt_pagamento        DateTime @default(now()) @db.Timestamp()
    
    tipo_lancamento     String   @default("COMISSAO") @db.VarChar(50) // 'COMISSAO', 'SALARIO', 'VALE'
    referencia_inicio   DateTime? @db.Date // Para Sal√°rio/Vale
    referencia_fim      DateTime? @db.Date // Para Sal√°rio/Vale
    
    obs                 String?  @db.VarChar(500)

    // Controle de Vales/Adiantamentos (Novo)
    descontado          Boolean  @default(false) // Indica se esse VALE j√° foi descontado de um sal√°rio futuro
    id_pagamento_deducao Int?     // ID do pagamento que descontou este vale
    pagamento_deducao   PagamentoEquipe? @relation("DeducaoVale", fields: [id_pagamento_deducao], references: [id_pagamento_equipe])
    vales_deduzidos     PagamentoEquipe[] @relation("DeducaoVale")
    
    // Rela√ß√µes
    funcionario         Funcionario @relation(fields: [id_funcionario], references: [id_funcionario])
    servicos_pagos      ServicoMaoDeObra[] // 1 Pagamento pode quitar v√°rios servi√ßos
    movimentacoes_caixa LivroCaixa[]       // Gera 1 ou mais sa√≠das no caixa

    @@map("pagamento_equipe")
}

// Tabela 14: Livro Caixa (Registro Central de Movimenta√ß√µes)
model LivroCaixa {
    id_livro_caixa      Int      @id @default(autoincrement())
    descricao           String   @db.VarChar(255)
    valor               Decimal  @db.Decimal(10, 2)
    tipo_movimentacao   String   @db.VarChar(10) // 'ENTRADA' ou 'SAIDA'
    categoria           String   @db.VarChar(50) // 'EQUIPE', 'FORNECEDOR', 'VENDA', 'OUTROS'
    dt_movimentacao     DateTime @default(now()) @db.Timestamp()
    
    // New fields
    obs                 String?  @db.VarChar(500)
    origem              String   @default("MANUAL") @db.VarChar(20) // 'MANUAL' or 'AUTOMATICA'
    deleted_at          DateTime? @db.Timestamp()

    id_conta_bancaria   Int?
    conta               ContaBancaria? @relation(fields: [id_conta_bancaria], references: [id_conta])

    // Rastreabilidade (Opcional)
    id_pagamento_equipe Int?
    pagamento_equipe    PagamentoEquipe? @relation(fields: [id_pagamento_equipe], references: [id_pagamento_equipe])
    
    pagamento_peca      PagamentoPeca?
    pagamento_cliente   PagamentoCliente?

    @@map("livro_caixa")
}


model CategoriaFinanceira {
    id_categoria    Int      @id @default(autoincrement())
    nome            String   @unique @db.VarChar(50)
    tipo            String   @db.VarChar(10) // 'ENTRADA', 'SAIDA', 'AMBOS'
    dt_cadastro     DateTime @default(now()) @db.Timestamp()

    @@map("categoria_financeira")
}

// ---------------------------------------------------------
// M√ìDULO ESTOQUE (ENTRADAS E COMPRAS)
// ---------------------------------------------------------

model EntradaEstoque {
    id_entrada      Int      @id @default(autoincrement())
    id_fornecedor   Int
    
    nota_fiscal     String?  @db.VarChar(50)
    data_compra     DateTime @default(now()) @db.Timestamp()
    valor_total     Decimal  @db.Decimal(10, 2)
    obs             String?  @db.VarChar(500)
    
    created_at      DateTime @default(now()) @db.Timestamp()

    // Rela√ß√µes
    fornecedor      Fornecedor @relation(fields: [id_fornecedor], references: [id_fornecedor])
    itens           ItemEntrada[]

    @@map("entrada_estoque")
}

model ItemEntrada {
    id_item_entrada   Int      @id @default(autoincrement())
    id_entrada        Int
    id_pecas_estoque  Int

    quantidade        Int
    valor_custo       Decimal  @db.Decimal(10, 2)
    margem_lucro      Decimal? @db.Decimal(10, 2) // Porcentagem
    valor_venda       Decimal  @db.Decimal(10, 2)
    
    ref_cod           String?  @db.VarChar(50)
    obs               String?  @db.VarChar(255)

    // Rela√ß√µes
    entrada           EntradaEstoque @relation(fields: [id_entrada], references: [id_entrada])
    peca              PecasEstoque   @relation(fields: [id_pecas_estoque], references: [id_pecas_estoque])

    @@map("item_entrada")
}

// ---------------------------------------------------------
// M√ìDULO INTELIG√äNCIA FINANCEIRA (MULTICONTAS E CART√ïES)
// ---------------------------------------------------------

model ContaBancaria {
  id_conta        Int          @id @default(autoincrement())
  nome            String       @db.VarChar(50) // "Caixa Geral", "Ita√∫ Empresas"
  banco           String?      @db.VarChar(50)
  agencia         String?      @db.VarChar(20)
  conta           String?      @db.VarChar(20)
  saldo_atual     Decimal      @default(0) @db.Decimal(12, 2)
  ativo           Boolean      @default(true)
  vincular_caixa  Boolean      @default(false) // Se TRUE, movimenta√ß√µes geram lan√ßamento no Livro Caixa
  
  dt_cadastro     DateTime     @default(now()) @db.Timestamp()

  movimentacoes   LivroCaixa[]      
  operadoras      OperadoraCartao[] 
  pagamentos_cliente PagamentoCliente[] 
  
  @@map("conta_bancaria")
}

model OperadoraCartao {
  id_operadora          Int      @id @default(autoincrement())
  nome                  String   @db.VarChar(50) // "Stone", "Cielo"
  vincular_caixa        Boolean  @default(false) // Se TRUE, ativa gest√£o de receb√≠veis
  
  // Taxas e Prazos
  taxa_debito           Decimal  @default(0) @db.Decimal(5, 2)
  prazo_debito          Int      @default(1) // Dias
  
  taxa_credito_vista    Decimal  @default(0) @db.Decimal(5, 2)
  prazo_credito_vista   Int      @default(30)
  
  taxa_credito_parc     Decimal  @default(0) @db.Decimal(5, 2)
  prazo_credito_parc    Int      @default(30)
  
  taxa_antecipacao      Decimal  @default(0) @db.Decimal(5, 2)
  antecipacao_auto      Boolean  @default(false)
  
  // Destino Autom√°tico
  id_conta_destino      Int
  conta_destino         ContaBancaria @relation(fields: [id_conta_destino], references: [id_conta])
  
  recebiveis            RecebivelCartao[]
  pagamentos_cliente    PagamentoCliente[]

  @@map("operadora_cartao")
}

model RecebivelCartao {
  id_recebivel      Int      @id @default(autoincrement())
  id_os             Int?     
  id_operadora      Int
  
  num_parcela       Int      @default(1)
  total_parcelas    Int      @default(1)
  
  valor_bruto       Decimal  @db.Decimal(10, 2)
  valor_liquido     Decimal  @db.Decimal(10, 2) 
  taxa_aplicada     Decimal  @db.Decimal(10, 2)
  
  data_venda        DateTime @default(now()) @db.Date
  data_prevista     DateTime @db.Date 
  data_recebimento  DateTime? @db.Date 
  
  status            String   @default("PENDENTE") // 'PENDENTE', 'RECEBIDO'
  
  // Rastreabilidade de confirma√ß√£o
  confirmado_em     DateTime? @db.Timestamp()
  confirmado_por    String?   @db.VarChar(100)
  
  operadora         OperadoraCartao @relation(fields: [id_operadora], references: [id_operadora])
  ordem_de_servico  OrdemDeServico? @relation(fields: [id_os], references: [id_os])

  @@map("recebivel_cartao")
}


================================================================================
FILE PATH: server\prisma\seed.ts
================================================================================
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  console.log('üå± Starting seed...');

  // 1. Seed Tipos
  const tipos = [
    { id_tipo: 1, funcao: 'Cliente' },
    { id_tipo: 2, funcao: 'Funcion√°rio' },
    { id_tipo: 3, funcao: 'Fornecedor' },
  ];

  for (const t of tipos) {
    const tipo = await prisma.tipo.upsert({
      where: { id_tipo: t.id_tipo },
      update: {},
      create: t,
    });
    console.log(`Created Tipo: ${tipo.funcao} (ID: ${tipo.id_tipo})`);
  }

  // 2. Seed a default Employee (Funcionario)
  const existingFunc = await prisma.funcionario.findFirst();
  if (!existingFunc) {
      console.log('üë∑ Creating default employee...');
      const pessoa = await prisma.pessoa.create({
          data: {
              nome: 'Mec√¢nico Padr√£o',
              genero: 'Masculino'
          }
      });

      const pessoaFisica = await prisma.pessoaFisica.create({
          data: {
              id_pessoa: pessoa.id_pessoa,
              cpf: '00000000000'
          }
      });

      await prisma.funcionario.create({
          data: {
              id_pessoa_fisica: pessoaFisica.id_pessoa_fisica,
              ativo: 'S',
              cargo: 'Mec√¢nico',
              dt_admissao: new Date()
          }
      });
      console.log('‚úÖ Default employee created.');
  }

  console.log('‚úÖ Seed finished.');
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });



================================================================================
FILE PATH: server\prisma\migrations\migration_lock.toml
================================================================================
# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "postgresql"


================================================================================
FILE PATH: server\prisma\migrations\20251208001043_init_full_schema\migration.sql
================================================================================
-- CreateTable
CREATE TABLE "pessoa" (
    "id_pessoa" SERIAL NOT NULL,
    "nome" VARCHAR(100) NOT NULL,
    "genero" VARCHAR(20),
    "dt_nascimento" DATE,
    "obs" VARCHAR(500),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "pessoa_pkey" PRIMARY KEY ("id_pessoa")
);

-- CreateTable
CREATE TABLE "pessoa_fisica" (
    "id_pessoa_fisica" SERIAL NOT NULL,
    "id_pessoa" INTEGER NOT NULL,
    "cpf" VARCHAR(11),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "pessoa_fisica_pkey" PRIMARY KEY ("id_pessoa_fisica")
);

-- CreateTable
CREATE TABLE "pessoa_juridica" (
    "id_pessoa_juridica" SERIAL NOT NULL,
    "id_pessoa" INTEGER NOT NULL,
    "razao_social" VARCHAR(100) NOT NULL,
    "nome_fantasia" VARCHAR(100),
    "cnpj" VARCHAR(14),
    "inscricao_estadual" VARCHAR(50),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "pessoa_juridica_pkey" PRIMARY KEY ("id_pessoa_juridica")
);

-- CreateTable
CREATE TABLE "tipo" (
    "id_tipo" SERIAL NOT NULL,
    "funcao" VARCHAR(50),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "tipo_pkey" PRIMARY KEY ("id_tipo")
);

-- CreateTable
CREATE TABLE "cliente" (
    "id_cliente" SERIAL NOT NULL,
    "id_pessoa_fisica" INTEGER,
    "id_pessoa_juridica" INTEGER,
    "tipo_pessoa" INTEGER NOT NULL,
    "telefone_1" VARCHAR(15) NOT NULL,
    "telefone_2" VARCHAR(15),
    "telefone_3" VARCHAR(15),
    "email" VARCHAR(100),
    "logradouro" VARCHAR(150) NOT NULL,
    "nr_logradouro" VARCHAR(10) NOT NULL,
    "compl_logradouro" VARCHAR(50),
    "bairro" VARCHAR(100) NOT NULL,
    "cidade" VARCHAR(100) NOT NULL,
    "estado" CHAR(2) NOT NULL,
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "cliente_pkey" PRIMARY KEY ("id_cliente")
);

-- CreateTable
CREATE TABLE "funcionario" (
    "id_funcionario" SERIAL NOT NULL,
    "id_pessoa_fisica" INTEGER NOT NULL,
    "ativo" CHAR(1) NOT NULL,
    "cargo" VARCHAR(50) NOT NULL,
    "salario" DECIMAL(10,2),
    "comissao" INTEGER,
    "dt_admissao" TIMESTAMP NOT NULL,
    "dt_recisao" TIMESTAMP,
    "motivo_saida" VARCHAR(200),
    "obs" VARCHAR(500),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "funcionario_pkey" PRIMARY KEY ("id_funcionario")
);

-- CreateTable
CREATE TABLE "pecas_estoque" (
    "id_pecas_estoque" SERIAL NOT NULL,
    "fabricante" VARCHAR(50),
    "nome" VARCHAR(255) NOT NULL,
    "descricao" VARCHAR(255) NOT NULL,
    "valor_custo" DECIMAL(10,2) NOT NULL,
    "valor_venda" DECIMAL(10,2) NOT NULL,
    "estoque_atual" INTEGER NOT NULL,
    "unidade_medida" VARCHAR(20),
    "dt_ultima_compra" TIMESTAMP,
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "pecas_estoque_pkey" PRIMARY KEY ("id_pecas_estoque")
);

-- CreateTable
CREATE TABLE "veiculo" (
    "id_veiculo" SERIAL NOT NULL,
    "id_cliente" INTEGER NOT NULL,
    "placa" VARCHAR(8) NOT NULL,
    "chassi" VARCHAR(20),
    "marca" VARCHAR(50) NOT NULL,
    "modelo" VARCHAR(50) NOT NULL,
    "versao" VARCHAR(50),
    "ano_modelo" VARCHAR(10) NOT NULL,
    "cor" VARCHAR(30) NOT NULL,
    "combustivel" VARCHAR(20) NOT NULL,
    "obs" VARCHAR(500),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "veiculo_pkey" PRIMARY KEY ("id_veiculo")
);

-- CreateTable
CREATE TABLE "ordem_de_servico" (
    "id_os" SERIAL NOT NULL,
    "id_cliente" INTEGER NOT NULL,
    "id_veiculo" INTEGER NOT NULL,
    "id_funcionario" INTEGER NOT NULL,
    "dt_abertura" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "dt_entrega" TIMESTAMP,
    "km_entrada" INTEGER NOT NULL,
    "status" VARCHAR(20) NOT NULL,
    "defeito_relatado" VARCHAR(500),
    "diagnostico" VARCHAR(500),
    "valor_servico" DECIMAL(10,2),
    "valor_pecas" DECIMAL(10,2),
    "valor_final" DECIMAL(12,2),
    "modo_pagamento" VARCHAR(50),
    "cod_pagamento" VARCHAR(80),
    "parcelas" INTEGER NOT NULL,
    "obs" VARCHAR(500),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "ordem_de_servico_pkey" PRIMARY KEY ("id_os")
);

-- CreateTable
CREATE TABLE "itens_os" (
    "id_iten" SERIAL NOT NULL,
    "id_os" INTEGER NOT NULL,
    "id_pecas_estoque" INTEGER,
    "descricao" VARCHAR(500) NOT NULL,
    "qtd" INTEGER NOT NULL,
    "valor_unt" DECIMAL(10,2) NOT NULL,
    "valor_total" DECIMAL(12,2) NOT NULL,
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "itens_os_pkey" PRIMARY KEY ("id_iten")
);

-- CreateTable
CREATE TABLE "finalizacao" (
    "id_finalizacao" SERIAL NOT NULL,
    "id_os" INTEGER NOT NULL,
    "valor_peca_entrada" DECIMAL(10,2),
    "valor_peca_saida" DECIMAL(10,2),
    "valor_pago_funcionario" DECIMAL(10,2),
    "obs" VARCHAR(500),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "finalizacao_pkey" PRIMARY KEY ("id_finalizacao")
);

-- CreateIndex
CREATE UNIQUE INDEX "pessoa_fisica_id_pessoa_key" ON "pessoa_fisica"("id_pessoa");

-- CreateIndex
CREATE UNIQUE INDEX "pessoa_fisica_cpf_key" ON "pessoa_fisica"("cpf");

-- CreateIndex
CREATE UNIQUE INDEX "pessoa_juridica_id_pessoa_key" ON "pessoa_juridica"("id_pessoa");

-- CreateIndex
CREATE UNIQUE INDEX "pessoa_juridica_cnpj_key" ON "pessoa_juridica"("cnpj");

-- CreateIndex
CREATE INDEX "cliente_id_pessoa_fisica_idx" ON "cliente"("id_pessoa_fisica");

-- CreateIndex
CREATE INDEX "cliente_id_pessoa_juridica_idx" ON "cliente"("id_pessoa_juridica");

-- CreateIndex
CREATE INDEX "cliente_tipo_pessoa_idx" ON "cliente"("tipo_pessoa");

-- CreateIndex
CREATE UNIQUE INDEX "funcionario_id_pessoa_fisica_key" ON "funcionario"("id_pessoa_fisica");

-- CreateIndex
CREATE UNIQUE INDEX "veiculo_placa_key" ON "veiculo"("placa");

-- CreateIndex
CREATE UNIQUE INDEX "finalizacao_id_os_key" ON "finalizacao"("id_os");

-- AddForeignKey
ALTER TABLE "pessoa_fisica" ADD CONSTRAINT "pessoa_fisica_id_pessoa_fkey" FOREIGN KEY ("id_pessoa") REFERENCES "pessoa"("id_pessoa") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pessoa_juridica" ADD CONSTRAINT "pessoa_juridica_id_pessoa_fkey" FOREIGN KEY ("id_pessoa") REFERENCES "pessoa"("id_pessoa") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "cliente" ADD CONSTRAINT "cliente_id_pessoa_fisica_fkey" FOREIGN KEY ("id_pessoa_fisica") REFERENCES "pessoa_fisica"("id_pessoa_fisica") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "cliente" ADD CONSTRAINT "cliente_id_pessoa_juridica_fkey" FOREIGN KEY ("id_pessoa_juridica") REFERENCES "pessoa_juridica"("id_pessoa_juridica") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "cliente" ADD CONSTRAINT "cliente_tipo_pessoa_fkey" FOREIGN KEY ("tipo_pessoa") REFERENCES "tipo"("id_tipo") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "funcionario" ADD CONSTRAINT "funcionario_id_pessoa_fisica_fkey" FOREIGN KEY ("id_pessoa_fisica") REFERENCES "pessoa_fisica"("id_pessoa_fisica") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "veiculo" ADD CONSTRAINT "veiculo_id_cliente_fkey" FOREIGN KEY ("id_cliente") REFERENCES "cliente"("id_cliente") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "ordem_de_servico" ADD CONSTRAINT "ordem_de_servico_id_cliente_fkey" FOREIGN KEY ("id_cliente") REFERENCES "cliente"("id_cliente") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "ordem_de_servico" ADD CONSTRAINT "ordem_de_servico_id_veiculo_fkey" FOREIGN KEY ("id_veiculo") REFERENCES "veiculo"("id_veiculo") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "ordem_de_servico" ADD CONSTRAINT "ordem_de_servico_id_funcionario_fkey" FOREIGN KEY ("id_funcionario") REFERENCES "funcionario"("id_funcionario") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "itens_os" ADD CONSTRAINT "itens_os_id_os_fkey" FOREIGN KEY ("id_os") REFERENCES "ordem_de_servico"("id_os") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "itens_os" ADD CONSTRAINT "itens_os_id_pecas_estoque_fkey" FOREIGN KEY ("id_pecas_estoque") REFERENCES "pecas_estoque"("id_pecas_estoque") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "finalizacao" ADD CONSTRAINT "finalizacao_id_os_fkey" FOREIGN KEY ("id_os") REFERENCES "ordem_de_servico"("id_os") ON DELETE RESTRICT ON UPDATE CASCADE;



================================================================================
FILE PATH: server\prisma\migrations\20251216160147_init_v3\migration.sql
================================================================================
/*
  Warnings:

  - You are about to drop the column `qtd` on the `itens_os` table. All the data in the column will be lost.
  - You are about to drop the column `valor_unt` on the `itens_os` table. All the data in the column will be lost.
  - You are about to drop the `finalizacao` table. If the table is not empty, all the data it contains will be lost.
  - Added the required column `quantidade` to the `itens_os` table without a default value. This is not possible if the table is not empty.
  - Added the required column `valor_venda` to the `itens_os` table without a default value. This is not possible if the table is not empty.

*/
-- DropForeignKey
ALTER TABLE "finalizacao" DROP CONSTRAINT "finalizacao_id_os_fkey";

-- AlterTable
ALTER TABLE "itens_os" DROP COLUMN "qtd",
DROP COLUMN "valor_unt",
ADD COLUMN     "quantidade" INTEGER NOT NULL,
ADD COLUMN     "valor_venda" DECIMAL(10,2) NOT NULL;

-- AlterTable
ALTER TABLE "ordem_de_servico" ADD COLUMN     "valor_mao_de_obra" DECIMAL(10,2),
ADD COLUMN     "valor_total_cliente" DECIMAL(10,2);

-- AlterTable
ALTER TABLE "pecas_estoque" ADD COLUMN     "custo_unitario_padrao" DECIMAL(10,2) NOT NULL DEFAULT 0;

-- DropTable
DROP TABLE "finalizacao";

-- CreateTable
CREATE TABLE "fornecedor" (
    "id_fornecedor" SERIAL NOT NULL,
    "nome" VARCHAR(100) NOT NULL,
    "documento" VARCHAR(20),
    "contato" VARCHAR(100),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "fornecedor_pkey" PRIMARY KEY ("id_fornecedor")
);

-- CreateTable
CREATE TABLE "pagamento_peca" (
    "id_pagamento_peca" SERIAL NOT NULL,
    "id_item_os" INTEGER NOT NULL,
    "id_fornecedor" INTEGER NOT NULL,
    "custo_real" DECIMAL(10,2) NOT NULL,
    "data_compra" TIMESTAMP NOT NULL,
    "data_pagamento_fornecedor" TIMESTAMP,
    "pago_ao_fornecedor" BOOLEAN NOT NULL DEFAULT false,

    CONSTRAINT "pagamento_peca_pkey" PRIMARY KEY ("id_pagamento_peca")
);

-- CreateTable
CREATE TABLE "fechamento_financeiro" (
    "id_fechamento_financeiro" SERIAL NOT NULL,
    "id_os" INTEGER NOT NULL,
    "custo_total_pecas_real" DECIMAL(10,2) NOT NULL,
    "data_fechamento_financeiro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "fechamento_financeiro_pkey" PRIMARY KEY ("id_fechamento_financeiro")
);

-- CreateIndex
CREATE UNIQUE INDEX "fechamento_financeiro_id_os_key" ON "fechamento_financeiro"("id_os");

-- AddForeignKey
ALTER TABLE "pagamento_peca" ADD CONSTRAINT "pagamento_peca_id_item_os_fkey" FOREIGN KEY ("id_item_os") REFERENCES "itens_os"("id_iten") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pagamento_peca" ADD CONSTRAINT "pagamento_peca_id_fornecedor_fkey" FOREIGN KEY ("id_fornecedor") REFERENCES "fornecedor"("id_fornecedor") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "fechamento_financeiro" ADD CONSTRAINT "fechamento_financeiro_id_os_fkey" FOREIGN KEY ("id_os") REFERENCES "ordem_de_servico"("id_os") ON DELETE RESTRICT ON UPDATE CASCADE;



================================================================================
FILE PATH: server\prisma\migrations\20251216195722_migrate161220251657\migration.sql
================================================================================
-- DropIndex
DROP INDEX "pessoa_fisica_cpf_key";



================================================================================
FILE PATH: server\prisma\migrations\20251218194757_make_address_optional\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "cliente" ALTER COLUMN "logradouro" DROP NOT NULL,
ALTER COLUMN "nr_logradouro" DROP NOT NULL,
ALTER COLUMN "bairro" DROP NOT NULL,
ALTER COLUMN "cidade" DROP NOT NULL,
ALTER COLUMN "estado" DROP NOT NULL;



================================================================================
FILE PATH: server\prisma\migrations\20251218212849_migration_181220251828\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "ordem_de_servico" ADD COLUMN     "obs_final" VARCHAR(500);



================================================================================
FILE PATH: server\prisma\migrations\20251218225607_181220251956\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "ordem_de_servico" ALTER COLUMN "status" SET DATA TYPE VARCHAR(50);



================================================================================
FILE PATH: server\prisma\migrations\20251220222534_201220251925\migration.sql
================================================================================
-- CreateTable
CREATE TABLE "pagamento_cliente" (
    "id_pagamento_cliente" SERIAL NOT NULL,
    "id_os" INTEGER NOT NULL,
    "metodo_pagamento" VARCHAR(50) NOT NULL,
    "valor" DECIMAL(10,2) NOT NULL,
    "data_pagamento" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "bandeira_cartao" VARCHAR(50),
    "codigo_transacao" VARCHAR(100),
    "qtd_parcelas" INTEGER NOT NULL DEFAULT 1,

    CONSTRAINT "pagamento_cliente_pkey" PRIMARY KEY ("id_pagamento_cliente")
);

-- AddForeignKey
ALTER TABLE "pagamento_cliente" ADD CONSTRAINT "pagamento_cliente_id_os_fkey" FOREIGN KEY ("id_os") REFERENCES "ordem_de_servico"("id_os") ON DELETE RESTRICT ON UPDATE CASCADE;



================================================================================
FILE PATH: server\prisma\migrations\20251220230657_201220252006\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "itens_os" ADD COLUMN     "codigo_referencia" VARCHAR(50);



================================================================================
FILE PATH: server\prisma\migrations\20251223140348_enable_unaccent\migration.sql
================================================================================
CREATE EXTENSION IF NOT EXISTS unaccent;


================================================================================
FILE PATH: server\prisma\migrations\20251223143540_multi_labor_audit_soft_delete\migration.sql
================================================================================
-- DropForeignKey
ALTER TABLE "ordem_de_servico" DROP CONSTRAINT "ordem_de_servico_id_funcionario_fkey";

-- AlterTable
ALTER TABLE "fechamento_financeiro" ADD COLUMN     "deleted_at" TIMESTAMP;

-- AlterTable
ALTER TABLE "ordem_de_servico" ADD COLUMN     "deleted_at" TIMESTAMP,
ALTER COLUMN "id_funcionario" DROP NOT NULL;

-- AlterTable
ALTER TABLE "pagamento_cliente" ADD COLUMN     "deleted_at" TIMESTAMP;

-- AlterTable
ALTER TABLE "pagamento_peca" ADD COLUMN     "deleted_at" TIMESTAMP;

-- CreateTable
CREATE TABLE "servico_mao_de_obra" (
    "id_servico_mao_de_obra" SERIAL NOT NULL,
    "id_os" INTEGER NOT NULL,
    "id_funcionario" INTEGER NOT NULL,
    "valor" DECIMAL(10,2) NOT NULL,
    "descricao" VARCHAR(255),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "deleted_at" TIMESTAMP,

    CONSTRAINT "servico_mao_de_obra_pkey" PRIMARY KEY ("id_servico_mao_de_obra")
);

-- CreateTable
CREATE TABLE "audit_log" (
    "id_log" SERIAL NOT NULL,
    "tabela" VARCHAR(50) NOT NULL,
    "registro_id" INTEGER NOT NULL,
    "acao" VARCHAR(50) NOT NULL,
    "valor_antigo" TEXT,
    "valor_novo" TEXT,
    "usuario_id" INTEGER,
    "dt_criacao" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "audit_log_pkey" PRIMARY KEY ("id_log")
);

-- AddForeignKey
ALTER TABLE "ordem_de_servico" ADD CONSTRAINT "ordem_de_servico_id_funcionario_fkey" FOREIGN KEY ("id_funcionario") REFERENCES "funcionario"("id_funcionario") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "servico_mao_de_obra" ADD CONSTRAINT "servico_mao_de_obra_id_os_fkey" FOREIGN KEY ("id_os") REFERENCES "ordem_de_servico"("id_os") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "servico_mao_de_obra" ADD CONSTRAINT "servico_mao_de_obra_id_funcionario_fkey" FOREIGN KEY ("id_funcionario") REFERENCES "funcionario"("id_funcionario") ON DELETE RESTRICT ON UPDATE CASCADE;



================================================================================
FILE PATH: server\prisma\migrations\20251223143630_add_soft_delete_to_itens_os\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "itens_os" ADD COLUMN     "deleted_at" TIMESTAMP;



================================================================================
FILE PATH: server\prisma\migrations\20260103205456_add_indexes_os\migration.sql
================================================================================
-- CreateIndex
CREATE INDEX "ordem_de_servico_id_cliente_idx" ON "ordem_de_servico"("id_cliente");

-- CreateIndex
CREATE INDEX "ordem_de_servico_id_veiculo_idx" ON "ordem_de_servico"("id_veiculo");

-- CreateIndex
CREATE INDEX "ordem_de_servico_status_idx" ON "ordem_de_servico"("status");

-- CreateIndex
CREATE INDEX "ordem_de_servico_deleted_at_idx" ON "ordem_de_servico"("deleted_at");



================================================================================
FILE PATH: server\prisma\migrations\20260104015042_add_contas_pagar_updated_at\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "ordem_de_servico" ADD COLUMN     "updated_at" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP;

-- CreateTable
CREATE TABLE "contas_pagar" (
    "id_conta_pagar" SERIAL NOT NULL,
    "descricao" VARCHAR(255) NOT NULL,
    "valor" DECIMAL(10,2) NOT NULL,
    "dt_vencimento" DATE NOT NULL,
    "dt_pagamento" DATE,
    "status" VARCHAR(20) NOT NULL,
    "categoria" VARCHAR(50),
    "obs" VARCHAR(500),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "deleted_at" TIMESTAMP,

    CONSTRAINT "contas_pagar_pkey" PRIMARY KEY ("id_conta_pagar")
);



================================================================================
FILE PATH: server\prisma\migrations\20260110143752_stock_module_v1\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "servico_mao_de_obra" ADD COLUMN     "id_pagamento_equipe" INTEGER,
ADD COLUMN     "status_pagamento" VARCHAR(20) NOT NULL DEFAULT 'PENDENTE';

-- CreateTable
CREATE TABLE "pagamento_equipe" (
    "id_pagamento_equipe" SERIAL NOT NULL,
    "id_funcionario" INTEGER NOT NULL,
    "valor_total" DECIMAL(10,2) NOT NULL,
    "forma_pagamento" VARCHAR(50),
    "premio_valor" DECIMAL(10,2),
    "premio_descricao" VARCHAR(255),
    "dt_pagamento" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "tipo_lancamento" VARCHAR(50) NOT NULL DEFAULT 'COMISSAO',
    "referencia_inicio" DATE,
    "referencia_fim" DATE,
    "obs" VARCHAR(500),
    "descontado" BOOLEAN NOT NULL DEFAULT false,
    "id_pagamento_deducao" INTEGER,

    CONSTRAINT "pagamento_equipe_pkey" PRIMARY KEY ("id_pagamento_equipe")
);

-- CreateTable
CREATE TABLE "livro_caixa" (
    "id_livro_caixa" SERIAL NOT NULL,
    "descricao" VARCHAR(255) NOT NULL,
    "valor" DECIMAL(10,2) NOT NULL,
    "tipo_movimentacao" VARCHAR(10) NOT NULL,
    "categoria" VARCHAR(50) NOT NULL,
    "dt_movimentacao" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "obs" VARCHAR(500),
    "origem" VARCHAR(20) NOT NULL DEFAULT 'MANUAL',
    "deleted_at" TIMESTAMP,
    "id_pagamento_equipe" INTEGER,

    CONSTRAINT "livro_caixa_pkey" PRIMARY KEY ("id_livro_caixa")
);

-- CreateTable
CREATE TABLE "categoria_financeira" (
    "id_categoria" SERIAL NOT NULL,
    "nome" VARCHAR(50) NOT NULL,
    "tipo" VARCHAR(10) NOT NULL,
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "categoria_financeira_pkey" PRIMARY KEY ("id_categoria")
);

-- CreateTable
CREATE TABLE "entrada_estoque" (
    "id_entrada" SERIAL NOT NULL,
    "id_fornecedor" INTEGER NOT NULL,
    "nota_fiscal" VARCHAR(50),
    "data_compra" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "valor_total" DECIMAL(10,2) NOT NULL,
    "obs" VARCHAR(500),
    "created_at" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "entrada_estoque_pkey" PRIMARY KEY ("id_entrada")
);

-- CreateTable
CREATE TABLE "item_entrada" (
    "id_item_entrada" SERIAL NOT NULL,
    "id_entrada" INTEGER NOT NULL,
    "id_pecas_estoque" INTEGER NOT NULL,
    "quantidade" INTEGER NOT NULL,
    "valor_custo" DECIMAL(10,2) NOT NULL,
    "margem_lucro" DECIMAL(10,2),
    "valor_venda" DECIMAL(10,2) NOT NULL,
    "ref_cod" VARCHAR(50),
    "obs" VARCHAR(255),

    CONSTRAINT "item_entrada_pkey" PRIMARY KEY ("id_item_entrada")
);

-- CreateIndex
CREATE UNIQUE INDEX "categoria_financeira_nome_key" ON "categoria_financeira"("nome");

-- AddForeignKey
ALTER TABLE "servico_mao_de_obra" ADD CONSTRAINT "servico_mao_de_obra_id_pagamento_equipe_fkey" FOREIGN KEY ("id_pagamento_equipe") REFERENCES "pagamento_equipe"("id_pagamento_equipe") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pagamento_equipe" ADD CONSTRAINT "pagamento_equipe_id_pagamento_deducao_fkey" FOREIGN KEY ("id_pagamento_deducao") REFERENCES "pagamento_equipe"("id_pagamento_equipe") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pagamento_equipe" ADD CONSTRAINT "pagamento_equipe_id_funcionario_fkey" FOREIGN KEY ("id_funcionario") REFERENCES "funcionario"("id_funcionario") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "livro_caixa" ADD CONSTRAINT "livro_caixa_id_pagamento_equipe_fkey" FOREIGN KEY ("id_pagamento_equipe") REFERENCES "pagamento_equipe"("id_pagamento_equipe") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "entrada_estoque" ADD CONSTRAINT "entrada_estoque_id_fornecedor_fkey" FOREIGN KEY ("id_fornecedor") REFERENCES "fornecedor"("id_fornecedor") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "item_entrada" ADD CONSTRAINT "item_entrada_id_entrada_fkey" FOREIGN KEY ("id_entrada") REFERENCES "entrada_estoque"("id_entrada") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "item_entrada" ADD CONSTRAINT "item_entrada_id_pecas_estoque_fkey" FOREIGN KEY ("id_pecas_estoque") REFERENCES "pecas_estoque"("id_pecas_estoque") ON DELETE RESTRICT ON UPDATE CASCADE;



================================================================================
FILE PATH: server\prisma\migrations\20260111224809_add_financial_module\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "contas_pagar" ADD COLUMN     "credor" VARCHAR(100),
ADD COLUMN     "dt_emissao" DATE,
ADD COLUMN     "forma_pagamento" VARCHAR(50),
ADD COLUMN     "num_documento" VARCHAR(50),
ADD COLUMN     "url_anexo" VARCHAR(500);

-- AlterTable
ALTER TABLE "fornecedor" ADD COLUMN     "agencia" VARCHAR(20),
ADD COLUMN     "bairro" VARCHAR(100),
ADD COLUMN     "banco" VARCHAR(50),
ADD COLUMN     "categoria_produto" VARCHAR(100),
ADD COLUMN     "cep" VARCHAR(10),
ADD COLUMN     "chave_pix" VARCHAR(100),
ADD COLUMN     "cidade" VARCHAR(100),
ADD COLUMN     "complemento" VARCHAR(100),
ADD COLUMN     "condicoes_pagamento" VARCHAR(100),
ADD COLUMN     "conta" VARCHAR(20),
ADD COLUMN     "email" VARCHAR(100),
ADD COLUMN     "inscricao_estadual" VARCHAR(50),
ADD COLUMN     "inscricao_municipal" VARCHAR(50),
ADD COLUMN     "logradouro" VARCHAR(150),
ADD COLUMN     "nome_fantasia" VARCHAR(100),
ADD COLUMN     "numero" VARCHAR(20),
ADD COLUMN     "obs" VARCHAR(500),
ADD COLUMN     "telefone" VARCHAR(20),
ADD COLUMN     "tipo_pessoa" VARCHAR(20) DEFAULT 'JURIDICA',
ADD COLUMN     "uf" CHAR(2),
ADD COLUMN     "whatsapp" VARCHAR(20);

-- AlterTable
ALTER TABLE "funcionario" ADD COLUMN     "agencia" VARCHAR(20),
ADD COLUMN     "bairro" VARCHAR(100),
ADD COLUMN     "banco" VARCHAR(50),
ADD COLUMN     "cep" VARCHAR(10),
ADD COLUMN     "chave_pix" VARCHAR(100),
ADD COLUMN     "cidade" VARCHAR(100),
ADD COLUMN     "cnpj_mei" VARCHAR(20),
ADD COLUMN     "comissao_pecas" DECIMAL(5,2),
ADD COLUMN     "complemento" VARCHAR(100),
ADD COLUMN     "conta" VARCHAR(20),
ADD COLUMN     "dia_vencimento" INTEGER,
ADD COLUMN     "email_pessoal" VARCHAR(100),
ADD COLUMN     "equipamentos_epis" TEXT,
ADD COLUMN     "especialidade" VARCHAR(100),
ADD COLUMN     "inscricao_municipal" VARCHAR(50),
ADD COLUMN     "logradouro" VARCHAR(150),
ADD COLUMN     "nome_fantasia" VARCHAR(100),
ADD COLUMN     "numero" VARCHAR(20),
ADD COLUMN     "periodicidade_pagamento" VARCHAR(50),
ADD COLUMN     "razao_social" VARCHAR(100),
ADD COLUMN     "rg" VARCHAR(20),
ADD COLUMN     "telefone_pessoal" VARCHAR(20),
ADD COLUMN     "tipo_pagamento" VARCHAR(50),
ADD COLUMN     "uf" CHAR(2),
ADD COLUMN     "url_ccmei" VARCHAR(500),
ADD COLUMN     "url_cnh" VARCHAR(500),
ADD COLUMN     "valor_pagamento" DECIMAL(10,2);

-- AlterTable
ALTER TABLE "livro_caixa" ADD COLUMN     "id_conta_bancaria" INTEGER;

-- CreateTable
CREATE TABLE "conta_bancaria" (
    "id_conta" SERIAL NOT NULL,
    "nome" VARCHAR(50) NOT NULL,
    "banco" VARCHAR(50),
    "agencia" VARCHAR(20),
    "conta" VARCHAR(20),
    "saldo_atual" DECIMAL(12,2) NOT NULL DEFAULT 0,
    "ativo" BOOLEAN NOT NULL DEFAULT true,
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "conta_bancaria_pkey" PRIMARY KEY ("id_conta")
);

-- CreateTable
CREATE TABLE "operadora_cartao" (
    "id_operadora" SERIAL NOT NULL,
    "nome" VARCHAR(50) NOT NULL,
    "taxa_debito" DECIMAL(5,2) NOT NULL DEFAULT 0,
    "prazo_debito" INTEGER NOT NULL DEFAULT 1,
    "taxa_credito_vista" DECIMAL(5,2) NOT NULL DEFAULT 0,
    "prazo_credito_vista" INTEGER NOT NULL DEFAULT 30,
    "taxa_credito_parc" DECIMAL(5,2) NOT NULL DEFAULT 0,
    "prazo_credito_parc" INTEGER NOT NULL DEFAULT 30,
    "taxa_antecipacao" DECIMAL(5,2) NOT NULL DEFAULT 0,
    "antecipacao_auto" BOOLEAN NOT NULL DEFAULT false,
    "id_conta_destino" INTEGER NOT NULL,

    CONSTRAINT "operadora_cartao_pkey" PRIMARY KEY ("id_operadora")
);

-- CreateTable
CREATE TABLE "recebivel_cartao" (
    "id_recebivel" SERIAL NOT NULL,
    "id_os" INTEGER,
    "id_operadora" INTEGER NOT NULL,
    "num_parcela" INTEGER NOT NULL DEFAULT 1,
    "total_parcelas" INTEGER NOT NULL DEFAULT 1,
    "valor_bruto" DECIMAL(10,2) NOT NULL,
    "valor_liquido" DECIMAL(10,2) NOT NULL,
    "taxa_aplicada" DECIMAL(10,2) NOT NULL,
    "data_venda" DATE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "data_prevista" DATE NOT NULL,
    "data_recebimento" DATE,
    "status" TEXT NOT NULL DEFAULT 'PENDENTE',

    CONSTRAINT "recebivel_cartao_pkey" PRIMARY KEY ("id_recebivel")
);

-- AddForeignKey
ALTER TABLE "livro_caixa" ADD CONSTRAINT "livro_caixa_id_conta_bancaria_fkey" FOREIGN KEY ("id_conta_bancaria") REFERENCES "conta_bancaria"("id_conta") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "operadora_cartao" ADD CONSTRAINT "operadora_cartao_id_conta_destino_fkey" FOREIGN KEY ("id_conta_destino") REFERENCES "conta_bancaria"("id_conta") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "recebivel_cartao" ADD CONSTRAINT "recebivel_cartao_id_operadora_fkey" FOREIGN KEY ("id_operadora") REFERENCES "operadora_cartao"("id_operadora") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "recebivel_cartao" ADD CONSTRAINT "recebivel_cartao_id_os_fkey" FOREIGN KEY ("id_os") REFERENCES "ordem_de_servico"("id_os") ON DELETE SET NULL ON UPDATE CASCADE;



================================================================================
FILE PATH: server\prisma\migrations\20260112125036_add_financial_integration_fields\migration.sql
================================================================================
/*
  Warnings:

  - A unique constraint covering the columns `[id_livro_caixa]` on the table `pagamento_cliente` will be added. If there are existing duplicate values, this will fail.
  - A unique constraint covering the columns `[id_livro_caixa]` on the table `pagamento_peca` will be added. If there are existing duplicate values, this will fail.

*/
-- AlterTable
ALTER TABLE "conta_bancaria" ADD COLUMN     "vincular_caixa" BOOLEAN NOT NULL DEFAULT false;

-- AlterTable
ALTER TABLE "operadora_cartao" ADD COLUMN     "vincular_caixa" BOOLEAN NOT NULL DEFAULT false;

-- AlterTable
ALTER TABLE "pagamento_cliente" ADD COLUMN     "id_livro_caixa" INTEGER,
ADD COLUMN     "id_operadora" INTEGER;

-- AlterTable
ALTER TABLE "pagamento_peca" ADD COLUMN     "id_livro_caixa" INTEGER;

-- AlterTable
ALTER TABLE "recebivel_cartao" ADD COLUMN     "confirmado_em" TIMESTAMP,
ADD COLUMN     "confirmado_por" VARCHAR(100);

-- CreateIndex
CREATE UNIQUE INDEX "pagamento_cliente_id_livro_caixa_key" ON "pagamento_cliente"("id_livro_caixa");

-- CreateIndex
CREATE UNIQUE INDEX "pagamento_peca_id_livro_caixa_key" ON "pagamento_peca"("id_livro_caixa");

-- AddForeignKey
ALTER TABLE "pagamento_peca" ADD CONSTRAINT "pagamento_peca_id_livro_caixa_fkey" FOREIGN KEY ("id_livro_caixa") REFERENCES "livro_caixa"("id_livro_caixa") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pagamento_cliente" ADD CONSTRAINT "pagamento_cliente_id_livro_caixa_fkey" FOREIGN KEY ("id_livro_caixa") REFERENCES "livro_caixa"("id_livro_caixa") ON DELETE SET NULL ON UPDATE CASCADE;



================================================================================
FILE PATH: server\prisma\migrations\20260112150428_add_conta_bancaria_to_pagamento_cliente\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "pagamento_cliente" ADD COLUMN     "id_conta_bancaria" INTEGER;



================================================================================
FILE PATH: server\prisma\migrations\20260113203536_correcao_modal_pagamento\migration.sql
================================================================================
-- AddForeignKey
ALTER TABLE "pagamento_cliente" ADD CONSTRAINT "pagamento_cliente_id_operadora_fkey" FOREIGN KEY ("id_operadora") REFERENCES "operadora_cartao"("id_operadora") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pagamento_cliente" ADD CONSTRAINT "pagamento_cliente_id_conta_bancaria_fkey" FOREIGN KEY ("id_conta_bancaria") REFERENCES "conta_bancaria"("id_conta") ON DELETE SET NULL ON UPDATE CASCADE;



================================================================================
FILE PATH: server\prisma\migrations\20260115130823_add_cep_to_cliente\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "cliente" ADD COLUMN     "cep" VARCHAR(10);



================================================================================
FILE PATH: server\scripts\check_tipos.ts
================================================================================
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

async function main() {
  const tipos = await prisma.tipo.findMany();
  console.log("Tipos found:", JSON.stringify(tipos, null, 2));
}

main()
  .catch((e) => console.error(e))
  .finally(async () => await prisma.$disconnect());



================================================================================
FILE PATH: server\scripts\seed_categories.ts
================================================================================
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  const systemCategories = ['FORNECEDOR', 'RECEITA_SERVICO', 'OUTROS', 'EQUIPE'];

  for (const nome of systemCategories) {
    const exists = await prisma.categoriaFinanceira.findUnique({
      where: { nome }
    });

    if (!exists) {
      await prisma.categoriaFinanceira.create({
        data: {
          nome,
          tipo: 'AMBOS'
        }
      });
      console.log(`Categoria criada: ${nome}`);
    } else {
        console.log(`Categoria j√° existe: ${nome}`);
    }
  }
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });



================================================================================
FILE PATH: server\src\prisma.ts
================================================================================
import { PrismaClient } from '@prisma/client';
import dotenv from 'dotenv';

dotenv.config();

export const prisma = new PrismaClient();




================================================================================
FILE PATH: server\src\server.ts
================================================================================
import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';

// Importar todas as rotas primeiro
import { pessoaRoutes } from './routes/pessoa.routes.js';
import { tipoRoutes } from './routes/tipo.routes.js';
import { pessoaFisicaRoutes } from './routes/pessoaFisica.routes.js';
import { pessoaJuridicaRoutes } from './routes/pessoaJuridica.routes.js';
import { clienteRoutes } from './routes/cliente.routes.js';
import { funcionarioRoutes } from './routes/funcionario.routes.js';
import { pecasEstoqueRoutes } from './routes/pecasEstoque.routes.js';
import { veiculoRoutes } from './routes/veiculo.routes.js';
import { ordemDeServicoRoutes } from './routes/ordemDeServico.routes.js';
import { itensOsRoutes } from './routes/itensOs.routes.js';
import { servicoMaoDeObraRoutes } from './routes/servicoMaoDeObra.routes.js';
import { fechamentoFinanceiroRoutes } from './routes/fechamentoFinanceiro.routes.js';
import { fornecedorRoutes } from './routes/fornecedor.routes.js';
import { pagamentoPecaRoutes } from './routes/pagamentoPeca.routes.js';
import { pagamentoClienteRoutes } from './routes/pagamentoCliente.routes.js';
import contasPagarRoutes from './routes/contasPagar.routes.js';
import { pagamentoEquipeRoutes } from './routes/pagamentoEquipe.routes.js';
import { livroCaixaRoutes } from './routes/livroCaixa.routes.js';
import { categoriaFinanceiraRoutes } from './routes/categoriaFinanceira.routes.js';
import { contaBancariaRoutes } from './routes/contaBancaria.routes.js';
import { operadoraRoutes } from './routes/operadoraCartao.routes.js';
import { recebivelCartaoRoutes } from './routes/recebivelCartao.routes.js';

dotenv.config();

const app = express();

app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3000;

app.get('/', (req, res) => {
  res.send('Centro Automotivo API is running');
});

// Registrar todas as rotas
app.use('/api/pessoa', pessoaRoutes);
app.use('/api/tipo', tipoRoutes);
app.use('/api/pessoa-fisica', pessoaFisicaRoutes);
app.use('/api/pessoa-juridica', pessoaJuridicaRoutes);
app.use('/api/cliente', clienteRoutes);
app.use('/api/funcionario', funcionarioRoutes);
app.use('/api/pecas-estoque', pecasEstoqueRoutes);
app.use('/api/veiculo', veiculoRoutes);
app.use('/api/ordem-de-servico', ordemDeServicoRoutes);
app.use('/api/itens-os', itensOsRoutes);
app.use('/api/servico-mao-de-obra', servicoMaoDeObraRoutes);
app.use('/api/fechamento-financeiro', fechamentoFinanceiroRoutes);
app.use('/api/fornecedor', fornecedorRoutes);
app.use('/api/pagamento-peca', pagamentoPecaRoutes);
app.use('/api/pagamento-cliente', pagamentoClienteRoutes);
app.use('/api/contas-pagar', contasPagarRoutes);
app.use('/api/pagamento-equipe', pagamentoEquipeRoutes);
app.use('/api/livro-caixa', livroCaixaRoutes);
app.use('/api/categoria-financeira', categoriaFinanceiraRoutes);
app.use('/api/conta-bancaria', contaBancariaRoutes);
app.use('/api/operadora-cartao', operadoraRoutes);
app.use('/api/recebivel-cartao', recebivelCartaoRoutes);

app.listen(PORT, () => {
  console.log(`Server is running on port ${PORT}`);
});



================================================================================
FILE PATH: server\src\controllers\categoriaFinanceira.controller.ts
================================================================================
import { Request, Response } from 'express';
import { prisma } from '../prisma.js';

export const getAll = async (req: Request, res: Response) => {
    try {
        // Sync: Fetch distinct categories from LivroCaixa that are NOT in CategoriaFinanceira
        const existingCats = await prisma.categoriaFinanceira.findMany({ select: { nome: true } });
        const existingNames = new Set(existingCats.map(c => c.nome.toUpperCase()));

        // Get distinct categories used in LivroCaixa
        const usedCategories = await prisma.livroCaixa.groupBy({
            by: ['categoria'],
        });

        const newCategories = usedCategories
            .map(uc => uc.categoria)
            .filter(name => name && !existingNames.has(name.toUpperCase()));

        // Create missing categories
        if (newCategories.length > 0) {
            await prisma.categoriaFinanceira.createMany({
                data: newCategories.map(name => ({
                    nome: name,
                    tipo: 'AMBOS' // Default to AMBOS as we don't know for sure
                })),
                skipDuplicates: true
            });
        }

        const categorias = await prisma.categoriaFinanceira.findMany({
            orderBy: { nome: 'asc' }
        });
        res.json(categorias);
    } catch (error) {
        console.error(error);
        res.status(500).json({ error: 'Erro ao buscar categorias' });
    }
};

export const create = async (req: Request, res: Response) => {
    try {
        const { nome, tipo } = req.body;
        const categoria = await prisma.categoriaFinanceira.create({
            data: { nome, tipo }
        });
        res.status(201).json(categoria);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao criar categoria' });
    }
};

export const update = async (req: Request, res: Response) => {
    try {
        const { id } = req.params;
        const { nome, tipo } = req.body;
        
        // Also update name in LivroCaixa if name changed? 
        // Sync: If name changed, we should update LivroCaixa to keep consistency?
        // Or keep old name in history?
        // User asked for "sync everything". Updating history seems correct if it's a rename.
        
        const oldCat = await prisma.categoriaFinanceira.findUnique({ where: { id_categoria: Number(id) }});

        if (oldCat && oldCat.nome !== nome) {
             // Update references first
             await prisma.livroCaixa.updateMany({
                 where: { categoria: oldCat.nome },
                 data: { categoria: nome }
             });
        }

        const categoria = await prisma.categoriaFinanceira.update({
            where: { id_categoria: Number(id) },
            data: { nome, tipo }
        });
        res.json(categoria);
    } catch (error) {
        console.error(error);
        res.status(500).json({ error: 'Erro ao atualizar categoria' });
    }
};

export const remove = async (req: Request, res: Response) => {
    try {
        const { id } = req.params;
        const { replacementCategory } = req.body;
        
        const categoryToDelete = await prisma.categoriaFinanceira.findUnique({
             where: { id_categoria: Number(id) }
        });

        if (!categoryToDelete) return res.status(404).json({error: 'Cat not found'});

        // Check compatibility if usage exists
        const usageCount = await prisma.livroCaixa.count({
             where: { categoria: categoryToDelete.nome }
        });

        if (usageCount > 0) {
            if (!replacementCategory) {
                 return res.status(409).json({ 
                     error: 'Categoria em uso', 
                     usageCount,
                     message: `Esta categoria est√° sendo usada em ${usageCount} registros. Selecione uma categoria substituta.` 
                 });
            }

            // Update all records to new category
            await prisma.livroCaixa.updateMany({
                where: { categoria: categoryToDelete.nome },
                data: { categoria: replacementCategory }
            });
        }

        await prisma.categoriaFinanceira.delete({
            where: { id_categoria: Number(id) }
        });
        res.status(204).send();
    } catch (error) {
        res.status(500).json({ error: 'Erro ao deletar categoria' });
    }
};



================================================================================
FILE PATH: server\src\controllers\cliente.controller.ts
================================================================================
import { Request, Response } from "express";
import { ClienteRepository } from "../repositories/cliente.repository.js";

const repository = new ClienteRepository();

export class ClienteController {
  async create(req: Request, res: Response) {
    console.log("üîµ ClienteController.create - Received request");
    console.log("üì¶ Request body:", JSON.stringify(req.body, null, 2));

    try {
      const cliente = await repository.create(req.body);
      console.log("‚úÖ ClienteController.create - Success:", cliente.id_cliente);
      res.status(201).json(cliente);
    } catch (error: any) {
      console.error("‚ùå ClienteController.create - Error:", error);
      console.error("‚ùå Error message:", error.message);
      console.error("‚ùå Error stack:", error.stack);
      res
        .status(400)
        .json({ error: "Failed to create Cliente", details: error.message });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const clientes = await repository.findAll();
      res.json(clientes);
    } catch (error) {
      res.status(500).json({ error: "Failed to fetch Clientes" });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const cliente = await repository.findById(id);
      if (!cliente) {
        return res.status(404).json({ error: "Cliente not found" });
      }
      res.json(cliente);
    } catch (error) {
      res.status(500).json({ error: "Failed to fetch Cliente" });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const cliente = await repository.update(id, req.body);
      res.json(cliente);
    } catch (error) {
      res.status(400).json({ error: "Failed to update Cliente" });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);

      // Check if client has service orders or vehicles with service orders
      const clienteWithOS = await repository.findById(id);

      if (!clienteWithOS) {
        return res.status(404).json({ error: "Cliente n√£o encontrado." });
      }

      // Check if client has service orders directly
      if (
        clienteWithOS &&
        clienteWithOS.ordens_de_servico &&
        clienteWithOS.ordens_de_servico.length > 0
      ) {
        return res.status(400).json({
          error:
            "N√£o √© poss√≠vel excluir cliente com ordens de servi√ßo cadastradas.",
          message:
            "Este cliente possui ordens de servi√ßo associadas. N√£o √© poss√≠vel exclu√≠-lo.",
        });
      }

      // Check if client has vehicles with service orders
      if (clienteWithOS.veiculos && clienteWithOS.veiculos.length > 0) {
        // Import prisma to check each vehicle
        const { prisma } = await import("../prisma.js");

        for (const veiculo of clienteWithOS.veiculos) {
          const veiculoWithOS = await prisma.veiculo.findUnique({
            where: { id_veiculo: veiculo.id_veiculo },
            include: { ordens_de_servico: true },
          });

          if (
            veiculoWithOS &&
            veiculoWithOS.ordens_de_servico &&
            veiculoWithOS.ordens_de_servico.length > 0
          ) {
            return res.status(400).json({
              error:
                "N√£o √© poss√≠vel excluir cliente com ve√≠culos vinculados a ordens de servi√ßo.",
              message: `O ve√≠culo ${veiculoWithOS.placa} possui ordens de servi√ßo associadas. N√£o √© poss√≠vel excluir o cliente.`,
            });
          }
        }

        // Delete all vehicles without OS
        await prisma.veiculo.deleteMany({
          where: { id_cliente: id },
        });
      }

      await repository.delete(id);
      res.status(204).send();
    } catch (error: any) {
      console.error("Error deleting cliente:", error);
      res.status(400).json({
        error: "Failed to delete Cliente",
        message: error.message || "Unknown error",
        details: error.code || "",
      });
    }
  }

  async searchByName(req: Request, res: Response) {
    try {
      const { name } = req.query;
      if (!name || typeof name !== "string") {
        return res
          .status(400)
          .json({ error: "Name query parameter is required" });
      }
      const clientes = await repository.searchByName(name);
      res.json(clientes);
    } catch (error) {
      res.status(500).json({ error: "Failed to search Clientes" });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\contaBancaria.controller.ts
================================================================================
import { Request, Response } from 'express';
import { prisma } from '../prisma.js';

export const getAll = async (req: Request, res: Response) => {
    try {
        const contas = await prisma.contaBancaria.findMany({
            orderBy: { id_conta: 'asc' }
        });
        res.json(contas);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao buscar contas' });
    }
};

export const create = async (req: Request, res: Response) => {
    try {
        const data = req.body;
        const conta = await prisma.contaBancaria.create({ data });
        res.status(201).json(conta);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao criar conta' });
    }
};

export const update = async (req: Request, res: Response) => {
    const { id } = req.params;
    try {
        const data = req.body;
        const conta = await prisma.contaBancaria.update({
            where: { id_conta: Number(id) },
            data
        });
        res.json(conta);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao atualizar conta' });
    }
};

export const remove = async (req: Request, res: Response) => {
    const { id } = req.params;
    try {
        // Soft delete logic can be added, but user asked for "Ativo/Inativo" status mostly.
        // For now, let's use the 'ativo' flag update as a soft delete or just toggle.
        // Or if real delete is needed:
        // await prisma.contaBancaria.delete({ where: { id_conta: Number(id) } });
        // But let's check if 'ativo' is enough.
        
        const conta = await prisma.contaBancaria.update({
            where: { id_conta: Number(id) },
            data: { ativo: false }
        });
        res.json(conta);
    } catch (error) {
         res.status(500).json({ error: 'Erro ao desativar conta' });
    }
};



================================================================================
FILE PATH: server\src\controllers\contasPagar.controller.ts
================================================================================

import { Request, Response } from 'express';
import { ContasPagarRepository } from '../repositories/contasPagar.repository.js';

const repository = new ContasPagarRepository();

export const createConta = async (req: Request, res: Response) => {
    try {
        const conta = await repository.create(req.body);
        res.status(201).json(conta);
    } catch (error) {
        res.status(400).json({ error: 'Erro ao criar conta a pagar' });
    }
};

export const getContas = async (req: Request, res: Response) => {
    try {
        const contas = await repository.findAll();
        res.json(contas);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao buscar contas' });
    }
};

export const getContaById = async (req: Request, res: Response) => {
    try {
        const conta = await repository.findById(Number(req.params.id));
        if (!conta) return res.status(404).json({ error: 'Conta n√£o encontrada' });
        res.json(conta);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao buscar conta' });
    }
};

export const updateConta = async (req: Request, res: Response) => {
    try {
        const conta = await repository.update(Number(req.params.id), req.body);
        res.json(conta);
    } catch (error) {
        res.status(400).json({ error: 'Erro ao atualizar conta' });
    }
};

export const deleteConta = async (req: Request, res: Response) => {
    try {
        await repository.delete(Number(req.params.id));
        res.status(204).send();
    } catch (error) {
        res.status(400).json({ error: 'Erro ao deletar conta' });
    }
};



================================================================================
FILE PATH: server\src\controllers\dashboard.controller.ts
================================================================================
import { Request, Response } from 'express';
import { prisma } from '../prisma.js';

export class DashboardController {
  async getDashboardData(req: Request, res: Response) {
    try {
      // Dates for "Today" filter (Server Time)
      const startOfDay = new Date();
      startOfDay.setHours(0, 0, 0, 0);
      const endOfDay = new Date();
      endOfDay.setHours(23, 59, 59, 999);

      // 1. Servi√ßos em Aberto
      const osAberta = await prisma.ordemDeServico.count({
        where: {
          status: { in: ['ABERTA', 'EM_ANDAMENTO'] },
          deleted_at: null
        }
      });

      // 2. Contas a Pagar (Geral) -> Status PENDENTE
      const contasPagar = await prisma.contasPagar.count({
        where: {
          status: 'PENDENTE',
          deleted_at: null
        }
      });

      // 3. Livro Caixa Entries (PagamentoCliente Today)
      const livroCaixaEntries = await prisma.pagamentoCliente.count({
        where: {
          data_pagamento: { gte: startOfDay, lte: endOfDay },
          deleted_at: null
        }
      });

      // 4. Livro Caixa Exits (PagamentoPeca Today - Real Only)
      const livroCaixaExits = await prisma.pagamentoPeca.count({
        where: {
          pago_ao_fornecedor: true,
          data_pagamento_fornecedor: { gte: startOfDay, lte: endOfDay },
          deleted_at: null
        }
      });

      // 5. Auto Pe√ßas Pendentes
      // A. Items without payment record
      const itemsUnpaid = await prisma.itensOs.count({
        where: {
          pagamentos_peca: { none: {} },
          ordem_de_servico: { status: { not: 'CANCELADA' } },
          deleted_at: null
        }
      });
      // B. Payment records pending
      const paymentsPending = await prisma.pagamentoPeca.count({
        where: {
          pago_ao_fornecedor: false,
          deleted_at: null
        }
      });
      const autoPecasPendentes = itemsUnpaid + paymentsPending;

      // 6. Consolida√ß√£o (OS Pronta para Financeiro E SEM Fechamento)
      const consolidacao = await prisma.ordemDeServico.count({
        where: {
          status: 'PRONTO PARA FINANCEIRO',
          fechamento_financeiro: null,
          deleted_at: null
        }
      });

      // 7. Recent OSs (Limit to 100 for performance)
      const recentOss = await prisma.ordemDeServico.findMany({
        take: 100,
        orderBy: { updated_at: 'desc' },
        include: {
          veiculo: true,
          cliente: {
            include: {
              pessoa_fisica: { include: { pessoa: true } },
              pessoa_juridica: { include: { pessoa: true } }
            }
          },
          servicos_mao_de_obra: {
            include: {
              funcionario: {
                include: {
                  pessoa_fisica: { include: { pessoa: true } }
                }
              }
            }
          }
        }
      });

      res.json({
        stats: {
          osAberta,
          contasPagar,
          livroCaixaEntries,
          livroCaixaExits,
          autoPecasPendentes,
          consolidacao
        },
        recentOss
      });

    } catch (error) {
      console.error('Dashboard Error:', error);
      res.status(500).json({ error: 'Failed to load dashboard data' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\fechamentoFinanceiro.controller.ts
================================================================================
import { Request, Response } from 'express';
import { FechamentoFinanceiroRepository } from '../repositories/fechamentoFinanceiro.repository.js';

const repository = new FechamentoFinanceiroRepository();

export class FechamentoFinanceiroController {
  async create(req: Request, res: Response) {
    try {
      const fechamento = await repository.create(req.body);
      res.status(201).json(fechamento);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Fechamento Financeiro', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const fechamentos = await repository.findAll();
      res.json(fechamentos);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Fechamentos Financeiros' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const fechamento = await repository.findById(id);
      if (!fechamento) {
        return res.status(404).json({ error: 'Fechamento Financeiro not found' });
      }
      res.json(fechamento);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Fechamento Financeiro' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const fechamento = await repository.update(id, req.body);
      res.json(fechamento);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Fechamento Financeiro' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Fechamento Financeiro' });
    }
  }

  async consolidarOS(req: Request, res: Response) {
    try {
      const { idOs, custoTotalPecasReal } = req.body;
      
      if (!idOs) {
        return res.status(400).json({ error: 'ID da OS √© obrigat√≥rio' });
      }

      const fechamento = await repository.consolidarOS(
        Number(idOs),
        Number(custoTotalPecasReal) || 0
      );
      
      res.status(201).json(fechamento);
    } catch (error: any) {
      res.status(400).json({ 
        error: 'Failed to consolidate OS', 
        details: error.message 
      });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\fornecedor.controller.ts
================================================================================
import { Request, Response } from 'express';
import { FornecedorRepository } from '../repositories/fornecedor.repository.js';

const repository = new FornecedorRepository();

export class FornecedorController {
  async create(req: Request, res: Response) {
    try {
      const fornecedor = await repository.create(req.body);
      res.status(201).json(fornecedor);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Fornecedor', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const fornecedores = await repository.findAll();
      res.json(fornecedores);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Fornecedores' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const fornecedor = await repository.findById(id);
      if (!fornecedor) {
        return res.status(404).json({ error: 'Fornecedor not found' });
      }
      res.json(fornecedor);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Fornecedor' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const fornecedor = await repository.update(id, req.body);
      res.json(fornecedor);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Fornecedor' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Fornecedor' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\funcionario.controller.ts
================================================================================
import { Request, Response } from 'express';
import { FuncionarioRepository } from '../repositories/funcionario.repository.js';

const repository = new FuncionarioRepository();

export class FuncionarioController {
  async create(req: Request, res: Response) {
    try {
      const funcionario = await repository.create(req.body);
      res.status(201).json(funcionario);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Funcionario', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const funcionarios = await repository.findAll();
      res.json(funcionarios);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Funcionarios' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const funcionario = await repository.findById(id);
      if (!funcionario) {
        return res.status(404).json({ error: 'Funcionario not found' });
      }
      res.json(funcionario);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Funcionario' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const funcionario = await repository.update(id, req.body);
      res.json(funcionario);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Funcionario' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Funcionario' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\itensOs.controller.ts
================================================================================
import { Request, Response } from 'express';
import { ItensOsRepository } from '../repositories/itensOs.repository.js';
import { PagamentoPecaRepository } from '../repositories/pagamentoPeca.repository.js';

const repository = new ItensOsRepository();
const pagamentoRepository = new PagamentoPecaRepository();

export class ItensOsController {
  async create(req: Request, res: Response) {
    try {
      const { id_fornecedor, custo_real, ...itemData } = req.body;
      const item = await repository.create(itemData);
      
      if (id_fornecedor) {
          await pagamentoRepository.create({
              item_os: { connect: { id_iten: item.id_iten } },
              fornecedor: { connect: { id_fornecedor: Number(id_fornecedor) } },
              custo_real: custo_real ? Number(custo_real) : 0,
              data_compra: new Date(),
              pago_ao_fornecedor: false
          });
      }

      res.status(201).json(item);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Item OS', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const itens = await repository.findAll();
      res.json(itens);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Itens OS' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const item = await repository.findById(id);
      if (!item) {
        return res.status(404).json({ error: 'Item OS not found' });
      }
      res.json(item);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Item OS' });
    }
  }

  async findByOsId(req: Request, res: Response) {
    try {
      const idOs = Number(req.params.idOs);
      const itens = await repository.findByOsId(idOs);
      res.json(itens);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Itens for OS' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const { id_fornecedor, custo_real, ...itemData } = req.body;
      
      const item = await repository.update(id, itemData);

      if (id_fornecedor !== undefined) {
          // Check if payment record exists
          const existingPayments = await pagamentoRepository.findByItemId(id);
          
          if (existingPayments && existingPayments.length > 0) {
              if (id_fornecedor) {
                  const updateData: any = {
                      fornecedor: { connect: { id_fornecedor: Number(id_fornecedor) } }
                  };
                  if (custo_real) {
                      updateData.custo_real = Number(custo_real);
                  }
                  
                  await pagamentoRepository.update(existingPayments[0]!.id_pagamento_peca, updateData);
              } else {
                  // If cleared, delete the payment record
                  await pagamentoRepository.delete(existingPayments[0]!.id_pagamento_peca);
              }
          } else if (id_fornecedor) {
              // Create new if strictly provided
              await pagamentoRepository.create({
                  item_os: { connect: { id_iten: id } },
                  fornecedor: { connect: { id_fornecedor: Number(id_fornecedor) } },
                  custo_real: custo_real ? Number(custo_real) : 0,
                  data_compra: new Date(),
                  pago_ao_fornecedor: false
              });
          }
      }

      res.json(item);
    } catch (error) {
      console.error(error);
      res.status(400).json({ error: 'Failed to update Item OS' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Item OS' });
    }
  }

  async search(req: Request, res: Response) {
    try {
      const query = req.query.q as string;
      if (!query) return res.json([]);
      const itens = await repository.search(query);
      res.json(itens);
    } catch (error) {
      res.status(500).json({ error: 'Failed to search Item OS descriptions' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\livroCaixa.controller.ts
================================================================================
import { Request, Response } from 'express';
import { prisma } from '../prisma.js';

export const getAll = async (req: Request, res: Response) => {
    try {
        const registros = await prisma.livroCaixa.findMany({
            include: { conta: true },
            orderBy: { dt_movimentacao: 'desc' },
            take: 200 // Limit to last 200 for performance? Or pagination later.
        });
        res.json(registros);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao buscar livro caixa' });
    }
};

export const create = async (req: Request, res: Response) => {
    try {
        const { descricao, valor, tipo_movimentacao, categoria, obs, origem, id_conta_bancaria } = req.body;
        
        // Transaction to update balance if account provided
        const result = await prisma.$transaction(async (tx) => {
             const registro = await tx.livroCaixa.create({
                data: { 
                    descricao, 
                    valor, 
                    tipo_movimentacao, 
                    categoria,
                    obs,
                    origem: origem || 'MANUAL',
                    id_conta_bancaria: id_conta_bancaria ? Number(id_conta_bancaria) : null
                }
            });

            if (id_conta_bancaria) {
                 if (tipo_movimentacao === 'ENTRADA') {
                     await tx.contaBancaria.update({
                         where: { id_conta: Number(id_conta_bancaria) },
                         data: { saldo_atual: { increment: valor } }
                     });
                 } else {
                     await tx.contaBancaria.update({
                         where: { id_conta: Number(id_conta_bancaria) },
                         data: { saldo_atual: { decrement: valor } }
                     });
                 }
            }
            return registro;
        });

        res.status(201).json(result);
    } catch (error) {
        console.error(error);
        res.status(500).json({ error: 'Erro ao criar registro' });
    }
};

export const update = async (req: Request, res: Response) => {
    const { id } = req.params;
    try {
        const { descricao, valor, tipo_movimentacao, categoria, obs } = req.body;
        const registro = await prisma.livroCaixa.update({
            where: { id_livro_caixa: Number(id) },
            data: { descricao, valor, tipo_movimentacao, categoria, obs }
        });
        res.json(registro);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao atualizar registro' });
    }
};

export const softDelete = async (req: Request, res: Response) => {
    const { id } = req.params;
    const { obs } = req.body;
    try {
        const registro = await prisma.livroCaixa.update({
             where: { id_livro_caixa: Number(id) },
             data: { 
                 deleted_at: new Date(),
                 obs: obs // Update obs if provided
             }
        });
        res.json(registro);
    } catch (error) {
         res.status(500).json({ error: 'Erro ao deletar registro' });
    }
};



================================================================================
FILE PATH: server\src\controllers\operadoraCartao.controller.ts
================================================================================
import { Request, Response } from 'express';
import { prisma } from '../prisma.js';

export const getAll = async (req: Request, res: Response) => {
    try {
        const operadoras = await prisma.operadoraCartao.findMany({
            include: { conta_destino: true }
        });
        res.json(operadoras);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao buscar operadoras' });
    }
};

export const create = async (req: Request, res: Response) => {
    try {
        const data = req.body;
        const operadora = await prisma.operadoraCartao.create({ data });
        res.status(201).json(operadora);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao criar operadora' });
    }
};

export const update = async (req: Request, res: Response) => {
    const { id } = req.params;
    try {
        const data = req.body;
        const operadora = await prisma.operadoraCartao.update({
            where: { id_operadora: Number(id) },
            data
        });
        res.json(operadora);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao atualizar operadora' });
    }
};



================================================================================
FILE PATH: server\src\controllers\ordemDeServico.controller.ts
================================================================================
import { Request, Response } from 'express';
import { OrdemDeServicoRepository } from '../repositories/ordemDeServico.repository.js';

const repository = new OrdemDeServicoRepository();

export class OrdemDeServicoController {
  async create(req: Request, res: Response) {
    try {
      const os = await repository.create(req.body);
      res.status(201).json(os);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create OS', details: error });
    }
  }

  async createUnified(req: Request, res: Response) {
    try {
        const result = await repository.createUnified(req.body);
        res.status(201).json(result);
    } catch (error) {
        console.error('Unified Create Error:', error);
        res.status(400).json({ error: 'Failed to create OS Unified', details: error instanceof Error ? error.message : error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const oss = await repository.findAll();
      res.json(oss);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch OSs' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const os = await repository.findById(id);
      if (!os) {
        return res.status(404).json({ error: 'OS not found' });
      }
      res.json(os);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch OS' });
    }
  }

  async findByVehicleId(req: Request, res: Response) {
    try {
      const vehicleId = Number(req.params.vehicleId);
      if (isNaN(vehicleId)) {
        return res.status(400).json({ error: 'Invalid Vehicle ID' });
      }
      const oss = await repository.findByVehicleId(vehicleId);
      res.json(oss);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch OSs for vehicle' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);

      // STOCK MANAGEMENT LOGIC
      if (req.body.status) {
          const current = await repository.findById(id);
          if (current) {
               const oldStatus = current.status;
               const newStatus = req.body.status;
               
               const closedStatuses = ['PRONTO PARA FINANCEIRO', 'FINALIZADA', 'PAGA_CLIENTE'];
               const isClosing = closedStatuses.includes(newStatus);
               const wasClosed = closedStatuses.includes(oldStatus);
               
               // If moving TO closed state FROM open state -> DEDUCT
               if (isClosing && !wasClosed) {
                   await repository.adjustStockForOS(id, 'DEDUCT');
               } 
               // If moving FROM closed state TO open state -> RETURN
               else if (!isClosing && wasClosed) {
                   await repository.adjustStockForOS(id, 'RETURN');
               }
          }
      }

      const os = await repository.update(id, req.body);
      res.json(os);
    } catch (error) {
      console.error('Update OS Error:', error);
      res.status(400).json({ error: 'Failed to update OS', details: error instanceof Error ? error.message : error });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete OS' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\pagamentoCliente.controller.ts
================================================================================
import { Request, Response } from 'express';
import { PagamentoClienteRepository } from '../repositories/pagamentoCliente.repository.js';
import { prisma } from '../prisma.js';

const repository = new PagamentoClienteRepository();

export class PagamentoClienteController {
  async create(req: Request, res: Response) {
    try {
      const { id_operadora, ...data } = req.body;
      
      const result = await prisma.$transaction(async (tx) => {
          // 1. Create PagamentoCliente
          const pagamento = await tx.pagamentoCliente.create({ 
            data: { 
                ...data,
                id_operadora: id_operadora ? Number(id_operadora) : null 
            } 
          });

          // 2. If Operator selected, create Receivables
          if (id_operadora && (data.metodo_pagamento === 'CREDITO' || data.metodo_pagamento === 'DEBITO')) {
              const operadora = await tx.operadoraCartao.findUnique({ where: { id_operadora } });
              if (!operadora) throw new Error('Operadora n√£o encontrada');

              const parcelas = data.qtd_parcelas || 1;
              const valorTotal = Number(data.valor);
              const valorParcela = valorTotal / parcelas;
              
              // Determine Rates & Deadlines
              let taxa = 0;
              let prazo = 0;
              
              if (data.metodo_pagamento === 'DEBITO') {
                  taxa = Number(operadora.taxa_debito);
                  prazo = operadora.prazo_debito;
              } else if (parcelas === 1) {
                  taxa = Number(operadora.taxa_credito_vista);
                  prazo = operadora.prazo_credito_vista;
              } else {
                  taxa = Number(operadora.taxa_credito_parc);
                  prazo = operadora.prazo_credito_parc;
              }

              // Create Receivables
              for (let i = 1; i <= parcelas; i++) {
                  // Calculate Due Date
                  // For Debit/Credit 1x: Date + Prazo
                  // For Credit Nx: Date + Prazo + (30 * (i-1))
                  let daysToAdd = prazo;
                  if (data.metodo_pagamento === 'CREDITO' && parcelas > 1) {
                       daysToAdd = prazo + (30 * (i - 1));
                  }
                  
                  const dtPrevista = new Date();
                  dtPrevista.setDate(dtPrevista.getDate() + daysToAdd);

                  const valorLiquido = valorParcela - (valorParcela * (taxa / 100));

                  await tx.recebivelCartao.create({
                      data: {
                          id_os: data.id_os,
                          id_operadora: id_operadora,
                          num_parcela: i,
                          total_parcelas: parcelas,
                          valor_bruto: valorParcela,
                          valor_liquido: valorLiquido,
                          taxa_aplicada: taxa,
                          data_venda: new Date(),
                          data_prevista: dtPrevista,
                          status: 'PENDENTE'
                      }
                  });
              }
          }
          return pagamento;
      });

      res.status(201).json(result);
    } catch (error) {
      console.error(error);
      res.status(400).json({ error: 'Failed to create PagamentoCliente', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const pagamentos = await repository.findAll();
      res.json(pagamentos);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch PagamentoClientes' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pagamento = await repository.findById(id);
      if (!pagamento) {
        return res.status(404).json({ error: 'PagamentoCliente not found' });
      }
      res.json(pagamento);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch PagamentoCliente' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pagamento = await repository.update(id, req.body);
      res.json(pagamento);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update PagamentoCliente' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete PagamentoCliente' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\pagamentoEquipe.controller.ts
================================================================================
import { Request, Response } from 'express';
import { prisma } from '../prisma.js';

export const getPendentesByFuncionario = async (req: Request, res: Response) => {
    try {
        const { id_funcionario } = req.params;
        
        // Busca servi√ßos de M√£o de Obra Pendentes
        const servicos = await prisma.servicoMaoDeObra.findMany({
            where: {
                id_funcionario: Number(id_funcionario),
                status_pagamento: 'PENDENTE',
                deleted_at: null
            },
            include: {
                ordem_de_servico: {
                    select: {
                        id_os: true,
                        dt_abertura: true,
                        dt_entrega: true, 
                        // dt_finalizacao: true, // Assuming this field might not verify in schema yet based on previous turns, but filter uses it. Check schema.
                        // Actually schema has NO dt_finalizacao, only dt_entrega (which is finalization date usually).
                        // Let's check Schema one last time? No, I recall dt_entrega is the one. 
                        // Wait, previous turn code used dt_finalizacao. 
                        // Schema lines 200: dt_entrega DateTime?
                        // Schema lines 201: km_entrada
                        // No dt_finalizacao in recent view. So I should stick to dt_entrega.
                        // But I will add defect and diagnosis.
                        status: true,
                        defeito_relatado: true,
                        diagnostico: true,
                        veiculo: true,
                        cliente: {
                            include: {
                                pessoa_fisica: { include: { pessoa: true } },
                                pessoa_juridica: { include: { pessoa: true } }
                            }
                        }
                    }
                }
            },
            orderBy: {
                dt_cadastro: 'desc'
            }
        });

        res.json(servicos);
    } catch (error) {
        console.error(error);
        res.status(500).json({ error: 'Erro ao buscar comiss√µes pendentes' });
    }
};

export const getValesPendentesByFuncionario = async (req: Request, res: Response) => {
    try {
        const { id_funcionario } = req.params;
        const vales = await prisma.pagamentoEquipe.findMany({
            where: {
                id_funcionario: Number(id_funcionario),
                tipo_lancamento: 'VALE',
                descontado: false
            },
            orderBy: {
                dt_pagamento: 'desc'
            }
        });
        res.json(vales);
    } catch (error) {
        console.error(error);
        res.status(500).json({ error: 'Erro ao buscar vales pendentes' });
    }
};

export const createPagamento = async (req: Request, res: Response) => {
    try {
        const { 
            id_funcionario, servicos_ids, vales_ids, valor_total, obs, 
            forma_pagamento, premio_valor, premio_descricao,
            tipo_lancamento, referencia_inicio, referencia_fim
        } = req.body;

        const result = await prisma.$transaction(async (tx) => {
            // 1. Criar Registro de Pagamento
            // Se for VALE, ele nasce nao descontado (descontado: false). Se for SALARIO/COMISSAO, nao se aplica (false).
            const pagamento = await tx.pagamentoEquipe.create({
                data: {
                    id_funcionario: Number(id_funcionario),
                    valor_total: Number(valor_total),
                    forma_pagamento: forma_pagamento || 'DINHEIRO',
                    premio_valor: premio_valor ? Number(premio_valor) : null,
                    premio_descricao: premio_descricao || null,
                    tipo_lancamento: tipo_lancamento || 'COMISSAO',
                    referencia_inicio: referencia_inicio ? new Date(referencia_inicio) : null,
                    referencia_fim: referencia_fim ? new Date(referencia_fim) : null,
                    obs: obs,
                    descontado: false // Default
                }
            });

            // 2. Atualizar Servi√ßos (Comiss√µes)
            if (servicos_ids && servicos_ids.length > 0) {
                await tx.servicoMaoDeObra.updateMany({
                    where: {
                        id_servico_mao_de_obra: { in: servicos_ids },
                        deleted_at: null
                    },
                    data: {
                        status_pagamento: 'PAGO',
                        id_pagamento_equipe: pagamento.id_pagamento_equipe
                    }
                });
            }

            // 3. Deduzir Vales (Se houver IDs de vales selecionados para desconto)
            if (vales_ids && vales_ids.length > 0) {
                await tx.pagamentoEquipe.updateMany({
                   where: {
                       id_pagamento_equipe: { in: vales_ids },
                       id_funcionario: Number(id_funcionario),
                       tipo_lancamento: 'VALE',
                       descontado: false
                   },
                   data: {
                       descontado: true,
                       id_pagamento_deducao: pagamento.id_pagamento_equipe
                   }
                });
            }

            // 3. Obter nome do funcion√°rio para o Livro Caixa
            const func = await tx.funcionario.findUnique({
                where: { id_funcionario: Number(id_funcionario) },
                include: { pessoa_fisica: { include: { pessoa: true } } }
            });
            const nomeFunc = func?.pessoa_fisica?.pessoa?.nome || 'Funcion√°rio';

            // 4. Lan√ßar no Livro Caixa
            await tx.livroCaixa.create({
                data: {
                    descricao: `Pagamento Equipe - ${nomeFunc}`,
                    valor: Number(valor_total),
                    tipo_movimentacao: 'SAIDA',
                    categoria: 'EQUIPE',
                    id_pagamento_equipe: pagamento.id_pagamento_equipe
                }
            });

            return pagamento;
        });

        res.status(201).json(result);
    } catch (error) {
        console.error(error);
        res.status(500).json({ error: 'Erro ao realizar pagamento' });
    }
};

export const getHistorico = async (req: Request, res: Response) => {
    try {
        const pagamentos = await prisma.pagamentoEquipe.findMany({
            include: {
                funcionario: {
                     include: { pessoa_fisica: { include: { pessoa: true } } }
                },
                servicos_pagos: {
                    include: { 
                        ordem_de_servico: {
                            include: {
                                veiculo: true,
                                cliente: {
                                    include: {
                                        pessoa_fisica: { include: { pessoa: true } },
                                        pessoa_juridica: { include: { pessoa: true } }
                                    }
                                }
                            }
                        }
                    }
                }
            },
            orderBy: { dt_pagamento: 'desc' }
        });
        res.json(pagamentos);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao buscar hist√≥rico' });
    }
};



================================================================================
FILE PATH: server\src\controllers\pagamentoPeca.controller.ts
================================================================================
import { Request, Response } from "express";
import { PagamentoPecaRepository } from "../repositories/pagamentoPeca.repository.js";

const repository = new PagamentoPecaRepository();

export class PagamentoPecaController {
  async create(req: Request, res: Response) {
    try {
      const pagamento = await repository.create(req.body);
      res.status(201).json(pagamento);
    } catch (error) {
      res
        .status(400)
        .json({ error: "Failed to create Pagamento Peca", details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const pagamentos = await repository.findAll();
      res.json(pagamentos);
    } catch (error) {
      res.status(500).json({ error: "Failed to fetch Pagamentos Peca" });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pagamento = await repository.findById(id);
      if (!pagamento) {
        return res.status(404).json({ error: "Pagamento Peca not found" });
      }
      res.json(pagamento);
    } catch (error) {
      res.status(500).json({ error: "Failed to fetch Pagamento Peca" });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const {
        pago_ao_fornecedor,
        id_conta_bancaria,
        data_pagamento_fornecedor,
      } = req.body;

      // Check if we are UN-PAYING (reversing)
      // The frontend sends pago_ao_fornecedor: false when unpaying
      if (pago_ao_fornecedor === false) {
        try {
          const result = await repository.reversePayment(id);
          return res.json(result);
        } catch (e: any) {
          // If error is "not paid", maybe it was just a regular update setting false?
          // Fallback to regular update if specific logic fails or just let it fail?
          // Let's assume frontend calls this explicitly for unpay action.
          console.error("Reverse failed, trying regular update", e);
          // Fallback to regular update
          const p = await repository.update(id, req.body);
          return res.json(p);
        }
      }

      // Check if we are PAYING (confirming) and have a bank account
      // Frontend sends pago_ao_fornecedor: true AND id_conta_bancaria
      if (pago_ao_fornecedor === true && id_conta_bancaria) {
        try {
          const date = data_pagamento_fornecedor
            ? new Date(data_pagamento_fornecedor + "T12:00:00")
            : new Date();
          const result = await repository.confirmPayment(
            id,
            Number(id_conta_bancaria),
            date,
          );
          return res.json(result);
        } catch (e: any) {
          console.error("Confirm failed", e);
          return res
            .status(400)
            .json({ error: e.message || "Failed to confirm payment" });
        }
      }

      // Default generic update (e.g. editing cost, date_compra, without changing status)
      // Note: If frontend sends pago_ao_fornecedor: true BUT NO account, it goes here.
      // This path updates the record but creates NO financial movement.
      // This is backward compatible but dangerous if frontend forgets account.
      // But let's keep it for now.
      const pagamento = await repository.update(id, req.body);
      res.json(pagamento);
    } catch (error) {
      res.status(400).json({ error: "Failed to update Pagamento Peca" });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: "Failed to delete Pagamento Peca" });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\pecasEstoque.controller.ts
================================================================================
import { Request, Response } from 'express';
import { PecasEstoqueRepository } from '../repositories/pecasEstoque.repository.js';

const repository = new PecasEstoqueRepository();

export class PecasEstoqueController {
  async create(req: Request, res: Response) {
    try {
      const peca = await repository.create(req.body);
      res.status(201).json(peca);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Peca', details: error });
    }
  }

  async createEntry(req: Request, res: Response) {
    try {
        const entry = await repository.createEntry(req.body);
        res.status(201).json(entry);
    } catch (error) {
        console.error(error);
        res.status(400).json({ error: 'Failed to create entry', details: error });
    }
  }

  async getAvailability(req: Request, res: Response) {
      try {
          const id = Number(req.params.id);
          const result = await repository.getAvailability(id);
          if (!result) return res.status(404).json({error: 'Part not found'});
          res.json(result);
      } catch (error) {
          res.status(500).json({ error: 'Failed to fetch availability' });
      }
  }

  async findAll(req: Request, res: Response) {
    try {
      const pecas = await repository.findAll();
      res.json(pecas);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Pecas' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const peca = await repository.findById(id);
      if (!peca) {
        return res.status(404).json({ error: 'Peca not found' });
      }
      res.json(peca);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Peca' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const peca = await repository.update(id, req.body);
      res.json(peca);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Peca' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Peca' });
    }
  }

  async search(req: Request, res: Response) {
    try {
      const query = req.query.q as string;
      if (!query) return res.json([]);
      const pecas = await repository.search(query);
      res.json(pecas);
    } catch (error) {
      res.status(500).json({ error: 'Failed to search Pecas' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\pessoa.controller.ts
================================================================================
import { Request, Response } from "express";
import { PessoaRepository } from "../repositories/pessoa.repository.js";

const repository = new PessoaRepository();

export class PessoaController {
  async create(req: Request, res: Response) {
    try {
      const pessoa = await repository.create(req.body);
      res.status(201).json(pessoa);
    } catch (error) {
      console.error("Error creating Pessoa:", error);
      res
        .status(400)
        .json({ error: "Failed to create Pessoa", details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const pessoas = await repository.findAll();
      res.json(pessoas);
    } catch (error) {
      res.status(500).json({ error: "Failed to fetch Pessoas" });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pessoa = await repository.findById(id);
      if (!pessoa) {
        return res.status(404).json({ error: "Pessoa not found" });
      }
      res.json(pessoa);
    } catch (error) {
      res.status(500).json({ error: "Failed to fetch Pessoa" });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pessoa = await repository.update(id, req.body);
      res.json(pessoa);
    } catch (error) {
      res.status(400).json({ error: "Failed to update Pessoa" });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: "Failed to delete Pessoa" });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\pessoaFisica.controller.ts
================================================================================
import { Request, Response } from 'express';
import { PessoaFisicaRepository } from '../repositories/pessoaFisica.repository.js';

const repository = new PessoaFisicaRepository();

export class PessoaFisicaController {
  async create(req: Request, res: Response) {
    try {
      const pessoaFisica = await repository.create(req.body);
      res.status(201).json(pessoaFisica);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create PessoaFisica', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const pessoasFisicas = await repository.findAll();
      res.json(pessoasFisicas);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch PessoasFisicas' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pessoaFisica = await repository.findById(id);
      if (!pessoaFisica) {
        return res.status(404).json({ error: 'PessoaFisica not found' });
      }
      res.json(pessoaFisica);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch PessoaFisica' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pessoaFisica = await repository.update(id, req.body);
      res.json(pessoaFisica);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update PessoaFisica' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete PessoaFisica' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\pessoaJuridica.controller.ts
================================================================================
import { Request, Response } from 'express';
import { PessoaJuridicaRepository } from '../repositories/pessoaJuridica.repository.js';

const repository = new PessoaJuridicaRepository();

export class PessoaJuridicaController {
  async create(req: Request, res: Response) {
    try {
      const pessoaJuridica = await repository.create(req.body);
      res.status(201).json(pessoaJuridica);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create PessoaJuridica', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const pessoasJuridicas = await repository.findAll();
      res.json(pessoasJuridicas);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch PessoasJuridicas' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pessoaJuridica = await repository.findById(id);
      if (!pessoaJuridica) {
        return res.status(404).json({ error: 'PessoaJuridica not found' });
      }
      res.json(pessoaJuridica);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch PessoaJuridica' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pessoaJuridica = await repository.update(id, req.body);
      res.json(pessoaJuridica);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update PessoaJuridica' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete PessoaJuridica' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\recebivelCartao.controller.ts
================================================================================
import { Request, Response } from 'express';
import { RecebivelCartaoRepository } from '../repositories/recebivelCartao.repository.js';

const repository = new RecebivelCartaoRepository();

export class RecebivelCartaoController {
  async create(req: Request, res: Response) {
    try {
      const recebivel = await repository.create(req.body);
      res.status(201).json(recebivel);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Receb√≠vel', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const recebiveis = await repository.findAll();
      res.json(recebiveis);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Receb√≠veis' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const recebivel = await repository.findById(id);
      if (!recebivel) {
        return res.status(404).json({ error: 'Receb√≠vel not found' });
      }
      res.json(recebivel);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Receb√≠vel' });
    }
  }

  async findByOperadora(req: Request, res: Response) {
    try {
      const idOperadora = Number(req.params.idOperadora);
      const recebiveis = await repository.findByOperadora(idOperadora);
      res.json(recebiveis);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Receb√≠veis by Operadora' });
    }
  }

  async findByStatus(req: Request, res: Response) {
    try {
      const { status } = req.params;
      if (!status) {
        return res.status(400).json({ error: 'Status is required' });
      }
      const recebiveis = await repository.findByStatus(status);
      res.json(recebiveis);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Receb√≠veis by Status' });
    }
  }

  async findByDateRange(req: Request, res: Response) {
    try {
      const { dataInicio, dataFim } = req.query;

      if (!dataInicio || !dataFim) {
        return res.status(400).json({ error: 'Data de in√≠cio e fim s√£o obrigat√≥rias' });
      }

      // Ensure full day coverage by setting hours
      const start = new Date(dataInicio as string);
      start.setHours(0, 0, 0, 0);

      const end = new Date(dataFim as string);
      end.setHours(23, 59, 59, 999);

      if (isNaN(start.getTime()) || isNaN(end.getTime())) {
          return res.status(400).json({ error: 'Datas inv√°lidas fornecidas' });
      }
      
      console.log(`Buscando receb√≠veis de ${start.toISOString()} at√© ${end.toISOString()}`);

      const recebiveis = await repository.findByDateRange(start, end);
      res.json(recebiveis);
    } catch (error) {
      console.error('Error in findByDateRange:', error); 
      res.status(500).json({ error: 'Failed to fetch Receb√≠veis by Date Range' });
    }
  }

  async confirmarRecebimento(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const { confirmadoPor } = req.body;
      
      const recebivel = await repository.confirmarRecebimento(id, confirmadoPor || 'Sistema');
      res.json(recebivel);
    } catch (error: any) {
      res.status(400).json({ error: 'Failed to confirm Receb√≠vel', details: error.message });
    }
  }

  async estornarRecebimento(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const recebivel = await repository.estornarRecebimento(id);
      res.json(recebivel);
    } catch (error: any) {
      res.status(400).json({ error: 'Failed to reverse Receb√≠vel', details: error.message });
    }
  }

  async getResumo(req: Request, res: Response) {
    try {
      const resumo = await repository.getResumo();
      res.json(resumo);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Resumo' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const recebivel = await repository.update(id, req.body);
      res.json(recebivel);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Receb√≠vel' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Receb√≠vel' });
    }
  }

  async confirmarRecebimentoLote(req: Request, res: Response) {
    try {
      const { ids } = req.body;
      
      if (!ids || !Array.isArray(ids) || ids.length === 0) {
        return res.status(400).json({ error: 'IDs inv√°lidos' });
      }

      const confirmadoPor = req.body.confirmadoPor || 'Sistema';
      const resultados = await repository.confirmarRecebimentoLote(ids, confirmadoPor);
      
      res.json({ 
        message: `${resultados.length} recebimento(s) confirmado(s) com sucesso`,
        resultados 
      });
    } catch (error: any) {
      res.status(400).json({ 
        error: 'Failed to confirm Receb√≠veis', 
        details: error.message 
      });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\servicoMaoDeObra.controller.ts
================================================================================
import { Request, Response } from 'express';
import { ServicoMaoDeObraRepository } from '../repositories/servicoMaoDeObra.repository.js';

const repository = new ServicoMaoDeObraRepository();

export class ServicoMaoDeObraController {
  async create(req: Request, res: Response) {
    try {
      const { id_os, id_funcionario, valor, descricao } = req.body;
      const result = await repository.create({ 
          id_os: Number(id_os), 
          id_funcionario: Number(id_funcionario), 
          valor: Number(valor), 
          descricao 
      });
      res.status(201).json(result);
    } catch (error) {
      console.error(error);
      res.status(500).json({ error: 'Failed to add labor service' });
    }
  }

  async index(req: Request, res: Response) {
      try {
          const { id_os } = req.params;
          const result = await repository.findAllByOs(Number(id_os));
          res.json(result);
      } catch (error) {
          res.status(500).json({ error: 'Failed to fetch labor services' });
      }
  }

  async update(req: Request, res: Response) {
    try {
      const { id } = req.params;
      const { id_funcionario, valor, descricao } = req.body;
      
      const updateData: any = {};
      if (id_funcionario) updateData.id_funcionario = Number(id_funcionario);
      if (valor !== undefined) updateData.valor = Number(valor);
      if (descricao !== undefined) updateData.descricao = descricao;

      const result = await repository.update(Number(id), updateData);
      res.json(result);
    } catch (error) {
      console.error(error);
      res.status(500).json({ error: 'Failed to update labor service' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const { id } = req.params;
      await repository.softDelete(Number(id));
      res.status(204).send();
    } catch (error) {
      res.status(500).json({ error: 'Failed to delete labor service' });
    }
  }
}

export const servicoMaoDeObraController = new ServicoMaoDeObraController();



================================================================================
FILE PATH: server\src\controllers\tipo.controller.ts
================================================================================
import { Request, Response } from 'express';
import { TipoRepository } from '../repositories/tipo.repository.js';

const repository = new TipoRepository();

export class TipoController {
  async create(req: Request, res: Response) {
    try {
      const tipo = await repository.create(req.body);
      res.status(201).json(tipo);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Tipo', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const tipos = await repository.findAll();
      res.json(tipos);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Tipos' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const tipo = await repository.findById(id);
      if (!tipo) {
        return res.status(404).json({ error: 'Tipo not found' });
      }
      res.json(tipo);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Tipo' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const tipo = await repository.update(id, req.body);
      res.json(tipo);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Tipo' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Tipo' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\veiculo.controller.ts
================================================================================
import { Request, Response } from "express";
import { VeiculoRepository } from "../repositories/veiculo.repository.js";

const repository = new VeiculoRepository();

export class VeiculoController {
  async create(req: Request, res: Response) {
    try {
      const veiculo = await repository.create(req.body);
      res.status(201).json(veiculo);
    } catch (error) {
      res
        .status(400)
        .json({ error: "Failed to create Veiculo", details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const veiculos = await repository.findAll();
      res.json(veiculos);
    } catch (error) {
      res.status(500).json({ error: "Failed to fetch Veiculos" });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const veiculo = await repository.findById(id);
      if (!veiculo) {
        return res.status(404).json({ error: "Veiculo not found" });
      }
      res.json(veiculo);
    } catch (error) {
      res.status(500).json({ error: "Failed to fetch Veiculo" });
    }
  }

  async findByPlaca(req: Request, res: Response) {
    try {
      const placa = req.params.placa as string;
      if (!placa) {
        return res.status(400).json({ error: "Placa required" });
      }
      const veiculo = await repository.findByPlaca(placa);
      // NOTE: We return 404 explicitly if not found to trigger the frontend "Not Found" logic
      if (!veiculo) {
        return res.status(404).json({ error: "Veiculo not found" });
      }
      res.json(veiculo);
    } catch (error) {
      res.status(500).json({ error: "Failed to fetch Veiculo by placa" });
    }
  }

  async search(req: Request, res: Response) {
    try {
      const query = req.query.q as string;
      if (!query) {
        return res.json([]);
      }
      const veiculos = await repository.search(query);
      res.json(veiculos);
    } catch (error) {
      res.status(500).json({ error: "Failed to search Veiculos" });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const veiculo = await repository.update(id, req.body);
      res.json(veiculo);
    } catch (error) {
      res.status(400).json({ error: "Failed to update Veiculo" });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);

      // Check if vehicle has service orders
      const veiculoWithOS = await repository.findById(id);
      if (
        veiculoWithOS &&
        veiculoWithOS.ordens_de_servico &&
        veiculoWithOS.ordens_de_servico.length > 0
      ) {
        return res.status(400).json({
          error:
            "N√£o √© poss√≠vel excluir ve√≠culo com ordens de servi√ßo cadastradas.",
          message:
            "Este ve√≠culo possui ordens de servi√ßo associadas. N√£o √© poss√≠vel exclu√≠-lo.",
        });
      }

      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: "Failed to delete Veiculo" });
    }
  }
}



================================================================================
FILE PATH: server\src\repositories\auditLog.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class AuditLogRepository {
  async create(data: {
    tabela: string;
    registro_id: number;
    acao: 'CREATE' | 'UPDATE' | 'DELETE' | 'SOFT_DELETE';
    valor_antigo?: any;
    valor_novo?: any;
    usuario_id?: number;
  }) {
    return await prisma.auditLog.create({
      data: {
        tabela: data.tabela,
        registro_id: data.registro_id,
        acao: data.acao,
        valor_antigo: data.valor_antigo ? JSON.stringify(data.valor_antigo) : null,
        valor_novo: data.valor_novo ? JSON.stringify(data.valor_novo) : null,
        usuario_id: data.usuario_id || null, // Optional for now
      }
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\cliente.repository.ts
================================================================================
import { Prisma } from "@prisma/client";
import { prisma } from "../prisma.js";

export class ClienteRepository {
  async create(data: any) {
    console.log(
      "üì• ClienteRepository.create - Received data:",
      JSON.stringify(data, null, 2)
    );

    // TRANSACTIONAL CREATION FOR SIMPLIFIED PAYLOAD
    // If 'nome' is provided and we don't have explicit foreign keys, assume we need to create the person structure.
    if (data.nome && !data.id_pessoa_fisica && !data.id_pessoa_juridica) {
      return await prisma.$transaction(async (tx) => {
        // 1. Create Base Pessoa
        const pessoa = await tx.pessoa.create({
          data: {
            nome: data.nome,
          },
        });

        let idPessoaFisica = null;
        let idPessoaJuridica = null;
        let tipoPessoaId = 1; // Default to Fisica

        if (data.tipo === "JURIDICA") {
          tipoPessoaId = 2;
          const pj = await tx.pessoaJuridica.create({
            data: {
              id_pessoa: pessoa.id_pessoa,
              razao_social: data.nome, // Using name as Razao Social for simplicity
              cnpj: data.cnpj || null,
            },
          });
          idPessoaJuridica = pj.id_pessoa_juridica;
        } else {
          // Default to FISICA
          const pf = await tx.pessoaFisica.create({
            data: {
              id_pessoa: pessoa.id_pessoa,
              cpf: data.cpf || null,
            },
          });
          idPessoaFisica = pf.id_pessoa_fisica;
        }

        // 2. Create Cliente
        const cliente = await tx.cliente.create({
          data: {
            id_pessoa_fisica: idPessoaFisica,
            id_pessoa_juridica: idPessoaJuridica,
            tipo_pessoa: tipoPessoaId,
            telefone_1: data.telefone_1,
            telefone_2: data.telefone_2 || null,
            email: data.email || null,
            logradouro: data.logradouro || null,
            nr_logradouro: data.nr_logradouro || null,
            compl_logradouro: data.compl_logradouro || null,
            bairro: data.bairro || null,
            cidade: data.cidade || null,
            estado: data.estado || null,
            cep: data.cep || null,
          },
        });

        console.log("‚úÖ Cliente transaction complete:", cliente.id_cliente);
        return cliente;
      });
    }

    // EXISTING LOGIC (If IDs are provided)
    const { id_pessoa_fisica, id_pessoa_juridica, ...clienteData } = data;

    const payload = {
      ...clienteData,
      id_pessoa_fisica: id_pessoa_fisica || null,
      id_pessoa_juridica: id_pessoa_juridica || null,
    };

    console.log(
      "üì§ ClienteRepository.create - Sending to Prisma:",
      JSON.stringify(payload, null, 2)
    );

    try {
      const result = await prisma.cliente.create({
        data: payload,
      });
      console.log("‚úÖ ClienteRepository.create - Success:", result.id_cliente);
      return result;
    } catch (error: any) {
      console.error("‚ùå ClienteRepository.create - Error:", error);
      throw error;
    }
  }

  async findAll() {
    return await prisma.cliente.findMany({
      include: {
        pessoa_fisica: { include: { pessoa: true } },
        pessoa_juridica: { include: { pessoa: true } },
        tipo: true,
        veiculos: true,
      },
    });
  }

  async findById(id: number) {
    return await prisma.cliente.findUnique({
      where: { id_cliente: id },
      include: {
        pessoa_fisica: { include: { pessoa: true } },
        pessoa_juridica: { include: { pessoa: true } },
        tipo: true,
        veiculos: true,
        ordens_de_servico: true,
      },
    });
  }

  async update(id: number, data: Prisma.ClienteUpdateInput) {
    return await prisma.cliente.update({
      where: { id_cliente: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.cliente.delete({
      where: { id_cliente: id },
    });
  }

  // Case-insensitive & accent-insensitive search by name
  async searchByName(searchTerm: string) {
    const searchPattern = `%${searchTerm}%`;

    const ids = await prisma.$queryRaw<{ id_cliente: number }[]>`
      SELECT c.id_cliente
      FROM "cliente" c
      LEFT JOIN "pessoa_fisica" pf ON c.id_pessoa_fisica = pf.id_pessoa_fisica
      LEFT JOIN "pessoa" p1 ON pf.id_pessoa = p1.id_pessoa
      LEFT JOIN "pessoa_juridica" pj ON c.id_pessoa_juridica = pj.id_pessoa_juridica
      LEFT JOIN "pessoa" p2 ON pj.id_pessoa = p2.id_pessoa
      WHERE unaccent(p1.nome) ILIKE unaccent(${searchPattern})
         OR unaccent(p2.nome) ILIKE unaccent(${searchPattern})
         OR (pj.nome_fantasia IS NOT NULL AND unaccent(pj.nome_fantasia) ILIKE unaccent(${searchPattern}))
      LIMIT 20
    `;

    const idList = ids.map((item) => item.id_cliente);

    if (idList.length === 0) {
      return [];
    }

    return await prisma.cliente.findMany({
      where: {
        id_cliente: { in: idList },
      },
      include: {
        pessoa_fisica: { include: { pessoa: true } },
        pessoa_juridica: { include: { pessoa: true } },
        tipo: true,
        veiculos: true,
      },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\contasPagar.repository.ts
================================================================================
import { prisma } from "../prisma.js";

export class ContasPagarRepository {
  async create(data: any) {
    console.log("[ContasPagarRepo] Creating:", data);

    // Helper para normalizar datas para Meio-Dia UTC (Garante fidelidade do dia no Fuso BRT)
    // Evita que 00:00 UTC vire 21:00 do dia anterior.
    const normalizeDate = (dateInfo: any) => {
      if (!dateInfo) return null;
      const dt = new Date(dateInfo);
      dt.setUTCHours(12, 0, 0, 0);
      return dt;
    };

    if (data.dt_vencimento)
      data.dt_vencimento = normalizeDate(data.dt_vencimento);
    if (data.dt_pagamento) data.dt_pagamento = normalizeDate(data.dt_pagamento);

    return prisma.$transaction(async (tx) => {
      const created = await tx.contasPagar.create({ data });
      console.log("[ContasPagarRepo] Created Status:", created.status);

      // Se j√° nascer PAGO, lan√ßa no caixa
      if (created.status === "PAGO") {
        console.log("[ContasPagarRepo] Auto-launching Livro Caixa for Create");

        // Smart Date Logic for Livro Caixa
        let movimentoDate = new Date();
        if (data.dt_pagamento) {
          const pgDate = new Date(data.dt_pagamento);
          const now = new Date();
          const isSameDay =
            pgDate.toISOString().split("T")[0] ===
            now.toISOString().split("T")[0];
          if (!isSameDay) movimentoDate = pgDate;
        }

        await tx.livroCaixa.create({
          data: {
            descricao: `Conta: ${created.descricao}${created.credor ? " - " + created.credor : ""}`,
            valor: created.valor,
            tipo_movimentacao: "SAIDA",
            categoria: created.categoria || "DESPESAS GERAIS",
            dt_movimentacao: movimentoDate,
            origem: "AUTOMATICA",
            obs: `Referente √† conta a pagar #${created.id_conta_pagar}. ${data.obs || ""}`,
          },
        });
      }
      return created;
    });
  }

  // ... findAll / findById ...
  async findAll() {
    return prisma.contasPagar.findMany({
      where: { deleted_at: null },
      orderBy: { dt_vencimento: "asc" },
    });
  }

  async findById(id: number) {
    return prisma.contasPagar.findUnique({
      where: { id_conta_pagar: id },
    });
  }

  async update(id: number, data: any) {
    console.log(`[ContasPagarRepo] Updating ID ${id} with:`, data);

    // Redefinindo o helper aqui ou usando l√≥gica direta para manter o arquivo limpo se n√£o extra√≠ pra fora da classe
    const normalizeDate = (dateInfo: any) => {
      if (!dateInfo) return null;
      const dt = new Date(dateInfo);
      dt.setUTCHours(12, 0, 0, 0);
      return dt;
    };

    if (data.dt_vencimento)
      data.dt_vencimento = normalizeDate(data.dt_vencimento);
    if (data.dt_pagamento) data.dt_pagamento = normalizeDate(data.dt_pagamento);

    const { id_conta_bancaria: idContaRaw, ...updateData } = data;

    // ... dentro de update ...
    // Checar estado anterior
    const current = await prisma.contasPagar.findUnique({
      where: { id_conta_pagar: id },
    });
    console.log(
      `[ContasPagarRepo] Current status: ${current?.status}, New status: ${updateData.status}`,
    );

    const isPayingNow =
      current?.status !== "PAGO" && updateData.status === "PAGO";
    console.log("[ContasPagarRepo] Is Paying Now?", isPayingNow);

    return prisma.$transaction(async (tx) => {
      const updated = await tx.contasPagar.update({
        where: { id_conta_pagar: id },
        data: updateData, // Ensure we pass the modified data object with fixed dates
      });

      if (isPayingNow) {
        console.log("[ContasPagarRepo] Auto-launching Livro Caixa for Update");

        const id_conta_bancaria = idContaRaw ? Number(idContaRaw) : null;

        // Smart Date Logic for Livro Caixa
        // Se data.dt_pagamento existe (foi processada para 12h ou veio no payload)
        // Verificamos se √© "HOJE". Se for, usamos AGORA (pra ter hora certa).
        // Se n√£o, usamos a data processada (12h) para garantir o dia.
        let movimentoDate = new Date();
        if (data.dt_pagamento) {
          const pgDate = new Date(data.dt_pagamento);
          const now = new Date();
          // Check if same day (ignoring time)
          const isSameDay =
            pgDate.toISOString().split("T")[0] ===
            now.toISOString().split("T")[0]; // Crude check but works for simplified UTC comparison logic established

          if (!isSameDay) {
            movimentoDate = pgDate; // Use the 12:00 UTC date
          }
          // If it IS same day, we stick with 'movimentoDate = new Date()' to capture exact current time
        }

        await tx.livroCaixa.create({
          data: {
            descricao: `Conta: ${updated.descricao}${updated.credor ? " - " + updated.credor : ""}`,
            valor: updated.valor,
            tipo_movimentacao: "SAIDA",
            categoria: updated.categoria || "DESPESAS GERAIS",
            dt_movimentacao: movimentoDate,
            origem: "AUTOMATICA",
            obs: `Referente √† conta a pagar #${updated.id_conta_pagar}. ${updated.obs || ""}`,
            id_conta_bancaria: id_conta_bancaria,
          },
        });

        if (id_conta_bancaria) {
          console.log(
            `[ContasPagarRepo] Updating Bank Balance for Conta ${id_conta_bancaria}: -${updated.valor}`,
          );
          await tx.contaBancaria.update({
            where: { id_conta: id_conta_bancaria },
            data: { saldo_atual: { decrement: updated.valor } },
          });
        }
      }

      const isReverting = current?.status === "PAGO" && data.status !== "PAGO";
      if (isReverting) {
        console.log(
          `[ContasPagarRepo] Reverting payment for ID ${id} - Removing LivroCaixa entry`,
        );

        // Find existing entries to refund balance if needed
        const entriesToDelete = await tx.livroCaixa.findMany({
          where: {
            origem: "AUTOMATICA",
            obs: { startsWith: `Referente √† conta a pagar #${id}` },
            deleted_at: null,
          },
        });

        for (const entry of entriesToDelete) {
          if (entry.id_conta_bancaria) {
            console.log(
              `[ContasPagarRepo] Refunding Bank Balance for Conta ${entry.id_conta_bancaria}: +${entry.valor}`,
            );
            await tx.contaBancaria.update({
              where: { id_conta: entry.id_conta_bancaria },
              data: { saldo_atual: { increment: entry.valor } },
            });
          }
        }

        if (entriesToDelete.length > 0) {
          await tx.livroCaixa.updateMany({
            where: {
              id_livro_caixa: {
                in: entriesToDelete.map((e) => e.id_livro_caixa),
              },
            },
            data: { deleted_at: new Date() },
          });
        }
      }

      return updated;
    });
  }

  async delete(id: number) {
    return prisma.contasPagar.update({
      where: { id_conta_pagar: id },
      data: { deleted_at: new Date() },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\fechamentoFinanceiro.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class FechamentoFinanceiroRepository {
  async create(data: Prisma.FechamentoFinanceiroCreateInput) {
    return await prisma.fechamentoFinanceiro.create({
      data,
    });
  }

  async findAll() {
    return await prisma.fechamentoFinanceiro.findMany({
        include: { 
            ordem_de_servico: {
                include: { 
                    veiculo: true,
                    servicos_mao_de_obra: {
                        where: { deleted_at: null },
                        include: {
                            funcionario: {
                                include: {
                                    pessoa_fisica: {
                                        include: {
                                            pessoa: true
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            } 
        }
    });
  }

  async findById(id: number) {
    return await prisma.fechamentoFinanceiro.findUnique({
      where: { id_fechamento_financeiro: id },
        include: { ordem_de_servico: true }
    });
  }

  async update(id: number, data: Prisma.FechamentoFinanceiroUpdateInput) {
    return await prisma.fechamentoFinanceiro.update({
      where: { id_fechamento_financeiro: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.fechamentoFinanceiro.delete({
      where: { id_fechamento_financeiro: id },
    });
  }

  /**
   * Consolida uma OS financeiramente
   * - Cria lan√ßamentos no Livro Caixa para TODOS os pagamentos
   * - PIX: Atualiza saldo banc√°rio imediatamente
   * - Dinheiro: Apenas lan√ßamento no caixa
   * - D√©bito/Cr√©dito: Lan√ßamento no caixa + cria receb√≠vel (N√ÉO atualiza saldo ainda)
   */
  async consolidarOS(idOs: number, custoTotalPecasReal: number) {
    return await prisma.$transaction(async (tx) => {
      // 1. Buscar OS com todos os pagamentos
      const os = await tx.ordemDeServico.findUnique({
        where: { id_os: idOs },
        include: {
          pagamentos_cliente: {
            where: { deleted_at: null }
          }
        }
      });

      if (!os) {
        throw new Error('OS n√£o encontrada');
      }

      if (os.status !== 'PRONTO PARA FINANCEIRO') {
        throw new Error('OS n√£o est√° pronta para consolida√ß√£o financeira');
      }

      // 2. Criar Fechamento Financeiro
      const fechamento = await tx.fechamentoFinanceiro.create({
        data: {
          id_os: idOs,
          custo_total_pecas_real: custoTotalPecasReal,
          data_fechamento_financeiro: new Date()
        }
      });

      // 3. Processar cada pagamento do cliente (STRICT MODE)
      console.log(`üîç [CONSOLIDA√á√ÉO STRICT] Processando ${os.pagamentos_cliente.length} pagamento(s) para OS #${idOs}`);
      
      for (const pagamento of os.pagamentos_cliente) {
        const metodo = (pagamento.metodo_pagamento || '').trim().toUpperCase();
        const valorPagamento = Number(pagamento.valor);
        const idContaBancaria = (pagamento as any).id_conta_bancaria;
        const idOperadora = pagamento.id_operadora;
        const idPagamentoCliente = pagamento.id_pagamento_cliente;

        console.log(`   üî∏ Pagamento ${idPagamentoCliente}: ${metodo} | R$ ${valorPagamento}`);

        // VALIDA√á√ÉO PR√âVIA (FAIL FAST)
        if ((metodo === 'PIX' || metodo === 'DINHEIRO') && !idContaBancaria) {
            throw new Error(`Pagamento ${metodo} (R$ ${valorPagamento}) sem Conta Banc√°ria definida!`);
        }
        if ((metodo === 'CREDITO' || metodo === 'DEBITO') && !idOperadora) {
            throw new Error(`Pagamento ${metodo} (R$ ${valorPagamento}) sem Operadora definida!`);
        }

        // --- FLUXO 1: DINHEIRO (IMEDIATO) ---
        // PIX agora entra no fluxo de receb√≠veis (diferido), assim como Cart√£o.
        if (metodo === 'DINHEIRO') {
          
          // VERIFICA SE J√Å FOI PROCESSADO
          if ((pagamento as any).id_livro_caixa) {
              console.log(`      ‚ö†Ô∏è [SKIP] Pagamento ${idPagamentoCliente} j√° possui Livro Caixa #${(pagamento as any).id_livro_caixa}. Ignorando duplica√ß√£o.`);
              continue;
          }

          // 1.1 Criar LivroCaixa (Dinheiro entra direto no Caixa mas n√£o vinculamos conta banc√°ria para evitar duplicidade de saldo se houver)
          // Mas Dinheiro f√≠sico n√£o afeta saldo de conta banc√°ria digital, apenas saldo de "Caixa".
          // Se houver uma conta "Caixa F√≠sico", usamos o ID dela.
          const targetContaId = idContaBancaria; // Se o usu√°rio selecionou "Caixa", usa ele.

          const livroCaixa = await tx.livroCaixa.create({
            data: {
              descricao: `Venda ${metodo} - OS #${idOs}`,
              valor: valorPagamento,
              tipo_movimentacao: 'ENTRADA',
              categoria: 'VENDA',
              dt_movimentacao: new Date(),
              origem: 'AUTOMATICA',
              id_conta_bancaria: null // Dinheiro n√£o gera extrato banc√°rio autom√°tico (apenas Livro Caixa)
            }
          });

          // 1.2 Vincular ao PagamentoCliente
          await tx.pagamentoCliente.update({
            where: { id_pagamento_cliente: idPagamentoCliente },
            data: { id_livro_caixa: (livroCaixa as any).id_livro_caixa } as any
          });

          // Dinheiro n√£o atualiza saldo de conta banc√°ria autom√°tica por enquanto, 
          // a menos que tiv√©ssemos uma conta "Caixa F√≠sico" expl√≠cita no sistema com saldo.
          // O comportamento anterior para Dinheiro era apenas Log.
          
          console.log(`      ‚úÖ [DINHEIRO] Livro Caixa gerado (Sem impacto no Saldo Banc√°rio Digital)`);
        } 
        
        // --- FLUXO 2: CART√ÉO (DIFERIDO) ---
        else if (metodo === 'DEBITO' || metodo === 'CREDITO') {
          // Prepara nome da operadora para descri√ß√£o
          let operadoraNome = '';
          if (idOperadora) {
             const op = await tx.operadoraCartao.findUnique({ where: { id_operadora: idOperadora } });
             operadoraNome = op?.nome || '';
          }

          // 2.1 Criar LivroCaixa (SEM CONTA BANC√ÅRIA -> N√ÉO aparece no Extrato, apenas Faturamento)
          const livroCaixa = await tx.livroCaixa.create({
            data: {
              descricao: `Venda Cart√£o ${metodo} ${operadoraNome ? `(${operadoraNome})` : ''} - OS #${idOs}`,
              valor: valorPagamento,
              tipo_movimentacao: 'ENTRADA',
              categoria: 'VENDA',
              dt_movimentacao: new Date(),
              origem: 'AUTOMATICA',
              id_conta_bancaria: null // NULL PARA N√ÉO AFETAR EXTRATO/SALDO AGORA
            }
          });
          
          // 2.2 Vincular ao PagamentoCliente
          await tx.pagamentoCliente.update({
            where: { id_pagamento_cliente: idPagamentoCliente },
            data: { id_livro_caixa: (livroCaixa as any).id_livro_caixa } as any
          });

          // 2.3 Criar Receb√≠veis (C√°lculo de Parcelas e Taxas)
          if (idOperadora) {
            const operadora = await tx.operadoraCartao.findUnique({ where: { id_operadora: idOperadora } });

            if (operadora) {
              const taxa = metodo === 'DEBITO' 
                ? Number(operadora.taxa_debito) 
                : (pagamento.qtd_parcelas === 1 ? Number(operadora.taxa_credito_vista) : Number(operadora.taxa_credito_parc));
              
              const prazo = metodo === 'DEBITO'
                ? Number(operadora.prazo_debito)
                : (pagamento.qtd_parcelas === 1 ? Number(operadora.prazo_credito_vista) : Number(operadora.prazo_credito_parc));

              const taxaAplicada = (valorPagamento * taxa) / 100;
              const valorLiquido = valorPagamento - taxaAplicada;

              // Data base para vencimento
              const dataPrevistaBase = new Date();
              dataPrevistaBase.setDate(dataPrevistaBase.getDate() + prazo);

              const qtdParcelas = pagamento.qtd_parcelas || 1;
              const valorPorParcela = valorPagamento / qtdParcelas;
              const valorLiquidoPorParcela = valorLiquido / qtdParcelas;
              const taxaPorParcela = taxaAplicada / qtdParcelas;

              for (let i = 1; i <= qtdParcelas; i++) {
                const dataPrevistaParcela = new Date(dataPrevistaBase);
                dataPrevistaParcela.setMonth(dataPrevistaParcela.getMonth() + (i - 1));

                await tx.recebivelCartao.create({
                  data: {
                    id_os: idOs,
                    id_operadora: idOperadora,
                    num_parcela: i,
                    total_parcelas: qtdParcelas,
                    valor_bruto: valorPorParcela,
                    valor_liquido: valorLiquidoPorParcela,
                    taxa_aplicada: taxaPorParcela,
                    data_venda: new Date(),
                    data_prevista: dataPrevistaParcela,
                    status: 'PENDENTE' // AGUARDANDO CONCILIA√á√ÉO
                  }
                });
              }
              console.log(`      ‚úÖ [CART√ÉO] ${qtdParcelas} parcela(s) criada(s) em Receb√≠veis.`);
            }
          }
        }
      }

      await tx.ordemDeServico.update({
        where: { id_os: idOs },
        data: { status: 'FINALIZADA' }
      });

      return fechamento;
    });
  }
}




================================================================================
FILE PATH: server\src\repositories\fornecedor.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class FornecedorRepository {
  async create(data: Prisma.FornecedorCreateInput) {
    return await prisma.fornecedor.create({
      data,
    });
  }

  async findAll() {
    return await prisma.fornecedor.findMany();
  }

  async findById(id: number) {
    return await prisma.fornecedor.findUnique({
      where: { id_fornecedor: id },
    });
  }

  async update(id: number, data: Prisma.FornecedorUpdateInput) {
    return await prisma.fornecedor.update({
      where: { id_fornecedor: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.fornecedor.delete({
      where: { id_fornecedor: id },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\funcionario.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class FuncionarioRepository {
  async create(data: Prisma.FuncionarioCreateInput) {
    return await prisma.funcionario.create({
      data,
    });
  }

  async findAll() {
    return await prisma.funcionario.findMany({
        include: { pessoa_fisica: { include: { pessoa: true } } }
    });
  }

  async findById(id: number) {
    return await prisma.funcionario.findUnique({
      where: { id_funcionario: id },
      include: { pessoa_fisica: { include: { pessoa: true } } }
    });
  }

  async update(id: number, data: Prisma.FuncionarioUpdateInput) {
    return await prisma.funcionario.update({
      where: { id_funcionario: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.funcionario.delete({
      where: { id_funcionario: id },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\itensOs.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';
import { AuditLogRepository } from './auditLog.repository.js';
import { OrdemDeServicoRepository } from './ordemDeServico.repository.js';

const auditRepo = new AuditLogRepository();
const osRepo = new OrdemDeServicoRepository();

export class ItensOsRepository {
  async create(data: Prisma.ItensOsCreateInput) {
    const created = await prisma.itensOs.create({
      data,
    });
    
    await auditRepo.create({
        tabela: 'itens_os',
        registro_id: created.id_iten,
        acao: 'CREATE',
        valor_novo: created
    });

    // Recalculate OS totals
    await osRepo.recalculateTotals(created.id_os);
    
    return created;
  }

  async findAll() {
    return await prisma.itensOs.findMany({
        where: { deleted_at: null },
        include: { ordem_de_servico: true, pecas_estoque: true, pagamentos_peca: true }
    });
  }

  async findById(id: number) {
    return await prisma.itensOs.findUnique({
      where: { id_iten: id },
        include: { ordem_de_servico: true, pecas_estoque: true, pagamentos_peca: true }
    });
  }

  async findByOsId(idOs: number) {
    return await prisma.itensOs.findMany({
      where: { id_os: idOs, deleted_at: null },
      include: { pecas_estoque: true, pagamentos_peca: true }
    });
  }

  async update(id: number, data: Prisma.ItensOsUpdateInput) {
    const current = await this.findById(id);
    const updated = await prisma.itensOs.update({
      where: { id_iten: id },
      data,
    });

    await auditRepo.create({
        tabela: 'itens_os',
        registro_id: id,
        acao: 'UPDATE',
        valor_antigo: current,
        valor_novo: updated
    });
    
    // Recalculate OS totals
    await osRepo.recalculateTotals(updated.id_os);

    return updated;
  }

  async delete(id: number) {
    const current = await this.findById(id);
    if (!current) throw new Error('Item not found');

    const updated = await prisma.itensOs.update({
      where: { id_iten: id },
      data: { deleted_at: new Date() }
    });

    await auditRepo.create({
        tabela: 'itens_os',
        registro_id: id,
        acao: 'SOFT_DELETE',
        valor_antigo: current
    });
    
    // Recalculate OS totals
    await osRepo.recalculateTotals(current.id_os);

    return updated;
  }

  async search(query: string) {
    // Busca descri√ß√µes √∫nicas na tabela de itens j√° usados
    return await prisma.itensOs.findMany({
      where: {
        descricao: { contains: query, mode: 'insensitive' },
        deleted_at: null
      },
      distinct: ['descricao'],
      take: 10
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\ordemDeServico.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';
import { AuditLogRepository } from './auditLog.repository.js';

const auditRepo = new AuditLogRepository();

export class OrdemDeServicoRepository {
  async create(data: Prisma.OrdemDeServicoCreateInput) {
    const created = await prisma.ordemDeServico.create({
      data,
    });
    
    await auditRepo.create({
        tabela: 'ordem_de_servico',
        registro_id: created.id_os,
        acao: 'CREATE',
        valor_novo: created
    });
    
    return created;
  }

  async createUnified(data: any) {
    return await prisma.$transaction(async (tx) => {
        let finalClientId = data.client.id_cliente;

        // 1. Handle Client Creation if needed
        if (!finalClientId) {
             const isJuridica = data.client.tipo === 'JURIDICA';
             
             // Base Pessoa
             const pessoa = await tx.pessoa.create({
                 data: { nome: data.client.nome }
             });

             let idPessoaFisica = null;
             let idPessoaJuridica = null;
             let tipoId = 1; // Default Default 1=Fisica

             if (isJuridica) {
                 tipoId = 2; // Default 2=Juridica
                 const pj = await tx.pessoaJuridica.create({
                     data: {
                         id_pessoa: pessoa.id_pessoa,
                         razao_social: data.client.nome,
                         cnpj: data.client.cnpj || null
                     }
                 });
                 idPessoaJuridica = pj.id_pessoa_juridica;
             } else {
                 const pf = await tx.pessoaFisica.create({
                     data: {
                         id_pessoa: pessoa.id_pessoa,
                         cpf: data.client.cpf || null
                     }
                 });
                 idPessoaFisica = pf.id_pessoa_fisica;
             }

             const newClient = await tx.cliente.create({
                 data: {
                     id_pessoa_fisica: idPessoaFisica,
                     id_pessoa_juridica: idPessoaJuridica,
                     tipo_pessoa: tipoId,
                     telefone_1: data.client.telefone,
                     logradouro: data.client.logradouro,
                     nr_logradouro: data.client.numero,
                     bairro: data.client.bairro,
                     cidade: data.client.cidade,
                     estado: data.client.estado
                 }
             });
             finalClientId = newClient.id_cliente;
        }

        // 2. Handle Vehicle Creation if needed
        let finalVehicleId = data.vehicle.id_veiculo;
        if (!finalVehicleId) {
             // Check if vehicle exists by Plate to avoid duplicates
             const existingVehicle = await tx.veiculo.findUnique({
                 where: { placa: data.vehicle.placa }
             });

             if (existingVehicle) {
                 // If vehicle exists, update owner to new client and use it
                 if (existingVehicle.id_cliente !== finalClientId) {
                     await tx.veiculo.update({
                         where: { id_veiculo: existingVehicle.id_veiculo },
                         data: { id_cliente: finalClientId }
                     });
                 }
                 finalVehicleId = existingVehicle.id_veiculo;
             } else {
                 const newVehicle = await tx.veiculo.create({
                     data: {
                         id_cliente: finalClientId,
                         placa: data.vehicle.placa,
                         marca: data.vehicle.marca,
                         modelo: data.vehicle.modelo,
                         cor: data.vehicle.cor || 'BRANCO',
                         ano_modelo: data.vehicle.ano,
                         combustivel: data.vehicle.combustivel || 'FLEX'
                     }
                 });
                 finalVehicleId = newVehicle.id_veiculo;
             }
        }

        // 3. Create OS
        const os = await tx.ordemDeServico.create({
            data: {
                id_cliente: finalClientId,
                id_veiculo: finalVehicleId,
                id_funcionario: Number(data.os.id_funcionario),
                km_entrada: Number(data.os.km_entrada),
                defeito_relatado: data.os.defeito_relatado,
                status: 'ABERTA',
                valor_total_cliente: 0,
                valor_mao_de_obra: 0,
                parcelas: 1 // Default
            }
        });

        await auditRepo.create({
            tabela: 'ordem_de_servico',
            registro_id: os.id_os,
            acao: 'CREATE',
            valor_novo: os
        });

        return os;
    });
  }

  async findAll() {
    return await prisma.ordemDeServico.findMany({
      where: { deleted_at: null },
      include: {
        cliente: {
          include: {
            pessoa_fisica: { include: { pessoa: true } },
            pessoa_juridica: { include: { pessoa: true } }
          }
        },
        veiculo: true,
        funcionario: { include: { pessoa_fisica: { include: { pessoa: true } } } },
        servicos_mao_de_obra: {
            select: {
                funcionario: {
                    select: {
                        id_funcionario: true,
                        pessoa_fisica: {
                            select: {
                                pessoa: { select: { nome: true } }
                            }
                        }
                    }
                }
            }
         },
        fechamento_financeiro: true
      }
    });
  }

  async findById(id: number) {
    return await prisma.ordemDeServico.findUnique({
      where: { id_os: id },
      include: {
        cliente: {
          include: {
            pessoa_fisica: { include: { pessoa: true } },
            pessoa_juridica: { include: { pessoa: true } }
          }
        },
        veiculo: true,
        funcionario: { include: { pessoa_fisica: { include: { pessoa: true } } } },
        itens_os: {
          where: { deleted_at: null },
          include: {
            pagamentos_peca: true,
            pecas_estoque: true
          }
        },
        fechamento_financeiro: true,
        pagamentos_cliente: {
          include: {
            // @ts-ignore: Prisma types delay
            conta_bancaria: true,
            operadora: true
          } as any
        },
        servicos_mao_de_obra: {
            where: { deleted_at: null },
            include: { funcionario: { include: { pessoa_fisica: { include: { pessoa: true } } } } }
        }
      }
    });
  }

  async findByVehicleId(vehicleId: number) {
    return await prisma.ordemDeServico.findMany({
      where: { id_veiculo: vehicleId, deleted_at: null },
      orderBy: { dt_abertura: 'desc' },
      select: {
        id_os: true,
        dt_abertura: true,
        dt_entrega: true,
        km_entrada: true,
        status: true,
        defeito_relatado: true,
        diagnostico: true,
        obs_final: true,
        valor_total_cliente: true,
        valor_mao_de_obra: true,
        valor_pecas: true,
        funcionario: {
          select: {
            id_funcionario: true,
            pessoa_fisica: { select: { pessoa: { select: { nome: true } } } }
          }
        },
        itens_os: {
          select: {
            id_iten: true,
            descricao: true,
            quantidade: true,
            valor_venda: true,
            valor_total: true
          }
        },
        servicos_mao_de_obra: {
            select: {
                id_servico_mao_de_obra: true,
                valor: true,
                descricao: true,
                funcionario: {
                  select: {
                    id_funcionario: true,
                    pessoa_fisica: { select: { pessoa: { select: { nome: true } } } }
                  }
                }
            }
        },
        pagamentos_cliente: true
      }
    });
  }

  async update(id: number, data: Prisma.OrdemDeServicoUpdateInput) {
    const current = await this.findById(id);
    if (!current) throw new Error('OS not found');
    
    // Check lock if finalized or paid (unless it's a specific internal update we might allow, but user said disable for users)
    // Assuming this repo usage is for general updates.
    // If status is FINALIZADA or PAGA, prevent update?
    // "Implementar uma trava onde, ap√≥s a OS ser marcada como "Finalizada" ou "Paga", o salvamento autom√°tico e as edi√ß√µes sejam desabilitados"
    // This is best enforced in Controller or Service, but Repo is the last line of defense.
    // However, sometimes we need to update status FROM Finalizada TO Something else (Reopen).
    // So assume the Caller handles logic, or we check if data DOES NOT contain status change.
    
    const updated = await prisma.ordemDeServico.update({
      where: { id_os: id },
      data,
    });

    await auditRepo.create({
        tabela: 'ordem_de_servico',
        registro_id: id,
        acao: 'UPDATE',
        valor_antigo: current,
        valor_novo: updated
    });

    return updated;
  }

  async delete(id: number) {
    // Soft Delete
    const current = await this.findById(id);
    if (!current) throw new Error('OS not found');

    const updated = await prisma.ordemDeServico.update({
      where: { id_os: id },
      data: { deleted_at: new Date() }
    });
    
    await auditRepo.create({
        tabela: 'ordem_de_servico',
        registro_id: id,
        acao: 'SOFT_DELETE',
        valor_antigo: current
    });
    
    return updated;
  }

  async recalculateTotals(id_os: number) {
    const items = await prisma.itensOs.aggregate({
        where: { id_os, deleted_at: null },
        _sum: { valor_total: true }
    });
    
    const labor = await prisma.servicoMaoDeObra.aggregate({
        where: { id_os, deleted_at: null },
        _sum: { valor: true }
    });

    const valor_pecas = items._sum?.valor_total || new Prisma.Decimal(0);
    const valor_mao_de_obra = labor._sum?.valor || new Prisma.Decimal(0);
    
    // Ensure accurate decimal addition
    const valor_total_cliente = new Prisma.Decimal(valor_pecas).plus(new Prisma.Decimal(valor_mao_de_obra));

    await prisma.ordemDeServico.update({
        where: { id_os },
        data: {
            valor_pecas,
            valor_mao_de_obra,
            valor_total_cliente
        }
    });

    return { valor_pecas, valor_mao_de_obra, valor_total_cliente };
  }

  async adjustStockForOS(id_os: number, action: 'DEDUCT' | 'RETURN') {
      const items = await prisma.itensOs.findMany({
          where: { id_os, id_pecas_estoque: { not: null }, deleted_at: null }
      });

      for (const item of items) {
          if (!item.id_pecas_estoque) continue;

          if (action === 'DEDUCT') {
              await prisma.pecasEstoque.update({
                  where: { id_pecas_estoque: item.id_pecas_estoque },
                  data: { estoque_atual: { decrement: item.quantidade } }
              });
          } else {
              await prisma.pecasEstoque.update({
                  where: { id_pecas_estoque: item.id_pecas_estoque },
                  data: { estoque_atual: { increment: item.quantidade } }
              });
          }
      }
  }
}



================================================================================
FILE PATH: server\src\repositories\pagamentoCliente.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class PagamentoClienteRepository {
  async create(data: Prisma.PagamentoClienteCreateInput) {
    return await prisma.$transaction(async (tx) => {
      // 1. Criar Pagamento
      const pagamento = await tx.pagamentoCliente.create({ data });

      // 2. Processamento Financeiro Imediato
      const p = pagamento as any; // Cast to avoid TS errors
      const metodo = (p.metodo_pagamento || '').toUpperCase();
      const idConta = p.id_conta_bancaria;

      // CASO 1: PIX (Vai pro Banco + Livro Caixa)
      if (metodo === 'PIX' && idConta) {
        const livroCaixa = await tx.livroCaixa.create({
          data: {
            descricao: `Venda PIX - OS #${p.id_os} (Antecipado)`,
            valor: p.valor,
            tipo_movimentacao: 'ENTRADA',
            categoria: 'VENDA',
            dt_movimentacao: new Date(),
            origem: 'AUTOMATICA',
            id_conta_bancaria: idConta // VINCULADO AO BANCO
          }
        });

        await tx.contaBancaria.update({
          where: { id_conta: idConta },
          data: { saldo_atual: { increment: p.valor } }
        });

        await tx.pagamentoCliente.update({
          where: { id_pagamento_cliente: p.id_pagamento_cliente },
          data: { id_livro_caixa: livroCaixa.id_livro_caixa } as any
        });
        console.log(`‚úÖ [LC] PIX Imediato Criado: LC #${livroCaixa.id_livro_caixa} | Conta #${idConta} (+${p.valor})`);
      }

      // CASO 2: DINHEIRO (Vai S√ì pro Livro Caixa, SEM Banco)
      else if (metodo === 'DINHEIRO') {
        const livroCaixa = await tx.livroCaixa.create({
          data: {
            descricao: `Venda DINHEIRO - OS #${p.id_os} (Antecipado)`,
            valor: p.valor,
            tipo_movimentacao: 'ENTRADA',
            categoria: 'VENDA',
            dt_movimentacao: new Date(),
            origem: 'AUTOMATICA',
            id_conta_bancaria: null // N√ÉO VINCULADO AO BANCO
          }
        });

        // N√ÉO ATUALIZA SALDO BANC√ÅRIO

        await tx.pagamentoCliente.update({
          where: { id_pagamento_cliente: p.id_pagamento_cliente },
          data: { id_livro_caixa: livroCaixa.id_livro_caixa } as any
        });
        console.log(`‚úÖ [LC] DINHEIRO Imediato Criado: LC #${livroCaixa.id_livro_caixa} (Sem impacto banc√°rio)`);
      }

      return pagamento;
    });
  }

  async findAll() {
    return await prisma.pagamentoCliente.findMany({
        include: { 
          ordem_de_servico: {
            include: {
              veiculo: true,
              cliente: {
                include: {
                  pessoa_fisica: { include: { pessoa: true } },
                  pessoa_juridica: { include: { pessoa: true } }
                }
              }
            }
          },
          // @ts-ignore
          conta_bancaria: true,
          // @ts-ignore
          operadora: true
        }
    });
  }

  async findById(id: number) {
    return await prisma.pagamentoCliente.findUnique({
      where: { id_pagamento_cliente: id },
      include: { ordem_de_servico: true }
    });
  }

  async update(id: number, data: Prisma.PagamentoClienteUpdateInput) {
    return await prisma.$transaction(async (tx) => {
      // 1. Buscar estado anterior
      const oldPayment = await tx.pagamentoCliente.findUnique({ where: { id_pagamento_cliente: id } });
      if (!oldPayment) throw new Error("Pagamento n√£o encontrado");
      const oldP = oldPayment as any;

      // 2. REVERS√ÉO (Se j√° tinha processamento financeiro)
      if (oldP.id_livro_caixa) {
        // Estornar saldo conta antiga (SE TIVER)
        if (oldP.id_conta_bancaria) {
            await tx.contaBancaria.update({
                where: { id_conta: oldP.id_conta_bancaria },
                data: { saldo_atual: { decrement: oldP.valor } }
            });
            console.log(`‚Ü∫ [LC] Revers√£o Pagamento #${id}: Conta #${oldP.id_conta_bancaria} (-${oldP.valor})`);
        }
        
        // Remover entrada antiga livro caixa (SEMPRE)
        await tx.livroCaixa.delete({
            where: { id_livro_caixa: oldP.id_livro_caixa }
        });
      }

      // 3. Atualizar Pagamento (Desvinculando LC antigo se houver, pois foi deletado acima)
      const updatedPayment = await tx.pagamentoCliente.update({
        where: { id_pagamento_cliente: id },
        data: { ...data, id_livro_caixa: null } as any
      });

      // 4. NOVA APLICA√á√ÉO
      const newP = updatedPayment as any;
      const metodo = (newP.metodo_pagamento || '').toUpperCase();
      const idConta = newP.id_conta_bancaria;

      // CASO 1: PIX (Banco + LC)
      if (metodo === 'PIX' && idConta) {
         const livroCaixa = await tx.livroCaixa.create({
          data: {
            descricao: `Venda PIX - OS #${newP.id_os} (Atualizado)`,
            valor: newP.valor,
            tipo_movimentacao: 'ENTRADA',
            categoria: 'VENDA',
            dt_movimentacao: new Date(),
            origem: 'AUTOMATICA',
            id_conta_bancaria: idConta
          }
        });

        await tx.contaBancaria.update({
          where: { id_conta: idConta },
          data: { saldo_atual: { increment: newP.valor } }
        });

        await tx.pagamentoCliente.update({
            where: { id_pagamento_cliente: id },
            data: { id_livro_caixa: livroCaixa.id_livro_caixa } as any
        });
        console.log(`‚úÖ [LC] PIX Atualizado: LC #${livroCaixa.id_livro_caixa} | Conta #${idConta} (+${newP.valor})`);
      }
      
      // CASO 2: DINHEIRO (S√≥ LC)
      else if (metodo === 'DINHEIRO') {
         const livroCaixa = await tx.livroCaixa.create({
          data: {
            descricao: `Venda DINHEIRO - OS #${newP.id_os} (Atualizado)`,
            valor: newP.valor,
            tipo_movimentacao: 'ENTRADA',
            categoria: 'VENDA',
            dt_movimentacao: new Date(),
            origem: 'AUTOMATICA',
            id_conta_bancaria: null
          }
        });

        await tx.pagamentoCliente.update({
            where: { id_pagamento_cliente: id },
            data: { id_livro_caixa: livroCaixa.id_livro_caixa } as any
        });
        console.log(`‚úÖ [LC] DINHEIRO Atualizado: LC #${livroCaixa.id_livro_caixa} (Sem impacto banc√°rio)`);
      }


      return updatedPayment;
    });
  }

  async delete(id: number) {
    return await prisma.$transaction(async (tx) => {
        const payment = await tx.pagamentoCliente.findUnique({ where: { id_pagamento_cliente: id } });
        if (!payment) throw new Error("Pagamento n√£o encontrado");
        const p = payment as any;

        // Estornar se tiver LC
        if (p.id_livro_caixa) {
             if (p.id_conta_bancaria) {
                 await tx.contaBancaria.update({
                     where: { id_conta: p.id_conta_bancaria },
                     data: { saldo_atual: { decrement: p.valor } }
                });
                console.log(`üóëÔ∏è [LC] Pagamento Exclu√≠do/Estornado #${id}: Conta #${p.id_conta_bancaria} (-${p.valor})`);
             }
             
            await tx.livroCaixa.delete({ where: { id_livro_caixa: p.id_livro_caixa } });
        }

        return await tx.pagamentoCliente.update({
          where: { id_pagamento_cliente: id },
          data: { deleted_at: new Date(), id_livro_caixa: null } as any
        });
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\pagamentoPeca.repository.ts
================================================================================
import { Prisma } from "@prisma/client";
import { prisma } from "../prisma.js";

export class PagamentoPecaRepository {
  async create(data: Prisma.PagamentoPecaCreateInput) {
    return await prisma.pagamentoPeca.create({
      data,
    });
  }

  async findAll() {
    return await prisma.pagamentoPeca.findMany({
      include: {
        fornecedor: true,
        item_os: {
          include: {
            ordem_de_servico: {
              include: {
                veiculo: true,
                cliente: {
                  include: {
                    pessoa_fisica: { include: { pessoa: true } },
                    pessoa_juridica: { include: { pessoa: true } },
                  },
                },
              },
            },
          },
        },
      },
    });
  }

  async findById(id: number) {
    return await prisma.pagamentoPeca.findUnique({
      where: { id_pagamento_peca: id },
      include: { item_os: true, fornecedor: true },
    });
  }

  async findByItemId(itemId: number) {
    return await prisma.pagamentoPeca.findMany({
      where: { id_item_os: itemId },
      include: { fornecedor: true },
    });
  }

  async update(id: number, data: Prisma.PagamentoPecaUpdateInput) {
    return await prisma.pagamentoPeca.update({
      where: { id_pagamento_peca: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.pagamentoPeca.update({
      where: { id_pagamento_peca: id },
      data: { deleted_at: new Date() },
    });
  }

  async confirmPayment(id: number, accountId: number, dataPagamento: Date) {
    return await prisma.$transaction(async (tx) => {
      const pagamento = await tx.pagamentoPeca.findUnique({
        where: { id_pagamento_peca: id },
        include: {
          fornecedor: true,
          item_os: { include: { ordem_de_servico: true } },
        },
      });

      if (!pagamento) throw new Error("Pagamento n√£o encontrado");
      // If already paid, do nothing or throw. Let's throw to be safe.
      if (pagamento.pago_ao_fornecedor)
        throw new Error("Pagamento j√° realizado.");

      // 1. Debit Account
      // We can skip checking existence if we trust FK, but logic-wise check saldo is good? No, let it be negative.
      await tx.contaBancaria.update({
        where: { id_conta: accountId },
        data: { saldo_atual: { decrement: pagamento.custo_real } },
      });

      // 2. Create Livro Caixa Entry
      const lc = await tx.livroCaixa.create({
        data: {
          descricao: `Pag. Pe√ßa - OS #${pagamento.item_os.ordem_de_servico.id_os} - ${pagamento.fornecedor.nome}`,
          valor: pagamento.custo_real,
          tipo_movimentacao: "SAIDA",
          categoria: "Auto Pe√ßas",
          dt_movimentacao: dataPagamento,
          origem: "AUTOMATICA",
          id_conta_bancaria: accountId,
        },
      });

      // 3. Update Payment
      return await tx.pagamentoPeca.update({
        where: { id_pagamento_peca: id },
        data: {
          pago_ao_fornecedor: true,
          data_pagamento_fornecedor: dataPagamento,
          id_livro_caixa: lc.id_livro_caixa,
        },
      });
    });
  }

  async reversePayment(id: number) {
    return await prisma.$transaction(async (tx) => {
      const pagamento = await tx.pagamentoPeca.findUnique({
        where: { id_pagamento_peca: id },
        include: { livro_caixa: true },
      });

      if (!pagamento) throw new Error("Pagamento n√£o encontrado");
      if (!pagamento.pago_ao_fornecedor)
        throw new Error("Pagamento n√£o est√° pago, imposs√≠vel estornar.");

      // 1. Restore Account Balance and Delete Livro Caixa
      if (pagamento.id_livro_caixa && pagamento.livro_caixa) {
        if (pagamento.livro_caixa.id_conta_bancaria) {
          await tx.contaBancaria.update({
            where: { id_conta: pagamento.livro_caixa.id_conta_bancaria },
            data: { saldo_atual: { increment: pagamento.livro_caixa.valor } },
          });
        }
        // Soft Delete Livro Caixa (keeps log but marks as deleted)
        await tx.livroCaixa.update({
          where: { id_livro_caixa: pagamento.id_livro_caixa },
          data: { deleted_at: new Date() },
        });
      }

      // 2. Reset Payment Status
      return await tx.pagamentoPeca.update({
        where: { id_pagamento_peca: id },
        data: {
          pago_ao_fornecedor: false,
          data_pagamento_fornecedor: null,
          id_livro_caixa: null,
        },
      });
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\pecasEstoque.repository.ts
================================================================================
import { Prisma } from "@prisma/client";
import { prisma } from "../prisma.js";

export class PecasEstoqueRepository {
  async create(data: Prisma.PecasEstoqueCreateInput) {
    return await prisma.pecasEstoque.create({
      data,
    });
  }

  async findAll() {
    return await prisma.pecasEstoque.findMany({
      include: {
        itens_entrada: {
          take: 1,
          orderBy: { id_item_entrada: "desc" },
          include: {
            entrada: {
              include: { fornecedor: true },
            },
          },
        },
      },
      orderBy: { nome: "asc" },
    });
  }

  async findById(id: number) {
    return await prisma.pecasEstoque.findUnique({
      where: { id_pecas_estoque: id },
    });
  }

  async update(id: number, data: Prisma.PecasEstoqueUpdateInput) {
    return await prisma.pecasEstoque.update({
      where: { id_pecas_estoque: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.pecasEstoque.delete({
      where: { id_pecas_estoque: id },
    });
  }

  async search(query: string) {
    return await prisma.pecasEstoque.findMany({
      where: {
        OR: [
          { nome: { contains: query, mode: "insensitive" } },
          { descricao: { contains: query, mode: "insensitive" } },
        ],
      },
      take: 20,
      include: {
        itens_entrada: {
          take: 1,
          orderBy: { id_item_entrada: "desc" },
          include: {
            entrada: {
              include: { fornecedor: true },
            },
          },
        },
      },
    });
  }

  async createEntry(data: {
    id_fornecedor: number;
    nota_fiscal?: string;
    data_compra?: Date;
    obs?: string;
    itens: {
      id_pecas_estoque?: number;
      new_part_data?: any; // Name, Description, etc.
      quantidade: number;
      valor_custo: number;
      valor_venda: number;
      margem_lucro?: number;
      ref_cod?: string;
      obs?: string;
    }[];
  }) {
    return await prisma.$transaction(async (tx) => {
      // 1. Create Entry Header
      const entrada = await tx.entradaEstoque.create({
        data: {
          id_fornecedor: data.id_fornecedor,
          nota_fiscal: data.nota_fiscal || null,
          data_compra: data.data_compra || new Date(),
          valor_total: data.itens.reduce(
            (acc, i) => acc + Number(i.valor_custo) * Number(i.quantidade),
            0,
          ),
          obs: data.obs || null,
        },
      });

      // 2. Process Items
      for (const item of data.itens) {
        let partId = item.id_pecas_estoque;

        // 2a. Create Part if new
        if (!partId && item.new_part_data) {
          const newPart = await tx.pecasEstoque.create({
            data: {
              nome: item.new_part_data.nome,
              descricao:
                item.new_part_data.descricao || item.new_part_data.nome,
              unidade_medida: item.new_part_data.unidade_medida || "UN",
              estoque_atual: 0, // Will act increment below
              valor_custo: item.valor_custo,
              valor_venda: item.valor_venda,
              custo_unitario_padrao: item.valor_custo, // Init standard cost
              fabricante: item.new_part_data.fabricante || null,
            },
          });
          partId = newPart.id_pecas_estoque;
        }

        if (!partId)
          throw new Error("Item sem ID de pe√ßa e sem dados para cadastro.");

        // 2b. Create ItemEntrada
        await tx.itemEntrada.create({
          data: {
            id_entrada: entrada.id_entrada,
            id_pecas_estoque: partId,
            quantidade: item.quantidade,
            valor_custo: item.valor_custo,
            valor_venda: item.valor_venda,
            margem_lucro: item.margem_lucro || null,
            ref_cod: item.ref_cod || null,
            obs: item.obs || null,
          },
        });

        // 2c. Update Stock & Price
        await tx.pecasEstoque.update({
          where: { id_pecas_estoque: partId },
          data: {
            estoque_atual: { increment: item.quantidade },
            valor_venda: item.valor_venda, // Always update selling price as requested
            dt_ultima_compra: new Date(),
            // As per request: "sem atualizar o pre√ßo de custo das pe√ßas compradas anteriormente",
            // but we MUST update standard cost for new parts.
            // For existing parts, we might typically update Average Cost, but ignoring cost update here as strictly requested for existing.
            // NOTE: If it was a NEW part, we already set the cost in creation.
          },
        });
      }

      // 3. Process Financials (Contas a Pagar + Livro Caixa)
      // We check if 'financeiro' data was passed in the 'data' argument (need to update type definition first)
      if ((data as any).financeiro) {
        const fin = (data as any).financeiro;

        const conta = await tx.contasPagar.create({
          data: {
            descricao: fin.descricao,
            valor: fin.valor,
            dt_vencimento: new Date(fin.dt_vencimento),
            dt_pagamento:
              fin.status === "PAGO" ? new Date(fin.dt_pagamento) : null,
            status: fin.status,
            categoria: "PE√áAS",
            obs: `Ref. Entrada Estoque #${entrada.id_entrada}`,
          },
        });

        // If PAID, create Livro Caixa movement
        if (fin.status === "PAGO") {
          await tx.livroCaixa.create({
            data: {
              descricao: `Pagamento Compra Pe√ßas - ${fin.descricao}`,
              valor: fin.valor,
              tipo_movimentacao: "SAIDA",
              categoria: "FORNECEDOR",
              origem: "AUTOMATICA",
              dt_movimentacao: new Date(fin.dt_pagamento),
              obs: `Vinculado a Conta Pagar #${conta.id_conta_pagar}`,
            },
          });
        }
      }

      return entrada;
    });
  }

  async getAvailability(id: number) {
    const part = await prisma.pecasEstoque.findUnique({
      where: { id_pecas_estoque: id },
      select: {
        estoque_atual: true,
        nome: true,
        valor_venda: true,
        id_pecas_estoque: true,
      },
    });

    if (!part) return null;

    const reservedItems = await prisma.itensOs.aggregate({
      where: {
        id_pecas_estoque: id,
        deleted_at: null,
        ordem_de_servico: {
          status: {
            notIn: ["FINALIZADA", "PAGA_CLIENTE", "PRONTO PARA FINANCEIRO"],
          }, // Using active statuses
          deleted_at: null,
        },
      },
      _sum: { quantidade: true },
    });

    const reserved = reservedItems._sum.quantidade || 0;

    return {
      ...part,
      reserved,
    };
  }
}



================================================================================
FILE PATH: server\src\repositories\pessoa.repository.ts
================================================================================
import { Prisma, PrismaClient } from '@prisma/client';
import { prisma } from '../prisma.js';

export class PessoaRepository {
  async create(data: Prisma.PessoaCreateInput) {
    return await prisma.pessoa.create({
      data,
    });
  }

  async findAll() {
    return await prisma.pessoa.findMany();
  }

  async findById(id: number) {
    return await prisma.pessoa.findUnique({
      where: { id_pessoa: id },
    });
  }

  async update(id: number, data: Prisma.PessoaUpdateInput) {
    return await prisma.pessoa.update({
      where: { id_pessoa: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.pessoa.delete({
      where: { id_pessoa: id },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\pessoaFisica.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class PessoaFisicaRepository {
  async create(data: Prisma.PessoaFisicaCreateInput) {
    return await prisma.pessoaFisica.create({
      data,
    });
  }

  async findAll() {
    return await prisma.pessoaFisica.findMany({
        include: { pessoa: true }
    });
  }

  async findById(id: number) {
    return await prisma.pessoaFisica.findUnique({
      where: { id_pessoa_fisica: id },
      include: { pessoa: true }
    });
  }

  async update(id: number, data: Prisma.PessoaFisicaUpdateInput) {
    return await prisma.pessoaFisica.update({
      where: { id_pessoa_fisica: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.pessoaFisica.delete({
      where: { id_pessoa_fisica: id },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\pessoaJuridica.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class PessoaJuridicaRepository {
  async create(data: Prisma.PessoaJuridicaCreateInput) {
    return await prisma.pessoaJuridica.create({
      data,
    });
  }

  async findAll() {
    return await prisma.pessoaJuridica.findMany({
        include: { pessoa: true }
    });
  }

  async findById(id: number) {
    return await prisma.pessoaJuridica.findUnique({
      where: { id_pessoa_juridica: id },
      include: { pessoa: true }
    });
  }

  async update(id: number, data: Prisma.PessoaJuridicaUpdateInput) {
    return await prisma.pessoaJuridica.update({
      where: { id_pessoa_juridica: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.pessoaJuridica.delete({
      where: { id_pessoa_juridica: id },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\recebivelCartao.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class RecebivelCartaoRepository {
  async create(data: Prisma.RecebivelCartaoCreateInput) {
    return await prisma.recebivelCartao.create({
      data,
    });
  }

  async findAll() {
    const [recebiveis, pixPendentes] = await Promise.all([
      prisma.recebivelCartao.findMany({
        include: {
          operadora: {
            include: {
              conta_destino: true
            }
          },
          ordem_de_servico: {
            include: {
              cliente: {
                include: {
                  pessoa_fisica: { include: { pessoa: true } },
                  pessoa_juridica: true
                }
              },
              veiculo: true,
              pagamentos_cliente: true
            }
          }
        },
        orderBy: {
          data_prevista: 'asc'
        }
      }),
      // Buscar PIX Pendentes (Pagamentos de OS finalizada sem LivroCaixa)
      prisma.pagamentoCliente.findMany({
        where: {
          metodo_pagamento: 'PIX',
          deleted_at: null,
          id_livro_caixa: null,
          ordem_de_servico: {
            fechamento_financeiro: { isNot: null } // Apenas OSs Consolidadas
          }
        },
        include: {
          ordem_de_servico: {
            include: {
              cliente: {
                include: {
                  pessoa_fisica: { include: { pessoa: true } },
                  pessoa_juridica: true
                }
              },
              veiculo: true,
              pagamentos_cliente: true,
              fechamento_financeiro: true
            }
          },
          conta_bancaria: true // Incluir conta destino do PIX
        }
      })
    ]);

    // Mapear PIX para IRecebivelCartao "Virtual"
    const pixMapped = pixPendentes.map(p => ({
        id_recebivel: -p.id_pagamento_cliente, // ID Negativo para identificar PIX
        id_os: p.id_os,
        id_operadora: 999999, // ID Fict√≠cio
        valor_bruto: p.valor,
        valor_liquido: p.valor, // PIX n√£o tem taxa no sistema atual
        taxa_aplicada: 0,
        num_parcela: 1,
        total_parcelas: 1,
        data_venda: p.data_pagamento,
        data_prevista: p.data_pagamento, // Dispon√≠vel imediatamente
        status: 'PENDENTE',
        data_recebimento: null,
        confirmado_em: null,
        confirmado_por: null,
        created_at: p.data_pagamento,
        updated_at: p.data_pagamento,
        
        // Relacionamentos Simulados
        operadora: {
          id_operadora: 999999,
          nome: 'PIX', // Exibir como PIX na coluna Operadora
          taxa: 0,
          dias_recebimento: 0,
          ativo: true,
          id_conta_destino: p.id_conta_bancaria || 0,
          conta_destino: p.conta_bancaria || { nome: 'Conta N/I' } // Fallback
        },
        ordem_de_servico: p.ordem_de_servico
    }));

    // Merge e Sort
    return [...recebiveis, ...pixMapped].sort((a, b) => new Date(a.data_prevista).getTime() - new Date(b.data_prevista).getTime());
  }

  async findById(id: number) {
    return await prisma.recebivelCartao.findUnique({
      where: { id_recebivel: id },
      include: {
        operadora: {
          include: {
            conta_destino: true
          }
        },
        ordem_de_servico: {
          include: {
            cliente: {
              include: {
                pessoa_fisica: { include: { pessoa: true } },
                pessoa_juridica: true
              }
            },
            veiculo: true,
            pagamentos_cliente: true
          }
        }
      }
    });
  }

  async findByOperadora(idOperadora: number) {
    return await prisma.recebivelCartao.findMany({
      where: { id_operadora: idOperadora },
      include: {
        operadora: {
          include: {
            conta_destino: true
          }
        },
        ordem_de_servico: {
            include: {
              cliente: {
                include: {
                  pessoa_fisica: { include: { pessoa: true } },
                  pessoa_juridica: true
                }
              },
              veiculo: true,
              pagamentos_cliente: true
            }
          }
      },
      orderBy: {
        data_prevista: 'asc'
      }
    });
  }

  async findByStatus(status: string) {
    return await prisma.recebivelCartao.findMany({
      where: { status },
      include: {
        operadora: {
          include: {
            conta_destino: true
          }
        },
        ordem_de_servico: {
            include: {
              cliente: {
                include: {
                  pessoa_fisica: { include: { pessoa: true } },
                  pessoa_juridica: true
                }
              },
              veiculo: true,
              pagamentos_cliente: true
            }
          }
      },
      orderBy: {
        data_prevista: 'asc'
      }
    });
  }

  async findByDateRange(dataInicio: Date, dataFim: Date) {
    return await prisma.recebivelCartao.findMany({
      where: {
        data_prevista: {
          gte: dataInicio,
          lte: dataFim
        }
      },
      include: {
        operadora: {
          include: {
            conta_destino: true
          }
        },
        ordem_de_servico: {
            include: {
              cliente: {
                include: {
                  pessoa_fisica: { include: { pessoa: true } },
                  pessoa_juridica: true
                }
              },
              veiculo: true,
              pagamentos_cliente: true
            }
          }
      },
      orderBy: {
        data_prevista: 'asc'
      }
    });
  }

  async confirmarRecebimento(id: number, confirmadoPor: string) {
    return await prisma.$transaction(async (tx) => {
      // 1. Buscar receb√≠vel
      const recebivel = await tx.recebivelCartao.findUnique({
        where: { id_recebivel: id },
        include: {
          operadora: {
            include: {
              conta_destino: true
            }
          }
        }
      });

      if (!recebivel) {
        throw new Error('Receb√≠vel n√£o encontrado');
      }

      if (recebivel.status === 'RECEBIDO') {
        throw new Error('Receb√≠vel j√° foi confirmado');
      }

      // 2. Atualizar saldo da conta banc√°ria (VALOR L√çQUIDO)
      await tx.contaBancaria.update({
        where: { id_conta: recebivel.operadora.id_conta_destino },
        data: {
          saldo_atual: {
            increment: Number(recebivel.valor_liquido)
          }
        }
      });

      // 3. Criar lan√ßamento no LivroCaixa APENAS para o extrato banc√°rio
      // Obs: id_conta_bancaria preenchido faz aparecer no extrato.
      // Categoria diferenciada para n√£o inflar faturamento di√°rio se for filtrado.
      await tx.livroCaixa.create({
        data: {
            descricao: `Rec. Confirmado - ${recebivel.operadora.nome} (OS #${recebivel.id_os}) Parc ${recebivel.num_parcela}/${recebivel.total_parcelas} [REC_ID:${id}]`,
            valor: recebivel.valor_liquido,
            tipo_movimentacao: 'ENTRADA',
            categoria: 'CONCILIACAO_CARTAO',
            dt_movimentacao: new Date(),
            origem: 'AUTOMATICA',
            id_conta_bancaria: recebivel.operadora.id_conta_destino
        }
      });

      // 4. Atualizar status do receb√≠vel
      return await tx.recebivelCartao.update({
        where: { id_recebivel: id },
        data: {
          status: 'RECEBIDO',
          data_recebimento: new Date(),
          confirmado_em: new Date(),
          confirmado_por: confirmadoPor
        } as any
      });
    });
  }

  async estornarRecebimento(id: number) {
    return await prisma.$transaction(async (tx) => {
      // 1. Buscar receb√≠vel
      const recebivel = await tx.recebivelCartao.findUnique({
        where: { id_recebivel: id },
        include: {
          operadora: {
            include: {
              conta_destino: true
            }
          }
        }
      });

      if (!recebivel) {
        throw new Error('Receb√≠vel n√£o encontrado');
      }

      if (recebivel.status !== 'RECEBIDO') {
        throw new Error('Receb√≠vel n√£o est√° confirmado');
      }

      // 2. Reverter saldo da conta banc√°ria
      await tx.contaBancaria.update({
        where: { id_conta: recebivel.operadora.id_conta_destino },
        data: {
          saldo_atual: {
            decrement: Number(recebivel.valor_liquido)
          }
        }
      });

      // 3. Remover registros de concilia√ß√£o do LivroCaixa para este receb√≠vel
      await tx.livroCaixa.deleteMany({
          where: {
              categoria: 'CONCILIACAO_CARTAO',
              descricao: {
                  contains: `[REC_ID:${id}]`
              }
          }
      });

      // 4. Reverter status do receb√≠vel
      return await tx.recebivelCartao.update({
        where: { id_recebivel: id },
        data: {
          status: 'PENDENTE',
          data_recebimento: null,
          confirmado_em: null,
          confirmado_por: null
        } as any
      });
    });
  }

  async update(id: number, data: Prisma.RecebivelCartaoUpdateInput) {
    return await prisma.recebivelCartao.update({
      where: { id_recebivel: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.recebivelCartao.delete({
      where: { id_recebivel: id },
    });
  }

  // Resumos para Dashboard
  async getResumo() {
    const hoje = new Date();
    const seteDias = new Date();
    seteDias.setDate(hoje.getDate() + 7);
    const trintaDias = new Date();
    trintaDias.setDate(hoje.getDate() + 30);

    const [totalPendente, receberHoje, receberSeteDias, receberTrintaDias, totalRecebido] = await Promise.all([
      // Total pendente (Cart√£o + PIX Pendente)
      (async () => {
         const card = await prisma.recebivelCartao.aggregate({ where: { status: 'PENDENTE' }, _sum: { valor_liquido: true } });
         const pix = await prisma.pagamentoCliente.aggregate({
            where: {
               metodo_pagamento: 'PIX',
               deleted_at: null,
               id_livro_caixa: null,
               ordem_de_servico: { fechamento_financeiro: { isNot: null } }
            },
            _sum: { valor: true }
         });
         return Number(card._sum.valor_liquido || 0) + Number(pix._sum.valor || 0);
      })(),

      // Receber hoje (Cart√£o + PIX)
      (async () => {
         const card = await prisma.recebivelCartao.aggregate({
            where: {
               status: 'PENDENTE',
               data_prevista: {
                   gte: new Date(hoje.setHours(0, 0, 0, 0)),
                   lte: new Date(hoje.setHours(23, 59, 59, 999))
               }
            },
            _sum: { valor_liquido: true }
         });
         // PIX √© sempre D+0 praticamente, ent√£o entra aqui se pendente
         const pix = await prisma.pagamentoCliente.aggregate({
            where: {
               metodo_pagamento: 'PIX',
               deleted_at: null,
               id_livro_caixa: null,
               ordem_de_servico: { fechamento_financeiro: { isNot: null } }
            },
            _sum: { valor: true }
         });
         return Number(card._sum.valor_liquido || 0) + Number(pix._sum.valor || 0);
      })(),

      // Pr√≥ximos 7 dias
      prisma.recebivelCartao.aggregate({
        where: {
          status: 'PENDENTE',
          data_prevista: { gte: hoje, lte: seteDias }
        },
        _sum: { valor_liquido: true }
      }),
      // Pr√≥ximos 30 dias
      prisma.recebivelCartao.aggregate({
        where: {
          status: 'PENDENTE',
          data_prevista: { gte: hoje, lte: trintaDias }
        },
        _sum: { valor_liquido: true }
      }),
      // Total recebido (m√™s atual) - APENAS CART√ÉO POR ENQUANTO (PIX entra como Caixa, complexo rastrear "hist√≥rico" sem tabela pr√≥pria)
      prisma.recebivelCartao.aggregate({
        where: {
          status: 'RECEBIDO',
          data_recebimento: { gte: new Date(hoje.getFullYear(), hoje.getMonth(), 1) }
        },
        _sum: { valor_liquido: true }
      })
    ]);

    return {
      totalPendente: totalPendente || 0,
      receberHoje: receberHoje || 0,
      receberSeteDias: receberSeteDias._sum.valor_liquido || 0,
      receberTrintaDias: receberTrintaDias._sum.valor_liquido || 0,
      totalRecebido: totalRecebido._sum.valor_liquido || 0
    };
  }

  // Confirma√ß√£o em lote
  async confirmarRecebimentoLote(ids: number[], confirmadoPor: string) {
    return await prisma.$transaction(async (tx) => {
      const resultados = [];

      for (const id of ids) {
        
        // --- FLUXO PIX (ID NEGATIVO) ---
        if (id < 0) {
            const idPagamento = Math.abs(id);
            const pagamento = await tx.pagamentoCliente.findUnique({
                where: { id_pagamento_cliente: idPagamento },
                include: { conta_bancaria: true }
            });

            if (!pagamento || pagamento.id_livro_caixa) continue; // J√° processado ou n√£o existe

            console.log(`[PIX CONFIRM] Processing Payment #${idPagamento}`);

            const valor = Number(pagamento.valor);
            const idConta = pagamento.id_conta_bancaria || pagamento.conta_bancaria?.id_conta;

            if (!idConta) {
                console.error(`[PIX ERROR] Payment #${idPagamento} has no bank account provided.`);
                throw new Error(`Pagamento PIX (R$ ${valor}) n√£o possui Conta Banc√°ria vinculada. Edite o pagamento na OS.`);
            }

            // 1. Atualizar Saldo
            await tx.contaBancaria.update({
                where: { id_conta: idConta },
                data: { saldo_atual: { increment: valor } }
            });

            // 2. Criar Livro Caixa (Aparece no Extrato)
            const livro = await tx.livroCaixa.create({
                data: {
                    descricao: `Recebimento PIX - OS #${pagamento.id_os} (Confirmado em Rec.)`,
                    valor: valor,
                    tipo_movimentacao: 'ENTRADA',
                    categoria: 'VENDA', // PIX √© venda direta
                    dt_movimentacao: new Date(),
                    origem: 'AUTOMATICA',
                    id_conta_bancaria: idConta
                }
            });

            // 3. Vincular (Marca como CONFIRMADO/FEITO)
            const updated = await tx.pagamentoCliente.update({
                where: { id_pagamento_cliente: idPagamento },
                data: { id_livro_caixa: livro.id_livro_caixa }
            });
            
            resultados.push(updated);
            continue;
        }

        // --- FLUXO CART√ÉO (ID POSITIVO) - MANTIDO ---
        // Buscar receb√≠vel
        const recebivel = await tx.recebivelCartao.findUnique({
          where: { id_recebivel: id },
          include: {
            operadora: {
              include: {
                conta_destino: true
              }
            }
          }
        });

        if (!recebivel) {
          continue; // Pula se n√£o encontrar
        }

        if (recebivel.status === 'RECEBIDO') {
          continue; // J√° confirmado, pula
        }

        // Atualizar saldo da conta banc√°ria
        await tx.contaBancaria.update({
          where: { id_conta: recebivel.operadora.id_conta_destino },
          data: {
            saldo_atual: {
              increment: Number(recebivel.valor_liquido)
            }
          }
        });

        // Registrar no extrato (LivroCaixa com conta vinculada)
        await tx.livroCaixa.create({
            data: {
                descricao: `Rec. Confirmado (Lote) - ${recebivel.operadora.nome} (OS #${recebivel.id_os}) Parc ${recebivel.num_parcela}/${recebivel.total_parcelas} [REC_ID:${id}]`,
                valor: recebivel.valor_liquido,
                tipo_movimentacao: 'ENTRADA',
                categoria: 'CONCILIACAO_CARTAO',
                dt_movimentacao: new Date(),
                origem: 'AUTOMATICA',
                id_conta_bancaria: recebivel.operadora.id_conta_destino
            }
        });

        // Atualizar status do receb√≠vel
        const updated = await tx.recebivelCartao.update({
          where: { id_recebivel: id },
          data: {
            status: 'RECEBIDO',
            data_recebimento: new Date(),
            confirmado_em: new Date(),
            confirmado_por: confirmadoPor
          } as any
        });

        resultados.push(updated);
      }

      return resultados;
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\servicoMaoDeObra.repository.ts
================================================================================

import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';
import { AuditLogRepository } from './auditLog.repository.js';
import { OrdemDeServicoRepository } from './ordemDeServico.repository.js';

const auditRepo = new AuditLogRepository();
const osRepo = new OrdemDeServicoRepository();

export class ServicoMaoDeObraRepository {
  async create(data: { id_os: number; id_funcionario: number; valor: number; descricao?: string | null }) {
    const created = await prisma.servicoMaoDeObra.create({
      data: {
        id_os: data.id_os,
        id_funcionario: data.id_funcionario,
        valor: data.valor,
        descricao: data.descricao ?? null
      },
      include: { funcionario: { include: { pessoa_fisica: { include: { pessoa: true } } } } }
    });
    
    await auditRepo.create({
        tabela: 'servico_mao_de_obra',
        registro_id: created.id_servico_mao_de_obra,
        acao: 'CREATE',
        valor_novo: created
    });

    await osRepo.recalculateTotals(data.id_os);

    return created;
  }

  async findAllByOs(id_os: number) {
    return await prisma.servicoMaoDeObra.findMany({
      where: { id_os: id_os, deleted_at: null },
      include: {
        funcionario: { include: { pessoa_fisica: { include: { pessoa: true } } } }
      }
    });
  }

  async update(id: number, data: { valor?: number; descricao?: string; id_funcionario?: number }) {
    const current = await prisma.servicoMaoDeObra.findUnique({ where: { id_servico_mao_de_obra: id } });
    
    if (!current) throw new Error('Servi√ßo n√£o encontrado');
    // @ts-ignore - status_pagamento exists in db but type might leak outdated
    if (current.status_pagamento === 'PAGO') throw new Error('Bloqueado: Comiss√£o j√° paga ao funcion√°rio.');

    const updated = await prisma.servicoMaoDeObra.update({
      where: { id_servico_mao_de_obra: id },
      data,
      include: { funcionario: { include: { pessoa_fisica: { include: { pessoa: true } } } } }
    });

    await auditRepo.create({
        tabela: 'servico_mao_de_obra',
        registro_id: id,
        acao: 'UPDATE',
        valor_antigo: current,
        valor_novo: updated
    });

    await osRepo.recalculateTotals(updated.id_os);

    return updated;
  }

  async softDelete(id: number) {
    const current = await prisma.servicoMaoDeObra.findUnique({ where: { id_servico_mao_de_obra: id } });
    if (!current) throw new Error('Servi√ßo n√£o encontrado');
    // @ts-ignore
    if (current.status_pagamento === 'PAGO') throw new Error('Bloqueado: Comiss√£o j√° paga ao funcion√°rio.');

    const updated = await prisma.servicoMaoDeObra.update({
        where: { id_servico_mao_de_obra: id },
        data: { deleted_at: new Date() }
    });

    await auditRepo.create({
        tabela: 'servico_mao_de_obra',
        registro_id: id,
        acao: 'SOFT_DELETE',
        valor_antigo: current
    });

    await osRepo.recalculateTotals(current.id_os);
    
    return updated;
  }
}



================================================================================
FILE PATH: server\src\repositories\tipo.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class TipoRepository {
  async create(data: Prisma.TipoCreateInput) {
    return await prisma.tipo.create({
      data,
    });
  }

  async findAll() {
    return await prisma.tipo.findMany();
  }

  async findById(id: number) {
    return await prisma.tipo.findUnique({
      where: { id_tipo: id },
    });
  }

  async update(id: number, data: Prisma.TipoUpdateInput) {
    return await prisma.tipo.update({
      where: { id_tipo: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.tipo.delete({
      where: { id_tipo: id },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\veiculo.repository.ts
================================================================================
import { Prisma } from "@prisma/client";
import { prisma } from "../prisma.js";

export class VeiculoRepository {
  async create(data: Prisma.VeiculoCreateInput) {
    return await prisma.veiculo.create({
      data,
      include: {
        cliente: {
          include: {
            pessoa_fisica: { include: { pessoa: true } },
            pessoa_juridica: { include: { pessoa: true } },
          },
        },
      },
    });
  }

  async findAll() {
    return await prisma.veiculo.findMany({
      include: {
        cliente: {
          include: {
            pessoa_fisica: { include: { pessoa: true } },
            pessoa_juridica: { include: { pessoa: true } },
          },
        },
      },
    });
  }

  async findById(id: number) {
    return await prisma.veiculo.findUnique({
      where: { id_veiculo: id },
      include: {
        cliente: {
          include: {
            pessoa_fisica: { include: { pessoa: true } },
            pessoa_juridica: { include: { pessoa: true } },
          },
        },
        ordens_de_servico: true,
      },
    });
  }

  // Search by plate (case-insensitive, normalized without hyphens)
  async findByPlaca(placa: string) {
    // Normalize: remove hyphens and convert to uppercase
    const normalizedPlaca = placa.replace(/-/g, "").toUpperCase();

    return await prisma.veiculo.findUnique({
      where: { placa: normalizedPlaca },
      include: {
        cliente: {
          include: {
            pessoa_fisica: { include: { pessoa: true } },
            pessoa_juridica: { include: { pessoa: true } },
          },
        },
      },
    });
  }

  // search by partial plate or model (accent-insensitive)
  async search(query: string) {
    // Check if query is numeric (potentially ID search) but we treat as string for now

    return await prisma.veiculo.findMany({
      where: {
        OR: [
          { placa: { contains: query, mode: "insensitive" } },
          { modelo: { contains: query, mode: "insensitive" } },
          { marca: { contains: query, mode: "insensitive" } },
          {
            cliente: {
              OR: [
                {
                  pessoa_fisica: {
                    pessoa: { nome: { contains: query, mode: "insensitive" } },
                  },
                },
                {
                  pessoa_juridica: {
                    razao_social: { contains: query, mode: "insensitive" },
                  },
                },
                {
                  pessoa_juridica: {
                    nome_fantasia: { contains: query, mode: "insensitive" },
                  },
                },
              ],
            },
          },
        ],
      },
      take: 20,
      include: {
        cliente: {
          include: {
            pessoa_fisica: { include: { pessoa: true } },
            pessoa_juridica: { include: { pessoa: true } },
          },
        },
      },
    });
  }

  async update(id: number, data: Prisma.VeiculoUpdateInput) {
    return await prisma.veiculo.update({
      where: { id_veiculo: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.veiculo.delete({
      where: { id_veiculo: id },
    });
  }
}



================================================================================
FILE PATH: server\src\routes\categoriaFinanceira.routes.ts
================================================================================
import { Router } from 'express';
import * as CategoriaController from '../controllers/categoriaFinanceira.controller.js';

export const categoriaFinanceiraRoutes = Router();

categoriaFinanceiraRoutes.get('/', CategoriaController.getAll);
categoriaFinanceiraRoutes.post('/', CategoriaController.create);
categoriaFinanceiraRoutes.put('/:id', CategoriaController.update);
categoriaFinanceiraRoutes.delete('/:id', CategoriaController.remove);



================================================================================
FILE PATH: server\src\routes\cliente.routes.ts
================================================================================
import { Router } from 'express';
import { ClienteController } from '../controllers/cliente.controller.js';

const clienteRoutes = Router();
const controller = new ClienteController();

clienteRoutes.post('/', controller.create);
clienteRoutes.get('/', controller.findAll);
clienteRoutes.get('/search', controller.searchByName); // Must be before /:id
clienteRoutes.get('/:id', controller.findById);
clienteRoutes.put('/:id', controller.update);
clienteRoutes.delete('/:id', controller.delete);

export { clienteRoutes };



================================================================================
FILE PATH: server\src\routes\contaBancaria.routes.ts
================================================================================
import { Router } from 'express';
import * as ContaBancariaController from '../controllers/contaBancaria.controller.js';

export const contaBancariaRoutes = Router();

contaBancariaRoutes.get('/', ContaBancariaController.getAll);
contaBancariaRoutes.post('/', ContaBancariaController.create);
contaBancariaRoutes.put('/:id', ContaBancariaController.update);
contaBancariaRoutes.delete('/:id', ContaBancariaController.remove);



================================================================================
FILE PATH: server\src\routes\contasPagar.routes.ts
================================================================================

import { Router } from 'express';
import { createConta, getContas, getContaById, updateConta, deleteConta } from '../controllers/contasPagar.controller.js';

const router = Router();

router.post('/', createConta);
router.get('/', getContas);
router.get('/:id', getContaById);
router.put('/:id', updateConta);
router.delete('/:id', deleteConta);

export default router;



================================================================================
FILE PATH: server\src\routes\dashboard.routes.ts
================================================================================
import { Router } from 'express';
import { DashboardController } from '../controllers/dashboard.controller.js';

const dashboardRoutes = Router();
const controller = new DashboardController();

dashboardRoutes.get('/', controller.getDashboardData);

export { dashboardRoutes };



================================================================================
FILE PATH: server\src\routes\fechamentoFinanceiro.routes.ts
================================================================================
import { Router } from 'express';
import { FechamentoFinanceiroController } from '../controllers/fechamentoFinanceiro.controller.js';

const fechamentoFinanceiroRoutes = Router();
const controller = new FechamentoFinanceiroController();

fechamentoFinanceiroRoutes.post('/', controller.create);
fechamentoFinanceiroRoutes.post('/consolidar', controller.consolidarOS);
fechamentoFinanceiroRoutes.get('/', controller.findAll);
fechamentoFinanceiroRoutes.get('/:id', controller.findById);
fechamentoFinanceiroRoutes.put('/:id', controller.update);
fechamentoFinanceiroRoutes.delete('/:id', controller.delete);

export { fechamentoFinanceiroRoutes };



================================================================================
FILE PATH: server\src\routes\fornecedor.routes.ts
================================================================================
import { Router } from 'express';
import { FornecedorController } from '../controllers/fornecedor.controller.js';

const fornecedorRoutes = Router();
const controller = new FornecedorController();

fornecedorRoutes.post('/', controller.create);
fornecedorRoutes.get('/', controller.findAll);
fornecedorRoutes.get('/:id', controller.findById);
fornecedorRoutes.put('/:id', controller.update);
fornecedorRoutes.delete('/:id', controller.delete);

export { fornecedorRoutes };



================================================================================
FILE PATH: server\src\routes\funcionario.routes.ts
================================================================================
import { Router } from 'express';
import { FuncionarioController } from '../controllers/funcionario.controller.js';

const funcionarioRoutes = Router();
const controller = new FuncionarioController();

funcionarioRoutes.post('/', controller.create);
funcionarioRoutes.get('/', controller.findAll);
funcionarioRoutes.get('/:id', controller.findById);
funcionarioRoutes.put('/:id', controller.update);
funcionarioRoutes.delete('/:id', controller.delete);

export { funcionarioRoutes };



================================================================================
FILE PATH: server\src\routes\itensOs.routes.ts
================================================================================
import { Router } from 'express';
import { ItensOsController } from '../controllers/itensOs.controller.js';

const itensOsRoutes = Router();
const controller = new ItensOsController();

itensOsRoutes.post('/', controller.create);
itensOsRoutes.get('/', controller.findAll);
itensOsRoutes.get('/os/:idOs', controller.findByOsId);
itensOsRoutes.get('/:id', controller.findById);
itensOsRoutes.put('/:id', controller.update);
itensOsRoutes.delete('/:id', controller.delete);
itensOsRoutes.get('/search/desc', controller.search);

export { itensOsRoutes };



================================================================================
FILE PATH: server\src\routes\livroCaixa.routes.ts
================================================================================
import { Router } from 'express';
import * as LivroCaixaController from '../controllers/livroCaixa.controller.js';

export const livroCaixaRoutes = Router();

livroCaixaRoutes.get('/', LivroCaixaController.getAll);
livroCaixaRoutes.post('/', LivroCaixaController.create);
livroCaixaRoutes.put('/:id', LivroCaixaController.update);
livroCaixaRoutes.delete('/:id', LivroCaixaController.softDelete);



================================================================================
FILE PATH: server\src\routes\operadoraCartao.routes.ts
================================================================================
import { Router } from 'express';
import * as OperadoraController from '../controllers/operadoraCartao.controller.js';

export const operadoraRoutes = Router();

operadoraRoutes.get('/', OperadoraController.getAll);
operadoraRoutes.post('/', OperadoraController.create);
operadoraRoutes.put('/:id', OperadoraController.update);



================================================================================
FILE PATH: server\src\routes\ordemDeServico.routes.ts
================================================================================
import { Router } from 'express';
import { OrdemDeServicoController } from '../controllers/ordemDeServico.controller.js';

const ordemDeServicoRoutes = Router();
const controller = new OrdemDeServicoController();

ordemDeServicoRoutes.post('/', controller.create);
ordemDeServicoRoutes.post('/unified', controller.createUnified);
ordemDeServicoRoutes.get('/', controller.findAll);
ordemDeServicoRoutes.get('/:id', controller.findById);
ordemDeServicoRoutes.put('/:id', controller.update);
ordemDeServicoRoutes.delete('/:id', controller.delete);
ordemDeServicoRoutes.get('/veiculo/:vehicleId', controller.findByVehicleId);

export { ordemDeServicoRoutes };



================================================================================
FILE PATH: server\src\routes\pagamentoCliente.routes.ts
================================================================================
import { Router } from 'express';
import { PagamentoClienteController } from '../controllers/pagamentoCliente.controller.js';

const pagamentoClienteRoutes = Router();
const controller = new PagamentoClienteController();

pagamentoClienteRoutes.post('/', controller.create);
pagamentoClienteRoutes.get('/', controller.findAll);
pagamentoClienteRoutes.get('/:id', controller.findById);
pagamentoClienteRoutes.put('/:id', controller.update);
pagamentoClienteRoutes.delete('/:id', controller.delete);

export { pagamentoClienteRoutes };



================================================================================
FILE PATH: server\src\routes\pagamentoEquipe.routes.ts
================================================================================
import { Router } from 'express';
import * as PagamentoEquipeController from '../controllers/pagamentoEquipe.controller.js';

export const pagamentoEquipeRoutes = Router();

pagamentoEquipeRoutes.get('/pendentes/:id_funcionario', PagamentoEquipeController.getPendentesByFuncionario);
pagamentoEquipeRoutes.get('/vales/:id_funcionario', PagamentoEquipeController.getValesPendentesByFuncionario);
pagamentoEquipeRoutes.post('/', PagamentoEquipeController.createPagamento);
pagamentoEquipeRoutes.get('/', PagamentoEquipeController.getHistorico);



================================================================================
FILE PATH: server\src\routes\pagamentoPeca.routes.ts
================================================================================
import { Router } from 'express';
import { PagamentoPecaController } from '../controllers/pagamentoPeca.controller.js';

const pagamentoPecaRoutes = Router();
const controller = new PagamentoPecaController();

pagamentoPecaRoutes.post('/', controller.create);
pagamentoPecaRoutes.get('/', controller.findAll);
pagamentoPecaRoutes.get('/:id', controller.findById);
pagamentoPecaRoutes.put('/:id', controller.update);
pagamentoPecaRoutes.delete('/:id', controller.delete);

export { pagamentoPecaRoutes };



================================================================================
FILE PATH: server\src\routes\pecasEstoque.routes.ts
================================================================================
import { Router } from 'express';
import { PecasEstoqueController } from '../controllers/pecasEstoque.controller.js';

const pecasEstoqueRoutes = Router();
const controller = new PecasEstoqueController();

pecasEstoqueRoutes.post('/entry', controller.createEntry);
pecasEstoqueRoutes.post('/', controller.create);
pecasEstoqueRoutes.get('/', controller.findAll);
pecasEstoqueRoutes.get('/search', controller.search);
pecasEstoqueRoutes.get('/:id/availability', controller.getAvailability);
pecasEstoqueRoutes.get('/:id', controller.findById);
pecasEstoqueRoutes.put('/:id', controller.update);
pecasEstoqueRoutes.delete('/:id', controller.delete);

export { pecasEstoqueRoutes };



================================================================================
FILE PATH: server\src\routes\pessoa.routes.ts
================================================================================
import { Router } from 'express';
import { PessoaController } from '../controllers/pessoa.controller.js';

const pessoaRoutes = Router();
const controller = new PessoaController();

pessoaRoutes.post('/', controller.create);
pessoaRoutes.get('/', controller.findAll);
pessoaRoutes.get('/:id', controller.findById);
pessoaRoutes.put('/:id', controller.update);
pessoaRoutes.delete('/:id', controller.delete);

export { pessoaRoutes };



================================================================================
FILE PATH: server\src\routes\pessoaFisica.routes.ts
================================================================================
import { Router } from 'express';
import { PessoaFisicaController } from '../controllers/pessoaFisica.controller.js';

const pessoaFisicaRoutes = Router();
const controller = new PessoaFisicaController();

pessoaFisicaRoutes.post('/', controller.create);
pessoaFisicaRoutes.get('/', controller.findAll);
pessoaFisicaRoutes.get('/:id', controller.findById);
pessoaFisicaRoutes.put('/:id', controller.update);
pessoaFisicaRoutes.delete('/:id', controller.delete);

export { pessoaFisicaRoutes };



================================================================================
FILE PATH: server\src\routes\pessoaJuridica.routes.ts
================================================================================
import { Router } from 'express';
import { PessoaJuridicaController } from '../controllers/pessoaJuridica.controller.js';

const pessoaJuridicaRoutes = Router();
const controller = new PessoaJuridicaController();

pessoaJuridicaRoutes.post('/', controller.create);
pessoaJuridicaRoutes.get('/', controller.findAll);
pessoaJuridicaRoutes.get('/:id', controller.findById);
pessoaJuridicaRoutes.put('/:id', controller.update);
pessoaJuridicaRoutes.delete('/:id', controller.delete);

export { pessoaJuridicaRoutes };



================================================================================
FILE PATH: server\src\routes\recebivelCartao.routes.ts
================================================================================
import { Router } from 'express';
import { RecebivelCartaoController } from '../controllers/recebivelCartao.controller.js';

const recebivelCartaoRoutes = Router();
const controller = new RecebivelCartaoController();

// CRUD b√°sico
// Rotas espec√≠ficas (DEVEM vir antes de /:id)
recebivelCartaoRoutes.get('/resumo', controller.getResumo);
recebivelCartaoRoutes.get('/date-range', controller.findByDateRange);
recebivelCartaoRoutes.get('/operadora/:idOperadora', controller.findByOperadora);
recebivelCartaoRoutes.get('/status/:status', controller.findByStatus);

// CRUD b√°sico e rotas parametrizadas por ID
recebivelCartaoRoutes.post('/', controller.create);
recebivelCartaoRoutes.get('/', controller.findAll);
recebivelCartaoRoutes.get('/:id', controller.findById);
recebivelCartaoRoutes.put('/:id', controller.update);
recebivelCartaoRoutes.delete('/:id', controller.delete);

// A√ß√µes
recebivelCartaoRoutes.post('/confirmar', controller.confirmarRecebimentoLote);
recebivelCartaoRoutes.post('/:id/confirmar', controller.confirmarRecebimento);
recebivelCartaoRoutes.post('/:id/estornar', controller.estornarRecebimento);

export { recebivelCartaoRoutes };



================================================================================
FILE PATH: server\src\routes\servicoMaoDeObra.routes.ts
================================================================================
import { Router } from 'express';
import { servicoMaoDeObraController } from '../controllers/servicoMaoDeObra.controller.js';

const servicoMaoDeObraRoutes = Router();

servicoMaoDeObraRoutes.post('/', servicoMaoDeObraController.create);
servicoMaoDeObraRoutes.get('/os/:id_os', servicoMaoDeObraController.index);
servicoMaoDeObraRoutes.put('/:id', servicoMaoDeObraController.update);
servicoMaoDeObraRoutes.delete('/:id', servicoMaoDeObraController.delete);

export { servicoMaoDeObraRoutes };



================================================================================
FILE PATH: server\src\routes\tipo.routes.ts
================================================================================
import { Router } from 'express';
import { TipoController } from '../controllers/tipo.controller.js';

const tipoRoutes = Router();
const controller = new TipoController();

tipoRoutes.post('/', controller.create);
tipoRoutes.get('/', controller.findAll);
tipoRoutes.get('/:id', controller.findById);
tipoRoutes.put('/:id', controller.update);
tipoRoutes.delete('/:id', controller.delete);

export { tipoRoutes };



================================================================================
FILE PATH: server\src\routes\veiculo.routes.ts
================================================================================
import { Router } from 'express';
import { VeiculoController } from '../controllers/veiculo.controller.js';

const veiculoRoutes = Router();
const controller = new VeiculoController();

veiculoRoutes.post('/', controller.create);
veiculoRoutes.get('/', controller.findAll);
veiculoRoutes.get('/search', controller.search);
veiculoRoutes.get('/placa/:placa', controller.findByPlaca);
veiculoRoutes.get('/:id', controller.findById);
veiculoRoutes.put('/:id', controller.update);
veiculoRoutes.delete('/:id', controller.delete);

export { veiculoRoutes };



