PROJECT DUMP GENERATED ON 01/10/2026 10:38:36
ROOT: C:\workspace\Meus Projetos\Centro Automotivo APP\App Centro Automotivo
EXCLUDED: node_modules, .git, dist, build, .next, coverage, package-lock.json, yarn.lock, pnpm-lock.yaml, *.log, *.png, *.jpg, *.jpeg, *.gif, *.ico, *.svg, *.webp, *.pdf, .DS_Store, .env


================================================================================
FILE PATH: docker-compose.yml
================================================================================
services:
  # 1. Serviço do Banco de Dados PostgreSQL
  centroautomotivo_db:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: automotivo_db
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d automotivo_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network

  # 2. Serviço da API (Backend Node/Express)
  api:
    build:
      context: ./server
      dockerfile: Dockerfile
    image: automotivo-api
    command: sh -c "npx prisma generate && npx prisma migrate deploy && npm run dev"
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: postgresql://user:password@centroautomotivo_db:5432/automotivo_db
      PORT: 3000
      NODE_ENV: development
      NODE_OPTIONS: "--max-old-space-size=2048"
    depends_on:
      centroautomotivo_db:
        condition: service_healthy
    volumes:
      - ./server:/app/server
      - /app/server/node_modules
    networks:
      - app-network

  # 3. Serviço do Frontend (React + Vite)
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    image: automotivo-client
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://localhost:3000
      NODE_OPTIONS: "--max-old-space-size=2048"
    volumes:
      - ./client:/app/client
      - /app/client/node_modules
    depends_on:
      - api
    networks:
      - app-network

volumes:
  postgres_data:

networks:
  app-network:
    driver: bridge


================================================================================
FILE PATH: package.json
================================================================================
{
  "name": "centro-automotivo-app",
  "version": "1.0.0",
  "description": "Root scripts for managing Docker and overarching project tasks",
  "scripts": {
    "docker:reset": "docker compose up -d --build",
    "docker:up": "docker compose up -d",
    "docker:down": "docker compose down",
    "db:migrate": "docker compose exec api npx prisma migrate dev",
    "db:studio": "docker compose exec api npx prisma studio",
    "generate:context": "powershell -ExecutionPolicy Bypass -File ./generate_context.ps1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}



================================================================================
FILE PATH: README.md
================================================================================
# Centro-Automotivo-Basico




================================================================================
FILE PATH: .antigravity\rules.md
================================================================================
Você é um desenvolvedor fullstack sênior, especialista em ReactJS, NextJS, TypeScript, TailwindCSS 3, Shadcn e Radix. Suas respostas devem ser diretas, profissionais e focadas em eficiência.  
1. Fluxo de Trabalho e Economia de Tokens
Planejamento Conciso: Antes de codificar, apresente um plano de implementação resumido e direto ao ponto. Aguarde minha aprovação para iniciar a codificação.  
Foco na Tarefa (Escopo): Concentre-se apenas nos arquivos e componentes mencionados na tarefa atual. Não modifique ou adicione código a arquivos já existentes e fora do escopo a menos que seja explicitamente solicitado.  
Geração de Código: Ao receber a aprovação, gere o código completo, funcional, dinâmico e sem placeholders, mocks ou dados fixos. Não gere documentação adicional, pseudo-código ou planos extensos, a menos que seja explicitamente pedido. Em caso de bugs ou necessidade de ajustes, aponte a causa e a solução de forma objetiva. Itere na solução até eu confirmar que a funcionalidade está correta. 
2. Padrões de Código
DRY (Don't Repeat Yourself): O código deve ser reutilizável e modular.  Use nomes claros e descritivos para componentes, variáveis e funções. Use o prefixo handle para funções de eventos (ex: handleClick). Utilize exclusivamente TailwindCSS 3 na estilização. UI/UX: Priorize o uso de Shadcn e Radix para componentes complexos, estilizando-os com Tailwind.  
Boas Práticas:
Sempre use const e let. Use TypeScript com tipagem explícita sempre que possível. Implemente acessibilidade (ex: tabindex, aria-label). Priorize early returns para maior legibilidade. Faça os tratamentos de erros pertinentes ao código.
3. Gerenciamento de Cores
Todas as cores e fontes devem ser definidas e gerenciadas exclusivamente no arquivo tailwind.config.js. Isso garante um controle centralizado e a geração automática de todas as classes de utilidade do Tailwind.   
Resumo das Regras Principais
Planejar de forma concisa → Aprovar → Executar.  
Respeitar o escopo da tarefa, sem alterar código já aprovado.  
Código deve ser legível, completo, funcional e acessível.  
Estilização via Tailwind 3 com cores centralizadas no tailwind.config.js.  
Tudo passa pelo Docker, não é pra fazer nada direto sem passar pelo docker.
Preciso que vc tenha essas informações para que a cada alteração não modifique códigos ou funcionalidades que já estão funcionando bem.
Responder tudo e portugues Brasil, pt-br. Não entendo nada de ingles

O projeto é um app para gestão de oficinas automotivas, o diferencial é que ele é fácil de usar, é objetivo e fácil de navegar. Para oficinas pequenas que não precisam de um software complexo e caro. Oficinas que não vendem peças, apenas serviços de manutenção e pequenas peças como lampadas, oleo, bateria etc.. apenas para agilizar o serviço.


================================================================================
FILE PATH: client\.dockerignore
================================================================================
node_modules
npm-debug.log
dist
build
.git
.gitignore
README.md


================================================================================
FILE PATH: client\Dockerfile
================================================================================
# Usa uma imagem leve do Node
FROM node:20-alpine

# Define o diretório de trabalho
WORKDIR /app/client

# Copia os arquivos de dependências
COPY package*.json ./

# Instala as dependências
RUN npm install

# Copia o restante do código
COPY . .

# Expõe a porta padrão do Vite
EXPOSE 5173

# Inicia o servidor de desenvolvimento com host 0.0.0.0 para acesso externo
CMD ["npm", "run", "dev", "--", "--host"]



================================================================================
FILE PATH: client\eslint.config.js
================================================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])



================================================================================
FILE PATH: client\index.html
================================================================================
<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Centro Automotivo APP</title>
</head>

<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>

</html>


================================================================================
FILE PATH: client\package.json
================================================================================
{
  "name": "client",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
    
  },
  "dependencies": {
    "@tailwindcss/vite": "^4.1.17",
    "axios": "^1.13.2",
    "lucide-react": "^0.561.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.10.1",
    "tailwindcss": "^4.1.17"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4"
  }
}



================================================================================
FILE PATH: client\README.md
================================================================================
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```



================================================================================
FILE PATH: client\tsconfig.app.json
================================================================================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}



================================================================================
FILE PATH: client\tsconfig.json
================================================================================
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}



================================================================================
FILE PATH: client\tsconfig.node.json
================================================================================
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}



================================================================================
FILE PATH: client\vite.config.ts
================================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import tailwindcss from '@tailwindcss/vite'


// https://vite.dev/config/
export default defineConfig({
  plugins: [react(), tailwindcss()],
  server: {
    host: true, // Listen on all addresses
    strictPort: true,
    port: 5173,
    watch: {
      usePolling: true, 
      interval: 1000, // Check files every 1000ms (Reduced Load)
      binaryInterval: 2000, // Check binary files less often
    },
    hmr: {
      clientPort: 5173, // Ensures simple WebSocket connection from browser
    }
  }
})



================================================================================
FILE PATH: client\src\App.css
================================================================================
@import "tailwindcss";

#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}

.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}

.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }

  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


================================================================================
FILE PATH: client\src\App.tsx
================================================================================
import { createBrowserRouter, RouterProvider, createRoutesFromElements, Route } from 'react-router-dom';
import { MainLayout } from './components/layouts/MainLayout';
import { HomePage } from './pages/HomePage';
import { NotFoundPage } from './pages/NotFoundPage';
import { ClientePage } from './pages/ClientePage'; 

// Importe suas páginas antigas aqui enquanto não refatora todas
import { VeiculoPage } from './pages/VeiculoPage';
import { OrdemDeServicoPage } from './pages/OrdemDeServicoPage';
import { OrdemDeServicoDetalhePage } from './pages/OrdemDeServicoDetalhePage';
import { CadastroUnificadoPage } from './pages/CadastroUnificadoPage';

import { PecasEstoquePage } from './pages/PecasEstoquePage';
import { FuncionarioPage } from './pages/FuncionarioPage';
import { PessoaPage } from './pages/PessoaPage';
import { TipoPage } from './pages/TipoPage';
import { FechamentoFinanceiroPage } from './pages/FechamentoFinanceiroPage';
import { FechamentoFinanceiroDetalhePage } from './pages/FechamentoFinanceiroDetalhePage';

import { FornecedorPage } from './pages/FornecedorPage';
import { PagamentoPecaPage } from './pages/PagamentoPecaPage';
import { LivroCaixaPage } from './pages/LivroCaixaPage';
import { ContasAPagarPage } from './pages/ContasAPagarPage';
import { SearchClientePage } from './pages/SearchClientePage';
import { SearchVeiculoPage } from './pages/SearchVeiculoPage';
import { NovoPagamentoPage } from './pages/NovoPagamentoPage';
import { PagamentoEquipePage } from './pages/PagamentoEquipePage';

const router = createBrowserRouter(
  createRoutesFromElements(
    <Route element={<MainLayout />}>
      <Route path="/" element={<HomePage />} />
      
      {/* Páginas Modernizadas */}
      <Route path="/cliente" element={<ClientePage />} />

      {/* Páginas Legadas (Ainda funcionam dentro do layout novo!) */}
      <Route path="/veiculo" element={<VeiculoPage />} />
      <Route path="/ordem-de-servico" element={<OrdemDeServicoPage />} />
      <Route path="/ordem-de-servico/:id" element={<OrdemDeServicoDetalhePage />} />
      {/* Unified Registration Routes */}
      <Route path="/novo-cadastro" element={<CadastroUnificadoPage />} />
      <Route path="/cadastro/:clienteId" element={<CadastroUnificadoPage />} />

      <Route path="/pecas-estoque" element={<PecasEstoquePage />} />
      <Route path="/funcionario" element={<FuncionarioPage />} />
      <Route path="/pessoa" element={<PessoaPage />} />
      <Route path="/tipo" element={<TipoPage />} />
      <Route path="/fechamento-financeiro" element={<FechamentoFinanceiroPage />} />
      <Route path="/fechamento-financeiro/:id" element={<FechamentoFinanceiroDetalhePage />} />
      <Route path="/financeiro" element={<LivroCaixaPage />} /> {/* Redirect old /financeiro to LivroCaixaPage */}
      <Route path="/financeiro/livro-caixa" element={<LivroCaixaPage />} />
      <Route path="/financeiro/pagamento-pecas" element={<PagamentoPecaPage />} />
      <Route path="/financeiro/contas-pagar" element={<ContasAPagarPage />} />
      <Route path="/financeiro/equipe" element={<PagamentoEquipePage />} /> {/* Nova Rota */}
      <Route path="/pagamento-equipe" element={<PagamentoEquipePage />} />
      <Route path="/pagamento-equipe/novo" element={<NovoPagamentoPage />} />

      <Route path="/fornecedor" element={<FornecedorPage />} />
      <Route path="/pagamento-peca" element={<PagamentoPecaPage />} />
      
      {/* Search Pages */}
      <Route path="/search-cliente" element={<SearchClientePage />} />
      <Route path="/search-veiculo" element={<SearchVeiculoPage />} />
      
      {/* Rota 404 para qualquer coisa não definida */}
      <Route path="*" element={<NotFoundPage />} />
    </Route>
  )
);

function App() {
  return <RouterProvider router={router} />;
}

export default App;


================================================================================
FILE PATH: client\src\index.css
================================================================================
@import "tailwindcss";

@theme {
  /* Tipografia */
  --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
  --font-mono: 'JetBrains Mono', 'Fira Code', monospace;

  /* Brand / Primary */
  --color-primary-50: #eff6ff;
  --color-primary-100: #dbeafe;
  --color-primary-200: #bfdbfe;
  --color-primary-300: #93c5fd;
  --color-primary-400: #60a5fa;
  --color-primary-500: #3b82f6;
  --color-primary-600: #2563eb;
  --color-primary-700: #1d4ed8;
  --color-primary-800: #1e40af;
  --color-primary-900: #1e3a8a;

  /* Neutros / Grayscale */
  --color-neutral-25: #fcfcfd;
  --color-neutral-50: #f9fafb;
  --color-neutral-100: #f3f4f6;
  --color-neutral-200: #e5e7eb;
  --color-neutral-300: #d1d5db;
  --color-neutral-400: #9ca3af;
  --color-neutral-500: #6b7280;
  --color-neutral-600: #4b5563;
  --color-neutral-700: #374151;
  --color-neutral-800: #1f2937;
  --color-neutral-900: #2b3b5e;

  /* Accent / Secondary */
  --color-accent-50: #f5f3ff;
  --color-accent-600: #7c3aed;
  --color-accent-700: #6d28d9;

  /* Semânticas */
  --color-success: #059669;
  --color-success-50: #ecfdf5;
  --color-warning: #d97706;
  --color-warning-50: #fffbeb;
  --color-error: #dc2626;
  --color-error-50: #fef2f2;
  --color-info: #2563eb;

  /* UI Tokens */
  --color-background: var(--color-neutral-50);
  --color-surface: #ffffff;
  --color-border: var(--color-neutral-200);
  --color-text-main: var(--color-neutral-900);
  --color-text-muted: var(--color-neutral-500);
  --color-sidebar: var(--color-neutral-900);
}

:root {
  font-family: var(--font-sans);
  line-height: 1.5;
  font-weight: 400;
  color: #334155;
  /* Slate 700 */
  background-color: var(--color-background);
  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  margin: 0;
  display: flex;
  min-width: 320px;
  min-height: 100vh;
}

/* Scrollbar moderna */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}


================================================================================
FILE PATH: client\src\main.tsx
================================================================================
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)



================================================================================
FILE PATH: client\src\components\Sidebar.tsx
================================================================================
import { useState } from 'react';
import { 
  Wrench, 
  Package, 
  LayoutDashboard,
  DollarSign,
  ChevronDown,
  ChevronRight,
  Search
} from 'lucide-react';
import { Link, useLocation } from 'react-router-dom';

const menuItems = [
  { path: '/', label: 'Dashboard', icon: LayoutDashboard },
  { 
    label: 'Buscar', 
    icon: Search,
    path: '/buscar', 
    subItems: [
        { path: '/cliente', label: 'Clientes' },
        { path: '/veiculo', label: 'Veículos' },
        { path: '/fornecedor', label: 'Fornecedores' },
        { path: '/funcionario', label: 'Colaboradores' }
    ]
  },
  { path: '/ordem-de-servico', label: 'Ordens de Serviço', icon: Wrench },
  { path: '/pecas-estoque', label: 'Estoque', icon: Package },
  { 
    label: 'Financeiro', 
    icon: DollarSign,
    path: '/financeiro', // Base path for checking active state
    subItems: [
        { path: '/financeiro/livro-caixa', label: 'Movimentação de Caixa' },
        { path: '/financeiro/equipe', label: 'Pagamento de Equipe' },
        { path: '/financeiro/pagamento-pecas', label: 'Pagamento Auto Peças' },
        { path: '/financeiro/contas-pagar', label: 'Contas a Pagar (Geral)' },
        { path: '/fechamento-financeiro', label: 'Gestão Financeira' }
    ]
  },
];

export const Sidebar = () => {
  const location = useLocation();
  const [expandedMenus, setExpandedMenus] = useState<string[]>(['Financeiro']); // Auto-expand Financeiro for visibility

  const toggleMenu = (label: string) => {
    setExpandedMenus(prev => 
      prev.includes(label) ? prev.filter(item => item !== label) : [...prev, label]
    );
  };

  return (
    <aside className="w-64 bg-sidebar text-neutral-400 flex flex-col h-screen fixed left-0 top-0 overflow-y-auto border-r border-neutral-800">
      <div className="p-6 border-b border-neutral-800">
        <h1 className="text-2xl font-bold text-white tracking-tight">
          Auto<span className="text-primary-500">Center</span>
        </h1>
      </div>
      
      <nav className="flex-1 py-6 px-3 space-y-1">
        {menuItems.map((item) => {
          const isActive = location.pathname === item.path || (item.subItems && item.subItems.some(sub => location.pathname === sub.path));
          const isExpanded = expandedMenus.includes(item.label);

          return (
            <div key={item.label}>
                {item.subItems ? (
                    <button
                        onClick={() => toggleMenu(item.label)}
                        className={`w-full flex items-center justify-between px-4 py-3 rounded-xl transition-all duration-200 font-medium cursor-pointer ${
                            isActive 
                            ? 'bg-neutral-800 text-white' 
                            : 'hover:bg-neutral-800 hover:text-white'
                        }`}
                    >
                        <div className="flex items-center gap-3">
                            <item.icon size={20} className={isActive ? 'text-primary-500' : 'text-neutral-500'} />
                            {item.label}
                        </div>
                        {isExpanded ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
                    </button>
                ) : (
                    <Link
                        to={item.path}
                        className={`flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 font-medium ${
                            isActive 
                            ? 'bg-primary-600 text-white shadow-lg shadow-primary-900/50' 
                            : 'hover:bg-neutral-800 hover:text-white'
                        }`}
                    >
                        <item.icon size={20} className={isActive ? 'text-white' : 'text-neutral-500'} />
                        {item.label}
                    </Link>
                )}

                {/* Submenu Rendering */}
                {item.subItems && isExpanded && (
                    <div className="mt-1 ml-4 space-y-1 border-l border-neutral-800 pl-2">
                        {item.subItems.map(sub => {
                            const isSubActive = location.pathname === sub.path;
                            return (
                                <Link
                                    key={sub.path}
                                    to={sub.path}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm transition-colors ${
                                        isSubActive 
                                        ? 'text-primary-400 bg-primary-500/10 font-bold' 
                                        : 'text-neutral-500 hover:text-neutral-300'
                                    }`}
                                >
                                    {sub.label}
                                </Link>
                            )
                        })}
                    </div>
                )}
            </div>
          );
        })}
      </nav>

      <div className="p-4 border-t border-neutral-800">
        <div className="bg-neutral-800/50 rounded-lg p-3">
          <p className="text-xs text-center text-neutral-500">
            &copy; 2026 Centro Automotivo Guilherme Gebaili
          </p>
        </div>
      </div>
    </aside>
  );
};


================================================================================
FILE PATH: client\src\components\financeiro\CategoryManager.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../../services/api';
import { Trash2, Plus, X, AlertTriangle, Edit2 } from 'lucide-react';

interface Category {
    id_categoria: number;
    nome: string;
    tipo: string;
}

interface CategoryManagerProps {
    isOpen: boolean;
    onClose: () => void;
    onUpdate: () => void;
}

export const CategoryManager = ({ isOpen, onClose, onUpdate }: CategoryManagerProps) => {
    const [categories, setCategories] = useState<Category[]>([]);
    const [newCatName, setNewCatName] = useState('');
    const [newCatType, setNewCatType] = useState('AMBOS');
    const [loading, setLoading] = useState(false);
    
    // Conflict Resolution State
    const [conflictData, setConflictData] = useState<{ id: number; message: string; count: number } | null>(null);
    const [replacementCat, setReplacementCat] = useState('');

    // Editing State
    const [editingCatId, setEditingCatId] = useState<number | null>(null);
    const [editName, setEditName] = useState('');
    const [editType, setEditType] = useState('AMBOS');

    // UI State
    const [deleteConfirmId, setDeleteConfirmId] = useState<number | null>(null);

    useEffect(() => {
        if (isOpen) {
             loadCategories(); // This will hit the backend which now syncs
             setConflictData(null);
             setReplacementCat('');
        }
    }, [isOpen]);

    const loadCategories = async () => {
        try {
            const res = await api.get('/categoria-financeira');
            setCategories(res.data);
        } catch (error) {
            console.error(error);
        }
    };

    const handleAdd = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            setLoading(true);
            await api.post('/categoria-financeira', { nome: newCatName, tipo: newCatType });
            setNewCatName('');
            loadCategories();
            onUpdate();
        } catch (error) {
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    const handleDelete = async (id: number, replacement?: string) => {
        // Direct delete (called from confirm UI)
        try {
            // Need to pass replacement in body if it exists. Note: axios delete config for body is distinct.
            await api.delete(`/categoria-financeira/${id}`, { 
                data: { replacementCategory: replacement }
            });
            
            // Success
            setConflictData(null);
            setReplacementCat('');
            loadCategories();
            onUpdate();
        } catch (error: any) {
            if (error.response && error.response.status === 409) {
                setDeleteConfirmId(null); // Close simple delete confirm
                setConflictData({
                    id,
                    message: error.response.data.message,
                    count: error.response.data.usageCount
                });
                // Set default replacement to first available
                const firstAvailable = categories.find(c => c.id_categoria !== id);
                if (firstAvailable) setReplacementCat(firstAvailable.nome);
            } else {
                console.error(error);
                // alert('Erro ao excluir categoria'); // Replaced with console error for now, or could use a toast if available
            }
        } finally {
             // clean up state if needed
        }
    };

    const startEditing = (cat: Category) => {
        setEditingCatId(cat.id_categoria);
        setEditName(cat.nome);
        setEditType(cat.tipo);
    };

    const handleEdit = async (id: number) => {
        try {
            // Optimistic update for UI responsiveness
            setCategories(categories.map(c => c.id_categoria === id ? { ...c, nome: editName, tipo: editType } : c));
            setEditingCatId(null);

            await api.put(`/categoria-financeira/${id}`, { nome: editName, tipo: editType });
            loadCategories();
            onUpdate();
        } catch (error) {
            console.error(error);
            loadCategories(); // Revert on error
        }
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl animate-in fade-in zoom-in duration-200">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-black text-neutral-900">Gerenciar Categorias</h2>
                    <button onClick={onClose} className="p-2 hover:bg-neutral-100 rounded-full text-neutral-400 hover:text-neutral-900">
                        <X size={20} />
                    </button>
                </div>

                {conflictData ? (
                    <div className="bg-orange-50 border border-orange-100 p-4 rounded-xl mb-6">
                        <div className="flex items-center gap-3 text-orange-600 mb-2">
                            <AlertTriangle size={20} />
                            <h3 className="font-bold">Categoria em uso</h3>
                        </div>
                        <p className="text-sm text-neutral-600 mb-4">{conflictData.message}</p>
                        
                        <label className="block text-[10px] font-black text-neutral-400 uppercase mb-1">Substituir por:</label>
                        <select 
                            value={replacementCat}
                            onChange={(e) => setReplacementCat(e.target.value)}
                            className="w-full bg-white border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-orange-300 mb-4"
                        >
                            {categories.filter(c => c.id_categoria !== conflictData.id).map(c => (
                                <option key={c.id_categoria} value={c.nome}>{c.nome}</option>
                            ))}
                        </select>
                        <div className="flex gap-2">
                            <button onClick={() => setConflictData(null)} className="flex-1 py-2 font-bold text-neutral-500 hover:bg-white rounded-lg transition-colors">Cancelar</button>
                            <button onClick={() => handleDelete(conflictData.id, replacementCat)} className="flex-1 py-2 bg-orange-500 text-white font-bold rounded-lg hover:bg-orange-600 transition-colors">Confirmar Troca</button>
                        </div>
                    </div>
                ) : deleteConfirmId ? (
                    <div className="bg-red-50 border border-red-100 p-4 rounded-xl mb-6 animate-in fade-in zoom-in duration-200">
                        <div className="flex items-center gap-3 text-red-600 mb-2">
                            <Trash2 size={20} />
                            <h3 className="font-bold">Excluir Categoria?</h3>
                        </div>
                        <p className="text-sm text-neutral-600 mb-4">Esta ação não pode ser desfeita. Se houver lançamentos vinculados, você precisará escolher um substituto.</p>
                        <div className="flex gap-2">
                             <button onClick={() => setDeleteConfirmId(null)} className="flex-1 py-2 font-bold text-neutral-500 hover:bg-white rounded-lg transition-colors">Cancelar</button>
                             <button onClick={() => handleDelete(deleteConfirmId)} className="flex-1 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors">Sim, Excluir</button>
                        </div>
                    </div>
                ) : (
                    <>
                        <form onSubmit={handleAdd} className="flex gap-2 mb-6">
                            <input 
                                value={newCatName}
                                onChange={e => setNewCatName(e.target.value)}
                                placeholder="Nova categoria..."
                                className="flex-1 bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                                required
                            />
                            <select 
                                value={newCatType}
                                onChange={e => setNewCatType(e.target.value)}
                                className="w-24 bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                            >
                                <option value="AMBOS">Ambos</option>
                                <option value="ENTRADA">Entrada</option>
                                <option value="SAIDA">Saída</option>
                            </select>
                            <button 
                                type="submit" 
                                disabled={loading}
                                className="bg-neutral-900 text-white p-3 rounded-xl hover:bg-neutral-800 disabled:opacity-50"
                            >
                                <Plus size={20} />
                            </button>
                        </form>

                        <div className="max-h-[300px] overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                            {categories.map(cat => (
                                <div key={cat.id_categoria} className="flex justify-between items-center p-3 bg-neutral-50 rounded-xl border border-neutral-100 group hover:border-neutral-200 transition-colors">
                                    {editingCatId === cat.id_categoria ? (
                                        <div className="flex gap-2 w-full">
                                            <input 
                                                value={editName}
                                                onChange={e => setEditName(e.target.value)}
                                                className="flex-1 bg-white border border-neutral-300 p-2 rounded-lg font-bold text-sm outline-none focus:border-neutral-400"
                                                autoFocus
                                            />
                                            <select 
                                                value={editType}
                                                onChange={e => setEditType(e.target.value)}
                                                className="w-24 bg-white border border-neutral-300 p-2 rounded-lg font-bold text-sm outline-none focus:border-neutral-400"
                                            >
                                                <option value="AMBOS">Ambos</option>
                                                <option value="ENTRADA">Entrada</option>
                                                <option value="SAIDA">Saída</option>
                                            </select>
                                            <button onClick={() => handleEdit(cat.id_categoria)} className="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600">
                                                <Plus size={16} /> {/* Reusing Plus for Save icon visually or could import Save */}
                                            </button>
                                            <button onClick={() => setEditingCatId(null)} className="bg-neutral-200 text-neutral-600 p-2 rounded-lg hover:bg-neutral-300">
                                                <X size={16} />
                                            </button>
                                        </div>
                                    ) : (
                                        <>
                                            <div>
                                                <p className="font-bold text-neutral-800">{cat.nome}</p>
                                                <p className="text-[10px] uppercase font-black text-neutral-400">{cat.tipo}</p>
                                            </div>
                                            <div className="flex gap-1">
                                                <button 
                                                    onClick={() => startEditing(cat)}
                                                    className="text-neutral-300 hover:text-primary-500 transition-colors p-2"
                                                >
                                                    <Edit2 size={16} />
                                                </button>
                                                <button 
                                                    onClick={() => setDeleteConfirmId(cat.id_categoria)}
                                                    className="text-neutral-300 hover:text-red-500 transition-colors p-2"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            ))}
                            {categories.length === 0 && (
                                <p className="text-center text-neutral-400 text-sm py-4">Nenhuma categoria cadastrada.</p>
                            )}
                        </div>
                    </>
                )}
            </div>
        </div>
    );
};



================================================================================
FILE PATH: client\src\components\forms\ClienteForm.tsx
================================================================================


================================================================================
FILE PATH: client\src\components\forms\FechamentoFinanceiroForm.tsx
================================================================================
import { useState, useEffect, type FormEvent } from 'react';
import { useNavigate } from 'react-router-dom';
import { api } from '../../services/api';
import { Calculator, Save, Truck, Plus, BadgeCheck, Palette, Trash2 } from 'lucide-react';
import { PagamentoClienteForm } from './PagamentoClienteForm';
import { FornecedorForm } from './FornecedorForm';
import { LaborManager } from '../os/LaborManager';
import { Modal } from '../ui/Modal';
import { StatusBanner } from '../ui/StatusBanner';
import { Button } from '../ui/Button';

interface FechamentoFinanceiroFormProps {
    preSelectedOsId?: number | null;
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

interface ItemOS {
    id_iten: number;
    valor_total: number;
    descricao: string;
    quantidade: number;
    codigo_referencia?: string;
    pecas_estoque?: {
        valor_custo: number;
        nome: string;
    };
    pagamentos_peca?: {
        id_pagamento_peca: number;
        id_fornecedor: number;
        custo_real: number;
        pago_ao_fornecedor: boolean;
    }[];
}

interface IFornecedor {
    id_fornecedor: number;
    nome: string;
}

interface ItemFinanceiroState {
    id_pagamento_peca?: number; // ID se já existir
    id_fornecedor: string;
    custo_real: string;
    pago_fornecedor: boolean;
}

interface OSData {
    id_os: number;
    status: string;
    valor_total_cliente: number;
    valor_mao_de_obra: number;
    valor_pecas: number; 
    itens_os: ItemOS[];
    defeito_relatado?: string;
    diagnostico?: string;
    cliente: {
        pessoa_fisica?: { pessoa: { nome: string } };
        pessoa_juridica?: { nome_fantasia: string };
    };
    veiculo: {
        placa: string;
        modelo: string;
        cor: string;
    };
    pagamentos_cliente?: {
        id_pagamento_cliente: number;
        metodo_pagamento: string;
        valor: number;
        data_pagamento: string;
        bandeira_cartao?: string;
        codigo_transacao?: string;
        qtd_parcelas?: number;
        deleted_at?: string;
    }[];
    fechamento_financeiro?: {
        id_fechamento_financeiro: number;
    };
    servicos_mao_de_obra?: {
        id_servico_mao_de_obra: number;
        valor: number;
        funcionario?: {
            pessoa_fisica?: {
                pessoa: {
                    nome: string;
                }
            };
            cargo?: string;
        }
    }[];
}

export const FechamentoFinanceiroForm = ({ preSelectedOsId, onSuccess, onCancel }: FechamentoFinanceiroFormProps) => {
    const navigate = useNavigate();
    const [loading, setLoading] = useState(false);
    const [fetchingOs, setFetchingOs] = useState(false);
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });
    
    const [idOs, setIdOs] = useState(preSelectedOsId ? String(preSelectedOsId) : '');
    const [osData, setOsData] = useState<OSData | null>(null);
    const [fornecedores, setFornecedores] = useState<IFornecedor[]>([]);
    
    const [itemsState, setItemsState] = useState<Record<number, ItemFinanceiroState>>({});
    const [showFornecedorModal, setShowFornecedorModal] = useState(false);
    const [editItem, setEditItem] = useState<ItemOS | null>(null);
    const [paymentModal, setPaymentModal] = useState<{ isOpen: boolean; data: any }>({ isOpen: false, data: null });

    const handleDeletePayment = (id: number) => {
         setConfirmModal({
            isOpen: true,
            title: 'Excluir Pagamento',
            message: 'Tem certeza que deseja excluir este pagamento?',
            onConfirm: async () => {
                try {
                    await api.delete(`/pagamento-cliente/${id}`);
                    setStatusMsg({ type: 'success', text: 'Pagamento removido!' });
                    if (osData) fetchOsData(osData.id_os);
                } catch (error) {
                    setStatusMsg({ type: 'error', text: 'Erro ao remover pagamento.' });
                }
                setConfirmModal(prev => ({ ...prev, isOpen: false }));
            }
        });
    };

    // Confirmation Modal State
    const [confirmModal, setConfirmModal] = useState<{
        isOpen: boolean;
        title: string;
        message: string;
        onConfirm: () => void;
    }>({ isOpen: false, title: '', message: '', onConfirm: () => {} });

    // Employees State (for LaborManager)
    const [employees, setEmployees] = useState<any[]>([]);

    useEffect(() => {
        loadFornecedores();
        loadEmployees();
        if (preSelectedOsId) {
            fetchOsData(preSelectedOsId);
        }
    }, [preSelectedOsId]);

    const loadFornecedores = async () => {
        try {
            const response = await api.get('/fornecedor');
            setFornecedores(response.data);
        } catch (error) {
            console.error("Erro ao carregar fornecedores");
        }
    };

    const loadEmployees = async () => {
        try {
            const response = await api.get('/funcionario');
            // Ensure we map to the format expected by select options or LaborManager
            setEmployees(response.data);
        } catch (error) {
            console.error("Erro ao carregar funcionários");
        }
    };

    const fetchOsData = async (id: number) => {
        setFetchingOs(true);
        setStatusMsg({ type: null, text: '' });
        try {
            const response = await api.get(`/ordem-de-servico/${id}`);
            const os: OSData = response.data;
            setOsData(os);

            const initialItemsState: Record<number, ItemFinanceiroState> = {};
            os.itens_os.forEach(item => {
                const existingPayment = item.pagamentos_peca && item.pagamentos_peca.length > 0 ? item.pagamentos_peca[0] : null;

                const initialCost = existingPayment 
                    ? String(existingPayment.custo_real)
                    : item.pecas_estoque?.valor_custo 
                        ? (Number(item.pecas_estoque.valor_custo) * item.quantidade).toFixed(2) 
                        : '';
                
                initialItemsState[item.id_iten] = {
                    id_pagamento_peca: existingPayment?.id_pagamento_peca,
                    id_fornecedor: existingPayment ? String(existingPayment.id_fornecedor) : '', 
                    custo_real: initialCost,
                    pago_fornecedor: existingPayment ? existingPayment.pago_ao_fornecedor : false
                };
            });
            setItemsState(initialItemsState);

        } catch (error) {
            console.error(error);
            setStatusMsg({ type: 'error', text: 'OS não encontrada ou erro ao buscar dados.' });
        } finally {
            setFetchingOs(false);
        }
    };

    const handleSearchOs = () => {
        if (!idOs) return;
        fetchOsData(Number(idOs));
    };

    // Auto-save logic
    const saveItemCost = async (id_iten: number, partialState: ItemFinanceiroState) => {
         const item = osData?.itens_os.find(i => i.id_iten === id_iten);
         if (!item || !partialState.id_fornecedor || !partialState.custo_real) return;

         try {
            const payload = {
                id_item_os: id_iten,
                id_fornecedor: Number(partialState.id_fornecedor),
                custo_real: Number(partialState.custo_real),
                data_compra: new Date().toISOString(),
                pago_ao_fornecedor: partialState.pago_fornecedor
            };

            if (partialState.id_pagamento_peca) {
                    await api.put(`/pagamento-peca/${partialState.id_pagamento_peca}`, payload);
            } else {
                    const res = await api.post('/pagamento-peca', payload);
                    // Update the state with the new ID to avoid duplicates on next save
                    setItemsState(prev => ({
                        ...prev,
                        [id_iten]: { ...prev[id_iten], id_pagamento_peca: res.data.id_pagamento_peca }
                    }));
            }
         } catch (error) {
             console.error("Erro no auto-save do item", error);
         }
    };

    const handleItemChange = (id_iten: number, field: keyof ItemFinanceiroState, value: any) => {
        setItemsState(prev => {
            const newState = {
                ...prev,
                [id_iten]: {
                    ...prev[id_iten],
                    [field]: value
                }
            };
            
            // Auto-save trigger (debounced 500ms effectively by user typing speed, but for simplicity here we just call it)
            // Ideally we should debounce. For now, let's just trigger it. 
            // Actually, flooding the API on every keypress for 'custo_real' is bad.
            // Let's rely on onBlur for inputs, but the user might click 'Novo Pagamento' without blurring properly?
            // User said "costs were blank again... did not persist".
            // Let's add onBlur to the inputs to trigger save.
            
            return newState;
        });
    };

    const handleItemBlur = (id_iten: number) => {
        const state = itemsState[id_iten];
        if (state) saveItemCost(id_iten, state);
    };



    // ITEM EDITING
    const handleSaveItemEdit = async (e: FormEvent) => {
        e.preventDefault();
        if (!editItem || !osData) return;

        try {
             const valorTotal = Number(editItem.quantidade) * Number((editItem as any).valor_venda_unitario);

             await api.put(`/itens-os/${editItem.id_iten}`, {
                 descricao: editItem.descricao,
                 quantidade: Number(editItem.quantidade),
                 valor_venda: Number((editItem as any).valor_venda_unitario),
                 valor_total: valorTotal,
                 codigo_referencia: editItem.codigo_referencia
             });

             // Refresh Data
             fetchOsData(osData.id_os);
             setEditItem(null);
             setStatusMsg({ type: 'success', text: 'Item atualizado!' });
             setTimeout(() => setStatusMsg({ type: null, text: '' }), 2000);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao atualizar item.' });
        }
    };

    const handleDeleteItemOS = (id: number) => {
        setConfirmModal({
            isOpen: true,
            title: 'Excluir Item',
            message: 'Tem certeza que deseja remover este item da OS?',
            onConfirm: async () => {
                try {
                    await api.delete(`/itens-os/${id}`);
                    setStatusMsg({ type: 'success', text: 'Item removido com sucesso!' });
                    if (osData) fetchOsData(osData.id_os);
                } catch (error) {
                    setStatusMsg({ type: 'error', text: 'Erro ao remover item.' });
                }
                setConfirmModal(prev => ({ ...prev, isOpen: false }));
            }
        });
    };

    const calculateTotals = () => {
        if (!osData) return { totalReceita: 0, totalCusto: 0, lucro: 0, margem: 0 };
        
        // Recalculate total revenue based on items + labor (since items might have changed)
        const totalItemsRevenue = osData.itens_os.reduce((acc, item) => acc + Number(item.valor_total), 0);
        const totalReceita = totalItemsRevenue + Number(osData.valor_mao_de_obra || 0);

        let totalCusto = 0;
        Object.values(itemsState).forEach(st => {
            totalCusto += Number(st.custo_real || 0);
        });

        const lucro = totalReceita - totalCusto;
        const margem = totalReceita > 0 ? (lucro / totalReceita) * 100 : 0;

        return { totalReceita, totalCusto, lucro, margem, totalItemsRevenue };
    };

    const { totalReceita, totalCusto, lucro, totalItemsRevenue } = calculateTotals();

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        if (!osData) return;

        try {
            // Validação: Verificar se há pagamentos registrados (Receita)
            const totalPago = osData.pagamentos_cliente?.reduce((acc, p) => p.deleted_at ? acc : acc + Number(p.valor), 0) || 0;
            
            if (totalPago === 0) {
                 setStatusMsg({ type: 'error', text: 'Nenhum recebimento registrado. Adicione o pagamento do cliente (seção Recebimentos) antes de finalizar.' });
                 setLoading(false);
                 return;
            }

            // 1. Processar Pagamentos (Upsert)
            const pagamentoPromises = osData.itens_os.map(async (item) => {
                const st = itemsState[item.id_iten];
                
                // Validação de preenchimento dos custos
                if (!st || !st.id_fornecedor || !st.custo_real || Number(st.custo_real) <= 0) {
                     // Se não tiver fornecedor ou custo real, vamos apenas ignorar se for um item sem custo (opcional)
                     // Mas o usuário pediu aviso se esquecer.
                     // Vamos lançar erro se houver items sem custo definido.
                     throw new Error(`Item "${item.descricao}" está sem Fornecedor ou Custo Real definido.`);
                }

                if (st && st.id_fornecedor && Number(st.custo_real) > 0) {
                    const payload = {
                        id_item_os: item.id_iten,
                        id_fornecedor: Number(st.id_fornecedor),
                        custo_real: Number(st.custo_real),
                        data_compra: new Date().toISOString(),
                        pago_ao_fornecedor: st.pago_fornecedor
                    };

                    if (st.id_pagamento_peca) {
                         return api.put(`/pagamento-peca/${st.id_pagamento_peca}`, payload);
                    } else {
                         return api.post('/pagamento-peca', payload);
                    }
                }
                return null;
            });

            await Promise.all(pagamentoPromises);

            // 2. Salvar Fechamento (Upsert)
            const fechamentoPayload = {
                id_os: Number(idOs),
                custo_total_pecas_real: totalCusto
            };

            let response;
            if (osData.fechamento_financeiro) {
                 response = await api.put(`/fechamento-financeiro/${osData.fechamento_financeiro.id_fechamento_financeiro}`, fechamentoPayload);
            } else {
                 response = await api.post('/fechamento-financeiro', fechamentoPayload);
            }
            
            if (osData.status !== 'FINALIZADA') {
                 try {
                      await api.put(`/ordem-de-servico/${idOs}`, { 
                          status: 'FINALIZADA',
                          valor_final: totalReceita,
                          valor_pecas: totalItemsRevenue
                        });
                 } catch (err) { }
            }

            onSuccess(response.data);
            navigate('/');
        } catch (error: any) {
            console.error(error);
            setStatusMsg({ type: 'error', text: error.message || 'Erro ao processar fechamento financeiro.' });
        } finally {
            setLoading(false);
        }
    };

    const getClientName = () => osData?.cliente?.pessoa_fisica?.pessoa?.nome || osData?.cliente?.pessoa_juridica?.nome_fantasia || 'Cliente';

    return (
        <>
        <form onSubmit={handleSubmit} className="space-y-6 relative">
             <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({type: null, text: ''})} />

             <div className="bg-gray-50 p-4 rounded-xl text-sm text-gray-700 border border-gray-100 flex gap-3">
                <Calculator className="text-gray-400 shrink-0" />
                <div>
                    <strong className="block text-gray-900 mb-1">Consolidação Financeira</strong> 
                    {osData?.fechamento_financeiro ? 'Edite os custos lançados anteriormente.' : 'Lance os custos reais de cada peça para calcular o lucro exato desta OS.'}
                </div>
            </div>

            {!preSelectedOsId && (
                <div className="flex gap-2">
                    <input 
                        type="number"
                        value={idOs} 
                        onChange={e => setIdOs(e.target.value)} 
                        className="flex-1 border-2 border-gray-100 p-3 rounded-xl focus:border-gray-900 focus:outline-none transition-colors font-bold" 
                        required 
                        placeholder="Digite o ID da OS..."
                    />
                    <button 
                        type="button" 
                        onClick={handleSearchOs}
                        className="bg-gray-900 text-white px-6 rounded-xl font-bold hover:bg-gray-800 transition-colors"
                    >
                        Buscar OS
                    </button>
                </div>
            )}

            {fetchingOs && <div className="text-center p-4 text-gray-500">Carregando dados da OS...</div>}

            {osData && (
                <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                    
                    {/* OS Summary Card */}
                    <div className="bg-white border-2 border-gray-100 rounded-2xl p-5 shadow-sm flex flex-col gap-4">
                        <div className="flex flex-col md:flex-row gap-6 items-start">
                            {/* LEFT: Client & Vehicle Info */}
                            <div className="flex-1 min-w-[200px]">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="px-2.5 py-1 rounded-md text-xs font-black uppercase bg-gray-100 text-gray-600 tracking-wide">OS #{osData.id_os}</span>
                                    <span className="px-2.5 py-1 rounded-md text-xs font-black uppercase bg-green-100 text-green-700 tracking-wide">{osData.status}</span>
                                </div>
                                <h3 className="font-black text-xl text-gray-900 leading-tight">{getClientName()}</h3>
                                <div className="mt-3 bg-gray-50 border border-gray-100 rounded-xl p-3">
                                    <div className="flex items-center gap-2 mb-1">
                                        <Truck size={18} className="text-gray-400" />
                                        <span className="font-black text-gray-800 text-base uppercase">{osData.veiculo.placa}</span>
                                        <span className="text-gray-300">|</span>
                                        <span className="font-bold text-gray-600 text-sm uppercase">{osData.veiculo.modelo}</span>
                                    </div>
                                    {osData.veiculo.cor && (
                                        <div className="flex items-center gap-2 text-xs font-bold text-gray-500 uppercase pl-1">
                                            <Palette size={14} />
                                            <span className="capitalize">{osData.veiculo.cor}</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* CENTER: Defect & Diagnosis */}
                            <div className="flex-1 w-full md:border-l md:border-r border-gray-100 md:px-6 border-dashed">
                                <div className="flex flex-col gap-3">
                                    <div>
                                        <p className="text-[10px] font-black text-gray-400 uppercase mb-1 tracking-wider">Defeito Relatado</p>
                                        <p className="text-sm font-medium text-gray-700 leading-relaxed">
                                            {osData.defeito_relatado || <span className="italic text-gray-400">Não informado</span>}
                                        </p>
                                    </div>
                                    <div className="h-px bg-gray-100 w-full" />
                                    <div>
                                        <p className="text-[10px] font-black text-blue-400 uppercase mb-1 tracking-wider">Diagnóstico Técnico</p>
                                        <p className="text-sm font-medium text-gray-700 leading-relaxed">
                                            {osData.diagnostico || <span className="italic text-gray-400">Não informado</span>}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* RIGHT: Revenue */}
                            <div className="md:text-right min-w-[150px]">
                                <p className="text-xs font-black text-gray-400 uppercase tracking-widest mb-1">Receita Total</p>
                                <p className="text-3xl font-black text-green-600 tracking-tight">
                                    R$ {Number(totalReceita).toFixed(2)}
                                </p>
                            </div>
                        </div>

                        {/* Detalhamento de Mão de Obra (LaborManager) - Full Width */}
                        <div className="mt-2 border border-blue-100 rounded-xl overflow-hidden text-left bg-blue-50/30">
                            <div className="px-4 py-2 bg-blue-50/50 border-b border-blue-100 flex justify-between items-center">
                                <span className="text-xs font-black uppercase text-blue-600 flex items-center gap-2">
                                    <BadgeCheck size={14} /> Mão de Obra (Execução)
                                </span>
                            </div>
                            <div className="p-3">
                                {/* Prevent form submission from inner buttons by intercepting onSubmit if possible, 
                                    but simpler is assuming LaborManager buttons might need fixing. 
                                    However, typically we can just rely on LaborManager being well behaved. 
                                    If it submits, it's a bug in LaborManager or we need to ensure this form doesn't catch it. 
                                    We can try to assist by making this a div not a form? No, it needs to submit. 
                                    We will assume LaborManager is being fixed or we add a note to fix it.
                                    For layout: Full width container.
                                */}
                                <LaborManager 
                                    osId={osData.id_os}
                                    mode="api" 
                                    employees={employees}
                                    initialData={osData.servicos_mao_de_obra as any[]} 
                                    onChange={() => fetchOsData(osData.id_os)} 
                                    readOnly={false}
                                    onTotalChange={(total) => {
                                        setOsData(prev => {
                                            if (!prev || prev.valor_mao_de_obra === total) return prev;
                                            return { ...prev, valor_mao_de_obra: total };
                                        });
                                    }}
                                />
                            </div>
                        </div>
                    </div>

                    {/* ITEMS TABLE */}
                    <div className="border border-gray-200 rounded-2xl overflow-hidden bg-white shadow-sm">
                        <div className="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                            <h4 className="font-bold text-sm text-gray-700 uppercase tracking-wide">Detalhamento de Custos (Peças)</h4>
                            <button 
                                type="button"
                                onClick={() => setShowFornecedorModal(true)}
                                className="text-[10px] font-black uppercase text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100 transition-colors flex items-center gap-1"
                            >
                                <Plus size={12} /> Novo Fornecedor
                            </button>
                        </div>
                        <table className="w-full text-left">
                            <thead className="bg-gray-50/50 text-xs font-bold text-gray-400 uppercase">
                                <tr>
                                    <th className="p-4 w-1/3">Item / Peça</th>
                                    <th className="p-4">Ref / Nota</th>
                                    <th className="p-4">Fornecedor (Origem)</th>
                                    <th className="p-4 w-32">Custo Real (R$)</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {osData.itens_os.map(item => (
                                    <tr key={item.id_iten} className="hover:bg-gray-50/50 transition-colors group">
                                        <td className="p-4 relative">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <p className="font-bold text-gray-800 text-sm">{item.descricao}</p>
                                                    <p className="text-xs text-gray-400">
                                                        Qtd: {item.quantidade} x R$ {Number(Number(item.valor_total) / item.quantidade).toFixed(2)} = <span className="text-green-600 font-bold">R$ {Number(item.valor_total).toFixed(2)}</span>
                                                    </p>
                                                </div>
                                                <button 
                                                    type="button"
                                                    onClick={() => setEditItem({...item, valor_venda_unitario: Number(item.valor_total) / item.quantidade} as any)}
                                                    className="opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-blue-600 transition-opacity"
                                                    title="Editar Item"
                                                >
                                                    <BadgeCheck size={16} />
                                                </button>
                                                <button 
                                                    type="button"
                                                    onClick={() => handleDeleteItemOS(item.id_iten)}
                                                    className="opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-red-600 transition-opacity"
                                                    title="Excluir Item"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                            </div>
                                        </td>
                                        <td className="p-4 text-xs font-mono font-bold text-gray-500">
                                            {item.codigo_referencia || '-'}
                                        </td>
                                        <td className="p-4">
                                            <select 
                                                className="w-full p-2.5 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                                value={itemsState[item.id_iten]?.id_fornecedor || ''}
                                                onChange={e => handleItemChange(item.id_iten, 'id_fornecedor', e.target.value)}
                                                onBlur={() => handleItemBlur(item.id_iten)}
                                            >
                                                <option value="">-- Selecione --</option>
                                                {fornecedores.map(f => (
                                                    <option key={f.id_fornecedor} value={f.id_fornecedor}>{f.nome}</option>
                                                ))}
                                            </select>
                                        </td>
                                        <td className="p-4">
                                            <div className="relative">
                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs font-bold">R$</span>
                                                <input 
                                                    type="number" 
                                                    step="0.01"
                                                    value={itemsState[item.id_iten]?.custo_real}
                                                    onChange={e => handleItemChange(item.id_iten, 'custo_real', e.target.value)}
                                                    onBlur={() => handleItemBlur(item.id_iten)}
                                                    className="w-full pl-8 pr-3 py-2 border border-gray-200 rounded-lg text-sm font-bold text-red-600 focus:ring-2 focus:ring-red-500 outline-none"
                                                    placeholder="0.00"
                                                />
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {osData.itens_os.length === 0 && (
                            <div className="p-8 text-center text-gray-400 font-medium">Nenhum item lançado nesta OS.</div>
                        )}
                    </div>

                    {/* PAGAMENTOS RECEBIDOS (CRUD) */}
                    <div className="border border-green-200 rounded-2xl overflow-hidden bg-white shadow-sm mt-6">
                        <div className="bg-green-50 px-4 py-3 border-b border-green-200 flex justify-between items-center">
                            <h4 className="font-bold text-sm text-green-800 uppercase tracking-wide">Recebimentos (Pagamentos do Cliente)</h4>
                            <button 
                                type="button"
                                onClick={() => setPaymentModal({ isOpen: true, data: null })}
                                className="text-[10px] font-black uppercase text-green-700 bg-white border border-green-200 px-3 py-1.5 rounded-lg hover:bg-green-100 transition-colors flex items-center gap-1"
                            >
                                <Plus size={12} /> Novo Pagamento
                            </button>
                        </div>
                        <table className="w-full text-left text-xs">
                            <thead className="bg-white border-b border-green-100 text-green-400 font-bold uppercase">
                                <tr>
                                    <th className="p-3">Data</th>
                                    <th className="p-3">Método</th>
                                    <th className="p-3">Pars.</th>
                                    <th className="p-3">NSU / Cód.</th>
                                    <th className="p-3 text-right">Valor</th>
                                    <th className="p-3 text-center">Status</th>
                                    <th className="p-3 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-green-50">
                                {osData.pagamentos_cliente?.sort((a,b) => new Date(b.data_pagamento).getTime() - new Date(a.data_pagamento).getTime()).map(pag => {
                                    const isDeleted = !!pag.deleted_at;
                                    return (
                                        <tr key={pag.id_pagamento_cliente} className={isDeleted ? 'bg-red-50 opacity-60' : 'hover:bg-green-50/50'}>
                                            <td className={`p-3 ${isDeleted ? 'line-through' : ''}`}>{new Date(pag.data_pagamento).toLocaleDateString()}</td>
                                            <td className={`p-3 font-bold ${isDeleted ? 'line-through' : ''}`}>
                                                {pag.metodo_pagamento}
                                                {pag.bandeira_cartao && <span className="text-gray-400 font-normal ml-1">({pag.bandeira_cartao})</span>}
                                            </td>
                                            <td className={`p-3 font-bold text-center ${isDeleted ? 'line-through' : ''}`}>
                                                {pag.qtd_parcelas && pag.qtd_parcelas > 1 ? `${pag.qtd_parcelas}x` : '-'}
                                            </td>
                                            <td className={`p-3 font-mono text-gray-500 ${isDeleted ? 'line-through' : ''}`}>{pag.codigo_transacao || '-'}</td>
                                            <td className={`p-3 text-right font-black ${isDeleted ? 'line-through text-red-800' : 'text-green-700'}`}>R$ {Number(pag.valor).toFixed(2)}</td>
                                            <td className="p-3 text-center">
                                                {isDeleted ? <span className="text-[9px] font-black text-red-500 uppercase rounded bg-white px-1">Excluído</span> : <span className="text-[9px] font-black text-green-600 uppercase">Ativo</span>}
                                            </td>
                                            <td className="p-3 text-center">
                                                {!isDeleted && (
                                                    <div className="flex justify-center gap-2">
                                                        <button 
                                                            type="button"
                                                            onClick={() => setPaymentModal({ isOpen: true, data: pag })}
                                                            className="text-gray-400 hover:text-blue-600"
                                                        >
                                                            <BadgeCheck size={14} />
                                                        </button>
                                                        <button 
                                                            type="button"
                                                            onClick={() => handleDeletePayment(pag.id_pagamento_cliente)}
                                                            className="text-gray-400 hover:text-red-600"
                                                        >
                                                            <Trash2 size={14} />
                                                        </button>
                                                    </div>
                                                )}
                                            </td>
                                        </tr>
                                    );
                                })}
                                {(!osData.pagamentos_cliente || osData.pagamentos_cliente.length === 0) && (
                                    <tr><td colSpan={6} className="p-4 text-center text-gray-400">Nenhum pagamento registrado.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                    <div className={`p-6 rounded-2xl border-2 transition-colors ${lucro >= 0 ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`}>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
                            <div>
                                <p className="text-xs font-bold uppercase text-gray-500 mb-1">Valor Peças (Cobrado)</p>
                                <p className="text-3xl font-black text-gray-900">R$ {(totalItemsRevenue || 0).toFixed(2)}</p>
                                <p className="text-[10px] uppercase font-bold text-gray-400 mt-1">
                                    Ref: <span className={lucro >= 0 ? "text-green-600" : "text-red-600"}>R$ {((totalItemsRevenue || 0) - totalCusto).toFixed(2)}</span>
                                </p>
                            </div>
                            
                            <div className="md:text-center">
                                <p className="text-xs font-bold uppercase text-gray-500 mb-1">Mão de Obra Total</p>
                                <p className="text-3xl font-black text-blue-600">
                                    R$ {Number(osData.valor_mao_de_obra || 0).toFixed(2)}
                                </p>
                            </div>

                            <div className="md:text-right">
                                <p className="text-xs font-bold uppercase text-gray-500 mb-1">Valor Final (OS)</p>
                                <p className="text-4xl font-black text-green-600">
                                    R$ {totalReceita.toFixed(2)}
                                </p>
                                {(() => {
                                    const totalPago = osData.pagamentos_cliente?.filter(p => !p.deleted_at).reduce((acc, p) => acc + Number(p.valor), 0) || 0;
                                    const restante = totalReceita - totalPago;
                                    const isOk = restante <= 0.01;
                                    return (
                                        <div className={`mt-2 inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-black uppercase ${isOk ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                            {isOk ? <><BadgeCheck size={14} /> OK (QUITADO)</> : <><div className="w-2 h-2 rounded-full bg-red-600 animate-pulse" /> PENDENTE</>}
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>
                    </div>

                    <div className="flex gap-3 pt-4 border-t border-gray-100">
                        <button type="button" onClick={onCancel} className="flex-1 py-4 text-gray-600 font-bold hover:bg-gray-50 rounded-xl transition-colors">
                            Cancelar
                        </button>
                        
                        {osData.status === 'FINALIZADA' && (
                            <button 
                                type="button" 
                                onClick={async () => {
                                    if(!osData) return;
                                    try {
                                        if (osData.fechamento_financeiro) {
                                            await api.delete(`/fechamento-financeiro/${osData.fechamento_financeiro.id_fechamento_financeiro}`);
                                        }
                                        await api.put(`/ordem-de-servico/${osData.id_os}`, { 
                                            status: 'ABERTA',
                                            valor_mao_de_obra: osData.valor_mao_de_obra 
                                        });
                                        setStatusMsg({ type: 'success', text: 'OS Reaberta com sucesso!' });
                                        onSuccess(osData);
                                    } catch(e) {
                                        setStatusMsg({ type: 'error', text: 'Erro ao reabrir OS.' });
                                    }
                                }}
                                className="flex-1 py-4 text-orange-600 font-bold hover:bg-orange-50 rounded-xl transition-colors border border-orange-100"
                            >
                                Reabrir OS
                            </button>
                        )}

                        <Button 
                            type="submit" 
                            isLoading={loading}
                            variant="success"
                            className="flex-1 py-4 shadow-xl shadow-green-200"
                        >
                            <Save size={18} /> {osData.fechamento_financeiro ? 'Atualizar Dados' : 'Confirmar & Fechar OS'}
                        </Button>
                    </div>
                </div>
            )}
        </form>

            {/* MODALS OUTSIDE THE MAIN FORM */}

            {showFornecedorModal && (
                <Modal title="Novo Fornecedor" onClose={() => setShowFornecedorModal(false)}>
                    <FornecedorForm 
                        onSuccess={() => {
                             setShowFornecedorModal(false);
                             loadFornecedores(); 
                        }}
                        onCancel={() => setShowFornecedorModal(false)}
                    />
                </Modal>
            )}

            {paymentModal.isOpen && osData && (
                <Modal title={paymentModal.data ? 'Editar Pagamento' : 'Novo Pagamento'} onClose={() => setPaymentModal({ isOpen: false, data: null })}>
                    <PagamentoClienteForm
                        osId={osData.id_os}
                        valorTotal={
                            ((osData!.itens_os.reduce((acc, i) => acc + Number(i.valor_total), 0) + Number(osData!.valor_mao_de_obra || 0)) -
                            (osData!.pagamentos_cliente?.filter(p => !p.deleted_at && p.id_pagamento_cliente !== paymentModal.data?.id_pagamento_cliente).reduce((acc, p) => acc + Number(p.valor), 0) || 0))
                        }
                        initialData={paymentModal.data}
                        onSuccess={() => {
                            setPaymentModal({ isOpen: false, data: null });
                            fetchOsData(osData.id_os);
                            setStatusMsg({ type: 'success', text: 'Pagamento salvo!' });
                        }}
                        onCancel={() => setPaymentModal({ isOpen: false, data: null })}
                    />
                </Modal>
            )}

             {editItem && (
                <Modal title="Editar Item da OS" onClose={() => setEditItem(null)}>
                    <div className="space-y-4">
                        <div>
                            <label className="text-xs font-bold text-gray-500 uppercase">Descrição</label>
                            <input 
                                value={editItem.descricao}
                                onChange={e => setEditItem({...editItem, descricao: e.target.value})}
                                className="w-full border p-3 rounded-xl font-bold"
                            />
                        </div>
                        <div>
                            <label className="text-xs font-bold text-gray-500 uppercase">Ref / Nota</label>
                            <input 
                                value={editItem.codigo_referencia || ''}
                                onChange={e => setEditItem({...editItem, codigo_referencia: e.target.value})}
                                className="w-full border p-3 rounded-xl font-bold"
                            />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Quantidade</label>
                                <input 
                                    type="number"
                                    value={editItem.quantidade}
                                    onChange={e => setEditItem({...editItem, quantidade: Number(e.target.value)})}
                                    className="w-full border p-3 rounded-xl font-bold"
                                />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">Valor Unitário (Venda)</label>
                                <input 
                                    type="number" step="0.01"
                                    value={(editItem as any).valor_venda_unitario}
                                    onChange={e => setEditItem({...editItem, valor_venda_unitario: e.target.value} as any)}
                                    className="w-full border p-3 rounded-xl font-bold"
                                />
                            </div>
                        </div>
                        <div className="flex justify-end gap-2 mt-4">
                             <button onClick={() => setEditItem(null)} className="px-4 py-2 text-gray-500 font-bold">Cancelar</button>
                             <button onClick={handleSaveItemEdit} className="bg-green-600 text-white px-6 py-2 rounded-xl font-bold">Salvar Alterações</button>
                        </div>
                    </div>
                </Modal>
            )}

            {/* Confirmation Modal */}
            {confirmModal.isOpen && (
                <Modal 
                    title={confirmModal.title} 
                    onClose={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))}
                >
                     <div className="space-y-6">
                        <p className="text-neutral-600 font-medium">{confirmModal.message}</p>
                        <div className="flex justify-end gap-3 pt-2">
                             <button
                                type="button"
                                onClick={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))}
                                className="px-5 py-2.5 text-neutral-600 font-bold hover:bg-neutral-100 rounded-lg transition-colors"
                            >
                                Cancelar
                            </button>
                            <button
                                type="button"
                                onClick={confirmModal.onConfirm}
                                className="px-5 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors shadow-lg shadow-red-500/30"
                            >
                                Confirmar
                            </button>
                        </div>
                    </div>
                </Modal>
            )}
        </>
    );
};



================================================================================
FILE PATH: client\src\components\forms\FornecedorForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';
import { Store, User, Phone, FileText, BadgeCheck } from 'lucide-react';

interface FornecedorFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const FornecedorForm = ({ onSuccess, onCancel }: FornecedorFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // Schema: nome, documento?, contato?
    const [nome, setNome] = useState('');
    const [documento, setDocumento] = useState('');
    const [contato, setContato] = useState('');

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                nome,
                documento: documento || null,
                contato: contato || null
            };

            const response = await api.post('/fornecedor', payload);
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao cadastrar fornecedor.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-6">
            <div className="bg-orange-50 p-4 rounded-xl flex items-center gap-3 border border-orange-100">
                <Store className="text-orange-500" />
                <p className="text-sm text-orange-800 font-medium">Cadastre um novo parceiro para fornecimento de peças.</p>
            </div>

            <div className="space-y-4">
                <div>
                    <label className="text-xs font-black text-neutral-500 uppercase flex items-center gap-2 mb-2">
                        <User size={14} /> Nome / Razão Social *
                    </label>
                    <input 
                        value={nome} 
                        onChange={e => setNome(e.target.value)} 
                        className="w-full p-4 bg-neutral-50 border border-neutral-100 rounded-xl focus:ring-4 focus:ring-orange-500/10 focus:border-orange-500 outline-none font-bold text-neutral-900 transition-all placeholder:font-normal"
                        required 
                        placeholder="Ex: Auto Peças Silva LTDA"
                    />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label className="text-xs font-black text-neutral-500 uppercase flex items-center gap-2 mb-2">
                            <FileText size={14} /> Documento (CPF/CNPJ)
                        </label>
                        <input 
                            value={documento} 
                            onChange={e => setDocumento(e.target.value)} 
                            className="w-full p-4 bg-neutral-50 border border-neutral-100 rounded-xl focus:ring-4 focus:ring-orange-500/10 focus:border-orange-500 outline-none font-bold text-neutral-900 transition-all placeholder:font-normal"
                            placeholder="Somente números"
                        />
                    </div>

                    <div>
                        <label className="text-xs font-black text-neutral-500 uppercase flex items-center gap-2 mb-2">
                            <Phone size={14} /> Contato
                        </label>
                        <input 
                            value={contato} 
                            onChange={e => setContato(e.target.value)} 
                            className="w-full p-4 bg-neutral-50 border border-neutral-100 rounded-xl focus:ring-4 focus:ring-orange-500/10 focus:border-orange-500 outline-none font-bold text-neutral-900 transition-all placeholder:font-normal"
                            placeholder="Telefone, Whatsapp ou Email"
                        />
                    </div>
                </div>
            </div>

            <div className="flex gap-3 pt-4 border-t border-neutral-100">
                <button type="button" onClick={onCancel} className="flex-1 py-4 text-neutral-600 font-black text-xs uppercase hover:bg-neutral-50 rounded-xl transition-colors">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-4 bg-neutral-900 text-white font-black text-xs uppercase rounded-xl hover:bg-neutral-800 disabled:opacity-50 shadow-xl shadow-neutral-900/10 flex items-center justify-center gap-2 transition-all hover:scale-[1.02]"
                >
                    {loading ? 'Salvando...' : <><BadgeCheck size={18} /> Cadastrar Fornecedor</>}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\FuncionarioForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';
import { Briefcase, DollarSign, Calendar, FileText, Info, User, CheckCircle } from 'lucide-react';

interface FuncionarioFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const FuncionarioForm = ({ onSuccess, onCancel }: FuncionarioFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // User Identity (Pessoa)
    const [nome, setNome] = useState('');
    const [genero, setGenero] = useState('');
    
    // Physical Person (Pessoa Fisica)
    const [cpf, setCpf] = useState('');
    
    // Contract Details (Funcionario)
    const [ativo, setAtivo] = useState('S');
    const [cargo, setCargo] = useState('');
    const [salario, setSalario] = useState('');
    const [comissao, setComissao] = useState('');
    const [dtAdmissao, setDtAdmissao] = useState(new Date().toISOString().split('T')[0]);
    // Other
    const [obs, setObs] = useState('');

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            // 1. Criar Pessoa Base
            const pessoaResponse = await api.post('/pessoa', {
                nome,
                genero: genero || null,
            });
            const idPessoa = pessoaResponse.data.id_pessoa;

            // 2. Criar Pessoa Física
            const pfResponse = await api.post('/pessoa-fisica', {
                id_pessoa: idPessoa,
                cpf: cpf.replace(/\D/g, '') || null
            });
            const idPessoaFisica = pfResponse.data.id_pessoa_fisica;

            // 3. Criar Funcionário
            const payload = {
                id_pessoa_fisica: idPessoaFisica,
                ativo,
                cargo,
                salario: salario ? Number(salario) : null,
                comissao: comissao ? Number(comissao) : null,
                dt_admissao: new Date(dtAdmissao).toISOString(),
                obs: obs || null
            };

            const response = await api.post('/funcionario', payload);
            alert('Funcionário cadastrado com sucesso!');
            onSuccess(response.data);
        } catch (error: any) {
            console.error(error);
            const msg = error.response?.data?.error || 'Erro ao cadastrar funcionário.';
            alert(msg);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="space-y-6 text-neutral-900 bg-white p-2">
             <div className="bg-primary-50 p-4 rounded-2xl flex items-start gap-4 border border-primary-100 mb-2">
                <div className="bg-primary-500 p-2 rounded-xl text-white shadow-lg shadow-primary-500/30">
                    <Info size={20} />
                </div>
                <div>
                    <h4 className="text-sm font-black text-primary-900 uppercase tracking-tight">Cadastro Unificado</h4>
                    <p className="text-xs text-primary-700 font-medium tracking-tight">Este formulário cria automaticamente os registros de Pessoa, Pessoa Física e Funcionário.</p>
                </div>
            </div>

            <form onSubmit={handleSubmit} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* DADOS PESSOAIS */}
                    <div className="col-span-2">
                        <h3 className="text-sm font-black text-neutral-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <User size={16} /> Dados Pessoais
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="col-span-2">
                                <label className="block text-[10px] font-black text-neutral-500 uppercase mb-1 ml-1">Nome Completo *</label>
                                <input 
                                    value={nome} 
                                    onChange={e => setNome(e.target.value)} 
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-bold text-neutral-800 transition-all" 
                                    required 
                                    placeholder="Nome completo do funcionário"
                                />
                            </div>
                            <div>
                                <label className="block text-[10px] font-black text-neutral-500 uppercase mb-1 ml-1">CPF</label>
                                <input 
                                    value={cpf} 
                                    onChange={e => setCpf(e.target.value)} 
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-bold text-neutral-800 transition-all" 
                                    placeholder="000.000.000-00"
                                />
                            </div>
                            <div>
                                <label className="block text-[10px] font-black text-neutral-500 uppercase mb-1 ml-1">Gênero</label>
                                <select 
                                    value={genero} 
                                    onChange={e => setGenero(e.target.value)} 
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-bold text-neutral-800 transition-all"
                                >
                                    <option value="">Selecione...</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Feminino">Feminino</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* DADOS CONTRATUAIS */}
                    <div className="col-span-2 border-t border-neutral-100 pt-6">
                        <h3 className="text-sm font-black text-neutral-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <Briefcase size={16} /> Dados do Contrato
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="col-span-1">
                                <label className="block text-[10px] font-black text-neutral-500 uppercase mb-1 ml-1">Cargo *</label>
                                <input 
                                    value={cargo} 
                                    onChange={e => setCargo(e.target.value)} 
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-bold text-neutral-800 transition-all" 
                                    required 
                                    placeholder="Ex: Mecânico, Vendedor"
                                />
                            </div>
                            <div>
                                <label className="block text-[10px] font-black text-neutral-500 uppercase mb-1 ml-1">Status</label>
                                <select 
                                    value={ativo} 
                                    onChange={e => setAtivo(e.target.value)} 
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-black text-primary-600 transition-all"
                                >
                                    <option value="S">ATIVO</option>
                                    <option value="N">INATIVO</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-[10px] font-black text-neutral-500 uppercase mb-1 ml-1">Salário (R$)</label>
                                <div className="relative">
                                    <DollarSign size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" />
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value={salario} 
                                        onChange={e => setSalario(e.target.value)} 
                                        className="w-full bg-neutral-50 border border-neutral-200 pl-10 pr-3 py-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-bold text-neutral-800 transition-all" 
                                        placeholder="0,00"
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-[10px] font-black text-neutral-500 uppercase mb-1 ml-1">Comissão (%)</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 font-bold text-neutral-400 text-xs">%</span>
                                    <input 
                                        type="number" 
                                        value={comissao} 
                                        onChange={e => setComissao(e.target.value)} 
                                        className="w-full bg-neutral-50 border border-neutral-200 pl-10 pr-3 py-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-bold text-neutral-800 transition-all" 
                                        placeholder="0"
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-[10px] font-black text-neutral-500 uppercase mb-1 ml-1">Data de Admissão *</label>
                                <div className="relative">
                                    <Calendar size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" />
                                    <input 
                                        type="date" 
                                        value={dtAdmissao} 
                                        onChange={e => setDtAdmissao(e.target.value)} 
                                        className="w-full bg-neutral-50 border border-neutral-200 pl-10 pr-3 py-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-bold text-neutral-800 transition-all" 
                                        required 
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="col-span-2 border-t border-neutral-100 pt-6">
                        <label className="text-[10px] font-black text-neutral-500 uppercase mb-1 ml-1 flex items-center gap-1">
                            <FileText size={14} /> Observações Internas
                        </label>
                        <textarea 
                            value={obs} 
                            onChange={e => setObs(e.target.value)} 
                            className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-medium text-neutral-800 transition-all min-h-[100px] resize-none" 
                            placeholder="Informações adicionais sobre o colaborador..." 
                        />
                    </div>
                </div>

                <div className="flex gap-4 pt-4 border-t border-neutral-100">
                    <button 
                        type="button" 
                        onClick={onCancel} 
                        className="flex-1 py-4 text-neutral-500 font-black text-xs uppercase hover:bg-neutral-100 rounded-2xl transition-all tracking-widest"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        disabled={loading}
                        className="flex-2 px-12 py-4 bg-neutral-900 text-white font-black text-xs uppercase rounded-2xl hover:bg-primary-600 disabled:opacity-50 transition-all tracking-widest shadow-xl shadow-neutral-900/10 flex items-center justify-center gap-2 active:scale-95"
                    >
                        {loading ? 'Processando...' : (
                            <>
                                Finalizar Cadastro <CheckCircle size={18} />
                            </>
                        )}
                    </button>
                </div>
            </form>
        </div>
    );
};



================================================================================
FILE PATH: client\src\components\forms\ItensOsForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface ItensOsFormProps {
    osId: number;
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const ItensOsForm = ({ osId, onSuccess, onCancel }: ItensOsFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // Schema: id_os, id_pecas_estoque?, descricao, quantidade, valor_venda, valor_total
    const [idPecasEstoque, setIdPecasEstoque] = useState('');
    const [descricao, setDescricao] = useState('');
    const [quantidade, setQuantidade] = useState('1');
    const [valorVenda, setValorVenda] = useState('');
    const [valorTotal, setValorTotal] = useState('');

    // Auto-calculate valor_total when quantidade or valor_venda changes
    const handleQuantidadeChange = (value: string) => {
        setQuantidade(value);
        if (valorVenda) {
            const total = Number(value) * Number(valorVenda);
            setValorTotal(total.toFixed(2));
        }
    };

    const handleValorVendaChange = (value: string) => {
        setValorVenda(value);
        if (quantidade) {
            const total = Number(quantidade) * Number(value);
            setValorTotal(total.toFixed(2));
        }
    };

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                id_os: osId,
                id_pecas_estoque: idPecasEstoque ? Number(idPecasEstoque) : null,
                descricao,
                quantidade: Number(quantidade),
                valor_venda: Number(valorVenda),
                valor_total: Number(valorTotal)
            };

            const response = await api.post('/itens-os', payload);
            alert('Item adicionado à OS com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao adicionar item à OS.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div className="bg-blue-50 p-3 rounded text-sm text-blue-800 border border-blue-100">
                <strong>OS #{osId}</strong> - Adicionando item/peça/serviço
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">ID Peça Estoque (Opcional)</label>
                    <input 
                        type="number"
                        value={idPecasEstoque} 
                        onChange={e => setIdPecasEstoque(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        placeholder="Deixe vazio para serviço"
                    />
                </div>

                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Descrição *</label>
                    <input 
                        value={descricao} 
                        onChange={e => setDescricao(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                        placeholder="Ex: Troca de óleo, Filtro de ar..."
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Quantidade *</label>
                    <input 
                        type="number"
                        min="1"
                        value={quantidade} 
                        onChange={e => handleQuantidadeChange(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Valor Unitário (R$) *</label>
                    <input 
                        type="number"
                        step="0.01"
                        value={valorVenda} 
                        onChange={e => handleValorVendaChange(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                    />
                </div>

                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Valor Total (R$)</label>
                    <input 
                        type="number"
                        step="0.01"
                        value={valorTotal} 
                        onChange={e => setValorTotal(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300 bg-gray-50 font-bold text-lg" 
                        required 
                        readOnly
                    />
                </div>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 disabled:opacity-50"
                >
                    {loading ? 'Adicionando...' : 'Adicionar Item'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\PagamentoClienteForm.tsx
================================================================================
import { useState, useEffect, type FormEvent } from 'react';
import { api } from '../../services/api';
import { CreditCard, DollarSign, CheckCircle, Smartphone } from 'lucide-react';

interface PagamentoClienteFormProps {
    osId: number;
    valorTotal: number;
    onSuccess: (payment: any) => void;
    onCancel: () => void;
}

export const PagamentoClienteForm = ({ osId, valorTotal, initialData, onSuccess, onCancel }: PagamentoClienteFormProps & { initialData?: any }) => {
    const [loading, setLoading] = useState(false);
    const [metodo, setMetodo] = useState('CREDITO');
    const [valor, setValor] = useState(String(valorTotal));
    const [bandeira, setBandeira] = useState('');
    const [parcelas, setParcelas] = useState('1');
    const [codigoTransacao, setCodigoTransacao] = useState('');

    useEffect(() => {
        if (initialData) {
            setMetodo(initialData.metodo_pagamento || 'CREDITO');
            setValor(String(initialData.valor));
            setBandeira(initialData.bandeira_cartao || '');
            setParcelas(String(initialData.qtd_parcelas || 1));
            setCodigoTransacao(initialData.codigo_transacao || '');
        }
    }, [initialData]);

    const [error, setError] = useState('');

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
            const cleanValor = String(valor).replace(',', '.');
            if (isNaN(Number(cleanValor)) || Number(cleanValor) <= 0) {
                setError('Valor inválido.');
                setLoading(false);
                return;
            }

            const payload = {
                id_os: osId,
                metodo_pagamento: metodo,
                valor: Number(cleanValor),
                data_pagamento: initialData?.data_pagamento || new Date().toISOString(),
                bandeira_cartao: (metodo === 'CREDITO' || metodo === 'DEBITO') ? bandeira : null,
                codigo_transacao: codigoTransacao || null,
                qtd_parcelas: metodo === 'CREDITO' ? Number(parcelas) : 1
            };

            let response;
            if (initialData?.id_pagamento_cliente) {
                response = await api.put(`/pagamento-cliente/${initialData.id_pagamento_cliente}`, payload);
            } else {
                response = await api.post('/pagamento-cliente', payload);
            }
            
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            setError('Erro ao salvar pagamento. Verifique os dados.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-6">
            <div className="bg-green-50 p-4 rounded-xl flex items-center gap-3 border border-green-100">
                <DollarSign className="text-green-600" />
                <div>
                    <strong className="block text-green-900 text-sm">{initialData ? 'Editar Pagamento' : 'Registro de Pagamento'}</strong>
                    <p className="text-xs text-green-700">Informe os detalhes do recebimento do cliente.</p>
                </div>
            </div>

            {error && (
                <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm font-bold border border-red-200">
                    {error}
                </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="md:col-span-2">
                    <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Valor do Pagamento (R$)</label>
                    <input 
                        type="number" 
                        step="0.01"
                        value={valor}
                        onChange={e => setValor(e.target.value)}
                        className="w-full p-3 border border-gray-200 rounded-xl font-black text-2xl text-green-600 focus:ring-2 focus:ring-green-500 outline-none"
                    />
                </div>

                <div className="md:col-span-2">
                    <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Forma de Pagamento</label>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                        {['CREDITO', 'DEBITO', 'PIX', 'DINHEIRO'].map(m => (
                            <button
                                key={m}
                                type="button"
                                onClick={() => setMetodo(m)}
                                className={`p-3 rounded-xl border flex flex-col items-center gap-2 transition-all ${metodo === m ? 'bg-green-100 border-green-500 text-green-700 ring-2 ring-green-500/20' : 'bg-gray-50 border-gray-100 text-gray-600 hover:bg-white'}`}
                            >
                                {m === 'CREDITO' && <CreditCard size={20} />}
                                {m === 'DEBITO' && <CreditCard size={20} />}
                                {m === 'PIX' && <Smartphone size={20} />}
                                {m === 'DINHEIRO' && <DollarSign size={20} />}
                                <span className="text-[10px] font-bold">{m}</span>
                            </button>
                        ))}
                    </div>
                </div>

                {(metodo === 'CREDITO' || metodo === 'DEBITO') && (
                    <>
                        <div>
                            <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Bandeira</label>
                            <select 
                                value={bandeira} 
                                onChange={e => setBandeira(e.target.value)}
                                className="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none focus:border-green-500 font-bold text-gray-700"
                            >
                                <option value="">Selecione...</option>
                                <option value="VISA">Visa</option>
                                <option value="MASTER">Mastercard</option>
                                <option value="ELO">Elo</option>
                                <option value="AMEX">Amex</option>
                                <option value="HIPER">Hipercard</option>
                            </select>
                        </div>
                        {metodo === 'CREDITO' && (
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Parcelas</label>
                                <select 
                                    value={parcelas} 
                                    onChange={e => setParcelas(e.target.value)}
                                    className="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none focus:border-green-500 font-bold text-gray-700"
                                >
                                    {[1,2,3,4,5,6,10,12].map(p => (
                                        <option key={p} value={p}>{p}x</option>
                                    ))}
                                </select>
                            </div>
                        )}
                    </>
                )}

                <div className="md:col-span-2">
                    <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">
                        {metodo === 'PIX' ? 'ID da Transação (Pix)' : 'Código de Autorização / NSU'}
                    </label>
                    <input 
                        value={codigoTransacao}
                        onChange={e => setCodigoTransacao(e.target.value)}
                        className="w-full p-3 border border-gray-200 rounded-xl outline-none focus:border-green-500 font-mono text-sm"
                        placeholder="Opcional"
                    />
                </div>
            </div>

            <div className="flex gap-3 pt-4 border-t border-gray-100">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-50 rounded-xl transition-colors">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-green-600 text-white font-black uppercase text-xs rounded-xl hover:bg-green-700 shadow-xl shadow-green-200 transition-all flex items-center justify-center gap-2"
                >
                    {loading ? 'Processando...' : <><CheckCircle size={18} /> {initialData ? 'Salvar Alterações' : 'Confirmar Pagamento'}</>}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\PagamentoPecaForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface PagamentoPecaFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const PagamentoPecaForm = ({ onSuccess, onCancel }: PagamentoPecaFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // Schema: id_item_os, id_fornecedor, custo_real, data_compra, data_pagamento_fornecedor?, pago_ao_fornecedor
    const [idItemOs, setIdItemOs] = useState('');
    const [idFornecedor, setIdFornecedor] = useState('');
    const [custoReal, setCustoReal] = useState('');
    const [dataCompra, setDataCompra] = useState('');
    const [dataPagamentoFornecedor, setDataPagamentoFornecedor] = useState('');
    const [pagoAoFornecedor, setPagoAoFornecedor] = useState(false);

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                id_item_os: Number(idItemOs),
                id_fornecedor: Number(idFornecedor),
                custo_real: Number(custoReal),
                data_compra: new Date(dataCompra).toISOString(),
                data_pagamento_fornecedor: dataPagamentoFornecedor ? new Date(dataPagamentoFornecedor).toISOString() : null,
                pago_ao_fornecedor: pagoAoFornecedor
            };

            const response = await api.post('/pagamento-peca', payload);
            alert('Pagamento de peça registrado com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao registrar pagamento de peça.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div className="bg-orange-50 p-3 rounded text-sm text-orange-800 border border-orange-100">
                <strong>Rastreio de Custo Real:</strong> Registre o custo efetivo pago ao fornecedor.
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">ID Item OS *</label>
                    <input 
                        type="number"
                        value={idItemOs} 
                        onChange={e => setIdItemOs(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                        placeholder="ID do item da OS"
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">ID Fornecedor *</label>
                    <input 
                        type="number"
                        value={idFornecedor} 
                        onChange={e => setIdFornecedor(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                        placeholder="ID do fornecedor"
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Custo Real (R$) *</label>
                    <input 
                        type="number"
                        step="0.01"
                        value={custoReal} 
                        onChange={e => setCustoReal(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Data da Compra *</label>
                    <input 
                        type="date"
                        value={dataCompra} 
                        onChange={e => setDataCompra(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Data Pagamento Fornecedor</label>
                    <input 
                        type="date"
                        value={dataPagamentoFornecedor} 
                        onChange={e => setDataPagamentoFornecedor(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                    />
                </div>

                <div className="flex items-center">
                    <label className="flex items-center gap-2 cursor-pointer">
                        <input 
                            type="checkbox"
                            checked={pagoAoFornecedor} 
                            onChange={e => setPagoAoFornecedor(e.target.checked)} 
                            className="w-5 h-5 text-green-600"
                        />
                        <span className="text-sm font-bold text-gray-700">Pago ao Fornecedor</span>
                    </label>
                </div>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 disabled:opacity-50"
                >
                    {loading ? 'Salvando...' : 'Registrar Pagamento'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\PecasEstoqueForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface PecasEstoqueFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const PecasEstoqueForm = ({ onSuccess, onCancel }: PecasEstoqueFormProps) => {
    const [loading, setLoading] = useState(false);

    // Form States
    const [nome, setNome] = useState('');
    const [descricao, setDescricao] = useState('');
    const [fabricante, setFabricante] = useState('');
    const [unidadeMedida, setUnidadeMedida] = useState('');
    const [valorCusto, setValorCusto] = useState('');
    const [valorVenda, setValorVenda] = useState('');
    const [estoqueAtual, setEstoqueAtual] = useState('');
    const [custoUnitarioPadrao, setCustoUnitarioPadrao] = useState('');

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                nome,
                descricao,
                fabricante,
                unidade_medida: unidadeMedida,
                valor_custo: Number(valorCusto),
                valor_venda: Number(valorVenda),
                estoque_atual: Number(estoqueAtual),
                custo_unitario_padrao: custoUnitarioPadrao ? Number(custoUnitarioPadrao) : 0
            };

            const response = await api.post('/pecas-estoque', payload);
            alert('Peça cadastrada com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao cadastrar peça.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Nome da Peça *</label>
                    <input value={nome} onChange={e => setNome(e.target.value)} className="w-full border p-2 rounded border-gray-300" required />
                </div>
                 <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Descrição Detalhada *</label>
                    <input value={descricao} onChange={e => setDescricao(e.target.value)} className="w-full border p-2 rounded border-gray-300" required />
                </div>
                
                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Fabricante</label>
                    <input value={fabricante} onChange={e => setFabricante(e.target.value)} className="w-full border p-2 rounded border-gray-300" />
                </div>
                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Unidade Medida</label>
                    <input value={unidadeMedida} onChange={e => setUnidadeMedida(e.target.value)} className="w-full border p-2 rounded border-gray-300" placeholder="Ex: UN, KG, LT" />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Valor Custo (R$) *</label>
                    <input type="number" step="0.01" value={valorCusto} onChange={e => setValorCusto(e.target.value)} className="w-full border p-2 rounded border-gray-300" required />
                </div>
                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Valor Venda (R$) *</label>
                    <input type="number" step="0.01" value={valorVenda} onChange={e => setValorVenda(e.target.value)} className="w-full border p-2 rounded border-gray-300" required />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Estoque Atual *</label>
                    <input type="number" value={estoqueAtual} onChange={e => setEstoqueAtual(e.target.value)} className="w-full border p-2 rounded border-gray-300" required />
                </div>
                 <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Custo Padrão (Ref.)</label>
                    <input type="number" step="0.01" value={custoUnitarioPadrao} onChange={e => setCustoUnitarioPadrao(e.target.value)} className="w-full border p-2 rounded border-gray-300" />
                </div>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 disabled:opacity-50"
                >
                    {loading ? 'Salvando...' : 'Salvar Peça'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\PessoaFisicaForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface PessoaFisicaFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const PessoaFisicaForm = ({ onSuccess, onCancel }: PessoaFisicaFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // Schema: id_pessoa, cpf?
    const [idPessoa, setIdPessoa] = useState('');
    const [cpf, setCpf] = useState('');

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                id_pessoa: Number(idPessoa),
                cpf: cpf || null
            };

            const response = await api.post('/pessoa-fisica', payload);
            alert('Pessoa Física cadastrada com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao cadastrar. Verifique se o ID da Pessoa existe.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div className="bg-blue-50 p-3 rounded text-sm text-blue-800 border border-blue-100">
                <strong>Pré-requisito:</strong> A Pessoa base deve estar cadastrada primeiro.
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">ID Pessoa *</label>
                    <input 
                        type="number"
                        value={idPessoa} 
                        onChange={e => setIdPessoa(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                        placeholder="Ex: 10"
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">CPF</label>
                    <input 
                        value={cpf} 
                        onChange={e => setCpf(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        maxLength={11}
                        placeholder="Somente números"
                    />
                </div>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 disabled:opacity-50"
                >
                    {loading ? 'Salvando...' : 'Salvar Pessoa Física'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\PessoaForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface PessoaFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const PessoaForm = ({ onSuccess, onCancel }: PessoaFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // Schema: nome, genero?, dt_nascimento?, obs?
    const [nome, setNome] = useState('');
    const [genero, setGenero] = useState('');
    const [dtNascimento, setDtNascimento] = useState('');
    const [obs, setObs] = useState('');

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                nome,
                genero: genero || null,
                dt_nascimento: dtNascimento ? new Date(dtNascimento) : null,
                obs: obs || null
            };

            const response = await api.post('/pessoa', payload);
            alert('Pessoa cadastrada com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao cadastrar pessoa.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Nome Completo *</label>
                    <input 
                        value={nome} 
                        onChange={e => setNome(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Gênero</label>
                    <select value={genero} onChange={e => setGenero(e.target.value)} className="w-full border p-2 rounded border-gray-300">
                        <option value="">Selecione...</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Feminino">Feminino</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Data Nascimento</label>
                    <input 
                        type="date" 
                        value={dtNascimento} 
                        onChange={e => setDtNascimento(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                    />
                </div>

                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Observações</label>
                    <textarea 
                        value={obs} 
                        onChange={e => setObs(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        rows={3}
                    />
                </div>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 disabled:opacity-50"
                >
                    {loading ? 'Salvando...' : 'Salvar Pessoa'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\PessoaJuridicaForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface PessoaJuridicaFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const PessoaJuridicaForm = ({ onSuccess, onCancel }: PessoaJuridicaFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // Schema: id_pessoa, razao_social, nome_fantasia?, cnpj?, inscricao_estadual?
    const [idPessoa, setIdPessoa] = useState('');
    const [razaoSocial, setRazaoSocial] = useState('');
    const [nomeFantasia, setNomeFantasia] = useState('');
    const [cnpj, setCnpj] = useState('');
    const [inscricaoEstadual, setInscricaoEstadual] = useState('');

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                id_pessoa: Number(idPessoa),
                razao_social: razaoSocial,
                nome_fantasia: nomeFantasia || null,
                cnpj: cnpj || null,
                inscricao_estadual: inscricaoEstadual || null
            };

            const response = await api.post('/pessoa-juridica', payload);
            alert('Pessoa Jurídica cadastrada com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao cadastrar. Verifique se o ID da Pessoa existe.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div className="bg-purple-50 p-3 rounded text-sm text-purple-800 border border-purple-100">
                <strong>Pré-requisito:</strong> A Pessoa base deve estar cadastrada primeiro.
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">ID Pessoa *</label>
                    <input 
                        type="number"
                        value={idPessoa} 
                        onChange={e => setIdPessoa(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                        placeholder="Ex: 10"
                    />
                </div>

                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Razão Social *</label>
                    <input 
                        value={razaoSocial} 
                        onChange={e => setRazaoSocial(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        required 
                    />
                </div>

                <div className="col-span-2">
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Nome Fantasia</label>
                    <input 
                        value={nomeFantasia} 
                        onChange={e => setNomeFantasia(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">CNPJ</label>
                    <input 
                        value={cnpj} 
                        onChange={e => setCnpj(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                        maxLength={14}
                        placeholder="Somente números"
                    />
                </div>

                <div>
                    <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Inscrição Estadual</label>
                    <input 
                        value={inscricaoEstadual} 
                        onChange={e => setInscricaoEstadual(e.target.value)} 
                        className="w-full border p-2 rounded border-gray-300" 
                    />
                </div>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 disabled:opacity-50"
                >
                    {loading ? 'Salvando...' : 'Salvar Pessoa Jurídica'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\TipoForm.tsx
================================================================================
import { useState } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';

interface TipoFormProps {
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
}

export const TipoForm = ({ onSuccess, onCancel }: TipoFormProps) => {
    const [loading, setLoading] = useState(false);
    
    // Schema: funcao?
    const [funcao, setFuncao] = useState('');

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);
        try {
            const payload = {
                funcao: funcao || null
            };

            const response = await api.post('/tipo', payload);
            alert('Tipo cadastrado com sucesso!');
            onSuccess(response.data);
        } catch (error) {
            console.error(error);
            alert('Erro ao cadastrar tipo.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <div>
                <label className="block text-xs font-bold text-gray-700 uppercase mb-1">Função / Tipo</label>
                <input 
                    value={funcao} 
                    onChange={e => setFuncao(e.target.value)} 
                    className="w-full border p-2 rounded border-gray-300" 
                    placeholder="Ex: Cliente, Fornecedor, Parceiro..."
                />
                <p className="text-xs text-gray-500 mt-1">Define a função/categoria da pessoa ou empresa.</p>
            </div>

            <div className="flex gap-2 pt-4">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-100 rounded-lg">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading}
                    className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 disabled:opacity-50"
                >
                    {loading ? 'Salvando...' : 'Salvar Tipo'}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\forms\UnifiedOsForm.tsx
================================================================================

import React, { useState, useEffect } from 'react';
import { User, Car, Wrench, ArrowRight, Phone, AlertCircle, MapPin } from 'lucide-react';
import { api } from '../../services/api';
import { Button } from '../ui/Button';

interface UnifiedOsFormProps {
    onCancel: () => void;
    onSuccess: (osId: number) => void;
    employees: any[];
    initialClient?: any; // If we start from a found client
}

export const UnifiedOsForm: React.FC<UnifiedOsFormProps> = ({ onCancel, onSuccess, employees, initialClient }) => {
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');

    // --- FORM DATA ---
    const [clientData, setClientData] = useState({
        id_cliente: '',
        nome: '',
        telefone: '',
        cep: '',
        logradouro: '',
        numero: '',
        bairro: '',
        cidade: '',
        estado: '',
        isNew: true
    });
    
    const [vehicleData, setVehicleData] = useState({
        id_veiculo: '',
        placa: '',
        marca: '',
        modelo: '',
        cor: '',
        ano: new Date().getFullYear().toString(),
        combustivel: 'FLEX',
        isNew: true
    });

    const [osData, setOsData] = useState({
        km_entrada: '',
        id_funcionario: '',
        defeito: ''
    });

    // Client Search for Autocomplete
    const [clientQuery, setClientQuery] = useState('');
    const [clientResults, setClientResults] = useState<any[]>([]);

    useEffect(() => {
        if (initialClient) {
            selectClient(initialClient);
        }
    }, [initialClient]);

    // Search existing client
    const handleClientSearch = async (val: string) => {
        setClientQuery(val);
        setClientData(prev => ({ ...prev, nome: val, isNew: true, id_cliente: '' }));
        if (val.length < 3) {
            setClientResults([]);
            return;
        }
        try {
            const res = await api.get(`/cliente/search?q=${val}`);
            setClientResults(res.data);
        } catch (e) { console.error(e); }
    };

    const selectClient = (c: any) => {
        const nome = c.pessoa_fisica?.pessoa?.nome || c.pessoa_juridica?.razao_social;
        setClientData({
            id_cliente: c.id_cliente,
            nome: nome,
            telefone: c.telefone_1,
            cep: c.cep || '',
            logradouro: c.logradouro || '',
            numero: c.nr_logradouro || '',
            bairro: c.bairro || '',
            cidade: c.cidade || '',
            estado: c.estado || '',
            isNew: false
        });
        setClientQuery(nome);
        setClientResults([]);
    };

    // --- VALIDATION & SUBMIT ---
    const handleSubmit = async () => {
        setError('');
        if (!clientData.nome) return setError('Nome do cliente é obrigatório.');
        if (!clientData.telefone) return setError('Telefone do cliente é obrigatório.');
        if (!vehicleData.placa) return setError('Placa do veículo é obrigatória.');
        if (!vehicleData.marca) return setError('Marca do veículo é obrigatória.');
        if (!vehicleData.modelo) return setError('Modelo do veículo é obrigatório.');
        if (!osData.km_entrada) return setError('KM é obrigatório.');
        if (!osData.id_funcionario) return setError('Mecânico é obrigatório.');

        setLoading(true);
        try {
            // UNIFIED PAYLOAD
            const payload = {
                client: {
                    id_cliente: clientData.isNew ? null : Number(clientData.id_cliente),
                    nome: clientData.nome,
                    telefone: clientData.telefone,
                    tipo: 'FISICA', // Defaulting to Fisica as per UI simplicity
                    logradouro: clientData.logradouro,
                    numero: clientData.numero,
                    bairro: clientData.bairro,
                    cidade: clientData.cidade,
                    estado: clientData.estado
                    // CPF not in form yet, sending null implicitly by omission
                },
                vehicle: {
                    id_veiculo: vehicleData.isNew ? null : Number(vehicleData.id_veiculo),
                    placa: vehicleData.placa.toUpperCase(),
                    marca: vehicleData.marca,
                    modelo: vehicleData.modelo,
                    cor: vehicleData.cor || 'BRANCO',
                    ano_modelo: vehicleData.ano,
                    combustivel: vehicleData.combustivel
                },
                os: {
                    id_funcionario: Number(osData.id_funcionario),
                    km_entrada: Number(osData.km_entrada),
                    defeito_relatado: osData.defeito
                }
            };

            const response = await api.post('/ordem-de-servico/unified', payload);
            
            onSuccess(response.data.id_os);

        } catch (err: any) {
            console.error(err);
            setError(err.response?.data?.error || err.message || 'Erro ao salvar.');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="space-y-6">
            {/* ERROR MSG */}
            {error && (
                <div className="bg-red-50 text-red-600 p-3 rounded-xl flex items-center gap-2 text-sm font-bold">
                    <AlertCircle size={16} /> {error}
                </div>
            )}

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* SECTION: CLIENTE */}
                <div className="p-4 bg-neutral-50 rounded-2xl border border-neutral-100 space-y-4">
                    <div className="flex items-center gap-2 text-primary-600 mb-2">
                        <User size={20} />
                        <h3 className="font-black text-neutral-400 uppercase tracking-widest text-xs">Dados do Cliente</h3>
                    </div>
                    
                    <div className="relative">
                        <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Nome Completo *</label>
                        <input 
                            value={clientQuery}
                            onChange={e => handleClientSearch(e.target.value)}
                            className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500"
                            placeholder="Buscar ou Digitar Novo..."
                        />
                        {clientResults.length > 0 && (
                            <div className="absolute top-16 left-0 w-full bg-white shadow-xl border border-neutral-100 rounded-xl z-20 max-h-40 overflow-y-auto">
                                {clientResults.map(c => (
                                    <button key={c.id_cliente} onClick={() => selectClient(c)} className="w-full text-left p-3 hover:bg-neutral-50 text-sm font-bold text-neutral-700">
                                        {c.pessoa_fisica?.pessoa?.nome || c.pessoa_juridica?.razao_social}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                    <div>
                        <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Telefone / Celular *</label>
                        <div className="relative">
                            <Phone className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" size={14} />
                            <input 
                                value={clientData.telefone}
                                onChange={e => setClientData({...clientData, telefone: e.target.value})}
                                disabled={!clientData.isNew}
                                className="w-full pl-9 pr-3 py-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500 disabled:bg-neutral-100"
                                placeholder="(00) 00000-0000"
                            />
                        </div>
                    </div>
                    
                    {/* Endereço Simplificado */}
                    <div className="pt-2 border-t border-neutral-200">
                        <div className="flex items-center gap-1 mb-2">
                             <MapPin size={14} className="text-neutral-400" />
                             <span className="text-[10px] font-black text-neutral-400 uppercase">Endereço</span>
                        </div>
                        <div className="grid grid-cols-3 gap-2 mb-2">
                             <input placeholder="CEP" className="col-span-1 p-2 border rounded-lg text-sm" value={clientData.cep} onChange={e => setClientData({...clientData, cep: e.target.value})} disabled={!clientData.isNew}/>
                             <input placeholder="Cidade" className="col-span-2 p-2 border rounded-lg text-sm" value={clientData.cidade} onChange={e => setClientData({...clientData, cidade: e.target.value})} disabled={!clientData.isNew}/>
                        </div>
                         <div className="grid grid-cols-4 gap-2">
                             <input placeholder="Logradouro" className="col-span-3 p-2 border rounded-lg text-sm" value={clientData.logradouro} onChange={e => setClientData({...clientData, logradouro: e.target.value})} disabled={!clientData.isNew}/>
                             <input placeholder="Nº" className="col-span-1 p-2 border rounded-lg text-sm" value={clientData.numero} onChange={e => setClientData({...clientData, numero: e.target.value})} disabled={!clientData.isNew}/>
                        </div>
                    </div>
                </div>

                {/* SECTION: VEÍCULO */}
                <div className="p-4 bg-neutral-50 rounded-2xl border border-neutral-100 space-y-4">
                    <div className="flex items-center gap-2 text-primary-600 mb-2">
                        <Car size={20} />
                        <h3 className="font-black text-neutral-400 uppercase tracking-widest text-xs">Dados do Veículo</h3>
                    </div>
                    
                    <div className="flex gap-3">
                        <div className="flex-1">
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Placa *</label>
                            <input 
                                value={vehicleData.placa}
                                onChange={e => setVehicleData({...vehicleData, placa: e.target.value.toUpperCase()})}
                                className="w-full p-3 rounded-xl border border-neutral-200 font-black text-neutral-800 outline-none focus:border-primary-500 uppercase"
                                placeholder="MER-0000"
                                maxLength={8}
                            />
                        </div>
                        <div className="w-24">
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Ano</label>
                            <input 
                                value={vehicleData.ano}
                                onChange={e => setVehicleData({...vehicleData, ano: e.target.value})}
                                className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500 text-center"
                                placeholder="2024"
                            />
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                         <div>
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Marca *</label>
                            <input 
                                value={vehicleData.marca}
                                onChange={e => setVehicleData({...vehicleData, marca: e.target.value})}
                                className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500"
                                placeholder="Ex: VW"
                            />
                        </div>
                         <div>
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Modelo *</label>
                            <input 
                                value={vehicleData.modelo}
                                onChange={e => setVehicleData({...vehicleData, modelo: e.target.value})}
                                className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500"
                                placeholder="Ex: Gol"
                            />
                        </div>
                    </div>
                     <div className="grid grid-cols-2 gap-3">
                         <div>
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Cor</label>
                            <input 
                                value={vehicleData.cor}
                                onChange={e => setVehicleData({...vehicleData, cor: e.target.value})}
                                className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500"
                                placeholder="Ex: Branco"
                            />
                        </div>
                         <div>
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Combustível *</label>
                            <select 
                                value={vehicleData.combustivel}
                                onChange={e => setVehicleData({...vehicleData, combustivel: e.target.value})}
                                className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500 bg-white"
                            >
                                <option value="FLEX">Flex</option>
                                <option value="GASOLINA">Gasolina</option>
                                <option value="ETANOL">Etanol</option>
                                <option value="DIESEL">Diesel</option>
                                <option value="GNV">GNV</option>
                                <option value="ELETRICO">Elétrico</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            {/* SECTION: OS BASICS */}
            <div className="p-4 bg-white rounded-2xl border border-neutral-200 shadow-sm grid grid-cols-1 md:grid-cols-3 gap-4">
                 <div className="col-span-1 md:col-span-3 pb-2 border-b border-neutral-100 mb-2">
                     <h3 className="font-black text-primary-600 uppercase tracking-widest text-xs flex items-center gap-2">
                         <Wrench size={16} /> Detalhes Iniciais
                     </h3>
                 </div>

                 <div>
                     <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">KM Entrada *</label>
                     <input 
                         type="number"
                         value={osData.km_entrada}
                         onChange={e => setOsData({...osData, km_entrada: e.target.value})}
                         className="w-full p-3 rounded-xl border border-neutral-200 font-black text-xl text-neutral-900 outline-none focus:border-primary-500"
                         placeholder="000000"
                     />
                 </div>
                 <div>
                     <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Mecânico *</label>
                     <select 
                        value={osData.id_funcionario}
                        onChange={e => setOsData({...osData, id_funcionario: e.target.value})}
                        className="w-full p-3 rounded-xl border border-neutral-200 font-bold text-neutral-800 outline-none focus:border-primary-500 bg-white"
                     >
                         <option value="">Selecione...</option>
                         {employees.map(e => (
                             <option key={e.id_funcionario} value={e.id_funcionario}>
                                 {e.pessoa_fisica?.pessoa?.nome || 'Func'}
                             </option>
                         ))}
                     </select>
                 </div>
                 <div>
                     <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Defeito (Opcional)</label>
                     <input 
                         value={osData.defeito}
                         onChange={e => setOsData({...osData, defeito: e.target.value})}
                         className="w-full p-3 rounded-xl border border-neutral-200 font-medium text-neutral-800 outline-none focus:border-primary-500"
                         placeholder="Barulho no motor..."
                     />
                 </div>
            </div>

            {/* ACTIONS */}
            <div className="flex gap-4 pt-4">
                <Button variant="secondary" onClick={onCancel} className="flex-1 py-4 h-auto text-neutral-500">
                    Cancelar
                </Button>
                <Button variant="primary" onClick={handleSubmit} isLoading={loading} className="flex-2 w-full py-4 h-auto text-lg uppercase tracking-widest">
                    CRIAR ORDEM DE SERVIÇO <ArrowRight className="ml-2" />
                </Button>
            </div>
        </div>
    );
};



================================================================================
FILE PATH: client\src\components\forms\VeiculoForm.tsx
================================================================================
import { useState, useEffect, useRef } from 'react';
import type { FormEvent } from 'react';
import { api } from '../../services/api';
import { normalizePlate } from '../../utils/normalize';
import { Car, Search, User, Check, X, CheckCircle, AlertCircle } from 'lucide-react';

interface VeiculoFormProps {
    clientId?: number | null;
    vehicleId?: number;
    initialData?: any;
    onSuccess: (newItem: any) => void;
    onCancel: () => void;
    onCreateClient?: () => void;
}

interface ClientResult {
    id_cliente: number;
    email: string;
    telefone_1: string;
    pessoa_fisica?: {
        pessoa: { nome: string };
        cpf: string;
    };
    pessoa_juridica?: {
        razao_social: string;
        nome_fantasia: string;
        cnpj: string;
    };
}

export const VeiculoForm = ({ clientId, vehicleId, initialData, onSuccess, onCancel, onCreateClient }: VeiculoFormProps) => {
    const [loading, setLoading] = useState(false);
    const [formStatus, setFormStatus] = useState<{ type: 'success' | 'error' | null, message: string }>({ type: null, message: '' });
    
    // Client Search State
    const [clientSearchTerm, setClientSearchTerm] = useState('');
    const [clientResults, setClientResults] = useState<ClientResult[]>([]);
    const [selectedOwner, setSelectedOwner] = useState<{id: number, name: string} | null>(null);
    const [isSearchingClient, setIsSearchingClient] = useState(false);

    const firstInputRef = useRef<HTMLInputElement>(null);

    // Form States
    const [placa, setPlaca] = useState('');
    const [marca, setMarca] = useState('');
    const [modelo, setModelo] = useState('');
    const [cor, setCor] = useState('');
    const [anoModelo, setAnoModelo] = useState('');
    const [combustivel, setCombustivel] = useState('Flex');
    const [chassi, setChassi] = useState('');

    useEffect(() => {
        if (firstInputRef.current) {
            firstInputRef.current.focus();
        }
    }, [clientId, vehicleId]);

    useEffect(() => {
        if (initialData) {
            setPlaca(initialData.placa || '');
            setMarca(initialData.marca || '');
            setModelo(initialData.modelo || '');
            setCor(initialData.cor || '');
            setAnoModelo(initialData.ano_modelo || '');
            setCombustivel(initialData.combustivel || 'Flex');
            setChassi(initialData.chassi || '');
        }
    }, [initialData]);

    const [clientActiveIndex, setClientActiveIndex] = useState(-1);
    
    const handleKeyDown = (e: React.KeyboardEvent) => {
        if (e.key === 'Escape') {
            setClientResults([]);
            setClientActiveIndex(-1);
            return;
        }

        if (clientResults.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            const next = clientActiveIndex + 1 >= clientResults.length ? 0 : clientActiveIndex + 1;
            setClientActiveIndex(next);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            const prev = clientActiveIndex - 1 < 0 ? clientResults.length - 1 : clientActiveIndex - 1;
            setClientActiveIndex(prev);
        } else if (e.key === 'Enter' && clientActiveIndex !== -1) {
            e.preventDefault();
            selectClient(clientResults[clientActiveIndex]);
        }
    };

    const handleSearchClient = async (term: string) => {
        setClientSearchTerm(term);
        setClientActiveIndex(-1);
        if (term.length < 3) {
            setClientResults([]);
            return;
        }

        setIsSearchingClient(true);
        try {
            const response = await api.get(`/cliente/search?name=${term}`);
            setClientResults(response.data);
        } catch (error) {
            console.error('Erro ao buscar clientes', error);
        } finally {
            setIsSearchingClient(false);
        }
    };

    const selectClient = (client: ClientResult) => {
        const name = client.pessoa_fisica?.pessoa?.nome || 
                     client.pessoa_juridica?.nome_fantasia || 
                     client.pessoa_juridica?.razao_social || 
                     'Cliente Sem Nome';
        
        setSelectedOwner({ id: client.id_cliente, name });
        setClientResults([]);
        setClientSearchTerm('');
        setClientActiveIndex(-1);
    };

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        setFormStatus({ type: null, message: '' });
        
        const finalClientId = clientId || selectedOwner?.id;

        // For creation, clientId is required.
        if (!vehicleId && !finalClientId) {
            setFormStatus({ type: 'error', message: 'É necessário selecionar um proprietário.' });
            return;
        }

        setLoading(true);
        try {
            const payload = {
                id_cliente: finalClientId, 
                placa: normalizePlate(placa),
                marca,
                modelo,
                cor,
                ano_modelo: anoModelo,
                combustivel,
                chassi
            };

            if (vehicleId) {
                const response = await api.put(`/veiculo/${vehicleId}`, payload);
                setFormStatus({ type: 'success', message: 'Veículo atualizado com sucesso!' });
                setTimeout(() => onSuccess(response.data), 1500);
            } else {
                const response = await api.post('/veiculo', payload);
                setFormStatus({ type: 'success', message: 'Veículo cadastrado com sucesso!' });
                setTimeout(() => onSuccess(response.data), 1500);
            }
        } catch (error: any) {
            console.error(error);
            setFormStatus({ type: 'error', message: 'Erro ao salvar veículo: ' + (error.response?.data?.error || error.message) });
        } finally {
            setLoading(false);
        }
    };

    // Helper to determine if we need to show client selection
    const needsClientSelection = !vehicleId && !clientId;

    return (
        <form onSubmit={handleSubmit} className="space-y-6 text-neutral-900">
            {formStatus.type && (
                <div className={`p-4 rounded-xl flex items-center gap-3 animate-in fade-in slide-in-from-top-2 duration-300 ${formStatus.type === 'success' ? 'bg-success-50 text-success-700 border border-success-100' : 'bg-red-50 text-red-700 border border-red-100'}`}>
                    {formStatus.type === 'success' ? <CheckCircle size={20} /> : <AlertCircle size={20} />}
                    <p className="text-sm font-bold">{formStatus.message}</p>
                </div>
            )}
            
            {/* 1. Client Selection Section (Only for new vehicles where ID isn't pre-injected) */}
            {needsClientSelection && (
                <div className="space-y-3 p-4 bg-neutral-50 rounded-xl border border-neutral-200">
                    <div className="flex items-center gap-2 mb-2">
                        <User className="text-primary-600" size={20} />
                        <h3 className="font-bold text-neutral-800">Proprietário do Veículo</h3>
                    </div>

                    {!selectedOwner ? (
                        <div className="relative">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" size={18} />
                            <input
                                ref={firstInputRef}
                                type="text"
                                placeholder="Buscar cliente por nome..."
                                className="w-full pl-10 pr-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-200 outline-none font-bold"
                                value={clientSearchTerm}
                                onChange={(e) => handleSearchClient(e.target.value)}
                                onKeyDown={handleKeyDown}
                            />
                            
                            {/* Results Dropdown */}
                            {clientResults.length > 0 && (
                                <div className="absolute z-10 w-full mt-1 bg-white border border-neutral-200 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                    {clientResults.map((client, idx) => {
                                         const name = client.pessoa_fisica?.pessoa?.nome || client.pessoa_juridica?.nome_fantasia || client.pessoa_juridica?.razao_social;
                                         const contact = client.telefone_1 || client.email || 'Sem Contato';
                                         return (
                                            <button
                                                key={client.id_cliente}
                                                type="button"
                                                onClick={() => selectClient(client)}
                                                className={`w-full text-left p-3 hover:bg-primary-50 transition-colors border-b border-neutral-100 last:border-0 ${idx === clientActiveIndex ? 'bg-primary-100' : ''}`}
                                            >
                                                <div className="font-bold text-sm text-neutral-800">{name}</div>
                                                <div className="text-xs text-neutral-500">{contact}</div>
                                            </button>
                                         );
                                    })}
                                </div>
                            )}
                            {clientSearchTerm.length > 2 && clientResults.length === 0 && !isSearchingClient && (
                                <div className="mt-2 text-center">
                                    <p className="text-xs text-neutral-500 mb-2">Nenhum cliente encontrado.</p>
                                    {onCreateClient && (
                                        <button 
                                            type="button" 
                                            onClick={onCreateClient}
                                            className="text-sm text-primary-600 font-bold hover:underline"
                                        >
                                            + Cadastrar Novo Cliente
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="flex items-center justify-between bg-primary-50 p-3 rounded-lg border border-primary-100">
                            <div className="flex items-center gap-3">
                                <div className="bg-primary-600 text-white p-2 rounded-full">
                                    <Check size={16} />
                                </div>
                                <div>
                                    <p className="text-xs text-primary-600 font-bold uppercase">Cliente Selecionado</p>
                                    <p className="font-bold text-primary-900">{selectedOwner.name}</p>
                                </div>
                            </div>
                            <button 
                                type="button"
                                onClick={() => setSelectedOwner(null)}
                                className="p-2 text-primary-600 hover:bg-primary-100 rounded-lg transition-colors"
                                title="Alterar Cliente"
                            >
                                <X size={18} />
                            </button>
                        </div>
                    )}
                </div>
            )}

            {/* 2. Vehicle Info Section */}
            <div className="space-y-4">
                <div className="bg-primary-50 p-4 rounded-lg flex items-center gap-3">
                    <Car className="text-primary-600" size={24} />
                    <div>
                        <h3 className="font-bold text-primary-900">Dados do Veículo</h3>
                        <p className="text-xs text-primary-700">Preencha as informações do veículo.</p>
                    </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Placa *</label>
                        <input 
                            ref={needsClientSelection ? null : firstInputRef}
                            value={placa} 
                            onChange={e => setPlaca(e.target.value.toUpperCase())} 
                            maxLength={7}
                            className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300 font-mono tracking-wider font-bold placeholder:text-neutral-300"
                            placeholder="ABC1234"
                            required 
                        />
                    </div>
                    <div>
                         <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Marca *</label>
                         <input value={marca} onChange={e => setMarca(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300 font-bold" required />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Modelo *</label>
                        <input value={modelo} onChange={e => setModelo(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300 font-bold" required />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Cor *</label>
                        <input value={cor} onChange={e => setCor(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300 font-bold" required />
                    </div>
                     <div>
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Ano Modelo (YYYY)</label>
                        <input type="number" value={anoModelo} onChange={e => setAnoModelo(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300 font-bold" />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Combustível</label>
                         <select value={combustivel} onChange={e => setCombustivel(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300 font-bold">
                            <option value="Flex">Flex</option>
                            <option value="Gasolina">Gasolina</option>
                            <option value="Etanol">Etanol</option>
                            <option value="Diesel">Diesel</option>
                            <option value="GNV">GNV</option>
                            <option value="Elétrico">Elétrico</option>
                         </select>
                    </div>
                    <div className="col-span-2">
                        <label className="block text-xs font-bold text-neutral-600 uppercase mb-1">Chassi</label>
                        <input value={chassi} onChange={e => setChassi(e.target.value)} className="w-full border p-2 rounded focus:ring-2 focus:ring-primary-100 outline-none border-neutral-300 font-mono font-bold" />
                    </div>
                </div>
            </div>

            <div className="flex gap-2 pt-4 border-t border-neutral-100">
                <button type="button" onClick={onCancel} className="flex-1 py-3 text-neutral-600 font-bold hover:bg-neutral-100 rounded-lg transition-colors">
                    Cancelar
                </button>
                <button 
                    type="submit" 
                    disabled={loading || (!clientId && !selectedOwner && !vehicleId)}
                    className="flex-1 py-3 bg-primary-600 text-white font-black rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-lg shadow-primary-500/30"
                >
                    {loading ? 'Salvando...' : (vehicleId ? 'Salvar Alterações' : 'Salvar Veículo')}
                </button>
            </div>
        </form>
    );
};



================================================================================
FILE PATH: client\src\components\layouts\MainLayout.tsx
================================================================================
import { Outlet } from 'react-router-dom';
import { Sidebar } from '../Sidebar';

export function MainLayout() {
  return (
    <div className="flex bg-background min-h-screen">
      <Sidebar />
      <main className="flex-1 ml-64 p-8 overflow-y-auto">
        <div className="max-w-7xl mx-auto">
          {/* Breadcrumbs ou Header Global poderiam entrar aqui */}
          <Outlet />
        </div>
      </main>
    </div>
  );
}


================================================================================
FILE PATH: client\src\components\os\LaborManager.tsx
================================================================================

import React, { useState, useEffect } from 'react';
import { Wrench, Plus, Check, X, Trash2 } from 'lucide-react';
import { api } from '../../services/api';
import type { FormEvent } from 'react';

// Tipagem básica para garantir o funcionamento
interface LaborService {
    id_servico_mao_de_obra?: number;
    id_temporary?: string; // Para modo draft
    id_funcionario: number | string;
    valor: number | string;
    descricao?: string;
    funcionario?: {
        pessoa_fisica?: {
            pessoa?: {
                nome: string;
            }
        }
    }
}

interface LaborManagerProps {
    osId?: number;
    mode: 'api' | 'draft';
    initialData?: LaborService[]; // Para carregar dados ou estado inicial
    onChange?: (services: LaborService[]) => void; // Para retornar dados no modo draft
    employees: any[];
    readOnly?: boolean;
    onTotalChange?: (total: number) => void;
}

export const LaborManager: React.FC<LaborManagerProps> = ({ 
    osId, 
    mode, 
    initialData = [], 
    onChange, 
    employees, 
    readOnly = false,
    onTotalChange
}) => {
    const [laborServices, setLaborServices] = useState<LaborService[]>(initialData);
    const [newLaborService, setNewLaborService] = useState({ id_funcionario: '', valor: '', descricao: '' });
    const [editingLaborId, setEditingLaborId] = useState<number | string | null>(null);
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });

    // Sincroniza com dados externos se mudarem
    useEffect(() => {
        if (initialData) {
            setLaborServices(initialData);
        }
    }, [initialData]);

    // Recalcula total sempre que laborServices mudar
    useEffect(() => {
        const total = laborServices.reduce((acc, svc) => acc + Number(svc.valor), 0);
        if (onTotalChange) onTotalChange(total);
    }, [laborServices, onTotalChange]);

    const handleAddLabor = async (e?: FormEvent) => {
        if (e) e.preventDefault();
        
        const val = Number(newLaborService.valor);
        if (isNaN(val) || val < 0) {
             setStatusMsg({ type: 'error', text: 'Valor inválido.' });
             return;
        }
        if (!newLaborService.id_funcionario) {
            setStatusMsg({ type: 'error', text: 'Selecione um funcionário.' });
            return;
        }

        const employee = employees.find(emp => String(emp.id_funcionario) === String(newLaborService.id_funcionario));
        
        const newItem: LaborService = {
            id_funcionario: newLaborService.id_funcionario,
            valor: val,
            descricao: newLaborService.descricao,
            funcionario: employee
        };

        if (mode === 'api') {
            if (!osId) return;
            try {
                if (editingLaborId) {
                    const payload = {
                        id_funcionario: newItem.id_funcionario,
                        valor: newItem.valor,
                        descricao: newItem.descricao
                    };
                    await api.put(`/servico-mao-de-obra/${editingLaborId}`, payload);
                    setStatusMsg({ type: 'success', text: 'Mão de obra atualizada!' });
                } else {
                    const payload = {
                        id_os: osId,
                        id_funcionario: newItem.id_funcionario,
                        valor: newItem.valor,
                        descricao: newItem.descricao
                    };
                    await api.post('/servico-mao-de-obra', payload);
                    setStatusMsg({ type: 'success', text: 'Mão de obra adicionada!' });
                }
                
                if (onChange) onChange([]); // Trigger reload request
                
                // Reset form
                setNewLaborService({ id_funcionario: '', valor: '', descricao: '' });
                setEditingLaborId(null);
                setTimeout(() => setStatusMsg({ type: null, text: '' }), 1500);
            } catch (error) {
                setStatusMsg({ type: 'error', text: 'Erro ao salvar mão de obra.' });
            }
        } else {
            // DRAFT MODE
            if (editingLaborId) {
                const updatedList = laborServices.map(item => 
                    (item.id_temporary === editingLaborId || item.id_servico_mao_de_obra === editingLaborId) 
                    ? { ...item, ...newItem } 
                    : item
                );
                setLaborServices(updatedList);
                if (onChange) onChange(updatedList);
            } else {
                const newItemWithId = { ...newItem, id_temporary: Date.now().toString() };
                const newList = [...laborServices, newItemWithId];
                setLaborServices(newList);
                if (onChange) onChange(newList);
            }
            setNewLaborService({ id_funcionario: '', valor: '', descricao: '' });
            setEditingLaborId(null);
        }
    };

    const handleEditLabor = (service: LaborService) => {
        setNewLaborService({
            id_funcionario: String(service.id_funcionario),
            valor: String(service.valor),
            descricao: service.descricao || ''
        });
        // Important: Store the correct ID depending on mode/existence
        const idToEdit = service.id_servico_mao_de_obra || service.id_temporary;
        setEditingLaborId(idToEdit || null);
    };

    const handleDeleteLabor = async (id: number | string) => {
        if (mode === 'api') {
            // In API mode, we expect a real numeric ID
            if (!id || typeof id !== 'number') return; 
            try {
                await api.delete(`/servico-mao-de-obra/${id}`);
                setStatusMsg({ type: 'success', text: 'Removido!' });
                if (onChange) onChange([]); // Trigger parent reload
                setTimeout(() => setStatusMsg({ type: null, text: '' }), 1500);
            } catch (error) {
                setStatusMsg({ type: 'error', text: 'Erro ao remover.' });
            }
        } else {
            // In Draft mode, filter by whatever ID we have
            const newList = laborServices.filter(s => (s.id_temporary !== id && s.id_servico_mao_de_obra !== id));
            setLaborServices(newList);
            if (onChange) onChange(newList);
        }
    };

    return (
        <div className="space-y-4">
             {statusMsg.text && (
                 <div className={`text-xs font-bold p-2 rounded-lg text-center ${statusMsg.type === 'error' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>
                     {statusMsg.text}
                 </div>
             )}
             
             {!readOnly && (
                <div className="p-4 bg-primary-50 rounded-2xl border border-primary-100 grid grid-cols-12 gap-3 items-end">
                    <div className="col-span-12 md:col-span-5">
                        <label className="text-[10px] font-black text-primary-400 uppercase mb-1 block">Profissional / Mecânico</label>
                        <select 
                            value={newLaborService.id_funcionario}
                            onChange={e => setNewLaborService({...newLaborService, id_funcionario: e.target.value})}
                            className="w-full p-3 rounded-xl border border-primary-200 outline-none focus:border-primary-500 font-bold text-sm bg-white"
                        >
                            <option value="">Selecione...</option>
                            {employees.map(emp => (
                                <option key={emp.id_funcionario} value={emp.id_funcionario}>
                                    {emp.pessoa_fisica?.pessoa?.nome} ({emp.cargo})
                                </option>
                            ))}
                        </select>
                    </div>
                    <div className="col-span-12 md:col-span-4">
                         <label className="text-[10px] font-black text-primary-400 uppercase mb-1 block">Descrição (Opcional)</label>
                         <input 
                            value={newLaborService.descricao}
                            onChange={e => setNewLaborService({...newLaborService, descricao: e.target.value})}
                            placeholder="Ex: Troca de óleo..."
                            className="w-full p-3 rounded-xl border border-primary-200 outline-none focus:border-primary-500 font-bold text-sm bg-white"
                         />
                    </div>
                    <div className="col-span-12 md:col-span-2">
                        <label className="text-[10px] font-black text-primary-400 uppercase mb-1 block">Valor (R$)</label>
                        <input 
                            type="number" step="0.01"
                            value={newLaborService.valor}
                            onChange={e => setNewLaborService({...newLaborService, valor: e.target.value})}
                            placeholder="0.00"
                            className="w-full p-3 rounded-xl border border-primary-200 outline-none focus:border-primary-500 font-black text-sm bg-white"
                        />
                    </div>
                    <div className="col-span-12 md:col-span-1 flex gap-1">
                        <button 
                            type="button"
                            onClick={handleAddLabor} 
                            disabled={!newLaborService.id_funcionario || !newLaborService.valor}
                            className={`w-full h-[46px] rounded-xl flex items-center justify-center transition-colors shadow-lg ${editingLaborId ? 'bg-amber-500 hover:bg-amber-600' : 'bg-primary-600 hover:bg-primary-700'} text-white disabled:opacity-50`}
                        >
                            {editingLaborId ? <Check size={20} strokeWidth={3} /> : <Plus size={20} strokeWidth={3} />}
                        </button>
                        {editingLaborId && (
                            <button 
                                type="button"
                                onClick={() => {
                                    setNewLaborService({ id_funcionario: '', valor: '', descricao: '' });
                                    setEditingLaborId(null);
                                }}
                                className="h-[46px] w-[46px] bg-neutral-200 text-neutral-500 hover:bg-neutral-300 rounded-xl flex items-center justify-center transition-colors"
                            >
                                <X size={20} />
                            </button>
                        )}
                    </div>
                </div>
            )}

            {/* Lista Mão de Obra */}
            <div className="bg-white border border-neutral-100 rounded-2xl overflow-hidden shadow-sm">
                {laborServices.length === 0 ? (
                    <div className="p-6 text-center text-neutral-400 text-xs italic">Nenhum serviço de mão de obra lançado.</div>
                ) : (
                    <table className="w-full text-xs text-left">
                         <thead className="bg-neutral-50 border-b border-neutral-100">
                            <tr>
                                <th className="p-3 font-black text-neutral-400 uppercase text-[9px] tracking-widest">Profissional</th>
                                <th className="p-3 font-black text-neutral-400 uppercase text-[9px] tracking-widest">Descrição</th>
                                <th className="p-3 font-black text-neutral-400 uppercase text-[9px] tracking-widest text-right">Valor</th>
                                <th className="p-3 text-center"></th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-neutral-50">
                            {laborServices.map(svc => (
                                <tr key={svc.id_servico_mao_de_obra || svc.id_temporary}>
                                    <td className="p-3 font-bold text-neutral-700">
                                        {svc.funcionario?.pessoa_fisica?.pessoa?.nome || employees.find(e => String(e.id_funcionario) === String(svc.id_funcionario))?.pessoa_fisica?.pessoa?.nome || 'Mecânico'}
                                    </td>
                                    <td className="p-3 text-neutral-600">{svc.descricao || '-'}</td>
                                    <td className="p-3 text-right font-black text-neutral-900">R$ {Number(svc.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                                    <td className="p-3 text-center">
                                        {!readOnly && (
                                            <div className="flex items-center justify-center gap-2">
                                                <button type="button" onClick={() => handleEditLabor(svc)} className="text-neutral-400 hover:text-amber-500 transition-colors" title="Editar">
                                                    <Wrench size={14} />
                                                </button>
                                                <button type="button" onClick={() => handleDeleteLabor(svc.id_servico_mao_de_obra || svc.id_temporary!)} className="text-neutral-400 hover:text-red-500 transition-colors" title="Remover">
                                                    <Trash2 size={14} />
                                                </button>
                                            </div>
                                        )}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                )}
            </div>
        </div>
    );
};



================================================================================
FILE PATH: client\src\components\os\OrdemDeServicoNova.tsx
================================================================================

import React, { useState, useEffect } from 'react';
import { Search, Plus, Car, User, AlertTriangle, ArrowRight, Loader2 } from 'lucide-react';
import { api } from '../../services/api';
import { UnifiedOsForm } from '../forms/UnifiedOsForm';
import { Modal } from '../ui/Modal';
import { Button } from '../ui/Button';

interface OrdemDeServicoNovaProps {
    employees: any[];
    onSuccess: (osId: number) => void;
}

export const OrdemDeServicoNova: React.FC<OrdemDeServicoNovaProps> = ({ employees, onSuccess }) => {
    // MODE: 'search' (default) or 'create' (modal)
    const [searchQuery, setSearchQuery] = useState('');
    const [results, setResults] = useState<{ vehicles: any[], clients: any[] }>({ vehicles: [], clients: [] });
    const [loadingSearch, setLoadingSearch] = useState(false);

    const [createModalOpen, setCreateModalOpen] = useState(false);
    
    // If a client is selected from search, we show their vehicles
    const [selectedClient, setSelectedClient] = useState<any | null>(null);
    const [clientVehicles, setClientVehicles] = useState<any[]>([]);

    // Confirmation Modal for "Quick Start"
    const [quickStartModal, setQuickStartModal] = useState<{ isOpen: boolean, vehicle: any, client: any }>({ isOpen: false, vehicle: null, client: null });
    const [quickStartData, setQuickStartData] = useState({ km: '', mechanic: '', defect: '' });
    const [quickLoading, setQuickLoading] = useState(false);

    // --- SEARCH LOGIC ---
    useEffect(() => {
        const timer = setTimeout(() => {
            if (searchQuery.length >= 2) {
                performSearch(searchQuery);
            } else {
                setResults({ vehicles: [], clients: [] });
                setSelectedClient(null);
            }
        }, 300); // Fast debounce
        return () => clearTimeout(timer);
    }, [searchQuery]);

    const performSearch = async (q: string) => {
        setLoadingSearch(true);
        try {
            const [vRes, cRes] = await Promise.all([
                api.get(`/veiculo/search?q=${q}`),
                api.get(`/cliente/search?q=${q}`)
            ]);
            setResults({
                vehicles: vRes.data || [],
                clients: cRes.data || []
            });
        } catch (e) { console.error(e); }
        finally { setLoadingSearch(false); }
    };

    const handleSelectVehicle = (v: any) => {
        // Find client info if not populated (search vehicle endpoint usually populates, let's assume it does or we fetch)
        // vehicle search usually returns client relation.
         if (v.cliente) {
             setQuickStartModal({ isOpen: true, vehicle: v, client: v.cliente });
         } else {
             // Fetch client if missing? Assuming robust backend response for now.
             // If missing client, we can't really start OS easily. 
             console.error("Vehicle has no client data", v);
         }
    };

    const handleSelectClient = async (c: any) => {
        setSelectedClient(c);
        // Fetch vehicles for this client specifically if not already present or if we want to be sure
        // Ideally we search vehicles by client ID.
        try {
            const res = await api.get('/veiculo'); // Filtering client side as fallback or specific endpoint
            const myVehicles = res.data.filter((v: any) => v.id_cliente === c.id_cliente);
            setClientVehicles(myVehicles);
        } catch(e) { console.error(e); }
    };

    const handleQuickCreate = async () => {
        if (!quickStartData.km || !quickStartData.mechanic) return;
        setQuickLoading(true);
        try {
            const payload = {
                id_veiculo: quickStartModal.vehicle.id_veiculo,
                id_cliente: quickStartModal.client.id_cliente,
                id_funcionario: Number(quickStartData.mechanic),
                km_entrada: Number(quickStartData.km),
                defeito_relatado: quickStartData.defect,
                status: 'ABERTA',
                dt_abertura: new Date().toISOString(),
                valor_total_cliente: 0,
                valor_mao_de_obra: 0,
                parcelas: 1
            };
            const res = await api.post('/ordem-de-servico', payload);
            setQuickStartModal({ isOpen: false, vehicle: null, client: null });
            onSuccess(res.data.id_os);
        } catch (e) {
            console.error(e);
            alert('Erro ao criar OS.');
        } finally {
            setQuickLoading(false);
        }
    };

    const handleNewVehicleForSelectedClient = () => {
        // Open Unified Form but pre-fill client
        setCreateModalOpen(true);
        // The UnifiedForm should handle "InitialClient" prop.
    };

    return (
        <div className="max-w-4xl mx-auto py-10 px-4">
            
            {/* BIG SEARCH BAR */}
            <div className="relative mb-8">
                <div className="flex gap-2">
                    <div className="relative flex-1 group">
                        <Search className="absolute left-6 top-1/2 -translate-y-1/2 text-neutral-400 group-focus-within:text-primary-500 transition-colors" size={24} />
                        <input 
                            value={searchQuery}
                            onChange={e => setSearchQuery(e.target.value)}
                            className="w-full h-[72px] pl-16 pr-6 rounded-2xl bg-white border-2 border-neutral-100 shadow-xl shadow-neutral-100/50 text-2xl font-black text-neutral-800 placeholder:text-neutral-300 outline-none focus:border-primary-500 transition-all"
                            placeholder="Busque por Placa, Cliente ou Modelo..."
                            autoFocus
                        />
                         {loadingSearch && <div className="absolute right-6 top-1/2 -translate-y-1/2"><Loader2 className="animate-spin text-primary-500" /></div>}
                    </div>
                    
                    <button 
                        onClick={() => { setSelectedClient(null); setCreateModalOpen(true); }}
                        className="h-[72px] px-8 bg-primary-600 hover:bg-primary-700 text-white rounded-2xl font-black text-lg flex items-center gap-2 shadow-lg shadow-primary-500/30 transition-all active:scale-95"
                    >
                        <Plus strokeWidth={3} /> <span className="hidden md:inline">CRIAR NOVO</span>
                    </button>
                </div>
            </div>

            {/* RESULTS AREA */}
            <div className="space-y-6">
                {selectedClient && (
                    <div className="bg-primary-50 border border-primary-100 p-6 rounded-2xl animate-in fade-in slide-in-from-top-4">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <p className="text-xs font-black text-primary-400 uppercase tracking-widest">Cliente Selecionado</p>
                                <h3 className="text-2xl font-black text-primary-900">{selectedClient.pessoa_fisica?.pessoa?.nome || selectedClient.pessoa_juridica?.razao_social}</h3>
                                <p className="text-primary-700 font-bold">{selectedClient.telefone_1 || 'Sem telefone'}</p>
                            </div>
                            <button onClick={() => setSelectedClient(null)} className="text-primary-400 hover:text-primary-700 font-bold text-sm">Trocar</button>
                        </div>
                        
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                            {clientVehicles.map(v => (
                                <button 
                                    key={v.id_veiculo}
                                    onClick={() => handleSelectVehicle({...v, cliente: selectedClient})} // Inject client to be safe
                                    className="p-4 bg-white rounded-xl border border-primary-200 text-left hover:border-primary-500 hover:shadow-md transition-all group"
                                >
                                    <p className="font-black text-lg text-neutral-800 group-hover:text-primary-600">{v.placa}</p>
                                    <p className="text-sm font-bold text-neutral-500">{v.modelo} • {v.cor}</p>
                                    <div className="mt-2 text-xs font-bold text-primary-600 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        Abrir OS <ArrowRight size={12} />
                                    </div>
                                </button>
                            ))}
                            <button 
                                onClick={handleNewVehicleForSelectedClient}
                                className="p-4 bg-white/50 border-2 border-dashed border-primary-300 rounded-xl text-primary-600 font-bold flex flex-col items-center justify-center gap-2 hover:bg-white hover:border-solid hover:shadow-md transition-all"
                            >
                                <Plus size={24} /> Novo Veículo
                            </button>
                        </div>
                    </div>
                )}

                {/* SEARCH RESULTS LIST */}
                {!selectedClient && (results.vehicles.length > 0 || results.clients.length > 0) && (
                   <div className="bg-white rounded-2xl border border-neutral-100 shadow-sm overflow-hidden animate-in fade-in">
                       {/* VEHICLES RESULTS */}
                       {results.vehicles.map(v => (
                           <button 
                                key={`v-${v.id_veiculo}`} 
                                onClick={() => handleSelectVehicle(v)}
                                className="w-full text-left p-6 border-b border-neutral-50 hover:bg-neutral-50 transition-colors flex items-center justify-between group"
                           >
                                <div className="flex items-center gap-4">
                                    <div className="h-12 w-12 rounded-full bg-neutral-100 text-neutral-500 flex items-center justify-center group-hover:bg-primary-100 group-hover:text-primary-600 transition-colors">
                                        <Car size={24} />
                                    </div>
                                    <div>
                                        <h4 className="font-black text-xl text-neutral-800">{v.placa}</h4>
                                        <p className="text-sm font-bold text-neutral-500">{v.modelo} • {v.cor}</p>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <p className="text-xs font-bold text-neutral-400 uppercase">Proprietário</p>
                                    <p className="font-bold text-neutral-700">{v.cliente?.pessoa_fisica?.pessoa?.nome || v.cliente?.pessoa_juridica?.razao_social || 'Desconhecido'}</p>
                                </div>
                           </button>
                       ))}

                       {/* CLIENTS RESULTS */}
                       {results.clients.map(c => (
                            <button 
                                key={`c-${c.id_cliente}`} 
                                onClick={() => handleSelectClient(c)}
                                className="w-full text-left p-6 border-b border-neutral-50 hover:bg-neutral-50 transition-colors flex items-center justify-between group"
                            >
                                <div className="flex items-center gap-4">
                                    <div className="h-12 w-12 rounded-full bg-neutral-100 text-neutral-500 flex items-center justify-center group-hover:bg-primary-100 group-hover:text-primary-600 transition-colors">
                                        <User size={24} />
                                    </div>
                                    <div>
                                        <h4 className="font-black text-xl text-neutral-800">{c.pessoa_fisica?.pessoa?.nome || c.pessoa_juridica?.razao_social}</h4>
                                        <p className="text-sm font-bold text-neutral-500">{c.telefone_1 || 'Sem telefone'}</p>
                                    </div>
                                </div>
                                <div className="px-4 py-2 rounded-lg bg-neutral-100 text-xs font-bold text-neutral-500 group-hover:bg-white group-hover:text-primary-600 transition-colors">
                                    Ver Veículos
                                </div>
                            </button>
                       ))}
                   </div>
                )}
                
                {searchQuery.length > 2 && !selectedClient && results.vehicles.length === 0 && results.clients.length === 0 && !loadingSearch && (
                    <div className="text-center py-10 opacity-50">
                        <AlertTriangle className="mx-auto mb-2 text-neutral-400" size={48} />
                        <p className="font-bold text-neutral-500">Nenhum resultado encontrado.</p>
                        <p className="text-sm">Tente buscar por outro termo ou clique em "Criar Novo".</p>
                    </div>
                )}

                {!searchQuery && !selectedClient && (
                    <div className="text-center py-12">
                         <div className="inline-block p-4 bg-primary-50 rounded-full text-primary-300 mb-4">
                             <Search size={48} />
                         </div>
                         <h2 className="text-xl font-black text-neutral-900 mb-2">Comece a digitar...</h2>
                         <p className="text-neutral-500 max-w-sm mx-auto">Busque rapidamente por placa ou nome para iniciar um atendimento.</p>
                    </div>
                )}
            </div>

            {/* MODAL: UNIFIED FORM */}
            {createModalOpen && (
                <Modal title="Novo Cadastro" onClose={() => setCreateModalOpen(false)}>
                    <UnifiedOsForm 
                        employees={employees} 
                        initialClient={selectedClient}
                        onCancel={() => setCreateModalOpen(false)}
                        onSuccess={(id) => { setCreateModalOpen(false); onSuccess(id); }}
                    />
                </Modal>
            )}

            {/* MODAL: QUICK START OS (KM/MECH Input) */}
            {quickStartModal.isOpen && (
                <Modal title="Iniciar Serviço" onClose={() => setQuickStartModal({ isOpen: false, vehicle: null, client: null })}>
                    <div className="space-y-6">
                        <div className="bg-primary-50 p-4 rounded-xl border border-primary-100">
                             <p className="text-xs font-black text-primary-400 uppercase">Veículo</p>
                             <p className="text-lg font-black text-primary-900">{quickStartModal.vehicle?.placa} - {quickStartModal.vehicle?.modelo}</p>
                             <p className="text-sm font-bold text-primary-700">{quickStartModal.client?.pessoa_fisica?.pessoa?.nome || quickStartModal.client?.pessoa_juridica?.razao_social}</p>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">KM Entrada *</label>
                                <input 
                                    type="number"
                                    autoFocus
                                    value={quickStartData.km}
                                    onChange={e => setQuickStartData({...quickStartData, km: e.target.value})}
                                    className="w-full p-3 rounded-xl border border-neutral-300 font-black text-xl text-neutral-900 outline-none focus:border-primary-500"
                                    placeholder="000000"
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Mecânico *</label>
                                <select 
                                    value={quickStartData.mechanic}
                                    onChange={e => setQuickStartData({...quickStartData, mechanic: e.target.value})}
                                    className="w-full p-3 rounded-xl border border-neutral-300 font-bold text-neutral-800 outline-none focus:border-primary-500"
                                >
                                    <option value="">Selecione...</option>
                                    {employees.map(e => (
                                        <option key={e.id_funcionario} value={e.id_funcionario}>
                                            {e.pessoa_fisica?.pessoa?.nome}
                                        </option>
                                    ))}
                                </select>
                            </div>
                        </div>

                         <div>
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Defeito Relatado (Opcional)</label>
                            <input 
                                value={quickStartData.defect}
                                onChange={e => setQuickStartData({...quickStartData, defect: e.target.value})}
                                className="w-full p-3 rounded-xl border border-neutral-300 font-medium text-neutral-800 outline-none focus:border-primary-500"
                            />
                        </div>

                        <Button 
                            onClick={handleQuickCreate}
                            disabled={!quickStartData.km || !quickStartData.mechanic}
                            isLoading={quickLoading}
                            variant="primary"
                            className="w-full h-[54px] text-lg uppercase tracking-widest"
                        >
                            ABRIR OS
                        </Button>
                    </div>
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\components\ui\Button.tsx
================================================================================
import React from 'react';
import { type LucideIcon } from 'lucide-react';

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
    variant?: 'primary' | 'secondary' | 'danger' | 'ghost' | 'success' | 'dark';
    size?: 'sm' | 'md' | 'lg' | 'blocks';
    icon?: LucideIcon;
    isLoading?: boolean;
    children: React.ReactNode;
}

export const Button = ({ 
    variant = 'primary', 
    size = 'md', 
    icon: Icon, 
    isLoading = false, 
    children, 
    className = '',
    ...props 
}: ButtonProps) => {
    const baseStyles = "font-black uppercase tracking-wide rounded-xl transition-all flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";
    
    const variants = {
        primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-lg shadow-blue-200",
        secondary: "bg-gray-100 text-gray-600 hover:bg-gray-200",
        danger: "bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700",
        ghost: "bg-transparent text-gray-500 hover:text-gray-900 border border-transparent hover:border-gray-200",
        success: "bg-green-600 text-white hover:bg-green-700 shadow-lg shadow-green-200",
        dark: "bg-gray-900 text-white hover:bg-gray-800 shadow-lg shadow-gray-200"
    };

    const sizes = {
        sm: "px-3 py-1.5 text-[10px]",
        md: "px-5 py-2.5 text-xs",
        lg: "px-8 py-4 text-sm",
        blocks: "w-full py-4 text-sm"
    };

    return (
        <button 
            className={`${baseStyles} ${variants[variant]} ${sizes[size]} ${className}`}
            disabled={isLoading || props.disabled}
            {...props}
        >
            {isLoading ? (
                <>
                    <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                    Processing...
                </>
            ) : (
                <>
                    {Icon && <Icon size={size === 'sm' ? 14 : size === 'lg' ? 20 : 18} />}
                    {children}
                </>
            )}
        </button>
    );
};





================================================================================
FILE PATH: client\src\pages\CadastroUnificadoPage.tsx
================================================================================
import { useState, useEffect, useRef } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import { api } from '../services/api'; // Correct import path
import { formatNameTitleCase, normalizePlate } from '../utils/normalize'; // Correct import path
import { User, Car, CheckCircle, Save, ArrowLeft, Plus, Trash2, Edit } from 'lucide-react';

import { StatusBanner } from '../components/ui/StatusBanner'; // Correct import path
import { Modal } from '../components/ui/Modal'; // Correct import path
import { VeiculoForm } from '../components/forms/VeiculoForm'; // Correct import path
import type { FormEvent } from 'react';

// Interfaces (Simplified)
interface IVeiculo {
    id_veiculo: number;
    placa: string;
    marca: string;
    modelo: string;
    cor: string;
    ano_modelo: string;
    id_cliente: number;
}

export const CadastroUnificadoPage = () => {
    const navigate = useNavigate();
    const { clienteId } = useParams(); // For Edit Mode if route is /cadastro/:clienteId
    const isEditMode = !!clienteId;

    const [loading, setLoading] = useState(false);
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });

    // --- CLIENT STATE ---
    const [tipoPessoa, setTipoPessoa] = useState<'PF' | 'PJ'>('PF');
    const [nome, setNome] = useState('');
    const [cpf, setCpf] = useState('');
    const [razaoSocial, setRazaoSocial] = useState('');
    const [cnpj, setCnpj] = useState('');
    const [ie, setIe] = useState('');
    const [nomeFantasia, setNomeFantasia] = useState('');
    
    // Contact & Address
    const [telefone, setTelefone] = useState('');
    const [telefone2, setTelefone2] = useState('');
    const [email, setEmail] = useState('');
    const [logradouro, setLogradouro] = useState('');
    const [numero, setNumero] = useState('');
    const [complLogradouro, setComplLogradouro] = useState('');
    const [bairro, setBairro] = useState('');
    const [cidade, setCidade] = useState('São Paulo');
    const [estado, setEstado] = useState('SP');

    // --- VEHICLE STATE (Only used in Creation Mode) ---
    const [placa, setPlaca] = useState('');
    const [marca, setMarca] = useState('');
    const [modelo, setModelo] = useState('');
    const [cor, setCor] = useState('');
    const [anoModelo, setAnoModelo] = useState('');
    const [combustivel, setCombustivel] = useState('Flex');
    
    // --- VEHICLE LIST STATE (Only used in Edit Mode) ---
    const [veiculos, setVeiculos] = useState<IVeiculo[]>([]);
    const [showVehicleModal, setShowVehicleModal] = useState(false);
    const [editingVehicle, setEditingVehicle] = useState<IVeiculo | null>(null);
    const [confirmDeleteVehicle, setConfirmDeleteVehicle] = useState<number | null>(null);

    // Refs
    const nameRef = useRef<HTMLInputElement>(null);

    // Initial Load (Edit Mode)
    useEffect(() => {
        if (isEditMode) {
            loadClienteData();
        } else {
             if (nameRef.current) nameRef.current.focus();
        }
    }, [clienteId]);

    const loadClienteData = async () => {
        try {
            setLoading(true);
            const response = await api.get(`/cliente/${clienteId}`);
            const data = response.data;

            // Fill Client Data
            setTelefone(data.telefone_1 || '');
            setTelefone2(data.telefone_2 || '');
            setEmail(data.email || '');
            setLogradouro(data.logradouro || '');
            setNumero(data.nr_logradouro || '');
            setComplLogradouro(data.compl_logradouro || '');
            setBairro(data.bairro || '');
            setCidade(data.cidade || '');
            setEstado(data.estado || '');

            if (data.pessoa_fisica) {
                setTipoPessoa('PF');
                setNome(data.pessoa_fisica.pessoa?.nome || '');
                setCpf(data.pessoa_fisica.cpf || '');
            } else if (data.pessoa_juridica) {
                setTipoPessoa('PJ');
                setRazaoSocial(data.pessoa_juridica.razao_social || '');
                setNomeFantasia(data.pessoa_juridica.nome_fantasia || '');
                setCnpj(data.pessoa_juridica.cnpj || '');
                setIe(data.pessoa_juridica.inscricao_estadual || '');
            }

            // Load Vehicles
            if (data.veiculos) {
                setVeiculos(data.veiculos);
            }

        } catch (error) {
            console.error(error);
            setStatusMsg({ type: 'error', text: 'Erro ao carregar dados do cliente.' });
        } finally {
            setLoading(false);
        }
    };

    const handleSave = async (e: FormEvent) => {
        e.preventDefault();
        setLoading(true);

        try {
            // 1. Save/Update Client
            let finalClientId = clienteId ? Number(clienteId) : null;

            if (isEditMode && finalClientId) {
                // UPDATE CLIENT
                const clientePayload = {
                    telefone_1: telefone,
                    telefone_2: telefone2,
                    email,
                    logradouro,
                    nr_logradouro: numero,
                    compl_logradouro: complLogradouro,
                    bairro,
                    cidade,
                    estado
                };
                await api.put(`/cliente/${finalClientId}`, clientePayload);
                 setStatusMsg({ type: 'success', text: 'Dados atualizados com sucesso!' });
            } else {
                // CREATE CLIENT (Logic from ClienteForm)
                // A. Base Pessoa
                 const pessoaPayload = { 
                    nome: formatNameTitleCase(tipoPessoa === 'PF' ? nome : razaoSocial),
                    genero: null,
                    dt_nascimento: null,
                    obs: ''
                };
                const pessoaRes = await api.post('/pessoa', pessoaPayload);
                const idPessoa = pessoaRes.data.id_pessoa;

                // B. Specific Type
                let fkId = null;
                let fkField = '';
                 if (tipoPessoa === 'PF') {
                    const pfPayload = { id_pessoa: idPessoa, cpf: cpf ? cpf.replace(/\D/g, '') : null };
                    const pfRes = await api.post('/pessoa-fisica', pfPayload);
                    fkId = pfRes.data.id_pessoa_fisica;
                    fkField = 'id_pessoa_fisica';
                } else {
                    const pjPayload = { 
                        id_pessoa: idPessoa, 
                        razao_social: formatNameTitleCase(razaoSocial),
                        nome_fantasia: nomeFantasia ? formatNameTitleCase(nomeFantasia) : null,
                        cnpj: cnpj ? cnpj.replace(/\D/g, '') : null,
                        inscricao_estadual: ie 
                    };
                    const pjRes = await api.post('/pessoa-juridica', pjPayload);
                    fkId = pjRes.data.id_pessoa_juridica;
                    fkField = 'id_pessoa_juridica';
                }

                // C. Create Cliente
                const clientePayload = {
                    [fkField]: fkId,
                    tipo_pessoa: 1,
                    telefone_1: telefone,
                    telefone_2: telefone2,
                    email,
                    logradouro,
                    nr_logradouro: numero,
                    compl_logradouro: complLogradouro,
                    bairro,
                    cidade,
                    estado
                };
                const clienteRes = await api.post('/cliente', clientePayload);
                finalClientId = clienteRes.data.id_cliente;
            }

            // 2. Create Vehicle (Only in Creation Mode or if filled)
            let finalVehicleId = null;
            if (!isEditMode && finalClientId && (placa || modelo)) {
                 const vehiclePayload = {
                    id_cliente: finalClientId, 
                    placa: normalizePlate(placa),
                    marca,
                    modelo,
                    cor,
                    ano_modelo: anoModelo,
                    combustivel,
                    chassi: '' // Optional for quick registry
                };
                const vehicleRes = await api.post('/veiculo', vehiclePayload);
                finalVehicleId = vehicleRes.data.id_veiculo;
            }

            // 3. Redirect Logic
            // "Após salvar o novo cadastro, vai direto para o passo 3 para validação"
            // Path: /ordem-de-servico?startWizard=true&clientId=X&vehicleId=Y&step=CONFIRM
            if (!isEditMode && finalClientId) {
                setStatusMsg({ type: 'success', text: 'Cadastro realizado! Redirecionando...' });
                setTimeout(() => {
                    let url = `/ordem-de-servico?clientId=${finalClientId}`;
                    if (finalVehicleId) {
                         url += `&vehicleId=${finalVehicleId}`;
                    }
                    navigate(url);
                }, 1000);
            }

        } catch (error: any) {
            console.error(error);
            setStatusMsg({ type: 'error', text: 'Erro ao salvar cadastro: ' + (error.response?.data?.error || error.message) });
        } finally {
            setLoading(false);
        }
    };

    const handleDeleteVehicle = async (vId: number) => {
        try {
            await api.delete(`/veiculo/${vId}`);
            setVeiculos(prev => prev.filter(v => v.id_veiculo !== vId));
            setConfirmDeleteVehicle(null);
            setStatusMsg({ type: 'success', text: 'Veículo removido.' });
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao remover veículo.' });
        }
    };

    return (
        <div className="space-y-6 pb-20">
             {statusMsg.text && (
                <div className="fixed bottom-8 right-8 z-50">
                     <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({ type: null, text: '' })} />
                </div>
            )}

            {/* Header */}
            <div className="flex items-center gap-4">
                 <button onClick={() => navigate(-1)} className="p-2 hover:bg-neutral-100 rounded-lg transition-colors text-neutral-600">
                     <ArrowLeft size={24} />
                 </button>
                 <div>
                     <h1 className="text-2xl font-bold text-neutral-900">{isEditMode ? 'Editar Cadastro' : 'Novo Cadastro'}</h1>
                     <p className="text-neutral-500 text-sm">{isEditMode ? 'Atualize os dados do cliente e seus veículos.' : 'Cadastre o cliente e o veículo para abrir a OS.'}</p>
                 </div>
            </div>

            <form onSubmit={handleSave} className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                
                {/* --- LEFT COL: CLIENTE --- */}
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-2xl border border-neutral-200 shadow-sm space-y-6">
                        <div className="flex items-center gap-2 border-b border-neutral-100 pb-4">
                            <div className="bg-primary-100 p-2 rounded-lg text-primary-600">
                                <User size={20} />
                            </div>
                            <h2 className="font-bold text-lg text-neutral-900">Dados do Cliente</h2>
                        </div>

                         {/* Tipo Pessoa Switch */}
                        <div className="flex bg-neutral-100 p-1 rounded-lg w-fit">
                            <button
                                type="button"
                                onClick={() => !isEditMode && setTipoPessoa('PF')}
                                disabled={isEditMode}
                                className={`px-4 py-2 rounded-md text-xs font-bold transition-all ${tipoPessoa === 'PF' ? 'bg-white shadow text-primary-600' : 'text-neutral-500'} ${isEditMode ? 'opacity-50 cursor-not-allowed' : ''}`}
                            >
                                Pessoa Física
                            </button>
                            <button
                                type="button"
                                onClick={() => !isEditMode && setTipoPessoa('PJ')}
                                disabled={isEditMode}
                                className={`px-4 py-2 rounded-md text-xs font-bold transition-all ${tipoPessoa === 'PJ' ? 'bg-white shadow text-accent-600' : 'text-neutral-500'} ${isEditMode ? 'opacity-50 cursor-not-allowed' : ''}`}
                            >
                                Pessoa Jurídica
                            </button>
                        </div>

                         <div className="grid grid-cols-1 gap-4">
                            {tipoPessoa === 'PF' ? (
                                <>
                                    <div>
                                        <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Nome Completo *</label>
                                        <input ref={nameRef} value={nome} onChange={e => setNome(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-50 transition-all font-medium" required disabled={isEditMode} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">CPF</label>
                                        <input value={cpf} onChange={e => setCpf(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 transition-all" disabled={isEditMode} />
                                    </div>
                                </>
                            ) : (
                                <>
                                    <div>
                                        <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Razão Social *</label>
                                        <input ref={nameRef} value={razaoSocial} onChange={e => setRazaoSocial(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-accent-500 focus:ring-4 focus:ring-accent-50 transition-all font-medium" required disabled={isEditMode} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Nome Fantasia</label>
                                        <input value={nomeFantasia} onChange={e => setNomeFantasia(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-accent-500 transition-all" disabled={isEditMode} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">CNPJ</label>
                                            <input value={cnpj} onChange={e => setCnpj(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-accent-500 transition-all" disabled={isEditMode} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">IE</label>
                                            <input value={ie} onChange={e => setIe(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-accent-500 transition-all" disabled={isEditMode} />
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                         <div className="space-y-4 pt-4 border-t border-neutral-100">
                             <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Telefone Principal *</label>
                                    <input value={telefone} onChange={e => setTelefone(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 transition-all" required />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Telefone 2</label>
                                    <input value={telefone2} onChange={e => setTelefone2(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 transition-all" />
                                </div>
                             </div>
                             <div>
                                <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Email</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 transition-all" />
                            </div>
                        </div>

                        <div className="space-y-4 pt-4 border-t border-neutral-100">
                             <div className="grid grid-cols-3 gap-4">
                                <div className="col-span-2">
                                    <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Logradouro</label>
                                    <input value={logradouro} onChange={e => setLogradouro(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 transition-all" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Número</label>
                                    <input value={numero} onChange={e => setNumero(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 transition-all" />
                                </div>
                             </div>
                              <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Bairro</label>
                                    <input value={bairro} onChange={e => setBairro(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 transition-all" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Cidade</label>
                                    <input value={cidade} onChange={e => setCidade(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 transition-all" />
                                </div>
                              </div>
                        </div>
                    </div>
                </div>

                {/* --- RIGHT COL: VEÍCULO --- */}
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-2xl border border-neutral-200 shadow-sm space-y-6 h-full">
                         <div className="flex items-center justify-between border-b border-neutral-100 pb-4">
                            <div className="flex items-center gap-2">
                                <div className="bg-primary-100 p-2 rounded-lg text-primary-600">
                                    <Car size={20} />
                                </div>
                                <h2 className="font-bold text-lg text-neutral-900">{isEditMode ? 'Veículos Cadastrados' : 'Dados do Veículo'}</h2>
                            </div>
                             {isEditMode && (
                                 <button 
                                     type="button" 
                                     onClick={() => { setEditingVehicle(null); setShowVehicleModal(true); }}
                                     className="text-xs font-bold text-primary-600 bg-primary-50 px-3 py-1.5 rounded-lg hover:bg-primary-100 transition-colors flex items-center gap-1"
                                 >
                                     <Plus size={14} /> NOVO VEÍCULO
                                 </button>
                             )}
                        </div>

                        {isEditMode ? (
                            /* --- EDIT MODE: VEHICLE LIST --- */
                            <div className="space-y-3">
                                {veiculos.length > 0 ? veiculos.map(v => (
                                    <div key={v.id_veiculo} className="p-4 rounded-xl border border-neutral-200 bg-neutral-50 flex justify-between items-center group hover:border-primary-300 hover:bg-white transition-all">
                                        <div>
                                            <p className="font-bold text-neutral-900 uppercase font-mono">{v.placa}</p>
                                            <p className="text-xs font-bold text-neutral-500 uppercase">{v.marca} {v.modelo} • {v.cor}</p>
                                        </div>
                                        <div className="flex gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                             <button type="button" onClick={() => { setEditingVehicle(v); setShowVehicleModal(true); }} className="p-2 text-neutral-400 hover:text-primary-600 hover:bg-primary-50 rounded-lg"><Edit size={16} /></button>
                                             <button type="button" onClick={() => setConfirmDeleteVehicle(v.id_veiculo)} className="p-2 text-neutral-400 hover:text-red-600 hover:bg-red-50 rounded-lg"><Trash2 size={16} /></button>
                                        </div>
                                    </div>
                                )) : (
                                    <div className="text-center py-8 text-neutral-400 italic text-sm">Nenhum veículo cadastrado.</div>
                                )}
                            </div>
                        ) : (
                             /* --- CREATE MODE: VEHICLE FORM --- */
                            <div className="space-y-4">
                                <div className="p-4 bg-primary-50 rounded-xl border border-primary-100 mb-2">
                                    <p className="text-xs text-primary-700 font-medium">Preencha os dados do veículo agora para agilizar a abertura da OS.</p>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Placa *</label>
                                        <input 
                                            value={placa} 
                                            onChange={e => setPlaca(e.target.value.toUpperCase())} 
                                            maxLength={7}
                                            className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-50 transition-all font-mono font-bold tracking-wider uppercase" 
                                            placeholder="ABC1234"
                                            required={!isEditMode} // Required on creation
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Marca *</label>
                                        <input value={marca} onChange={e => setMarca(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 transition-all font-medium" required={!isEditMode && !!placa} />
                                    </div>
                                    <div className="col-span-2">
                                        <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Modelo *</label>
                                        <input value={modelo} onChange={e => setModelo(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 transition-all font-medium" required={!isEditMode && !!placa} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Cor *</label>
                                        <input value={cor} onChange={e => setCor(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 transition-all font-medium" required={!isEditMode && !!placa} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Ano</label>
                                        <input type="number" value={anoModelo} onChange={e => setAnoModelo(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 transition-all font-medium" />
                                    </div>
                                     <div className="col-span-2">
                                         <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Combustível</label>
                                         <select value={combustivel} onChange={e => setCombustivel(e.target.value)} className="w-full border p-2.5 rounded-xl outline-none focus:border-primary-500 transition-all font-medium">
                                            <option value="Flex">Flex</option>
                                            <option value="Gasolina">Gasolina</option>
                                            <option value="Etanol">Etanol</option>
                                            <option value="Diesel">Diesel</option>
                                            <option value="GNV">GNV</option>
                                         </select>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>

                {/* Footer Save Button */}
                <div className="col-span-1 lg:col-span-2 flex justify-end pt-4 border-t border-neutral-200">
                    <button 
                         type="submit" 
                         disabled={loading}
                         className="px-8 py-4 bg-primary-600 text-white font-black rounded-xl hover:bg-primary-700 hover:scale-105 transition-all shadow-xl shadow-primary-500/20 disabled:opacity-50 disabled:hover:scale-100 flex items-center gap-3 text-lg"
                    >
                        {loading ? 'Salvando...' : (
                            isEditMode ? <><Save size={24} /> SALVAR ALTERAÇÕES</> 
                                       : <><CheckCircle size={24} /> SALVAR NOVO CADASTRO</>
                        )}
                    </button>
                </div>
            </form>

            {/* MODAL EDIT VEHICLE (ONLY IN EDIT MODE) */}
            {showVehicleModal && clienteId && (
                <Modal title={editingVehicle ? "Editar Veículo" : "Novo Veículo"} onClose={() => setShowVehicleModal(false)}>
                    <VeiculoForm 
                        clientId={Number(clienteId)}
                        vehicleId={editingVehicle?.id_veiculo}
                        initialData={editingVehicle}
                        onSuccess={() => {
                            setShowVehicleModal(false);
                            loadClienteData(); // Reload to update list
                            setStatusMsg({ type: 'success', text: 'Veículo salvo com sucesso!' });
                        }}
                        onCancel={() => setShowVehicleModal(false)}
                    />
                </Modal>
            )}

            {/* CONFIRM DELETE VEHICLE */}
            {confirmDeleteVehicle && (
                 <Modal title="Excluir Veículo" onClose={() => setConfirmDeleteVehicle(null)}>
                     <div className="space-y-4">
                         <p>Tem certeza que deseja excluir este veículo?</p>
                         <div className="flex justify-end gap-2">
                             <button onClick={() => setConfirmDeleteVehicle(null)} className="px-4 py-2 font-bold text-neutral-500 hover:bg-neutral-100 rounded-lg">Cancelar</button>
                             <button onClick={() => handleDeleteVehicle(confirmDeleteVehicle)} className="px-4 py-2 font-bold text-white bg-red-600 hover:bg-red-700 rounded-lg">Excluir</button>
                         </div>
                     </div>
                 </Modal>
            )}

        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\ClientePage.tsx
================================================================================
import { useState, useEffect, useRef, Fragment } from 'react';
import { useNavigate } from 'react-router-dom';
import { api } from '../services/api';
import { Search, Plus, Trash2, Edit, MapPin, Phone, Mail, User, Wrench } from 'lucide-react';
import { VeiculoForm } from '../components/forms/VeiculoForm';
import { Modal } from '../components/ui/Modal';
import { StatusBanner } from '../components/ui/StatusBanner';

// Extended Interface for View (assuming backend returns relations)
interface IClienteView {
  id_cliente: number;
  telefone_1: string;
  telefone_2?: string;
  email?: string;
  logradouro: string;
  nr_logradouro: string;
  compl_logradouro?: string;
  bairro: string;
  cidade: string;
  estado: string;
  id_pessoa_juridica?: number | null;
  pessoa_fisica?: {
      id_pessoa_fisica: number;
      cpf?: string;
      pessoa: {
          nome: string;
      };
  };
  pessoa_juridica?: {
      id_pessoa_juridica: number;
      razao_social: string;
      nome_fantasia?: string;
      cnpj?: string;
  };
  veiculos?: Array<{
    id_veiculo: number;
    placa: string;
    marca: string;
    modelo: string;
    cor: string;
    ano_modelo: string;
    combustivel: string;
    chassi: string;
  }>;
}

export const ClientePage = () => {
  const navigate = useNavigate();
  const [clientes, setClientes] = useState<IClienteView[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');

  const [expandedRows, setExpandedRows] = useState<Set<number>>(new Set());
  const [showVehicleModal, setShowVehicleModal] = useState(false);
  const [selectedClientIdForVehicle, setSelectedClientIdForVehicle] = useState<number | null>(null);

  // New states for Vehicle CRUD and Confirmation
  const [editingVehicle, setEditingVehicle] = useState<any | null>(null);
  const [confirmModal, setConfirmModal] = useState<{ isOpen: boolean, title: string, message: string, onConfirm: () => void }>({ isOpen: false, title: '', message: '', onConfirm: () => {} });

  const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });

  useEffect(() => {
    loadClientes();
  }, []);

  const loadClientes = async () => {
    try {
      setLoading(true);
      const response = await api.get('/cliente');
      setClientes(response.data);
    } catch (error) {
      console.error(error);
      setStatusMsg({ type: 'error', text: 'Erro ao carregar clientes.' });
    } finally {
      setLoading(false);
    }
  };

  const getNome = (c: IClienteView) => {
    if (c.pessoa_fisica) return c.pessoa_fisica.pessoa.nome;
    if (c.pessoa_juridica) return c.pessoa_juridica.razao_social; // or nome_fantasia
    return 'Nome Indisponível';
  };

  const handleDelete = (id: number) => {
      setConfirmModal({
          isOpen: true,
          title: 'Excluir Cliente',
          message: 'Tem certeza que deseja excluir este cliente? Todos os vínculos serão perdidos.',
          onConfirm: async () => {
              try {
                  await api.delete(`/cliente/${id}`);
                  setStatusMsg({ type: 'success', text: 'Cliente removido com sucesso!' });
                  loadClientes();
              } catch (error) {
                  setStatusMsg({ type: 'error', text: 'Erro ao excluir cliente.' });
              }
              setConfirmModal(prev => ({ ...prev, isOpen: false }));
          }
      });
  };

  const handleDeleteVehicle = (id: number) => {
    setConfirmModal({
        isOpen: true,
        title: 'Excluir Veículo',
        message: 'Tem certeza que deseja remover este veículo do cliente?',
        onConfirm: async () => {
            try {
                await api.delete(`/veiculo/${id}`);
                setStatusMsg({ type: 'success', text: 'Veículo removido com sucesso!' });
                loadClientes();
            } catch (error) {
                setStatusMsg({ type: 'error', text: 'Erro ao deletar veículo.' });
            }
            setConfirmModal(prev => ({ ...prev, isOpen: false }));
        }
    });
  };

  const openCreateModal = () => {
      navigate('/novo-cadastro');
  };

  const openEditModal = (client: IClienteView) => {
      navigate(`/cadastro/${client.id_cliente}`);
  };

   const openEditVehicleModal = (vehicle: any, clientId: number) => {
      setEditingVehicle(vehicle);
      setSelectedClientIdForVehicle(clientId);
      setShowVehicleModal(true);
  };

  const toggleRow = (id: number) => {
    const newExpanded = new Set(expandedRows);
    if (newExpanded.has(id)) newExpanded.delete(id);
    else newExpanded.add(id);
    setExpandedRows(newExpanded);
  };

  const handleRegisterVehicle = (clientId: number) => {
    setSelectedClientIdForVehicle(clientId);
    setEditingVehicle(undefined);
    setShowVehicleModal(true);
  };

  const filteredClientes = clientes.filter(c => {
    const search = searchTerm.toLowerCase();
    const nome = getNome(c).toLowerCase();
    const email = c.email?.toLowerCase() || '';
    const cidade = (c.cidade || '').toLowerCase();
    const id = c.id_cliente.toString();
    
    return nome.includes(search) || 
           email.includes(search) || 
           cidade.includes(search) || 
           id.includes(search);
  });

  const [activeIndex, setActiveIndex] = useState(-1);
  const searchInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if (searchInputRef.current) searchInputRef.current.focus();
  }, []);

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (filteredClientes.length === 0) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      setActiveIndex(prev => (prev + 1 >= filteredClientes.length ? 0 : prev + 1));
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      setActiveIndex(prev => (prev - 1 < 0 ? filteredClientes.length - 1 : prev - 1));
    } else if (e.key === 'Enter') {
      if (activeIndex !== -1) {
        e.preventDefault();
        toggleRow(filteredClientes[activeIndex].id_cliente);
      }
    } else if (e.key === 'Escape') {
      setSearchTerm('');
      setActiveIndex(-1);
    }
  };

  useEffect(() => {
    setActiveIndex(-1);
  }, [searchTerm]);

  return (
    <div className="space-y-6">

      
      {/* Header da Página */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl font-bold text-neutral-900">Clientes</h1>
          <p className="text-neutral-500">Gerencie sua base de clientes e contatos.</p>
        </div>
        <button 
            onClick={openCreateModal}
            className="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2.5 rounded-lg font-medium transition-all shadow-sm"
        >
          <Plus size={20} />
          Novo Cliente
        </button>
      </div>

       {/* Confirm Modal */}
       {confirmModal.isOpen && (
            <Modal title={confirmModal.title} onClose={() => setConfirmModal(prev => ({...prev, isOpen: false}))}>
                <div className="space-y-6">
                    <p className="text-neutral-600">{confirmModal.message}</p>
                    <div className="flex justify-end gap-3">
                        <button 
                            onClick={() => setConfirmModal(prev => ({...prev, isOpen: false}))}
                            className="px-4 py-2 text-neutral-600 font-bold hover:bg-neutral-100 rounded-lg transition-colors"
                        >
                            Cancelar
                        </button>
                        <button 
                            onClick={confirmModal.onConfirm}
                            className="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors shadow-lg shadow-red-500/30"
                        >
                            Confirmar Exclusão
                        </button>
                    </div>
                </div>
            </Modal>
       )}

      {/* Barra de Filtros */}
      <div className="bg-surface p-4 rounded-xl shadow-sm border border-neutral-200 flex gap-4">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" size={20} />
          <input 
            ref={searchInputRef}
            type="text"
            placeholder="Buscar por nome, email ou cidade..."
            className="w-full pl-10 pr-4 py-2 border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all text-neutral-900"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            onKeyDown={handleKeyDown}
          />
        </div>
      </div>

      {/* Tabela Moderna */}
      <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden">
        {loading ? (
          <div className="p-8 text-center text-neutral-500">Carregando dados...</div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr className="bg-neutral-50 border-b border-neutral-200 text-xs uppercase tracking-wider text-neutral-500 font-semibold">
                  <th className="p-4">Cliente</th>
                  <th className="p-4">Contato</th>
                  <th className="p-4">Localização</th>
                  <th className="p-4">Tipo</th>
                  <th className="p-4 text-right">Ações</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-neutral-100">
                {filteredClientes.map((c, idx) => (
                  <Fragment key={c.id_cliente}>
                    <tr className={`transition-colors hover:bg-neutral-25 cursor-pointer ${idx === activeIndex ? 'bg-primary-50 ring-2 ring-primary-500 ring-inset' : ''}`}>
                      <td className="p-4 cursor-pointer" onClick={() => toggleRow(c.id_cliente)}>
                        <div className="flex items-center gap-3">
                          <div className={`p-2 rounded-full transition-colors ${expandedRows.has(c.id_cliente) ? 'bg-primary-600 text-white' : 'bg-primary-50 text-primary-600'}`}>
                             <User size={16} />
                          </div>
                          <div>
                              <span className="font-bold text-neutral-900 block">{getNome(c)}</span>
                              <span className="text-xs text-neutral-500 font-bold">{c.telefone_1}</span>
                          </div>
                        </div>
                      </td>
                      <td className="p-4">
                        <div className="flex flex-col gap-1">
                          {c.email && (
                              <div className="flex items-center gap-2 text-sm text-neutral-600">
                                  <Mail size={12} /> {c.email}
                              </div>
                          )}
                          <div className="flex items-center gap-2 text-sm text-neutral-600">
                             <Phone size={12} /> {c.telefone_1}
                          </div>
                        </div>
                      </td>
                      <td className="p-4">
                        <div className="flex items-center gap-2 text-sm text-neutral-600">
                          <MapPin size={14} className="text-neutral-400" />
                          {c.cidade}, {c.estado}
                        </div>
                        <span className="text-xs text-neutral-400 ml-6">{c.bairro}</span>
                      </td>
                      <td className="p-4">
                        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                          ${c.id_pessoa_juridica ? 'bg-accent-50 text-accent-600' : 'bg-primary-50 text-primary-600'}`}>
                          {c.id_pessoa_juridica ? 'Jurídica' : 'Física'}
                        </span>
                      </td>
                      <td className="p-4 text-right">
                        <div className="flex items-center justify-end gap-2">
                          <button 
                              onClick={() => handleRegisterVehicle(c.id_cliente)}
                              className="p-2 text-neutral-400 hover:text-success-600 hover:bg-success-50 rounded-lg transition-colors"
                              title="Adicionar Veículo"
                          >
                            <Plus size={18} />
                          </button>
                          <button 
                              onClick={() => openEditModal(c)}
                              className="p-2 text-neutral-400 hover:text-primary-600 hover:bg-primary-50 rounded-lg transition-colors"
                          >
                            <Edit size={18} />
                          </button>
                          <button 
                              onClick={() => handleDelete(c.id_cliente)}
                              className="p-2 text-neutral-400 hover:text-error hover:bg-red-50 rounded-lg transition-colors"
                          >
                            <Trash2 size={18} />
                          </button>
                        </div>
                      </td>
                    </tr>
                    {expandedRows.has(c.id_cliente) && (
                      <tr className="bg-neutral-50/50 animate-in fade-in slide-in-from-top-1 duration-200">
                        <td colSpan={5} className="p-4 pt-0">
                          <div className="ml-12 border-l-2 border-primary-200 pl-6 py-2 space-y-3">
                            <div className="flex items-center justify-between">
                              <h4 className="text-[10px] font-black uppercase text-neutral-400 tracking-widest">Veículos do Cliente ({c.veiculos?.length || 0})</h4>
                              <button 
                                onClick={() => handleRegisterVehicle(c.id_cliente)}
                                className="text-[10px] font-black text-primary-600 hover:underline uppercase"
                              >
                                + Adicionar Veículo
                              </button>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                              {c.veiculos?.length ? c.veiculos.map(v => (
                                <div key={v.id_veiculo} className="bg-white p-3 rounded-xl border border-neutral-200 shadow-sm flex items-center justify-between group hover:border-primary-300 transition-all">
                                  <div>
                                    <p className="text-xs font-black text-neutral-800 tracking-widest uppercase">{v.placa}</p>
                                    <p className="text-[10px] text-neutral-500 font-bold uppercase">{v.marca} {v.modelo} • {v.cor}</p>
                                  </div>
                                  <div className="flex items-center gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                      <button 
                                        onClick={() => navigate(`/ordem-de-servico?clientId=${c.id_cliente}&vehicleId=${v.id_veiculo}`)}
                                        className="p-1.5 text-neutral-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg"
                                        title="Abrir OS"
                                      >
                                          <Wrench size={14} />
                                      </button>
                                      <button 
                                        onClick={() => openEditVehicleModal(v, c.id_cliente)}
                                        className="p-1.5 text-neutral-400 hover:text-primary-600 hover:bg-primary-50 rounded-lg"
                                        title="Editar Veículo"
                                      >
                                          <Edit size={14} />
                                      </button>
                                      <button 
                                        onClick={() => handleDeleteVehicle(v.id_veiculo)}
                                        className="p-1.5 text-neutral-400 hover:text-red-600 hover:bg-red-50 rounded-lg"
                                        title="Excluir Veículo"
                                      >
                                          <Trash2 size={14} />
                                      </button>
                                  </div>
                                </div>
                              )) : (
                                <p className="text-xs text-neutral-400 italic">Nenhum veículo cadastrado.</p>
                              )}
                            </div>
                          </div>
                        </td>
                      </tr>
                    )}
                  </Fragment>
                ))}
                {filteredClientes.length === 0 && (
                  <tr>
                    <td colSpan={5} className="p-8 text-center text-neutral-400">
                      Nenhum cliente encontrado.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {showVehicleModal && selectedClientIdForVehicle && (
        <Modal title={editingVehicle ? "Editar Veículo" : "Cadastrar Veículo para Cliente"} onClose={() => setShowVehicleModal(false)}>
          <VeiculoForm 
            clientId={selectedClientIdForVehicle}
            vehicleId={editingVehicle?.id_veiculo}
            initialData={editingVehicle}
            onSuccess={() => {
              setShowVehicleModal(false);
              setEditingVehicle(null);
              loadClientes();
            }}
            onCancel={() => {
                setShowVehicleModal(false);
                setEditingVehicle(null);
            }}
          />
        </Modal>
      )}
      <div className="fixed bottom-8 right-8 z-100 min-w-[320px]">
        <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({type: null, text: ''})} />
      </div>
    </div>
  );
};


================================================================================
FILE PATH: client\src\pages\ContasAPagarPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import { StatusBanner } from '../components/ui/StatusBanner';
import { Modal } from '../components/ui/Modal';
import { 
    Plus, Calendar, CheckCircle, Search, Trash2, Edit
} from 'lucide-react';

export const ContasAPagarPage = () => {
    const [contas, setContas] = useState<any[]>([]);
    const [loading, setLoading] = useState(false);
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });
    
    // Filters
    const [filterStatus, setFilterStatus] = useState('TODOS'); // TODOS, PENDENTE, PAGO
    const [searchTerm, setSearchTerm] = useState('');

    // Date Filters
    const [filterStart, setFilterStart] = useState(new Date().toLocaleDateString('en-CA'));
    const [filterEnd, setFilterEnd] = useState(new Date().toLocaleDateString('en-CA'));

    // Modal & Form
    const [modalOpen, setModalOpen] = useState(false);
    const [editingId, setEditingId] = useState<number | null>(null);
    const [formData, setFormData] = useState({
        descricao: '',
        valor: '',
        dt_vencimento: '',
        dt_pagamento: '',
        status: 'PENDENTE',
        categoria: 'OUTROS',
        obs: ''
    });

    useEffect(() => {
        loadContas();
    }, []);

    const loadContas = async () => {
        try {
            setLoading(true);
            const res = await api.get('/contas-pagar');
            setContas(res.data);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao carregar contas.' });
        } finally {
            setLoading(false);
        }
    };

    const handleSave = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            const payload = {
                ...formData,
                valor: Number(formData.valor),
                // Enforce NULL payment date if status is not PAGO
                dt_pagamento: formData.status === 'PAGO' 
                    ? (formData.dt_pagamento ? new Date(formData.dt_pagamento).toISOString() : new Date().toISOString()) 
                    : null,
                dt_vencimento: new Date(formData.dt_vencimento).toISOString()
            };

            if (editingId) {
                await api.put(`/contas-pagar/${editingId}`, payload);
                setStatusMsg({ type: 'success', text: 'Conta atualizada com sucesso!' });
            } else {
                await api.post('/contas-pagar', payload);
                setStatusMsg({ type: 'success', text: 'Conta lançada com sucesso!' });
            }
            setModalOpen(false);
            resetForm();
            loadContas();
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao salvar conta.' });
        }
    };

    const handleDelete = async (id: number) => {
        if (!confirm('Tem certeza que deseja excluir esta conta?')) return;
        try {
            await api.delete(`/contas-pagar/${id}`);
            setStatusMsg({ type: 'success', text: 'Conta excluída.' });
            loadContas();
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao excluir conta.' });
        }
    };

    const handleQuickPay = async (conta: any) => {
        try {
            await api.put(`/contas-pagar/${conta.id_conta_pagar}`, {
                status: 'PAGO',
                dt_pagamento: new Date().toISOString()
            });
            setStatusMsg({ type: 'success', text: 'Conta marcada como PAGA.' });
            loadContas();
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao atualizar pagamento.' });
        }
    };

    const handleEdit = (conta: any) => {
        setEditingId(conta.id_conta_pagar);
        setFormData({
            descricao: conta.descricao,
            valor: Number(conta.valor).toFixed(2),
            dt_vencimento: conta.dt_vencimento ? new Date(conta.dt_vencimento).toISOString().split('T')[0] : '',
            dt_pagamento: conta.dt_pagamento ? new Date(conta.dt_pagamento).toISOString().split('T')[0] : '',
            status: conta.status,
            categoria: conta.categoria || 'OUTROS',
            obs: conta.obs || ''
        });
        setModalOpen(true);
    };

    const resetForm = () => {
        setEditingId(null);
        setFormData({
            descricao: '',
            valor: '',
            dt_vencimento: new Date().toISOString().split('T')[0],
            dt_pagamento: '',
            status: 'PENDENTE',
            categoria: 'OUTROS',
            obs: ''
        });
    };

    const openNewModal = () => {
        resetForm();
        setModalOpen(true);
    };

    const applyQuickFilter = (type: 'TODAY' | 'WEEK' | 'MONTH') => {
        const now = new Date();
        const todayStr = now.toLocaleDateString('en-CA'); // Local YYYY-MM-DD
        
        if (type === 'TODAY') {
            setFilterStart(todayStr);
            setFilterEnd(todayStr);
        } else if (type === 'WEEK') {
             const weekAgo = new Date(now);
             weekAgo.setDate(now.getDate() - 7);
             setFilterStart(weekAgo.toLocaleDateString('en-CA'));
             setFilterEnd(todayStr);
        } else if (type === 'MONTH') {
             const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
             setFilterStart(firstDay.toLocaleDateString('en-CA'));
             setFilterEnd(todayStr);
        }
    };

    // Calculations
    const filteredContas = contas.filter(c => {
        // Date Filter (Vencimento)
        if (filterStart) {
            // Compare Date Strings YYYY-MM-DD
            if (c.dt_vencimento < filterStart) return false;
        }
        if (filterEnd) {
             // For end date, we need to ensure match includes the day. 
             // c.dt_vencimento is ISO string potentially with time or T00:00.
             // Best to take YYYY-MM-DD part and compare strings.
             const vencC = c.dt_vencimento.split('T')[0];
             if (vencC > filterEnd) return false;
        }

        if (filterStatus !== 'TODOS' && c.status !== filterStatus) return false;
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            return c.descricao.toLowerCase().includes(term) || c.categoria?.toLowerCase().includes(term);
        }
        return true;
    });

    const totalPending = contas.filter(c => c.status === 'PENDENTE').reduce((acc, c) => acc + Number(c.valor), 0);
    const totalPaidMonth = contas.filter(c => {
        if (c.status !== 'PAGO' || !c.dt_pagamento) return false;
        const d = new Date(c.dt_pagamento);
        const now = new Date();
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    }).reduce((acc, c) => acc + Number(c.valor), 0);

    const categories = ['AGUA', 'LUZ', 'ALUGUEL', 'INTERNET', 'CONTADOR', 'SALARIO', 'MANUTENCAO', 'OUTROS'];

    return (
        <div className="space-y-6 animate-in fade-in duration-500">
            <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({type: null, text: ''})} />

            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 className="text-2xl font-black text-neutral-900 tracking-tight">Contas a Pagar (Geral)</h1>
                    <p className="text-neutral-500">Gerência de despesas operacionais da oficina.</p>
                </div>
                <button 
                    onClick={openNewModal}
                    className="bg-primary-600 hover:bg-primary-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-transform hover:-translate-y-0.5"
                >
                    <Plus size={20} /> Nova Conta
                </button>
            </div>

            {/* Summary */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                 <div className="bg-red-50 border border-red-100 p-6 rounded-2xl">
                     <p className="text-xs font-black text-red-400 uppercase tracking-widest mb-1">Total Pendente</p>
                     <p className="text-3xl font-black text-red-600">R$ {totalPending.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                 </div>
                 <div className="bg-success-50 border border-success-100 p-6 rounded-2xl">
                     <p className="text-xs font-black text-success-400 uppercase tracking-widest mb-1">Pago este Mês</p>
                     <p className="text-3xl font-black text-success-600">R$ {totalPaidMonth.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                 </div>
            </div>

            {/* FILTERS */}
            <div className="bg-white p-6 rounded-2xl border border-neutral-100 shadow-sm flex flex-col gap-4">
                <div className="flex flex-col lg:flex-row justify-between items-end gap-4">
                     <div className="flex flex-col md:flex-row gap-4 w-full lg:w-auto">
                        {/* Search */}
                        <div className="relative w-full md:w-64">
                            <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Buscar</label>
                            <div className="relative">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" size={16} />
                                <input 
                                    className="w-full pl-10 pr-4 py-2.5 bg-neutral-50 border border-neutral-200 rounded-xl font-bold text-sm focus:border-primary-500 outline-none"
                                    placeholder="Descrição..."
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                />
                            </div>
                        </div>

                        {/* Date Inputs */}
                        <div className="flex gap-2">
                             <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Venc. De</label>
                                <input 
                                    type="date" 
                                    value={filterStart}
                                    onChange={e => setFilterStart(e.target.value)}
                                    className="px-3 py-2.5 rounded-xl border border-neutral-200 bg-neutral-50 text-xs font-bold text-neutral-600 focus:bg-white outline-none focus:border-primary-500 uppercase h-[42px]"
                                />
                             </div>
                             <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Até</label>
                                <input 
                                    type="date" 
                                    value={filterEnd}
                                    onChange={e => setFilterEnd(e.target.value)}
                                    className="px-3 py-2.5 rounded-xl border border-neutral-200 bg-neutral-50 text-xs font-bold text-neutral-600 focus:bg-white outline-none focus:border-primary-500 uppercase h-[42px]"
                                />
                             </div>
                        </div>
                     </div>

                     <div className="flex flex-col md:flex-row gap-4 w-full lg:w-auto items-end">
                        {/* Quick Filters */}
                        <div>
                            <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block lg:hidden">Período</label>
                            <div className="flex bg-neutral-100 p-1.5 rounded-xl h-[42px] items-center">
                                <button onClick={() => applyQuickFilter('TODAY')} className="px-3 py-1 rounded-lg text-[10px] font-black uppercase hover:bg-white hover:shadow-sm text-neutral-500 hover:text-neutral-900 transition-all">Hoje</button>
                                <button onClick={() => applyQuickFilter('WEEK')} className="px-3 py-1 rounded-lg text-[10px] font-black uppercase hover:bg-white hover:shadow-sm text-neutral-500 hover:text-neutral-900 transition-all">Semana</button>
                                <button onClick={() => applyQuickFilter('MONTH')} className="px-3 py-1 rounded-lg text-[10px] font-black uppercase hover:bg-white hover:shadow-sm text-neutral-500 hover:text-neutral-900 transition-all">Mês</button>
                            </div>
                        </div>

                        {/* Status Type */}
                         <div>
                            <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block lg:hidden">Status</label>
                            <div className="flex bg-neutral-100 p-1.5 rounded-xl h-[42px] items-center">
                                {['TODOS', 'PENDENTE', 'PAGO'].map(s => (
                                    <button 
                                        key={s}
                                        onClick={() => setFilterStatus(s)}
                                        className={`px-3 py-1 rounded-lg text-[10px] font-black uppercase whitespace-nowrap transition-colors ${filterStatus === s ? 'bg-white shadow-sm text-neutral-900' : 'text-neutral-400 hover:text-neutral-700'}`}
                                    >
                                        {s}
                                    </button>
                                ))}
                            </div>
                        </div>
                     </div>
                </div>
            </div>

            {/* TABLE */}
            <div className="bg-white border border-neutral-200 rounded-2xl overflow-hidden shadow-sm">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-neutral-50 border-b border-neutral-100">
                        <tr>
                            <th className="p-4 text-[10px] font-black text-neutral-400 uppercase tracking-widest">Vencimento</th>
                            <th className="p-4 text-[10px] font-black text-neutral-400 uppercase tracking-widest">Descrição / Categoria</th>
                            <th className="p-4 text-[10px] font-black text-neutral-400 uppercase tracking-widest">Obs</th>
                            <th className="p-4 text-[10px] font-black text-neutral-400 uppercase tracking-widest text-right">Valor</th>
                            <th className="p-4 text-[10px] font-black text-neutral-400 uppercase tracking-widest text-center">Status</th>
                            <th className="p-4 text-[10px] font-black text-neutral-400 uppercase tracking-widest text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-50">
                        {loading ? (
                            <tr><td colSpan={6} className="p-8 text-center text-neutral-400">Carregando...</td></tr>
                        ) : filteredContas.length === 0 ? (
                            <tr><td colSpan={6} className="p-8 text-center text-neutral-400 italic">Nenhuma conta encontrada.</td></tr>
                        ) : (
                            filteredContas.map(conta => (
                                <tr key={conta.id_conta_pagar} className="hover:bg-neutral-25 group">
                                    <td className="p-4">
                                        <div className="font-bold text-neutral-700 text-sm flex items-center gap-2">
                                            <Calendar size={14} className="text-neutral-400" />
                                            {/* Fix Timezone Display: Use UTC to calculate date */}
                                            {new Date(conta.dt_vencimento).getUTCDate().toString().padStart(2, '0')}/{ (new Date(conta.dt_vencimento).getUTCMonth() + 1).toString().padStart(2, '0') }/{ new Date(conta.dt_vencimento).getUTCFullYear() }
                                        </div>
                                        {conta.dt_pagamento && conta.status === 'PAGO' && (
                                            <div className="text-[10px] text-success-600 font-bold mt-1">
                                                Pago em {new Date(conta.dt_pagamento).getUTCDate().toString().padStart(2, '0')}/{ (new Date(conta.dt_pagamento).getUTCMonth() + 1).toString().padStart(2, '0') }
                                            </div>
                                        )}
                                    </td>
                                    <td className="p-4">
                                        <div className="font-bold text-neutral-900">{conta.descricao}</div>
                                        <div className="text-[10px] font-bold text-neutral-400 uppercase bg-neutral-100 px-2 py-0.5 rounded w-fit mt-1">
                                            {conta.categoria}
                                        </div>
                                    </td>
                                    <td className="p-4 text-xs font-medium text-neutral-500 max-w-[200px] truncate">
                                        {conta.obs || '-'}
                                    </td>
                                    <td className="p-4 text-right font-black text-neutral-800">
                                        R$ {Number(conta.valor).toFixed(2)}
                                    </td>
                                    <td className="p-4 text-center">
                                        <span className={`px-2 py-1 rounded-md text-[10px] font-black uppercase ${
                                            conta.status === 'PAGO' ? 'bg-success-100 text-success-700' : 
                                            // Check overdue
                                            (new Date(conta.dt_vencimento) < new Date() && conta.status !== 'PAGO') ? 'bg-red-100 text-red-600' : 'bg-warning-100 text-warning-700'
                                        }`}>
                                            {conta.status === 'PAGO' ? 'PAGO' : 
                                             (new Date(conta.dt_vencimento) < new Date() && conta.status !== 'PAGO') ? 'ATRASADO' : 'PENDENTE'}
                                        </span>
                                    </td>
                                    <td className="p-4 text-right">
                                        <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            {conta.status !== 'PAGO' && (
                                                <button onClick={() => handleQuickPay(conta)} className="p-2 bg-success-50 text-success-600 rounded-lg hover:bg-success-100" title="Marcar como Pago">
                                                    <CheckCircle size={16} />
                                                </button>
                                            )}
                                            <button onClick={() => handleEdit(conta)} className="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100" title="Editar">
                                                <Edit size={16} />
                                            </button>
                                            <button onClick={() => handleDelete(conta.id_conta_pagar)} className="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100" title="Excluir">
                                                <Trash2 size={16} />
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            {/* MODAL */}
            {modalOpen && (
                <Modal 
                    title={editingId ? 'Editar Conta' : 'Nova Conta a Pagar'} 
                    onClose={() => setModalOpen(false)}
                    className="max-w-xl"
                >
                    <form onSubmit={handleSave} className="space-y-4 pt-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-neutral-500 mb-1 uppercase">Descrição</label>
                                <input 
                                    required
                                    className="w-full p-3 rounded-xl border border-neutral-200 bg-neutral-50 focus:bg-white outline-none focus:border-primary-500 font-bold"
                                    value={formData.descricao}
                                    onChange={e => setFormData({...formData, descricao: e.target.value})}
                                    placeholder="Ex: Conta de Luz"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-neutral-500 mb-1 uppercase">Categoria</label>
                                <select 
                                    className="w-full p-3 rounded-xl border border-neutral-200 bg-neutral-50 focus:bg-white outline-none focus:border-primary-500 font-bold text-sm"
                                    value={formData.categoria}
                                    onChange={e => setFormData({...formData, categoria: e.target.value})}
                                >
                                    {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-neutral-500 mb-1 uppercase">Valor</label>
                                <input 
                                    type="number" step="0.01" required
                                    className="w-full p-3 rounded-xl border border-neutral-200 bg-neutral-50 focus:bg-white outline-none focus:border-primary-500 font-bold"
                                    value={formData.valor}
                                    onChange={e => setFormData({...formData, valor: e.target.value})}
                                    placeholder="0.00"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-neutral-500 mb-1 uppercase">Status</label>
                                <select 
                                    className="w-full p-3 rounded-xl border border-neutral-200 bg-neutral-50 focus:bg-white outline-none focus:border-primary-500 font-bold text-sm"
                                    value={formData.status}
                                    onChange={e => setFormData({...formData, status: e.target.value})}
                                >
                                    <option value="PENDENTE">Pendente</option>
                                    <option value="PAGO">Pago</option>
                                </select>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-neutral-500 mb-1 uppercase">Vencimento</label>
                                <input 
                                    type="date" required
                                    className="w-full p-3 rounded-xl border border-neutral-200 bg-neutral-50 focus:bg-white outline-none focus:border-primary-500 font-bold text-sm"
                                    value={formData.dt_vencimento}
                                    onChange={e => setFormData({...formData, dt_vencimento: e.target.value})}
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-neutral-500 mb-1 uppercase">Pagamento (Opcional)</label>
                                <input 
                                    type="date"
                                    className="w-full p-3 rounded-xl border border-neutral-200 bg-neutral-50 focus:bg-white outline-none focus:border-primary-500 font-bold text-sm"
                                    value={formData.dt_pagamento}
                                    disabled={formData.status !== 'PAGO'}
                                    onChange={e => setFormData({...formData, dt_pagamento: e.target.value})}
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-xs font-bold text-neutral-500 mb-1 uppercase">Observações</label>
                            <textarea 
                                className="w-full p-3 rounded-xl border border-neutral-200 bg-neutral-50 focus:bg-white outline-none focus:border-primary-500 font-medium text-sm h-20 resize-none"
                                value={formData.obs}
                                onChange={e => setFormData({...formData, obs: e.target.value})}
                            />
                        </div>

                        <button className="w-full py-4 bg-primary-600 hover:bg-primary-700 text-white font-black uppercase rounded-xl shadow-lg transition-transform hover:-translate-y-0.5 mt-2">
                            Salvar Conta
                        </button>
                    </form>
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\FechamentoFinanceiroDetalhePage.tsx
================================================================================

import { useState, useEffect } from 'react';
import { useNavigate, useParams, useBlocker } from 'react-router-dom';
import { api } from '../services/api';
import { Save, Plus, BadgeCheck, Trash2, ArrowLeft, Edit, AlertCircle } from 'lucide-react';
import { PagamentoClienteForm } from '../components/forms/PagamentoClienteForm';
import { FornecedorForm } from '../components/forms/FornecedorForm';
import { LaborManager } from '../components/os/LaborManager';
import { Modal } from '../components/ui/Modal';
import { StatusBanner } from '../components/ui/StatusBanner';
import { Button } from '../components/ui/Button';

interface ItemOS {
    id_iten: number;
    valor_total: number;
    valor_venda: number;
    descricao: string;
    quantidade: number;
    codigo_referencia?: string;
    pecas_estoque?: {
        valor_custo: number;
        nome: string;
    };
    pagamentos_peca?: {
        id_pagamento_peca: number;
        id_fornecedor: number;
        custo_real: number;
        pago_ao_fornecedor: boolean;
    }[];
}

interface IFornecedor {
    id_fornecedor: number;
    nome: string;
}

interface ItemFinanceiroState {
    id_pagamento_peca?: number;
    id_fornecedor: string;
    custo_real: string;
    pago_fornecedor: boolean;
}

interface OSData {
    id_os: number;
    status: string;
    valor_total_cliente: number;
    valor_mao_de_obra: number;
    valor_pecas: number; 
    itens_os: ItemOS[];
    defeito_relatado?: string;
    diagnostico?: string;
    cliente: {
        pessoa_fisica?: { pessoa: { nome: string } };
        pessoa_juridica?: { nome_fantasia: string };
    };
    veiculo: {
        placa: string;
        modelo: string;
        cor: string;
    };
    cliente_telefone?: string;
    pagamentos_cliente?: {
        id_pagamento_cliente: number;
        metodo_pagamento: string;
        valor: number;
        data_pagamento: string;
        bandeira_cartao?: string;
        codigo_transacao?: string;
        qtd_parcelas?: number;
        deleted_at?: string;
    }[];
    fechamento_financeiro?: {
        id_fechamento_financeiro: number;
    };
    servicos_mao_de_obra?: {
        id_servico_mao_de_obra: number;
        valor: number;
        funcionario?: {
            pessoa_fisica?: {
                pessoa: {
                    nome: string;
                }
            };
            cargo?: string;
        }
    }[];
}

export const FechamentoFinanceiroDetalhePage = () => {
    const { id } = useParams(); // Get ID from URL
    const navigate = useNavigate();
    
    const [loading, setLoading] = useState(false);
    const [fetchingOs, setFetchingOs] = useState(false);
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });
    
    const [osData, setOsData] = useState<OSData | null>(null);
    const [fornecedores, setFornecedores] = useState<IFornecedor[]>([]);
    
    const [itemsState, setItemsState] = useState<Record<number, ItemFinanceiroState>>({});
    const [showFornecedorModal, setShowFornecedorModal] = useState(false);
    const [paymentModal, setPaymentModal] = useState<{ isOpen: boolean; data: any }>({ isOpen: false, data: null });

    // Item Edit State
    const [editItemModal, setEditItemModal] = useState<{ isOpen: boolean; item: ItemOS | null }>({ isOpen: false, item: null });
    const [editItemForm, setEditItemForm] = useState({ descricao: '', quantidade: 1, valor_venda: 0, codigo_referencia: '' });

    // Dirty Check State
    const [isDirty, setIsDirty] = useState(false);
    
    const blocker = useBlocker(
        ({ currentLocation, nextLocation }) => isDirty && currentLocation.pathname !== nextLocation.pathname
    );

    const [confirmModal, setConfirmModal] = useState<{
        isOpen: boolean;
        title: string;
        message: string;
        onConfirm: () => void;
    }>({ isOpen: false, title: '', message: '', onConfirm: () => {} });

    const [employees, setEmployees] = useState<any[]>([]);


    useEffect(() => {
        loadFornecedores();
        loadEmployees();
        if (id) {
            fetchOsData(Number(id));
        }
    }, [id]);

    const loadFornecedores = async () => {
        try {
            const response = await api.get('/fornecedor');
            setFornecedores(response.data);
        } catch (error) {
            console.error("Erro ao carregar fornecedores");
        }
    };

    const loadEmployees = async () => {
        try {
            const response = await api.get('/funcionario');
            setEmployees(response.data);
        } catch (error) {
            console.error("Erro ao carregar funcionários");
        }
    };

    const fetchOsData = async (osId: number) => {
        setFetchingOs(true);
        setStatusMsg({ type: null, text: '' });
        try {
            const response = await api.get(`/ordem-de-servico/${osId}`);
            const os: OSData = response.data;
            setOsData(os);

            const initialItemsState: Record<number, ItemFinanceiroState> = {};
            os.itens_os.forEach(item => {
                const existingPayment = item.pagamentos_peca && item.pagamentos_peca.length > 0 ? item.pagamentos_peca[0] : null;

                const initialCost = existingPayment 
                    ? String(existingPayment.custo_real)
                    : item.pecas_estoque?.valor_custo 
                        ? (Number(item.pecas_estoque.valor_custo) * item.quantidade).toFixed(2) 
                        : '';
                
                initialItemsState[item.id_iten] = {
                    id_pagamento_peca: existingPayment?.id_pagamento_peca,
                    id_fornecedor: existingPayment ? String(existingPayment.id_fornecedor) : '', 
                    custo_real: initialCost,
                    pago_fornecedor: existingPayment ? existingPayment.pago_ao_fornecedor : false
                };
            });
            setItemsState(initialItemsState);
            setIsDirty(false); // Reset dirty after fetch

        } catch (error) {
            console.error(error);
            setStatusMsg({ type: 'error', text: 'OS não encontrada ou erro ao buscar dados.' });
        } finally {
            setFetchingOs(false);
        }
    };

    const handleDeletePayment = (paymentId: number) => {
         setConfirmModal({
            isOpen: true,
            title: 'Excluir Pagamento',
            message: 'Tem certeza que deseja excluir este pagamento?',
            onConfirm: async () => {
                try {
                    await api.delete(`/pagamento-cliente/${paymentId}`);
                    setStatusMsg({ type: 'success', text: 'Pagamento removido!' });
                    if (osData) fetchOsData(osData.id_os);
                } catch (error) {
                    setStatusMsg({ type: 'error', text: 'Erro ao remover pagamento.' });
                }
                setConfirmModal(prev => ({ ...prev, isOpen: false }));
            }
        });
    };

    const handleItemChange = (id_iten: number, field: keyof ItemFinanceiroState, value: any) => {
        setItemsState(prev => {
            const newState = {
                ...prev,
                [id_iten]: {
                    ...prev[id_iten],
                    [field]: value
                }
            };
            return newState;
        });
        setIsDirty(true);
    };

    // --- ITEM CRUD ---
    const handleOpenEditItem = (item: ItemOS) => {
        setEditItemForm({
            descricao: item.descricao,
            quantidade: item.quantidade,
            valor_venda: Number(item.valor_venda) || (Number(item.valor_total) / item.quantidade),
            codigo_referencia: item.codigo_referencia || ''
        });
        setEditItemModal({ isOpen: true, item });
    };

    const handleSaveEditItem = async () => {
        if (!editItemModal.item || !osData) return;
        try {
            const valorTotal = Number(editItemForm.quantidade) * Number(editItemForm.valor_venda);
            await api.put(`/itens-os/${editItemModal.item.id_iten}`, {
                descricao: editItemForm.descricao,
                quantidade: Number(editItemForm.quantidade),
                valor_venda: Number(editItemForm.valor_venda),
                valor_total: valorTotal,
                codigo_referencia: editItemForm.codigo_referencia
            });
            
            setEditItemModal({ isOpen: false, item: null });
            fetchOsData(osData.id_os);
            setStatusMsg({ type: 'success', text: 'Item atualizado!' });
        } catch (error) {
            console.error(error);
            setStatusMsg({ type: 'error', text: 'Erro ao atualizar item.' });
        }
    };


    const calculateTotals = () => {
        if (!osData) return { totalReceita: 0, totalCusto: 0, lucro: 0, margem: 0, totalItemsRevenue: 0, totalItemsCost: 0, totalLaborRevenue: 0 };
        
        const totalItemsRevenue = osData.itens_os.reduce((acc, i) => acc + Number(i.valor_total), 0);
    const totalItemsCost = osData.itens_os.reduce((acc, i) => acc + Number(itemsState[i.id_iten]?.custo_real || 0), 0);
    const totalLaborRevenue = osData.servicos_mao_de_obra?.reduce((acc, s) => acc + Number(s.valor), 0) || 0;
    const totalReceita = totalItemsRevenue + totalLaborRevenue;
        const totalCusto = totalItemsCost; // Updated to use totalItemsCost
        
        const lucro = totalReceita - totalCusto;
        const margem = totalReceita > 0 ? (lucro / totalReceita) * 100 : 0;

        return { totalReceita, totalCusto, lucro, margem, totalItemsRevenue, totalItemsCost, totalLaborRevenue };
    };

    const { totalReceita, totalCusto, totalItemsRevenue, totalItemsCost, totalLaborRevenue } = calculateTotals();

    const handleSave = async (finalize: boolean = false) => {
        setLoading(true);
        if (!osData) return;

        try {
            // Upsert Payments (Costs)
            const pagamentoPromises = osData.itens_os.map(async (item) => {
                const st = itemsState[item.id_iten];
                if (!st || !st.id_fornecedor) return null; // Skip incomplete items? Or strictly require?
                // If finalize is true, we might strictly require. If just saving, allow partial?
                // Let's allow partial save if not finalizing.
                
                if (st && st.id_fornecedor && st.custo_real) {
                    const payload = {
                        id_item_os: item.id_iten,
                        id_fornecedor: Number(st.id_fornecedor),
                        custo_real: Number(st.custo_real),
                        data_compra: new Date().toISOString(),
                        pago_ao_fornecedor: st.pago_fornecedor
                    };

                    if (st.id_pagamento_peca) {
                         return api.put(`/pagamento-peca/${st.id_pagamento_peca}`, payload);
                    } else {
                         return api.post('/pagamento-peca', payload);
                    }
                }
                return null;
            });

            await Promise.all(pagamentoPromises);

            await Promise.all(pagamentoPromises);

            // Finalize OS if requested
            if (finalize) {
                // Upsert Fechamento ONLY when finalizing
                const fechamentoPayload = {
                    id_os: Number(osData.id_os),
                    custo_total_pecas_real: totalCusto
                };
                if (osData.fechamento_financeiro) {
                     await api.put(`/fechamento-financeiro/${osData.fechamento_financeiro.id_fechamento_financeiro}`, fechamentoPayload);
                } else {
                     await api.post('/fechamento-financeiro', fechamentoPayload);
                }

                // Validation: Check Revenue
                const totalPago = osData.pagamentos_cliente?.reduce((acc, p) => p.deleted_at ? acc : acc + Number(p.valor), 0) || 0;
                if (totalPago === 0) {
                        setStatusMsg({ type: 'error', text: 'Aviso: Nenhum recebimento registrado.' });
                }

                if (osData.status !== 'FINALIZADA') {
                     await api.put(`/ordem-de-servico/${osData.id_os}`, { 
                          status: 'FINALIZADA',
                          valor_final: totalReceita,
                          valor_pecas: totalItemsRevenue
                        });
                }
                setStatusMsg({ type: 'success', text: 'OS Finalizada com Sucesso!' });
                setIsDirty(false);
                setTimeout(() => navigate('/fechamento-financeiro'), 1000);
            } else {
                setStatusMsg({ type: 'success', text: 'Dados Salvos!' });
                setIsDirty(false);
                // Refresh data
                fetchOsData(osData.id_os);
            }

        } catch (error: any) {
            console.error(error);
            setStatusMsg({ type: 'error', text: error.message || 'Erro ao salvar.' });
        } finally {
            setLoading(false);
        }
    };

    const getClientName = () => osData?.cliente?.pessoa_fisica?.pessoa?.nome || osData?.cliente?.pessoa_juridica?.nome_fantasia || 'Cliente';

    const getStatusStyle = (st: string) => {
        switch(st) {
            case 'ABERTA': return 'bg-blue-100 text-blue-700 border-blue-200';
            case 'EM_ANDAMENTO': return 'bg-cyan-100 text-cyan-700 border-cyan-200';
            case 'FINALIZADA': return 'bg-green-100 text-green-700 border-green-200';
            case 'CANCELADA': return 'bg-red-100 text-red-700 border-red-200';
            default: return 'bg-gray-100 text-gray-700 border-gray-200';
        }
    };

    // --- RENDER ---
    if (fetchingOs) return <div className="p-10 text-center text-neutral-500">Carregando detalhes...</div>;
    if (!osData) return <div className="p-10 text-center text-neutral-500">OS não encontrada.</div>;

    return (
        <div className="space-y-6 pb-20">
             {statusMsg.text && (
                <div className="fixed bottom-8 right-8 z-60 animate-in fade-in slide-in-from-bottom-5">
                     <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({ type: null, text: '' })} />
                </div>
            )}

            {blocker.state === "blocked" && (
                <Modal title="Salvar Alterações?" onClose={() => blocker.reset && blocker.reset()}>
                    <div className="space-y-4">
                        <p className="text-neutral-600">Você tem alterações não salvas. Deseja salvar antes de sair?</p>
                        <div className="flex gap-2 justify-end">
                            <Button variant="secondary" onClick={() => blocker.proceed && blocker.proceed()}>Descartar e Sair</Button>
                            <Button variant="primary" onClick={async () => {
                                await handleSave(false);
                                blocker.proceed && blocker.proceed();
                            }}>Salvar e Sair</Button>
                        </div>
                    </div>
                </Modal>
            )}

             {/* HEADER */}
             <div className="flex items-center gap-4">
                 <button onClick={() => navigate(-1)} className="p-2 hover:bg-neutral-100 rounded-lg transition-colors text-neutral-600">
                     <ArrowLeft size={24} />
                 </button>
                 <div className="flex-1">
                     <div className="flex items-center gap-3">
                         <h1 className="text-2xl font-bold text-neutral-900 tracking-tight">Fechamento Financeiro</h1>
                         <span className="text-neutral-400 font-medium">OS #{osData.id_os}</span>
                         <span className={`px-2 py-0.5 rounded text-[10px] font-black uppercase border tracking-wider ${getStatusStyle(osData.status)}`}>
                             {osData.status.replace(/_/g, ' ')}
                         </span>
                         {isDirty && <span className="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full font-bold flex items-center gap-1"><AlertCircle size={10} /> Alterações Pendentes</span>}
                     </div>
                 </div>
             </div>

             {/* SUMMARY CARD */}
             <div className="bg-white border text-sm border-gray-200 rounded-2xl p-5 shadow-sm flex flex-col gap-4">
                    <div className="flex flex-col md:flex-row gap-6 items-start">
                        {/* LEFT: Client & Vehicle Info */}
                        <div className="flex-1 min-w-[200px]">
                            <h3 className="font-black text-xl text-gray-900 leading-tight mb-2">{getClientName()}</h3>
                            <div className="flex gap-2 mb-2">
                                <div className="bg-gray-50 border border-gray-100 rounded-xl p-3 inline-flex flex-col">
                                    <span className="font-black text-gray-800 text-base uppercase">{osData.veiculo.placa}</span>
                                    <span className="font-bold text-gray-600 text-xs uppercase">{osData.veiculo.modelo} {osData.veiculo.cor && `• ${osData.veiculo.cor}`}</span>
                                </div>
                                {osData.cliente_telefone && (
                                     <div className="bg-gray-50 border border-gray-100 rounded-xl p-3 inline-flex flex-col justify-center">
                                        <span className="font-bold text-gray-500 text-[10px] uppercase">Contato</span>
                                        <span className="font-bold text-gray-800 text-sm">{osData.cliente_telefone}</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
             </div>

             {/* LABOR (Editable if Permissions allow, or just managing here) */}
             <div className="mt-2 border border-blue-100 rounded-xl overflow-hidden text-left bg-blue-50/30">
                <div className="px-4 py-2 bg-blue-50/50 border-b border-blue-100 flex justify-between items-center">
                    <span className="text-xs font-black uppercase text-blue-600 flex items-center gap-2">
                        <BadgeCheck size={14} /> Mão de Obra
                    </span>
                </div>
                <div className="p-3">
                    <LaborManager 
                        osId={osData.id_os}
                        mode="api" 
                        employees={employees}
                        initialData={osData.servicos_mao_de_obra as any[]} 
                        onChange={() => {
                            fetchOsData(osData.id_os);
                            setIsDirty(true); // Assuming LaborManager uses API directly, but we might want to flag change
                        }} 
                        readOnly={false}
                        onTotalChange={() => {}} // Could update locals
                    />
                </div>
             </div>

             {/* PARTS COSTS */}
             <div className="border border-gray-200 rounded-2xl overflow-hidden bg-white shadow-sm">
                <div className="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                    <h4 className="font-bold text-sm text-gray-700 uppercase tracking-wide">Custos de Peças (Fornecedores)</h4>
                    <button 
                        type="button"
                        onClick={() => setShowFornecedorModal(true)}
                        className="text-[10px] font-black uppercase text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100 transition-colors flex items-center gap-1"
                    >
                        <Plus size={12} /> Novo Fornecedor
                    </button>
                </div>
                <table className="w-full text-left">
                    <thead className="bg-gray-50/50 text-xs font-bold text-gray-400 uppercase">
                        <tr>
                            <th className="p-4 w-1/3">Peça</th>
                            <th className="p-4">Fornecedor</th>
                            <th className="p-4 w-32">Custo (R$)</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {osData.itens_os.map(item => (
                            <tr key={item.id_iten} className="hover:bg-gray-50/50 transition-colors">
                                <td className="p-4">
                                    <p className="font-bold text-gray-800 text-sm">{item.descricao}</p>
                                    <div className="flex justify-between items-center text-xs text-gray-400">
                                        <span>Qtd: {item.quantidade} | Venda: R$ {Number(item.valor_total).toFixed(2)}</span>
                                        <button 
                                            onClick={() => handleOpenEditItem(item)}
                                            className="ml-2 text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-50"
                                            title="Editar Item"
                                        >
                                            <Edit size={14} />
                                        </button>
                                    </div>
                                </td>
                                <td className="p-4">
                                    <select 
                                        className="w-full p-2.5 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 outline-none focus:ring-2 focus:ring-blue-500"
                                        value={itemsState[item.id_iten]?.id_fornecedor || ''}
                                        onChange={e => handleItemChange(item.id_iten, 'id_fornecedor', e.target.value)}
                                    >
                                        <option value="">-- Selecione --</option>
                                        {fornecedores.map(f => (
                                            <option key={f.id_fornecedor} value={f.id_fornecedor}>{f.nome}</option>
                                        ))}
                                    </select>
                                </td>
                                <td className="p-4">
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        value={itemsState[item.id_iten]?.custo_real}
                                        onChange={e => handleItemChange(item.id_iten, 'custo_real', e.target.value)}
                                        className="w-full p-2 border border-gray-200 rounded-lg text-sm font-bold text-red-600 focus:ring-2 focus:ring-red-500 outline-none"
                                        placeholder="0.00"
                                    />
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
             </div>

             {/* RECEBIMENTOS */}
             <div className="border border-green-200 rounded-2xl overflow-hidden bg-white shadow-sm">
                <div className="bg-green-50 px-4 py-3 border-b border-green-200 flex justify-between items-center">
                    <h4 className="font-bold text-sm text-green-800 uppercase tracking-wide">Recebimentos</h4>
                    <button 
                         type="button"
                         onClick={() => setPaymentModal({ isOpen: true, data: null })}
                         className="text-[10px] font-black uppercase text-green-700 bg-white border border-green-200 px-3 py-1.5 rounded-lg hover:bg-green-100 transition-colors flex items-center gap-1"
                    >
                        <Plus size={12} /> Novo Pagamento
                    </button>
                </div>
                <div className="p-4">
                     {/* Using a simplified list here or reuse Table logic */}
                     {osData.pagamentos_cliente?.filter(p => !p.deleted_at).length === 0 ? (
                         <p className="text-gray-400 text-sm text-center">Nenhum recebimento.</p>
                     ) : (
                         <div className="space-y-2">
                             {osData.pagamentos_cliente?.filter(p => !p.deleted_at).map(pag => (
                                 <div key={pag.id_pagamento_cliente} className="flex justify-between items-center bg-green-50/50 p-2 rounded-lg text-sm border border-green-100 group">
                                     <span className="font-bold text-green-800">R$ {Number(pag.valor).toFixed(2)}</span>
                                     <span className="text-gray-500">{pag.metodo_pagamento} - {new Date(pag.data_pagamento).toLocaleDateString()}</span>
                                     <div className="flex gap-2">
                                        <button onClick={() => setPaymentModal({ isOpen: true, data: pag })} className="text-neutral-400 hover:text-blue-600"><Edit size={14} /></button>
                                        <button onClick={() => handleDeletePayment(pag.id_pagamento_cliente)} className="text-neutral-400 hover:text-red-600"><Trash2 size={14} /></button>
                                     </div>
                                 </div>
                             ))}
                         </div>
                     )}
                </div>
             </div>

             {/* BOTTOM SUMMARY CARD */}
             <div className="bg-neutral-900 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
                <div className="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/2 blur-2xl"></div>
                <div className="relative z-10 grid grid-cols-1 md:grid-cols-4 gap-6 items-center">
                    <div>
                        <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest mb-1">Total Peças</p>
                        <p className="text-2xl font-black text-white">R$ {Number(totalItemsRevenue).toFixed(2)}</p>
                        <p className="text-[10px] font-bold text-emerald-400 mt-1">Ref: R$ {(Number(totalItemsRevenue) - totalItemsCost).toFixed(2)}</p>
                    </div>
                    <div>
                        <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest mb-1">Total Mão de Obra</p>
                        <p className="text-2xl font-black text-white">R$ {Number(totalLaborRevenue).toFixed(2)}</p>
                    </div>
                    <div>
                         <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest mb-1">Total Geral</p>
                         <p className="text-3xl font-black text-white">R$ {Number(totalReceita).toFixed(2)}</p>
                    </div>
                    <div className="text-right">
                        <div className={`inline-block px-4 py-2 rounded-xl font-black uppercase text-xs tracking-wider ${
                            (osData.pagamentos_cliente?.reduce((acc, p) => p.deleted_at ? acc : acc + Number(p.valor), 0) || 0) >= totalReceita
                            ? 'bg-emerald-500 text-emerald-950' 
                            : 'bg-amber-500 text-amber-950'
                        }`}>
                            {(osData.pagamentos_cliente?.reduce((acc, p) => p.deleted_at ? acc : acc + Number(p.valor), 0) || 0) >= totalReceita ? 'QUITADO' : 'PENDENTE'}
                        </div>
                    </div>
                </div>
             </div>

             {/* ACTIONS (Inline now) */}
             <div className="flex justify-end gap-3 pt-6 border-t border-gray-100">
                 <Button variant="secondary" onClick={() => navigate(-1)} className="border border-gray-300">Voltar</Button>
                 
                 <Button onClick={() => handleSave(false)} variant="primary" isLoading={loading} className="bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-500/30">
                     <Save size={18} className="mr-2" /> Salvar Alterações
                 </Button>

                 <Button onClick={() => handleSave(true)} variant="success" isLoading={loading} className="bg-green-600 hover:bg-green-700 text-white shadow-lg shadow-green-500/30">
                     <BadgeCheck size={18} className="mr-2" /> Salvar e Finalizar
                 </Button>
             </div>

             {/* MODALS */}
             {showFornecedorModal && (
                <Modal title="Novo Fornecedor" onClose={() => setShowFornecedorModal(false)}>
                    <FornecedorForm onSuccess={() => { setShowFornecedorModal(false); loadFornecedores(); }} onCancel={() => setShowFornecedorModal(false)} />
                </Modal>
             )}
              {paymentModal.isOpen && osData && (
                 <Modal title={paymentModal.data ? 'Editar Pagamento' : 'Novo Pagamento'} onClose={() => setPaymentModal({ isOpen: false, data: null })}>
                     <PagamentoClienteForm
                         osId={osData.id_os}
                         valorTotal={totalReceita - (osData.pagamentos_cliente?.filter(p => !p.deleted_at).reduce((acc, p) => acc + Number(p.valor), 0) || 0) + (paymentModal.data ? Number(paymentModal.data.valor) : 0)} 
                         initialData={paymentModal.data}
                         onSuccess={() => { setPaymentModal({ isOpen: false, data: null }); fetchOsData(osData.id_os); }}
                         onCancel={() => setPaymentModal({ isOpen: false, data: null })}
                     />
                 </Modal>
             )}
            
             {/* Edit Item Modal */}
             {editItemModal.isOpen && (
                 <Modal title="Editar Item OS" onClose={() => setEditItemModal({ isOpen: false, item: null })}>
                     <div className="space-y-4">
                         <div>
                             <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Descrição</label>
                             <input 
                                 type="text" 
                                 value={editItemForm.descricao} 
                                 onChange={e => setEditItemForm({...editItemForm, descricao: e.target.value})}
                                 className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                             />
                         </div>
                         <div className="grid grid-cols-2 gap-4">
                             <div>
                                 <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Quantidade</label>
                                 <input 
                                     type="number" 
                                     value={editItemForm.quantidade} 
                                     onChange={e => setEditItemForm({...editItemForm, quantidade: Number(e.target.value)})}
                                     className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                                 />
                             </div>
                             <div>
                                 <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Valor Unit. Venda</label>
                                 <input 
                                     type="number" 
                                     step="0.1"
                                     value={editItemForm.valor_venda} 
                                     onChange={e => setEditItemForm({...editItemForm, valor_venda: Number(e.target.value)})}
                                     className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                                 />
                             </div>
                         </div>
                         <div>
                             <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Ref / Nota</label>
                             <input 
                                 type="text" 
                                 value={editItemForm.codigo_referencia} 
                                 onChange={e => setEditItemForm({...editItemForm, codigo_referencia: e.target.value})}
                                 className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                                 placeholder="Opcional"
                             />
                         </div>
                         <div className="pt-2 flex justify-end gap-2">
                             <Button variant="secondary" onClick={() => setEditItemModal({ isOpen: false, item: null })}>Cancelar</Button>
                             <Button variant="primary" onClick={handleSaveEditItem}>Salvar</Button>
                         </div>
                     </div>
                 </Modal>
             )}

             {confirmModal.isOpen && (
                <Modal title={confirmModal.title} onClose={() => setConfirmModal(prev => ({...prev, isOpen: false}))}>
                    <p className="mb-6">{confirmModal.message}</p>
                    <div className="flex justify-end gap-2">
                        <Button variant="secondary" onClick={() => setConfirmModal(prev => ({...prev, isOpen: false}))}>Cancelar</Button>
                        <Button variant="danger" onClick={confirmModal.onConfirm}>Confirmar</Button>
                    </div>
                </Modal>
             )}

        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\FechamentoFinanceiroPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
// Removed FechamentoFinanceiroForm import
import { Modal } from '../components/ui/Modal';
import { Search, Trash2, Edit } from 'lucide-react';
import { useLocation, useNavigate } from 'react-router-dom';
import { StatusBanner } from '../components/ui/StatusBanner';

interface IFechamentoFinanceiro {
    id_fechamento_financeiro: number;
    id_os: number;
    custo_total_pecas_real: number;
    data_fechamento_financeiro: string;
    ordem_de_servico: IOS;
}

interface IOS {
    id_os: number;
    status: string;
    valor_total_cliente: number;
    cliente: {
        pessoa_fisica?: { pessoa: { nome: string } };
        pessoa_juridica?: { nome_fantasia: string; razao_social: string };
    };
    veiculo: {
        placa: string;
        modelo: string;
        cor: string;
    };
    fechamento_financeiro?: IFechamentoFinanceiro;
    servicos_mao_de_obra?: {
        funcionario: {
            pessoa_fisica: {
                pessoa: {
                    nome: string;
                }
            }
        }
    }[];
}

export const FechamentoFinanceiroPage = () => {
    const location = useLocation();
    const navigate = useNavigate();
    const [fechamentos, setFechamentos] = useState<IFechamentoFinanceiro[]>([]);
    const [pendingOss, setPendingOss] = useState<IOS[]>([]);
    // Removed showModal state
    // Removed selectedOsId state
    const [searchTerm, setSearchTerm] = useState('');
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });
    const [confirmModal, setConfirmModal] = useState<{ isOpen: boolean; title: string; message: string; onConfirm: () => void; }>({ isOpen: false, title: '', message: '', onConfirm: () => {} });
    
    // Date Filters
    const [filterStart, setFilterStart] = useState(new Date().toLocaleDateString('en-CA'));
    const [filterEnd, setFilterEnd] = useState(new Date().toLocaleDateString('en-CA'));

    useEffect(() => {
        loadData();
    }, []);

    useEffect(() => {
        const params = new URLSearchParams(location.search);
        const urlIdOs = params.get('id_os');
        if (urlIdOs) {
            handleOpenFechamento(Number(urlIdOs));
        }
    }, [location.search]);

    const loadData = async () => {
        try {
            const [fechamentosRes, osRes] = await Promise.all([
                api.get('/fechamento-financeiro'),
                api.get('/ordem-de-servico')
            ]);
            
            setFechamentos(fechamentosRes.data);
            
            const allOss = osRes.data;
            // Filter OSs: Em Andamento, Aberta, Pronto Para Financeiro (and Finalizada if pending logic applies, usually Finalizada has fechamento)
            // But if Finalizada DOES NOT have Fechamento, we show it too.
            const pending = allOss.filter((os: IOS) => 
                ['ABERTA', 'EM_ANDAMENTO', 'PRONTO PARA FINANCEIRO', 'FINALIZADA'].includes(os.status) && 
                !os.fechamento_financeiro &&
                !fechamentosRes.data.some((f: IFechamentoFinanceiro) => f.id_os === os.id_os)
            );
            setPendingOss(pending);

        } catch (error) {
            console.error('Erro ao carregar dados', error);
            setStatusMsg({ type: 'error', text: 'Erro ao carregar dados financeiros' });
        }
    };

    const handleOpenFechamento = (id_os: number) => {
        navigate(`/fechamento-financeiro/${id_os}`);
    };

    const handleEditFechamento = (fechamento: IFechamentoFinanceiro) => {
        navigate(`/fechamento-financeiro/${fechamento.id_os}`);
    };

    const handleDelete = async (id: number) => {
        setConfirmModal({
            isOpen: true,
            title: 'Cancelar Fechamento',
            message: 'Tem certeza que deseja cancelar este fechamento financeiro? Isso não apaga a OS, apenas a consolidação.',
            onConfirm: async () => {
                try {
                    await api.delete(`/fechamento-financeiro/${id}`);
                    setStatusMsg({ type: 'success', text: 'Fechamento cancelado com sucesso!' });
                    loadData();
                    setConfirmModal(prev => ({...prev, isOpen: false}));
                } catch (error) {
                    setStatusMsg({ type: 'error', text: 'Erro ao deletar fechamento' });
                }
            }
        });
    };



    const getClientName = (os: IOS) => {
        return os.cliente?.pessoa_fisica?.pessoa?.nome || 
               os.cliente?.pessoa_juridica?.nome_fantasia || 
               os.cliente?.pessoa_juridica?.razao_social || 'Cliente N/I';
    };

    const applyQuickFilter = (type: 'TODAY' | 'WEEK' | 'MONTH') => {
        const now = new Date();
        const todayStr = now.toLocaleDateString('en-CA');
        
        if (type === 'TODAY') {
            setFilterStart(todayStr);
            setFilterEnd(todayStr);
        } else if (type === 'WEEK') {
             const weekAgo = new Date(now);
             weekAgo.setDate(now.getDate() - 7);
             setFilterStart(weekAgo.toLocaleDateString('en-CA'));
             setFilterEnd(todayStr);
        } else if (type === 'MONTH') {
             const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
             setFilterStart(firstDay.toLocaleDateString('en-CA'));
             setFilterEnd(todayStr);
        }
    };

    const filteredFechamentos = fechamentos.filter(f => {
        if (filterStart) {
            const recordDate = new Date(f.data_fechamento_financeiro);
            const recordDateLocal = recordDate.toLocaleDateString('en-CA');
            if (recordDateLocal < filterStart) return false;
        }
        if (filterEnd) {
             const recordDate = new Date(f.data_fechamento_financeiro);
             const recordDateLocal = recordDate.toLocaleDateString('en-CA');
             if (recordDateLocal > filterEnd) return false;
        }

        if (!searchTerm) return true;
        const q = searchTerm.toLowerCase();
        
        const id = String(f.id_fechamento_financeiro);
        const fullId = `#${id}`;
        const osId = String(f.id_os);
        const fullOsId = `#${osId}`;
        const plate = f.ordem_de_servico?.veiculo?.placa?.toLowerCase() || '';
        const model = f.ordem_de_servico?.veiculo?.modelo?.toLowerCase() || '';
        const color = f.ordem_de_servico?.veiculo?.cor?.toLowerCase() || '';
        
        return [id, fullId, osId, fullOsId, plate, model, color].join(' ').includes(q);
    }).sort((a, b) => b.id_fechamento_financeiro - a.id_fechamento_financeiro);


    return (
        <div className="space-y-8 animate-in fade-in duration-500">
            <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({type: null, text: ''})} />

            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900 tracking-tight">Gestão Financeira</h1>
                    <p className="text-gray-500 mt-1">Consolidação de custos e serviços.</p>
                </div>
            </div>

            {/* PENDING OS LIST */}
            <div className="space-y-4">
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span className="w-2 h-8 bg-orange-500 rounded-full"></span>
                    Aguardando Consolidação
                </h2>
                
                {pendingOss.length === 0 ? (
                    <div className="bg-white p-8 rounded-2xl border border-gray-100 text-center text-gray-400 italic font-medium">
                        Nenhum fechamento pendente
                    </div>
                ) : (
                    <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="bg-gray-50 border-b border-gray-100">
                                <tr>
                                    <th className="p-5 text-xs font-bold text-gray-500 uppercase tracking-wider">OS ID</th>
                                    <th className="p-5 text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                    <th className="p-5 text-xs font-bold text-gray-500 uppercase tracking-wider">Veículo</th>
                                    <th className="p-5 text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                    <th className="p-5 text-xs font-bold text-gray-500 uppercase tracking-wider text-right">Ação</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-50">
                                {pendingOss.map(os => (
                                    <tr key={os.id_os} className="hover:bg-gray-50 transition-colors">
                                        <td className="p-5 font-bold text-gray-900">#{os.id_os}</td>
                                        <td className="p-5 text-gray-600 font-medium">{getClientName(os)}</td>
                                        <td className="p-5">
                                            <div className="flex flex-col">
                                                <span className="font-bold text-gray-800 uppercase">{os.veiculo?.placa}</span>
                                                <span className="text-xs text-gray-400">{os.veiculo?.modelo}</span>
                                            </div>
                                        </td>
                                        <td className="p-5">
                                            <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase ${
                                                os.status === 'ABERTA' ? 'bg-blue-100 text-blue-700' : 
                                                os.status === 'FINALIZADA' ? 'bg-emerald-100 text-emerald-700' :
                                                'bg-orange-100 text-orange-700'
                                            }`}>
                                                {os.status.replace(/_/g, ' ')}
                                            </span>
                                        </td>
                                        <td className="p-5 text-right">
                                            <div className="flex items-center justify-end gap-2">
                                                {/* Reopen OS currently ONLY makes sense if it was FINALIZED but not Closed financially? Or logic in handleReopen handles it. */}
                                                <button 
                                                    onClick={() => handleOpenFechamento(os.id_os)}
                                                    className="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-gray-800 transition-all hover:-translate-y-0.5"
                                                >
                                                    Fechar Financeiro
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>

            {/* HISTORY LIST */}
            <div className="space-y-4">
                <div className="flex flex-col md:flex-row justify-between items-end md:items-center gap-4">
                    <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span className="w-2 h-8 bg-green-600 rounded-full"></span>
                        Histórico de Fechamentos
                    </h2>
                    
                    <div className="flex flex-col md:flex-row gap-3 items-end">
                         {/* Quick Filters */}
                         <div className="flex bg-gray-100 p-1 rounded-xl">
                            <button onClick={() => applyQuickFilter('TODAY')} className="px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase hover:bg-white hover:shadow-sm text-gray-500 hover:text-gray-900 transition-all">Hoje</button>
                            <button onClick={() => applyQuickFilter('WEEK')} className="px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase hover:bg-white hover:shadow-sm text-gray-500 hover:text-gray-900 transition-all">Semana</button>
                            <button onClick={() => applyQuickFilter('MONTH')} className="px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase hover:bg-white hover:shadow-sm text-gray-500 hover:text-gray-900 transition-all">Mês</button>
                        </div>

                         {/* Date Inputs */}
                         <div className="flex gap-2">
                            <input 
                                type="date" 
                                value={filterStart}
                                onChange={e => setFilterStart(e.target.value)}
                                className="px-3 py-2 rounded-xl border border-gray-200 text-xs font-bold text-gray-600 bg-white focus:outline-none focus:ring-2 focus:ring-gray-200"
                            />
                            <input 
                                type="date" 
                                value={filterEnd}
                                onChange={e => setFilterEnd(e.target.value)}
                                className="px-3 py-2 rounded-xl border border-gray-200 text-xs font-bold text-gray-600 bg-white focus:outline-none focus:ring-2 focus:ring-gray-200"
                            />
                        </div>

                        {/* Search Bar */}
                        <div className="relative group">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-green-600 transition-colors" size={18} />
                            <input 
                                value={searchTerm} 
                                onChange={(e) => setSearchTerm(e.target.value)} 
                                placeholder="Buscar por ID ou Placa..." 
                                className="pl-10 pr-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-green-500 focus:outline-none w-48 bg-white shadow-sm font-medium text-sm"
                            />
                        </div>
                    </div>
                </div>

                <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden min-h-[300px]">
                    <table className="w-full text-left">
                        <thead className="bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th className="p-5 text-xs font-bold text-gray-500 uppercase tracking-wider">OS</th>
                                <th className="p-5 text-xs font-bold text-gray-500 uppercase tracking-wider">Veículo (Placa/Cor)</th>
                                <th className="p-5 text-xs font-bold text-gray-500 uppercase tracking-wider">Valor Serviço</th>
                                <th className="p-5 text-xs font-bold text-gray-500 uppercase tracking-wider">Mão de Obra (Execução)</th>
                                <th className="p-5 text-xs font-bold text-gray-500 uppercase tracking-wider">Data</th>
                                <th className="p-5 text-xs font-bold text-gray-500 uppercase tracking-wider text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-50">
                            {filteredFechamentos.length === 0 ? (
                                <tr>
                                    <td colSpan={6} className="p-10 text-center text-gray-400 italic">
                                        {searchTerm || filterStart ? 'Nenhum registro encontrado para a busca.' : 'Nenhum fechamento realizado ainda.'}
                                    </td>
                                </tr>
                            ) : (
                                filteredFechamentos.map((fech) => (
                                    <tr key={fech.id_fechamento_financeiro} className="hover:bg-gray-50 group transition-colors">
                                        <td className="p-5">
                                            <span className="font-bold text-gray-800 bg-gray-100 px-2 py-1 rounded">OS #{fech.id_os}</span>
                                        </td>
                                        <td className="p-5">
                                            <div className="flex flex-col">
                                                <span className="font-bold text-gray-700 uppercase">
                                                    {fech.ordem_de_servico?.veiculo?.placa || '-'} - {fech.ordem_de_servico?.veiculo?.modelo} 
                                                </span>
                                                <span className="text-xs text-gray-400 uppercase">
                                                    ({fech.ordem_de_servico?.veiculo?.cor || 'Cor N/I'})
                                                </span>
                                            </div>
                                        </td>
                                        <td className="p-5">
                                            <div className="flex items-center gap-2 text-blue-600 font-bold bg-blue-50 w-fit px-3 py-1 rounded-lg">
                                                <span className="text-xs">R$</span>
                                                {Number(fech.ordem_de_servico?.valor_total_cliente || 0).toFixed(2)}
                                            </div>
                                        </td>
                                        <td className="p-5">
                                            <div className="flex flex-col gap-1">
                                                {fech.ordem_de_servico?.servicos_mao_de_obra && fech.ordem_de_servico.servicos_mao_de_obra.length > 0 ? (
                                                     Array.from(new Set(fech.ordem_de_servico.servicos_mao_de_obra
                                                        .map(svc => svc.funcionario?.pessoa_fisica?.pessoa?.nome?.split(' ')[0])
                                                        .filter(Boolean)
                                                     )).map((name, idx) => (
                                                         <span key={idx} className="text-xs font-medium text-gray-600 bg-gray-100 px-2 py-0.5 rounded w-fit">
                                                             {name}
                                                         </span>
                                                     ))
                                                ) : (
                                                    <span className="text-xs text-gray-400 italic">Não informado</span>
                                                )}
                                            </div>
                                        </td>
                                        <td className="p-5 text-sm text-gray-500">
                                            {new Date(fech.data_fechamento_financeiro).toLocaleDateString('pt-BR')}
                                        </td>
                                        <td className="p-5 text-right">
                                            <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button 
                                                    onClick={() => handleEditFechamento(fech)}
                                                    className="p-2 hover:bg-blue-50 text-blue-600 rounded-lg transition-colors"
                                                    title="Editar Detalhes"
                                                >
                                                    <Edit size={18} />
                                                </button>
                                                <button 
                                                    onClick={() => handleDelete(fech.id_fechamento_financeiro)}
                                                    className="p-2 hover:bg-red-50 text-red-600 rounded-lg transition-colors"
                                                    title="Cancelar Fechamento"
                                                >
                                                    <Trash2 size={18} />
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            {confirmModal.isOpen && (
                <Modal title={confirmModal.title} onClose={() => setConfirmModal(prev => ({...prev, isOpen: false}))}>
                    <p className="mb-6">{confirmModal.message}</p>
                    <div className="flex justify-end gap-2">
                        <button 
                            onClick={() => setConfirmModal(prev => ({...prev, isOpen: false}))}
                            className="bg-gray-100 text-gray-600 px-4 py-2 rounded-xl font-bold hover:bg-gray-200 transition-colors"
                        >
                            Cancelar
                        </button>
                        <button 
                            onClick={confirmModal.onConfirm}
                            className="bg-red-50 text-red-600 px-4 py-2 rounded-xl font-bold hover:bg-red-100 hover:text-red-700 transition-colors"
                        >
                            Confirmar
                        </button>
                    </div>
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\FinanceiroPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { api } from '../services/api';
import { StatusBanner } from '../components/ui/StatusBanner';
import { 
    Search, Truck, Calendar, CheckSquare, Square, 
    ArrowUpCircle, ArrowDownCircle, Wallet, Edit, Filter, Trash2, Plus
} from 'lucide-react';

import { Modal } from '../components/ui/Modal';

export const FinanceiroPage = () => {
    const location = useLocation();
    const navigate = useNavigate();
    const [activeTab, setActiveTab] = useState<'AUTO_PECAS' | 'LIVRO_CAIXA' | 'CONTAS_PAGAR'>('LIVRO_CAIXA');
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });
    const [, setLoading] = useState(false);

    // --- STATES FOR ACCOUNTS PAYABLE (PEÇAS) ---
    const [payments, setPayments] = useState<any[]>([]);
    const [fornecedores, setFornecedores] = useState<any[]>([]);
    const [filterSupplier, setFilterSupplier] = useState('');
    const [filterPlate, setFilterPlate] = useState('');
    const [filterStatus, setFilterStatus] = useState<'PENDING' | 'PAID' | 'ALL'>('PENDING');
    const [filterStart, setFilterStart] = useState('');
    const [filterEnd, setFilterEnd] = useState('');

    // --- STATES FOR CASH BOOK (LIVRO CAIXA) ---
    const [cashBookEntries, setCashBookEntries] = useState<any[]>([]);
    const [cashFilterStart, setCashFilterStart] = useState('');
    const [cashFilterEnd, setCashFilterEnd] = useState('');
    const [cashSearch, setCashSearch] = useState('');

    // --- SHARED STATES ---
    const [editPayment, setEditPayment] = useState<any | null>(null);
    const [showEditModal, setShowEditModal] = useState(false);
    const [confirmModal, setConfirmModal] = useState<{isOpen: boolean; title: string; message: string; onConfirm: () => void}>({ isOpen: false, title: '', message: '', onConfirm: () => {} });

    useEffect(() => {
        const params = new URLSearchParams(location.search);
        const tab = params.get('tab');
        if (tab === 'AUTO_PECAS') setActiveTab('AUTO_PECAS');
        else if (tab === 'LIVRO_CAIXA') setActiveTab('LIVRO_CAIXA');
        else if (tab === 'CONTAS_PAGAR') setActiveTab('CONTAS_PAGAR');
        
        loadData();
    }, [location.search]);

    const loadData = async () => {
        try {
            setLoading(true);
            const [paymentsRes, fornecedoresRes, inflowsRes] = await Promise.all([
                api.get('/pagamento-peca'),
                api.get('/fornecedor'),
                api.get('/pagamento-cliente') // Assuming this endpoint exists, need to verify
            ]);

            setPayments(paymentsRes.data);
            setFornecedores(fornecedoresRes.data);
            
            // Process Cash Book
            // Map Outflows (Payments to Suppliers)
            const outflows = paymentsRes.data
                .filter((p: any) => p.pago_ao_fornecedor && p.data_pagamento_fornecedor) // Only actual paid items count as outflow in cash book? Or simplified view? User said "Control everything that enters and exits"
                .map((p: any) => ({
                    id: `out-${p.id_pagamento_peca}`,
                    date: p.data_pagamento_fornecedor || p.data_compra,
                    description: `Pagamento Fornecedor - ${p.item_os?.descricao || 'Peça'}`,
                    type: 'OUT',
                    value: Number(p.custo_real),
                    details: `OS #${p.item_os?.id_os} - ${p.fornecedor?.nome}`
                }));

            // Map Inflows (Payments from Clients)
            // Need to verify the structure of payment-cliente
            const inflows = (inflowsRes.data || []).map((p: any) => ({
                id: `in-${p.id_pagamento_cliente}`,
                date: p.data_pagamento,
                description: `Recebimento OS #${p.id_os}`,
                type: 'IN',
                value: Number(p.valor),
                details: `Forma: ${p.metodo_pagamento}`
            }));

            const combined = [...outflows, ...inflows].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
            setCashBookEntries(combined);

        } catch (error) {
            console.error(error);
            setStatusMsg({ type: 'error', text: 'Erro ao carregar dados financeiros.' });
        } finally {
            setLoading(false);
        }
    };

    // --- ACTIONS ---
    const handleTogglePayment = async (paymentId: number, currentStatus: boolean) => {
        try {
            setLoading(true);
            await api.put(`/pagamento-peca/${paymentId}`, {
                pago_ao_fornecedor: !currentStatus,
                data_pagamento_fornecedor: !currentStatus ? new Date() : null
            });
            setStatusMsg({ type: 'success', text: !currentStatus ? 'Pagamento marcado como realizado!' : 'Pagamento reaberto.' });
            loadData(); // Reload to update both lists
            setTimeout(() => setStatusMsg({ type: null, text: '' }), 3000);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao atualizar status do pagamento.' });
        } finally {
            setLoading(false);
        }
    };

    const handleDeletePayment = (id: number) => {
        setConfirmModal({
            isOpen: true,
            title: 'Excluir Pagamento',
            message: 'Tem certeza que deseja excluir este registro de conta a pagar? Esta ação é irreversível.',
            onConfirm: async () => {
                try {
                    setLoading(true);
                    await api.delete(`/pagamento-peca/${id}`);
                    setStatusMsg({ type: 'success', text: 'Pagamento excluído com sucesso!' });
                    loadData();
                } catch (error) {
                    setStatusMsg({ type: 'error', text: 'Erro ao excluir pagamento.' });
                } finally {
                    setLoading(false);
                    setConfirmModal(prev => ({...prev, isOpen: false}));
                }
            }
        });
    };

    const handleUpdatePayment = async () => {
        if (!editPayment) return;
        try {
            setLoading(true);
            await api.put(`/pagamento-peca/${editPayment.id_pagamento_peca}`, {
                custo_real: Number(editPayment.custo_real),
                id_fornecedor: Number(editPayment.id_fornecedor),
                data_compra: new Date(editPayment.data_compra),
                data_pagamento_fornecedor: editPayment.data_pagamento_fornecedor ? new Date(editPayment.data_pagamento_fornecedor) : null,
                pago_ao_fornecedor: editPayment.pago_ao_fornecedor
            });
            
            // Also update item_os reference if changed
            if (editPayment.item_os && editPayment.ref_nota) {
                 await api.put(`/itens-os/${editPayment.item_os.id_iten}`, {
                     codigo_referencia: editPayment.ref_nota
                 });
            }

            setStatusMsg({ type: 'success', text: 'Dados atualizados com sucesso!' });
            loadData();
            setShowEditModal(false);
            setEditPayment(null);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao atualizar pagamento.' });
        } finally {
            setLoading(false);
        }
    };

    const openEditModal = (payment: any) => {
        setEditPayment({
            ...payment,
            data_compra: new Date(payment.data_compra).toISOString().split('T')[0],
            data_pagamento_fornecedor: payment.data_pagamento_fornecedor ? new Date(payment.data_pagamento_fornecedor).toISOString().split('T')[0] : '',
            ref_nota: payment.item_os?.codigo_referencia || ''
        });
        setShowEditModal(true);
    };

    // --- FILTERS LOGIC ---
    const filteredPayments = payments.filter(p => {
        if (filterStatus === 'PENDING' && p.pago_ao_fornecedor) return false;
        if (filterStatus === 'PAID' && !p.pago_ao_fornecedor) return false;
        
        if (filterStart) {
            const start = new Date(filterStart);
            const date = new Date(p.data_compra);
            if (date < start) return false;
        }
        if (filterEnd) {
            const end = new Date(filterEnd);
            end.setHours(23, 59, 59, 999);
            const date = new Date(p.data_compra);
            if (date > end) return false;
        }

        const supplierMatch = filterSupplier ? String(p.id_fornecedor) === filterSupplier : true;
        const plateMatch = filterPlate ? p.item_os?.ordem_de_servico?.veiculo?.placa?.toLowerCase().includes(filterPlate.toLowerCase()) : true;
        
        return supplierMatch && plateMatch;
    }).sort((a,b) => new Date(b.data_compra).getTime() - new Date(a.data_compra).getTime());

    const totalPending = filteredPayments.filter(p => !p.pago_ao_fornecedor).reduce((acc, p) => acc + Number(p.custo_real), 0);
    const totalPaid = filteredPayments.filter(p => p.pago_ao_fornecedor).reduce((acc, p) => acc + Number(p.custo_real), 0);

    // --- FILTERS LOGIC ---
    // ... (Existing Payment Filters)
    
    // Cash Book Filters
    const filteredCashBook = cashBookEntries.filter(entry => {
        if (cashFilterStart) {
             const start = new Date(cashFilterStart);
             const date = new Date(entry.date);
             if (date < start) return false;
        }
        if (cashFilterEnd) {
             const end = new Date(cashFilterEnd);
             end.setHours(23, 59, 59, 999);
             const date = new Date(entry.date);
             if (date > end) return false;
        }
        if (cashSearch) {
             const searchLower = cashSearch.toLowerCase();
             const matchDesc = entry.description.toLowerCase().includes(searchLower);
             const matchDetails = entry.details.toLowerCase().includes(searchLower);
             if (!matchDesc && !matchDetails) return false;
        }
        return true;
    });

    const totalInflow = filteredCashBook.filter(e => e.type === 'IN').reduce((acc, e) => acc + e.value, 0);
    const totalOutflow = filteredCashBook.filter(e => e.type === 'OUT').reduce((acc, e) => acc + e.value, 0);
    const balance = totalInflow - totalOutflow;

    return (
        <div className="space-y-6 animate-in fade-in duration-500">
            <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({type: null, text: ''})} />

            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 className="text-2xl font-black text-neutral-900 tracking-tight">Financeiro</h1>
                    <p className="text-neutral-500">Controle de caixa, contas a pagar e receber.</p>
                </div>
            </div>

            {/* TABS */}
            <div className="flex gap-4 border-b border-neutral-200 overflow-x-auto">
                 <button 
                    onClick={() => navigate('/financeiro?tab=AUTO_PECAS')}
                    className={`pb-4 px-2 font-black text-sm uppercase tracking-widest transition-colors relative whitespace-nowrap ${activeTab === 'AUTO_PECAS' ? 'text-neutral-900' : 'text-neutral-400 hover:text-neutral-600'}`}
                >
                     Pagamento de Auto Peças
                     {activeTab === 'AUTO_PECAS' && <div className="absolute bottom-0 left-0 w-full h-1 bg-neutral-900 rounded-t-full" />}
                </button>
                <button 
                    onClick={() => navigate('/financeiro?tab=CONTAS_PAGAR')}
                    className={`pb-4 px-2 font-black text-sm uppercase tracking-widest transition-colors relative whitespace-nowrap ${activeTab === 'CONTAS_PAGAR' ? 'text-neutral-900' : 'text-neutral-400 hover:text-neutral-600'}`}
                >
                     Contas a Pagar (Geral)
                     {activeTab === 'CONTAS_PAGAR' && <div className="absolute bottom-0 left-0 w-full h-1 bg-red-500 rounded-t-full" />}
                </button>
                <button 
                    onClick={() => navigate('/financeiro?tab=LIVRO_CAIXA')}
                    className={`pb-4 px-2 font-black text-sm uppercase tracking-widest transition-colors relative whitespace-nowrap ${activeTab === 'LIVRO_CAIXA' ? 'text-neutral-900' : 'text-neutral-400 hover:text-neutral-600'}`}
                >
                     Movimentação de Caixa (Fluxo)
                     {activeTab === 'LIVRO_CAIXA' && <div className="absolute bottom-0 left-0 w-full h-1 bg-success-500 rounded-t-full" />}
                </button>
            </div>

            {activeTab === 'AUTO_PECAS' && (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {/* Filters */}
                    <div className="bg-white p-6 rounded-2xl border border-neutral-100 shadow-sm grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Status</label>
                            <div className="flex bg-neutral-100 rounded-xl p-1 gap-2">
                                <button onClick={() => setFilterStatus('PENDING')} className={`flex-1 py-2 rounded-lg text-xs font-black transition-all ${filterStatus === 'PENDING' ? 'bg-white shadow text-neutral-900' : 'text-neutral-400 hover:text-neutral-600'}`}>PENDENTES</button>
                                <button onClick={() => setFilterStatus('PAID')} className={`flex-1 py-2 rounded-lg text-xs font-black transition-all ${filterStatus === 'PAID' ? 'bg-white shadow text-green-600' : 'text-neutral-400 hover:text-neutral-600'}`}>PAGAS</button>
                                <button onClick={() => setFilterStatus('ALL')} className={`flex-1 py-2 rounded-lg text-xs font-black transition-all ${filterStatus === 'ALL' ? 'bg-white shadow text-neutral-900' : 'text-neutral-400 hover:text-neutral-600'}`}>TODAS</button>
                            </div>
                        </div>
                        <div>
                            <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Fornecedor</label>
                            <select 
                                value={filterSupplier}
                                onChange={(e) => setFilterSupplier(e.target.value)}
                                className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400 transition-colors"
                            >
                                <option value="">Todos</option>
                                {fornecedores.map(f => (
                                    <option key={f.id_fornecedor} value={f.id_fornecedor}>{f.nome}</option>
                                ))}
                            </select>
                        </div>
                        <div className="md:col-span-2">
                             <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Buscar por Placa</label>
                             <div className="relative">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" size={16} />
                                <input 
                                    value={filterPlate}
                                    onChange={(e) => setFilterPlate(e.target.value)}
                                    placeholder="Digite a placa do veículo da OS..."
                                    className="w-full pl-10 pr-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold text-sm outline-none focus:border-neutral-400 transition-colors uppercase"
                                />
                             </div>
                        </div>
                        <div className="md:col-span-4 grid grid-cols-2 gap-4 bg-neutral-50 p-4 rounded-xl border border-neutral-200">
                             <div className="col-span-2 flex items-center gap-2 mb-2">
                                <Filter size={16} className="text-neutral-500" />
                                <span className="text-xs font-black text-neutral-500 uppercase">Filtrar por Período de Compra</span>
                             </div>
                             <div>
                                <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1 block">De</label>
                                <input 
                                    type="date" 
                                    value={filterStart} 
                                    onChange={e => setFilterStart(e.target.value)} 
                                    className="w-full bg-white border border-neutral-200 p-2 rounded-lg font-bold text-sm outline-none focus:border-neutral-400 transition-colors uppercase"
                                />
                             </div>
                             <div>
                                <label className="text-[10px] font-bold text-neutral-400 uppercase mb-1 block">Até</label>
                                <input 
                                    type="date" 
                                    value={filterEnd} 
                                    onChange={e => setFilterEnd(e.target.value)} 
                                    className="w-full bg-white border border-neutral-200 p-2 rounded-lg font-bold text-sm outline-none focus:border-neutral-400 transition-colors uppercase"
                                />
                             </div>
                        </div>
                    </div>

                    {/* Totals Summary */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-red-50 p-6 rounded-2xl border border-red-100 flex items-center justify-between">
                            <div>
                                <p className="text-[10px] font-black text-red-400 uppercase tracking-widest">Total Pendente (Selecionado)</p>
                                <p className="text-2xl font-black text-red-600">R$ {totalPending.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                            </div>
                            <div className="p-3 bg-white rounded-xl text-red-200"><Square size={24} /></div>
                        </div>
                        <div className="bg-green-50 p-6 rounded-2xl border border-green-100 flex items-center justify-between">
                            <div>
                                <p className="text-[10px] font-black text-green-400 uppercase tracking-widest">Total Pago (Selecionado)</p>
                                <p className="text-2xl font-black text-green-600">R$ {totalPaid.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                            </div>
                            <div className="p-3 bg-white rounded-xl text-green-200"><CheckSquare size={24} /></div>
                        </div>
                    </div>

                    {/* Table */}
                    <div className="bg-white rounded-3xl shadow-sm border border-neutral-100 overflow-hidden w-full">
                        <table className="w-full text-left border-collapse min-w-[800px]">
                            <thead>
                                <tr className="bg-neutral-50 text-[10px] font-black text-neutral-400 uppercase tracking-widest">
                                    <th className="p-5">Data Compra</th>
                                    <th className="p-5">Ref / Nota</th>
                                    <th className="p-5">Peça</th>
                                    <th className="p-5">Fornecedor</th>
                                    <th className="p-5">Veículo / OS</th>
                                    <th className="p-5 text-right w-32">Valor Custo</th>
                                    <th className="p-5 text-center w-24">Pago?</th>
                                    <th className="p-5 text-center w-16">Editar</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-neutral-50">
                                {filteredPayments.length === 0 ? (
                                     <tr><td colSpan={7} className="p-10 text-center text-neutral-400 italic font-medium">Nenhum registro encontrado.</td></tr>
                                ) : (
                                    filteredPayments.map(p => (
                                        <tr key={p.id_pagamento_peca} className={`hover:bg-neutral-25 transition-colors ${p.pago_ao_fornecedor ? 'opacity-75' : ''}`}>
                                            <td className="p-5">
                                                <div className="flex items-center gap-2 font-bold text-neutral-600 text-xs">
                                                    <Calendar size={14} />
                                                    {new Date(p.data_compra).toLocaleDateString()}
                                                </div>
                                            </td>
                                            <td className="p-5">
                                                <span className="font-mono text-xs font-black text-neutral-600 bg-neutral-100 px-2 py-1 rounded w-fit">
                                                    {p.item_os?.codigo_referencia || '---'}
                                                </span>
                                            </td>
                                            <td className="p-5">
                                                <p className="font-bold text-neutral-900 text-sm">{p.item_os?.descricao}</p>
                                            </td>
                                            <td className="p-5">
                                                <div className="flex items-center gap-2">
                                                    <Truck size={14} className="text-orange-500" />
                                                    <span className="font-bold text-neutral-700 text-xs uppercase">{p.fornecedor?.nome}</span>
                                                </div>
                                            </td>
                                            <td className="p-5">
                                                <div>
                                                    <p className="font-black text-neutral-800 text-xs uppercase tracking-widest bg-neutral-100 px-2 py-1 rounded w-fit">
                                                        {p.item_os?.ordem_de_servico?.veiculo?.placa || 'N/A'}
                                                    </p>
                                                    <p className="text-[10px] text-neutral-400 font-bold mt-1">OS #{String(p.item_os?.id_os).padStart(4, '0')}</p>
                                                </div>
                                            </td>
                                            <td className="p-5 text-right font-black text-neutral-900">
                                                R$ {Number(p.custo_real).toFixed(2)}
                                            </td>
                                            <td className="p-5 text-center">
                                                <button 
                                                    onClick={() => handleTogglePayment(p.id_pagamento_peca, p.pago_ao_fornecedor)}
                                                    className="hover:scale-110 transition-transform active:scale-95 text-neutral-400 hover:text-neutral-600"
                                                    title={p.pago_ao_fornecedor ? "Desmarcar como pago" : "Marcar como pago"}
                                                >
                                                    {p.pago_ao_fornecedor ? (
                                                        <CheckSquare size={32} className="text-green-500 fill-green-500/20" />
                                                    ) : (
                                                        <Square size={32} className="text-neutral-300 stroke-[2.5]" />
                                                    )}
                                                </button>
                                            </td>
                                            <td className="p-5 text-center">
                                                <div className="flex justify-center gap-2">
                                                    <button 
                                                        onClick={() => openEditModal(p)}
                                                        className="p-2 text-neutral-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                                        title="Editar Detalhes"
                                                    >
                                                        <Edit size={18} />
                                                    </button>
                                                    <button 
                                                        onClick={() => handleDeletePayment(p.id_pagamento_peca)}
                                                        className="p-2 text-neutral-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                                        title="Excluir Pagamento"
                                                    >
                                                        <Trash2 size={18} />
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}
            
            {activeTab === 'CONTAS_PAGAR' && (
                <div className="bg-neutral-50 border-2 border-dashed border-neutral-200 rounded-3xl p-12 text-center animate-in fade-in duration-500">
                    <div className="w-16 h-16 bg-neutral-100 rounded-full flex items-center justify-center mx-auto mb-4 text-neutral-400">
                        <Wallet size={32} />
                    </div>
                    <h2 className="text-xl font-black text-neutral-800 mb-2">Contas a Pagar (Geral) em Construção</h2>
                    <p className="text-neutral-500 max-w-md mx-auto">
                        Aqui você poderá gerenciar contas de luz, água, aluguel, internet e outras despesas fixas ou variáveis da oficina.
                    </p>
                    <button className="mt-6 px-6 py-3 bg-neutral-900 text-white font-bold rounded-xl shadow-lg opacity-50 cursor-not-allowed">
                        Nova Conta a Pagar (Em Breve)
                    </button>
                </div>
            )}

            {activeTab === 'LIVRO_CAIXA' && (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {/* Manual Entry & Filters */}
                    <div className="bg-white p-6 rounded-2xl border border-neutral-100 shadow-sm flex flex-col md:flex-row justify-between items-end gap-4">
                        <div className="w-full grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Buscar Detalhes</label>
                                <div className="relative">
                                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" size={16} />
                                    <input 
                                        value={cashSearch}
                                        onChange={(e) => setCashSearch(e.target.value)}
                                        placeholder="Ex: OS 123, Pix..."
                                        className="w-full pl-10 pr-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold text-sm outline-none focus:border-neutral-400 transition-colors"
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">De</label>
                                <input 
                                    type="date" 
                                    value={cashFilterStart}
                                    onChange={e => setCashFilterStart(e.target.value)}
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400 transition-colors uppercase"
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Até</label>
                                <input 
                                    type="date" 
                                    value={cashFilterEnd}
                                    onChange={e => setCashFilterEnd(e.target.value)}
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400 transition-colors uppercase"
                                />
                            </div>
                        </div>
                        <button 
                            className="bg-neutral-900 text-white px-5 py-3 rounded-xl font-bold flex items-center gap-2 whitespace-nowrap shadow-lg hover:bg-neutral-800 transition-transform hover:-translate-y-0.5"
                            onClick={() => alert("Funcionalidade de Lançamento Manual será implementada em breve.")} 
                        >
                            <Plus size={18} />
                            Novo Lançamento
                        </button>
                    </div>

                    {/* SUMMARY CARDS */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-neutral-100">
                            <div className="flex items-center gap-3 mb-2">
                                <div className="p-2 bg-success-50 text-success-600 rounded-lg"><ArrowDownCircle size={20} /></div>
                                <p className="text-xs font-black text-neutral-400 uppercase tracking-widest">Entradas</p>
                            </div>
                            <p className="text-3xl font-black text-success-600">R$ {totalInflow.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-neutral-100">
                            <div className="flex items-center gap-3 mb-2">
                                <div className="p-2 bg-red-50 text-red-600 rounded-lg"><ArrowUpCircle size={20} /></div>
                                <p className="text-xs font-black text-neutral-400 uppercase tracking-widest">Saídas</p>
                            </div>
                            <p className="text-3xl font-black text-red-600">R$ {totalOutflow.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                        </div>
                        <div className="bg-neutral-900 p-6 rounded-2xl shadow-xl text-white">
                            <div className="flex items-center gap-3 mb-2">
                                <div className="p-2 bg-neutral-800 text-neutral-400 rounded-lg"><Wallet size={20} /></div>
                                <p className="text-xs font-black text-neutral-400 uppercase tracking-widest">Saldo</p>
                            </div>
                            <p className={`text-3xl font-black ${balance >= 0 ? 'text-white' : 'text-red-400'}`}>R$ {balance.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                        </div>
                    </div>

                    {/* TRANSACTIONS TABLE */}
                     <div className="bg-white rounded-3xl shadow-sm border border-neutral-100 overflow-hidden w-full">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="bg-neutral-50 text-[10px] font-black text-neutral-400 uppercase tracking-widest">
                                    <th className="p-5">Data</th>
                                    <th className="p-5">Descrição</th>
                                    <th className="p-5">Detalhes</th>
                                    <th className="p-5 text-right">Valor</th>
                                    <th className="p-5 text-center">Tipo</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-neutral-50">
                                {filteredCashBook.length === 0 ? (
                                     <tr><td colSpan={5} className="p-10 text-center text-neutral-400 italic font-medium">Nenhuma movimentação encontrada para o filtro.</td></tr>
                                ) : (
                                    filteredCashBook.map(entry => (
                                        <tr key={entry.id} className="hover:bg-neutral-25 transition-colors">
                                            <td className="p-5">
                                                <div className="flex items-center gap-2 font-bold text-neutral-600 text-xs">
                                                    <Calendar size={14} />
                                                    {new Date(entry.date).toLocaleDateString()}
                                                </div>
                                            </td>
                                            <td className="p-5 font-bold text-neutral-900">{entry.description}</td>
                                            <td className="p-5 text-xs font-medium text-neutral-500">{entry.details}</td>
                                            <td className="p-5 text-right font-black text-neutral-900">
                                                R$ {entry.value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                                            </td>
                                            <td className="p-5 text-center">
                                                <span className={`px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider ${
                                                    entry.type === 'IN' 
                                                    ? 'bg-success-100 text-success-700' 
                                                    : 'bg-red-100 text-red-700'
                                                }`}>
                                                    {entry.type === 'IN' ? 'ENTRADA' : 'SAÍDA'}
                                                </span>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                     </div>
                </div>
            )}
            
            {showEditModal && editPayment && (
                <Modal title="Editar Pagamento (Peça)" onClose={() => setShowEditModal(false)}>
                    <div className="space-y-6">
                        <div className="bg-neutral-50 p-4 rounded-xl mb-4">
                            <p className="text-xs font-bold text-neutral-400 uppercase">Item da OS</p>
                            <p className="font-bold text-neutral-800">{editPayment.item_os?.descricao}</p>
                            <div className="mt-2">
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-1 block">Ref / Nota</label>
                                <input 
                                    value={editPayment.ref_nota || ''}
                                    onChange={e => setEditPayment({...editPayment, ref_nota: e.target.value})}
                                    className="w-full bg-white border border-neutral-200 p-2 rounded-lg font-bold text-sm outline-none focus:border-neutral-400"
                                    placeholder="Número da Nota / Referência"
                                />
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Data Compra</label>
                                <input 
                                    type="date"
                                    value={editPayment.data_compra}
                                    onChange={e => setEditPayment({...editPayment, data_compra: e.target.value})}
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Data Pagamento</label>
                                <input 
                                    type="date"
                                    value={editPayment.data_pagamento_fornecedor || ''}
                                    onChange={e => setEditPayment({...editPayment, data_pagamento_fornecedor: e.target.value})}
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                             <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Custo Real (R$)</label>
                                <input 
                                    type="number"
                                    step="0.01"
                                    value={editPayment.custo_real}
                                    onChange={e => setEditPayment({...editPayment, custo_real: e.target.value})}
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Fornecedor</label>
                                <select 
                                    value={editPayment.id_fornecedor}
                                    onChange={(e) => setEditPayment({...editPayment, id_fornecedor: e.target.value})}
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                                >
                                    {fornecedores.map(f => (
                                        <option key={f.id_fornecedor} value={f.id_fornecedor}>{f.nome}</option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        <div className="flex gap-3 pt-4 border-t border-neutral-100">
                             <button
                                onClick={() => setShowEditModal(false)}
                                className="flex-1 py-3 text-neutral-500 font-bold hover:bg-neutral-50 rounded-xl transition-colors"
                            >
                                Cancelar
                            </button>
                            <button
                                onClick={handleUpdatePayment}
                                className="flex-1 py-3 bg-neutral-900 text-white font-bold rounded-xl hover:bg-neutral-800 transition-colors shadow-lg"
                            >
                                Salvar Alterações
                            </button>
                        </div>
                    </div>
                </Modal>
            )}

            {/* Confirmation Modal */}
            {confirmModal.isOpen && (
                <Modal 
                    title={confirmModal.title} 
                    onClose={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))}
                >
                     <div className="space-y-6">
                        <p className="text-neutral-600 font-medium">{confirmModal.message}</p>
                        <div className="flex justify-end gap-3 pt-2">
                             <button
                                type="button"
                                onClick={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))}
                                className="px-5 py-2.5 text-neutral-600 font-bold hover:bg-neutral-100 rounded-lg transition-colors"
                            >
                                Cancelar
                            </button>
                            <button
                                type="button"
                                onClick={confirmModal.onConfirm}
                                className="px-5 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors shadow-lg shadow-red-500/30"
                            >
                                Confirmar Exclusão
                            </button>
                        </div>
                    </div>
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\FornecedorPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import type { IFornecedor } from '../types/backend';
import { FornecedorForm } from '../components/forms/FornecedorForm';
import { Modal } from '../components/ui/Modal';
import { Button } from '../components/ui/Button';
import { StatusBanner } from '../components/ui/StatusBanner';
import { 
    Plus, Search, Trash2, Edit, Truck, BadgeCheck, Store, Calendar, Phone 
} from 'lucide-react';

export const FornecedorPage = () => {
    const [fornecedores, setFornecedores] = useState<IFornecedor[]>([]);
    const [showModal, setShowModal] = useState(false);
    const [editData, setEditData] = useState<IFornecedor | null>(null);
    const [searchTerm, setSearchTerm] = useState('');
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });

    useEffect(() => {
        loadFornecedores();
    }, []);

    const loadFornecedores = async () => {
        try {
            const response = await api.get('/fornecedor');
            setFornecedores(response.data);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao carregar lista de fornecedores.' });
        }
    };

    const handleUpdateFornecedor = async () => {
        if (!editData) return;
        try {
            await api.put(`/fornecedor/${editData.id_fornecedor}`, editData);
            setStatusMsg({ type: 'success', text: 'Dados atualizados com sucesso!' });
            loadFornecedores();
            setEditData(null);
            setTimeout(() => setStatusMsg({ type: null, text: '' }), 3000);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao salvar alterações.' });
        }
    };

    const handleDeleteFornecedor = async (id: number) => {
        if (!confirm('Deseja realmente remover este fornecedor?')) return;
        try {
            await api.delete(`/fornecedor/${id}`);
            setStatusMsg({ type: 'success', text: 'Fornecedor removido.' });
            loadFornecedores();
            if (editData?.id_fornecedor === id) setEditData(null);
            setTimeout(() => setStatusMsg({ type: null, text: '' }), 3000);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao deletar fornecedor.' });
        }
    };

    const filteredFornecedores = fornecedores.filter(f => 
        f.nome.toLowerCase().includes(searchTerm.toLowerCase()) || 
        (f.documento && f.documento.includes(searchTerm))
    );

    return (
        <div className="space-y-6 animate-in fade-in duration-500">
            <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({type: null, text: ''})} />

            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 className="text-2xl font-black text-neutral-900 tracking-tight">Gestão de Fornecedores</h1>
                    <p className="text-neutral-500">Cadastro de parceiros de peças.</p>
                </div>
                <Button 
                    onClick={() => setShowModal(true)}
                    className="shadow-xl shadow-black/10"
                >
                    <Plus size={20} /> Novo Fornecedor
                </Button>
            </div>

            <div className="flex flex-col md:flex-row gap-4 items-center bg-white p-4 rounded-2xl border border-neutral-100 shadow-sm">
                <div className="relative flex-1 group w-full">
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400 group-focus-within:text-orange-500 transition-colors" size={20} />
                    <input 
                        value={searchTerm} 
                        onChange={(e) => setSearchTerm(e.target.value)} 
                        placeholder="Buscar por nome ou documento..." 
                        className="w-full pl-12 pr-4 py-3 bg-neutral-50 border border-neutral-100 rounded-xl focus:ring-4 focus:ring-orange-500/10 outline-none font-bold"
                    />
                </div>
            </div>

            <div className="bg-white rounded-3xl shadow-sm border border-neutral-100 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead>
                        <tr className="bg-neutral-50 text-[10px] font-black text-neutral-400 uppercase tracking-widest">
                            <th className="p-6">Fornecedor</th>
                            <th className="p-6">Documento</th>
                            <th className="p-6">Contato</th>
                            <th className="p-6">Cadastro</th>
                            <th className="p-6 text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-50">
                        {filteredFornecedores.length === 0 ? (
                            <tr>
                                <td colSpan={5} className="p-20 text-center">
                                    <div className="flex flex-col items-center gap-4">
                                        <div className="bg-neutral-50 p-6 rounded-full text-neutral-200">
                                            <Store size={40} />
                                        </div>
                                        <p className="font-bold text-neutral-400">Nenhum fornecedor encontrado.</p>
                                    </div>
                                </td>
                            </tr>
                        ) : (
                            filteredFornecedores.map((f) => (
                                <tr key={f.id_fornecedor} className="hover:bg-neutral-50/50 transition-colors group">
                                    <td className="p-6">
                                        <div className="flex items-center gap-4">
                                            <div className="w-10 h-10 bg-orange-50 rounded-xl flex items-center justify-center text-orange-600 font-black">
                                                <Truck size={20} />
                                            </div>
                                            <div>
                                                <p className="font-black text-neutral-900">{f.nome}</p>
                                                <p className="text-[10px] font-bold text-neutral-400 uppercase">ID #{String(f.id_fornecedor).padStart(3, '0')}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td className="p-6">
                                        <p className="font-mono text-xs font-bold text-neutral-600 bg-neutral-100 px-2 py-1 rounded w-fit">
                                            {f.documento || 'N/A'}
                                        </p>
                                    </td>
                                    <td className="p-6">
                                        <div className="flex items-center gap-2 text-neutral-600 text-sm font-medium">
                                            <Phone size={14} className="text-neutral-400" />
                                            {f.contato || '-'}
                                        </div>
                                    </td>
                                    <td className="p-6">
                                        <div className="flex items-center gap-2 text-neutral-500 text-xs">
                                            <Calendar size={14} />
                                            {new Date(f.dt_cadastro).toLocaleDateString('pt-BR')}
                                        </div>
                                    </td>
                                    <td className="p-6 text-right">
                                        <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button 
                                                onClick={() => setEditData(f)}
                                                className="p-2 hover:bg-orange-50 text-orange-600 rounded-lg transition-colors"
                                                title="Editar"
                                            >
                                                <Edit size={18} />
                                            </button>
                                            <button 
                                                onClick={() => handleDeleteFornecedor(f.id_fornecedor)}
                                                className="p-2 hover:bg-red-50 text-red-600 rounded-lg transition-colors"
                                                title="Excluir"
                                            >
                                                <Trash2 size={18} />
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            {/* EDIT DRAWER */}
            {editData && (
                <div className="bg-neutral-900 p-8 rounded-3xl text-white shadow-2xl fixed inset-y-0 right-0 w-full md:w-[500px] z-50 animate-in slide-in-from-right duration-500 border-l border-neutral-800 overflow-y-auto">
                    <div className="flex justify-between items-start mb-6">
                        <div>
                            <h3 className="text-xl font-black flex items-center gap-3">
                                <Edit className="text-orange-500" /> Editando Fornecedor
                            </h3>
                            <p className="text-neutral-400 text-sm">Atualize os dados cadastrais.</p>
                        </div>
                        <button onClick={() => setEditData(null)} className="text-neutral-500 hover:text-white transition-colors">
                            <Plus size={24} className="rotate-45" />
                        </button>
                    </div>
                    
                    <div className="space-y-6 mb-8">
                        <div>
                            <label className="text-[10px] font-black text-neutral-500 uppercase block mb-2">Razão Social / Nome</label>
                            <input 
                                value={editData.nome} 
                                onChange={(e) => setEditData({...editData, nome: e.target.value})} 
                                className="w-full bg-neutral-800 border-none p-4 rounded-2xl focus:ring-2 focus:ring-orange-500 outline-none font-bold placeholder-neutral-600"
                            />
                        </div>
                        <div>
                            <label className="text-[10px] font-black text-neutral-500 uppercase block mb-2">Documento (CNPJ/CPF)</label>
                            <input 
                                value={editData.documento || ''} 
                                onChange={(e) => setEditData({...editData, documento: e.target.value})} 
                                className="w-full bg-neutral-800 border-none p-4 rounded-2xl focus:ring-2 focus:ring-orange-500 outline-none font-bold placeholder-neutral-600"
                            />
                        </div>
                        <div>
                            <label className="text-[10px] font-black text-neutral-500 uppercase block mb-2">Contato</label>
                            <input 
                                value={editData.contato || ''} 
                                onChange={(e) => setEditData({...editData, contato: e.target.value})} 
                                className="w-full bg-neutral-800 border-none p-4 rounded-2xl focus:ring-2 focus:ring-orange-500 outline-none font-bold placeholder-neutral-600"
                            />
                        </div>
                    </div>
                    
                    <button 
                        onClick={handleUpdateFornecedor} 
                        className="w-full bg-orange-600 text-white py-5 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-orange-700 transition-all flex items-center justify-center gap-2 active:scale-95 shadow-lg shadow-orange-900/20"
                    >
                        Salvar Alterações <BadgeCheck size={20} />
                    </button>
                </div>
            )}

            {showModal && (
                <Modal title="Novo Fornecedor" onClose={() => setShowModal(false)}>
                    <FornecedorForm 
                        onSuccess={() => {
                            setShowModal(false);
                            loadFornecedores();
                            setStatusMsg({ type: 'success', text: 'Fornecedor cadastrado com sucesso!' });
                            setTimeout(() => setStatusMsg({ type: null, text: '' }), 3000);
                        }}
                        onCancel={() => setShowModal(false)}
                    />
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\FuncionarioPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import type { IFuncionario } from '../types/backend';
import { FuncionarioForm } from '../components/forms/FuncionarioForm';
import { Modal } from '../components/ui/Modal';
import { Plus, Search, Trash2, Edit, Briefcase, BadgeCheck, XCircle, FileText, CheckCircle } from 'lucide-react';
import { StatusBanner } from '../components/ui/StatusBanner';

export const FuncionarioPage = () => {
    const [funcionarios, setFuncionarios] = useState<IFuncionario[]>([]);
    const [showModal, setShowModal] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    
    // Edit State
    const [editData, setEditData] = useState<IFuncionario | null>(null);
    const [editCargo, setEditCargo] = useState('');
    const [editSalario, setEditSalario] = useState('');
    const [editComissao, setEditComissao] = useState('');
    const [editAtivo, setEditAtivo] = useState('S');
    const [editObs, setEditObs] = useState('');
    const [editDtAdmissao, setEditDtAdmissao] = useState('');

    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });

    useEffect(() => {
        loadFuncionarios();
    }, []);

    const loadFuncionarios = async () => {
        try {
            const response = await api.get('/funcionario');
            setFuncionarios(response.data);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao carregar colaboradores.' });
        }
    };

    const handleOpenEdit = (funcionario: IFuncionario) => {
        setEditData(funcionario);
        setEditCargo(funcionario.cargo || '');
        setEditSalario(String(funcionario.salario || ''));
        setEditComissao(String(funcionario.comissao || ''));
        setEditAtivo(funcionario.ativo || 'S');
        setEditObs(funcionario.obs || '');
        setEditDtAdmissao(funcionario.dt_admissao ? new Date(funcionario.dt_admissao).toISOString().split('T')[0] : '');
    };

    const handleUpdate = async () => {
        if (!editData) return;
        try {
            await api.put(`/funcionario/${editData.id_funcionario}`, {
                 cargo: editCargo,
                 ativo: editAtivo,
                 salario: Number(editSalario),
                 comissao: Number(editComissao),
                 obs: editObs,
                 dt_admissao: editDtAdmissao ? new Date(editDtAdmissao).toISOString() : null
            });
            setStatusMsg({ type: 'success', text: 'Colaborador atualizado com sucesso!' });
            setTimeout(() => setStatusMsg({ type: null, text: '' }), 3000);
            loadFuncionarios();
            setEditData(null);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao atualizar colaborador.' });
        }
    };

    const handleDelete = async (id: number) => {
        if (!confirm('Tem certeza que deseja excluir este colaborador?')) return;
        try {
            await api.delete(`/funcionario/${id}`);
            setStatusMsg({ type: 'success', text: 'Colaborador removido com sucesso!' });
            setTimeout(() => setStatusMsg({ type: null, text: '' }), 3000);
            loadFuncionarios();
            if (editData?.id_funcionario === id) setEditData(null);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao remover colaborador. Verifique se há vínculos.' });
        }
    };

    // Filter by Name or ID
    const filteredFuncionarios = funcionarios.filter(f => {
        const name = f.pessoa_fisica?.pessoa?.nome?.toLowerCase() || '';
        const id = String(f.id_funcionario);
        const search = searchTerm.toLowerCase();
        return name.includes(search) || id.includes(search);
    });

    return (
        <div className="space-y-6 animate-in fade-in duration-500">
            <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({type: null, text: ''})} />

            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 className="text-2xl font-black text-neutral-900 tracking-tight">Equipe e Colaboradores</h1>
                    <p className="text-neutral-500">Gestão de colaboradores e acesso ao sistema.</p>
                </div>
                <button 
                    onClick={() => setShowModal(true)}
                    className="group bg-neutral-900 text-white px-6 py-3.5 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-primary-600 transition-all shadow-xl shadow-black/10 flex items-center gap-2 active:scale-95"
                >
                    <Plus size={20} className="group-hover:rotate-90 transition-transform" />
                    Novo Colaborador
                </button>
            </div>

            {/* QUICK SEARCH */}
            <div className="flex flex-col md:flex-row gap-4 items-center bg-white p-4 rounded-2xl border border-neutral-100 shadow-sm">
                <div className="relative flex-1 group w-full">
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400 group-focus-within:text-primary-500 transition-colors" size={20} />
                    <input 
                        value={searchTerm} 
                        onChange={(e) => setSearchTerm(e.target.value)} 
                        placeholder="Buscar por nome ou ID..." 
                        className="w-full pl-12 pr-4 py-3 bg-neutral-50 border border-neutral-100 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-bold placeholder:font-normal"
                    />
                </div>
            </div>

            {/* LIST */}
            <div className="bg-white rounded-3xl shadow-sm border border-neutral-100 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead>
                        <tr className="bg-neutral-50 text-[10px] font-black text-neutral-400 uppercase tracking-widest">
                            <th className="p-6">Colaborador</th>
                            <th className="p-6">Cargo</th>
                            <th className="p-6">Admissão</th>
                            <th className="p-6">Status</th>
                            <th className="p-6 text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-50">
                        {filteredFuncionarios.length === 0 ? (
                            <tr>
                                <td colSpan={5} className="p-20 text-center">
                                    <div className="flex flex-col items-center gap-4">
                                        <div className="bg-neutral-50 p-6 rounded-full text-neutral-200">
                                            <Briefcase size={40} />
                                        </div>
                                        <p className="font-bold text-neutral-400">Nenhum colaborador encontrado.</p>
                                    </div>
                                </td>
                            </tr>
                        ) : (
                            filteredFuncionarios.map((f: IFuncionario) => (
                                <tr key={f.id_funcionario} className="hover:bg-neutral-50/50 transition-colors group">
                                    <td className="p-6">
                                        <div className="flex items-center gap-4">
                                            <div className="w-10 h-10 bg-primary-100 rounded-xl flex items-center justify-center text-primary-600 font-black">
                                                {f.pessoa_fisica?.pessoa?.nome?.charAt(0)}
                                            </div>
                                            <div>
                                                <p className="font-black text-neutral-900">{f.pessoa_fisica?.pessoa?.nome}</p>
                                                <p className="text-[10px] font-bold text-neutral-400 uppercase">#{String(f.id_funcionario).padStart(3, '0')}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td className="p-6">
                                        <p className="font-bold text-neutral-600">{f.cargo}</p>
                                    </td>
                                    <td className="p-6">
                                        <p className="text-sm font-medium text-neutral-500">
                                            {f.dt_admissao ? new Date(f.dt_admissao).toLocaleDateString() : '-'}
                                        </p>
                                    </td>
                                    <td className="p-6">
                                        {f.ativo === 'S' ? (
                                            <span className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-success-50 text-success-700 rounded-lg text-[10px] font-black uppercase">
                                                <BadgeCheck size={14} /> Ativo
                                            </span>
                                        ) : (
                                            <span className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-50 text-red-700 rounded-lg text-[10px] font-black uppercase">
                                                <XCircle size={14} /> Inativo
                                            </span>
                                        )}
                                    </td>
                                    <td className="p-6 text-right">
                                        <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button 
                                                onClick={() => handleOpenEdit(f)}
                                                className="p-2 hover:bg-primary-50 text-primary-600 rounded-lg transition-colors"
                                            >
                                                <Edit size={18} />
                                            </button>
                                            <button 
                                                onClick={() => handleDelete(f.id_funcionario)}
                                                className="p-2 hover:bg-red-50 text-red-600 rounded-lg transition-colors"
                                            >
                                                <Trash2 size={18} />
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            {/* EDIT MODAL STANDARD */}
            {editData && (
                <Modal title={`Editando: ${editData.pessoa_fisica?.pessoa?.nome}`} onClose={() => setEditData(null)} className="max-w-4xl">
                    <div className="space-y-6">
                         {/* INFO HEADER */}
                         <div className="bg-primary-50 p-4 rounded-2xl flex items-center gap-4 border border-primary-100">
                            <div className="w-12 h-12 bg-primary-500 rounded-xl flex items-center justify-center text-white font-black text-xl shadow-lg shadow-primary-500/30">
                                {editData.pessoa_fisica?.pessoa?.nome?.charAt(0)}
                            </div>
                            <div>
                                <h4 className="font-black text-primary-900 text-lg">{editData.pessoa_fisica?.pessoa?.nome}</h4>
                                <p className="text-sm text-primary-700 font-medium">CPF: {editData.pessoa_fisica?.cpf || 'Não informado'}</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                             {/* Coluna 1: Dados do Cargo */}
                             <div className="space-y-4">
                                <h3 className="text-xs font-black text-neutral-400 uppercase tracking-widest flex items-center gap-2">
                                    <Briefcase size={14} /> Dados Contratuais
                                </h3>
                                <div>
                                    <label className="text-[10px] font-black text-neutral-500 uppercase block mb-1">Cargo</label>
                                    <input 
                                        value={editCargo} 
                                        onChange={(e) => setEditCargo(e.target.value)} 
                                        className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-bold" 
                                    />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-[10px] font-black text-neutral-500 uppercase block mb-1">Pagamento (R$)</label>
                                        <input 
                                            type="number"
                                            value={editSalario} 
                                            onChange={(e) => setEditSalario(e.target.value)} 
                                            className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-bold" 
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-neutral-500 uppercase block mb-1">Comissão (%)</label>
                                        <input 
                                            type="number"
                                            value={editComissao} 
                                            onChange={(e) => setEditComissao(e.target.value)} 
                                            className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-bold" 
                                        />
                                    </div>
                                </div>
                             </div>

                             {/* Coluna 2: Status e Data */}
                             <div className="space-y-4">
                                 <h3 className="text-xs font-black text-neutral-400 uppercase tracking-widest flex items-center gap-2">
                                     <BadgeCheck size={14} /> Status e Admissão
                                 </h3>
                                 <div>
                                    <label className="text-[10px] font-black text-neutral-500 uppercase block mb-1">Status do Colaborador</label>
                                    <select 
                                        value={editAtivo}
                                        onChange={(e) => setEditAtivo(e.target.value)}
                                        className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-bold text-primary-600"
                                    >
                                        <option value="S">ATIVO</option>
                                        <option value="N">INATIVO</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-[10px] font-black text-neutral-500 uppercase block mb-1">Data de Admissão</label>
                                    <input 
                                        type="date"
                                        value={editDtAdmissao} 
                                        onChange={(e) => setEditDtAdmissao(e.target.value)} 
                                        className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-bold" 
                                    />
                                </div>
                             </div>

                             {/* Obs - Full Width */}
                             <div className="col-span-1 md:col-span-2 space-y-4">
                                 <h3 className="text-xs font-black text-neutral-400 uppercase tracking-widest flex items-center gap-2">
                                     <FileText size={14} /> Observações
                                 </h3>
                                 <textarea 
                                    value={editObs} 
                                    onChange={(e) => setEditObs(e.target.value)} 
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl focus:ring-4 focus:ring-primary-500/10 focus:border-primary-500 outline-none font-medium text-neutral-800 min-h-[100px] resize-none" 
                                    placeholder="Observações internas..."
                                />
                             </div>
                        </div>

                        <div className="flex justify-end gap-3 pt-4 border-t border-neutral-100">
                             <button 
                                onClick={() => setEditData(null)}
                                className="px-6 py-3 rounded-xl font-bold text-neutral-500 hover:bg-neutral-50 transition-colors uppercase text-xs"
                            >
                                Cancelar
                            </button>
                            <button 
                                onClick={handleUpdate}
                                className="px-8 py-3 bg-neutral-900 text-white rounded-xl font-black uppercase text-xs hover:bg-primary-600 transition-all shadow-lg flex items-center gap-2"
                            >
                                <CheckCircle size={16} /> Salvar Alterações
                            </button>
                        </div>
                    </div>
                </Modal>
            )}

            {showModal && (
                <Modal title="Novo Colaborador" onClose={() => setShowModal(false)}>
                    <FuncionarioForm 
                        onSuccess={() => {
                            setShowModal(false);
                            loadFuncionarios();
                        }}
                        onCancel={() => setShowModal(false)}
                    />
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\HomePage.tsx
================================================================================
import { useEffect, useState } from 'react';
import { Plus } from 'lucide-react';
import { api } from '../services/api';
import { useNavigate } from 'react-router-dom';

const StatCard = ({ title, value, color, onClick, subtext }: any) => (
  <div 
    onClick={onClick}
    className={`bg-white p-6 rounded-2xl shadow-sm border border-neutral-100 cursor-pointer hover:shadow-md hover:-translate-y-1 transition-all duration-300 group`}
  >
    <div className="flex flex-col justify-between h-full items-center text-center">
       <div>
         <p className="text-[10px] font-black text-neutral-400 uppercase tracking-widest mb-2">{title}</p>
         <h3 className={`text-4xl font-black ${color.replace('bg-', 'text-')}`}>{value}</h3>
       </div>
       {subtext && <div className="mt-4 pt-4 border-t border-neutral-50 w-full">
           <p className="text-[10px] text-neutral-400 font-bold uppercase">{subtext}</p>
       </div>}
    </div>
  </div>
);

export function HomePage() {
  const navigate = useNavigate();
  const [recentOss, setRecentOss] = useState<any[]>([]);
  const [filterPeriod, setFilterPeriod] = useState<'HOJE' | 'SEMANA' | 'MES' | 'STATUS'>('HOJE');
  
  const [stats, setStats] = useState({
    osAberta: 0,
    contasPagar: 0,
    livroCaixaEntries: 0,
    livroCaixaExits: 0,
    autoPecasPendentes: 0,
    consolidacao: 0
  });

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    try {
      const [osRes, contasRes, pagPecaRes, pagCliRes] = await Promise.all([
        api.get('/ordem-de-servico'),
        api.get('/contas-pagar'),
        api.get('/pagamento-peca'),
        api.get('/pagamento-cliente')
      ]);

      const oss = osRes.data;
      const contas = contasRes.data;
      const pagPecas = pagPecaRes.data;
      const pagClients = pagCliRes.data;

      // 1. Serviços em Aberto
      const osAberta = oss.filter((o: any) => o.status === 'ABERTA' || o.status === 'EM_ANDAMENTO').length;
      
      // 2. Contas a Pagar (Geral) -> Status PENDENTE
      const contasPagar = contas.filter((c: any) => c.status === 'PENDENTE').length;

      // Robust matcher for local date string match (ignores timezone shifts from DB midnight)
      const isToday = (dateStr: string) => {
          if (!dateStr) return false;
          // Create Date object from ISO string (e.g. 2026-01-04T02:00:00Z)
          const date = new Date(dateStr);
          // Get local date string YYYY-MM-DD (e.g. 2026-01-03)
          const localDateStr = date.toLocaleDateString('en-CA');
          
          const todayStr = new Date().toLocaleDateString('en-CA');
          return localDateStr === todayStr;
      };

      const todayEntries = pagClients.filter((p: any) => isToday(p.data_pagamento) && !p.deleted_at).length;
      
      const todayExits = pagPecas.filter((p: any) => {
          if (!p.pago_ao_fornecedor) return false;
          if (!p.data_pagamento_fornecedor) return false;
          return isToday(p.data_pagamento_fornecedor) && !p.deleted_at;
      }).length;

      // 4. Auto Peças (Pecas não pagas ao fornecedor)
      const autoPecasPendentes = pagPecas.filter((p: any) => !p.pago_ao_fornecedor && !p.deleted_at).length;

      // 5. Consolidação (OS Pronta para Financeiro E SEM Fechamento)
      const consolidacao = oss.filter((o: any) => o.status === 'PRONTO PARA FINANCEIRO' && !o.fechamento_financeiro).length;

      setStats({
          osAberta,
          contasPagar,
          livroCaixaEntries: todayEntries,
          livroCaixaExits: todayExits,
          autoPecasPendentes,
          consolidacao
      });

      setRecentOss(oss);

    } catch (error) {
      console.error('Erro ao carregar dados', error);
    }
  };

  const getFilteredRecentServices = () => {
      const now = new Date();
      const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      let filtered = recentOss;

      // 1. Filter Logic
      if (filterPeriod !== 'STATUS') {
          filtered = recentOss.filter(os => {
            const dateRef = os.updated_at ? new Date(os.updated_at) : new Date(os.dt_abertura);
            if (filterPeriod === 'HOJE') {
                if (os.status === 'ABERTA') return true;
                return dateRef >= startOfToday;
            } else if (filterPeriod === 'SEMANA') {
                const weekAgo = new Date(startOfToday);
                weekAgo.setDate(startOfToday.getDate() - 7);
                if (os.status === 'ABERTA') return true;
                return dateRef >= weekAgo;
            } else { // MES
                const firstDayMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                if (os.status === 'ABERTA') return true;
                return dateRef >= firstDayMonth;
            }
          });
      }

      // 2. Sort Logic
      return filtered.sort((a,b) => {
          if (filterPeriod === 'STATUS') {
              const priority: Record<string, number> = {
                  'ABERTA': 1, 'EM_ANDAMENTO': 1,
                  'PRONTO PARA FINANCEIRO': 2,
                  'finalizada': 3, 'FINALIZADA': 3, 
                  'PAGA_CLIENTE': 4
              };
              const pA = priority[a.status] || 99;
              const pB = priority[b.status] || 99;
              if (pA !== pB) return pA - pB;
          }
          // Date Sort (Secondary for STATUS, Primary for others)
          const dateA = a.updated_at ? new Date(a.updated_at).getTime() : new Date(a.dt_abertura).getTime();
          const dateB = b.updated_at ? new Date(b.updated_at).getTime() : new Date(b.dt_abertura).getTime();
          return dateB - dateA;
      });
  };

  const getStatusStyle = (status: string) => {
    switch (status) {
      case 'FINALIZADA': return 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200';
      case 'PAGA_CLIENTE': return 'bg-neutral-100 text-neutral-600 ring-1 ring-neutral-200';
      case 'PRONTO PARA FINANCEIRO': return 'bg-amber-100 text-amber-700 ring-1 ring-amber-200';
      case 'ABERTA': return 'bg-blue-100 text-blue-700 ring-1 ring-blue-200';
      case 'EM_ANDAMENTO': return 'bg-cyan-100 text-cyan-700 ring-1 ring-cyan-200';
      default: return 'bg-gray-50 text-gray-500 ring-1 ring-gray-200';
    }
  };

  const filteredServices = getFilteredRecentServices();

  return (
    <div className="space-y-8 animate-in fade-in duration-500">
      <div className="flex justify-between items-center">
        <div>
            <h1 className="text-2xl font-black text-neutral-900 tracking-tight">Visão Geral</h1>
            <p className="text-neutral-500">Acompanhamento diário da oficina.</p>
        </div>
        <span className="text-sm font-bold text-neutral-400 bg-neutral-100 px-3 py-1 rounded-lg uppercase">{new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}</span>
      </div>

      {/* Stats Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <StatCard 
            title="Serviços Abertos" 
            value={stats.osAberta} 
            color="bg-blue-500" 
            onClick={() => navigate('/ordem-de-servico')}
            subtext="Em produção"
        />
        <StatCard 
            title="Contas a Pagar" 
            value={stats.contasPagar} 
            color="bg-red-500" 
            onClick={() => navigate('/financeiro/contas-pagar')}
            subtext="Geral / Fixas"
        />
        <StatCard 
            title="Movimentação de Caixa" 
            value={stats.livroCaixaEntries + stats.livroCaixaExits} 
            color="bg-neutral-900" 
            onClick={() => navigate('/financeiro/livro-caixa')}
            subtext={`Ent: ${stats.livroCaixaEntries}  |  Sai: ${stats.livroCaixaExits}`}
        />
        <StatCard 
            title="Auto Peças" 
            value={stats.autoPecasPendentes} 
            color="bg-orange-500" 
            onClick={() => navigate('/financeiro/pagamento-pecas')}
            subtext="Pendentes Pagto"
        />
        <StatCard 
            title="Consolidação" 
            value={stats.consolidacao} 
            color="bg-emerald-500" 
            onClick={() => navigate('/fechamento-financeiro')}
            subtext="Aguardando Financ."
        />
      </div>

      {/* Shortcuts */}
      <div className="flex items-center gap-4">
            <button 
                onClick={() => navigate('/ordem-de-servico?new=true')} 
                className="bg-neutral-900 hover:bg-black text-white px-8 py-4 rounded-xl font-black text-sm uppercase tracking-wide flex items-center gap-3 shadow-xl shadow-neutral-900/20 transition-all hover:-translate-y-1 hover:shadow-2xl"
            >
                <Plus size={22} /> Nova Ordem de Serviço
            </button>
      </div>

      {/* Recent Services - FULL WIDTH */}
      <div className="bg-white rounded-2xl shadow-sm border border-neutral-100 overflow-hidden">
        <div className="p-6 border-b border-neutral-100 flex flex-col sm:flex-row justify-between items-center gap-4">
            <h2 className="text-lg font-black text-neutral-900 tracking-tight">Ordens de Serviços Recentes</h2>
            
            {/* Date Tabs */}
            <div className="flex bg-neutral-100 p-1 rounded-xl">
                {['HOJE', 'SEMANA', 'MES', 'STATUS'].map((p) => (
                    <button
                        key={p}
                        onClick={() => setFilterPeriod(p as any)}
                        className={`px-4 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all ${filterPeriod === p ? 'bg-white text-neutral-900 shadow-sm' : 'text-neutral-500 hover:text-neutral-700'}`}
                    >
                        {p === 'MES' ? 'Mês' : p}
                    </button>
                ))}
            </div>
        </div>
        
        <div className="overflow-x-auto">
        <table className="w-full text-left">
            <thead className="bg-neutral-50 border-b border-neutral-100">
            <tr>
                <th className="p-4 text-[10px] font-black uppercase text-neutral-400 tracking-widest">OS / Data</th>
                <th className="p-4 text-[10px] font-black uppercase text-neutral-400 tracking-widest">Veículo</th>
                <th className="p-4 text-[10px] font-black uppercase text-neutral-400 tracking-widest">Diagnóstico</th>
                <th className="p-4 text-[10px] font-black uppercase text-neutral-400 tracking-widest">Colaborador</th>
                <th className="p-4 text-[10px] font-black uppercase text-neutral-400 tracking-widest">Cliente</th>
                <th className="p-4 text-[10px] font-black uppercase text-neutral-400 tracking-widest text-center">Status</th>
                <th className="p-4 text-[10px] font-black uppercase text-neutral-400 tracking-widest text-right">Ações</th>
            </tr>
            </thead>
            <tbody className="divide-y divide-neutral-50">
            {filteredServices.length === 0 ? (
                <tr>
                <td colSpan={5} className="p-12 text-center text-neutral-400 font-medium italic">
                    Nenhuma atualização neste período.
                </td>
                </tr>
            ) : (
                filteredServices.map((os: any) => (
                <tr 
                    key={os.id_os} 
                    onClick={() => navigate(os.status === 'PRONTO PARA FINANCEIRO' ? `/fechamento-financeiro?id_os=${os.id_os}` : `/ordem-de-servico?id=${os.id_os}`)}
                    className="hover:bg-neutral-25 cursor-pointer transition-colors group"
                >
                    <td className="p-4">
                        <div className="font-black text-neutral-800">#{os.id_os}</div>
                        <div className="text-[10px] text-neutral-400 font-bold">{new Date(os.dt_abertura).toLocaleDateString()}</div>
                    </td>
                    <td className="p-4">
                        <div className="flex flex-col">
                            <span className="font-bold text-neutral-700 uppercase text-xs">
                                {os.veiculo?.modelo || 'Modelo N/I'} {os.veiculo?.cor ? os.veiculo.cor : ''}
                            </span>
                            <span className="text-[10px] font-black text-neutral-400 uppercase">
                                {os.veiculo?.placa || '---'}
                            </span>
                        </div>
                    </td>
                    <td className="p-4 max-w-[250px]">
                        <p className="text-xs font-medium text-neutral-600 line-clamp-1">
                            {os.diagnostico || os.defeito_relatado || <span className="text-neutral-300 italic">---</span>}
                        </p>
                    </td>
                    <td className="p-4">
                        <p className="text-[10px] font-bold text-neutral-600 uppercase">
                            {(() => {
                                // @ts-ignore
                                const mechanics = os.servicos_mao_de_obra?.map(s => s.funcionario?.pessoa_fisica?.pessoa?.nome?.split(' ')[0]).filter(Boolean);
                                const uniqueMechanics = [...new Set(mechanics || [])];
                                if (uniqueMechanics.length > 0) return uniqueMechanics.join(', ');
                                return <span className="text-neutral-300">---</span>;
                            })()}
                        </p>
                    </td>
                    <td className="p-4">
                        <div className="font-bold text-neutral-700 text-xs truncate max-w-[150px]">
                            {os.cliente?.pessoa_fisica?.pessoa?.nome || os.cliente?.pessoa_juridica?.razao_social}
                        </div>
                        <div className="text-[10px] text-neutral-400 font-medium">
                            {os.cliente?.telefone_1 || ''}
                        </div>
                    </td>
                    <td className="p-4 text-center">
                        <span className={`px-3 py-1 rounded-md text-[10px] font-black uppercase whitespace-nowrap ${getStatusStyle(os.status)}`}>
                            {os.status.replace(/_/g, ' ')}
                        </span>
                    </td>
                    <td className="p-4 text-right">
                        <button 
                            onClick={(e) => {
                                e.stopPropagation(); // Prevent row click
                                navigate(`/ordem-de-servico?id=${os.id_os}`);
                            }}
                            className="bg-neutral-900 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase hover:bg-black transition-transform hover:scale-105 shadow-md shadow-neutral-900/20"
                        >
                            Gerenciar
                        </button>
                    </td>
                </tr>
                ))
            )}
            </tbody>
        </table>
        </div>
      </div>
    </div>
  );
}


================================================================================
FILE PATH: client\src\pages\ItensOsPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import type { IItensOs } from '../types/backend';
import { ItensOsForm } from '../components/forms/ItensOsForm';
import { Modal } from '../components/ui/Modal';
import { Plus, Search, Trash2, Edit, Package } from 'lucide-react';

export const ItensOsPage = () => {
    const [itens, setItens] = useState<IItensOs[]>([]);
    const [showModal, setShowModal] = useState(false);
    const [searchId, setSearchId] = useState('');
    const [editData, setEditData] = useState<IItensOs | null>(null);
    const [selectedOsId, setSelectedOsId] = useState<number | null>(null);

    useEffect(() => {
        loadItens();
    }, []);

    const loadItens = async () => {
        try {
            const response = await api.get('/itens-os');
            setItens(response.data);
        } catch (error) {
            alert('Erro ao carregar itens');
        }
    };

    const handleSearch = async () => {
        try {
            const response = await api.get(`/itens-os/${searchId}`);
            setEditData(response.data);
        } catch (error) {
            alert('Item não encontrado');
            setEditData(null);
        }
    };

    const handleUpdate = async () => {
        if (!editData) return;
        try {
            await api.put(`/itens-os/${editData.id_iten}`, editData);
            alert('Item atualizado!');
            loadItens();
        } catch (error) {
            alert('Erro ao atualizar item');
        }
    };

    const handleDelete = async () => {
        if (!searchId) return;
        try {
            await api.delete(`/itens-os/${searchId}`);
            alert('Item deletado!');
            loadItens();
            setEditData(null);
            setSearchId('');
        } catch (error) {
            alert('Erro ao deletar item');
        }
    };

    const openCreateModal = () => {
        const osId = prompt('Digite o ID da OS para adicionar item:');
        if (osId) {
            setSelectedOsId(Number(osId));
            setShowModal(true);
        }
    };

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-2xl font-bold text-slate-800">Itens de Ordem de Serviço</h1>
                    <p className="text-slate-500">Peças e serviços aplicados nas OS.</p>
                </div>
                <button 
                    onClick={openCreateModal}
                    className="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2.5 rounded-lg font-medium shadow-sm transition-all"
                >
                    <Plus size={20} />
                    Novo Item
                </button>
            </div>

            {/* LIST */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">ID</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">OS</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Descrição</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Qtd</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Valor Unit.</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Total</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {itens.map((item) => (
                            <tr key={item.id_iten} className="hover:bg-slate-50">
                                <td className="p-4 text-gray-500 font-mono">#{item.id_iten}</td>
                                <td className="p-4 text-slate-600">OS #{item.id_os}</td>
                                <td className="p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-green-50 p-2 rounded-lg text-green-600">
                                            <Package size={18} />
                                        </div>
                                        <div>
                                            <div className="font-medium text-slate-900">{item.descricao}</div>
                                            {item.id_pecas_estoque && <div className="text-xs text-slate-500">Peça ID: {item.id_pecas_estoque}</div>}
                                        </div>
                                    </div>
                                </td>
                                <td className="p-4 text-slate-700 font-bold">{item.quantidade}</td>
                                <td className="p-4 text-slate-700">R$ {Number(item.valor_venda).toFixed(2)}</td>
                                <td className="p-4 text-green-700 font-bold">R$ {Number(item.valor_total).toFixed(2)}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* MANAGE */}
            <div className="bg-white p-4 rounded-xl border border-gray-200">
                <h2 className="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Manutenção de Item (Por ID)</h2>
                <div className="flex gap-4 mb-4">
                    <input 
                        type="number" 
                        value={searchId} 
                        onChange={(e) => setSearchId(e.target.value)} 
                        placeholder="Digite o ID do Item..." 
                        className="border p-2 rounded w-64"
                    />
                    <button onClick={handleSearch} className="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                        <Search size={18} /> Localizar
                    </button>
                    {searchId && <button onClick={handleDelete} className="flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200">
                        <Trash2 size={18} /> Excluir
                    </button>}
                </div>

                {editData && (
                    <div className="bg-slate-50 p-4 rounded border animate-in fade-in">
                        <h3 className="font-bold mb-2">Editando: {editData.descricao}</h3>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="col-span-2">
                                <label className="text-xs font-bold block mb-1">Descrição</label>
                                <input 
                                    value={editData.descricao} 
                                    onChange={(e) => setEditData({...editData, descricao: e.target.value})} 
                                    className="border p-2 w-full rounded" 
                                />
                            </div>
                            <div>
                                <label className="text-xs font-bold block mb-1">Quantidade</label>
                                <input 
                                    type="number"
                                    value={editData.quantidade} 
                                    onChange={(e) => setEditData({...editData, quantidade: Number(e.target.value)})} 
                                    className="border p-2 w-full rounded" 
                                />
                            </div>
                        </div>
                        <button onClick={handleUpdate} className="flex items-center gap-2 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">
                            <Edit size={18} /> Salvar Alterações
                        </button>
                    </div>
                )}
            </div>

            {showModal && selectedOsId && (
                <Modal title="Novo Item na OS" onClose={() => setShowModal(false)}>
                    <ItensOsForm 
                        osId={selectedOsId}
                        onSuccess={() => {
                            setShowModal(false);
                            loadItens();
                        }}
                        onCancel={() => setShowModal(false)}
                    />
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\LivroCaixaPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import { 
    Plus, Search, ArrowUpCircle, ArrowDownCircle, 
    Calendar, Trash2, Edit2, 
    X, AlertTriangle, Wallet, Settings
} from 'lucide-react';
import { StatusBanner } from '../components/ui/StatusBanner';
import { CategoryManager } from '../components/financeiro/CategoryManager';

interface CashBookEntry {
    id: string; // 'man-1', 'in-5', 'out-10' (prefix to identify source)
    rawId: number;
    date: string; // ISO date string
    description: string;
    type: 'IN' | 'OUT';
    value: number;
    category: string;
    vehicle?: string;
    client?: string;
    supplier?: string; // New field
    obs?: string;
    source: 'MANUAL' | 'AUTO';
    deleted_at?: string | null;
    originalData?: any;
}

interface Category {
    id_categoria: number;
    nome: string;
    tipo: string;
}

export const LivroCaixaPage = () => {
    const [cashBookEntries, setCashBookEntries] = useState<CashBookEntry[]>([]);

    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });
    
    // Filters
    const [cashSearch, setCashSearch] = useState('');
    const [cashFilterStart, setCashFilterStart] = useState(new Date().toLocaleDateString('en-CA'));
    const [cashFilterEnd, setCashFilterEnd] = useState(new Date().toLocaleDateString('en-CA'));
    const [filterSource, setFilterSource] = useState<'ALL' | 'MANUAL' | 'AUTO'>('ALL');
    const [filterCategory, setFilterCategory] = useState<string>('ALL');

    // Modals
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
    const [editingItem, setEditingItem] = useState<CashBookEntry | null>(null);
    const [itemToDelete, setItemToDelete] = useState<CashBookEntry | null>(null);
    const [deleteObs, setDeleteObs] = useState('');
    
    // Category Management
    const [categories, setCategories] = useState<Category[]>([]);
    const [isCategoryModalOpen, setIsCategoryModalOpen] = useState(false);

    // Form
    const [formData, setFormData] = useState({
        descricao: '',
        valor: '',
        tipo_movimentacao: 'ENTRADA',
        categoria: 'OUTROS',
        obs: ''
    });

    useEffect(() => {
        loadData();
        loadCategories();
    }, []);

    const loadCategories = async () => {
        try {
            const res = await api.get('/categoria-financeira');
            setCategories(res.data);
        } catch (error) {
            console.error(error);
        }
    };

    const loadData = async () => {
        try {

            const [manualRes, paymentsRes, inflowsRes] = await Promise.all([
                api.get('/livro-caixa'),
                api.get('/pagamento-peca'), // Outflows
                api.get('/pagamento-cliente') // Inflows
            ]);

            // 1. Manual Entries
            const manual = manualRes.data.map((e: any) => ({
                id: `man-${e.id_livro_caixa}`,
                rawId: e.id_livro_caixa,
                date: e.dt_movimentacao,
                description: e.descricao,
                type: e.tipo_movimentacao === 'ENTRADA' ? 'IN' : 'OUT',
                value: Number(e.valor),
                category: e.categoria,
                obs: e.obs,
                source: e.origem === 'AUTOMATICA' ? 'AUTO' : 'MANUAL',
                deleted_at: e.deleted_at,
                originalData: e
            }));

            // 2. Auto Outflows (Payments to Suppliers)
            const outflows = paymentsRes.data
                .filter((p: any) => (p.pago_ao_fornecedor && p.data_pagamento_fornecedor) || p.deleted_at) // Include soft deleted!
                .map((p: any) => {
                    const os = p.item_os?.ordem_de_servico;
                    const veh = os?.veiculo;
                    const cli = os?.cliente;
                    const clientName = cli?.pessoa_fisica?.pessoa?.nome || cli?.pessoa_juridica?.nome_fantasia || cli?.pessoa_juridica?.razao_social || 'Desconhecido';
                    const vehicleText = veh ? `${veh.placa} - ${veh.modelo} (${veh.cor})` : '';
                    const supplierName = p.fornecedor?.nome || 'Fornecedor';

                    return {
                        id: `out-${p.id_pagamento_peca}`,
                        rawId: p.id_pagamento_peca,
                        date: p.data_pagamento_fornecedor || p.data_compra,
                        description: `OS #${p.item_os?.id_os || '?'} - ${veh?.modelo || 'V'} ${veh?.cor || ''} (${veh?.placa || '?'}) - ${p.item_os?.descricao || 'Peça'}`,
                        type: 'OUT',
                        value: Number(p.custo_real),
                        category:  'Auto Peças', // Implicit category
                        vehicle: vehicleText,
                        client: clientName,
                        supplier: supplierName, // Added Supplier
                        obs: '',
                        source: 'AUTO',
                        deleted_at: p.deleted_at,
                        originalData: p
                    };
                });

            // 3. Auto Inflows (Payments from Clients)
            const inflows = (inflowsRes.data || []).map((p: any) => {
                const os = p.ordem_de_servico;
                const veh = os?.veiculo;
                const cli = os?.cliente;
                const clientName = cli?.pessoa_fisica?.pessoa?.nome || cli?.pessoa_juridica?.nome_fantasia || cli?.pessoa_juridica?.razao_social || 'Desconhecido';
                const vehicleText = veh ? `${veh.placa} - ${veh.modelo} (${veh.cor})` : '';

                return {
                    id: `in-${p.id_pagamento_cliente}`,
                    rawId: p.id_pagamento_cliente,
                    date: p.data_pagamento,
                    description: `Recebimento: OS #${p.id_os}`,
                    type: 'IN',
                    value: Number(p.valor),
                    category: 'Receita de Serviços', // Implicit category
                    vehicle: vehicleText,
                    client: clientName,
                    obs: p.observacao || '', 
                    source: 'AUTO',
                    deleted_at: p.deleted_at,
                    originalData: p
                };
            });

            const combined = [...manual, ...outflows, ...inflows].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
            setCashBookEntries(combined);

        } catch (error) {
            console.error(error);
            setStatusMsg({ type: 'error', text: 'Erro ao carregar dados financeiros.' });
        }
    };

    // Filter Logic
    const filteredCashBook = cashBookEntries.filter(entry => {
        // 0. Manual/Auto Filter
        if (filterSource !== 'ALL') {
             if (filterSource !== entry.source) return false;
        }

        // 0.1 Category Filter
        if (filterCategory !== 'ALL') {
             if (entry.category !== filterCategory) return false;
        }

        // 1. Search overrides date filters
        if (cashSearch) {
             const searchLower = cashSearch.toLowerCase();
             const searchableText = [
                 entry.description, 
                 entry.category, 
                 entry.vehicle,
                 entry.client,
                 entry.obs,
                 `#${entry.rawId}`,
                 String(entry.value)
             ].join(' ').toLowerCase();

             return searchableText.includes(searchLower);
        }

        // 2. Date Filters
        const recordDateLocal = new Date(entry.date).toLocaleDateString('en-CA');
        if (cashFilterStart && recordDateLocal < cashFilterStart) return false;
        if (cashFilterEnd && recordDateLocal > cashFilterEnd) return false;
        
        return true;
    });

    const totalInflow = filteredCashBook.filter(e => e.type === 'IN' && !e.deleted_at).reduce((acc, e) => acc + e.value, 0);
    const totalOutflow = filteredCashBook.filter(e => e.type === 'OUT' && !e.deleted_at).reduce((acc, e) => acc + e.value, 0);
    const balance = totalInflow - totalOutflow;

    const applyQuickFilter = (type: 'TODAY' | 'WEEK' | 'MONTH') => {
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];
        if (type === 'TODAY') {
            setCashFilterStart(todayStr);
            setCashFilterEnd(todayStr);
        } else if (type === 'WEEK') {
             const weekAgo = new Date(now);
             weekAgo.setDate(now.getDate() - 7);
             setCashFilterStart(weekAgo.toISOString().split('T')[0]);
             setCashFilterEnd(todayStr);
        } else if (type === 'MONTH') {
             const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
             setCashFilterStart(firstDay.toISOString().split('T')[0]);
             setCashFilterEnd(todayStr);
        }
    };

    // CRUD Handlers
    const handleOpenCreate = () => {
        setEditingItem(null);
        setFormData({ 
            descricao: '', 
            valor: '', 
            tipo_movimentacao: 'ENTRADA', 
            categoria: 'OUTROS', 
            obs: '' 
        });
        setIsModalOpen(true);
    };

    const handleOpenEdit = (entry: any) => {
        setEditingItem(entry);
        // Map fields based on source
        if (entry.source === 'MANUAL') {
             setFormData({
                descricao: entry.originalData.descricao,
                valor: entry.originalData.valor,
                tipo_movimentacao: entry.originalData.tipo_movimentacao,
                categoria: entry.originalData.categoria,
                obs: entry.originalData.obs || ''
            });
        } else if (entry.source === 'AUTO') {
             setFormData({
                descricao: entry.description, 
                valor: entry.originalData.custo_real || entry.originalData.valor, 
                tipo_movimentacao: entry.type === 'IN' ? 'ENTRADA' : 'SAIDA',
                categoria: entry.category,
                obs: entry.obs
             });
        }
       
        setIsModalOpen(true);
    };

    const handleOpenDelete = (entry: any) => {
        setItemToDelete(entry);
        setDeleteObs('');
        setIsDeleteModalOpen(true);
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            if (editingItem) {
                // Determine Endpoint based on ID prefix
                if (editingItem.id.startsWith('man-')) {
                     await api.put(`/livro-caixa/${editingItem.rawId}`, formData);
                } else if (editingItem.id.startsWith('in-')) {
                     await api.put(`/pagamento-cliente/${editingItem.rawId}`, { 
                         valor: formData.valor,
                     });
                } else if (editingItem.id.startsWith('out-')) {
                     await api.put(`/pagamento-peca/${editingItem.rawId}`, {
                         custo_real: formData.valor
                     });
                }
                setStatusMsg({ type: 'success', text: 'Lançamento atualizado!' });
            } else {
                // Create (Always Manual)
                await api.post('/livro-caixa', { ...formData, origem: 'MANUAL' });
                setStatusMsg({ type: 'success', text: 'Lançamento criado!' });
            }
            setIsModalOpen(false);
            loadData();
        } catch (err) {
            console.error(err);
            setStatusMsg({ type: 'error', text: 'Erro ao salvar lançamento.' });
        }
    };

    const handleDelete = async () => {
        if (!itemToDelete) return;
        try {
            if (itemToDelete.id.startsWith('man-')) {
                 await api.delete(`/livro-caixa/${itemToDelete.rawId}`, { data: { obs: deleteObs } });
            } else if (itemToDelete.id.startsWith('in-')) {
                 await api.delete(`/pagamento-cliente/${itemToDelete.rawId}`);
            } else if (itemToDelete.id.startsWith('out-')) {
                 await api.delete(`/pagamento-peca/${itemToDelete.rawId}`);
            }

            setStatusMsg({ type: 'success', text: 'Lançamento deletado (estornado).' });
            setIsDeleteModalOpen(false);
            loadData();
        } catch (err) {
            console.error(err);
            setStatusMsg({ type: 'error', text: 'Erro ao deletar lançamento.' });
        }
    };

    return (
        <div className="space-y-6 animate-in fade-in duration-500 relative">
            <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({type: null, text: ''})} />

            <CategoryManager 
                isOpen={isCategoryModalOpen} 
                onClose={() => setIsCategoryModalOpen(false)} 
                onUpdate={() => { loadCategories(); }}
            />

            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 className="text-2xl font-black text-neutral-900 tracking-tight">Movimentação de Caixa</h1>
                    <p className="text-neutral-500">Fluxo de caixa consolidado (Manual e Automático).</p>
                </div>
                <button 
                    onClick={() => setIsCategoryModalOpen(true)}
                    className="flex items-center gap-2 text-neutral-500 hover:text-neutral-900 font-bold text-sm bg-white border border-neutral-200 px-4 py-2 rounded-xl hover:shadow-sm hover:border-neutral-300 transition-all"
                >
                    <Settings size={16} />
                    Gerenciar Categorias
                </button>
            </div>

            <div className="space-y-6">
                {/* Filters Board */}
                <div className="bg-white p-6 rounded-2xl border border-neutral-100 shadow-sm flex flex-col xl:flex-row justify-between items-end gap-4">
                    <div className="w-full grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        
                        {/* Search */}
                        <div className="md:col-span-3">
                            <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Buscar</label>
                            <div className="relative">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" size={16} />
                                <input 
                                    value={cashSearch}
                                    onChange={(e) => setCashSearch(e.target.value)}
                                    placeholder="Pesquisar..."
                                    className="w-full pl-10 pr-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold text-sm outline-none focus:border-neutral-400 transition-colors"
                                />
                            </div>
                        </div>
                        
                        {/* Dates */}
                        <div className="md:col-span-4 flex gap-2">
                             <div className="flex-1">
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">De</label>
                                <input type="date" value={cashFilterStart} onChange={e => setCashFilterStart(e.target.value)} className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none uppercase" />
                             </div>
                             <div className="flex-1">
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Até</label>
                                <input type="date" value={cashFilterEnd} onChange={e => setCashFilterEnd(e.target.value)} className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none uppercase" />
                             </div>
                        </div>

                        {/* Quick Filters */}
                        <div className="md:col-span-5 flex items-center justify-end">
                             <div className="w-full">
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Período</label>
                                <div className="flex bg-neutral-100 p-1 rounded-xl h-[46px] items-center w-full">
                                    <button onClick={() => applyQuickFilter('TODAY')} className="flex-1 px-2 py-1.5 rounded-lg text-[10px] font-black uppercase hover:bg-white transition-all text-neutral-500">Hoje</button>
                                    <button onClick={() => applyQuickFilter('WEEK')} className="flex-1 px-2 py-1.5 rounded-lg text-[10px] font-black uppercase hover:bg-white transition-all text-neutral-500">Semana</button>
                                    <button onClick={() => applyQuickFilter('MONTH')} className="flex-1 px-2 py-1.5 rounded-lg text-[10px] font-black uppercase hover:bg-white transition-all text-neutral-500">Mês</button>
                                </div>
                             </div>
                        </div>

                         {/* Source Filter */}
                         <div className="md:col-span-2">
                            <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Origem</label>
                            <select 
                                value={filterSource} 
                                onChange={(e) => setFilterSource(e.target.value as any)}
                                className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                            >
                                <option value="ALL">Todas</option>
                                <option value="MANUAL">Manual</option>
                                <option value="AUTO">Automática</option>
                            </select>
                        </div>

                        {/* Category Filter */}
                        <div className="md:col-span-3">
                             <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Categoria</label>
                             <select 
                                 value={filterCategory} 
                                 onChange={(e) => setFilterCategory(e.target.value)}
                                 className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                             >
                                 <option value="ALL">Todas</option>
                                 {categories.map(cat => (
                                     <option key={cat.id_categoria} value={cat.nome}>{cat.nome}</option>
                                 ))}
                             </select>
                        </div>
                        
                        <div className="md:col-span-2">
                            <button 
                                className="w-full bg-neutral-900 text-white px-6 py-4 rounded-2xl font-black flex items-center justify-center gap-3 shadow-xl hover:bg-neutral-800 transition-all hover:scale-[1.02] active:scale-95 whitespace-nowrap text-sm tracking-wide"
                                onClick={handleOpenCreate}
                            >
                                <Plus size={32} strokeWidth={3} />
                                <div className="flex flex-col items-start leading-tight">
                                    <span>NOVO</span>
                                    <span className="text-[10px] opacity-70 font-medium">LANÇAMENTO</span>
                                </div>
                            </button>
                        </div>

                    </div>
                </div>

                {/* SUMMARY */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-neutral-100">
                        <div className="flex items-center gap-3 mb-2">
                            <div className="p-2 bg-success-50 text-success-600 rounded-lg"><ArrowDownCircle size={20} /></div>
                            <p className="text-xs font-black text-neutral-400 uppercase tracking-widest">Entradas</p>
                        </div>
                        <p className="text-3xl font-black text-success-600">R$ {totalInflow.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                    </div>
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-neutral-100">
                        <div className="flex items-center gap-3 mb-2">
                            <div className="p-2 bg-red-50 text-red-600 rounded-lg"><ArrowUpCircle size={20} /></div>
                            <p className="text-xs font-black text-neutral-400 uppercase tracking-widest">Saídas</p>
                        </div>
                        <p className="text-3xl font-black text-red-600">R$ {totalOutflow.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                    </div>
                    <div className="bg-neutral-900 p-6 rounded-2xl shadow-xl text-white">
                        <div className="flex items-center gap-3 mb-2">
                            <div className="p-2 bg-neutral-800 text-neutral-400 rounded-lg"><Wallet size={20} /></div>
                            <p className="text-xs font-black text-neutral-400 uppercase tracking-widest">Saldo</p>
                        </div>
                        <p className={`text-3xl font-black ${balance >= 0 ? 'text-white' : 'text-red-400'}`}>R$ {balance.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                    </div>
                </div>

                {/* TABLE */}
                 <div className="bg-white rounded-3xl shadow-sm border border-neutral-100 overflow-hidden w-full">
                    <table className="w-full text-left border-collapse">
                        <thead>
                            <tr className="bg-neutral-50 text-[10px] font-black text-neutral-400 uppercase tracking-widest">
                                <th className="p-5">Data</th>
                                <th className="p-5">Descrição</th>
                                <th className="p-5">Tipo</th>
                                <th className="p-5">Categoria</th>
                                <th className="p-5 text-right whitespace-nowrap min-w-[150px]">Valor</th>
                                <th className="p-5 font-black text-neutral-400 uppercase text-[10px] tracking-widest">Obs</th>
                                <th className="p-5 text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-neutral-50">
                            {filteredCashBook.length === 0 ? (
                                 <tr><td colSpan={7} className="p-10 text-center text-neutral-400 italic font-medium">Nenhuma movimentação encontrada.</td></tr>
                            ) : (
                                filteredCashBook.map(entry => (
                                    <tr key={entry.id} className={`hover:bg-neutral-25 transition-colors ${entry.deleted_at ? 'opacity-50' : ''}`}>
                                        <td className="p-5">
                                            <div className={`flex items-center gap-2 font-bold text-xs ${entry.deleted_at ? 'line-through text-neutral-400' : 'text-neutral-600'}`}>
                                                <Calendar size={14} />
                                                {/* Show Date and Time */}
                                                {new Date(entry.date).toLocaleString('pt-BR', { 
                                                    day: '2-digit', month: '2-digit', year: 'numeric',
                                                    hour: '2-digit', minute: '2-digit'
                                                })}
                                            </div>
                                        </td>
                                        <td className={`p-5 font-bold ${entry.deleted_at ? 'line-through text-neutral-400' : 'text-neutral-900'}`}>
                                            <div>{entry.description}</div>
                                            {(entry.source === 'AUTO') && (
                                                <div className="text-[10px] text-neutral-400 font-medium mt-1">
                                                    {entry.type === 'OUT' ? (
                                                        <span>Pago a: {entry.supplier}</span>
                                                    ) : (
                                                        <span>{entry.client} {entry.vehicle ? `| ${entry.vehicle}` : ''}</span>
                                                    )}
                                                </div>
                                            )}
                                            {/* Show manual obs if exists */}
                                            {entry.source === 'MANUAL' && entry.obs && (
                                                <div className="text-[10px] text-neutral-400 font-medium mt-1 italic">
                                                    {entry.obs}
                                                </div>
                                            )}
                                        </td>
                                        <td className="p-5">
                                             <span className={`px-2 py-1 rounded-md text-[10px] font-black uppercase tracking-wider ${
                                                entry.deleted_at 
                                                ? 'bg-neutral-100 text-neutral-500 line-through'
                                                : entry.type === 'IN' 
                                                ? 'bg-success-50 text-success-700' 
                                                : 'bg-red-50 text-red-700'
                                            }`}>
                                                {entry.deleted_at ? 'CANCELADO' : (entry.type === 'IN' ? 'Entrada' : 'Saída')} ({entry.source === 'MANUAL' ? 'M' : 'A'})
                                            </span>
                                        </td>
                                        <td className="p-5">
                                            <span className="text-xs font-bold text-neutral-600 uppercase bg-neutral-100 px-2 py-1 rounded-md">
                                                {entry.category || 'Geral'}
                                            </span>
                                        </td>
                                        <td className={`p-5 text-right font-black ${entry.deleted_at ? 'line-through text-neutral-400' : 'text-neutral-900'}`}>
                                            R$ {entry.value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                                        </td>
                                        <td className="p-5">
                                            <div className="text-xs text-neutral-500 italic truncate max-w-[150px]" title={entry.obs}>
                                                {entry.obs || '-'}
                                            </div>
                                        </td>
                                        <td className="p-5 text-center">
                                            {!entry.deleted_at && (
                                                <div className="flex justify-center gap-2">
                                                    <button onClick={() => handleOpenEdit(entry)} className="p-2 hover:bg-neutral-100 rounded-lg text-neutral-500 hover:text-primary-600 transition-colors">
                                                        <Edit2 size={16} />
                                                    </button>
                                                    <button onClick={() => handleOpenDelete(entry)} className="p-2 hover:bg-neutral-100 rounded-lg text-neutral-500 hover:text-red-600 transition-colors">
                                                        <Trash2 size={16} />
                                                    </button>
                                                </div>
                                            )}
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                 </div>
            </div>

            {/* CREATE/EDIT MODAL */}
            {isModalOpen && (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl animate-in fade-in zoom-in duration-200">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-black text-neutral-900">
                                {editingItem ? 'Editar Lançamento' : 'Novo Lançamento'}
                            </h2>
                            <button onClick={() => setIsModalOpen(false)} className="p-2 hover:bg-neutral-100 rounded-full text-neutral-400 hover:text-neutral-900">
                                <X size={20} />
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Descrição</label>
                                <input 
                                    disabled={editingItem?.source === 'AUTO'} // Lock description for AUTO
                                    required type="text" value={formData.descricao} onChange={e => setFormData({...formData, descricao: e.target.value})} className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-neutral-900 outline-none focus:border-neutral-400 disabled:opacity-60" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Valor (R$)</label>
                                    <input required type="number" step="0.01" value={formData.valor} onChange={e => setFormData({...formData, valor: e.target.value})} className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-neutral-900 outline-none focus:border-neutral-400" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Tipo</label>
                                    <select 
                                        disabled={editingItem?.source === 'AUTO'} // Only lock for AUTO
                                        value={formData.tipo_movimentacao} onChange={e => setFormData({...formData, tipo_movimentacao: e.target.value})} className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-neutral-900 outline-none focus:border-neutral-400 disabled:opacity-60">
                                        <option value="ENTRADA">Entrada</option>
                                        <option value="SAIDA">Saída</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Categoria</label>
                                <select 
                                    disabled={editingItem?.source === 'AUTO'} // Lock category for AUTO
                                    value={formData.categoria} onChange={e => setFormData({...formData, categoria: e.target.value})} className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-neutral-900 outline-none focus:border-neutral-400 disabled:opacity-60">
                                    {categories.map(cat => (
                                        <option key={cat.id_categoria} value={cat.nome}>{cat.nome}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-neutral-500 uppercase mb-1">Observação</label>
                                <textarea 
                                    disabled={editingItem?.source === 'AUTO'} // Lock OBS for AUTO
                                    rows={3} value={formData.obs} onChange={e => setFormData({...formData, obs: e.target.value})} className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-medium text-neutral-900 outline-none focus:border-neutral-400 disabled:opacity-60" />
                                {editingItem?.source === 'AUTO' && <p className="text-[10px] text-red-500 mt-1">* Obs e Categoria não editáveis em lançamentos automáticos.</p>}
                            </div>
                            <div className="pt-4 flex gap-3">
                                <button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 py-3 font-bold text-neutral-500 hover:bg-neutral-100 rounded-xl">Cancelar</button>
                                <button type="submit" className="flex-1 py-3 bg-neutral-900 text-white font-bold rounded-xl hover:bg-neutral-800 shadow-lg">{editingItem ? 'Salvar Alterações' : 'Criar Lançamento'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* DELETE MODAL */}
            {isDeleteModalOpen && (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-3xl w-full max-w-sm p-8 shadow-2xl animate-in fade-in zoom-in duration-200 text-center">
                        <div className="w-16 h-16 bg-red-50 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6">
                            <AlertTriangle size={32} />
                        </div>
                        <h2 className="text-xl font-black text-neutral-900 mb-2">Excluir Lançamento?</h2>
                        <p className="text-neutral-500 mb-6">
                            Esta ação irá inativar o registro. Para lançamentos automáticos, isso não desfaz a OS ou Pagamento original, apenas remove do Livro Caixa visível.
                        </p>
                        
                        {itemToDelete?.source === 'MANUAL' && (
                             <input 
                                value={deleteObs}
                                onChange={e => setDeleteObs(e.target.value)}
                                placeholder="Motivo da exclusão (obs)..."
                                className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-medium text-sm outline-none focus:border-red-200 mb-6"
                            />
                        )}

                        <div className="flex gap-3">
                            <button onClick={() => setIsDeleteModalOpen(false)} className="flex-1 py-3 font-bold text-neutral-500 hover:bg-neutral-100 rounded-xl">Cancelar</button>
                            <button onClick={handleDelete} className="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 shadow-lg">Confirmar</button>
                        </div>
                    </div>
                </div>
            )}

        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\NotFoundPage.tsx
================================================================================
import { Link } from 'react-router-dom';
import { Home } from 'lucide-react';

export function NotFoundPage() {
  return (
    <div className="min-h-[80vh] flex flex-col items-center justify-center text-center p-4">
      <h1 className="text-9xl font-black text-slate-200">404</h1>
      <h2 className="text-2xl font-bold text-slate-800 mt-4">Página não encontrada</h2>
      <p className="text-slate-500 mt-2 max-w-md">
        Ops! A rota que você tentou acessar não existe ou foi movida.
      </p>
      <Link 
        to="/" 
        className="mt-8 flex items-center gap-2 px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium"
      >
        <Home size={20} />
        Voltar para o Início
      </Link>
    </div>
  );
}


================================================================================
FILE PATH: client\src\pages\NovoPagamentoPage.tsx
================================================================================

import { useState, useEffect, useMemo } from 'react';
import { api } from '../services/api';
import { StatusBanner } from '../components/ui/StatusBanner';
import { User, ArrowRight, Calculator, CheckCircle2, Circle, DollarSign, CheckSquare, Square } from 'lucide-react';
import { useNavigate, useLocation } from 'react-router-dom';

export const NovoPagamentoPage = () => {
    const navigate = useNavigate();

    // --- STATE ---
    const [funcionarios, setFuncionarios] = useState<any[]>([]);
    const [selectedFuncionarioId, setSelectedFuncionarioId] = useState('');
    const location = useLocation();

    const [funcPendentes, setFuncPendentes] = useState<any[]>([]); // Comissões Pendentes
    const [valesPendentes, setValesPendentes] = useState<any[]>([]); // Vales Pendentes

    // Selection
    const [selectedItems, setSelectedItems] = useState<number[]>([]); // IDs Comissões
    const [selectedVales, setSelectedVales] = useState<number[]>([]); // IDs Vales

    // MODE: 'PAGAMENTO' (Full) or 'ADIANTAMENTO' (Simple Vale)
    const [mode, setMode] = useState<'PAGAMENTO' | 'ADIANTAMENTO'>('PAGAMENTO');

    // Values
    const [valorSalario, setValorSalario] = useState(''); // Salário Base (Editable)
    const [includeSalary, setIncludeSalary] = useState(false); // Checkbox state
    const [valorPremio, setValorPremio] = useState('');   // Prêmio Extra
    
    // Common Inputs
    const [obsExtra, setObsExtra] = useState(''); // Obs Prêmio
    const [obsPagamento, setObsPagamento] = useState(''); // Obs Geral
    const [paymentMethod, setPaymentMethod] = useState('DINHEIRO');

    // Simple Adiantamento Inputs
    const [valorAdiantamento, setValorAdiantamento] = useState('');
    const [dataAdiantamento, setDataAdiantamento] = useState(new Date().toISOString().split('T')[0]);

    // Date Filters (Comissões)
    const [filterStart, setFilterStart] = useState('');
    const [filterEnd, setFilterEnd] = useState('');

    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });

    // --- EFFECTS ---
    useEffect(() => {
        loadFuncionarios();
    }, []);

    // Auto-select from navigation state
    useEffect(() => {
        if (location.state?.funcionarioId && funcionarios.length > 0) {
            setSelectedFuncionarioId(String(location.state.funcionarioId));
            // Clear state to avoid re-triggering if needed, but react-router handles this cleanly ideally
            // window.history.replaceState({}, document.title); 
        }
    }, [location.state, funcionarios]);

    useEffect(() => {
        if (selectedFuncionarioId) {
            loadData(selectedFuncionarioId);
            
            // Auto-fill Salary from selected Funcionario
            const func = funcionarios.find(f => String(f.id_funcionario) === String(selectedFuncionarioId));
            if (func && func.salario) {
                setValorSalario(String(func.salario));
            } else {
                setValorSalario('');
            }
        } else {
            setFuncPendentes([]);
            setValesPendentes([]);
            setSelectedItems([]);
            setSelectedVales([]);
            setValorSalario('');
        }
    }, [selectedFuncionarioId, funcionarios]);

    // --- LOADERS ---
    const loadFuncionarios = async () => {
        try { const res = await api.get('/funcionario'); setFuncionarios(res.data); } catch (e) { console.error(e); }
    };

    const loadData = async (id: string) => {
        try {
            // 1. Comissões
            const resComissao = await api.get(`/pagamento-equipe/pendentes/${id}`);
            setFuncPendentes(resComissao.data);
            // Auto-select Finalized Commissions
            setSelectedItems(
                resComissao.data
                    .filter((i: any) => i.ordem_de_servico?.status === 'FINALIZADA')
                    .map((i: any) => i.id_servico_mao_de_obra)
            );

            // 2. Vales Pendentes
            const resVales = await api.get(`/pagamento-equipe/vales/${id}`);
            setValesPendentes(resVales.data);
            // Auto-select ALL Vales by default for Deduction
            setSelectedVales(resVales.data.map((v: any) => v.id_pagamento_equipe));

        } catch (error) { console.error(error); }
    };

    // --- FILTERS ---
    const filteredComissioes = useMemo(() => {
        return funcPendentes.filter((item: any) => {
            if (!filterStart && !filterEnd) return true;
            const dateStr = item.ordem_de_servico?.dt_finalizacao || item.ordem_de_servico?.dt_entrega || item.ordem_de_servico?.dt_abertura;
            const osDate = dateStr ? new Date(dateStr) : null;
            if (!osDate) return true;
            
            const start = filterStart ? new Date(filterStart) : new Date('1900-01-01');
            const end = filterEnd ? new Date(filterEnd) : new Date('2100-01-01');
            end.setHours(23,59,59);

            return osDate >= start && osDate <= end;
        });
    }, [funcPendentes, filterStart, filterEnd]);

    // --- TOTALS (Mode PAGAMENTO) ---
    // Helper to calculate commission value per item
    const getCommissionValue = (itemVal: number) => {
        const func = funcionarios.find(f => String(f.id_funcionario) === String(selectedFuncionarioId));
        const pct = func?.comissao || 0;
        return (itemVal * pct) / 100;
    };

    const totalComissoes = useMemo(() => {
        return funcPendentes
            .filter(i => selectedItems.includes(i.id_servico_mao_de_obra))
            .reduce((acc, curr) => {
                const comissao = getCommissionValue(Number(curr.valor));
                return acc + comissao;
            }, 0);
    }, [funcPendentes, selectedItems, funcionarios, selectedFuncionarioId]);

    const totalDescontos = useMemo(() => {
        // Sum of SELECTED Vales to deduct
        return valesPendentes
            .filter(v => selectedVales.includes(v.id_pagamento_equipe))
            .reduce((acc, v) => acc + Number(v.valor_total), 0);
    }, [valesPendentes, selectedVales]);

    const finalTotalPagamento = useMemo(() => {
        const salario = includeSalary ? (Number(valorSalario) || 0) : 0;
        const premios = Number(valorPremio) || 0;
        return (salario + totalComissoes + premios) - totalDescontos;
    }, [valorSalario, totalComissoes, valorPremio, totalDescontos, includeSalary]);


    // --- HANDLERS ---
    const handleSelectAllComissoes = () => {
        const payables = filteredComissioes.filter((i: any) => i.ordem_de_servico?.status === 'FINALIZADA');
        const allSelected = payables.length > 0 && payables.every((p: any) => selectedItems.includes(p.id_servico_mao_de_obra));
        if (allSelected) setSelectedItems([]);
        else setSelectedItems(payables.map((i: any) => i.id_servico_mao_de_obra));
    };

    const handleSelectAllVales = () => {
        if (valesPendentes.length === selectedVales.length) setSelectedVales([]);
        else setSelectedVales(valesPendentes.map(v => v.id_pagamento_equipe));
    };

    const handlePay = async () => {
        if (!selectedFuncionarioId) return;

        try {
            if (mode === 'ADIANTAMENTO') {
                // Post ADIANTAMENTO (Vale)
                await api.post('/pagamento-equipe', {
                    id_funcionario: selectedFuncionarioId,
                    servicos_ids: [],
                    vales_ids: [], // No deduction when creating a vale
                    valor_total: valorAdiantamento,
                    obs: obsPagamento, // General Obs
                    forma_pagamento: paymentMethod,
                    premio_valor: null,
                    tipo_lancamento: 'VALE', // Backend uses VALE for Adiantamento
                    referencia_inicio: dataAdiantamento ? new Date(dataAdiantamento) : null // Use ref date as creation date override if needed, or just obs
                });
            } else {
                // Post PAGAMENTO (Full)
                await api.post('/pagamento-equipe', {
                    id_funcionario: selectedFuncionarioId,
                    servicos_ids: selectedItems,
                    vales_ids: selectedVales, // Deduct these vales
                    valor_total: finalTotalPagamento, // Net Value
                    obs: obsPagamento,
                    forma_pagamento: paymentMethod,
                    premio_valor: valorPremio || null,
                    premio_descricao: obsExtra || null,
                    tipo_lancamento: 'COMISSAO', // Or 'PAGAMENTO' if backend supports, keeping 'COMISSAO' for now as it consolidates OSs
                    referencia_inicio: null,
                    include_salary: includeSalary // Helper for backend if needed, or simply logic handles it by value passed
                });
            }

            setStatusMsg({ type: 'success', text: 'Lançamento realizado com sucesso!' });
            setTimeout(() => navigate('/pagamento-equipe'), 1500);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao processar lançamento.' });
        }
    };


    return (
        <div className="space-y-6 animate-in fade-in duration-500">
            <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({type: null, text: ''})} />

            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                     <button onClick={() => navigate('/pagamento-equipe')} className="text-sm font-bold text-neutral-500 hover:text-neutral-800 mb-1 flex items-center gap-1">
                        <ArrowRight className="rotate-180" size={14} /> Voltar
                     </button>
                     <h1 className="text-2xl font-black text-neutral-900 tracking-tight">Novo Pagamento / Adiantamento</h1>
                </div>
            </div>

            <div className="bg-white p-6 rounded-3xl shadow-sm border border-neutral-100 grid grid-cols-1 md:grid-cols-3 gap-6">
                
                {/* 1. SELEÇÃO DE COLABORADOR */}
                <div className="md:col-span-1">
                    <label className="text-[10px] font-black text-neutral-400 uppercase tracking-widest block mb-2">Colaborador</label>
                    <div className="relative">
                        <User className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" size={18} />
                        <select
                            value={selectedFuncionarioId}
                            onChange={(e) => setSelectedFuncionarioId(e.target.value)}
                            className="w-full pl-10 pr-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-primary-500/20 appearance-none text-neutral-700"
                        >
                            <option value="">Selecione...</option>
                            {funcionarios.map((f: any) => (
                                <option key={f.id_funcionario} value={f.id_funcionario}>
                                    {f.pessoa_fisica?.pessoa?.nome}
                                </option>
                            ))}
                        </select>
                    </div>
                </div>

                {/* 2. TIPO DE LANÇAMENTO (MODE) */}
                <div className="md:col-span-2">
                    <label className="text-[10px] font-black text-neutral-400 uppercase tracking-widest block mb-2">Modo de Lançamento</label>
                    <div className="flex gap-2 p-1 bg-neutral-50 rounded-xl border border-neutral-200 w-fit">
                         <button
                            onClick={() => setMode('PAGAMENTO')}
                            className={`px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wider transition-all ${
                                mode === 'PAGAMENTO' 
                                ? 'bg-neutral-900 text-white shadow' 
                                : 'text-neutral-500 hover:bg-white'
                            }`}
                         >
                            Pagamento (Salário/Comissões)
                         </button>
                         <button
                            onClick={() => setMode('ADIANTAMENTO')}
                            className={`px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wider transition-all ${
                                mode === 'ADIANTAMENTO' 
                                ? 'bg-amber-500 text-white shadow' 
                                : 'text-neutral-500 hover:bg-white'
                            }`}
                         >
                            Adiantamento (Novo Vale)
                         </button>
                    </div>
                </div>

            </div>

            {selectedFuncionarioId && (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
                    
                    {/* LEFT COLUMN: DETAILS */}
                    <div className="lg:col-span-2 space-y-6">
                        
                        {/* CARD COMISSÕES (Only in PAGAMENTO mode) */}
                        {mode === 'PAGAMENTO' && (
                            <div className="bg-white rounded-3xl shadow-sm border border-neutral-100 overflow-hidden">
                                <div className="p-4 bg-neutral-50 border-b border-neutral-100 flex items-center justify-between">
                                    <h3 className="font-black text-neutral-700 flex items-center gap-2">
                                        <Calculator size={18} className="text-primary-500" /> Comissões
                                        <span className="text-xs font-normal text-neutral-400 bg-neutral-100 px-2 py-0.5 rounded-full">
                                            {funcionarios.find(f => String(f.id_funcionario) === String(selectedFuncionarioId))?.comissao || 0}%
                                        </span>
                                    </h3>
                                    <div className="flex items-center gap-3">
                                        <button onClick={handleSelectAllComissoes} className="text-[10px] font-black uppercase tracking-widest text-primary-600 hover:text-primary-700">
                                            {selectedItems.length > 0 && selectedItems.length >= filteredComissioes.filter((i:any) => i.ordem_de_servico?.status === 'FINALIZADA').length ? 'Desmarcar Todas' : 'Marcar Todas'}
                                        </button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4 p-4 border-b border-neutral-100 bg-white">
                                    <div>
                                        <label className="text-[9px] font-black text-neutral-400 uppercase tracking-widest block mb-1">De</label>
                                        <input type="date" value={filterStart} onChange={e => setFilterStart(e.target.value)} className="w-full px-3 py-2 bg-neutral-50 border border-neutral-200 rounded-lg text-xs font-bold outline-none" />
                                    </div>
                                    <div>
                                        <label className="text-[9px] font-black text-neutral-400 uppercase tracking-widest block mb-1">Até</label>
                                        <input type="date" value={filterEnd} onChange={e => setFilterEnd(e.target.value)} className="w-full px-3 py-2 bg-neutral-50 border border-neutral-200 rounded-lg text-xs font-bold outline-none" />
                                    </div>
                                </div>
                                
                                <div className="max-h-[400px] overflow-y-auto p-2 space-y-2 bg-neutral-50/30">
                                    {filteredComissioes.length === 0 ? (
                                        <div className="p-8 text-center text-neutral-400 text-sm italic">Nenhuma comissão pendente.</div>
                                    ) : (
                                        filteredComissioes.map((item: any) => {
                                            const isPayable = item.ordem_de_servico?.status === 'FINALIZADA';
                                            const isSelected = selectedItems.includes(item.id_servico_mao_de_obra);
                                            const os = item.ordem_de_servico;
                                            const valorComissao = getCommissionValue(Number(item.valor));
                                            
                                            return (
                                                <div 
                                                    key={item.id_servico_mao_de_obra}
                                                    onClick={() => { if (isPayable) isSelected ? setSelectedItems(prev => prev.filter(id => id !== item.id_servico_mao_de_obra)) : setSelectedItems(prev => [...prev, item.id_servico_mao_de_obra]) }}
                                                    className={`p-4 rounded-xl border transition-all cursor-pointer flex gap-4 ${isSelected ? 'bg-primary-50 border-primary-200 ring-1 ring-primary-100' : isPayable ? 'bg-white border-neutral-200 hover:border-primary-200' : 'bg-neutral-100 border-neutral-100 opacity-60 cursor-not-allowed'}`}
                                                >
                                                    <div className={`mt-1 ${isSelected ? 'text-primary-600' : isPayable ? 'text-neutral-300' : 'text-neutral-200'}`}>
                                                        {isSelected ? <CheckCircle2 size={24} /> : <Circle size={24} />}
                                                    </div>
                                                    <div className="flex-1 space-y-2">
                                                        {/* ROW 1: Header */}
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-xs font-black bg-neutral-100 px-2 py-0.5 rounded text-neutral-600 uppercase">OS #{item.id_os}</span>
                                                                <span className={`text-[10px] font-black px-2 py-0.5 rounded uppercase border ${
                                                                    os?.status === 'FINALIZADA' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' :
                                                                    os?.status === 'ABERTA' ? 'bg-blue-50 text-blue-600 border-blue-100' : 
                                                                    os?.status === 'CANCELADA' ? 'bg-red-50 text-red-600 border-red-100' :
                                                                    os?.status === 'PAGA_CLIENTE' ? 'bg-cyan-50 text-cyan-600 border-cyan-100' :
                                                                    'bg-gray-50 text-gray-500 border-gray-100'
                                                                }`}>{os?.status ? os.status.replace(/_/g, ' ') : 'N/A'}</span>
                                                                {!isPayable && <span className="text-[10px] font-bold text-red-400 uppercase ml-2">(Não Finalizada)</span>}
                                                            </div>
                                                            <div className="text-right">
                                                                <span className="font-black text-emerald-600 text-lg">R$ {valorComissao.toFixed(2)}</span>
                                                                <div className="text-[9px] text-neutral-400 font-bold uppercase tracking-wide">Valor Serviço: R$ {Number(item.valor).toFixed(2)}</div>
                                                            </div>
                                                        </div>

                                                        {/* ROW 2: Vehicle */}
                                                        <div className="flex items-center gap-2 text-sm text-neutral-800">
                                                            <span className="font-bold">{os?.veiculo?.modelo}</span>
                                                            <span className="text-neutral-300">•</span>
                                                            <span className="text-neutral-600">{os?.veiculo?.cor}</span>
                                                            <span className="text-neutral-300">•</span>
                                                            <span className="font-mono bg-neutral-100 px-1 rounded text-neutral-600 text-xs">{os?.veiculo?.placa}</span>
                                                        </div>

                                                        {/* ROW 3: Client */}
                                                        <div className="text-xs font-bold text-neutral-500">
                                                            Cliente: <span className="text-neutral-700">{os?.cliente?.pessoa_fisica?.pessoa?.nome || os?.cliente?.pessoa_juridica?.razao_social || 'Desconhecido'}</span>
                                                        </div>

                                                        {/* ROW 4: Defect/Diag */}
                                                        {(os?.defeito_relatado || os?.diagnostico) && (
                                                            <div className="bg-neutral-50 p-2 rounded-lg text-[11px] space-y-1 mt-1 border border-neutral-100/50">
                                                                {os?.defeito_relatado && <div className="text-neutral-600"><strong className="text-neutral-400 uppercase tracking-wider text-[9px]">Defeito:</strong> {os.defeito_relatado}</div>}
                                                                {os?.diagnostico && <div className="text-neutral-600"><strong className="text-neutral-400 uppercase tracking-wider text-[9px]">Diag:</strong> {os.diagnostico}</div>}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            )
                                        })
                                    )}
                                </div>
                            </div>
                        )}

                        {/* CARD ADIANTAMENTOS PENDENTES (Histórico) */}
                        <div className="bg-white rounded-3xl shadow-sm border border-neutral-100 overflow-hidden">
                             <div className="p-4 bg-amber-50 border-b border-amber-100 flex items-center justify-between">
                                <h3 className="font-black text-amber-800 flex items-center gap-2">
                                    <DollarSign size={18} className="text-amber-600" /> 
                                    {mode === 'PAGAMENTO' ? 'Descontar Adiantamentos Pendentes' : 'Histórico de Adiantamentos Pendentes'}
                                </h3>
                                {mode === 'PAGAMENTO' && (
                                    <button onClick={handleSelectAllVales} className="text-[10px] font-black uppercase tracking-widest text-amber-700 hover:text-amber-900">
                                        {valesPendentes.length > 0 && selectedVales.length === valesPendentes.length ? 'Desmarcar Todos' : 'Marcar Todos'}
                                    </button>
                                )}
                            </div>
                            <div className="max-h-[250px] overflow-y-auto p-2 space-y-2 bg-neutral-50/30">
                                {valesPendentes.length === 0 ? (
                                    <div className="p-6 text-center text-neutral-400 text-sm italic">O colaborador não possui adiantamentos pendentes.</div>
                                ) : (
                                    valesPendentes.map((vale: any) => {
                                        const isSelected = selectedVales.includes(vale.id_pagamento_equipe);
                                        // In Adiantamento mode, items are not selectable (read-only list)
                                        const isReadOnly = mode === 'ADIANTAMENTO'; 

                                        return (
                                            <div 
                                                key={vale.id_pagamento_equipe}
                                                onClick={() => !isReadOnly && (isSelected ? setSelectedVales(prev => prev.filter(id => id !== vale.id_pagamento_equipe)) : setSelectedVales(prev => [...prev, vale.id_pagamento_equipe]))}
                                                className={`p-3 rounded-xl border transition-all flex gap-3 ${!isReadOnly ? 'cursor-pointer hover:border-amber-200' : ''} ${isSelected && !isReadOnly ? 'bg-amber-50/50 border-amber-200 ring-1 ring-amber-100' : 'bg-white border-neutral-200'}`}
                                            >
                                                {!isReadOnly && (
                                                     <div className={`mt-1 ${isSelected ? 'text-amber-600' : 'text-neutral-300'}`}>
                                                        {isSelected ? <CheckSquare size={18} /> : <Square size={18} />}
                                                    </div>
                                                )}
                                                <div className="flex-1 flex justify-between items-center">
                                                    <div>
                                                        <div className="text-xs font-bold text-neutral-800">
                                                            Lançado em {new Date(vale.dt_pagamento).toLocaleDateString()}
                                                        </div>
                                                        <div className="text-[10px] text-neutral-500 italic mt-0.5">{vale.obs || 'Sem observação'}</div>
                                                    </div>
                                                    <span className="font-black text-red-500 text-sm font-mono">- R$ {Number(vale.valor_total).toFixed(2)}</span>
                                                </div>
                                            </div>
                                        )
                                    })
                                )}
                            </div>
                            {valesPendentes.length > 0 && mode === 'PAGAMENTO' && (
                                <div className="p-3 bg-neutral-50 border-t border-neutral-100 text-right">
                                    <span className="text-[10px] font-black uppercase tracking-widest text-amber-700">Total a Descontar: </span>
                                    <span className="text-sm font-black text-red-600">R$ {totalDescontos.toFixed(2)}</span>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* RIGHT COLUMN: SUMMARY & ACTIONS */}
                    <div className="lg:col-span-1 space-y-6">
                        
                        {/* CARD FORMULÁRIO (Context Sensitive) */}
                        <div className="bg-white rounded-3xl shadow-sm border border-neutral-100 p-6 space-y-4">
                            <h3 className="font-black text-neutral-900 text-lg">Detalhes</h3>
                            
                            {mode === 'PAGAMENTO' ? (
                                <>
                                    {/* PAGAMENTO MODE INPUTS */}
                                    <div>
                                        <div className="flex items-center gap-2 mb-2">
                                            <input 
                                                type="checkbox" 
                                                id="chkSalary"
                                                checked={includeSalary}
                                                onChange={e => setIncludeSalary(e.target.checked)}
                                                className="w-4 h-4 rounded border-neutral-300 text-neutral-900 focus:ring-neutral-900"
                                            />
                                            <label htmlFor="chkSalary" className="text-[10px] font-black text-neutral-400 uppercase tracking-widest cursor-pointer select-none">
                                                Incluir Pagamento de Contrato?
                                            </label>
                                        </div>
                                        <input 
                                            type="number"
                                            disabled={!includeSalary}
                                            value={valorSalario}
                                            onChange={e => setValorSalario(e.target.value)}
                                            className="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold outline-none focus:ring-2 focus:ring-primary-500/20 disabled:opacity-50 disabled:bg-neutral-100"
                                            placeholder="0.00"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-neutral-400 uppercase tracking-widest block mb-1">Prêmios / Extras (R$)</label>
                                        <input 
                                            type="number"
                                            value={valorPremio}
                                            onChange={e => setValorPremio(e.target.value)}
                                            className="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold outline-none focus:ring-2 focus:ring-primary-500/20"
                                            placeholder="0.00"
                                        />
                                    </div>
                                    {valorPremio && (
                                        <div>
                                            <label className="text-[10px] font-black text-neutral-400 uppercase tracking-widest block mb-1">Motivo do Prêmio</label>
                                            <input value={obsExtra} onChange={e => setObsExtra(e.target.value)} className="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold text-xs outline-none" placeholder="Ex: Meta Batida" />
                                        </div>
                                    )}
                                </>
                            ) : (
                                <>
                                    {/* ADIANTAMENTO MODE INPUTS */}
                                     <div>
                                        <label className="text-[10px] font-black text-neutral-400 uppercase tracking-widest block mb-1">Valor do Novo Adiantamento (R$)</label>
                                        <input 
                                            type="number"
                                            value={valorAdiantamento}
                                            onChange={e => setValorAdiantamento(e.target.value)}
                                            className="w-full px-4 py-3 bg-neutral-50 border-amber-200 border rounded-xl font-bold outline-none focus:ring-2 focus:ring-amber-500/20 text-amber-900"
                                            placeholder="0.00"
                                            autoFocus
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-neutral-400 uppercase tracking-widest block mb-1">Data do Lançamento</label>
                                        <input 
                                            type="date"
                                            value={dataAdiantamento}
                                            onChange={e => setDataAdiantamento(e.target.value)}
                                            className="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold outline-none"
                                        />
                                    </div>
                                </>
                            )}
                            
                             <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase tracking-widest block mb-1">Forma Pagto</label>
                                <select value={paymentMethod} onChange={e => setPaymentMethod(e.target.value)} className="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold text-sm outline-none">
                                    <option value="DINHEIRO">Dinheiro</option>
                                    <option value="PIX">Pix</option>
                                    <option value="TRANSFERENCIA">Transferência</option>
                                </select>
                             </div>

                             <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase tracking-widest block mb-1">Obs Geral</label>
                                <textarea value={obsPagamento} onChange={e => setObsPagamento(e.target.value)} className="w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold text-xs outline-none" rows={2} />
                             </div>
                        </div>

                        {/* TOTAL FINAL CARD (Only in PAGAMENTO mode, or just Button in Adiantamento) */}
                        {mode === 'PAGAMENTO' ? (
                            <div className="bg-neutral-900 text-white rounded-3xl shadow-xl shadow-neutral-900/10 p-6 space-y-4">
                                <div className="space-y-1">
                                    <div className="flex justify-between text-xs text-neutral-400">
                                        <span>(+) Pagamento</span>
                                        <span className={`font-bold ${includeSalary ? 'text-emerald-400' : 'text-neutral-600 line-through opacity-50'}`}>
                                            R$ {includeSalary ? (Number(valorSalario)||0).toFixed(2) : '0.00'}
                                        </span>
                                    </div>
                                    <div className="flex justify-between text-xs text-neutral-400">
                                        <span>(+) Comissões</span>
                                        <span className="font-bold text-emerald-400">R$ {totalComissoes.toFixed(2)}</span>
                                    </div>
                                    <div className="flex justify-between text-xs text-neutral-400">
                                        <span>(+) Prêmios</span>
                                        <span className="font-bold text-emerald-400">R$ {(Number(valorPremio)||0).toFixed(2)}</span>
                                    </div>
                                    <div className="flex justify-between text-xs text-neutral-400 pt-1 border-t border-dashed border-neutral-800">
                                        <span>(-) Descontos</span>
                                        <span className="font-bold text-red-400">R$ {totalDescontos.toFixed(2)}</span>
                                    </div>

                                    <div className="border-t border-neutral-800 my-2 pt-3 flex justify-between items-end">
                                        <span className="font-black uppercase tracking-widest text-xs text-white">Total a Pagar</span>
                                        <span className="font-black text-3xl">R$ {finalTotalPagamento.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
                                    </div>
                                </div>
                                
                                <button 
                                    onClick={handlePay}
                                    className="w-full bg-emerald-500 hover:bg-emerald-400 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-sm transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Confirmar Pagamento
                                </button>
                            </div>
                        ) : (
                             <div className="bg-amber-500 text-white rounded-3xl shadow-xl shadow-amber-900/10 p-6 space-y-4">
                                <div className="flex justify-between items-end border-b border-white/20 pb-4">
                                    <span className="font-black uppercase tracking-widest text-xs text-amber-100">Valor Adiantamento</span>
                                    <span className="font-black text-3xl">R$ {Number(valorAdiantamento).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
                                </div>
                                <button 
                                    onClick={handlePay}
                                    className="w-full bg-white text-amber-600 hover:bg-amber-50 py-4 rounded-2xl font-black uppercase tracking-widest text-sm transition-all active:scale-95"
                                >
                                    Confirmar Lançamento
                                </button>
                            </div>
                        )}

                    </div>
                </div>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\OrdemDeServicoDetalhePage.tsx
================================================================================
import { useState, useEffect, useRef } from 'react';
import type { FormEvent } from 'react';

import { useParams, useNavigate } from 'react-router-dom';
import { api } from '../services/api';
import type { IOrdemDeServico } from '../types/backend';
import { 
    Search, Plus, PenTool, X,
    Package, Wrench, CheckCircle, BadgeCheck, DollarSign, ArrowLeft, Save
} from 'lucide-react';

import { StatusBanner } from '../components/ui/StatusBanner';
import { Modal } from '../components/ui/Modal';
import { Button } from '../components/ui/Button';
import { PagamentoClienteForm } from '../components/forms/PagamentoClienteForm';
import { LaborManager } from '../components/os/LaborManager';

export const OrdemDeServicoDetalhePage = () => {
    const { id } = useParams();
    const navigate = useNavigate();
    
    // --- STATE ---
    const [os, setOs] = useState<IOrdemDeServico | null>(null);
    const [osItems, setOsItems] = useState<any[]>([]);
    const [laborServices, setLaborServices] = useState<any[]>([]);
    const [employees, setEmployees] = useState<any[]>([]);
    const [availableParts, setAvailableParts] = useState<any[]>([]);
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });
    const [isDirty, setIsDirty] = useState(false);

    // Confirm Modal
    const [confirmModal, setConfirmModal] = useState<{ isOpen: boolean; title: string; message: string; onConfirm: () => void; }>({ isOpen: false, title: '', message: '', onConfirm: () => {} });

    // Items / Parts Management
    const [partSearch, setPartSearch] = useState('');
    const [partResults, setPartResults] = useState<any[]>([]);
    const [newItem, setNewItem] = useState({ id_pecas_estoque: '', quantidade: '1', valor_venda: '', descricao: '', codigo_referencia: '', id_fornecedor: '' });
    const [editingItemId, setEditingItemId] = useState<number | null>(null);
    const [highlightIndex, setHighlightIndex] = useState(-1);
    
    // Refs
    const partInputRef = useRef<HTMLInputElement>(null);
    const quantityInputRef = useRef<HTMLInputElement>(null);
    const referenceInputRef = useRef<HTMLInputElement>(null);

    // Edit Item Modal
    const [editItemModalOpen, setEditItemModalOpen] = useState(false);
    const [editingItemData, setEditingItemData] = useState<any>(null);

    // Payment Modal
    const [showPaymentModal, setShowPaymentModal] = useState(false);

    // --- LOADING ---
    const loadOsData = async () => {
        if (!id) return;
        try {
            const response = await api.get(`/ordem-de-servico/${id}`);
            setOs(response.data);
            setOsItems(response.data.itens_os || []);
            setLaborServices(response.data.servicos_mao_de_obra || []);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao carregar OS.' });
        }
    };

    const loadEmployees = async () => {
        try {
            const response = await api.get('/funcionario');
            setEmployees(response.data);
        } catch (error) {
            console.error(error);
        }
    };

    const loadParts = async () => {
        try {
            const response = await api.get('/pecas-estoque');
            setAvailableParts(response.data);
        } catch (error) {
            console.error(error);
        }
    };

    const loadOsItems = async (idOs: number) => {
        try {
            const response = await api.get(`/itens-os/os/${idOs}`);
            setOsItems(response.data);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao carregar itens.' });
        }
    };

    useEffect(() => {
        loadOsData();
        loadEmployees();
        loadParts();
    }, [id]);

    // --- HANDLERS ---
    
    const updateOSField = async (field: string, value: any) => {
         if (!os || os.status === 'FINALIZADA' || os.status === 'PAGA_CLIENTE') return;

         try {
             setOs(prev => prev ? ({ ...prev, [field]: value }) : null);
             await api.put(`/ordem-de-servico/${os.id_os}`, { [field]: value });
             setIsDirty(false);
         } catch (error) {
             setStatusMsg({ type: 'error', text: 'Erro ao salvar alteração.' });
         }
    };

    const handlePartSearch = async (val: string) => {
        setPartSearch(val);
        if (val.length < 2) { setPartResults([]); return; }
        try {
            const [stockRes, historyRes] = await Promise.all([
                api.get(`/pecas-estoque/search?q=${val}`),
                api.get(`/itens-os/search/desc?q=${val}`)
            ]);
            const historyFormatted = historyRes.data.map((h: any) => ({
                id_pecas_estoque: null, nome: h.descricao, valor_venda: h.valor_venda, fabricante: 'Histórico', isHistory: true
            }));
            const combined = [...stockRes.data, ...historyFormatted];
             const unique = combined.filter((v, i, a) => a.findIndex(t => t.nome === v.nome) === i);
            setPartResults(unique);
        } catch (e) { console.error(e); }
    };

    const selectPart = (p: any) => {
        setNewItem({ ...newItem, id_pecas_estoque: String(p.id_pecas_estoque), valor_venda: String(p.valor_venda), descricao: p.nome });
        setPartSearch(p.nome);
        setPartResults([]);
        setHighlightIndex(-1);
        setIsDirty(true);
        requestAnimationFrame(() => referenceInputRef.current?.focus());
    };

    const handleAddItem = async (e?: FormEvent) => {
        if (e) e.preventDefault();
        if (!os) return;
        try {
            const part = availableParts.find(p => p.id_pecas_estoque === Number(newItem.id_pecas_estoque));
            const description = part ? part.nome : (newItem.descricao || partSearch || 'Item Diverso');
            const qtd = Number(newItem.quantidade);
            const val = Number(newItem.valor_venda);

            if (editingItemId) {
                await api.put(`/itens-os/${editingItemId}`, {
                    descricao: description, quantidade: qtd, valor_venda: val, valor_total: qtd * val,
                    codigo_referencia: newItem.codigo_referencia, id_fornecedor: newItem.id_fornecedor || null
                });
                setStatusMsg({ type: 'success', text: 'Item adicionado/atualizado!' });
            } else {
                await api.post('/itens-os', {
                    id_os: os.id_os, id_pecas_estoque: newItem.id_pecas_estoque ? Number(newItem.id_pecas_estoque) : null,
                    descricao: description, quantidade: qtd, valor_venda: val, valor_total: qtd * val,
                    codigo_referencia: newItem.codigo_referencia, id_fornecedor: newItem.id_fornecedor || null
                });
                setStatusMsg({ type: 'success', text: 'Item adicionado!' });
            }
            setNewItem({ id_pecas_estoque: '', quantidade: '1', valor_venda: '', descricao: '', codigo_referencia: '', id_fornecedor: '' });
            setPartSearch('');
            setEditingItemId(null);
            loadOsItems(os.id_os);
            setTimeout(() => setStatusMsg({ type: null, text: '' }), 1500);
            requestAnimationFrame(() => partInputRef.current?.focus());
            setTimeout(() => partInputRef.current?.focus(), 100);
        } catch (error) { setStatusMsg({ type: 'error', text: 'Erro ao salvar item.' }); }
    };

    const handleDeleteItem = (itemId: number) => {
        if (!os) return;
        setConfirmModal({
            isOpen: true, title: 'Excluir Item', message: 'Deseja excluir este item?',
            onConfirm: async () => {
                await api.delete(`/itens-os/${itemId}`);
                loadOsItems(os.id_os);
                setConfirmModal(prev => ({ ...prev, isOpen: false }));
            }
        });
    };

    const handleEditItem = (item: any) => {
         setEditingItemData({ ...item, id_fornecedor: item.pagamentos_peca?.[0]?.id_fornecedor || '' });
         setEditItemModalOpen(true);
    };

    const handleSaveItemEdit = async () => {
        if (!editingItemData || !os) return;
        try {
            const qtd = Number(editingItemData.quantidade);
            const val = Number(editingItemData.valor_venda);
            await api.put(`/itens-os/${editingItemData.id_iten}`, {
                descricao: editingItemData.descricao, 
                quantidade: qtd, 
                valor_venda: val, 
                valor_total: qtd * val,
                codigo_referencia: editingItemData.codigo_referencia, 
                id_fornecedor: editingItemData.id_fornecedor ? Number(editingItemData.id_fornecedor) : null
            });
            loadOsItems(os.id_os);
            setEditItemModalOpen(false);
            setEditingItemData(null);
        } catch (e) { setStatusMsg({ type: 'error', text: 'Erro ao editar item.' }); }
    };

    const handleFinishService = async () => {
        if (!os) return;

        setConfirmModal({
            isOpen: true,
            title: 'Finalizar OS',
            message: 'Deseja Finalizar a OS? Isso irá gerar o financeiro e mudar o status.',
            onConfirm: async () => executeFinish()
        });
    };

    const executeFinish = async () => {
        if (!os) return;
        const totalItems = osItems.reduce((acc, item) => acc + Number(item.valor_total), 0);
        
        const sumLaborServices = laborServices.reduce((acc, l) => acc + Number(l.valor), 0);
        const finalLaborValue = laborServices.length > 0 ? sumLaborServices : Number(os.valor_mao_de_obra || 0);
        
        try {
             await api.put(`/ordem-de-servico/${os.id_os}`, {
                valor_pecas: totalItems,
                valor_mao_de_obra: finalLaborValue,
                valor_total_cliente: totalItems + finalLaborValue,
                status: 'PRONTO PARA FINANCEIRO',
                dt_entrega: os.dt_entrega ? new Date(os.dt_entrega).toISOString() : new Date().toISOString()
            });
            setStatusMsg({ type: 'success', text: 'OS Finalizada! Enviada para Financeiro.' });
            setIsDirty(false);
            setConfirmModal(prev => ({ ...prev, isOpen: false }));
            setTimeout(() => {
                setStatusMsg({ type: null, text: '' });
                navigate('/ordem-de-servico');
            }, 1000);
        } catch (e) { setStatusMsg({ type: 'error', text: 'Erro ao finalizar OS.' }); }
    };

    const handleSaveAndClose = async () => {
        if (!os) return;
        try {
            await api.put(`/ordem-de-servico/${os.id_os}`, { 
                defeito_relatado: os.defeito_relatado,
                diagnostico: os.diagnostico,
                km_entrada: os.km_entrada
            });
            setIsDirty(false);
            setStatusMsg({ type: 'success', text: 'Alterações Salvas!' });
            setTimeout(() => navigate('/ordem-de-servico'), 500);
        } catch (e) {
            setStatusMsg({ type: 'error', text: 'Erro ao salvar.' });
        }
    };

    const handleBack = () => {
        if (isDirty) {
            setConfirmModal({
                isOpen: true,
                title: 'Alterações Pendentes',
                message: 'Deseja Salvar as alterações?',
                onConfirm: () => {
                    setConfirmModal(prev => ({...prev, isOpen: false}));
                    handleSaveAndClose();
                }
            });
        } else {
            navigate('/ordem-de-servico');
        }
    };

    const getStatusStyle = (status: string) => {
        switch (status) {
            case 'FINALIZADA': return 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200';
            case 'PAGA_CLIENTE': return 'bg-neutral-100 text-neutral-600 ring-1 ring-neutral-200';
            case 'PRONTO PARA FINANCEIRO': return 'bg-amber-100 text-amber-700 ring-1 ring-amber-200';
            case 'ABERTA': return 'bg-blue-100 text-blue-700 ring-1 ring-blue-200';
            case 'EM_ANDAMENTO': return 'bg-cyan-100 text-cyan-700 ring-1 ring-cyan-200';
            default: return 'bg-gray-50 text-gray-500 ring-1 ring-gray-200';
        }
    };

    if (!os) {
        return <div className="p-8 text-center text-neutral-500">Carregando detalhes da OS...</div>;
    }

    return (
        <div className="space-y-6 pb-20">
             {statusMsg.text && (
                <div className="fixed bottom-8 right-8 z-60">
                     <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({ type: null, text: '' })} />
                </div>
            )}

            {/* HEADER with Back Button */}
            <div className="flex items-center gap-4">
                 <button onClick={handleBack} className="p-2 hover:bg-neutral-100 rounded-lg transition-colors text-neutral-600">
                     <ArrowLeft size={24} />
                 </button>
                 <div className="flex-1">
                     <div className="flex items-baseline gap-3">
                         <h1 className="text-2xl font-bold text-neutral-900 tracking-tight">OS #{os.id_os}</h1>
                         <span className={`text-xs px-2.5 py-0.5 rounded-full font-bold border ${getStatusStyle(os.status)}`}>
                             {os.status}
                         </span>
                     </div>
                 </div>
            </div>

            <div className="space-y-8">
                {/* Header Info */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 p-6 bg-white rounded-2xl border border-neutral-200 items-center shadow-sm">
                        {/* Coluna 1: Veículo */}
                        <div className="space-y-1">
                            <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-wider">Veículo</p>
                            <div className="flex flex-col">
                                <h3 className="text-2xl font-black text-neutral-900 leading-none tracking-tight">
                                {os.veiculo?.modelo}
                                </h3>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className="text-base font-bold text-neutral-700 uppercase bg-neutral-100 px-2 py-0.5 rounded-md">
                                        {os.veiculo?.cor || 'Cor N/I'}
                                    </span>
                                    <span className="text-sm font-medium text-neutral-400 uppercase tracking-widest border border-neutral-200 px-2 py-0.5 rounded-md">
                                        {os.veiculo?.placa}
                                    </span>
                                </div>
                            </div>
                        </div>

                        {/* Coluna 2: Cliente */}
                        <div className="space-y-1">
                            <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-wider">Cliente / Contato</p>
                            <div className="flex flex-col">
                                <p className="font-bold text-lg text-neutral-900 leading-tight">
                                    {os.cliente?.pessoa_fisica?.pessoa?.nome || os.cliente?.pessoa_juridica?.razao_social}
                                </p>
                                <p className="text-sm font-medium text-neutral-600 flex items-center gap-1">
                                    {os.cliente?.telefone_1 || 'Sem telefone'}
                                </p>
                            </div>
                        </div>

                        {/* Coluna 3: Entrada */}
                        <div className="space-y-1">
                            <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-wider">Data de Entrada</p>
                            <div className="flex items-center gap-2">
                                <div className="bg-neutral-50 p-2 rounded-lg border border-neutral-100">
                                <p className="font-black text-xl text-neutral-900 leading-none">
                                    {new Date(os.dt_abertura).getDate()}
                                </p>
                                </div>
                                <div className="flex flex-col leading-none">
                                    <span className="text-xs font-bold text-neutral-500 uppercase">
                                        {new Date(os.dt_abertura).toLocaleString('default', { month: 'short' })}
                                    </span>
                                    <span className="text-[10px] font-medium text-neutral-300">
                                        {new Date(os.dt_abertura).getFullYear()}
                                    </span>
                                </div>
                            </div>
                        </div>

                        {/* Coluna 4: KM */}
                        <div className="space-y-1">
                            <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-wider block">KM Atual</label>
                            <div className="relative group">
                                <input 
                                className="w-full bg-neutral-50 border border-neutral-200 text-neutral-900 font-black text-xl rounded-xl px-4 py-2 outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-50 transition-all"
                                type="number"
                                value={os.km_entrada}
                                onChange={e => setOs({...os, km_entrada: Number(e.target.value)})}
                                onBlur={e => updateOSField('km_entrada', Number(e.target.value))}
                                />
                                <span className="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-neutral-300 group-focus-within:text-primary-500 uppercase tracking-wider">KM</span>
                            </div>
                        </div>
                </div>

                {/* SPLIT LAYOUT: Defects/Diagnosis (Left) & Labor (Right) */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                    
                    {/* LEFT COL: Text Areas */}
                    <div className="space-y-4">
                        <div className="space-y-1">
                        <label className="flex items-center gap-2 text-[10px] font-black text-neutral-400 uppercase tracking-wider">
                            <span className="w-1.5 h-1.5 rounded-full bg-red-400"></span> Defeito Relatado
                        </label>
                        <textarea 
                            className="w-full bg-red-50/20 p-3 rounded-xl border border-red-100 text-xs font-medium text-neutral-700 h-24 outline-none focus:border-red-300 focus:bg-white resize-none transition-all focus:shadow-sm"
                            placeholder="Descreva o defeito..."
                            value={os.defeito_relatado || ''}
                            onChange={e => {
                                setOs({...os, defeito_relatado: e.target.value});
                                setIsDirty(true);
                            }}
                            onBlur={e => updateOSField('defeito_relatado', e.target.value)}
                        />
                        </div>
                        <div className="space-y-1">
                        <label className="flex items-center gap-2 text-[10px] font-black text-neutral-400 uppercase tracking-wider">
                            <span className="w-1.5 h-1.5 rounded-full bg-blue-400"></span> Diagnóstico Técnico
                        </label>
                        <textarea 
                            className="w-full bg-blue-50/20 p-3 rounded-xl border border-blue-100 text-xs font-medium text-neutral-700 h-24 outline-none focus:border-blue-300 focus:bg-white resize-none transition-all focus:shadow-sm"
                            placeholder="Insira o diagnóstico..."
                            value={os.diagnostico || ''}
                            onChange={e => {
                                setOs({...os, diagnostico: e.target.value});
                                setIsDirty(true);
                            }}
                            onBlur={e => updateOSField('diagnostico', e.target.value)}
                        />
                        </div>
                    </div>

                    {/* RIGHT COL: Labor Manager */}
                    <div className="w-full space-y-2 h-full">
                        <h3 className="text-xs font-black text-neutral-400 uppercase tracking-widest flex items-center gap-2 pl-1">
                            <Wrench size={14} /> Mão de Obra
                        </h3>
                        <div className="h-full bg-white rounded-xl border border-neutral-200 overflow-hidden">
                            <LaborManager 
                                mode="api"
                                osId={os.id_os}
                                initialData={laborServices}
                                employees={employees}
                                onChange={() => loadOsData()} 
                                readOnly={os.status === 'FINALIZADA' || os.status === 'PAGA_CLIENTE'}
                            />
                        </div>
                    </div>
                </div>
                
                {/* ITENS (PEÇAS) - FULL WIDTH */}
                <div className="space-y-4 pt-4 border-t border-dashed border-neutral-200">
                    <h3 className="text-sm font-black text-neutral-600 uppercase tracking-widest flex items-center gap-3 pb-2 border-b border-neutral-100">
                        <div className="p-1.5 bg-orange-100 rounded-lg text-orange-600">
                            <Package size={16} />
                        </div>
                        Peças e Produtos
                    </h3>
                    {/* Form Add Item */}
                    {os.status !== 'FINALIZADA' && os.status !== 'PAGA_CLIENTE' && (
                        <div className="p-4 rounded-2xl border border-neutral-200 bg-neutral-50 shadow-sm">
                                <div className="relative group mb-3">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400 group-focus-within:text-primary-500 transition-colors" size={18} />
                                <input 
                                    ref={partInputRef}
                                    className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-neutral-200 outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-50 font-bold text-sm bg-white transition-all shadow-sm"
                                    placeholder="Buscar peça no estoque..."
                                    value={partSearch}
                                    onChange={e => {
                                        handlePartSearch(e.target.value);
                                        setHighlightIndex(-1);
                                    }}
                                    onKeyDown={(e) => {
                                        if (partResults.length === 0) return;
                                        if (e.key === 'ArrowDown') {
                                            e.preventDefault();
                                            setHighlightIndex(prev => Math.min(prev + 1, partResults.length - 1));
                                        } else if (e.key === 'ArrowUp') {
                                            e.preventDefault();
                                            setHighlightIndex(prev => Math.max(prev - 1, -1)); // -1 means input focus
                                        } else if (e.key === 'Enter') {
                                            if (highlightIndex >= 0 && partResults[highlightIndex]) {
                                                e.preventDefault();
                                                selectPart(partResults[highlightIndex]);
                                                setHighlightIndex(-1);
                                            }
                                        }
                                    }}
                                />
                                {partResults.length > 0 && (
                                    <div className="absolute z-50 w-full mt-2 bg-white border border-neutral-100 rounded-xl shadow-2xl max-h-60 overflow-y-auto overflow-x-hidden animate-in fade-in slide-in-from-top-2">
                                        {partResults.map((p, idx) => (
                                            <button 
                                                key={p.id_pecas_estoque || p.nome} 
                                                onClick={() => selectPart(p)} 
                                                className={`w-full text-left p-3 text-sm font-medium border-b border-neutral-50 flex justify-between group/item transition-colors ${idx === highlightIndex ? 'bg-primary-50 ring-1 ring-inset ring-primary-100 z-10' : 'hover:bg-neutral-50'}`}
                                            >
                                                <span className="text-neutral-700 group-hover/item:text-neutral-900">{p.nome}</span>
                                                <span className="font-bold text-primary-600 bg-primary-50 px-2 py-0.5 rounded-md">R$ {Number(p.valor_venda).toFixed(2)}</span>
                                            </button>
                                        ))}
                                    </div>
                                )}
                                </div>
                                <form onSubmit={handleAddItem} className="flex gap-2">
                                    <input 
                                        ref={referenceInputRef}
                                        className="w-32 p-2.5 rounded-xl border border-neutral-200 bg-white font-bold text-sm outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-50" 
                                        placeholder="Ref (Opcional)" 
                                        value={newItem.codigo_referencia} 
                                        onChange={e => setNewItem({...newItem, codigo_referencia: e.target.value})} 
                                    />
                                    <input 
                                        ref={quantityInputRef}
                                        className="w-24 p-2.5 rounded-xl border border-neutral-200 bg-white font-bold text-center text-sm outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-50" 
                                        placeholder="Qtd" 
                                        value={newItem.quantidade} 
                                        onChange={e => setNewItem({...newItem, quantidade: e.target.value})} 
                                    />
                                    <input 
                                        className="w-48 p-2.5 rounded-xl border border-neutral-200 bg-white font-bold text-sm outline-none focus:border-primary-500 focus:ring-2 focus:ring-primary-50" 
                                        placeholder="Valor Unit." 
                                        value={newItem.valor_venda} 
                                        onChange={e => setNewItem({...newItem, valor_venda: e.target.value})} 
                                    />
                                    <div className="flex-1 flex items-center justify-end px-4 text-xs font-bold text-neutral-400 uppercase tracking-wider">
                                        Total: R$ {(Number(newItem.quantidade) * Number(newItem.valor_venda || 0)).toFixed(2)}
                                    </div>
                                    <button type="submit" className="bg-neutral-900 text-white px-6 py-2 rounded-xl hover:bg-black hover:scale-105 transition-all shadow-lg shadow-neutral-900/20 font-bold uppercase text-xs flex items-center gap-2"><Plus size={16} /> Adicionar</button>
                                </form>
                        </div>
                    )}
                    {/* List Items */}
                    <div className="border border-neutral-200 rounded-2xl overflow-hidden bg-white shadow-sm">
                            <table className="w-full text-left">
                            <thead className="bg-neutral-50 border-b border-neutral-100">
                                <tr>
                                    <th className="p-3 pl-4 text-[10px] uppercase font-black text-neutral-400 tracking-wider">Item</th>
                                    <th className="p-3 text-[10px] uppercase font-black text-neutral-400 tracking-wider">Ref/Código</th>
                                    <th className="p-3 text-[10px] uppercase font-black text-neutral-400 tracking-wider text-center">Qtd</th>
                                    <th className="p-3 text-[10px] uppercase font-black text-neutral-400 tracking-wider text-right">Unit.</th>
                                    <th className="p-3 text-[10px] uppercase font-black text-neutral-400 tracking-wider text-right">Total</th>
                                    <th className="p-3 w-20"></th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-neutral-50">
                                {osItems.map(item => (
                                    <tr key={item.id_iten} className="hover:bg-neutral-50/50 transition-colors group">
                                        <td className="p-3 pl-4">
                                            <div className="font-bold text-sm text-neutral-700">
                                                {item.descricao}
                                                {/* STATUS PAGO */}
                                                {item.pagamentos_peca && item.pagamentos_peca.length > 0 && item.pagamentos_peca.some((pp: any) => pp.pago_ao_fornecedor) && (
                                                    <span className="ml-2 px-1.5 py-0.5 rounded text-[9px] font-black uppercase bg-green-100 text-green-700 tracking-wider border border-green-200">
                                                        PAGO
                                                    </span>
                                                )}
                                            </div>
                                        </td>
                                        <td className="p-3">
                                            <div className="text-[10px] text-neutral-400 font-medium font-mono bg-neutral-100 px-2 py-0.5 rounded-md w-fit">{item.codigo_referencia || '-'}</div>
                                        </td>
                                        <td className="p-3 text-center font-bold text-neutral-600 text-xs">{item.quantidade}</td>
                                        <td className="p-3 text-right text-neutral-500 text-xs">R$ {Number(item.valor_venda).toFixed(2)}</td>
                                        <td className="p-3 text-right font-black text-neutral-800 text-xs">R$ {Number(item.valor_total).toFixed(2)}</td>
                                        <td className="p-3 text-right pr-4">
                                                {os.status !== 'FINALIZADA' && os.status !== 'PAGA_CLIENTE' && (
                                                <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    {/* Lock actions if paid */}
                                                    {item.pagamentos_peca && item.pagamentos_peca.length > 0 && item.pagamentos_peca.some((pp: any) => pp.pago_ao_fornecedor) ? (
                                                        <span className="text-[9px] font-bold text-neutral-400 uppercase flex items-center gap-1">
                                                            <DollarSign size={10} /> Pago
                                                        </span>
                                                    ) : (
                                                        <>
                                                            <button onClick={() => handleEditItem(item)} className="p-1.5 hover:bg-blue-50 text-neutral-400 hover:text-blue-600 rounded-md transition-colors"><PenTool size={14} /></button>
                                                            <button onClick={() => handleDeleteItem(item.id_iten)} className="p-1.5 hover:bg-red-50 text-neutral-400 hover:text-red-600 rounded-md transition-colors"><X size={14} /></button>
                                                        </>
                                                    )}
                                                </div>
                                                )}
                                        </td>
                                    </tr>
                                ))}
                                {osItems.length === 0 && (
                                    <tr>
                                        <td colSpan={6} className="p-8 text-center text-neutral-300 text-xs italic">Nenhum item adicionado à lista.</td>
                                    </tr>
                                )}
                            </tbody>
                            </table>
                    </div>
                </div>

                {/* SAVE & CLOSE BUTTON (New) */}
                {['ABERTA', 'EM_ANDAMENTO'].includes(os.status) && (
                    <div className="flex justify-end">
                        <Button 
                            variant="secondary" 
                            onClick={handleSaveAndClose}
                            className="bg-neutral-800 text-neutral-200 border border-neutral-700 hover:bg-neutral-900 shadow-lg px-8 py-4 text-sm font-bold uppercase tracking-wider flex items-center gap-2"
                        >
                            <Save size={18} /> Salvar e Fechar
                        </Button>
                    </div>
                )}

                {/* Totals & Actions - Keep as is (below everything) */}
                <div className="relative overflow-hidden rounded-3xl bg-neutral-900 border border-neutral-800 shadow-2xl">
                    {/* Background Glow Effect */}
                    <div className="absolute top-0 right-0 -mt-20 -mr-20 w-96 h-96 bg-primary-900/20 rounded-full blur-3xl pointer-events-none"></div>

                    <div className="relative p-8 text-white space-y-8">
                        {/* Totals Row */}
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-8 pb-8 border-b border-neutral-800">
                            <div className="flex gap-12">
                                <div>
                                    <p className="text-[10px] font-black text-neutral-500 uppercase tracking-widest mb-1">Peças</p>
                                    <p className="font-medium text-lg text-neutral-300">R$ {osItems.reduce((acc, i) => acc + Number(i.valor_total), 0).toFixed(2)}</p>
                                </div>
                                <div>
                                    <p className="text-[10px] font-black text-neutral-500 uppercase tracking-widest mb-1">Mão de Obra</p>
                                    <p className="font-medium text-lg text-neutral-300">
                                    R$ {Number(laborServices.length > 0 
                                        ? laborServices.reduce((acc, l) => acc + Number(l.valor), 0) 
                                        : (os.valor_mao_de_obra || 0)
                                    ).toFixed(2)}
                                    </p>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="text-xs font-black text-success-500 uppercase tracking-widest mb-1">VALOR TOTAL</p>
                                <p className="font-black text-5xl tracking-tighter text-white drop-shadow-lg">
                                    R$ {(
                                    osItems.reduce((acc, i) => acc + Number(i.valor_total), 0) + 
                                    (laborServices.length > 0 ? laborServices.reduce((acc, l) => acc + Number(l.valor), 0) : Number(os.valor_mao_de_obra || 0))
                                ).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                                </p>
                            </div>
                        </div>

                        {/* Footer Actions Row */}
                        <div className="flex flex-col lg:flex-row justify-between items-center gap-6">
                            
                            {/* Payment Card - HIGH VISIBILITY REDESIGN */}
                            <div className="w-full lg:w-auto flex-1 max-w-2xl bg-neutral-800/50 rounded-2xl p-2 pr-4 flex items-center justify-between border border-neutral-700/50 hover:bg-neutral-800 transition-colors group">
                                <div className="flex items-center gap-4">
                                    <div className="bg-neutral-900 border border-neutral-800 p-3 rounded-xl shadow-lg">
                                        <DollarSign className="text-success-500" size={24} strokeWidth={2.5} />
                                    </div>
                                    <div>
                                        <div className="flex items-center gap-2 mb-1">
                                            <p className="text-[10px] font-black text-neutral-400 uppercase tracking-wider">Pagamentos Recebidos</p>
                                            {(() => {
                                                const totalItemsVal = osItems.reduce((acc, i) => acc + Number(i.valor_total || 0), 0);
                                                const totalLaborVal = laborServices.length > 0 
                                                    ? laborServices.reduce((acc, l) => acc + Number(l.valor || 0), 0) 
                                                    : Number(os.valor_mao_de_obra || 0);
                                                const totalOS = totalItemsVal + totalLaborVal;
                                                
                                                const payments = os.pagamentos_cliente || [];
                                                const totalPago = payments.filter(p => !p.deleted_at).reduce((acc, p) => acc + Number(p.valor), 0);
                                                
                                                const isOk = (totalOS - totalPago) <= 0.05; // Margem de 5 centavos
                                                
                                                return (
                                                    <span className={`px-1.5 py-0.5 rounded text-[9px] font-black uppercase ${isOk ? 'bg-success-500/20 text-success-400' : 'bg-red-500/20 text-red-400'}`}>
                                                        {isOk ? 'QUITADO' : 'PENDENTE'}
                                                    </span>
                                                );
                                            })()}
                                        </div>
                                        <p className="font-bold text-2xl text-white tracking-tight">
                                            R$ {(os.pagamentos_cliente || []).filter(p => !p.deleted_at).reduce((acc, p) => acc + Number(p.valor), 0).toFixed(2)}
                                        </p>
                                    </div>
                                </div>
                                <Button variant="secondary" onClick={() => setShowPaymentModal(true)} size="sm" className="bg-neutral-700 text-neutral-200 border-none hover:bg-neutral-600 font-bold uppercase text-xs h-9 px-4 ml-4">
                                    Gerenciar
                                </Button>
                            </div>
                            
                            <div className="flex gap-4 w-full lg:w-auto justify-end">
                                {['ABERTA', 'EM_ANDAMENTO'].includes(os.status) ? (
                                    <Button 
                                    onClick={handleFinishService} 
                                    variant="success" 
                                    className="w-full lg:w-auto px-8 py-5 h-auto text-lg font-black uppercase tracking-widest shadow-xl shadow-success-500/20 hover:scale-105 transition-all flex-1 lg:flex-none justify-center"
                                >
                                        <CheckCircle className="mr-3" size={24} strokeWidth={3} /> FINALIZAR OS
                                </Button>
                                ) : (
                                <div className="flex flex-col sm:flex-row items-center gap-3 w-full">
                                    {(os.status === 'PRONTO PARA FINANCEIRO' || os.status === 'FINALIZADA') && (
                                        <Button
                                            variant="secondary"
                                            onClick={async () => {
                                                try {
                                                    if (os.fechamento_financeiro) {
                                                        await api.delete(`/fechamento-financeiro/${os.fechamento_financeiro.id_fechamento_financeiro}`);
                                                    }
                                                    await api.put(`/ordem-de-servico/${os.id_os}`, { status: 'ABERTA' });
                                                    loadOsData(); 
                                                    setStatusMsg({ type: 'success', text: 'OS Reaberta com sucesso!' });
                                                } catch(e) {
                                                    setStatusMsg({ type: 'error', text: 'Erro ao reabrir OS.' });
                                                }
                                            }}
                                            className="bg-transparent border-2 border-dashed border-neutral-600 text-neutral-500 hover:text-white hover:bg-neutral-800 hover:border-neutral-500 px-6 py-4 h-auto w-full sm:w-auto font-bold uppercase transition-all"
                                        >
                                            REABRIR OS
                                        </Button>
                                    )}
                                    <div className="flex items-center justify-center gap-3 text-success-400 font-black bg-success-500/10 px-8 py-4 rounded-xl border border-success-500/20 w-full sm:w-auto">
                                        <BadgeCheck size={28} /> 
                                        <div className="flex flex-col text-left">
                                            <span className="text-[10px] text-success-600/70 uppercase leading-none">Status Atual</span>
                                            <span className="text-lg leading-none mt-1">{os.status}</span>
                                        </div>
                                    </div>
                                </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* SHARED MODALS */}
            {confirmModal.isOpen && (
                <Modal title={confirmModal.title} onClose={() => setConfirmModal(prev => ({...prev, isOpen: false}))}>
                    <p className="mb-6">{confirmModal.message}</p>
                    <div className="flex justify-end gap-2">
                        <Button variant="secondary" onClick={() => setConfirmModal(prev => ({...prev, isOpen: false}))}>Cancelar</Button>
                        <Button variant="danger" onClick={confirmModal.onConfirm}>Confirmar</Button>
                    </div>
                </Modal>
            )}

            {editItemModalOpen && editingItemData && (
                <Modal title="Editar Item" onClose={() => setEditItemModalOpen(false)}>
                    <div className="space-y-4">
                        <div>
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Descrição do Item</label>
                            <input 
                                className="w-full border p-2 rounded text-sm font-medium" 
                                value={editingItemData.descricao} 
                                onChange={e => setEditingItemData({...editingItemData, descricao: e.target.value})} 
                            />
                        </div>
                        <div>
                            <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Mais Informações (Código/Nota/Referência)</label>
                            <input 
                                className="w-full border p-2 rounded text-sm font-medium" 
                                placeholder="Ex: Número da peça, código de referência..."
                                value={editingItemData.codigo_referencia || ''} 
                                onChange={e => setEditingItemData({...editingItemData, codigo_referencia: e.target.value})} 
                            />
                        </div>
                        <div className="flex gap-2">
                            <div className="flex-1">
                                <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Quantidade</label>
                                <input 
                                    type="number" 
                                    className="w-full border p-2 rounded text-sm font-bold text-center" 
                                    value={editingItemData.quantidade} 
                                    onChange={e => setEditingItemData({...editingItemData, quantidade: e.target.value})} 
                                />
                            </div>
                            <div className="flex-1">
                                <label className="text-[10px] font-bold text-neutral-400 uppercase block mb-1">Valor Unit. (R$)</label>
                                <input 
                                    type="number" 
                                    className="w-full border p-2 rounded text-sm font-bold text-right" 
                                    value={editingItemData.valor_venda} 
                                    onChange={e => setEditingItemData({...editingItemData, valor_venda: e.target.value})} 
                                />
                            </div>
                        </div>
                        <div className="p-3 bg-neutral-50 rounded-lg">
                            <p className="text-[10px] font-bold text-neutral-400 uppercase mb-1">Valor Total</p>
                            <p className="text-xl font-black text-primary-600">R$ {(Number(editingItemData.quantidade || 0) * Number(editingItemData.valor_venda || 0)).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</p>
                        </div>
                        <Button onClick={handleSaveItemEdit} className="w-full mt-2">Salvar Alterações</Button>
                    </div>
                </Modal>
            )}
            {showPaymentModal && os && (
                <Modal title="Pagamentos" onClose={() => setShowPaymentModal(false)}>
                    {/* Lista de pagamentos existentes */}
                    {os.pagamentos_cliente && os.pagamentos_cliente.length > 0 && (
                        <div className="mb-6">
                            <h4 className="text-xs font-bold text-neutral-500 uppercase mb-2">Pagamentos Registrados</h4>
                            <div className="border rounded-xl overflow-hidden">
                                <table className="w-full text-xs">
                                    <thead className="bg-neutral-50">
                                        <tr>
                                            <th className="p-2 text-left">Data</th>
                                            <th className="p-2 text-left">Método</th>
                                            <th className="p-2 text-left">Bandeira</th>
                                            <th className="p-2 text-right">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {os.pagamentos_cliente.sort((a,b) => new Date(b.data_pagamento).getTime() - new Date(a.data_pagamento).getTime()).map(pag => {
                                            const isDeleted = !!pag.deleted_at;
                                            return (
                                                <tr key={pag.id_pagamento_cliente} className={isDeleted ? 'bg-red-50 opacity-60' : ''}>
                                                    <td className={`p-2 ${isDeleted ? 'line-through' : ''}`}>{new Date(pag.data_pagamento).toLocaleDateString()}</td>
                                                    <td className={`p-2 font-bold ${isDeleted ? 'line-through' : ''}`}>{pag.metodo_pagamento}</td>
                                                    <td className={`p-2 ${isDeleted ? 'line-through' : ''}`}>{pag.bandeira_cartao || '-'}</td>
                                                    <td className={`p-2 text-right font-bold ${isDeleted ? 'line-through text-red-800' : 'text-green-600'}`}>R$ {Number(pag.valor).toFixed(2)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                    <tfoot className="bg-green-50">
                                        <tr>
                                            <td colSpan={3} className="p-2 font-bold text-green-700">TOTAL PAGO</td>
                                            <td className="p-2 text-right font-black text-green-700">
                                                R$ {os.pagamentos_cliente.filter(p => !p.deleted_at).reduce((acc, p) => acc + Number(p.valor), 0).toFixed(2)}
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    )}
                    
                    <PagamentoClienteForm 
                        osId={os.id_os}
                        valorTotal={
                            (osItems.reduce((acc, i) => acc + Number(i.valor_total), 0) + laborServices.reduce((acc, l) => acc + Number(l.valor), 0)) -
                            ((os.pagamentos_cliente || []).filter(p => !p.deleted_at).reduce((acc, p) => acc + Number(p.valor), 0))
                        }
                        onSuccess={() => { setShowPaymentModal(false); loadOsData(); }}
                        onCancel={() => setShowPaymentModal(false)}
                    />
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\OrdemDeServicoPage.tsx
================================================================================
import { useState, useEffect, useCallback } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { api } from '../services/api';
import type { IOrdemDeServico } from '../types/backend';
import { Search, Plus, Phone, CheckCircle } from 'lucide-react';


import { StatusBanner } from '../components/ui/StatusBanner';
import { Modal } from '../components/ui/Modal';

export const OrdemDeServicoPage = () => {
    const navigate = useNavigate();

    // --- STATE ---
    const [searchTerm, setSearchTerm] = useState(''); // NEW: Localizar Search
    const [dateFilter, setDateFilter] = useState<'ALL' | 'HOJE' | 'SEMANA' | 'MES'>('HOJE');

    const [oss, setOss] = useState<IOrdemDeServico[]>([]);
    
    // Status Feedback
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });

    const location = useLocation();

    // --- DATA LOADING ---
    const loadOss = useCallback(async () => {
        try {
            const response = await api.get('/ordem-de-servico');
            setOss(response.data);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao carregar Ordens de Serviço.' });
        }
    }, []);




    // Wizard State for New OS
    const [newOsWizardStep, setNewOsWizardStep] = useState<'NONE' | 'OS'>('NONE');
    const [wizardClient, setWizardClient] = useState<any>(null);
    const [wizardVehicle, setWizardVehicle] = useState<any>(null);

    useEffect(() => {
        loadOss();

        const params = new URLSearchParams(location.search);
        const osId = params.get('id');
        const paramClientId = params.get('clientId');
        const paramVehicleId = params.get('vehicleId');

        if (osId) {
            handleOpenFromId(Number(osId));
        } else if (paramClientId && paramVehicleId) {
             const loadForDirectOpen = async () => {
                try {
                    const [cRes, vRes] = await Promise.all([
                        api.get(`/cliente/${paramClientId}`),
                        api.get(`/veiculo/${paramVehicleId}`)
                    ]);
                    setWizardClient(cRes.data);
                    setWizardVehicle(vRes.data);
                    setNewOsWizardStep('OS');
                } catch (e) {
                    console.error("Error loading for direct open", e);
                }
             };
             loadForDirectOpen();
        }
    }, [loadOss, location.search]);

    const handleOpenNewOsForExisting = (vehicle: any, client: any) => {
        if (!vehicle || !client) return;
        setWizardClient(client);
        setWizardVehicle(vehicle);
        setNewOsWizardStep('OS');
    };

    const handleCreateOsFinal = async (
        mechanicId: number | null = null, 
        km: number = 0, 
        defect: string = '',
        overrideVehicle: any = null,
        overrideClient: any = null
    ) => {
        const client = overrideClient || wizardClient;
        const vehicle = overrideVehicle || wizardVehicle;

        if (!client || !vehicle) return;

        try {
             const payload = {
                id_cliente: client.id_cliente,
                id_veiculo: vehicle.id_veiculo,
                id_funcionario: mechanicId || null,
                km_entrada: km,
                defeito_relatado: defect,
                status: 'ABERTA',
                valor_total_cliente: 0,
                valor_mao_de_obra: 0,
                parcelas: 1
            };
            const res = await api.post('/ordem-de-servico', payload);
            setNewOsWizardStep('NONE');
            setWizardClient(null);
            setWizardVehicle(null);
            handleNewOsSuccess(res.data.id_os);
            setStatusMsg({ type: 'success', text: 'OS Criada com Sucesso!' });
        } catch (e) {
            setStatusMsg({ type: 'error', text: 'Erro ao criar OS.' });
        }
    };

    // --- HANDLERS ---

    const handleOpenFromId = (id: number) => {
        navigate(`/ordem-de-servico/${id}`);
    };

    const handleNewOsSuccess = async (newOsId: number) => {
        handleOpenFromId(newOsId);
    };

    const handleManageItem = (os: IOrdemDeServico) => {
        handleOpenFromId(os.id_os);
    };


    // FILTER LOGIC
    const filteredOss = (Array.isArray(oss) ? oss : []).filter(os => {
        // 1. Date Filter
        if (dateFilter !== 'ALL') {
             const now = new Date();
             const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
             const osDate = new Date(os.dt_abertura);
             
             if (dateFilter === 'HOJE') {
                 if (osDate < startOfToday) return false;
             } else if (dateFilter === 'SEMANA') {
                 const weekAgo = new Date(startOfToday);
                 weekAgo.setDate(startOfToday.getDate() - 7);
                 if (osDate < weekAgo) return false;
             } else if (dateFilter === 'MES') {
                 const firstDayMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                 if (osDate < firstDayMonth) return false;
             }
        }

        if (!searchTerm) {
            // User requested to show ALL OSs (subject to Date Filter)
            // Previously restricted to 'ABERTA'. Now we show everything matching the date filter.
            return true; 
        }

        const q = searchTerm.toLowerCase();
        const plate = os.veiculo?.placa?.toLowerCase() || '';
        const model = os.veiculo?.modelo?.toLowerCase() || '';
        const brand = os.veiculo?.marca?.toLowerCase() || '';
        const color = os.veiculo?.cor?.toLowerCase() || '';
        const owner = (os.cliente?.pessoa_fisica?.pessoa?.nome || os.cliente?.pessoa_juridica?.razao_social || '').toLowerCase();
        const id = String(os.id_os);
        const fullIdHash = `#${os.id_os}`;
        
        return [plate, model, brand, color, owner, id, fullIdHash].join(' ').includes(q);
    });


    

    // --- RENDER ---
    const getStatusStyle = (status: string) => {
        switch (status) {
            case 'FINALIZADA': return 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200';
            case 'PAGA_CLIENTE': return 'bg-neutral-100 text-neutral-600 ring-1 ring-neutral-200';
            case 'PRONTO PARA FINANCEIRO': return 'bg-amber-100 text-amber-700 ring-1 ring-amber-200';
            case 'ABERTA': return 'bg-blue-100 text-blue-700 ring-1 ring-blue-200';
            case 'EM_ANDAMENTO': return 'bg-cyan-100 text-cyan-700 ring-1 ring-cyan-200';
            default: return 'bg-gray-50 text-gray-500 ring-1 ring-gray-200';
        }
    };

    return (
        <div className="space-y-6">
            {statusMsg.text && (
                <div className="fixed bottom-8 right-8 z-60">
                     <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({ type: null, text: '' })} />
                </div>
            )}

            {/* HEADER */}
            <div className="space-y-6">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h1 className="text-2xl font-bold text-neutral-900 tracking-tight">Ordens de Serviço</h1>
                        <p className="text-neutral-500">Gestão centralizada de atendimentos.</p>
                    </div>
                    <button 
                        onClick={() => navigate('/novo-cadastro')}
                        className="group bg-primary-600 text-white px-5 py-2.5 rounded-xl font-bold text-xs uppercase tracking-wider hover:bg-primary-700 transition-all shadow-lg shadow-primary-500/20 flex items-center gap-2 active:scale-95"
                    >
                        <Plus size={18} className="group-hover:rotate-90 transition-transform" />
                        Novo Cadastro
                    </button>
                </div>
            </div>


            {/* MAIN INTERFACE: SEARCH & LIST */}
            <div className="bg-white rounded-2xl shadow-sm border border-neutral-200 overflow-hidden animate-in fade-in duration-300">
                    <div className="p-6 border-b border-neutral-100 flex flex-col md:flex-row items-center justify-between gap-4">
                    <div className="flex-1 w-full relative">
                        <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400" size={20} />
                        <input 
                            value={searchTerm}
                            onChange={e => setSearchTerm(e.target.value)}
                            className="w-full pl-12 pr-4 py-3 rounded-xl border border-neutral-200 bg-neutral-50 focus:bg-white outline-none focus:border-primary-500 font-bold text-neutral-700 transition-all placeholder:text-neutral-400 placeholder:font-normal"
                            placeholder="Buscar por Placa, Cliente ou Modelo..."
                        />
                    </div>
                    
                    {/* Date Filters */}
                    <div className="flex bg-neutral-100 p-1 rounded-xl shrink-0">
                         {['ALL', 'HOJE', 'SEMANA', 'MES'].map((f) => (
                             <button
                                 key={f}
                                 onClick={() => setDateFilter(f as any)}
                                 className={`px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wider transition-all ${dateFilter === f ? 'bg-white text-neutral-900 shadow-sm' : 'text-neutral-500 hover:text-neutral-700'}`}
                             >
                                 {f === 'ALL' ? 'Todos' : f === 'MES' ? 'Mês' : f}
                             </button>
                         ))}
                    </div>
                </div>

                {/* SEARCH RESULTS */}
                <div className="overflow-x-auto">
                    <table className="w-full text-left">
                        <thead className="bg-neutral-50 border-b border-neutral-100">
                            <tr>
                                <th className="p-4 font-black text-neutral-400 uppercase text-[10px] tracking-widest">OS / Data</th>
                                <th className="p-4 font-black text-neutral-400 uppercase text-[10px] tracking-widest">Veículo</th>
                                <th className="p-4 font-black text-neutral-400 uppercase text-[10px] tracking-widest">Diagnóstico / Ações</th>
                                <th className="p-4 font-black text-neutral-400 uppercase text-[10px] tracking-widest">Técnico</th>
                                <th className="p-4 font-black text-neutral-400 uppercase text-[10px] tracking-widest">Cliente</th>
                                <th className="p-4 font-black text-neutral-400 uppercase text-[10px] tracking-widest text-center">Status</th>
                                <th className="p-4 font-black text-neutral-400 uppercase text-[10px] tracking-widest text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-neutral-50">
                            {filteredOss.sort((a,b) => b.id_os - a.id_os).map((os) => (
                                <tr key={os.id_os} className="hover:bg-neutral-25 transition-colors group">
                                    <td className="p-4">
                                        <div className="font-bold text-neutral-900">#{os.id_os}</div>
                                        <div className="text-[10px] text-neutral-400 font-medium">{new Date(os.dt_abertura).toLocaleDateString()}</div>
                                    </td>
                                    <td className="p-4">
                                        <div className="font-black text-neutral-700 tracking-tight text-sm uppercase">
                                            {os.veiculo?.placa} - {os.veiculo?.modelo} 
                                        </div>
                                        <div className="text-[10px] text-neutral-400 font-bold uppercase">
                                             ({os.veiculo?.cor || 'Cor N/I'})
                                        </div>
                                    </td>
                                    <td className="p-4 max-w-[200px]" title={os.diagnostico || os.defeito_relatado || 'Sem diagnóstico registrado'}>
                                        <p className="text-xs font-medium text-neutral-600 line-clamp-2">
                                            {os.diagnostico || os.defeito_relatado || <span className="text-neutral-300 italic">Pendente</span>}
                                        </p>
                                    </td>
                                    <td className="p-4">
                                        <p className="text-xs font-bold text-neutral-700 uppercase truncate max-w-[120px]" title="Responsável Técnico">
                                            {(() => {
                                                // @ts-ignore
                                                const mechanics = os.servicos_mao_de_obra?.map(s => s.funcionario?.pessoa_fisica?.pessoa?.nome?.split(' ')[0]).filter(Boolean);
                                                const uniqueMechanics = [...new Set(mechanics || [])];
                                                
                                                if (uniqueMechanics.length > 0) {
                                                    return uniqueMechanics.join(', ');
                                                }
                                                // Fallback to OS Creator/Owner
                                                return os.funcionario?.pessoa_fisica?.pessoa?.nome?.split(' ')[0] || <span className="text-neutral-300">---</span>;
                                            })()}
                                        </p>
                                    </td>
                                    <td className="p-4">
                                        <div className="font-bold text-neutral-700 text-sm truncate max-w-[150px]">
                                            {os.cliente?.pessoa_fisica?.pessoa?.nome || os.cliente?.pessoa_juridica?.razao_social || 'Desconhecido'}
                                        </div>
                                        <div className="text-[10px] text-neutral-400 font-medium">{os.cliente?.telefone_1}</div>
                                    </td>
                                    <td className="p-4 text-center">
                                        <span className={`px-3 py-1 rounded-full text-[10px] font-black uppercase ring-1 ${getStatusStyle(os.status)}`}>
                                            {os.status}
                                        </span>
                                    </td>
                                    <td className="p-4 text-right">
                                        <div className="flex justify-end gap-2">
                                            <button 
                                                onClick={() => handleManageItem(os)} 
                                                className="h-9 px-4 bg-neutral-50 border border-neutral-200 text-neutral-600 rounded-lg font-bold text-xs uppercase hover:bg-primary-600 hover:text-white hover:border-primary-600 transition-colors shadow-sm"
                                            >
                                                Gerenciar
                                            </button>
                                            
                                            {(os.status === 'FINALIZADA' || os.status === 'PRONTO PARA FINANCEIRO' || os.status === 'PAGA_CLIENTE') && (
                                                <button 
                                                    onClick={() => handleOpenNewOsForExisting(os.veiculo, os.cliente)}
                                                    className="h-9 px-4 bg-primary-50 border border-primary-100 text-primary-600 rounded-lg font-bold text-xs uppercase hover:bg-primary-600 hover:text-white hover:border-primary-600 transition-colors flex items-center gap-2 shadow-sm"
                                                    title="Nova OS para este veículo"
                                                    >
                                                    <Plus size={16} /> Nova OS
                                                </button>
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))}
                            {/* Empty/No Results: Show 'INICIAR NOVA OS' Button */}
                            {filteredOss.length === 0 && (
                                <tr>
                                    <td colSpan={5} className="p-12 text-center">
                                        <p className="font-bold text-neutral-400 mb-2">Nenhum registro encontrado.</p>
                                        <p className="text-sm text-neutral-400 mb-4">Deseja iniciar um novo atendimento?</p>
                                        <button 
                                            onClick={() => navigate('/novo-cadastro')}
                                            className="px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-xl font-bold inline-flex items-center gap-2 shadow-lg shadow-primary-500/20 transition-all"
                                        >
                                            <Plus size={20} /> NOVO CADASTRO
                                        </button>
                                    </td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* --- MODALS (SHARED) --- */}
            {/* WIZARD MODALS */}


            {/* WIZARD MODALS */}
            {/* Step 1 & 2 replaced by CadastroUnificadoPage. Only Step 3 (OS Confirmation) remains. */}


            {newOsWizardStep === 'OS' && wizardClient && wizardVehicle && (
                 <Modal title="Passo 3: Confirmar Abertura" onClose={() => setNewOsWizardStep('NONE')} className="max-w-xl">
                     <div className="space-y-6">
                         <div className="bg-primary-50 p-6 rounded-xl border border-primary-100 space-y-4">
                            <div className="flex justify-between items-start border-b border-primary-100 pb-4">
                                <div>
                                    <p className="text-[10px] font-bold text-primary-400 uppercase mb-1">Cliente</p>
                                    <p className="font-bold text-primary-900 text-lg leading-tight">{wizardClient.pessoa_fisica?.pessoa?.nome || wizardClient.pessoa_juridica?.razao_social}</p>
                                    <p className="text-sm text-primary-600 font-bold mt-1 flex items-center gap-1">
                                        <Phone size={14} className="text-primary-400" /> {wizardClient.telefone_1 || wizardClient.telefone_2 || 'Sem telefone'}
                                    </p>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <div className="flex-1">
                                    <p className="text-[10px] font-bold text-primary-400 uppercase mb-1">Veículo</p>
                                    <div className="flex items-center gap-3">
                                         {/* Gray Circle Removed */}
                                         <div>
                                            <p className="font-black text-primary-900 text-xl tracking-tight">{wizardVehicle.placa}</p>
                                            <p className="text-xs text-primary-600 font-bold uppercase">{wizardVehicle.modelo} • {wizardVehicle.cor}</p>
                                         </div>
                                    </div>
                                </div>
                            </div>
                         </div>
                         
                         <div className="bg-neutral-50 p-4 rounded-xl border border-neutral-100 text-center">
                             <p className="text-neutral-500 text-sm font-medium">Confirme os dados acima para iniciar a Ordem de Serviço.</p>
                         </div>
                         
                         <form onSubmit={(e) => {
                             e.preventDefault();
                             handleCreateOsFinal(null, 0, ''); // No mechanic, No KM, No Defect for now
                         }}>
                             <div className="pt-2 flex gap-3">
                                <button type="button" onClick={() => setNewOsWizardStep('NONE')} className="flex-1 py-4 text-sm font-bold text-neutral-500 hover:bg-neutral-50 rounded-xl transition-colors">CANCELAR</button>
                                <button type="submit" style={{ flex: 2 }} className="py-4 bg-neutral-900 text-white font-bold rounded-xl shadow-lg hover:bg-black transition-transform hover:-translate-y-1 flex items-center justify-center gap-2">
                                    <CheckCircle size={20} /> ABRIR ORDEM DE SERVIÇO
                                </button>
                             </div>
                         </form>
                     </div>
                 </Modal>
            )}

        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\PagamentoEquipePage.tsx
================================================================================
import { useState, useEffect, useMemo } from 'react';
import { api } from '../services/api';
import { StatusBanner } from '../components/ui/StatusBanner';
import { DollarSign, User, Search, AlertCircle } from 'lucide-react';

import { useNavigate } from 'react-router-dom';

export const PagamentoEquipePage = () => {
    const navigate = useNavigate();
    console.log('PagamentoEquipePage mounted');
    // --- STATE ---
    const [selectedFuncId, setSelectedFuncId] = useState('');
    const [activeTab, setActiveTab] = useState<'PENDENTE' | 'PAGO'>('PENDENTE');
    
    // Data States
    const [funcionarios, setFuncionarios] = useState<any[]>([]);
    const [pendentes, setPendentes] = useState<any[]>([]); 
    const [valesPendentes, setValesPendentes] = useState<any[]>([]);
    const [historico, setHistorico] = useState<any[]>([]);
    
    // UI
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });
    
    // Filters (History Tab)
    const [filterHistStart, setFilterHistStart] = useState('');
    const [filterHistEnd, setFilterHistEnd] = useState('');
    const [historySearchTerm, setHistorySearchTerm] = useState('');

    // --- EFFECTS ---
    useEffect(() => {
        loadFuncionarios();
    }, []);

    useEffect(() => {
        if (!selectedFuncId) {
            setPendentes([]);
            setValesPendentes([]);
            setHistorico([]);
            return;
        }
        
        if (activeTab === 'PENDENTE') {
            loadPendentes(selectedFuncId);
            loadVales(selectedFuncId);
        } else {
            loadHistorico(selectedFuncId);
        }
    }, [selectedFuncId, activeTab]);

    // --- LOADERS ---
    const loadFuncionarios = async () => {
        try { const res = await api.get('/funcionario'); setFuncionarios(res.data); } catch (e) { console.error(e); }
    };

    const loadPendentes = async (id: string) => {
        try {
            const res = await api.get(`/pagamento-equipe/pendentes/${id}`);
            setPendentes(res.data);
        } catch (e) { console.error(e); }
    };

    const loadVales = async (id: string) => {
        try {
            const res = await api.get(`/pagamento-equipe/vales/${id}`);
            setValesPendentes(res.data);
        } catch (e) { console.error(e); }
    };

    const loadHistorico = async (id: string) => {
        try {
            const res = await api.get('/pagamento-equipe'); 
            const filtered = res.data.filter((h: any) => String(h.id_funcionario) === String(id));
            setHistorico(filtered); 
        } catch(e) { console.error(e); }
    };

    // --- HELPERS ---
    const getComissaoInfo = (funcId: any, valorTotal: number) => {
        const func = funcionarios.find(f => String(f.id_funcionario) === String(funcId));
        const porcentagem = func?.comissao || 0;
        const valorComissao = (valorTotal * porcentagem) / 100;
        return { porcentagem, valorComissao };
    };

    // --- FILTERS & FLATTENING ---
    const flattenedHistorico = useMemo(() => {
        const flatList: any[] = [];
        
        historico.forEach(h => {
            const dtPagamento = h.dt_pagamento ? h.dt_pagamento.split('T')[0] : '';
            
            // Check Date Range Filter
            if (filterHistStart && dtPagamento < filterHistStart) return;
            if (filterHistEnd && dtPagamento > filterHistEnd) return;

            // 1. Add Commission Items (OSs)
            if (h.servicos_pagos && h.servicos_pagos.length > 0) {
                h.servicos_pagos.forEach((s: any) => {
                    flatList.push({
                        type: 'COMISSAO',
                        id: s.id_servico_mao_de_obra,
                        date: h.dt_pagamento,
                        os: s.ordem_de_servico,
                        value: s.valor, // Base labor value
                        commissionValue: getComissaoInfo(selectedFuncId, Number(s.valor)).valorComissao,
                        percentage: getComissaoInfo(selectedFuncId, Number(s.valor)).porcentagem,
                        paymentId: h.id_pagamento_equipe,
                        paymentMethod: h.forma_pagamento
                    });
                });
            }

            // 2. Add Bonus (Prêmio) if exists
            if (Number(h.premio_valor) > 0) {
                flatList.push({
                    type: 'PREMIO',
                    id: `premio-${h.id_pagamento_equipe}`,
                    date: h.dt_pagamento,
                    description: h.premio_descricao || 'Prêmio / Bônus',
                    value: Number(h.premio_valor),
                    paymentId: h.id_pagamento_equipe,
                    paymentMethod: h.forma_pagamento
                });
            }

            // 3. Add Vales (Adiantamentos) paid 
            if (h.tipo_lancamento === 'VALE') {
                 flatList.push({
                    type: 'VALE',
                    id: `vale-${h.id_pagamento_equipe}`,
                    date: h.dt_pagamento,
                    description: `Adiantamento (Vale)${h.obs ? ' - ' + h.obs : ''}`,
                    value: Number(h.valor_total),
                    paymentId: h.id_pagamento_equipe,
                    paymentMethod: h.forma_pagamento
                });
            }

            // 4. Add Salary/Other Check (Residual Value)
            // If the payment total is greater than the sum of commissions + bonuses, the remainder is Salário/Contrato
            const commissionTotal = h.servicos_pagos ? h.servicos_pagos.reduce((acc: number, s: any) => acc + Number(s.valor), 0) : 0;
            const premioVal = Number(h.premio_valor) || 0;
            // valeVal was unused
            
            // If it is NOT a Vale record, we check for residuals
            if (h.tipo_lancamento !== 'VALE') {
                const totalExplained = commissionTotal + premioVal;
                const residual = Number(h.valor_total) - totalExplained;

                if (residual > 0.05) { // Tolerance for float math
                    flatList.push({
                        type: 'SALARIO',
                        id: `salario-${h.id_pagamento_equipe}`,
                        date: h.dt_pagamento,
                        description: h.obs || 'Pagamento / Salário',
                        value: residual,
                        paymentId: h.id_pagamento_equipe,
                        paymentMethod: h.forma_pagamento
                    });
                }
            }
        });

        // Search Filter
        if (!historySearchTerm) return flatList;

        const lowSearch = historySearchTerm.toLowerCase();

        return flatList.filter(item => {
            // Common fields
            if (item.date && item.date.includes(lowSearch)) return true;
            if (String(item.value).includes(lowSearch)) return true;
            if (item.paymentMethod && item.paymentMethod.toLowerCase().includes(lowSearch)) return true;

            // OS Specific
            if (item.type === 'COMISSAO' && item.os) {
                if (String(item.os.id_os).includes(lowSearch)) return true;
                if (item.os.veiculo?.placa?.toLowerCase().includes(lowSearch)) return true;
                if (item.os.veiculo?.modelo?.toLowerCase().includes(lowSearch)) return true;
                if (item.os.veiculo?.cor?.toLowerCase().includes(lowSearch)) return true;
                if (item.os.cliente?.pessoa_fisica?.pessoa?.nome?.toLowerCase().includes(lowSearch)) return true;
                if (item.os.cliente?.pessoa_juridica?.razao_social?.toLowerCase().includes(lowSearch)) return true;
            }

            // Description Specific (Vale/Premio)
            if (item.description && item.description.toLowerCase().includes(lowSearch)) return true;

            return false;
        });

    }, [historico, filterHistStart, filterHistEnd, historySearchTerm, selectedFuncId, funcionarios]);

    // Recalculate total based on filtered view
    const totalHistorico = useMemo(() => {
        return flattenedHistorico.reduce((acc, item) => {
            if (item.type === 'COMISSAO') return acc + (item.commissionValue || 0);
            return acc + (item.value || 0);
        }, 0);
    }, [flattenedHistorico]);

    return (
        <div className="space-y-6 animate-in fade-in duration-500">
             <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({type: null, text: ''})} />

             {/* HEADER */}
             <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 className="text-2xl font-black text-neutral-900 tracking-tight">Pagamento da Equipe</h1>
                    <p className="text-neutral-500">Gestão individual de comissões e pagamentos.</p>
                </div>
            </div>

            {/* SELEÇÃO COLABORADOR */}
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-neutral-100">
                <label className="text-[10px] font-black text-neutral-400 uppercase tracking-widest block mb-2">Selecione o Colaborador</label>
                <div className="relative max-w-md">
                    <select
                        value={selectedFuncId}
                        onChange={(e) => setSelectedFuncId(e.target.value)}
                        className="w-full pl-4 pr-10 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-primary-500/20 appearance-none text-neutral-800"
                    >
                        <option value="">Selecione um colaborador...</option>
                        {funcionarios.map((f: any) => (
                            <option key={f.id_funcionario} value={f.id_funcionario}>
                                {f.pessoa_fisica?.pessoa?.nome}
                            </option>
                        ))}
                    </select>
                </div>
            </div>

            {selectedFuncId ? (
                <div className="animate-in slide-in-from-bottom-4 duration-500 space-y-6">
                    
                    {/* ACTION & TABS */}
                    <div className="flex flex-col sm:flex-row justify-between items-end gap-4">
                        <div className="flex gap-2 bg-white p-1 rounded-2xl border border-neutral-100 w-fit">
                            <button 
                                onClick={() => setActiveTab('PENDENTE')}
                                className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-wider transition-all ${activeTab === 'PENDENTE' ? 'bg-neutral-900 text-white shadow-md' : 'text-neutral-500 hover:bg-neutral-50'}`}
                            >
                                Visão Geral / Pendências
                            </button>
                            <button 
                                onClick={() => setActiveTab('PAGO')}
                                className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-wider transition-all ${activeTab === 'PAGO' ? 'bg-neutral-900 text-white shadow-md' : 'text-neutral-500 hover:bg-neutral-50'}`}
                            >
                                Histórico (Pagos)
                            </button>
                        </div>

                        <button 
                            onClick={() => navigate('/pagamento-equipe/novo', { state: { funcionarioId: selectedFuncId } })}
                            className="bg-emerald-500 text-white px-6 py-3 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-emerald-600 transition-all shadow-lg shadow-emerald-500/20 flex items-center gap-2 active:scale-95"
                        >
                            <DollarSign size={18} />
                            Novo Lançamento
                        </button>
                    </div>

                    {/* CONTENT AREA */}
                    <div className="bg-white rounded-3xl shadow-sm border border-neutral-100 overflow-hidden min-h-[400px]">
                        
                        {/* TAB: PENDENTE */}
                        {activeTab === 'PENDENTE' && (
                            <div className="p-0">
                                {/* ADIANTAMENTOS EM ABERTO */}
                                {valesPendentes.length > 0 && (
                                    <div className="mb-6 border-b border-neutral-100 pb-2">
                                        <div className="px-6 py-4 bg-amber-50/50 flex items-center gap-2">
                                            <AlertCircle size={16} className="text-amber-500" />
                                            <h3 className="text-xs font-black text-amber-700 uppercase tracking-widest">Adiantamentos (Vales) em Aberto</h3>
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left">
                                                <thead className="bg-white text-[10px] font-black text-neutral-400 uppercase tracking-widest">
                                                    <tr>
                                                        <th className="px-6 py-2">Data</th>
                                                        <th className="px-6 py-2">Descrição</th>
                                                        <th className="px-6 py-2 text-right">Valor</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-neutral-50">
                                                    {valesPendentes.map((vale, idx) => (
                                                        <tr key={`vale-${idx}`} className="text-sm">
                                                            <td className="px-6 py-3">{new Date(vale.dt_pagamento).toLocaleDateString()}</td>
                                                            <td className="px-6 py-3 text-neutral-600">{vale.obs || 'Adiantamento (Sem descrição)'}</td>
                                                            <td className="px-6 py-3 text-right font-black text-amber-600">R$ {Number(vale.valor_total).toFixed(2)}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                <div className="px-6 py-4 bg-neutral-50/50 border-b border-neutral-100">
                                    <h3 className="text-xs font-black text-neutral-500 uppercase tracking-widest">Comissões Pendentes</h3>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead className="bg-neutral-50 text-[10px] font-black text-neutral-400 uppercase tracking-widest">
                                            <tr>
                                                <th className="p-4">OS / Data</th>
                                                <th className="p-4">Veículo / Cliente</th>
                                                <th className="p-4 text-right">Valor Serviço</th>
                                                <th className="p-4 text-center">%</th>
                                                <th className="p-4 text-right">Valor A Receber</th>
                                                <th className="p-4 text-center">Status OS</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-neutral-50">
                                            {pendentes.length === 0 ? (
                                                <tr><td colSpan={6} className="p-12 text-center text-neutral-400 font-bold">Nenhuma comissão pendente encontrada.</td></tr>
                                            ) : (
                                                pendentes.map((item, idx) => {
                                                    const { porcentagem, valorComissao } = getComissaoInfo(selectedFuncId, Number(item.valor));
                                                    return (
                                                        <tr key={`${item.id_os}-${idx}`} className="hover:bg-neutral-50 transition-colors">
                                                            <td className="p-4">
                                                                <div className="font-black text-neutral-800">#{item.id_os}</div>
                                                                <div className="text-[10px] text-neutral-400">{new Date(item.ordem_de_servico?.dt_abertura).toLocaleDateString()}</div>
                                                            </td>
                                                            <td className="p-4">
                                                                <div className="text-xs font-bold text-neutral-800">
                                                                    {item.ordem_de_servico?.veiculo?.modelo} 
                                                                    {item.ordem_de_servico?.veiculo?.cor && <span className="text-neutral-500 font-normal ml-1">• {item.ordem_de_servico?.veiculo?.cor}</span>}
                                                                </div>
                                                                <div className="text-[10px] font-bold text-neutral-600 uppercase tracking-wider mt-0.5">{item.ordem_de_servico?.veiculo?.placa}</div>
                                                                <div className="text-[10px] text-neutral-400 mt-0.5">{item.ordem_de_servico?.cliente?.pessoa_fisica?.pessoa?.nome || item.ordem_de_servico?.cliente?.pessoa_juridica?.razao_social}</div>
                                                            </td>
                                                            <td className="p-4 text-right">
                                                                <span className="text-xs font-bold text-neutral-400">R$ {Number(item.valor).toFixed(2)}</span>
                                                            </td>
                                                            <td className="p-4 text-center">
                                                                <span className="text-xs font-bold text-neutral-500 bg-neutral-100 px-2 py-1 rounded">{porcentagem ? porcentagem : '0'}%</span>
                                                            </td>
                                                            <td className="p-4 text-right">
                                                                <span className="font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded">R$ {valorComissao.toFixed(2)}</span>
                                                            </td>
                                                            <td className="p-4 text-center">
                                                                <span className={`px-2 py-1 rounded-md text-[10px] font-black uppercase border ${
                                                                    item.ordem_de_servico?.status === 'ABERTA' ? 'bg-blue-50 text-blue-600 border-blue-100' :
                                                                    item.ordem_de_servico?.status === 'FINALIZADA' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' :
                                                                    item.ordem_de_servico?.status === 'CANCELADA' ? 'bg-red-50 text-red-600 border-red-100' :
                                                                    item.ordem_de_servico?.status === 'PRONTO_PARA_FINANCEIRO' ? 'bg-violet-50 text-violet-600 border-violet-100' :
                                                                    item.ordem_de_servico?.status === 'PAGA_CLIENTE' ? 'bg-cyan-50 text-cyan-600 border-cyan-100' :
                                                                    'bg-gray-50 text-gray-600 border-gray-100'
                                                                }`}>
                                                                    {item.ordem_de_servico?.status ? item.ordem_de_servico.status.replace(/_/g, ' ') : 'N/A'}
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    );
                                                })
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* TAB: PAGO (HISTORICO) */}
                        {activeTab === 'PAGO' && (
                            <div>
                                {/* FILTROS E BUSCA */}
                                <div className="p-4 border-b border-neutral-100 flex flex-col md:flex-row gap-4 items-end bg-neutral-50/50">
                                    <div className="flex gap-4 w-full md:w-auto">
                                        <div>
                                            <label className="text-[10px] font-black text-neutral-400 uppercase tracking-widest block mb-1">De</label>
                                            <input type="date" value={filterHistStart} onChange={e => setFilterHistStart(e.target.value)} className="w-full px-3 py-2 bg-white border border-neutral-200 rounded-lg text-xs font-bold outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-neutral-400 uppercase tracking-widest block mb-1">Até</label>
                                            <input type="date" value={filterHistEnd} onChange={e => setFilterHistEnd(e.target.value)} className="w-full px-3 py-2 bg-white border border-neutral-200 rounded-lg text-xs font-bold outline-none" />
                                        </div>
                                    </div>
                                    
                                    <div className="w-full relative">
                                        <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" />
                                        <input 
                                            type="text" 
                                            placeholder="Buscar por OS, Placa, Cliente, Veículo..." 
                                            value={historySearchTerm}
                                            onChange={(e) => setHistorySearchTerm(e.target.value)}
                                            className="w-full pl-10 pr-4 py-2 bg-white border border-neutral-200 rounded-lg text-xs font-bold outline-none focus:ring-2 focus:ring-primary-500/20"
                                        />
                                    </div>

                                    <div className="ml-auto flex flex-col items-end min-w-max">
                                        <span className="text-[9px] font-black uppercase tracking-widest text-neutral-400">Total Pago no Período</span>
                                        <span className="text-lg font-black text-neutral-900">R$ {totalHistorico.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
                                    </div>
                                </div>
                                
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead className="bg-neutral-50 text-[10px] font-black text-neutral-400 uppercase tracking-widest">
                                            <tr>
                                                <th className="p-4">Data Pagto</th>
                                                <th className="p-4">Tipo</th>
                                                <th className="p-4">OS / Detalhe</th>
                                                <th className="p-4">Veículo</th>
                                                <th className="p-4">Cliente</th>
                                                <th className="p-4 text-right">Valor Pago</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-neutral-50">
                                            {flattenedHistorico.length === 0 ? (
                                                <tr><td colSpan={6} className="p-12 text-center text-neutral-400 font-bold">Nenhum histórico encontrado.</td></tr>
                                            ) : (
                                                flattenedHistorico.map((item, idx) => (
                                                    <tr key={`${item.id}-${idx}`} className="hover:bg-neutral-50 transition-colors">
                                                        <td className="p-4 text-xs font-bold text-neutral-600">
                                                            {new Date(item.date).toLocaleDateString()}
                                                        </td>
                                                        <td className="p-4">
                                                            <span className={`px-2 py-1 rounded text-[9px] font-black uppercase tracking-wider ${
                                                                item.type === 'COMISSAO' ? 'bg-emerald-50 text-emerald-600' :
                                                                item.type === 'VALE' ? 'bg-amber-50 text-amber-600' :
                                                                'bg-blue-50 text-blue-600'
                                                            }`}>
                                                                {item.type}
                                                            </span>
                                                        </td>
                                                        <td className="p-4">
                                                            {item.type === 'COMISSAO' ? (
                                                                <div className="flex flex-col gap-1">
                                                                    <span className="font-black text-neutral-800">OS #{item.os.id_os}</span>
                                                                    {(item.os.defeito_relatado || item.os.diagnostico) && (
                                                                        <div className="text-[10px] text-neutral-500 leading-tight bg-neutral-100/50 p-1.5 rounded-md border border-neutral-100 max-w-[200px]">
                                                                            {item.os.defeito_relatado && <div className="mb-0.5"><span className="font-bold text-neutral-600">Def:</span> {item.os.defeito_relatado}</div>}
                                                                            {item.os.diagnostico && <div><span className="font-bold text-neutral-600">Diag:</span> {item.os.diagnostico}</div>}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ) : (
                                                                <span className="text-xs font-medium text-neutral-600">{item.description}</span>
                                                            )}
                                                        </td>
                                                        <td className="p-4">
                                                            {item.type === 'COMISSAO' ? (
                                                                <div className="text-xs">
                                                                    <div className="font-bold text-neutral-800">{item.os.veiculo?.modelo}</div>
                                                                    <div className="text-[10px] text-neutral-500">{item.os.veiculo?.placa} • {item.os.veiculo?.cor}</div>
                                                                </div>
                                                            ) : (
                                                                <span className="text-neutral-300 transform scale-150 block w-4 h-px bg-neutral-200 is-dash"></span>
                                                            )}
                                                        </td>
                                                        <td className="p-4">
                                                            {item.type === 'COMISSAO' ? (
                                                                <div className="text-xs font-medium text-neutral-700">
                                                                    {item.os.cliente?.pessoa_fisica?.pessoa?.nome || item.os.cliente?.pessoa_juridica?.razao_social}
                                                                </div>
                                                            ) : (
                                                                <span className="text-neutral-300 transform scale-150 block w-4 h-px bg-neutral-200 is-dash"></span>
                                                            )}
                                                        </td>
                                                        <td className="p-4 text-right">
                                                            <div className="font-black text-neutral-800 text-xs">
                                                                R$ {(item.type === 'COMISSAO' ? item.commissionValue : item.value).toFixed(2)}
                                                            </div>
                                                            {item.type === 'COMISSAO' && (
                                                                <div className="text-[9px] text-neutral-400">({item.percentage}%)</div>
                                                            )}
                                                        </td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            ) : (
                // EMPTY STATE
                <div className="bg-white rounded-3xl border border-dashed border-neutral-300 p-12 flex flex-col items-center justify-center text-center mt-6">
                    <div className="w-16 h-16 bg-neutral-100 rounded-full flex items-center justify-center text-neutral-400 mb-4">
                        <User size={32} />
                    </div>
                    <h3 className="font-black text-lg text-neutral-800">Nenhum Colaborador Selecionado</h3>
                    <p className="text-neutral-500 max-w-sm mt-2">
                        Selecione um colaborador na lista acima para visualizar suas comissões, histórico e realizar pagamentos.
                    </p>
                </div>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\PagamentoPecaPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import { StatusBanner } from '../components/ui/StatusBanner';
import { 
    Search, Truck, Calendar, CheckSquare, Square, 
    Edit, Trash2, Save, CalendarCheck, DollarSign, X
} from 'lucide-react';
import { Modal } from '../components/ui/Modal';

export const PagamentoPecaPage = () => {
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });
    const [, setLoading] = useState(false);

    // --- STATES FOR ACCOUNTS PAYABLE (PEÇAS) ---
    const [payments, setPayments] = useState<any[]>([]);
    const [fornecedores, setFornecedores] = useState<any[]>([]);
    const [filterSupplier, setFilterSupplier] = useState('');
    const [filterPlate, setFilterPlate] = useState('');
    const [filterStatus, setFilterStatus] = useState<'PENDING' | 'PAID' | 'ALL'>('PENDING');
    
    // NEW FILTERS
    const [filterOSStart, setFilterOSStart] = useState('');
    const [filterOSEnd, setFilterOSEnd] = useState('');
    const [filterPayStart, setFilterPayStart] = useState('');
    const [filterPayEnd, setFilterPayEnd] = useState('');

    // Batch Selection State
    const [selectedIds, setSelectedIds] = useState<number[]>([]);

    const [editPayment, setEditPayment] = useState<any | null>(null);
    const [showEditModal, setShowEditModal] = useState(false);
    const [confirmModal, setConfirmModal] = useState<{isOpen: boolean; title: string; message: string; onConfirm: () => void}>({ isOpen: false, title: '', message: '', onConfirm: () => {} });

    useEffect(() => {
        loadData();
    }, []);

    // Clear selection when filters change (optional, but safer to avoid hidden selections)
    useEffect(() => {
        setSelectedIds([]);
    }, [filterStatus, filterSupplier, filterPlate, filterOSStart, filterOSEnd, filterPayStart, filterPayEnd]);

    const loadData = async () => {
        try {
            setLoading(true);
            const [paymentsRes, fornecedoresRes] = await Promise.all([
                api.get('/pagamento-peca'),
                api.get('/fornecedor')
            ]);
            setPayments(paymentsRes.data);
            setFornecedores(fornecedoresRes.data);
        } catch (error) {
            console.error(error);
            setStatusMsg({ type: 'error', text: 'Erro ao carregar dados financeiros.' });
        } finally {
            setLoading(false);
        }
    };

    const toggleSelection = (id: number) => {
        setSelectedIds(prev => 
            prev.includes(id) 
                ? prev.filter(x => x !== id) 
                : [...prev, id]
        );
    };

    const clearFilters = () => {
        setFilterStatus('PENDING'); // Or 'ALL', but defaulting to PENDING is usually safer flow
        setFilterSupplier('');
        setFilterPlate('');
        setFilterOSStart('');
        setFilterOSEnd('');
        setFilterPayStart('');
        setFilterPayEnd('');
        setSelectedIds([]);
    };

    const handleUnpay = async (id: number) => {
        try {
            setLoading(true);
            await api.put(`/pagamento-peca/${id}`, {
                pago_ao_fornecedor: false,
                data_pagamento_fornecedor: null
            });
            setStatusMsg({ type: 'success', text: 'Pagamento desfeito! Item voltou para Pendente.' });
            loadData();
            setTimeout(() => setStatusMsg({ type: null, text: '' }), 3000);
        } catch (error) {
            console.error(error);
            setStatusMsg({ type: 'error', text: 'Erro ao desfazer pagamento.' });
        } finally {
            setLoading(false);
        }
    };

    const handleBatchConfirm = async () => {
        if (selectedIds.length === 0) {
            setStatusMsg({ type: 'error', text: 'Nenhum item selecionado para pagamento.' });
            return;
        }

        try {
            setLoading(true);
            
            // Process updates in parallel
            await Promise.all(selectedIds.map(id => {
                return api.put(`/pagamento-peca/${id}`, {
                    pago_ao_fornecedor: true,
                    data_pagamento_fornecedor: new Date() // Saves current timestamp
                });
            }));

            setStatusMsg({ type: 'success', text: `${selectedIds.length} pagamentos confirmados com sucesso!` });
            
            // Clear selection and reload
            setSelectedIds([]);
            loadData();
        } catch (error) {
            console.error(error);
            setStatusMsg({ type: 'error', text: 'Erro ao processar pagamentos em lote.' });
        } finally {
            setLoading(false);
        }
    };

    const handleDeletePayment = (id: number) => {
        setConfirmModal({
            isOpen: true,
            title: 'Excluir Pagamento',
            message: 'Tem certeza que deseja excluir este registro de conta a pagar? Esta ação é irreversível.',
            onConfirm: async () => {
                try {
                    setLoading(true);
                    await api.delete(`/pagamento-peca/${id}`);
                    setStatusMsg({ type: 'success', text: 'Pagamento excluído com sucesso!' });
                    loadData();
                } catch (error) {
                    setStatusMsg({ type: 'error', text: 'Erro ao excluir pagamento.' });
                } finally {
                    setLoading(false);
                    setConfirmModal(prev => ({...prev, isOpen: false}));
                }
            }
        });
    };

    const handleUpdatePayment = async () => {
        if (!editPayment) return;
        try {
            setLoading(true);
            await api.put(`/pagamento-peca/${editPayment.id_pagamento_peca}`, {
                custo_real: Number(editPayment.custo_real),
                id_fornecedor: Number(editPayment.id_fornecedor),
                // Keep data_compra managed if needed, but for now we focus on payment date
                data_compra: new Date(editPayment.data_compra), 
                data_pagamento_fornecedor: editPayment.data_pagamento_fornecedor ? new Date(editPayment.data_pagamento_fornecedor) : null,
                pago_ao_fornecedor: editPayment.pago_ao_fornecedor
            });
            
            if (editPayment.item_os && editPayment.ref_nota) {
                 await api.put(`/itens-os/${editPayment.item_os.id_iten}`, {
                     codigo_referencia: editPayment.ref_nota
                 });
            }

            setStatusMsg({ type: 'success', text: 'Dados atualizados com sucesso!' });
            loadData();
            setShowEditModal(false);
            setEditPayment(null);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao atualizar pagamento.' });
        } finally {
            setLoading(false);
        }
    };

    const openEditModal = (payment: any) => {
        setEditPayment({
            ...payment,
            data_compra: new Date(payment.data_compra).toISOString().split('T')[0],
            data_pagamento_fornecedor: payment.data_pagamento_fornecedor ? new Date(payment.data_pagamento_fornecedor).toISOString().split('T')[0] : '',
            ref_nota: payment.item_os?.codigo_referencia || ''
        });
        setShowEditModal(true);
    };

    const filteredPayments = payments.filter(p => {
        // --- HELPER FOR ROBUST LOCAL DATE COMPARISON ---
        // Converts "YYYY-MM-DD" string to a local Date object at 00:00:00 or 23:59:59
        const getLocalStart = (dateStr: string) => {
            if (!dateStr) return null;
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d, 0, 0, 0, 0);
        };
        const getLocalEnd = (dateStr: string) => {
            if (!dateStr) return null;
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d, 23, 59, 59, 999);
        };

        // 1. Status Filter
        if (filterStatus === 'PENDING' && p.pago_ao_fornecedor) return false;
        if (filterStatus === 'PAID' && !p.pago_ao_fornecedor) return false;
        
        // 2. OS Finish Date Filter (dt_entrega)
        if (filterOSStart || filterOSEnd) {
            // Cannot filter by OS date if OS date doesn't exist
            if (!p.item_os?.ordem_de_servico?.dt_entrega) return false;
            
            const osDate = new Date(p.item_os.ordem_de_servico.dt_entrega);
            
            if (filterOSStart) {
                const start = getLocalStart(filterOSStart);
                if (start && osDate < start) return false;
            }
            if (filterOSEnd) {
                const end = getLocalEnd(filterOSEnd);
                if (end && osDate > end) return false;
            }
        }

        // 3. Payment to Supplier Date Filter (data_pagamento_fornecedor)
        if (filterPayStart || filterPayEnd) {
             // If we are filtering by payment date, the item MUST have a payment date
             if (!p.data_pagamento_fornecedor) return false;
             
             const payDate = new Date(p.data_pagamento_fornecedor);

             if (filterPayStart) {
                 const start = getLocalStart(filterPayStart);
                 if (start && payDate < start) return false;
             }
             if (filterPayEnd) {
                 const end = getLocalEnd(filterPayEnd);
                 if (end && payDate > end) return false;
             }
        }

        // 4. Supplier Filter
        if (filterSupplier && filterSupplier !== "") {
            if (String(p.id_fornecedor) !== String(filterSupplier)) return false;
        }

        // 5. General Search (was Plate Filter)
        if (filterPlate) {
            const q = filterPlate.toLowerCase();
            const plate = p.item_os?.ordem_de_servico?.veiculo?.placa?.toLowerCase() || '';
            const model = p.item_os?.ordem_de_servico?.veiculo?.modelo?.toLowerCase() || '';
            const color = p.item_os?.ordem_de_servico?.veiculo?.cor?.toLowerCase() || '';
            const supplier = p.fornecedor?.nome?.toLowerCase() || '';
            const desc = p.item_os?.descricao?.toLowerCase() || '';
            const osId = String(p.item_os?.id_os || '');
            const fullOsId = `#${osId}`;
            
            const searchable = [plate, model, color, supplier, desc, osId, fullOsId].join(' ');
            
            if (!searchable.includes(q)) return false;
        }
        
        return true;
    }).sort((a,b) => new Date(b.data_compra || 0).getTime() - new Date(a.data_compra || 0).getTime());

    // Calculate totals
    const totalSelected = filteredPayments
        .filter(p => selectedIds.includes(p.id_pagamento_peca))
        .reduce((acc, p) => acc + Number(p.custo_real), 0);



    return (
        <div className="space-y-6 animate-in fade-in duration-500">
            <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({type: null, text: ''})} />

            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 className="text-2xl font-black text-neutral-900 tracking-tight">Pagamento de Auto Peças</h1>
                    <p className="text-neutral-500">Controle de pagamento de peças para fornecedores.</p>
                </div>
            </div>

            <div className="space-y-6">
                {/* Filters */}
                <div className="bg-white p-6 rounded-2xl border border-neutral-100 shadow-sm grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    
                    <div className="md:col-span-3">
                        <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Status</label>
                        <div className="flex bg-neutral-100 rounded-xl p-1 gap-2">
                            <button onClick={() => setFilterStatus('PENDING')} className={`flex-1 py-2 rounded-lg text-xs font-black transition-all ${filterStatus === 'PENDING' ? 'bg-white shadow text-neutral-900' : 'text-neutral-400 hover:text-neutral-600'}`}>PENDENTES</button>
                            <button onClick={() => setFilterStatus('PAID')} className={`flex-1 py-2 rounded-lg text-xs font-black transition-all ${filterStatus === 'PAID' ? 'bg-white shadow text-green-600' : 'text-neutral-400 hover:text-neutral-600'}`}>PAGAS</button>
                            <button onClick={() => setFilterStatus('ALL')} className={`flex-1 py-2 rounded-lg text-xs font-black transition-all ${filterStatus === 'ALL' ? 'bg-white shadow text-neutral-900' : 'text-neutral-400 hover:text-neutral-600'}`}>TODAS</button>
                        </div>
                    </div>
                    
                    <div className="md:col-span-3">
                        <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Fornecedor</label>
                        <select 
                            value={filterSupplier}
                            onChange={(e) => setFilterSupplier(e.target.value)}
                            className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400 transition-colors"
                        >
                            <option value="">Todos</option>
                            {fornecedores.map(f => (
                                <option key={f.id_fornecedor} value={f.id_fornecedor}>{f.nome}</option>
                            ))}
                        </select>
                    </div>

                    <div className="md:col-span-3">
                            <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Buscar (Geral)</label>
                            <div className="relative">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" size={16} />
                            <input 
                                value={filterPlate}
                                onChange={(e) => setFilterPlate(e.target.value)}
                                placeholder="Placa, OS, Fornecedor..."
                                className="w-full pl-10 pr-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold text-sm outline-none focus:border-neutral-400 transition-colors"
                            />
                            </div>
                    </div>

                    {/* Clear Filters Button */}
                    <div className="md:col-span-3 flex md:justify-end">
                        <button 
                            onClick={clearFilters}
                            className="flex items-center gap-2 px-4 py-3 bg-neutral-100 hover:bg-neutral-200 text-neutral-500 font-bold rounded-xl transition-colors text-xs uppercase w-full md:w-auto justify-center"
                            title="Limpar todos os filtros"
                        >
                            <X size={16} />
                            Limpar Filtros
                        </button>
                    </div>
                    
                    {/* NEW DOUBLE DATE FILTER */}
                    <div className="md:col-span-12 grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* Filter 1: OS Finish */}
                        <div className="bg-neutral-50 p-4 rounded-xl border border-neutral-200 shadow-sm flex flex-col justify-center">
                             <div className="flex items-center gap-2 mb-2">
                                <CalendarCheck size={16} className="text-blue-500" />
                                <span className="text-[10px] font-black text-neutral-600 uppercase">Filtro: Finalização da OS</span>
                            </div>
                            <div className="flex items-end gap-2">
                                <div>
                                    <label className="text-[9px] font-bold text-neutral-400 uppercase mb-1 block">De</label>
                                    <input 
                                        type="date" 
                                        value={filterOSStart} 
                                        onChange={e => setFilterOSStart(e.target.value)} 
                                        className="bg-white border border-neutral-200 p-1.5 rounded-lg font-bold text-xs outline-none focus:border-neutral-400 transition-colors uppercase w-[130px]"
                                    />
                                </div>
                                <div>
                                    <label className="text-[9px] font-bold text-neutral-400 uppercase mb-1 block">Até</label>
                                    <input 
                                        type="date" 
                                        value={filterOSEnd} 
                                        onChange={e => setFilterOSEnd(e.target.value)} 
                                        className="bg-white border border-neutral-200 p-1.5 rounded-lg font-bold text-xs outline-none focus:border-neutral-400 transition-colors uppercase w-[130px]"
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Filter 2: Payment Date */}
                        <div className="bg-neutral-50 p-4 rounded-xl border border-neutral-200 shadow-sm flex flex-col justify-center">
                             <div className="flex items-center gap-2 mb-2">
                                <DollarSign size={16} className="text-green-500" />
                                <span className="text-[10px] font-black text-neutral-600 uppercase">Filtro: Pagamento Fornecedor</span>
                            </div>
                            <div className="flex items-end gap-2">
                                <div>
                                    <label className="text-[9px] font-bold text-neutral-400 uppercase mb-1 block">De</label>
                                    <input 
                                        type="date" 
                                        value={filterPayStart} 
                                        onChange={e => setFilterPayStart(e.target.value)} 
                                        className="bg-white border border-neutral-200 p-1.5 rounded-lg font-bold text-xs outline-none focus:border-neutral-400 transition-colors uppercase w-[130px]"
                                    />
                                </div>
                                <div>
                                    <label className="text-[9px] font-bold text-neutral-400 uppercase mb-1 block">Até</label>
                                    <input 
                                        type="date" 
                                        value={filterPayEnd} 
                                        onChange={e => setFilterPayEnd(e.target.value)} 
                                        className="bg-white border border-neutral-200 p-1.5 rounded-lg font-bold text-xs outline-none focus:border-neutral-400 transition-colors uppercase w-[130px]"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Totals Summary */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {/* CARD 1: SELETOR DE BAIXA (Checkboxes) - Show only if items selected */}
                    {selectedIds.length > 0 ? (
                        <div className="bg-blue-600 p-6 rounded-2xl flex items-center justify-between shadow-xl shadow-blue-500/20 text-white animate-in zoom-in duration-300">
                             <div>
                                <p className="text-[10px] font-black uppercase tracking-widest mb-1 opacity-80">Selecionado para Baixa ({selectedIds.length})</p>
                                <p className="text-3xl font-black tracking-tighter">
                                    R$ {totalSelected.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                                </p>
                             </div>
                             <div className="flex flex-col items-end gap-2">
                                <button 
                                    onClick={handleBatchConfirm}
                                    className="px-4 py-2 bg-white text-blue-600 text-xs font-black uppercase rounded-lg shadow hover:bg-neutral-50 active:scale-95 transition-all flex items-center gap-2"
                                >
                                    <Save size={14} />
                                    Confirmar Baixa
                                </button>
                             </div>
                        </div>
                    ) : (
                        // Placeholder or Info when nothing selected? Or keep hidden?
                        // Let's show TOTAL FILTRADO (PENDENTE + PAGO displayed)
                         <div className="bg-white p-6 rounded-2xl border border-neutral-100 flex items-center justify-between">
                            <div>
                                <p className="text-[10px] font-black text-neutral-400 uppercase tracking-widest">Total Listado (Status Atual)</p>
                                <p className="text-3xl font-black text-neutral-800">
                                    R$ {filteredPayments.reduce((acc, p) => acc + Number(p.custo_real), 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                                </p>
                                <p className="text-[10px] font-bold text-neutral-300 mt-2">{filteredPayments.length} registros encontrados</p>
                            </div>
                            <div className="p-3 bg-neutral-50 rounded-xl text-neutral-300"><Search size={24} /></div>
                        </div>
                    )}

                    {/* CARD 2: TOTAL PAGO (Only filtered paid items) - OR GENERAL STATS */}
                    {/* User requested simple "Total Selecionado" summing filtered values. 
                        If filter is PENDING, sums pending. If PAID, sums paid. If ALL, sums ALL.
                        The card above does exactly this (sums filteredPayments).
                        
                        Let's refine:
                        Card 1 (Left): Total Filtrado (Soma do que está na tela). "Total Selecionado" label as requested.
                        Card 2 (Right): Total Pendente de Baixa (Checkboxes) - if any. OR Total Pago Histórico Global?
                    */}
                    
                    <div className="bg-neutral-900 text-white p-6 rounded-2xl flex items-center justify-between shadow-lg">
                        <div>
                            <p className="text-[10px] font-black uppercase tracking-widest opacity-60">Total Selecionado (Filtro)</p>
                            <p className="text-3xl font-black">
                                R$ {filteredPayments.reduce((acc, p) => acc + Number(p.custo_real), 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                            </p>
                        </div>
                         <div className="p-3 bg-white/10 rounded-xl text-white/50"><DollarSign size={24} /></div>
                    </div>
                </div>

                {/* Table */}
                <div className="bg-white rounded-3xl shadow-sm border border-neutral-100 overflow-hidden w-full">
                    <table className="w-full text-left border-collapse min-w-[800px]">
                        <thead>
                            <tr className="bg-neutral-50 text-[10px] font-black text-neutral-400 uppercase tracking-widest">
                                <th className="p-5">Data Inserção</th>
                                <th className="p-5">Ref / Nota</th>
                                <th className="p-5">Peça</th>
                                <th className="p-5">Fornecedor</th>
                                <th className="p-5">Veículo / OS</th>
                                <th className="p-5">Status OS</th>
                                <th className="p-5 text-right w-32">Valor Custo</th>
                                <th className="p-5 text-center w-24">Pagar</th>
                                <th className="p-5 text-center w-16">Editar</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-neutral-50">
                            {filteredPayments.length === 0 ? (
                                    <tr><td colSpan={7} className="p-10 text-center text-neutral-400 italic font-medium">Nenhum registro encontrado.</td></tr>
                            ) : (
                                filteredPayments.map(p => (
                                    <tr key={p.id_pagamento_peca} className={`hover:bg-neutral-25 transition-colors ${p.pago_ao_fornecedor ? 'bg-neutral-50/50' : ''}`}>
                                        <td className="p-5">
                                            <div className="flex items-center gap-2 font-bold text-neutral-600 text-xs">
                                                <Calendar size={14} />
                                                {/* DATA INSERÇÃO NA OS (from item_os.dt_cadastro) */}
                                                {p.item_os?.dt_cadastro 
                                                    ? new Date(p.item_os.dt_cadastro).toLocaleDateString()
                                                    : 'N/A'
                                                }
                                            </div>
                                        </td>
                                        <td className="p-5">
                                            <span className="font-mono text-xs font-black text-neutral-600 bg-neutral-100 px-2 py-1 rounded w-fit">
                                                {p.item_os?.codigo_referencia || '---'}
                                            </span>
                                        </td>
                                        <td className="p-5">
                                            <p className="font-bold text-neutral-900 text-sm">{p.item_os?.descricao}</p>
                                        </td>
                                        <td className="p-5">
                                            <div className="flex items-center gap-2">
                                                <Truck size={14} className="text-orange-500" />
                                                <span className="font-bold text-neutral-700 text-xs uppercase">{p.fornecedor?.nome}</span>
                                            </div>
                                        </td>
                                        <td className="p-5">
                                            <div className="flex flex-col">
                                                <p className="font-black text-neutral-800 text-xs uppercase tracking-widest bg-neutral-100 px-2 py-1 rounded w-fit">
                                                    {p.item_os?.ordem_de_servico?.veiculo?.placa || '---'}
                                                </p>
                                                <p className="text-[10px] text-neutral-500 font-bold mt-1 uppercase">
                                                    {p.item_os?.ordem_de_servico?.veiculo?.modelo || 'N/A'} {p.item_os?.ordem_de_servico?.veiculo?.cor ? `• ${p.item_os.ordem_de_servico.veiculo.cor}` : ''}
                                                </p>
                                                
                                                <p className="text-[10px] text-neutral-400 font-bold mt-0.5">OS #{p.item_os?.id_os}</p>
                                                {/* Optional: Show OS Finish Date if available */}
                                                {p.item_os?.ordem_de_servico?.dt_entrega && (
                                                    <p className="text-[9px] text-green-600 font-bold mt-1">
                                                        Fim OS: {new Date(p.item_os.ordem_de_servico.dt_entrega).toLocaleDateString()}
                                                    </p>
                                                )}
                                            </div>
                                        </td>
                                        <td className="p-5">
                                             {(() => {
                                                 const st = p.item_os?.ordem_de_servico?.status || 'ABERTA';
                                                 const styles: Record<string, string> = {
                                                    'FINALIZADA': 'bg-emerald-100 text-emerald-700 ring-emerald-200',
                                                    'PAGA_CLIENTE': 'bg-neutral-100 text-neutral-600 ring-neutral-200',
                                                    'PRONTO PARA FINANCEIRO': 'bg-amber-100 text-amber-700 ring-amber-200',
                                                    'ABERTA': 'bg-blue-100 text-blue-700 ring-blue-200',
                                                    'EM_ANDAMENTO': 'bg-cyan-100 text-cyan-700 ring-cyan-200',
                                                    'CANCELADA': 'bg-red-100 text-red-700 ring-red-200'
                                                 };
                                                 const style = styles[st] || 'bg-gray-50 text-gray-500 ring-gray-200';
                                                 
                                                 return (
                                                     <span className={`px-2 py-1 rounded-md text-[9px] font-black uppercase ring-1 whitespace-nowrap ${style}`}>
                                                         {st.replace(/_/g, ' ')}
                                                     </span>
                                                 );
                                             })()}
                                        </td>
                                        <td className="p-5 text-right font-black text-neutral-900">
                                            R$ {Number(p.custo_real).toFixed(2)}
                                        </td>
                                        <td className="p-5 text-center">
                                            {p.pago_ao_fornecedor ? (
                                                <div className="flex flex-col items-center">
                                                    <button 
                                                        onClick={() => handleUnpay(p.id_pagamento_peca)}
                                                        className="hover:scale-110 transition-transform active:scale-95 text-neutral-400 hover:text-green-600"
                                                        title={`Pago em: ${p.data_pagamento_fornecedor ? new Date(p.data_pagamento_fornecedor).toLocaleDateString() : 'N/A'} (Clique para desfazer)`}
                                                    >
                                                        <CheckSquare size={32} className="text-green-500 fill-green-500/20" />
                                                    </button>
                                                    {p.data_pagamento_fornecedor && (
                                                        <span className="text-[9px] font-bold text-green-600 mt-1">
                                                            {new Date(p.data_pagamento_fornecedor).toLocaleDateString()}
                                                        </span>
                                                    )}
                                                </div>
                                            ) : (
                                                <button 
                                                    onClick={() => toggleSelection(p.id_pagamento_peca)}
                                                    className="hover:scale-110 transition-transform active:scale-95 text-neutral-300 hover:text-blue-500"
                                                    title={selectedIds.includes(p.id_pagamento_peca) ? "Desmarcar" : "Selecionar para pagamento"}
                                                >
                                                    {selectedIds.includes(p.id_pagamento_peca) ? (
                                                        <CheckSquare size={32} className="text-green-500 fill-green-500/20" />
                                                    ) : (
                                                        <Square size={32} className="stroke-[2.5]" />
                                                    )}
                                                </button>
                                            )}
                                        </td>
                                        <td className="p-5 text-center">
                                            <div className="flex justify-center gap-2">
                                                <button 
                                                    onClick={() => openEditModal(p)}
                                                    className="p-2 text-neutral-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                                    title="Editar Detalhes"
                                                >
                                                    <Edit size={18} />
                                                </button>
                                                <button 
                                                    onClick={() => handleDeletePayment(p.id_pagamento_peca)}
                                                    className="p-2 text-neutral-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                                    title="Excluir Pagamento"
                                                >
                                                    <Trash2 size={18} />
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
            
            {showEditModal && editPayment && (
                <Modal title="Editar Pagamento (Peça)" onClose={() => setShowEditModal(false)}>
                    <div className="space-y-6">
                        <div className="bg-neutral-50 p-4 rounded-xl mb-4">
                            <p className="text-xs font-bold text-neutral-400 uppercase">Item da OS</p>
                            <p className="font-bold text-neutral-800">{editPayment.item_os?.descricao}</p>
                            <div className="mt-2 text-[10px] text-neutral-400 font-mono">
                                Inserido em: {editPayment.item_os?.dt_cadastro ? new Date(editPayment.item_os.dt_cadastro).toLocaleString() : 'N/A'}
                            </div>
                            <div className="mt-2">
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-1 block">Ref / Nota</label>
                                <input 
                                    value={editPayment.ref_nota || ''}
                                    onChange={e => setEditPayment({...editPayment, ref_nota: e.target.value})}
                                    className="w-full bg-white border border-neutral-200 p-2 rounded-lg font-bold text-sm outline-none focus:border-neutral-400"
                                    placeholder="Número da Nota / Referência"
                                />
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {/* Read-Only Insertion Date */}
                            <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Data de Inserção na OS (Auto)</label>
                                <input 
                                    type="text"
                                    disabled
                                    value={editPayment.item_os?.dt_cadastro ? new Date(editPayment.item_os.dt_cadastro).toLocaleDateString() : 'N/A'}
                                    className="w-full bg-neutral-100 border border-neutral-200 p-3 rounded-xl font-bold text-sm text-neutral-500 cursor-not-allowed"
                                />
                            </div>

                            {/* Read-Only OS Finish Date */}
                            <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Data de Finalização da OS</label>
                                <input 
                                    type="text"
                                    disabled
                                    value={editPayment.item_os?.ordem_de_servico?.dt_entrega 
                                        ? new Date(editPayment.item_os.ordem_de_servico.dt_entrega).toLocaleDateString() 
                                        : 'OS em Aberto'}
                                    className="w-full bg-neutral-100 border border-neutral-200 p-3 rounded-xl font-bold text-sm text-neutral-500 cursor-not-allowed"
                                />
                            </div>

                            {/* Editable Payment Date */}
                            <div className="md:col-span-2">
                                <label className="text-[10px] font-black uppercase mb-2 block text-green-600">Data de Pagamento à Auto Peças (Editável)</label>
                                <input 
                                    type="date"
                                    value={editPayment.data_pagamento_fornecedor || ''}
                                    onChange={e => setEditPayment({...editPayment, data_pagamento_fornecedor: e.target.value})}
                                    className="w-full bg-white border border-green-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-green-400 text-green-700"
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                                <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Custo Real (R$)</label>
                                <input 
                                    type="number"
                                    step="0.01"
                                    value={editPayment.custo_real}
                                    onChange={e => setEditPayment({...editPayment, custo_real: e.target.value})}
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-neutral-400 uppercase mb-2 block">Fornecedor</label>
                                <select 
                                    value={editPayment.id_fornecedor}
                                    onChange={(e) => setEditPayment({...editPayment, id_fornecedor: e.target.value})}
                                    className="w-full bg-neutral-50 border border-neutral-200 p-3 rounded-xl font-bold text-sm outline-none focus:border-neutral-400"
                                >
                                    {fornecedores.map(f => (
                                        <option key={f.id_fornecedor} value={f.id_fornecedor}>{f.nome}</option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        <div className="flex gap-3 pt-4 border-t border-neutral-100">
                                <button
                                onClick={() => setShowEditModal(false)}
                                className="flex-1 py-3 text-neutral-500 font-bold hover:bg-neutral-50 rounded-xl transition-colors"
                            >
                                Cancelar
                            </button>
                            <button
                                onClick={handleUpdatePayment}
                                className="flex-1 py-3 bg-neutral-900 text-white font-bold rounded-xl hover:bg-neutral-800 transition-colors shadow-lg"
                            >
                                Salvar Alterações
                            </button>
                        </div>
                    </div>
                </Modal>
            )}

            {/* Confirmation Modal */}
            {confirmModal.isOpen && (
                <Modal 
                    title={confirmModal.title} 
                    onClose={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))}
                >
                        <div className="space-y-6">
                        <p className="text-neutral-600 font-medium">{confirmModal.message}</p>
                        <div className="flex justify-end gap-3 pt-2">
                                <button
                                type="button"
                                onClick={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))}
                                className="px-5 py-2.5 text-neutral-600 font-bold hover:bg-neutral-100 rounded-lg transition-colors"
                            >
                                Cancelar
                            </button>
                            <button
                                type="button"
                                onClick={confirmModal.onConfirm}
                                className="px-5 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors shadow-lg shadow-red-500/30"
                            >
                                Confirmar Exclusão
                            </button>
                        </div>
                    </div>
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\PecasEstoquePage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import type { IPecasEstoque } from '../types/backend';
import { PecasEstoqueForm } from '../components/forms/PecasEstoqueForm';
import { Modal } from '../components/ui/Modal';
import { Plus, Search, Trash2, Edit, Package } from 'lucide-react';
import { StatusBanner } from '../components/ui/StatusBanner';

export const PecasEstoquePage = () => {
    const [pecas, setPecas] = useState<IPecasEstoque[]>([]);
    const [showModal, setShowModal] = useState(false);
    const [searchId, setSearchId] = useState('');
    const [editData, setEditData] = useState<IPecasEstoque | null>(null);
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });

    useEffect(() => {
        loadPecas();
    }, []);

    const loadPecas = async () => {
        try {
            const response = await api.get('/pecas-estoque');
            setPecas(response.data);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao carregar estoque.' });
        }
    };

    const handleSearch = async () => {
        if (!searchId) return;
        try {
            const response = await api.get(`/pecas-estoque/${searchId}`);
            setEditData(response.data);
            setStatusMsg({ type: 'success', text: 'Peça localizada!' });
            setTimeout(() => setStatusMsg({ type: null, text: '' }), 2000);
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Peça não encontrada.' });
            setEditData(null);
        }
    };

    const handleUpdate = async () => {
        if (!editData) return;
        try {
             const payload = {
                ...editData,
                valor_custo: Number(editData.valor_custo),
                valor_venda: Number(editData.valor_venda),
                estoque_atual: Number(editData.estoque_atual)
             }
            await api.put(`/pecas-estoque/${editData.id_pecas_estoque}`, payload);
            setStatusMsg({ type: 'success', text: 'Peça atualizada com sucesso!' });
            setTimeout(() => setStatusMsg({ type: null, text: '' }), 3000);
            loadPecas();
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao atualizar peça.' });
        }
    };

    const handleDelete = async () => {
        if (!searchId) return;
        if (!confirm('Deseja realmente excluir este item?')) return;
        try {
            await api.delete(`/pecas-estoque/${searchId}`);
            setStatusMsg({ type: 'success', text: 'Peça removida do sistema.' });
            setTimeout(() => setStatusMsg({ type: null, text: '' }), 3000);
            loadPecas();
            setEditData(null);
            setSearchId('');
        } catch (error) {
            setStatusMsg({ type: 'error', text: 'Erro ao deletar peça.' });
        }
    };

    return (
        <div className="space-y-6">
            <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({type: null, text: ''})} />

            <div className="flex justify-between items-center">
                <div>
                     <h1 className="text-2xl font-bold text-neutral-900">Estoque de Peças</h1>
                     <p className="text-neutral-500">Gerencie o inventário de peças e serviços.</p>
                </div>
                <button 
                    onClick={() => setShowModal(true)}
                    className="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2.5 rounded-lg font-medium shadow-sm transition-all"
                >
                    <Plus size={20} />
                    Nova Peça
                </button>
            </div>

            {/* LIST */}
            <div className="bg-white rounded-xl shadow-sm border border-neutral-100 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-neutral-50">
                        <tr>
                            <th className="p-4 text-xs font-bold text-neutral-500 uppercase">ID</th>
                            <th className="p-4 text-xs font-bold text-neutral-500 uppercase">Produto/Peça</th>
                            <th className="p-4 text-xs font-bold text-neutral-500 uppercase">Fabricante</th>
                            <th className="p-4 text-xs font-bold text-neutral-500 uppercase">Estoque</th>
                            <th className="p-4 text-xs font-bold text-neutral-500 uppercase">Valor</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-100">
                        {pecas.map((p) => (
                            <tr key={p.id_pecas_estoque} className="hover:bg-neutral-50">
                                <td className="p-4 text-neutral-500 font-mono">#{p.id_pecas_estoque}</td>
                                <td className="p-4 font-medium">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-info-50 p-2 rounded-lg text-info-600">
                                            <Package size={18} />
                                        </div>
                                        <div>
                                            <div className="text-neutral-900">{p.nome}</div>
                                            <div className="text-xs text-neutral-500">{p.descricao}</div>
                                        </div>
                                    </div>
                                </td>
                                <td className="p-4 border-gray-100 text-right font-medium text-slate-700">{p.estoque_atual} {p.unidade_medida}</td>
                                <td className="p-4 border-gray-100 text-right font-bold text-green-600">
                                    R$ {Number(p.valor_venda).toFixed(2)}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* MANAGE (Search/Update/Delete) */}
            <div className="bg-white p-4 rounded-xl border border-gray-200">
                <h2 className="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Manutenção de Item (Por ID)</h2>
                <div className="flex gap-4 mb-4">
                    <input 
                        type="number" 
                        value={searchId} 
                        onChange={(e) => setSearchId(e.target.value)} 
                        placeholder="Digite o ID da Peça..." 
                        className="border p-2 rounded w-64"
                    />
                    <button onClick={handleSearch} className="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                        <Search size={18} /> Localizar
                    </button>
                    {searchId && <button onClick={handleDelete} className="flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200">
                        <Trash2 size={18} /> Excluir
                    </button>}
                </div>

                {editData && (
                    <div className="bg-slate-50 p-4 rounded border animate-in fade-in">
                        <h3 className="font-bold mb-2">Editando: {editData.nome}</h3>
                         <div className="grid grid-cols-2 gap-4 mb-4">
                             <div>
                                 <label className="text-xs font-bold block mb-1">Nome</label>
                                 <input 
                                     value={editData.nome} 
                                     onChange={(e) => setEditData({...editData, nome: e.target.value})} 
                                     className="border p-2 w-full rounded" 
                                 />
                             </div>
                             <div>
                                 <label className="text-xs font-bold block mb-1">Estoque</label>
                                 <input 
                                     type="number"
                                     value={editData.estoque_atual} 
                                     onChange={(e) => setEditData({...editData, estoque_atual: Number(e.target.value)})} 
                                     className="border p-2 w-full rounded" 
                                 />
                             </div>
                         </div>
                        <button onClick={handleUpdate} className="flex items-center gap-2 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">
                            <Edit size={18} /> Salvar Alterações
                        </button>
                    </div>
                )}
            </div>

            {showModal && (
                <Modal title="Nova Peça no Estoque" onClose={() => setShowModal(false)}>
                    <PecasEstoqueForm 
                        onSuccess={() => {
                            setShowModal(false);
                            loadPecas();
                        }}
                        onCancel={() => setShowModal(false)}
                    />
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\PessoaFisicaPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import type { IPessoaFisica } from '../types/backend';
import { PessoaFisicaForm } from '../components/forms/PessoaFisicaForm';
import { Modal } from '../components/ui/Modal';
import { Plus, Search, Trash2, Edit, UserCheck } from 'lucide-react';

export const PessoaFisicaPage = () => {
    const [pessoasFisicas, setPessoasFisicas] = useState<IPessoaFisica[]>([]);
    const [showModal, setShowModal] = useState(false);
    const [searchId, setSearchId] = useState('');
    const [editData, setEditData] = useState<IPessoaFisica | null>(null);

    useEffect(() => {
        loadPessoasFisicas();
    }, []);

    const loadPessoasFisicas = async () => {
        try {
            const response = await api.get('/pessoa-fisica');
            setPessoasFisicas(response.data);
        } catch (error) {
            alert('Erro ao carregar pessoas físicas');
        }
    };

    const handleSearch = async () => {
        try {
            const response = await api.get(`/pessoa-fisica/${searchId}`);
            setEditData(response.data);
        } catch (error) {
            alert('Pessoa Física não encontrada');
            setEditData(null);
        }
    };

    const handleUpdate = async () => {
        if (!editData) return;
        try {
            await api.put(`/pessoa-fisica/${editData.id_pessoa_fisica}`, editData);
            alert('Pessoa Física atualizada!');
            loadPessoasFisicas();
        } catch (error) {
            alert('Erro ao atualizar pessoa física');
        }
    };

    const handleDelete = async () => {
        if (!searchId) return;
        try {
            await api.delete(`/pessoa-fisica/${searchId}`);
            alert('Pessoa Física deletada!');
            loadPessoasFisicas();
            setEditData(null);
            setSearchId('');
        } catch (error) {
            alert('Erro ao deletar pessoa física');
        }
    };

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-2xl font-bold text-slate-800">Pessoas Físicas</h1>
                    <p className="text-slate-500">Especialização de Pessoa com CPF.</p>
                </div>
                <button 
                    onClick={() => setShowModal(true)}
                    className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-medium shadow-sm transition-all"
                >
                    <Plus size={20} />
                    Nova Pessoa Física
                </button>
            </div>

            {/* LIST */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">ID PF</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">ID Pessoa</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">CPF</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Cadastro</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {pessoasFisicas.map((pf) => (
                            <tr key={pf.id_pessoa_fisica} className="hover:bg-slate-50">
                                <td className="p-4 text-gray-500 font-mono">#{pf.id_pessoa_fisica}</td>
                                <td className="p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-blue-50 p-2 rounded-lg text-blue-600">
                                            <UserCheck size={18} />
                                        </div>
                                        <span className="font-medium text-slate-900">ID: {pf.id_pessoa}</span>
                                    </div>
                                </td>
                                <td className="p-4 font-mono text-slate-700">{pf.cpf || '-'}</td>
                                <td className="p-4 text-xs text-slate-500">
                                    {new Date(pf.dt_cadastro).toLocaleDateString('pt-BR')}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* MANAGE */}
            <div className="bg-white p-4 rounded-xl border border-gray-200">
                <h2 className="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Manutenção (Por ID)</h2>
                <div className="flex gap-4 mb-4">
                    <input 
                        type="number" 
                        value={searchId} 
                        onChange={(e) => setSearchId(e.target.value)} 
                        placeholder="Digite o ID da Pessoa Física..." 
                        className="border p-2 rounded w-64"
                    />
                    <button onClick={handleSearch} className="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                        <Search size={18} /> Localizar
                    </button>
                    {searchId && <button onClick={handleDelete} className="flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200">
                        <Trash2 size={18} /> Excluir
                    </button>}
                </div>

                {editData && (
                    <div className="bg-slate-50 p-4 rounded border animate-in fade-in">
                        <h3 className="font-bold mb-2">Editando PF #{editData.id_pessoa_fisica}</h3>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label className="text-xs font-bold block mb-1">CPF</label>
                                <input 
                                    value={editData.cpf || ''} 
                                    onChange={(e) => setEditData({...editData, cpf: e.target.value})} 
                                    className="border p-2 w-full rounded" 
                                    maxLength={11}
                                />
                            </div>
                        </div>
                        <button onClick={handleUpdate} className="flex items-center gap-2 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">
                            <Edit size={18} /> Salvar Alterações
                        </button>
                    </div>
                )}
            </div>

            {showModal && (
                <Modal title="Nova Pessoa Física" onClose={() => setShowModal(false)}>
                    <PessoaFisicaForm 
                        onSuccess={() => {
                            setShowModal(false);
                            loadPessoasFisicas();
                        }}
                        onCancel={() => setShowModal(false)}
                    />
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\PessoaJuridicaPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import type { IPessoaJuridica } from '../types/backend';
import { PessoaJuridicaForm } from '../components/forms/PessoaJuridicaForm';
import { Modal } from '../components/ui/Modal';
import { Plus, Search, Trash2, Edit, Building2 } from 'lucide-react';

export const PessoaJuridicaPage = () => {
    const [pessoasJuridicas, setPessoasJuridicas] = useState<IPessoaJuridica[]>([]);
    const [showModal, setShowModal] = useState(false);
    const [searchId, setSearchId] = useState('');
    const [editData, setEditData] = useState<IPessoaJuridica | null>(null);

    useEffect(() => {
        loadPessoasJuridicas();
    }, []);

    const loadPessoasJuridicas = async () => {
        try {
            const response = await api.get('/pessoa-juridica');
            setPessoasJuridicas(response.data);
        } catch (error) {
            alert('Erro ao carregar pessoas jurídicas');
        }
    };

    const handleSearch = async () => {
        try {
            const response = await api.get(`/pessoa-juridica/${searchId}`);
            setEditData(response.data);
        } catch (error) {
            alert('Pessoa Jurídica não encontrada');
            setEditData(null);
        }
    };

    const handleUpdate = async () => {
        if (!editData) return;
        try {
            await api.put(`/pessoa-juridica/${editData.id_pessoa_juridica}`, editData);
            alert('Pessoa Jurídica atualizada!');
            loadPessoasJuridicas();
        } catch (error) {
            alert('Erro ao atualizar pessoa jurídica');
        }
    };

    const handleDelete = async () => {
        if (!searchId) return;
        try {
            await api.delete(`/pessoa-juridica/${searchId}`);
            alert('Pessoa Jurídica deletada!');
            loadPessoasJuridicas();
            setEditData(null);
            setSearchId('');
        } catch (error) {
            alert('Erro ao deletar pessoa jurídica');
        }
    };

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-2xl font-bold text-slate-800">Pessoas Jurídicas</h1>
                    <p className="text-slate-500">Especialização de Pessoa com CNPJ.</p>
                </div>
                <button 
                    onClick={() => setShowModal(true)}
                    className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2.5 rounded-lg font-medium shadow-sm transition-all"
                >
                    <Plus size={20} />
                    Nova Pessoa Jurídica
                </button>
            </div>

            {/* LIST */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">ID PJ</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Empresa</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">CNPJ</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">ID Pessoa</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Cadastro</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {pessoasJuridicas.map((pj) => (
                            <tr key={pj.id_pessoa_juridica} className="hover:bg-slate-50">
                                <td className="p-4 text-gray-500 font-mono">#{pj.id_pessoa_juridica}</td>
                                <td className="p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-purple-50 p-2 rounded-lg text-purple-600">
                                            <Building2 size={18} />
                                        </div>
                                        <div>
                                            <div className="font-medium text-slate-900">{pj.razao_social}</div>
                                            {pj.nome_fantasia && <div className="text-xs text-slate-500">{pj.nome_fantasia}</div>}
                                        </div>
                                    </div>
                                </td>
                                <td className="p-4 font-mono text-slate-700">{pj.cnpj || '-'}</td>
                                <td className="p-4 text-slate-600">ID: {pj.id_pessoa}</td>
                                <td className="p-4 text-xs text-slate-500">
                                    {new Date(pj.dt_cadastro).toLocaleDateString('pt-BR')}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* MANAGE */}
            <div className="bg-white p-4 rounded-xl border border-gray-200">
                <h2 className="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Manutenção (Por ID)</h2>
                <div className="flex gap-4 mb-4">
                    <input 
                        type="number" 
                        value={searchId} 
                        onChange={(e) => setSearchId(e.target.value)} 
                        placeholder="Digite o ID da Pessoa Jurídica..." 
                        className="border p-2 rounded w-64"
                    />
                    <button onClick={handleSearch} className="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                        <Search size={18} /> Localizar
                    </button>
                    {searchId && <button onClick={handleDelete} className="flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200">
                        <Trash2 size={18} /> Excluir
                    </button>}
                </div>

                {editData && (
                    <div className="bg-slate-50 p-4 rounded border animate-in fade-in">
                        <h3 className="font-bold mb-2">Editando: {editData.razao_social}</h3>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="col-span-2">
                                <label className="text-xs font-bold block mb-1">Razão Social</label>
                                <input 
                                    value={editData.razao_social} 
                                    onChange={(e) => setEditData({...editData, razao_social: e.target.value})} 
                                    className="border p-2 w-full rounded" 
                                />
                            </div>
                            <div>
                                <label className="text-xs font-bold block mb-1">CNPJ</label>
                                <input 
                                    value={editData.cnpj || ''} 
                                    onChange={(e) => setEditData({...editData, cnpj: e.target.value})} 
                                    className="border p-2 w-full rounded" 
                                    maxLength={14}
                                />
                            </div>
                        </div>
                        <button onClick={handleUpdate} className="flex items-center gap-2 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">
                            <Edit size={18} /> Salvar Alterações
                        </button>
                    </div>
                )}
            </div>

            {showModal && (
                <Modal title="Nova Pessoa Jurídica" onClose={() => setShowModal(false)}>
                    <PessoaJuridicaForm 
                        onSuccess={() => {
                            setShowModal(false);
                            loadPessoasJuridicas();
                        }}
                        onCancel={() => setShowModal(false)}
                    />
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\PessoaPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import type { IPessoa } from '../types/backend';
import { PessoaForm } from '../components/forms/PessoaForm';
import { Modal } from '../components/ui/Modal';
import { Plus, Search, Trash2, Edit, User } from 'lucide-react';

export const PessoaPage = () => {
    const [pessoas, setPessoas] = useState<IPessoa[]>([]);
    const [showModal, setShowModal] = useState(false);
    const [searchId, setSearchId] = useState('');
    const [editData, setEditData] = useState<IPessoa | null>(null);

    useEffect(() => {
        loadPessoas();
    }, []);

    const loadPessoas = async () => {
        try {
            const response = await api.get('/pessoa');
            setPessoas(response.data);
        } catch (error) {
            alert('Erro ao carregar pessoas');
        }
    };

    const handleSearch = async () => {
        try {
            const response = await api.get(`/pessoa/${searchId}`);
            setEditData(response.data);
        } catch (error) {
            alert('Pessoa não encontrada');
            setEditData(null);
        }
    };

    const handleUpdate = async () => {
        if (!editData) return;
        try {
            await api.put(`/pessoa/${editData.id_pessoa}`, editData);
            alert('Pessoa atualizada!');
            loadPessoas();
        } catch (error) {
            alert('Erro ao atualizar pessoa');
        }
    };

    const handleDelete = async () => {
        if (!searchId) return;
        try {
            await api.delete(`/pessoa/${searchId}`);
            alert('Pessoa deletada!');
            loadPessoas();
            setEditData(null);
            setSearchId('');
        } catch (error) {
            alert('Erro ao deletar pessoa');
        }
    };

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-2xl font-bold text-slate-800">Gerenciar Pessoas</h1>
                    <p className="text-slate-500">Cadastro base de pessoas (antes de PF/PJ).</p>
                </div>
                <button 
                    onClick={() => setShowModal(true)}
                    className="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2.5 rounded-lg font-medium shadow-sm transition-all"
                >
                    <Plus size={20} />
                    Nova Pessoa
                </button>
            </div>

            {/* LIST */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">ID</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Nome</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Gênero</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Data Nascimento</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Cadastro</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {pessoas.map((p) => (
                            <tr key={p.id_pessoa} className="hover:bg-slate-50">
                                <td className="p-4 text-gray-500 font-mono">#{p.id_pessoa}</td>
                                <td className="p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-blue-50 p-2 rounded-lg text-blue-600">
                                            <User size={18} />
                                        </div>
                                        <div className="font-medium text-slate-900">{p.nome}</div>
                                    </div>
                                </td>
                                <td className="p-4 text-slate-600">{p.genero || '-'}</td>
                                <td className="p-4 text-slate-600">
                                    {p.dt_nascimento ? new Date(p.dt_nascimento).toLocaleDateString('pt-BR') : '-'}
                                </td>
                                <td className="p-4 text-xs text-slate-500">
                                    {new Date(p.dt_cadastro).toLocaleDateString('pt-BR')}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* MANAGE */}
            <div className="bg-white p-4 rounded-xl border border-gray-200">
                <h2 className="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Manutenção de Pessoa (Por ID)</h2>
                <div className="flex gap-4 mb-4">
                    <input 
                        type="number" 
                        value={searchId} 
                        onChange={(e) => setSearchId(e.target.value)} 
                        placeholder="Digite o ID da Pessoa..." 
                        className="border p-2 rounded w-64"
                    />
                    <button onClick={handleSearch} className="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                        <Search size={18} /> Localizar
                    </button>
                    {searchId && <button onClick={handleDelete} className="flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200">
                        <Trash2 size={18} /> Excluir
                    </button>}
                </div>

                {editData && (
                    <div className="bg-slate-50 p-4 rounded border animate-in fade-in">
                        <h3 className="font-bold mb-2">Editando: {editData.nome}</h3>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="col-span-2">
                                <label className="text-xs font-bold block mb-1">Nome</label>
                                <input 
                                    value={editData.nome} 
                                    onChange={(e) => setEditData({...editData, nome: e.target.value})} 
                                    className="border p-2 w-full rounded" 
                                />
                            </div>
                            <div>
                                <label className="text-xs font-bold block mb-1">Gênero</label>
                                <select 
                                    value={editData.genero || ''} 
                                    onChange={(e) => setEditData({...editData, genero: e.target.value})} 
                                    className="border p-2 w-full rounded"
                                >
                                    <option value="">Selecione...</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Feminino">Feminino</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                        </div>
                        <button onClick={handleUpdate} className="flex items-center gap-2 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">
                            <Edit size={18} /> Salvar Alterações
                        </button>
                    </div>
                )}
            </div>

            {showModal && (
                <Modal title="Nova Pessoa" onClose={() => setShowModal(false)}>
                    <PessoaForm 
                        onSuccess={() => {
                            setShowModal(false);
                            loadPessoas();
                        }}
                        onCancel={() => setShowModal(false)}
                    />
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\SearchClientePage.tsx
================================================================================
import { useState } from 'react';
import { api } from '../services/api';
import { Search, User, Car, Edit, Trash2, MapPin, Phone, Mail } from 'lucide-react';

interface ICliente {
    id_cliente: number;
    telefone_1: string;
    telefone_2?: string;
    email?: string;
    logradouro: string;
    nr_logradouro: string;
    compl_logradouro?: string;
    bairro: string;
    cidade: string;
    estado: string;
    pessoa_fisica?: {
        id_pessoa_fisica: number;
        cpf?: string;
        pessoa: {
            nome: string;
            genero?: string;
            dt_nascimento?: string;
        };
    };
    pessoa_juridica?: {
        id_pessoa_juridica: number;
        razao_social: string;
        nome_fantasia?: string;
        cnpj?: string;
    };
    veiculos?: IVeiculo[];
}

interface IVeiculo {
    id_veiculo: number;
    placa: string;
    marca: string;
    modelo: string;
    cor: string;
    ano_modelo?: string;
}

export const SearchClientePage = () => {
    const [searchTerm, setSearchTerm] = useState('');
    const [clientes, setClientes] = useState<ICliente[]>([]);
    const [selectedCliente, setSelectedCliente] = useState<ICliente | null>(null);
    const [loading, setLoading] = useState(false);

    const handleSearch = async () => {
        if (!searchTerm.trim()) {
            alert('Digite um nome para buscar');
            return;
        }

        setLoading(true);
        try {
            const response = await api.get(`/cliente/search?name=${searchTerm}`);
            setClientes(response.data);
            if (response.data.length === 0) {
                alert('Nenhum cliente encontrado');
            }
        } catch (error) {
            console.error(error);
            alert('Erro ao buscar clientes');
        } finally {
            setLoading(false);
        }
    };

    const loadClienteDetails = async (id: number) => {
        try {
            const response = await api.get(`/cliente/${id}`);
            setSelectedCliente(response.data);
        } catch (error) {
            alert('Erro ao carregar detalhes do cliente');
        }
    };

    const getNome = (cliente: ICliente) => {
        if (cliente.pessoa_fisica) {
            return cliente.pessoa_fisica.pessoa.nome;
        }
        if (cliente.pessoa_juridica) {
            return cliente.pessoa_juridica.razao_social;
        }
        return 'Nome não disponível';
    };

    return (
        <div className="space-y-6">
            <div>
                <h1 className="text-2xl font-bold text-slate-800">Pesquisar Cliente</h1>
                <p className="text-slate-500">Busque por nome (PF ou PJ)</p>
            </div>

            {/* SEARCH BAR */}
            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <div className="flex gap-4">
                    <input
                        type="text"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                        placeholder="Digite o nome do cliente... (ex: João Silva, Tania, ACME Ltda)"
                        className="flex-1 border p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-primary-500 outline-none"
                    />
                    <button
                        onClick={handleSearch}
                        disabled={loading}
                        className="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-medium shadow-sm transition-all disabled:opacity-50"
                    >
                        <Search size={20} />
                        {loading ? 'Buscando...' : 'Buscar'}
                    </button>
                </div>
            </div>

            {/* RESULTS LIST */}
            {clientes.length > 0 && (
                <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div className="p-4 bg-slate-50 border-b">
                        <h2 className="font-bold text-slate-700">Resultados ({clientes.length})</h2>
                    </div>
                    <div className="divide-y">
                        {clientes.map((cliente) => (
                            <div
                                key={cliente.id_cliente}
                                onClick={() => loadClienteDetails(cliente.id_cliente)}
                                className="p-4 hover:bg-slate-50 cursor-pointer transition-colors"
                            >
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-primary-50 p-3 rounded-lg text-primary-600">
                                            <User size={20} />
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-slate-800">{getNome(cliente)}</h3>
                                            <p className="text-sm text-slate-500">
                                                {cliente.pessoa_fisica && `CPF: ${cliente.pessoa_fisica.cpf || 'N/A'}`}
                                                {cliente.pessoa_juridica && `CNPJ: ${cliente.pessoa_juridica.cnpj || 'N/A'}`}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-sm text-slate-600">{cliente.telefone_1}</p>
                                        <p className="text-xs text-slate-400">{cliente.cidade} - {cliente.estado}</p>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {/* SELECTED CLIENTE DETAILS */}
            {selectedCliente && (
                <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div className="bg-gradient-to-r from-primary-600 to-primary-700 p-6 text-white">
                        <div className="flex justify-between items-start">
                            <div>
                                <h2 className="text-2xl font-bold mb-1">{getNome(selectedCliente)}</h2>
                                <p className="text-primary-100">
                                    {selectedCliente.pessoa_fisica && `CPF: ${selectedCliente.pessoa_fisica.cpf || 'Não informado'}`}
                                    {selectedCliente.pessoa_juridica && `CNPJ: ${selectedCliente.pessoa_juridica.cnpj || 'Não informado'}`}
                                </p>
                            </div>
                            <div className="flex gap-2">
                                <button className="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors">
                                    <Edit size={20} />
                                </button>
                                <button className="bg-red-500/80 hover:bg-red-600 p-2 rounded-lg transition-colors">
                                    <Trash2 size={20} />
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="p-6 space-y-6">
                        {/* CONTACT INFO */}
                        <div>
                            <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <Phone size={18} className="text-primary-600" />
                                Contato
                            </h3>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs text-slate-500">Telefone Principal</label>
                                    <p className="font-medium">{selectedCliente.telefone_1}</p>
                                </div>
                                {selectedCliente.telefone_2 && (
                                    <div>
                                        <label className="text-xs text-slate-500">Telefone 2</label>
                                        <p className="font-medium">{selectedCliente.telefone_2}</p>
                                    </div>
                                )}
                                {selectedCliente.email && (
                                    <div className="col-span-2">
                                        <label className="text-xs text-slate-500 flex items-center gap-1">
                                            <Mail size={14} /> Email
                                        </label>
                                        <p className="font-medium">{selectedCliente.email}</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* ADDRESS */}
                        <div>
                            <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <MapPin size={18} className="text-primary-600" />
                                Endereço
                            </h3>
                            <div className="bg-slate-50 p-4 rounded-lg">
                                <p className="font-medium">
                                    {selectedCliente.logradouro}, {selectedCliente.nr_logradouro}
                                    {selectedCliente.compl_logradouro && ` - ${selectedCliente.compl_logradouro}`}
                                </p>
                                <p className="text-slate-600">
                                    {selectedCliente.bairro} - {selectedCliente.cidade}/{selectedCliente.estado}
                                </p>
                            </div>
                        </div>

                        {/* VEHICLES */}
                        {selectedCliente.veiculos && selectedCliente.veiculos.length > 0 && (
                            <div>
                                <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
                                    <Car size={18} className="text-primary-600" />
                                    Veículos ({selectedCliente.veiculos.length})
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {selectedCliente.veiculos.map((veiculo) => (
                                        <div key={veiculo.id_veiculo} className="border border-slate-200 p-4 rounded-lg hover:border-primary-300 transition-colors">
                                            <div className="flex items-center gap-3">
                                                <div className="bg-slate-100 p-2 rounded">
                                                    <Car size={20} className="text-slate-600" />
                                                </div>
                                                <div>
                                                    <p className="font-bold text-slate-800">{veiculo.placa}</p>
                                                    <p className="text-sm text-slate-600">{veiculo.marca} {veiculo.modelo}</p>
                                                    <p className="text-xs text-slate-500">{veiculo.cor} • {veiculo.ano_modelo || 'Ano N/A'}</p>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\SearchVeiculoPage.tsx
================================================================================
import { useState } from 'react';
import { api } from '../services/api';
import { Search, Car, User, Edit, Trash2, MapPin, Phone } from 'lucide-react';
import { normalizePlate } from '../utils/normalize';

interface IVeiculo {
    id_veiculo: number;
    placa: string;
    marca: string;
    modelo: string;
    cor: string;
    ano_modelo?: string;
    combustivel?: string;
    chassi?: string;
    cliente: {
        id_cliente: number;
        telefone_1: string;
        email?: string;
        logradouro: string;
        nr_logradouro: string;
        bairro: string;
        cidade: string;
        estado: string;
        pessoa_fisica?: {
            pessoa: {
                nome: string;
            };
            cpf?: string;
        };
        pessoa_juridica?: {
            pessoa: {
                nome: string;
            };
            cnpj?: string;
        };
    };
}

export const SearchVeiculoPage = () => {
    const [searchPlaca, setSearchPlaca] = useState('');
    const [veiculo, setVeiculo] = useState<IVeiculo | null>(null);
    const [loading, setLoading] = useState(false);

    const handleSearch = async () => {
        if (!searchPlaca.trim()) {
            alert('Digite uma placa para buscar');
            return;
        }

        setLoading(true);
        try {
            // Normalize plate before searching
            const normalized = normalizePlate(searchPlaca);
            const response = await api.get(`/veiculo/placa/${normalized}`);
            setVeiculo(response.data);
        } catch (error) {
            console.error(error);
            alert('Veículo não encontrado');
            setVeiculo(null);
        } finally {
            setLoading(false);
        }
    };

    const getClienteNome = (cliente: IVeiculo['cliente']) => {
        if (cliente.pessoa_fisica) {
            return cliente.pessoa_fisica.pessoa.nome;
        }
        if (cliente.pessoa_juridica) {
            return cliente.pessoa_juridica.pessoa.nome;
        }
        return 'Nome não disponível';
    };

    return (
        <div className="space-y-6">
            <div>
                <h1 className="text-2xl font-bold text-slate-800">Pesquisar Veículo</h1>
                <p className="text-slate-500">Busque pela placa (com ou sem hífen)</p>
            </div>

            {/* SEARCH BAR */}
            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <div className="flex gap-4">
                    <input
                        type="text"
                        value={searchPlaca}
                        onChange={(e) => setSearchPlaca(e.target.value.toUpperCase())}
                        onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                        placeholder="Digite a placa... (ex: GIN1175 ou GIN-1175)"
                        className="flex-1 border p-3 rounded-lg border-gray-300 focus:ring-2 focus:ring-primary-500 outline-none font-mono text-lg tracking-wider"
                        maxLength={8}
                    />
                    <button
                        onClick={handleSearch}
                        disabled={loading}
                        className="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-medium shadow-sm transition-all disabled:opacity-50"
                    >
                        <Search size={20} />
                        {loading ? 'Buscando...' : 'Buscar'}
                    </button>
                </div>
                <p className="text-xs text-slate-400 mt-2">
                    💡 Dica: Você pode digitar com ou sem hífen (GIN1175 = GIN-1175)
                </p>
            </div>

            {/* VEHICLE DETAILS */}
            {veiculo && (
                <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div className="bg-gradient-to-r from-blue-600 to-blue-700 p-6 text-white">
                        <div className="flex justify-between items-start">
                            <div>
                                <div className="flex items-center gap-3 mb-2">
                                    <Car size={32} />
                                    <h2 className="text-3xl font-bold font-mono tracking-wider">{veiculo.placa}</h2>
                                </div>
                                <p className="text-blue-100 text-lg">{veiculo.marca} {veiculo.modelo}</p>
                                <p className="text-blue-200 text-sm">{veiculo.cor} • {veiculo.ano_modelo || 'Ano N/A'}</p>
                            </div>
                            <div className="flex gap-2">
                                <button className="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors">
                                    <Edit size={20} />
                                </button>
                                <button className="bg-red-500/80 hover:bg-red-600 p-2 rounded-lg transition-colors">
                                    <Trash2 size={20} />
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="p-6 space-y-6">
                        {/* VEHICLE INFO */}
                        <div>
                            <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <Car size={18} className="text-blue-600" />
                                Informações do Veículo
                            </h3>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="text-xs text-slate-500">Marca</label>
                                    <p className="font-medium">{veiculo.marca}</p>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-500">Modelo</label>
                                    <p className="font-medium">{veiculo.modelo}</p>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-500">Cor</label>
                                    <p className="font-medium">{veiculo.cor}</p>
                                </div>
                                {veiculo.ano_modelo && (
                                    <div>
                                        <label className="text-xs text-slate-500">Ano/Modelo</label>
                                        <p className="font-medium">{veiculo.ano_modelo}</p>
                                    </div>
                                )}
                                {veiculo.combustivel && (
                                    <div>
                                        <label className="text-xs text-slate-500">Combustível</label>
                                        <p className="font-medium">{veiculo.combustivel}</p>
                                    </div>
                                )}
                                {veiculo.chassi && (
                                    <div className="col-span-2">
                                        <label className="text-xs text-slate-500">Chassi</label>
                                        <p className="font-medium font-mono text-sm">{veiculo.chassi}</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* OWNER INFO */}
                        <div className="border-t pt-6">
                            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <User size={18} className="text-primary-600" />
                                Proprietário
                            </h3>
                            
                            <div className="bg-primary-50 p-5 rounded-lg border border-primary-100">
                                <div className="flex items-start justify-between mb-4">
                                    <div>
                                        <h4 className="text-xl font-bold text-slate-800 mb-1">
                                            {getClienteNome(veiculo.cliente)}
                                        </h4>
                                        <p className="text-sm text-slate-600">
                                            {veiculo.cliente.pessoa_fisica && `CPF: ${veiculo.cliente.pessoa_fisica.cpf || 'Não informado'}`}
                                            {veiculo.cliente.pessoa_juridica && `CNPJ: ${veiculo.cliente.pessoa_juridica.cnpj || 'Não informado'}`}
                                        </p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs text-slate-500 flex items-center gap-1 mb-1">
                                            <Phone size={12} /> Telefone
                                        </label>
                                        <p className="font-medium text-slate-800">{veiculo.cliente.telefone_1}</p>
                                    </div>
                                    {veiculo.cliente.email && (
                                        <div>
                                            <label className="text-xs text-slate-500 mb-1 block">Email</label>
                                            <p className="font-medium text-slate-800">{veiculo.cliente.email}</p>
                                        </div>
                                    )}
                                    <div className="col-span-2">
                                        <label className="text-xs text-slate-500 flex items-center gap-1 mb-1">
                                            <MapPin size={12} /> Endereço
                                        </label>
                                        <p className="font-medium text-slate-800">
                                            {veiculo.cliente.logradouro}, {veiculo.cliente.nr_logradouro}
                                        </p>
                                        <p className="text-sm text-slate-600">
                                            {veiculo.cliente.bairro} - {veiculo.cliente.cidade}/{veiculo.cliente.estado}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\TipoPage.tsx
================================================================================
import { useState, useEffect } from 'react';
import { api } from '../services/api';
import type { ITipo } from '../types/backend';
import { TipoForm } from '../components/forms/TipoForm';
import { Modal } from '../components/ui/Modal';
import { Plus, Search, Trash2, Edit, Tag } from 'lucide-react';

export const TipoPage = () => {
    const [tipos, setTipos] = useState<ITipo[]>([]);
    const [showModal, setShowModal] = useState(false);
    const [searchId, setSearchId] = useState('');
    const [editData, setEditData] = useState<ITipo | null>(null);

    useEffect(() => {
        loadTipos();
    }, []);

    const loadTipos = async () => {
        try {
            const response = await api.get('/tipo');
            setTipos(response.data);
        } catch (error) {
            alert('Erro ao carregar tipos');
        }
    };

    const handleSearch = async () => {
        try {
            const response = await api.get(`/tipo/${searchId}`);
            setEditData(response.data);
        } catch (error) {
            alert('Tipo não encontrado');
            setEditData(null);
        }
    };

    const handleUpdate = async () => {
        if (!editData) return;
        try {
            await api.put(`/tipo/${editData.id_tipo}`, editData);
            alert('Tipo atualizado!');
            loadTipos();
        } catch (error) {
            alert('Erro ao atualizar tipo');
        }
    };

    const handleDelete = async () => {
        if (!searchId) return;
        try {
            await api.delete(`/tipo/${searchId}`);
            alert('Tipo deletado!');
            loadTipos();
            setEditData(null);
            setSearchId('');
        } catch (error) {
            alert('Erro ao deletar tipo');
        }
    };

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-2xl font-bold text-slate-800">Tipos / Funções</h1>
                    <p className="text-slate-500">Categorias e funções de pessoas/empresas.</p>
                </div>
                <button 
                    onClick={() => setShowModal(true)}
                    className="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2.5 rounded-lg font-medium shadow-sm transition-all"
                >
                    <Plus size={20} />
                    Novo Tipo
                </button>
            </div>

            {/* LIST */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">ID</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Função</th>
                            <th className="p-4 text-xs font-bold text-gray-500 uppercase">Cadastro</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {tipos.map((t) => (
                            <tr key={t.id_tipo} className="hover:bg-slate-50">
                                <td className="p-4 text-gray-500 font-mono">#{t.id_tipo}</td>
                                <td className="p-4">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-green-50 p-2 rounded-lg text-green-600">
                                            <Tag size={18} />
                                        </div>
                                        <span className="font-medium text-slate-900">{t.funcao || 'Sem função definida'}</span>
                                    </div>
                                </td>
                                <td className="p-4 text-xs text-slate-500">
                                    {new Date(t.dt_cadastro).toLocaleDateString('pt-BR')}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* MANAGE */}
            <div className="bg-white p-4 rounded-xl border border-gray-200">
                <h2 className="text-lg font-bold mb-4 text-gray-700 border-b pb-2">Manutenção de Tipo (Por ID)</h2>
                <div className="flex gap-4 mb-4">
                    <input 
                        type="number" 
                        value={searchId} 
                        onChange={(e) => setSearchId(e.target.value)} 
                        placeholder="Digite o ID do Tipo..." 
                        className="border p-2 rounded w-64"
                    />
                    <button onClick={handleSearch} className="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                        <Search size={18} /> Localizar
                    </button>
                    {searchId && <button onClick={handleDelete} className="flex items-center gap-2 bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200">
                        <Trash2 size={18} /> Excluir
                    </button>}
                </div>

                {editData && (
                    <div className="bg-slate-50 p-4 rounded border animate-in fade-in">
                        <h3 className="font-bold mb-2">Editando Tipo #{editData.id_tipo}</h3>
                        <div className="mb-4">
                            <label className="text-xs font-bold block mb-1">Função</label>
                            <input 
                                value={editData.funcao || ''} 
                                onChange={(e) => setEditData({...editData, funcao: e.target.value})} 
                                className="border p-2 w-full rounded" 
                            />
                        </div>
                        <button onClick={handleUpdate} className="flex items-center gap-2 bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">
                            <Edit size={18} /> Salvar Alterações
                        </button>
                    </div>
                )}
            </div>

            {showModal && (
                <Modal title="Novo Tipo" onClose={() => setShowModal(false)}>
                    <TipoForm 
                        onSuccess={() => {
                            setShowModal(false);
                            loadTipos();
                        }}
                        onCancel={() => setShowModal(false)}
                    />
                </Modal>
            )}
        </div>
    );
};



================================================================================
FILE PATH: client\src\pages\VeiculoPage.tsx
================================================================================
import { useState, useEffect, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { api } from '../services/api';
import type { IVeiculo } from '../types/backend';
import { ClienteForm } from '../components/forms/ClienteForm';
import { VeiculoForm } from '../components/forms/VeiculoForm';
import { Modal } from '../components/ui/Modal';
import { Plus, Search, Trash2, Edit, Car, Wrench } from 'lucide-react';
import { StatusBanner } from '../components/ui/StatusBanner';

export const VeiculoPage = () => {
    const navigate = useNavigate();
    const [veiculos, setVeiculos] = useState<IVeiculo[]>([]);
    const [showModal, setShowModal] = useState(false);
    const [modalMode, setModalMode] = useState<'vehicle' | 'client'>('vehicle');
    const [searchTerm, setSearchTerm] = useState('');
    const [editingVehicle, setEditingVehicle] = useState<IVeiculo | undefined>(undefined);
    const [selectedClientId, setSelectedClientId] = useState<number | null>(null);
    const [statusMsg, setStatusMsg] = useState<{ type: 'success' | 'error' | null, text: string }>({ type: null, text: '' });
    const [confirmModal, setConfirmModal] = useState<{
        isOpen: boolean;
        title: string;
        message: string;
        onConfirm: () => void;
    }>({ isOpen: false, title: '', message: '', onConfirm: () => {} });
    const [activeIndex, setActiveIndex] = useState(-1);
    const searchInputRef = useRef<HTMLInputElement>(null);

    useEffect(() => {
        if (searchInputRef.current) searchInputRef.current.focus();
    }, []);

    const handleKeyDown = (e: React.KeyboardEvent) => {
        if (filteredVeiculos.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            setActiveIndex(prev => (prev + 1 >= filteredVeiculos.length ? 0 : prev + 1));
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            setActiveIndex(prev => (prev - 1 < 0 ? filteredVeiculos.length - 1 : prev - 1));
        } else if (e.key === 'Enter') {
            if (activeIndex !== -1) {
                e.preventDefault();
                openEditModal(filteredVeiculos[activeIndex]);
            }
        } else if (e.key === 'Escape') {
            setSearchTerm('');
            setActiveIndex(-1);
        }
    };

    useEffect(() => {
        setActiveIndex(-1);
    }, [searchTerm]);

    useEffect(() => {
        loadVeiculos();
    }, []);

    const loadVeiculos = async () => {
        try {
            const response = await api.get('/veiculo');
            setVeiculos(response.data);
        } catch (error) {
            console.error(error);
            // alert('Erro ao carregar veículos'); // Suppress initial load error alert to avoid noise if empty
        }
    };

    const handleDelete = (id: number) => {
        setConfirmModal({
            isOpen: true,
            title: 'Excluir Veículo',
            message: 'Tem certeza que deseja excluir este veículo?',
            onConfirm: async () => {
                try {
                    await api.delete(`/veiculo/${id}`);
                    setStatusMsg({ type: 'success', text: 'Veículo removido com sucesso!' });
                    setTimeout(() => setStatusMsg({ type: null, text: '' }), 3000);
                    loadVeiculos();
                } catch (error) {
                    setStatusMsg({ type: 'error', text: 'Erro ao deletar veículo. Verifique se há O.S. vinculadas.' });
                }
                setConfirmModal(prev => ({ ...prev, isOpen: false }));
            }
        });
    };

    const openCreateModal = () => {
        setModalMode('vehicle');
        setSelectedClientId(null);
        setEditingVehicle(undefined);
        setShowModal(true);
    };

    const openEditModal = (vehicle: IVeiculo) => {
        setModalMode('vehicle');
        setEditingVehicle(vehicle);
        setSelectedClientId(null); // Not needed for edit usually, or implicitly part of vehicle
        setShowModal(true);
    };

    const filteredVeiculos = veiculos.filter(v => 
        v.placa.toLowerCase().includes(searchTerm.toLowerCase()) ||
        v.modelo.toLowerCase().includes(searchTerm.toLowerCase()) ||
        v.marca.toLowerCase().includes(searchTerm.toLowerCase())
    );

    return (
        <div className="space-y-6">

            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 className="text-2xl font-bold text-neutral-900">Gerenciar Veículos</h1>
                    <p className="text-neutral-500">Cadastro e manutenção da frota de veículos.</p>
                </div>
                <button 
                    onClick={openCreateModal}
                    className="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 text-white px-4 py-2.5 rounded-lg font-medium shadow-sm transition-all"
                >
                    <Plus size={20} />
                    Novo Veículo
                </button>
            </div>

            {/* BARRA DE BUSCA */}
            <div className="bg-surface p-4 rounded-xl shadow-sm border border-neutral-200 flex gap-4">
                <div className="relative flex-1">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" size={20} />
                    <input 
                        ref={searchInputRef}
                        type="text"
                        placeholder="Buscar por placa, modelo ou marca..."
                        className="w-full pl-10 pr-4 py-2 border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 transition-all font-mono text-neutral-900"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        onKeyDown={handleKeyDown}
                    />
                </div>
            </div>

            {/* LIST */}
            <div className="bg-surface rounded-xl shadow-sm border border-neutral-200 overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-left border-collapse">
                        <thead className="bg-neutral-50">
                            <tr>
                                <th className="p-4 text-xs font-bold text-neutral-500 uppercase">Veículo</th>
                                <th className="p-4 text-xs font-bold text-neutral-500 uppercase">Placa</th>
                                <th className="p-4 text-xs font-bold text-neutral-500 uppercase">Cliente (ID)</th>
                                <th className="p-4 text-xs font-bold text-neutral-500 uppercase">Ações</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-neutral-100">
                            {filteredVeiculos.map((v, idx) => (
                                <tr key={v.id_veiculo} className={`transition-colors hover:bg-neutral-25 ${idx === activeIndex ? 'bg-primary-50 ring-2 ring-primary-500 ring-inset' : ''}`}>
                                    <td className="p-4">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-primary-50 p-2 rounded-lg text-primary-600">
                                                <Car size={18} />
                                            </div>
                                            <div>
                                                <div className="font-medium text-neutral-900">{v.marca} {v.modelo}</div>
                                                <div className="text-xs text-neutral-500">{v.ano_modelo} • {v.combustivel}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td className="p-4 font-mono font-bold text-neutral-700">{v.placa} <span className="text-xs font-normal text-neutral-400 ml-2">({v.cor})</span></td>
                                    <td className="p-4">
                                        <div className="flex flex-col">
                                            <span className="font-bold text-neutral-700">
                                                {(v.cliente as any)?.pessoa_fisica?.pessoa?.nome || (v.cliente as any)?.pessoa_juridica?.nome_fantasia || 'Cliente não identificado'}
                                            </span>
                                            <span className="text-xs text-neutral-500">
                                                {(v.cliente as any)?.pessoa_fisica?.pessoa?.telefone || (v.cliente as any)?.pessoa_juridica?.pessoa?.telefone || ''}
                                            </span>
                                        </div>
                                    </td>
                                    <td className="p-4">
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={() => openEditModal(v)}
                                                className="p-2 text-neutral-400 hover:text-primary-600 hover:bg-primary-50 rounded-lg transition-colors"
                                                title="Editar"
                                            >
                                                <Edit size={18} />
                                            </button>
                                            <button 
                                                onClick={() => navigate(`/ordem-de-servico?clientId=${v.id_cliente}&vehicleId=${v.id_veiculo}`)}
                                                className="p-2 text-neutral-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                                title="Abrir OS"
                                            >
                                                <Wrench size={18} />
                                            </button>
                                            <button 
                                                onClick={() => handleDelete(v.id_veiculo)}
                                                className="p-2 text-neutral-400 hover:text-error hover:bg-error-50 rounded-lg transition-colors"
                                                title="Excluir"
                                            >
                                                <Trash2 size={18} />
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))}
                            {filteredVeiculos.length === 0 && (
                                <tr>
                                    <td colSpan={5} className="p-8 text-center text-neutral-400">
                                        Nenhum veículo encontrado.
                                    </td>
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            {showModal && (
                <Modal 
                    title={
                        modalMode === 'client' 
                            ? "Novo Cliente" 
                            : (editingVehicle ? "Editar Veículo" : "Novo Veículo")
                    } 
                    onClose={() => setShowModal(false)}
                >
                    {modalMode === 'vehicle' ? (
                        <VeiculoForm 
                            clientId={selectedClientId}
                            vehicleId={editingVehicle?.id_veiculo}
                            initialData={editingVehicle}
                            onSuccess={() => {
                                setShowModal(false);
                                loadVeiculos();
                            }}
                            onCancel={() => setShowModal(false)}
                            onCreateClient={() => setModalMode('client')}
                        />
                    ) : (
                        <ClienteForm 
                            onSuccess={(newClient) => {
                                setSelectedClientId(newClient.id_cliente);
                                setModalMode('vehicle');
                            }}
                            onCancel={() => setModalMode('vehicle')}
                        />
                    )}
                </Modal>
            )}

            {/* Confirmation Modal */}
            {confirmModal.isOpen && (
                <Modal 
                    title={confirmModal.title} 
                    onClose={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))}
                >
                    <div className="space-y-6">
                        <p className="text-neutral-600 font-medium">{confirmModal.message}</p>
                        <div className="flex justify-end gap-3 pt-2">
                             <button
                                onClick={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))}
                                className="px-5 py-2.5 text-neutral-600 font-bold hover:bg-neutral-100 rounded-lg transition-colors"
                            >
                                Cancelar
                            </button>
                            <button
                                onClick={confirmModal.onConfirm}
                                className="px-5 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors shadow-lg shadow-red-500/30"
                            >
                                Confirmar
                            </button>
                        </div>
                    </div>
                </Modal>
            )}
            <div className="fixed bottom-8 right-8 z-100 min-w-[320px]">
                <StatusBanner msg={statusMsg} onClose={() => setStatusMsg({type: null, text: ''})} />
            </div>
        </div>
    );
};



================================================================================
FILE PATH: client\src\services\api.ts
================================================================================
import axios from 'axios';

export const api = axios.create({
  baseURL: 'http://localhost:3000/api',
});



================================================================================
FILE PATH: client\src\types\backend.d.ts
================================================================================
export interface IPessoa {
    id_pessoa: number;
    nome: string;
    genero?: string | null;
    dt_nascimento?: string | null; // Date sent as string
    obs?: string | null;
    dt_cadastro: string;
}

export interface IPessoaFisica {
    id_pessoa_fisica: number;
    id_pessoa: number;
    cpf?: string | null;
    dt_cadastro: string;
}

export interface IPessoaJuridica {
    id_pessoa_juridica: number;
    id_pessoa: number;
    razao_social: string;
    nome_fantasia?: string | null;
    cnpj?: string | null;
    inscricao_estadual?: string | null;
    dt_cadastro: string;
}

export interface ITipo {
    id_tipo: number;
    funcao?: string | null;
    dt_cadastro: string;
}

export interface ICliente {
    id_cliente: number;
    id_pessoa_fisica?: number | null;
    id_pessoa_juridica?: number | null;
    tipo_pessoa: number;
    telefone_1: string;
    telefone_2?: string | null;
    telefone_3?: string | null;
    email?: string | null;
    logradouro: string;
    nr_logradouro: string;
    compl_logradouro?: string | null;
    bairro: string;
    cidade: string;
    estado: string;
    dt_cadastro: string;

    // Optional Joins
    pessoa_fisica?: IPessoaFisica & { pessoa: IPessoa };
    pessoa_juridica?: IPessoaJuridica & { pessoa: IPessoa };
    veiculos?: IVeiculo[];
}

export interface IFuncionario {
    id_funcionario: number;
    id_pessoa_fisica: number;
    ativo: string;
    cargo: string;
    salario?: number | null;
    comissao?: number | null;
    dt_admissao: string;
    dt_recisao?: string | null;
    motivo_saida?: string | null;
    obs?: string | null;
    dt_cadastro: string;

    // Optional Joins
    pessoa_fisica?: IPessoaFisica & { pessoa: IPessoa };
}

export interface IPecasEstoque {
    id_pecas_estoque: number;
    fabricante?: string | null;
    nome: string;
    descricao: string;
    valor_custo: number; // Decimal
    valor_venda: number; // Decimal
    estoque_atual: number;
    unidade_medida?: string | null;
    custo_unitario_padrao: number; // Decimal
    dt_ultima_compra?: string | null;
    dt_cadastro: string;
}

export interface IVeiculo {
    id_veiculo: number;
    id_cliente: number;
    placa: string;
    chassi?: string | null;
    marca: string;
    modelo: string;
    versao?: string | null;
    ano_modelo: string;
    cor: string;
    combustivel: string;
    obs?: string | null;
    dt_cadastro: string;

    // Optional Joins
    cliente?: ICliente;
}

export interface IOrdemDeServico {
    id_os: number;
    id_cliente: number;
    id_veiculo: number;
    id_funcionario: number;
    dt_abertura: string;
    dt_entrega?: string | null;
    km_entrada: number;
    status: string;
    defeito_relatado?: string | null;
    diagnostico?: string | null;
    valor_servico?: number | null;
    valor_pecas?: number | null;
    valor_final?: number | null;
    
    valor_total_cliente?: number | null;
    valor_mao_de_obra?: number | null;

    modo_pagamento?: string | null;
    cod_pagamento?: string | null;
    parcelas: number;
    obs?: string | null;
    obs_final?: string | null;
    dt_cadastro: string;
    
    // Optional Joins
    cliente?: ICliente;
    veiculo?: IVeiculo;
    itens_os?: IItensOs[];
    pagamentos_cliente?: IPagamentoCliente[];
    funcionario?: IFuncionario;
    fechamento_financeiro?: IFechamentoFinanceiro;
    servicos_mao_de_obra?: IServicoMaoDeObra[];
}

export interface IServicoMaoDeObra {
    id_servico_mao_de_obra: number;
    id_os: number;
    id_funcionario: number;
    valor: number;
    descricao?: string | null;
    dt_cadastro: string;

    // Optional Joins
    funcionario?: IFuncionario;
}

export interface IPagamentoCliente {
    id_pagamento_cliente: number;
    id_os: number;
    metodo_pagamento: string;
    valor: number;
    data_pagamento: string;
    bandeira_cartao?: string | null;
    codigo_transacao?: string | null;
    qtd_parcelas: number;
    deleted_at?: string | null;
}

export interface IItensOs {
    id_iten: number;
    id_os: number;
    id_pecas_estoque?: number | null;
    descricao: string;
    codigo_referencia?: string | null;
    quantidade: number;
    valor_venda: number;
    valor_total: number;
    dt_cadastro: string;
}

export interface IFechamentoFinanceiro {
    id_fechamento_financeiro: number;
    id_os: number;
    custo_total_pecas_real: number;
    data_fechamento_financeiro: string;
}

export interface IFornecedor {
    id_fornecedor: number;
    nome: string;
    documento?: string | null;
    contato?: string | null;
    dt_cadastro: string;
}

export interface IPagamentoPeca {
    id_pagamento_peca: number;
    id_item_os: number;
    id_fornecedor: number;
    custo_real: number;
    data_compra: string;
    data_pagamento_fornecedor?: string | null;
    pago_ao_fornecedor: boolean;
}




================================================================================
FILE PATH: client\src\utils\normalize.ts
================================================================================
// Utility functions for data normalization and search

/**
 * Normaliza uma placa de veículo removendo hífens e convertendo para maiúsculas
 * Exemplos: "GIN-1175" -> "GIN1175", "gin1175" -> "GIN1175"
 */
export const normalizePlate = (plate: string): string => {
  return plate.replace(/-/g, '').toUpperCase().trim();
};

/**
 * Normaliza um nome para busca case-insensitive
 * Remove espaços extras e converte para maiúsculas
 * Exemplos: "Tania" -> "TANIA", "  joão silva  " -> "JOÃO SILVA"
 */
export const normalizeName = (name: string): string => {
  return name.trim().toUpperCase();
};

/**
 * Formata um nome seguindo o padrão Title Case (primeira letra maiúscula)
 * Exemplo: "JOÃO SILVA" -> "João Silva", "tania" -> "Tania"
 */
export const formatNameTitleCase = (name: string): string => {
  return name
    .toLowerCase()
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
};

/**
 * Formata uma placa no padrão brasileiro (XXX-0000 ou XXX0X00)
 * Exemplo: "GIN1175" -> "GIN-1175"
 */
export const formatPlate = (plate: string): string => {
  const normalized = normalizePlate(plate);
  if (normalized.length === 7) {
    return `${normalized.slice(0, 3)}-${normalized.slice(3)}`;
  }
  return normalized;
};

/**
 * Compara duas strings de forma case-insensitive
 */
export const caseInsensitiveMatch = (str1: string, str2: string): boolean => {
  return str1.toUpperCase() === str2.toUpperCase();
};

/**
 * Verifica se uma string contém outra (case-insensitive)
 */
export const caseInsensitiveIncludes = (haystack: string, needle: string): boolean => {
  return haystack.toUpperCase().includes(needle.toUpperCase());
};



================================================================================
FILE PATH: server\.dockerignore
================================================================================
node_modules
npm-debug.log
dist
build
.git
.gitignore
README.md


================================================================================
FILE PATH: server\check_db.ts
================================================================================
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
    console.log('--- Funcionarios ---');
    const funcionarios = await prisma.funcionario.findMany();
    console.log(JSON.stringify(funcionarios, null, 2));

    console.log('--- ServicoMaoDeObra ---');
    const servicos = await prisma.servicoMaoDeObra.findMany();
    console.log(JSON.stringify(servicos, null, 2));
}

main()
  .catch(e => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });



================================================================================
FILE PATH: server\Dockerfile
================================================================================
# Usa uma imagem base Node.js (Debian-based para melhor compatibilidade c/ Prisma)
FROM node:20

# Define o diretório de trabalho dentro do contêiner
WORKDIR /app/server

# Copia os arquivos de configuração de dependências
COPY package*.json ./

# Instala as dependências (incluindo o Prisma, express, etc.)
RUN npm install

# Copia o restante do código para o diretório de trabalho
COPY . .

# Comando de inicialização não é o principal, pois o Docker Compose o sobrescreve
CMD [ "npm", "run", "dev" ]


================================================================================
FILE PATH: server\package.json
================================================================================
{
  "name": "server",
  "version": "1.0.0",
  "description": "",
  "type": "module",
  "main": "index.js",
  "scripts": {
    "dev": "tsx watch src/server.ts",
    "migrate:host": "set DATABASE_URL=postgresql://user:password@localhost:5434/automotivo_db&& npx prisma migrate dev",
    "db:seed": "tsx prisma/seed.ts",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "@prisma/client": "5.22.0",
    "@types/cors": "^2.8.19",
    "@types/express": "^5.0.6",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.2.1",
    "ts-node": "^10.9.2",
    "typescript": "^5.9.3"
  },
  "devDependencies": {
    "prisma": "^5.22.0",
    "tsx": "^4.21.0"
  }
}



================================================================================
FILE PATH: server\tsconfig.json
================================================================================
{
  // Visit https://aka.ms/tsconfig to read more about this file
  "compilerOptions": {
    // File Layout
    // "rootDir": "./src",
    // "outDir": "./dist",

    // Environment Settings
    // See also https://aka.ms/tsconfig/module
    "module": "nodenext",
    "target": "esnext",
    "types": [],
    // For nodejs:
    // "lib": ["esnext"],
    // "types": ["node"],
    // and npm install -D @types/node

    // Other Outputs
    "sourceMap": true,
    "declaration": true,
    "declarationMap": true,

    // Stricter Typechecking Options
    "noUncheckedIndexedAccess": true,
    "exactOptionalPropertyTypes": true,

    // Style Options
    // "noImplicitReturns": true,
    // "noImplicitOverride": true,
    // "noUnusedLocals": true,
    // "noUnusedParameters": true,
    // "noFallthroughCasesInSwitch": true,
    // "noPropertyAccessFromIndexSignature": true,

    // Recommended Options
    "strict": true,
    "jsx": "react-jsx",
    //"verbatimModuleSyntax": true,
    "isolatedModules": true,
    "noUncheckedSideEffectImports": true,
    "moduleDetection": "force",
    "skipLibCheck": true,
  }
}



================================================================================
FILE PATH: server\prisma\schema.prisma
================================================================================
// server/prisma/schema.prisma

// 1. Configuração do Client: Deve ser 'prisma-client-js'
generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// 2. Configuração do Banco de Dados
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- TABELAS DE GENERALIZAÇÃO ---

// Tabela 1: Pessoa (Base)
model Pessoa {
  id_pessoa       Int      @id @default(autoincrement())
  nome            String   @db.VarChar(100)
  genero          String?  @db.VarChar(20)
  dt_nascimento   DateTime? @db.Date // DATE
  obs             String?  @db.VarChar(500)
  dt_cadastro     DateTime @default(now()) @db.Timestamp()

  // Relacionamentos 1:1 (Para Especialização)
  pessoa_fisica   PessoaFisica?
  pessoa_juridica PessoaJuridica?

  @@map("pessoa")
}

// Tabela 2: Pessoa Física (Especialização)
model PessoaFisica {
  id_pessoa_fisica Int      @id @default(autoincrement())
  id_pessoa        Int      @unique
  cpf              String?  @db.VarChar(11)
  dt_cadastro      DateTime @default(now()) @db.Timestamp()

  // Relacionamento com Pessoa
  pessoa           Pessoa   @relation(fields: [id_pessoa], references: [id_pessoa])

  // Relacionamentos para outras tabelas
  funcionario      Funcionario?
  clientes         Cliente[] // Mapeamento 1:N
  
  @@map("pessoa_fisica")
}

// Tabela 3: Pessoa Jurídica (Especialização)
model PessoaJuridica {
  id_pessoa_juridica Int      @id @default(autoincrement())
  id_pessoa          Int      @unique
  razao_social       String   @db.VarChar(100)
  nome_fantasia      String?  @db.VarChar(100)
  cnpj               String?  @unique @db.VarChar(14)
  inscricao_estadual String?  @db.VarChar(50)
  dt_cadastro        DateTime @default(now()) @db.Timestamp()

  // Relacionamento com Pessoa
  pessoa             Pessoa   @relation(fields: [id_pessoa], references: [id_pessoa])

  // Relacionamentos para outras tabelas
  clientes           Cliente[]

  @@map("pessoa_juridica")
}

// Tabela 4: Tipo (Função da Pessoa/Empresa)
model Tipo {
  id_tipo     Int      @id @default(autoincrement())
  funcao      String?  @db.VarChar(50)
  dt_cadastro DateTime @default(now()) @db.Timestamp()
  
  // Relacionamento com Cliente
  clientes    Cliente[]
  
  @@map("tipo")
}

// --- TABELAS PRINCIPAIS ---

// Tabela 5: Cliente (Endereço e Contato)
model Cliente {
  id_cliente          Int       @id @default(autoincrement())
  
  // FKs OPCIONAIS (NULLABLE)
  id_pessoa_fisica    Int?      
  id_pessoa_juridica  Int?      
  tipo_pessoa         Int       // FK
  
  telefone_1          String    @db.VarChar(15)
  telefone_2          String?   @db.VarChar(15)
  telefone_3          String?   @db.VarChar(15)
  email               String?   @db.VarChar(100)
  logradouro          String?   @db.VarChar(150)
  nr_logradouro       String?   @db.VarChar(10)
  compl_logradouro    String?   @db.VarChar(50)
  bairro              String?   @db.VarChar(100)
  cidade              String?   @db.VarChar(100)
  estado              String?   @db.Char(2)
  dt_cadastro         DateTime  @default(now()) @db.Timestamp()
  
  // Relacionamentos (Chaves Estrangeiras)
  pessoa_fisica       PessoaFisica?  @relation(fields: [id_pessoa_fisica], references: [id_pessoa_fisica])
  pessoa_juridica     PessoaJuridica? @relation(fields: [id_pessoa_juridica], references: [id_pessoa_juridica])
  tipo                Tipo          @relation(fields: [tipo_pessoa], references: [id_tipo])
  
  // Relacionamentos de Volta
  veiculos            Veiculo[]
  ordens_de_servico   OrdemDeServico[]

  // Índices para as FKs para otimização
  @@index([id_pessoa_fisica])
  @@index([id_pessoa_juridica])
  @@index([tipo_pessoa])
  
  @@map("cliente")
}

// Tabela 6: Funcionário
model Funcionario {
  id_funcionario      Int      @id @default(autoincrement())
  id_pessoa_fisica    Int      @unique 
  ativo               String   @db.Char(1) // Seu SQL usa CHAR(1) para boolean/status
  cargo               String   @db.VarChar(50)
  salario             Decimal?   @db.Decimal(10, 2)
  comissao            Int?     
  dt_admissao         DateTime @db.Timestamp()
  dt_recisao          DateTime? @db.Timestamp()
  motivo_saida        String?  @db.VarChar(200)
  obs                 String?  @db.VarChar(500)
  dt_cadastro         DateTime @default(now()) @db.Timestamp()
  
  // Relacionamento 1:1 com PessoaFisica
  pessoa_fisica       PessoaFisica @relation(fields: [id_pessoa_fisica], references: [id_pessoa_fisica])
  
  // Relacionamento de Volta
  ordens_de_servico   OrdemDeServico[]
  servicos_mao_de_obra ServicoMaoDeObra[]
  pagamentos           PagamentoEquipe[]

  @@map("funcionario")
}

// Tabela 7: Peças Estoque
model PecasEstoque {
    id_pecas_estoque    Int      @id @default(autoincrement())
    fabricante          String?  @db.VarChar(50)
    nome                String   @db.VarChar(255)
    descricao           String   @db.VarChar(255)
    valor_custo         Decimal    @db.Decimal(10, 2)
    valor_venda         Decimal    @db.Decimal(10, 2)
    estoque_atual       Int      
    unidade_medida      String?  @db.VarChar(20)
    dt_ultima_compra    DateTime? @db.Timestamp()
    
    // Novo Campo
    custo_unitario_padrao Decimal @default(0) @db.Decimal(10, 2)
    
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    
    // Relacionamento de Volta (M:N com OS)
    itens_os            ItensOs[]

    @@map("pecas_estoque")
}

// Tabela 8: Veículo
model Veiculo {
    id_veiculo          Int      @id @default(autoincrement())
    id_cliente          Int      
    placa               String   @unique @db.VarChar(8)
    chassi              String?  @db.VarChar(20)
    marca               String   @db.VarChar(50)
    modelo              String   @db.VarChar(50)
    versao              String?  @db.VarChar(50)
    ano_modelo          String   @db.VarChar(10)
    cor                 String   @db.VarChar(30)
    combustivel         String   @db.VarChar(20)
    obs                 String?  @db.VarChar(500)
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    
    // Relacionamento 1:N com Cliente
    cliente             Cliente  @relation(fields: [id_cliente], references: [id_cliente])
    
    // Relacionamento de Volta
    ordens_de_servico   OrdemDeServico[]

    @@map("veiculo")
}

// Tabela 9: Ordem de Serviço (OS)
model OrdemDeServico {
    id_os               Int      @id @default(autoincrement())
    id_cliente          Int
    id_veiculo          Int
    id_funcionario      Int?
    dt_abertura         DateTime @default(now()) @db.Timestamp()
    dt_entrega          DateTime? @db.Timestamp()
    km_entrada          Int      
    status              String   @db.VarChar(50)
    defeito_relatado    String?  @db.VarChar(500)
    diagnostico         String?  @db.VarChar(500)
    
    // Campos Existentes de Valores
    valor_servico       Decimal?   @db.Decimal(10, 2)
    valor_pecas         Decimal?   @db.Decimal(10, 2)
    valor_final         Decimal?   @db.Decimal(12, 2)
    
    // Novos Campos Solicitados
    valor_total_cliente Decimal?   @db.Decimal(10, 2) // Receita do Cliente
    valor_mao_de_obra   Decimal?   @db.Decimal(10, 2) // Valor M.O. padrão
    
    modo_pagamento      String?  @db.VarChar(50)
    cod_pagamento       String?  @db.VarChar(80)
    parcelas            Int      
    obs                 String?  @db.VarChar(500)
    obs_final           String?  @db.VarChar(500)
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    deleted_at          DateTime? @db.Timestamp() // Soft Delete Marker
    
    // Relacionamentos (Chaves Estrangeiras)
    cliente             Cliente    @relation(fields: [id_cliente], references: [id_cliente])
    veiculo             Veiculo    @relation(fields: [id_veiculo], references: [id_veiculo])
    funcionario         Funcionario? @relation(fields: [id_funcionario], references: [id_funcionario])
    
    // Relacionamentos de Volta
    itens_os            ItensOs[]
    servicos_mao_de_obra ServicoMaoDeObra[]
    fechamento_financeiro FechamentoFinanceiro?
    pagamentos_cliente  PagamentoCliente[]

    @@map("ordem_de_servico")
    
    @@index([id_cliente])
    @@index([id_veiculo])
    @@index([status])
    @@index([deleted_at])
    
    updated_at          DateTime @default(now()) @updatedAt @db.Timestamp()
}

// Tabela 10: Tabela Associativa M:N (ITENS_OS)
model ItensOs {
    id_iten             Int      @id @default(autoincrement())
    id_os               Int      
    id_pecas_estoque    Int?      
    descricao           String   @db.VarChar(500) 
    codigo_referencia   String?  @db.VarChar(50) // Identificação da Peça (Nota) 
    
    // Campos Renomeados/Garantidos
    quantidade          Int      
    valor_venda         Decimal    @db.Decimal(10, 2)
    valor_total         Decimal    @db.Decimal(12, 2)
    
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    deleted_at          DateTime? @db.Timestamp()
    
    // Relacionamentos (Chaves Estrangeiras)
    ordem_de_servico    OrdemDeServico @relation(fields: [id_os], references: [id_os])
    pecas_estoque       PecasEstoque?   @relation(fields: [id_pecas_estoque], references: [id_pecas_estoque])
    
    // Relacionamento com PagamentoPeca
    pagamentos_peca     PagamentoPeca[]

    @@map("itens_os")
}

// Nova Entidade: Fornecedor
model Fornecedor {
    id_fornecedor Int      @id @default(autoincrement())
    nome          String   @db.VarChar(100)
    documento     String?  @db.VarChar(20)
    contato       String?  @db.VarChar(100)
    dt_cadastro   DateTime @default(now()) @db.Timestamp()
    
    pagamentos_peca PagamentoPeca[]

    @@map("fornecedor")
}

// Nova Entidade: PagamentoPeca (Rastreio de Custo Real)
model PagamentoPeca {
    id_pagamento_peca     Int      @id @default(autoincrement())
    id_item_os            Int
    id_fornecedor         Int
    
    custo_real            Decimal  @db.Decimal(10, 2)
    data_compra           DateTime @db.Timestamp()
    data_pagamento_fornecedor DateTime? @db.Timestamp()
    pago_ao_fornecedor    Boolean  @default(false)
    deleted_at            DateTime? @db.Timestamp()
    
    item_os               ItensOs  @relation(fields: [id_item_os], references: [id_iten])
    fornecedor            Fornecedor @relation(fields: [id_fornecedor], references: [id_fornecedor])

    @@map("pagamento_peca")
}

// Nova Entidade: FechamentoFinanceiro (Substitui Finalizacao)
model FechamentoFinanceiro {
    id_fechamento_financeiro Int      @id @default(autoincrement())
    id_os                    Int      @unique
    custo_total_pecas_real   Decimal  @db.Decimal(10, 2)
    data_fechamento_financeiro DateTime @default(now()) @db.Timestamp()
    deleted_at               DateTime? @db.Timestamp()
    
    ordem_de_servico         OrdemDeServico @relation(fields: [id_os], references: [id_os])

    @@map("fechamento_financeiro")
}

// Nova Entidade: PagamentoCliente (Recebimentos)
model PagamentoCliente {
    id_pagamento_cliente  Int      @id @default(autoincrement())
    id_os                 Int      
    
    metodo_pagamento      String   @db.VarChar(50) // 'CREDITO', 'DEBITO', 'PIX', 'DINHEIRO'
    valor                 Decimal  @db.Decimal(10, 2)
    data_pagamento        DateTime @default(now()) @db.Timestamp()
    deleted_at            DateTime? @db.Timestamp()
    
    // Detalhes
    bandeira_cartao       String?  @db.VarChar(50) // 'VISA', 'MASTER', 'ELO'
    codigo_transacao      String?  @db.VarChar(100) // NSU, ID PIX
    qtd_parcelas          Int      @default(1)
    
    ordem_de_servico      OrdemDeServico @relation(fields: [id_os], references: [id_os])

    @@map("pagamento_cliente")
}

model ServicoMaoDeObra {
    id_servico_mao_de_obra Int      @id @default(autoincrement())
    id_os                 Int
    id_funcionario        Int
    valor                 Decimal  @db.Decimal(10, 2)
    descricao             String?  @db.VarChar(255)
    
    dt_cadastro           DateTime @default(now()) @db.Timestamp()
    deleted_at            DateTime? @db.Timestamp()

    // Controle Financeiro
    status_pagamento      String   @default("PENDENTE") @db.VarChar(20) // 'PENDENTE', 'PAGO'
    id_pagamento_equipe   Int?
    pagamento_equipe      PagamentoEquipe? @relation(fields: [id_pagamento_equipe], references: [id_pagamento_equipe])
    
    ordem_de_servico      OrdemDeServico @relation(fields: [id_os], references: [id_os])
    funcionario           Funcionario    @relation(fields: [id_funcionario], references: [id_funcionario])

    @@map("servico_mao_de_obra")
}

model AuditLog {
    id_log          Int      @id @default(autoincrement())
    tabela          String   @db.VarChar(50)
    registro_id     Int
    acao            String   @db.VarChar(50) 
    valor_antigo    String?  @db.Text
    valor_novo      String?  @db.Text
    usuario_id      Int?
    dt_criacao      DateTime @default(now()) @db.Timestamp()

    @@map("audit_log")
}

// Nova Tabela: Contas a Pagar (Despesas Gerais)
model ContasPagar {
    id_conta_pagar      Int      @id @default(autoincrement())
    descricao           String   @db.VarChar(255)
    valor               Decimal  @db.Decimal(10, 2)
    dt_vencimento       DateTime @db.Date
    dt_pagamento        DateTime? @db.Date
    status              String   @db.VarChar(20) // 'PENDENTE', 'PAGO'
    categoria           String?  @db.VarChar(50) // 'AGUA', 'LUZ', 'ALUGUEL', 'INTERNET', 'OUTROS'
    obs                 String?  @db.VarChar(500)
    
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    updated_at          DateTime @default(now()) @updatedAt @db.Timestamp()
    deleted_at          DateTime? @db.Timestamp()

    @@map("contas_pagar")
}

// ---------------------------------------------------------
// MÓDULO FINANCEIRO AVANÇADO (LIVRO CAIXA E EQUIPE)
// ---------------------------------------------------------

// Tabela 13: Pagamento de Equipe (Comissões e Salários Consolidados)
model PagamentoEquipe {
    id_pagamento_equipe Int      @id @default(autoincrement())
    id_funcionario      Int
    
    valor_total         Decimal  @db.Decimal(10, 2)
    forma_pagamento     String?  @db.VarChar(50) 
    premio_valor        Decimal? @db.Decimal(10, 2)
    premio_descricao    String?  @db.VarChar(255)
    dt_pagamento        DateTime @default(now()) @db.Timestamp()
    
    tipo_lancamento     String   @default("COMISSAO") @db.VarChar(50) // 'COMISSAO', 'SALARIO', 'VALE'
    referencia_inicio   DateTime? @db.Date // Para Salário/Vale
    referencia_fim      DateTime? @db.Date // Para Salário/Vale
    
    obs                 String?  @db.VarChar(500)

    // Controle de Vales/Adiantamentos (Novo)
    descontado          Boolean  @default(false) // Indica se esse VALE já foi descontado de um salário futuro
    id_pagamento_deducao Int?     // ID do pagamento que descontou este vale
    pagamento_deducao   PagamentoEquipe? @relation("DeducaoVale", fields: [id_pagamento_deducao], references: [id_pagamento_equipe])
    vales_deduzidos     PagamentoEquipe[] @relation("DeducaoVale")
    
    // Relações
    funcionario         Funcionario @relation(fields: [id_funcionario], references: [id_funcionario])
    servicos_pagos      ServicoMaoDeObra[] // 1 Pagamento pode quitar vários serviços
    movimentacoes_caixa LivroCaixa[]       // Gera 1 ou mais saídas no caixa

    @@map("pagamento_equipe")
}

// Tabela 14: Livro Caixa (Registro Central de Movimentações)
model LivroCaixa {
    id_livro_caixa      Int      @id @default(autoincrement())
    descricao           String   @db.VarChar(255)
    valor               Decimal  @db.Decimal(10, 2)
    tipo_movimentacao   String   @db.VarChar(10) // 'ENTRADA' ou 'SAIDA'
    categoria           String   @db.VarChar(50) // 'EQUIPE', 'FORNECEDOR', 'VENDA', 'OUTROS'
    dt_movimentacao     DateTime @default(now()) @db.Timestamp()
    
    // New fields
    obs                 String?  @db.VarChar(500)
    origem              String   @default("MANUAL") @db.VarChar(20) // 'MANUAL' or 'AUTOMATICA'
    deleted_at          DateTime? @db.Timestamp()

    // Rastreabilidade (Opcional)
    id_pagamento_equipe Int?
    pagamento_equipe    PagamentoEquipe? @relation(fields: [id_pagamento_equipe], references: [id_pagamento_equipe])
    
    @@map("livro_caixa")
}

model CategoriaFinanceira {
    id_categoria    Int      @id @default(autoincrement())
    nome            String   @unique @db.VarChar(50)
    tipo            String   @db.VarChar(10) // 'ENTRADA', 'SAIDA', 'AMBOS'
    dt_cadastro     DateTime @default(now()) @db.Timestamp()

    @@map("categoria_financeira")
}


================================================================================
FILE PATH: server\prisma\seed.ts
================================================================================
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  console.log('🌱 Starting seed...');

  // 1. Seed Tipos
  const tipos = [
    { id_tipo: 1, funcao: 'Cliente' },
    { id_tipo: 2, funcao: 'Funcionário' },
    { id_tipo: 3, funcao: 'Fornecedor' },
  ];

  for (const t of tipos) {
    const tipo = await prisma.tipo.upsert({
      where: { id_tipo: t.id_tipo },
      update: {},
      create: t,
    });
    console.log(`Created Tipo: ${tipo.funcao} (ID: ${tipo.id_tipo})`);
  }

  // 2. Seed a default Employee (Funcionario)
  const existingFunc = await prisma.funcionario.findFirst();
  if (!existingFunc) {
      console.log('👷 Creating default employee...');
      const pessoa = await prisma.pessoa.create({
          data: {
              nome: 'Mecânico Padrão',
              genero: 'Masculino'
          }
      });

      const pessoaFisica = await prisma.pessoaFisica.create({
          data: {
              id_pessoa: pessoa.id_pessoa,
              cpf: '00000000000'
          }
      });

      await prisma.funcionario.create({
          data: {
              id_pessoa_fisica: pessoaFisica.id_pessoa_fisica,
              ativo: 'S',
              cargo: 'Mecânico',
              dt_admissao: new Date()
          }
      });
      console.log('✅ Default employee created.');
  }

  console.log('✅ Seed finished.');
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });



================================================================================
FILE PATH: server\prisma\migrations\migration_lock.toml
================================================================================
# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "postgresql"


================================================================================
FILE PATH: server\prisma\migrations\20251208001043_init_full_schema\migration.sql
================================================================================
-- CreateTable
CREATE TABLE "pessoa" (
    "id_pessoa" SERIAL NOT NULL,
    "nome" VARCHAR(100) NOT NULL,
    "genero" VARCHAR(20),
    "dt_nascimento" DATE,
    "obs" VARCHAR(500),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "pessoa_pkey" PRIMARY KEY ("id_pessoa")
);

-- CreateTable
CREATE TABLE "pessoa_fisica" (
    "id_pessoa_fisica" SERIAL NOT NULL,
    "id_pessoa" INTEGER NOT NULL,
    "cpf" VARCHAR(11),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "pessoa_fisica_pkey" PRIMARY KEY ("id_pessoa_fisica")
);

-- CreateTable
CREATE TABLE "pessoa_juridica" (
    "id_pessoa_juridica" SERIAL NOT NULL,
    "id_pessoa" INTEGER NOT NULL,
    "razao_social" VARCHAR(100) NOT NULL,
    "nome_fantasia" VARCHAR(100),
    "cnpj" VARCHAR(14),
    "inscricao_estadual" VARCHAR(50),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "pessoa_juridica_pkey" PRIMARY KEY ("id_pessoa_juridica")
);

-- CreateTable
CREATE TABLE "tipo" (
    "id_tipo" SERIAL NOT NULL,
    "funcao" VARCHAR(50),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "tipo_pkey" PRIMARY KEY ("id_tipo")
);

-- CreateTable
CREATE TABLE "cliente" (
    "id_cliente" SERIAL NOT NULL,
    "id_pessoa_fisica" INTEGER,
    "id_pessoa_juridica" INTEGER,
    "tipo_pessoa" INTEGER NOT NULL,
    "telefone_1" VARCHAR(15) NOT NULL,
    "telefone_2" VARCHAR(15),
    "telefone_3" VARCHAR(15),
    "email" VARCHAR(100),
    "logradouro" VARCHAR(150) NOT NULL,
    "nr_logradouro" VARCHAR(10) NOT NULL,
    "compl_logradouro" VARCHAR(50),
    "bairro" VARCHAR(100) NOT NULL,
    "cidade" VARCHAR(100) NOT NULL,
    "estado" CHAR(2) NOT NULL,
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "cliente_pkey" PRIMARY KEY ("id_cliente")
);

-- CreateTable
CREATE TABLE "funcionario" (
    "id_funcionario" SERIAL NOT NULL,
    "id_pessoa_fisica" INTEGER NOT NULL,
    "ativo" CHAR(1) NOT NULL,
    "cargo" VARCHAR(50) NOT NULL,
    "salario" DECIMAL(10,2),
    "comissao" INTEGER,
    "dt_admissao" TIMESTAMP NOT NULL,
    "dt_recisao" TIMESTAMP,
    "motivo_saida" VARCHAR(200),
    "obs" VARCHAR(500),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "funcionario_pkey" PRIMARY KEY ("id_funcionario")
);

-- CreateTable
CREATE TABLE "pecas_estoque" (
    "id_pecas_estoque" SERIAL NOT NULL,
    "fabricante" VARCHAR(50),
    "nome" VARCHAR(255) NOT NULL,
    "descricao" VARCHAR(255) NOT NULL,
    "valor_custo" DECIMAL(10,2) NOT NULL,
    "valor_venda" DECIMAL(10,2) NOT NULL,
    "estoque_atual" INTEGER NOT NULL,
    "unidade_medida" VARCHAR(20),
    "dt_ultima_compra" TIMESTAMP,
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "pecas_estoque_pkey" PRIMARY KEY ("id_pecas_estoque")
);

-- CreateTable
CREATE TABLE "veiculo" (
    "id_veiculo" SERIAL NOT NULL,
    "id_cliente" INTEGER NOT NULL,
    "placa" VARCHAR(8) NOT NULL,
    "chassi" VARCHAR(20),
    "marca" VARCHAR(50) NOT NULL,
    "modelo" VARCHAR(50) NOT NULL,
    "versao" VARCHAR(50),
    "ano_modelo" VARCHAR(10) NOT NULL,
    "cor" VARCHAR(30) NOT NULL,
    "combustivel" VARCHAR(20) NOT NULL,
    "obs" VARCHAR(500),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "veiculo_pkey" PRIMARY KEY ("id_veiculo")
);

-- CreateTable
CREATE TABLE "ordem_de_servico" (
    "id_os" SERIAL NOT NULL,
    "id_cliente" INTEGER NOT NULL,
    "id_veiculo" INTEGER NOT NULL,
    "id_funcionario" INTEGER NOT NULL,
    "dt_abertura" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "dt_entrega" TIMESTAMP,
    "km_entrada" INTEGER NOT NULL,
    "status" VARCHAR(20) NOT NULL,
    "defeito_relatado" VARCHAR(500),
    "diagnostico" VARCHAR(500),
    "valor_servico" DECIMAL(10,2),
    "valor_pecas" DECIMAL(10,2),
    "valor_final" DECIMAL(12,2),
    "modo_pagamento" VARCHAR(50),
    "cod_pagamento" VARCHAR(80),
    "parcelas" INTEGER NOT NULL,
    "obs" VARCHAR(500),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "ordem_de_servico_pkey" PRIMARY KEY ("id_os")
);

-- CreateTable
CREATE TABLE "itens_os" (
    "id_iten" SERIAL NOT NULL,
    "id_os" INTEGER NOT NULL,
    "id_pecas_estoque" INTEGER,
    "descricao" VARCHAR(500) NOT NULL,
    "qtd" INTEGER NOT NULL,
    "valor_unt" DECIMAL(10,2) NOT NULL,
    "valor_total" DECIMAL(12,2) NOT NULL,
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "itens_os_pkey" PRIMARY KEY ("id_iten")
);

-- CreateTable
CREATE TABLE "finalizacao" (
    "id_finalizacao" SERIAL NOT NULL,
    "id_os" INTEGER NOT NULL,
    "valor_peca_entrada" DECIMAL(10,2),
    "valor_peca_saida" DECIMAL(10,2),
    "valor_pago_funcionario" DECIMAL(10,2),
    "obs" VARCHAR(500),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "finalizacao_pkey" PRIMARY KEY ("id_finalizacao")
);

-- CreateIndex
CREATE UNIQUE INDEX "pessoa_fisica_id_pessoa_key" ON "pessoa_fisica"("id_pessoa");

-- CreateIndex
CREATE UNIQUE INDEX "pessoa_fisica_cpf_key" ON "pessoa_fisica"("cpf");

-- CreateIndex
CREATE UNIQUE INDEX "pessoa_juridica_id_pessoa_key" ON "pessoa_juridica"("id_pessoa");

-- CreateIndex
CREATE UNIQUE INDEX "pessoa_juridica_cnpj_key" ON "pessoa_juridica"("cnpj");

-- CreateIndex
CREATE INDEX "cliente_id_pessoa_fisica_idx" ON "cliente"("id_pessoa_fisica");

-- CreateIndex
CREATE INDEX "cliente_id_pessoa_juridica_idx" ON "cliente"("id_pessoa_juridica");

-- CreateIndex
CREATE INDEX "cliente_tipo_pessoa_idx" ON "cliente"("tipo_pessoa");

-- CreateIndex
CREATE UNIQUE INDEX "funcionario_id_pessoa_fisica_key" ON "funcionario"("id_pessoa_fisica");

-- CreateIndex
CREATE UNIQUE INDEX "veiculo_placa_key" ON "veiculo"("placa");

-- CreateIndex
CREATE UNIQUE INDEX "finalizacao_id_os_key" ON "finalizacao"("id_os");

-- AddForeignKey
ALTER TABLE "pessoa_fisica" ADD CONSTRAINT "pessoa_fisica_id_pessoa_fkey" FOREIGN KEY ("id_pessoa") REFERENCES "pessoa"("id_pessoa") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pessoa_juridica" ADD CONSTRAINT "pessoa_juridica_id_pessoa_fkey" FOREIGN KEY ("id_pessoa") REFERENCES "pessoa"("id_pessoa") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "cliente" ADD CONSTRAINT "cliente_id_pessoa_fisica_fkey" FOREIGN KEY ("id_pessoa_fisica") REFERENCES "pessoa_fisica"("id_pessoa_fisica") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "cliente" ADD CONSTRAINT "cliente_id_pessoa_juridica_fkey" FOREIGN KEY ("id_pessoa_juridica") REFERENCES "pessoa_juridica"("id_pessoa_juridica") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "cliente" ADD CONSTRAINT "cliente_tipo_pessoa_fkey" FOREIGN KEY ("tipo_pessoa") REFERENCES "tipo"("id_tipo") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "funcionario" ADD CONSTRAINT "funcionario_id_pessoa_fisica_fkey" FOREIGN KEY ("id_pessoa_fisica") REFERENCES "pessoa_fisica"("id_pessoa_fisica") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "veiculo" ADD CONSTRAINT "veiculo_id_cliente_fkey" FOREIGN KEY ("id_cliente") REFERENCES "cliente"("id_cliente") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "ordem_de_servico" ADD CONSTRAINT "ordem_de_servico_id_cliente_fkey" FOREIGN KEY ("id_cliente") REFERENCES "cliente"("id_cliente") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "ordem_de_servico" ADD CONSTRAINT "ordem_de_servico_id_veiculo_fkey" FOREIGN KEY ("id_veiculo") REFERENCES "veiculo"("id_veiculo") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "ordem_de_servico" ADD CONSTRAINT "ordem_de_servico_id_funcionario_fkey" FOREIGN KEY ("id_funcionario") REFERENCES "funcionario"("id_funcionario") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "itens_os" ADD CONSTRAINT "itens_os_id_os_fkey" FOREIGN KEY ("id_os") REFERENCES "ordem_de_servico"("id_os") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "itens_os" ADD CONSTRAINT "itens_os_id_pecas_estoque_fkey" FOREIGN KEY ("id_pecas_estoque") REFERENCES "pecas_estoque"("id_pecas_estoque") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "finalizacao" ADD CONSTRAINT "finalizacao_id_os_fkey" FOREIGN KEY ("id_os") REFERENCES "ordem_de_servico"("id_os") ON DELETE RESTRICT ON UPDATE CASCADE;



================================================================================
FILE PATH: server\prisma\migrations\20251216160147_init_v3\migration.sql
================================================================================
/*
  Warnings:

  - You are about to drop the column `qtd` on the `itens_os` table. All the data in the column will be lost.
  - You are about to drop the column `valor_unt` on the `itens_os` table. All the data in the column will be lost.
  - You are about to drop the `finalizacao` table. If the table is not empty, all the data it contains will be lost.
  - Added the required column `quantidade` to the `itens_os` table without a default value. This is not possible if the table is not empty.
  - Added the required column `valor_venda` to the `itens_os` table without a default value. This is not possible if the table is not empty.

*/
-- DropForeignKey
ALTER TABLE "finalizacao" DROP CONSTRAINT "finalizacao_id_os_fkey";

-- AlterTable
ALTER TABLE "itens_os" DROP COLUMN "qtd",
DROP COLUMN "valor_unt",
ADD COLUMN     "quantidade" INTEGER NOT NULL,
ADD COLUMN     "valor_venda" DECIMAL(10,2) NOT NULL;

-- AlterTable
ALTER TABLE "ordem_de_servico" ADD COLUMN     "valor_mao_de_obra" DECIMAL(10,2),
ADD COLUMN     "valor_total_cliente" DECIMAL(10,2);

-- AlterTable
ALTER TABLE "pecas_estoque" ADD COLUMN     "custo_unitario_padrao" DECIMAL(10,2) NOT NULL DEFAULT 0;

-- DropTable
DROP TABLE "finalizacao";

-- CreateTable
CREATE TABLE "fornecedor" (
    "id_fornecedor" SERIAL NOT NULL,
    "nome" VARCHAR(100) NOT NULL,
    "documento" VARCHAR(20),
    "contato" VARCHAR(100),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "fornecedor_pkey" PRIMARY KEY ("id_fornecedor")
);

-- CreateTable
CREATE TABLE "pagamento_peca" (
    "id_pagamento_peca" SERIAL NOT NULL,
    "id_item_os" INTEGER NOT NULL,
    "id_fornecedor" INTEGER NOT NULL,
    "custo_real" DECIMAL(10,2) NOT NULL,
    "data_compra" TIMESTAMP NOT NULL,
    "data_pagamento_fornecedor" TIMESTAMP,
    "pago_ao_fornecedor" BOOLEAN NOT NULL DEFAULT false,

    CONSTRAINT "pagamento_peca_pkey" PRIMARY KEY ("id_pagamento_peca")
);

-- CreateTable
CREATE TABLE "fechamento_financeiro" (
    "id_fechamento_financeiro" SERIAL NOT NULL,
    "id_os" INTEGER NOT NULL,
    "custo_total_pecas_real" DECIMAL(10,2) NOT NULL,
    "data_fechamento_financeiro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "fechamento_financeiro_pkey" PRIMARY KEY ("id_fechamento_financeiro")
);

-- CreateIndex
CREATE UNIQUE INDEX "fechamento_financeiro_id_os_key" ON "fechamento_financeiro"("id_os");

-- AddForeignKey
ALTER TABLE "pagamento_peca" ADD CONSTRAINT "pagamento_peca_id_item_os_fkey" FOREIGN KEY ("id_item_os") REFERENCES "itens_os"("id_iten") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "pagamento_peca" ADD CONSTRAINT "pagamento_peca_id_fornecedor_fkey" FOREIGN KEY ("id_fornecedor") REFERENCES "fornecedor"("id_fornecedor") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "fechamento_financeiro" ADD CONSTRAINT "fechamento_financeiro_id_os_fkey" FOREIGN KEY ("id_os") REFERENCES "ordem_de_servico"("id_os") ON DELETE RESTRICT ON UPDATE CASCADE;



================================================================================
FILE PATH: server\prisma\migrations\20251216195722_migrate161220251657\migration.sql
================================================================================
-- DropIndex
DROP INDEX "pessoa_fisica_cpf_key";



================================================================================
FILE PATH: server\prisma\migrations\20251218194757_make_address_optional\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "cliente" ALTER COLUMN "logradouro" DROP NOT NULL,
ALTER COLUMN "nr_logradouro" DROP NOT NULL,
ALTER COLUMN "bairro" DROP NOT NULL,
ALTER COLUMN "cidade" DROP NOT NULL,
ALTER COLUMN "estado" DROP NOT NULL;



================================================================================
FILE PATH: server\prisma\migrations\20251218212849_migration_181220251828\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "ordem_de_servico" ADD COLUMN     "obs_final" VARCHAR(500);



================================================================================
FILE PATH: server\prisma\migrations\20251218225607_181220251956\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "ordem_de_servico" ALTER COLUMN "status" SET DATA TYPE VARCHAR(50);



================================================================================
FILE PATH: server\prisma\migrations\20251220222534_201220251925\migration.sql
================================================================================
-- CreateTable
CREATE TABLE "pagamento_cliente" (
    "id_pagamento_cliente" SERIAL NOT NULL,
    "id_os" INTEGER NOT NULL,
    "metodo_pagamento" VARCHAR(50) NOT NULL,
    "valor" DECIMAL(10,2) NOT NULL,
    "data_pagamento" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "bandeira_cartao" VARCHAR(50),
    "codigo_transacao" VARCHAR(100),
    "qtd_parcelas" INTEGER NOT NULL DEFAULT 1,

    CONSTRAINT "pagamento_cliente_pkey" PRIMARY KEY ("id_pagamento_cliente")
);

-- AddForeignKey
ALTER TABLE "pagamento_cliente" ADD CONSTRAINT "pagamento_cliente_id_os_fkey" FOREIGN KEY ("id_os") REFERENCES "ordem_de_servico"("id_os") ON DELETE RESTRICT ON UPDATE CASCADE;



================================================================================
FILE PATH: server\prisma\migrations\20251220230657_201220252006\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "itens_os" ADD COLUMN     "codigo_referencia" VARCHAR(50);



================================================================================
FILE PATH: server\prisma\migrations\20251223140348_enable_unaccent\migration.sql
================================================================================
CREATE EXTENSION IF NOT EXISTS unaccent;


================================================================================
FILE PATH: server\prisma\migrations\20251223143540_multi_labor_audit_soft_delete\migration.sql
================================================================================
-- DropForeignKey
ALTER TABLE "ordem_de_servico" DROP CONSTRAINT "ordem_de_servico_id_funcionario_fkey";

-- AlterTable
ALTER TABLE "fechamento_financeiro" ADD COLUMN     "deleted_at" TIMESTAMP;

-- AlterTable
ALTER TABLE "ordem_de_servico" ADD COLUMN     "deleted_at" TIMESTAMP,
ALTER COLUMN "id_funcionario" DROP NOT NULL;

-- AlterTable
ALTER TABLE "pagamento_cliente" ADD COLUMN     "deleted_at" TIMESTAMP;

-- AlterTable
ALTER TABLE "pagamento_peca" ADD COLUMN     "deleted_at" TIMESTAMP;

-- CreateTable
CREATE TABLE "servico_mao_de_obra" (
    "id_servico_mao_de_obra" SERIAL NOT NULL,
    "id_os" INTEGER NOT NULL,
    "id_funcionario" INTEGER NOT NULL,
    "valor" DECIMAL(10,2) NOT NULL,
    "descricao" VARCHAR(255),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "deleted_at" TIMESTAMP,

    CONSTRAINT "servico_mao_de_obra_pkey" PRIMARY KEY ("id_servico_mao_de_obra")
);

-- CreateTable
CREATE TABLE "audit_log" (
    "id_log" SERIAL NOT NULL,
    "tabela" VARCHAR(50) NOT NULL,
    "registro_id" INTEGER NOT NULL,
    "acao" VARCHAR(50) NOT NULL,
    "valor_antigo" TEXT,
    "valor_novo" TEXT,
    "usuario_id" INTEGER,
    "dt_criacao" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "audit_log_pkey" PRIMARY KEY ("id_log")
);

-- AddForeignKey
ALTER TABLE "ordem_de_servico" ADD CONSTRAINT "ordem_de_servico_id_funcionario_fkey" FOREIGN KEY ("id_funcionario") REFERENCES "funcionario"("id_funcionario") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "servico_mao_de_obra" ADD CONSTRAINT "servico_mao_de_obra_id_os_fkey" FOREIGN KEY ("id_os") REFERENCES "ordem_de_servico"("id_os") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "servico_mao_de_obra" ADD CONSTRAINT "servico_mao_de_obra_id_funcionario_fkey" FOREIGN KEY ("id_funcionario") REFERENCES "funcionario"("id_funcionario") ON DELETE RESTRICT ON UPDATE CASCADE;



================================================================================
FILE PATH: server\prisma\migrations\20251223143630_add_soft_delete_to_itens_os\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "itens_os" ADD COLUMN     "deleted_at" TIMESTAMP;



================================================================================
FILE PATH: server\prisma\migrations\20260103205456_add_indexes_os\migration.sql
-- CreateIndex
CREATE INDEX "ordem_de_servico_id_cliente_idx" ON "ordem_de_servico"("id_cliente");

-- CreateIndex
CREATE INDEX "ordem_de_servico_id_veiculo_idx" ON "ordem_de_servico"("id_veiculo");

-- CreateIndex
CREATE INDEX "ordem_de_servico_status_idx" ON "ordem_de_servico"("status");

-- CreateIndex
CREATE INDEX "ordem_de_servico_deleted_at_idx" ON "ordem_de_servico"("deleted_at");



================================================================================
FILE PATH: server\prisma\migrations\20260104015042_add_contas_pagar_updated_at\migration.sql
================================================================================
-- AlterTable
ALTER TABLE "ordem_de_servico" ADD COLUMN     "updated_at" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP;

-- CreateTable
CREATE TABLE "contas_pagar" (
    "id_conta_pagar" SERIAL NOT NULL,
    "descricao" VARCHAR(255) NOT NULL,
    "valor" DECIMAL(10,2) NOT NULL,
    "dt_vencimento" DATE NOT NULL,
    "dt_pagamento" DATE,
    "status" VARCHAR(20) NOT NULL,
    "categoria" VARCHAR(50),
    "obs" VARCHAR(500),
    "dt_cadastro" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "deleted_at" TIMESTAMP,

    CONSTRAINT "contas_pagar_pkey" PRIMARY KEY ("id_conta_pagar")
);



================================================================================
FILE PATH: server\scripts\seed_categories.ts
================================================================================
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  const systemCategories = ['FORNECEDOR', 'RECEITA_SERVICO', 'OUTROS', 'EQUIPE'];

  for (const nome of systemCategories) {
    const exists = await prisma.categoriaFinanceira.findUnique({
      where: { nome }
    });

    if (!exists) {
      await prisma.categoriaFinanceira.create({
        data: {
          nome,
          tipo: 'AMBOS'
        }
      });
      console.log(`Categoria criada: ${nome}`);
    } else {
        console.log(`Categoria já existe: ${nome}`);
    }
  }
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });



================================================================================
FILE PATH: server\src\prisma.ts
================================================================================
import { PrismaClient } from '@prisma/client';
import dotenv from 'dotenv';

dotenv.config();

export const prisma = new PrismaClient();




================================================================================
FILE PATH: server\src\server.ts
================================================================================
import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';

dotenv.config();

const app = express();

app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3000;

app.get('/', (req, res) => {
  res.send('Centro Automotivo API is running');
});

import { pessoaRoutes } from './routes/pessoa.routes.js';
import { tipoRoutes } from './routes/tipo.routes.js';
import { pessoaFisicaRoutes } from './routes/pessoaFisica.routes.js';
import { pessoaJuridicaRoutes } from './routes/pessoaJuridica.routes.js';
import { clienteRoutes } from './routes/cliente.routes.js';
import { funcionarioRoutes } from './routes/funcionario.routes.js';
import { pecasEstoqueRoutes } from './routes/pecasEstoque.routes.js';
import { veiculoRoutes } from './routes/veiculo.routes.js';
import { ordemDeServicoRoutes } from './routes/ordemDeServico.routes.js';
import { itensOsRoutes } from './routes/itensOs.routes.js';
import { servicoMaoDeObraRoutes } from './routes/servicoMaoDeObra.routes.js';

// Novas Rotas
import { fechamentoFinanceiroRoutes } from './routes/fechamentoFinanceiro.routes.js';
import { fornecedorRoutes } from './routes/fornecedor.routes.js';
import { pagamentoPecaRoutes } from './routes/pagamentoPeca.routes.js';
import { pagamentoClienteRoutes } from './routes/pagamentoCliente.routes.js';

import contasPagarRoutes from './routes/contasPagar.routes.js';

app.use('/api/pessoa', pessoaRoutes);
app.use('/api/tipo', tipoRoutes);
app.use('/api/pessoa-fisica', pessoaFisicaRoutes);
app.use('/api/pessoa-juridica', pessoaJuridicaRoutes);
app.use('/api/cliente', clienteRoutes);
app.use('/api/funcionario', funcionarioRoutes);
app.use('/api/pecas-estoque', pecasEstoqueRoutes);
app.use('/api/veiculo', veiculoRoutes);
app.use('/api/ordem-de-servico', ordemDeServicoRoutes);
app.use('/api/itens-os', itensOsRoutes);
app.use('/api/servico-mao-de-obra', servicoMaoDeObraRoutes);

// Uso das Novas Rotas
app.use('/api/fechamento-financeiro', fechamentoFinanceiroRoutes);
app.use('/api/fornecedor', fornecedorRoutes);
app.use('/api/pagamento-peca', pagamentoPecaRoutes);
app.use('/api/pagamento-cliente', pagamentoClienteRoutes);
app.use('/api/contas-pagar', contasPagarRoutes);

import { pagamentoEquipeRoutes } from './routes/pagamentoEquipe.routes.js';
import { livroCaixaRoutes } from './routes/livroCaixa.routes.js';
import { categoriaFinanceiraRoutes } from './routes/categoriaFinanceira.routes.js';

app.use('/api/pagamento-equipe', pagamentoEquipeRoutes);
app.use('/api/livro-caixa', livroCaixaRoutes);
app.use('/api/categoria-financeira', categoriaFinanceiraRoutes);

app.listen(PORT, () => {
  console.log(`Server is running on port ${PORT}`);
});



================================================================================
FILE PATH: server\src\controllers\categoriaFinanceira.controller.ts
================================================================================
import { Request, Response } from 'express';
import { prisma } from '../prisma.js';

export const getAll = async (req: Request, res: Response) => {
    try {
        // Sync: Fetch distinct categories from LivroCaixa that are NOT in CategoriaFinanceira
        const existingCats = await prisma.categoriaFinanceira.findMany({ select: { nome: true } });
        const existingNames = new Set(existingCats.map(c => c.nome.toUpperCase()));

        // Get distinct categories used in LivroCaixa
        const usedCategories = await prisma.livroCaixa.groupBy({
            by: ['categoria'],
        });

        const newCategories = usedCategories
            .map(uc => uc.categoria)
            .filter(name => name && !existingNames.has(name.toUpperCase()));

        // Create missing categories
        if (newCategories.length > 0) {
            await prisma.categoriaFinanceira.createMany({
                data: newCategories.map(name => ({
                    nome: name,
                    tipo: 'AMBOS' // Default to AMBOS as we don't know for sure
                })),
                skipDuplicates: true
            });
        }

        const categorias = await prisma.categoriaFinanceira.findMany({
            orderBy: { nome: 'asc' }
        });
        res.json(categorias);
    } catch (error) {
        console.error(error);
        res.status(500).json({ error: 'Erro ao buscar categorias' });
    }
};

export const create = async (req: Request, res: Response) => {
    try {
        const { nome, tipo } = req.body;
        const categoria = await prisma.categoriaFinanceira.create({
            data: { nome, tipo }
        });
        res.status(201).json(categoria);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao criar categoria' });
    }
};

export const update = async (req: Request, res: Response) => {
    try {
        const { id } = req.params;
        const { nome, tipo } = req.body;
        
        // Also update name in LivroCaixa if name changed? 
        // Sync: If name changed, we should update LivroCaixa to keep consistency?
        // Or keep old name in history?
        // User asked for "sync everything". Updating history seems correct if it's a rename.
        
        const oldCat = await prisma.categoriaFinanceira.findUnique({ where: { id_categoria: Number(id) }});

        if (oldCat && oldCat.nome !== nome) {
             // Update references first
             await prisma.livroCaixa.updateMany({
                 where: { categoria: oldCat.nome },
                 data: { categoria: nome }
             });
        }

        const categoria = await prisma.categoriaFinanceira.update({
            where: { id_categoria: Number(id) },
            data: { nome, tipo }
        });
        res.json(categoria);
    } catch (error) {
        console.error(error);
        res.status(500).json({ error: 'Erro ao atualizar categoria' });
    }
};

export const remove = async (req: Request, res: Response) => {
    try {
        const { id } = req.params;
        const { replacementCategory } = req.body;
        
        const categoryToDelete = await prisma.categoriaFinanceira.findUnique({
             where: { id_categoria: Number(id) }
        });

        if (!categoryToDelete) return res.status(404).json({error: 'Cat not found'});

        // Check compatibility if usage exists
        const usageCount = await prisma.livroCaixa.count({
             where: { categoria: categoryToDelete.nome }
        });

        if (usageCount > 0) {
            if (!replacementCategory) {
                 return res.status(409).json({ 
                     error: 'Categoria em uso', 
                     usageCount,
                     message: `Esta categoria está sendo usada em ${usageCount} registros. Selecione uma categoria substituta.` 
                 });
            }

            // Update all records to new category
            await prisma.livroCaixa.updateMany({
                where: { categoria: categoryToDelete.nome },
                data: { categoria: replacementCategory }
            });
        }

        await prisma.categoriaFinanceira.delete({
            where: { id_categoria: Number(id) }
        });
        res.status(204).send();
    } catch (error) {
        res.status(500).json({ error: 'Erro ao deletar categoria' });
    }
};



================================================================================
FILE PATH: server\src\controllers\cliente.controller.ts
================================================================================
import { Request, Response } from 'express';
import { ClienteRepository } from '../repositories/cliente.repository.js';

const repository = new ClienteRepository();

export class ClienteController {
  async create(req: Request, res: Response) {
    console.log('🔵 ClienteController.create - Received request');
    console.log('📦 Request body:', JSON.stringify(req.body, null, 2));
    
    try {
      const cliente = await repository.create(req.body);
      console.log('✅ ClienteController.create - Success:', cliente.id_cliente);
      res.status(201).json(cliente);
    } catch (error: any) {
      console.error('❌ ClienteController.create - Error:', error);
      console.error('❌ Error message:', error.message);
      console.error('❌ Error stack:', error.stack);
      res.status(400).json({ error: 'Failed to create Cliente', details: error.message });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const clientes = await repository.findAll();
      res.json(clientes);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Clientes' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const cliente = await repository.findById(id);
      if (!cliente) {
        return res.status(404).json({ error: 'Cliente not found' });
      }
      res.json(cliente);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Cliente' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const cliente = await repository.update(id, req.body);
      res.json(cliente);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Cliente' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Cliente' });
    }
  }

  async searchByName(req: Request, res: Response) {
    try {
      const { name } = req.query;
      if (!name || typeof name !== 'string') {
        return res.status(400).json({ error: 'Name query parameter is required' });
      }
      const clientes = await repository.searchByName(name);
      res.json(clientes);
    } catch (error) {
      res.status(500).json({ error: 'Failed to search Clientes' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\contasPagar.controller.ts
================================================================================

import { Request, Response } from 'express';
import { ContasPagarRepository } from '../repositories/contasPagar.repository.js';

const repository = new ContasPagarRepository();

export const createConta = async (req: Request, res: Response) => {
    try {
        const conta = await repository.create(req.body);
        res.status(201).json(conta);
    } catch (error) {
        res.status(400).json({ error: 'Erro ao criar conta a pagar' });
    }
};

export const getContas = async (req: Request, res: Response) => {
    try {
        const contas = await repository.findAll();
        res.json(contas);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao buscar contas' });
    }
};

export const getContaById = async (req: Request, res: Response) => {
    try {
        const conta = await repository.findById(Number(req.params.id));
        if (!conta) return res.status(404).json({ error: 'Conta não encontrada' });
        res.json(conta);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao buscar conta' });
    }
};

export const updateConta = async (req: Request, res: Response) => {
    try {
        const conta = await repository.update(Number(req.params.id), req.body);
        res.json(conta);
    } catch (error) {
        res.status(400).json({ error: 'Erro ao atualizar conta' });
    }
};

export const deleteConta = async (req: Request, res: Response) => {
    try {
        await repository.delete(Number(req.params.id));
        res.status(204).send();
    } catch (error) {
        res.status(400).json({ error: 'Erro ao deletar conta' });
    }
};



================================================================================
FILE PATH: server\src\controllers\dashboard.controller.ts
================================================================================
import { Request, Response } from 'express';
import { prisma } from '../prisma.js';

export class DashboardController {
  async getDashboardData(req: Request, res: Response) {
    try {
      // Dates for "Today" filter (Server Time)
      const startOfDay = new Date();
      startOfDay.setHours(0, 0, 0, 0);
      const endOfDay = new Date();
      endOfDay.setHours(23, 59, 59, 999);

      // 1. Serviços em Aberto
      const osAberta = await prisma.ordemDeServico.count({
        where: {
          status: { in: ['ABERTA', 'EM_ANDAMENTO'] },
          deleted_at: null
        }
      });

      // 2. Contas a Pagar (Geral) -> Status PENDENTE
      const contasPagar = await prisma.contasPagar.count({
        where: {
          status: 'PENDENTE',
          deleted_at: null
        }
      });

      // 3. Livro Caixa Entries (PagamentoCliente Today)
      const livroCaixaEntries = await prisma.pagamentoCliente.count({
        where: {
          data_pagamento: { gte: startOfDay, lte: endOfDay },
          deleted_at: null
        }
      });

      // 4. Livro Caixa Exits (PagamentoPeca Today - Real Only)
      const livroCaixaExits = await prisma.pagamentoPeca.count({
        where: {
          pago_ao_fornecedor: true,
          data_pagamento_fornecedor: { gte: startOfDay, lte: endOfDay },
          deleted_at: null
        }
      });

      // 5. Auto Peças Pendentes
      // A. Items without payment record
      const itemsUnpaid = await prisma.itensOs.count({
        where: {
          pagamentos_peca: { none: {} },
          ordem_de_servico: { status: { not: 'CANCELADA' } },
          deleted_at: null
        }
      });
      // B. Payment records pending
      const paymentsPending = await prisma.pagamentoPeca.count({
        where: {
          pago_ao_fornecedor: false,
          deleted_at: null
        }
      });
      const autoPecasPendentes = itemsUnpaid + paymentsPending;

      // 6. Consolidação (OS Pronta para Financeiro E SEM Fechamento)
      const consolidacao = await prisma.ordemDeServico.count({
        where: {
          status: 'PRONTO PARA FINANCEIRO',
          fechamento_financeiro: null,
          deleted_at: null
        }
      });

      // 7. Recent OSs (Limit to 100 for performance)
      const recentOss = await prisma.ordemDeServico.findMany({
        take: 100,
        orderBy: { updated_at: 'desc' },
        include: {
          veiculo: true,
          cliente: {
            include: {
              pessoa_fisica: { include: { pessoa: true } },
              pessoa_juridica: { include: { pessoa: true } }
            }
          },
          servicos_mao_de_obra: {
            include: {
              funcionario: {
                include: {
                  pessoa_fisica: { include: { pessoa: true } }
                }
              }
            }
          }
        }
      });

      res.json({
        stats: {
          osAberta,
          contasPagar,
          livroCaixaEntries,
          livroCaixaExits,
          autoPecasPendentes,
          consolidacao
        },
        recentOss
      });

    } catch (error) {
      console.error('Dashboard Error:', error);
      res.status(500).json({ error: 'Failed to load dashboard data' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\fechamentoFinanceiro.controller.ts
================================================================================
import { Request, Response } from 'express';
import { FechamentoFinanceiroRepository } from '../repositories/fechamentoFinanceiro.repository.js';

const repository = new FechamentoFinanceiroRepository();

export class FechamentoFinanceiroController {
  async create(req: Request, res: Response) {
    try {
      const fechamento = await repository.create(req.body);
      res.status(201).json(fechamento);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Fechamento Financeiro', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const fechamentos = await repository.findAll();
      res.json(fechamentos);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Fechamentos Financeiros' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const fechamento = await repository.findById(id);
      if (!fechamento) {
        return res.status(404).json({ error: 'Fechamento Financeiro not found' });
      }
      res.json(fechamento);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Fechamento Financeiro' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const fechamento = await repository.update(id, req.body);
      res.json(fechamento);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Fechamento Financeiro' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Fechamento Financeiro' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\fornecedor.controller.ts
================================================================================
import { Request, Response } from 'express';
import { FornecedorRepository } from '../repositories/fornecedor.repository.js';

const repository = new FornecedorRepository();

export class FornecedorController {
  async create(req: Request, res: Response) {
    try {
      const fornecedor = await repository.create(req.body);
      res.status(201).json(fornecedor);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Fornecedor', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const fornecedores = await repository.findAll();
      res.json(fornecedores);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Fornecedores' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const fornecedor = await repository.findById(id);
      if (!fornecedor) {
        return res.status(404).json({ error: 'Fornecedor not found' });
      }
      res.json(fornecedor);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Fornecedor' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const fornecedor = await repository.update(id, req.body);
      res.json(fornecedor);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Fornecedor' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Fornecedor' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\funcionario.controller.ts
================================================================================
import { Request, Response } from 'express';
import { FuncionarioRepository } from '../repositories/funcionario.repository.js';

const repository = new FuncionarioRepository();

export class FuncionarioController {
  async create(req: Request, res: Response) {
    try {
      const funcionario = await repository.create(req.body);
      res.status(201).json(funcionario);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Funcionario', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const funcionarios = await repository.findAll();
      res.json(funcionarios);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Funcionarios' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const funcionario = await repository.findById(id);
      if (!funcionario) {
        return res.status(404).json({ error: 'Funcionario not found' });
      }
      res.json(funcionario);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Funcionario' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const funcionario = await repository.update(id, req.body);
      res.json(funcionario);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Funcionario' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Funcionario' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\itensOs.controller.ts
================================================================================
import { Request, Response } from 'express';
import { ItensOsRepository } from '../repositories/itensOs.repository.js';
import { PagamentoPecaRepository } from '../repositories/pagamentoPeca.repository.js';

const repository = new ItensOsRepository();
const pagamentoRepository = new PagamentoPecaRepository();

export class ItensOsController {
  async create(req: Request, res: Response) {
    try {
      const { id_fornecedor, custo_real, ...itemData } = req.body;
      const item = await repository.create(itemData);
      
      if (id_fornecedor) {
          await pagamentoRepository.create({
              item_os: { connect: { id_iten: item.id_iten } },
              fornecedor: { connect: { id_fornecedor: Number(id_fornecedor) } },
              custo_real: custo_real ? Number(custo_real) : 0,
              data_compra: new Date(),
              pago_ao_fornecedor: false
          });
      }

      res.status(201).json(item);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Item OS', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const itens = await repository.findAll();
      res.json(itens);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Itens OS' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const item = await repository.findById(id);
      if (!item) {
        return res.status(404).json({ error: 'Item OS not found' });
      }
      res.json(item);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Item OS' });
    }
  }

  async findByOsId(req: Request, res: Response) {
    try {
      const idOs = Number(req.params.idOs);
      const itens = await repository.findByOsId(idOs);
      res.json(itens);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Itens for OS' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const { id_fornecedor, custo_real, ...itemData } = req.body;
      
      const item = await repository.update(id, itemData);

      if (id_fornecedor !== undefined) {
          // Check if payment record exists
          const existingPayments = await pagamentoRepository.findByItemId(id);
          
          if (existingPayments && existingPayments.length > 0) {
              if (id_fornecedor) {
                  const updateData: any = {
                      fornecedor: { connect: { id_fornecedor: Number(id_fornecedor) } }
                  };
                  if (custo_real) {
                      updateData.custo_real = Number(custo_real);
                  }
                  
                  await pagamentoRepository.update(existingPayments[0]!.id_pagamento_peca, updateData);
              } else {
                  // If cleared, delete the payment record
                  await pagamentoRepository.delete(existingPayments[0]!.id_pagamento_peca);
              }
          } else if (id_fornecedor) {
              // Create new if strictly provided
              await pagamentoRepository.create({
                  item_os: { connect: { id_iten: id } },
                  fornecedor: { connect: { id_fornecedor: Number(id_fornecedor) } },
                  custo_real: custo_real ? Number(custo_real) : 0,
                  data_compra: new Date(),
                  pago_ao_fornecedor: false
              });
          }
      }

      res.json(item);
    } catch (error) {
      console.error(error);
      res.status(400).json({ error: 'Failed to update Item OS' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Item OS' });
    }
  }

  async search(req: Request, res: Response) {
    try {
      const query = req.query.q as string;
      if (!query) return res.json([]);
      const itens = await repository.search(query);
      res.json(itens);
    } catch (error) {
      res.status(500).json({ error: 'Failed to search Item OS descriptions' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\livroCaixa.controller.ts
================================================================================
import { Request, Response } from 'express';
import { prisma } from '../prisma.js';

export const getAll = async (req: Request, res: Response) => {
    try {
        const registros = await prisma.livroCaixa.findMany({
            where: { deleted_at: null },
            orderBy: { dt_movimentacao: 'desc' }
        });
        res.json(registros);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao buscar livro caixa' });
    }
};

export const create = async (req: Request, res: Response) => {
    try {
        const { descricao, valor, tipo_movimentacao, categoria, obs, origem } = req.body;
        const registro = await prisma.livroCaixa.create({
            data: { 
                descricao, 
                valor, 
                tipo_movimentacao, 
                categoria,
                obs,
                origem: origem || 'MANUAL'
            }
        });
        res.status(201).json(registro);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao criar registro' });
    }
};

export const update = async (req: Request, res: Response) => {
    const { id } = req.params;
    try {
        const { descricao, valor, tipo_movimentacao, categoria, obs } = req.body;
        const registro = await prisma.livroCaixa.update({
            where: { id_livro_caixa: Number(id) },
            data: { descricao, valor, tipo_movimentacao, categoria, obs }
        });
        res.json(registro);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao atualizar registro' });
    }
};

export const softDelete = async (req: Request, res: Response) => {
    const { id } = req.params;
    const { obs } = req.body;
    try {
        const registro = await prisma.livroCaixa.update({
             where: { id_livro_caixa: Number(id) },
             data: { 
                 deleted_at: new Date(),
                 obs: obs // Update obs if provided
             }
        });
        res.json(registro);
    } catch (error) {
         res.status(500).json({ error: 'Erro ao deletar registro' });
    }
};



================================================================================
FILE PATH: server\src\controllers\ordemDeServico.controller.ts
================================================================================
import { Request, Response } from 'express';
import { OrdemDeServicoRepository } from '../repositories/ordemDeServico.repository.js';

const repository = new OrdemDeServicoRepository();

export class OrdemDeServicoController {
  async create(req: Request, res: Response) {
    try {
      const os = await repository.create(req.body);
      res.status(201).json(os);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create OS', details: error });
    }
  }

  async createUnified(req: Request, res: Response) {
    try {
        const result = await repository.createUnified(req.body);
        res.status(201).json(result);
    } catch (error) {
        console.error('Unified Create Error:', error);
        res.status(400).json({ error: 'Failed to create OS Unified', details: error instanceof Error ? error.message : error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const oss = await repository.findAll();
      res.json(oss);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch OSs' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const os = await repository.findById(id);
      if (!os) {
        return res.status(404).json({ error: 'OS not found' });
      }
      res.json(os);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch OS' });
    }
  }

  async findByVehicleId(req: Request, res: Response) {
    try {
      const vehicleId = Number(req.params.vehicleId);
      if (isNaN(vehicleId)) {
        return res.status(400).json({ error: 'Invalid Vehicle ID' });
      }
      const oss = await repository.findByVehicleId(vehicleId);
      res.json(oss);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch OSs for vehicle' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const os = await repository.update(id, req.body);
      res.json(os);
    } catch (error) {
      console.error('Update OS Error:', error);
      res.status(400).json({ error: 'Failed to update OS', details: error instanceof Error ? error.message : error });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete OS' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\pagamentoCliente.controller.ts
================================================================================
import { Request, Response } from 'express';
import { PagamentoClienteRepository } from '../repositories/pagamentoCliente.repository.js';

const repository = new PagamentoClienteRepository();

export class PagamentoClienteController {
  async create(req: Request, res: Response) {
    try {
      const pagamento = await repository.create(req.body);
      res.status(201).json(pagamento);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create PagamentoCliente', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const pagamentos = await repository.findAll();
      res.json(pagamentos);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch PagamentoClientes' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pagamento = await repository.findById(id);
      if (!pagamento) {
        return res.status(404).json({ error: 'PagamentoCliente not found' });
      }
      res.json(pagamento);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch PagamentoCliente' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pagamento = await repository.update(id, req.body);
      res.json(pagamento);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update PagamentoCliente' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete PagamentoCliente' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\pagamentoEquipe.controller.ts
================================================================================
import { Request, Response } from 'express';
import { prisma } from '../prisma.js';

export const getPendentesByFuncionario = async (req: Request, res: Response) => {
    try {
        const { id_funcionario } = req.params;
        
        // Busca serviços de Mão de Obra Pendentes
        const servicos = await prisma.servicoMaoDeObra.findMany({
            where: {
                id_funcionario: Number(id_funcionario),
                status_pagamento: 'PENDENTE',
                deleted_at: null
            },
            include: {
                ordem_de_servico: {
                    select: {
                        id_os: true,
                        dt_abertura: true,
                        dt_entrega: true, 
                        // dt_finalizacao: true, // Assuming this field might not verify in schema yet based on previous turns, but filter uses it. Check schema.
                        // Actually schema has NO dt_finalizacao, only dt_entrega (which is finalization date usually).
                        // Let's check Schema one last time? No, I recall dt_entrega is the one. 
                        // Wait, previous turn code used dt_finalizacao. 
                        // Schema lines 200: dt_entrega DateTime?
                        // Schema lines 201: km_entrada
                        // No dt_finalizacao in recent view. So I should stick to dt_entrega.
                        // But I will add defect and diagnosis.
                        status: true,
                        defeito_relatado: true,
                        diagnostico: true,
                        veiculo: true,
                        cliente: {
                            include: {
                                pessoa_fisica: { include: { pessoa: true } },
                                pessoa_juridica: { include: { pessoa: true } }
                            }
                        }
                    }
                }
            },
            orderBy: {
                dt_cadastro: 'desc'
            }
        });

        res.json(servicos);
    } catch (error) {
        console.error(error);
        res.status(500).json({ error: 'Erro ao buscar comissões pendentes' });
    }
};

export const getValesPendentesByFuncionario = async (req: Request, res: Response) => {
    try {
        const { id_funcionario } = req.params;
        const vales = await prisma.pagamentoEquipe.findMany({
            where: {
                id_funcionario: Number(id_funcionario),
                tipo_lancamento: 'VALE',
                descontado: false
            },
            orderBy: {
                dt_pagamento: 'desc'
            }
        });
        res.json(vales);
    } catch (error) {
        console.error(error);
        res.status(500).json({ error: 'Erro ao buscar vales pendentes' });
    }
};

export const createPagamento = async (req: Request, res: Response) => {
    try {
        const { 
            id_funcionario, servicos_ids, vales_ids, valor_total, obs, 
            forma_pagamento, premio_valor, premio_descricao,
            tipo_lancamento, referencia_inicio, referencia_fim
        } = req.body;

        const result = await prisma.$transaction(async (tx) => {
            // 1. Criar Registro de Pagamento
            // Se for VALE, ele nasce nao descontado (descontado: false). Se for SALARIO/COMISSAO, nao se aplica (false).
            const pagamento = await tx.pagamentoEquipe.create({
                data: {
                    id_funcionario: Number(id_funcionario),
                    valor_total: Number(valor_total),
                    forma_pagamento: forma_pagamento || 'DINHEIRO',
                    premio_valor: premio_valor ? Number(premio_valor) : null,
                    premio_descricao: premio_descricao || null,
                    tipo_lancamento: tipo_lancamento || 'COMISSAO',
                    referencia_inicio: referencia_inicio ? new Date(referencia_inicio) : null,
                    referencia_fim: referencia_fim ? new Date(referencia_fim) : null,
                    obs: obs,
                    descontado: false // Default
                }
            });

            // 2. Atualizar Serviços (Comissões)
            if (servicos_ids && servicos_ids.length > 0) {
                await tx.servicoMaoDeObra.updateMany({
                    where: {
                        id_servico_mao_de_obra: { in: servicos_ids },
                        deleted_at: null
                    },
                    data: {
                        status_pagamento: 'PAGO',
                        id_pagamento_equipe: pagamento.id_pagamento_equipe
                    }
                });
            }

            // 3. Deduzir Vales (Se houver IDs de vales selecionados para desconto)
            if (vales_ids && vales_ids.length > 0) {
                await tx.pagamentoEquipe.updateMany({
                   where: {
                       id_pagamento_equipe: { in: vales_ids },
                       id_funcionario: Number(id_funcionario),
                       tipo_lancamento: 'VALE',
                       descontado: false
                   },
                   data: {
                       descontado: true,
                       id_pagamento_deducao: pagamento.id_pagamento_equipe
                   }
                });
            }

            // 3. Obter nome do funcionário para o Livro Caixa
            const func = await tx.funcionario.findUnique({
                where: { id_funcionario: Number(id_funcionario) },
                include: { pessoa_fisica: { include: { pessoa: true } } }
            });
            const nomeFunc = func?.pessoa_fisica?.pessoa?.nome || 'Funcionário';

            // 4. Lançar no Livro Caixa
            await tx.livroCaixa.create({
                data: {
                    descricao: `Pagamento Equipe - ${nomeFunc}`,
                    valor: Number(valor_total),
                    tipo_movimentacao: 'SAIDA',
                    categoria: 'EQUIPE',
                    id_pagamento_equipe: pagamento.id_pagamento_equipe
                }
            });

            return pagamento;
        });

        res.status(201).json(result);
    } catch (error) {
        console.error(error);
        res.status(500).json({ error: 'Erro ao realizar pagamento' });
    }
};

export const getHistorico = async (req: Request, res: Response) => {
    try {
        const pagamentos = await prisma.pagamentoEquipe.findMany({
            include: {
                funcionario: {
                     include: { pessoa_fisica: { include: { pessoa: true } } }
                },
                servicos_pagos: {
                    include: { 
                        ordem_de_servico: {
                            include: {
                                veiculo: true,
                                cliente: {
                                    include: {
                                        pessoa_fisica: { include: { pessoa: true } },
                                        pessoa_juridica: { include: { pessoa: true } }
                                    }
                                }
                            }
                        }
                    }
                }
            },
            orderBy: { dt_pagamento: 'desc' }
        });
        res.json(pagamentos);
    } catch (error) {
        res.status(500).json({ error: 'Erro ao buscar histórico' });
    }
};



================================================================================
FILE PATH: server\src\controllers\pagamentoPeca.controller.ts
================================================================================
import { Request, Response } from 'express';
import { PagamentoPecaRepository } from '../repositories/pagamentoPeca.repository.js';

const repository = new PagamentoPecaRepository();

export class PagamentoPecaController {
  async create(req: Request, res: Response) {
    try {
      const pagamento = await repository.create(req.body);
      res.status(201).json(pagamento);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Pagamento Peca', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const pagamentos = await repository.findAll();
      res.json(pagamentos);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Pagamentos Peca' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pagamento = await repository.findById(id);
      if (!pagamento) {
        return res.status(404).json({ error: 'Pagamento Peca not found' });
      }
      res.json(pagamento);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Pagamento Peca' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pagamento = await repository.update(id, req.body);
      res.json(pagamento);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Pagamento Peca' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Pagamento Peca' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\pecasEstoque.controller.ts
================================================================================
import { Request, Response } from 'express';
import { PecasEstoqueRepository } from '../repositories/pecasEstoque.repository.js';

const repository = new PecasEstoqueRepository();

export class PecasEstoqueController {
  async create(req: Request, res: Response) {
    try {
      const peca = await repository.create(req.body);
      res.status(201).json(peca);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Peca', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const pecas = await repository.findAll();
      res.json(pecas);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Pecas' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const peca = await repository.findById(id);
      if (!peca) {
        return res.status(404).json({ error: 'Peca not found' });
      }
      res.json(peca);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Peca' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const peca = await repository.update(id, req.body);
      res.json(peca);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Peca' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Peca' });
    }
  }

  async search(req: Request, res: Response) {
    try {
      const query = req.query.q as string;
      if (!query) return res.json([]);
      const pecas = await repository.search(query);
      res.json(pecas);
    } catch (error) {
      res.status(500).json({ error: 'Failed to search Pecas' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\pessoa.controller.ts
================================================================================
import { Request, Response } from 'express';
import { PessoaRepository } from '../repositories/pessoa.repository.js';

const repository = new PessoaRepository();

export class PessoaController {
  async create(req: Request, res: Response) {
    try {
      const pessoa = await repository.create(req.body);
      res.status(201).json(pessoa);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Pessoa', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const pessoas = await repository.findAll();
      res.json(pessoas);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Pessoas' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pessoa = await repository.findById(id);
      if (!pessoa) {
        return res.status(404).json({ error: 'Pessoa not found' });
      }
      res.json(pessoa);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Pessoa' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pessoa = await repository.update(id, req.body);
      res.json(pessoa);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Pessoa' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Pessoa' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\pessoaFisica.controller.ts
================================================================================
import { Request, Response } from 'express';
import { PessoaFisicaRepository } from '../repositories/pessoaFisica.repository.js';

const repository = new PessoaFisicaRepository();

export class PessoaFisicaController {
  async create(req: Request, res: Response) {
    try {
      const pessoaFisica = await repository.create(req.body);
      res.status(201).json(pessoaFisica);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create PessoaFisica', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const pessoasFisicas = await repository.findAll();
      res.json(pessoasFisicas);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch PessoasFisicas' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pessoaFisica = await repository.findById(id);
      if (!pessoaFisica) {
        return res.status(404).json({ error: 'PessoaFisica not found' });
      }
      res.json(pessoaFisica);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch PessoaFisica' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pessoaFisica = await repository.update(id, req.body);
      res.json(pessoaFisica);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update PessoaFisica' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete PessoaFisica' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\pessoaJuridica.controller.ts
================================================================================
import { Request, Response } from 'express';
import { PessoaJuridicaRepository } from '../repositories/pessoaJuridica.repository.js';

const repository = new PessoaJuridicaRepository();

export class PessoaJuridicaController {
  async create(req: Request, res: Response) {
    try {
      const pessoaJuridica = await repository.create(req.body);
      res.status(201).json(pessoaJuridica);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create PessoaJuridica', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const pessoasJuridicas = await repository.findAll();
      res.json(pessoasJuridicas);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch PessoasJuridicas' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pessoaJuridica = await repository.findById(id);
      if (!pessoaJuridica) {
        return res.status(404).json({ error: 'PessoaJuridica not found' });
      }
      res.json(pessoaJuridica);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch PessoaJuridica' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const pessoaJuridica = await repository.update(id, req.body);
      res.json(pessoaJuridica);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update PessoaJuridica' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete PessoaJuridica' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\servicoMaoDeObra.controller.ts
================================================================================
import { Request, Response } from 'express';
import { ServicoMaoDeObraRepository } from '../repositories/servicoMaoDeObra.repository.js';

const repository = new ServicoMaoDeObraRepository();

export class ServicoMaoDeObraController {
  async create(req: Request, res: Response) {
    try {
      const { id_os, id_funcionario, valor, descricao } = req.body;
      const result = await repository.create({ 
          id_os: Number(id_os), 
          id_funcionario: Number(id_funcionario), 
          valor: Number(valor), 
          descricao 
      });
      res.status(201).json(result);
    } catch (error) {
      console.error(error);
      res.status(500).json({ error: 'Failed to add labor service' });
    }
  }

  async index(req: Request, res: Response) {
      try {
          const { id_os } = req.params;
          const result = await repository.findAllByOs(Number(id_os));
          res.json(result);
      } catch (error) {
          res.status(500).json({ error: 'Failed to fetch labor services' });
      }
  }

  async update(req: Request, res: Response) {
    try {
      const { id } = req.params;
      const { id_funcionario, valor, descricao } = req.body;
      
      const updateData: any = {};
      if (id_funcionario) updateData.id_funcionario = Number(id_funcionario);
      if (valor !== undefined) updateData.valor = Number(valor);
      if (descricao !== undefined) updateData.descricao = descricao;

      const result = await repository.update(Number(id), updateData);
      res.json(result);
    } catch (error) {
      console.error(error);
      res.status(500).json({ error: 'Failed to update labor service' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const { id } = req.params;
      await repository.softDelete(Number(id));
      res.status(204).send();
    } catch (error) {
      res.status(500).json({ error: 'Failed to delete labor service' });
    }
  }
}

export const servicoMaoDeObraController = new ServicoMaoDeObraController();



================================================================================
FILE PATH: server\src\controllers\tipo.controller.ts
================================================================================
import { Request, Response } from 'express';
import { TipoRepository } from '../repositories/tipo.repository.js';

const repository = new TipoRepository();

export class TipoController {
  async create(req: Request, res: Response) {
    try {
      const tipo = await repository.create(req.body);
      res.status(201).json(tipo);
    } catch (error) {
      res.status(400).json({ error: 'Failed to create Tipo', details: error });
    }
  }

  async findAll(req: Request, res: Response) {
    try {
      const tipos = await repository.findAll();
      res.json(tipos);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Tipos' });
    }
  }

  async findById(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const tipo = await repository.findById(id);
      if (!tipo) {
        return res.status(404).json({ error: 'Tipo not found' });
      }
      res.json(tipo);
    } catch (error) {
      res.status(500).json({ error: 'Failed to fetch Tipo' });
    }
  }

  async update(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      const tipo = await repository.update(id, req.body);
      res.json(tipo);
    } catch (error) {
      res.status(400).json({ error: 'Failed to update Tipo' });
    }
  }

  async delete(req: Request, res: Response) {
    try {
      const id = Number(req.params.id);
      await repository.delete(id);
      res.status(204).send();
    } catch (error) {
      res.status(400).json({ error: 'Failed to delete Tipo' });
    }
  }
}



================================================================================
FILE PATH: server\src\controllers\veiculo.controller.ts
================================================================================
================================================================================

import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class ClienteRepository {
  async create(data: any) {
    console.log('📥 ClienteRepository.create - Received data:', JSON.stringify(data, null, 2));

    // TRANSACTIONAL CREATION FOR SIMPLIFIED PAYLOAD
    // If 'nome' is provided and we don't have explicit foreign keys, assume we need to create the person structure.
    if (data.nome && !data.id_pessoa_fisica && !data.id_pessoa_juridica) {
        return await prisma.$transaction(async (tx) => {
            // 1. Create Base Pessoa
            const pessoa = await tx.pessoa.create({
                data: { 
                    nome: data.nome 
                }
            });

            let idPessoaFisica = null;
            let idPessoaJuridica = null;
            let tipoPessoaId = 1; // Default to Fisica

            if (data.tipo === 'JURIDICA') {
                tipoPessoaId = 2;
                const pj = await tx.pessoaJuridica.create({
                    data: {
                        id_pessoa: pessoa.id_pessoa,
                        razao_social: data.nome, // Using name as Razao Social for simplicity
                        cnpj: data.cnpj || null
                    }
                });
                idPessoaJuridica = pj.id_pessoa_juridica;
            } else {
                // Default to FISICA
                const pf = await tx.pessoaFisica.create({
                    data: {
                        id_pessoa: pessoa.id_pessoa,
                        cpf: data.cpf || null
                    }
                });
                idPessoaFisica = pf.id_pessoa_fisica;
            }

            // 2. Create Cliente
            const cliente = await tx.cliente.create({
                data: {
                    id_pessoa_fisica: idPessoaFisica,
                    id_pessoa_juridica: idPessoaJuridica,
                    tipo_pessoa: tipoPessoaId,
                    telefone_1: data.telefone_1,
                    telefone_2: data.telefone_2 || null,
                    email: data.email || null,
                    logradouro: data.logradouro || null,
                    nr_logradouro: data.nr_logradouro || null,
                    bairro: data.bairro || null,
                    cidade: data.cidade || null,
                    estado: data.estado || null,
                    // Map 'cep' if you add it to schema, currently schema doesn't seem to have explicit 'cep' column in Cliente? 
                    // Checked schema: Cliente has logradouro, nr, compl, bairro, cidade, estado. NO CEP.
                    // Ignoring CEP for now as it's not in schema.
                }
            });

            console.log('✅ Cliente transaction complete:', cliente.id_cliente);
            return cliente;
        });
    }
    
    // EXISTING LOGIC (If IDs are provided)
    const { id_pessoa_fisica, id_pessoa_juridica, ...clienteData } = data;
    
    const payload = {
      ...clienteData,
      id_pessoa_fisica: id_pessoa_fisica || null,
      id_pessoa_juridica: id_pessoa_juridica || null,
    };
    
    console.log('📤 ClienteRepository.create - Sending to Prisma:', JSON.stringify(payload, null, 2));
    
    try {
      const result = await prisma.cliente.create({
        data: payload,
      });
      console.log('✅ ClienteRepository.create - Success:', result.id_cliente);
      return result;
    } catch (error: any) {
      console.error('❌ ClienteRepository.create - Error:', error);
      throw error;
    }
  }

  async findAll() {
    return await prisma.cliente.findMany({
        include: {
            pessoa_fisica: { include: { pessoa: true } },
            pessoa_juridica: { include: { pessoa: true } },
            tipo: true,
            veiculos: true
        }
    });
  }

  async findById(id: number) {
    return await prisma.cliente.findUnique({
      where: { id_cliente: id },
      include: {
        pessoa_fisica: { include: { pessoa: true } },
        pessoa_juridica: { include: { pessoa: true } },
        tipo: true,
        veiculos: true
      }
    });
  }

  async update(id: number, data: Prisma.ClienteUpdateInput) {
    return await prisma.cliente.update({
      where: { id_cliente: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.cliente.delete({
      where: { id_cliente: id },
    });
  }

  // Case-insensitive & accent-insensitive search by name
  async searchByName(searchTerm: string) {
    const searchPattern = `%${searchTerm}%`;

    const ids = await prisma.$queryRaw<{id_cliente: number}[]>`
      SELECT c.id_cliente
      FROM "cliente" c
      LEFT JOIN "pessoa_fisica" pf ON c.id_pessoa_fisica = pf.id_pessoa_fisica
      LEFT JOIN "pessoa" p1 ON pf.id_pessoa = p1.id_pessoa
      LEFT JOIN "pessoa_juridica" pj ON c.id_pessoa_juridica = pj.id_pessoa_juridica
      LEFT JOIN "pessoa" p2 ON pj.id_pessoa = p2.id_pessoa
      WHERE unaccent(p1.nome) ILIKE unaccent(${searchPattern})
         OR unaccent(p2.nome) ILIKE unaccent(${searchPattern})
         OR (pj.nome_fantasia IS NOT NULL AND unaccent(pj.nome_fantasia) ILIKE unaccent(${searchPattern}))
      LIMIT 20
    `;

    const idList = ids.map(item => item.id_cliente);

    if (idList.length === 0) {
        return [];
    }

    return await prisma.cliente.findMany({
      where: {
        id_cliente: { in: idList }
      },
      include: {
        pessoa_fisica: { include: { pessoa: true } },
        pessoa_juridica: { include: { pessoa: true } },
        tipo: true,
        veiculos: true
      }
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\contasPagar.repository.ts
================================================================================

import { prisma } from '../prisma.js';

export class ContasPagarRepository {
    async create(data: any) {
        console.log('[ContasPagarRepo] Creating:', data);
        
        // Helper para normalizar datas para Meio-Dia UTC (Garante fidelidade do dia no Fuso BRT)
        // Evita que 00:00 UTC vire 21:00 do dia anterior.
        const normalizeDate = (dateInfo: any) => {
             if (!dateInfo) return null;
             const dt = new Date(dateInfo);
             dt.setUTCHours(12, 0, 0, 0);
             return dt;
        };

        if (data.dt_vencimento) data.dt_vencimento = normalizeDate(data.dt_vencimento);
        if (data.dt_pagamento) data.dt_pagamento = normalizeDate(data.dt_pagamento);
        
        return prisma.$transaction(async (tx) => {
            const created = await tx.contasPagar.create({ data });
            console.log('[ContasPagarRepo] Created Status:', created.status);

            // Se já nascer PAGO, lança no caixa
            if (created.status === 'PAGO') {
                console.log('[ContasPagarRepo] Auto-launching Livro Caixa for Create');
                
                 // Smart Date Logic for Livro Caixa
                 let movimentoDate = new Date();
                 if (data.dt_pagamento) {
                     const pgDate = new Date(data.dt_pagamento);
                     const now = new Date();
                     const isSameDay = pgDate.toISOString().split('T')[0] === now.toISOString().split('T')[0]; 
                     if (!isSameDay) movimentoDate = pgDate; 
                 }

                await tx.livroCaixa.create({
                    data: {
                        descricao: `Conta: ${created.descricao}`,
                        valor: created.valor,
                        tipo_movimentacao: 'SAIDA',
                        categoria: created.categoria || 'DESPESAS GERAIS',
                        dt_movimentacao: movimentoDate,
                        origem: 'AUTOMATICA',
                        obs: `Referente à conta a pagar #${created.id_conta_pagar}`
                    }
                });
            }
            return created;
        });
    }

    // ... findAll / findById ...
    async findAll() {
        return prisma.contasPagar.findMany({
            where: { deleted_at: null },
            orderBy: { dt_vencimento: 'asc' }
        });
    }

    async findById(id: number) {
        return prisma.contasPagar.findUnique({
            where: { id_conta_pagar: id }
        });
    }

    async update(id: number, data: any) {
        console.log(`[ContasPagarRepo] Updating ID ${id} with:`, data);
        
        // Redefinindo o helper aqui ou usando lógica direta para manter o arquivo limpo se não extraí pra fora da classe
        const normalizeDate = (dateInfo: any) => {
             if (!dateInfo) return null;
             const dt = new Date(dateInfo);
             dt.setUTCHours(12, 0, 0, 0);
             return dt;
        };

        if (data.dt_vencimento) data.dt_vencimento = normalizeDate(data.dt_vencimento);
        if (data.dt_pagamento) data.dt_pagamento = normalizeDate(data.dt_pagamento);

        // ... dentro de update ...
        // Checar estado anterior
        const current = await prisma.contasPagar.findUnique({ where: { id_conta_pagar: id } });
        console.log(`[ContasPagarRepo] Current status: ${current?.status}, New status: ${data.status}`);
        
        const isPayingNow = current?.status !== 'PAGO' && data.status === 'PAGO';
        console.log('[ContasPagarRepo] Is Paying Now?', isPayingNow);

        return prisma.$transaction(async (tx) => {
            const updated = await tx.contasPagar.update({
                where: { id_conta_pagar: id },
                data: { ...data } // Ensure we pass the modified data object with fixed dates
            });

            if (isPayingNow) {
                 console.log('[ContasPagarRepo] Auto-launching Livro Caixa for Update');
                 
                 // Smart Date Logic for Livro Caixa
                 // Se data.dt_pagamento existe (foi processada para 12h ou veio no payload)
                 // Verificamos se é "HOJE". Se for, usamos AGORA (pra ter hora certa).
                 // Se não, usamos a data processada (12h) para garantir o dia.
                 let movimentoDate = new Date();
                 if (data.dt_pagamento) {
                     const pgDate = new Date(data.dt_pagamento);
                     const now = new Date();
                     // Check if same day (ignoring time)
                     const isSameDay = pgDate.toISOString().split('T')[0] === now.toISOString().split('T')[0]; // Crude check but works for simplified UTC comparison logic established
                     
                     if (!isSameDay) {
                         movimentoDate = pgDate; // Use the 12:00 UTC date
                     }
                     // If it IS same day, we stick with 'movimentoDate = new Date()' to capture exact current time
                 }

                 await tx.livroCaixa.create({
                    data: {
                        descricao: `Conta: ${updated.descricao}`,
                        valor: updated.valor,
                        tipo_movimentacao: 'SAIDA',
                        categoria: updated.categoria || 'DESPESAS GERAIS',
                        dt_movimentacao: movimentoDate,
                        origem: 'AUTOMATICA',
                        obs: `Referente à conta a pagar #${updated.id_conta_pagar}`
                    }
                });
            }

            return updated;
        });
    }

    async delete(id: number) {
        return prisma.contasPagar.update({
            where: { id_conta_pagar: id },
            data: { deleted_at: new Date() }
        });
    }
}



================================================================================
FILE PATH: server\src\repositories\fechamentoFinanceiro.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class FechamentoFinanceiroRepository {
  async create(data: Prisma.FechamentoFinanceiroCreateInput) {
    return await prisma.fechamentoFinanceiro.create({
      data,
    });
  }

  async findAll() {
    return await prisma.fechamentoFinanceiro.findMany({
        include: { 
            ordem_de_servico: {
                include: { 
                    veiculo: true,
                    servicos_mao_de_obra: {
                        where: { deleted_at: null },
                        include: {
                            funcionario: {
                                include: {
                                    pessoa_fisica: {
                                        include: {
                                            pessoa: true
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            } 
        }
    });
  }

  async findById(id: number) {
    return await prisma.fechamentoFinanceiro.findUnique({
      where: { id_fechamento_financeiro: id },
        include: { ordem_de_servico: true }
    });
  }

  async update(id: number, data: Prisma.FechamentoFinanceiroUpdateInput) {
    return await prisma.fechamentoFinanceiro.update({
      where: { id_fechamento_financeiro: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.fechamentoFinanceiro.delete({
      where: { id_fechamento_financeiro: id },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\fornecedor.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class FornecedorRepository {
  async create(data: Prisma.FornecedorCreateInput) {
    return await prisma.fornecedor.create({
      data,
    });
  }

  async findAll() {
    return await prisma.fornecedor.findMany();
  }

  async findById(id: number) {
    return await prisma.fornecedor.findUnique({
      where: { id_fornecedor: id },
    });
  }

  async update(id: number, data: Prisma.FornecedorUpdateInput) {
    return await prisma.fornecedor.update({
      where: { id_fornecedor: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.fornecedor.delete({
      where: { id_fornecedor: id },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\funcionario.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class FuncionarioRepository {
  async create(data: Prisma.FuncionarioCreateInput) {
    return await prisma.funcionario.create({
      data,
    });
  }

  async findAll() {
    return await prisma.funcionario.findMany({
        include: { pessoa_fisica: { include: { pessoa: true } } }
    });
  }

  async findById(id: number) {
    return await prisma.funcionario.findUnique({
      where: { id_funcionario: id },
      include: { pessoa_fisica: { include: { pessoa: true } } }
    });
  }

  async update(id: number, data: Prisma.FuncionarioUpdateInput) {
    return await prisma.funcionario.update({
      where: { id_funcionario: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.funcionario.delete({
      where: { id_funcionario: id },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\itensOs.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';
import { AuditLogRepository } from './auditLog.repository.js';
import { OrdemDeServicoRepository } from './ordemDeServico.repository.js';

const auditRepo = new AuditLogRepository();
const osRepo = new OrdemDeServicoRepository();

export class ItensOsRepository {
  async create(data: Prisma.ItensOsCreateInput) {
    const created = await prisma.itensOs.create({
      data,
    });
    
    await auditRepo.create({
        tabela: 'itens_os',
        registro_id: created.id_iten,
        acao: 'CREATE',
        valor_novo: created
    });

    // Recalculate OS totals
    await osRepo.recalculateTotals(created.id_os);
    
    return created;
  }

  async findAll() {
    return await prisma.itensOs.findMany({
        where: { deleted_at: null },
        include: { ordem_de_servico: true, pecas_estoque: true, pagamentos_peca: true }
    });
  }

  async findById(id: number) {
    return await prisma.itensOs.findUnique({
      where: { id_iten: id },
        include: { ordem_de_servico: true, pecas_estoque: true, pagamentos_peca: true }
    });
  }

  async findByOsId(idOs: number) {
    return await prisma.itensOs.findMany({
      where: { id_os: idOs, deleted_at: null },
      include: { pecas_estoque: true, pagamentos_peca: true }
    });
  }

  async update(id: number, data: Prisma.ItensOsUpdateInput) {
    const current = await this.findById(id);
    const updated = await prisma.itensOs.update({
      where: { id_iten: id },
      data,
    });

    await auditRepo.create({
        tabela: 'itens_os',
        registro_id: id,
        acao: 'UPDATE',
        valor_antigo: current,
        valor_novo: updated
    });
    
    // Recalculate OS totals
    await osRepo.recalculateTotals(updated.id_os);

    return updated;
  }

  async delete(id: number) {
    const current = await this.findById(id);
    if (!current) throw new Error('Item not found');

    const updated = await prisma.itensOs.update({
      where: { id_iten: id },
      data: { deleted_at: new Date() }
    });

    await auditRepo.create({
        tabela: 'itens_os',
        registro_id: id,
        acao: 'SOFT_DELETE',
        valor_antigo: current
    });
    
    // Recalculate OS totals
    await osRepo.recalculateTotals(current.id_os);

    return updated;
  }

  async search(query: string) {
    // Busca descrições únicas na tabela de itens já usados
    return await prisma.itensOs.findMany({
      where: {
        descricao: { contains: query, mode: 'insensitive' },
        deleted_at: null
      },
      distinct: ['descricao'],
      take: 10
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\ordemDeServico.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';
import { AuditLogRepository } from './auditLog.repository.js';

const auditRepo = new AuditLogRepository();

export class OrdemDeServicoRepository {
  async create(data: Prisma.OrdemDeServicoCreateInput) {
    const created = await prisma.ordemDeServico.create({
      data,
    });
    
    await auditRepo.create({
        tabela: 'ordem_de_servico',
        registro_id: created.id_os,
        acao: 'CREATE',
        valor_novo: created
    });
    
    return created;
  }

  async createUnified(data: any) {
    return await prisma.$transaction(async (tx) => {
        let finalClientId = data.client.id_cliente;

        // 1. Handle Client Creation if needed
        if (!finalClientId) {
             const isJuridica = data.client.tipo === 'JURIDICA';
             
             // Base Pessoa
             const pessoa = await tx.pessoa.create({
                 data: { nome: data.client.nome }
             });

             let idPessoaFisica = null;
             let idPessoaJuridica = null;
             let tipoId = 1; // Default Default 1=Fisica

             if (isJuridica) {
                 tipoId = 2; // Default 2=Juridica
                 const pj = await tx.pessoaJuridica.create({
                     data: {
                         id_pessoa: pessoa.id_pessoa,
                         razao_social: data.client.nome,
                         cnpj: data.client.cnpj || null
                     }
                 });
                 idPessoaJuridica = pj.id_pessoa_juridica;
             } else {
                 const pf = await tx.pessoaFisica.create({
                     data: {
                         id_pessoa: pessoa.id_pessoa,
                         cpf: data.client.cpf || null
                     }
                 });
                 idPessoaFisica = pf.id_pessoa_fisica;
             }

             const newClient = await tx.cliente.create({
                 data: {
                     id_pessoa_fisica: idPessoaFisica,
                     id_pessoa_juridica: idPessoaJuridica,
                     tipo_pessoa: tipoId,
                     telefone_1: data.client.telefone,
                     logradouro: data.client.logradouro,
                     nr_logradouro: data.client.numero,
                     bairro: data.client.bairro,
                     cidade: data.client.cidade,
                     estado: data.client.estado
                 }
             });
             finalClientId = newClient.id_cliente;
        }

        // 2. Handle Vehicle Creation if needed
        let finalVehicleId = data.vehicle.id_veiculo;
        if (!finalVehicleId) {
             // Check if vehicle exists by Plate to avoid duplicates
             const existingVehicle = await tx.veiculo.findUnique({
                 where: { placa: data.vehicle.placa }
             });

             if (existingVehicle) {
                 // If vehicle exists, update owner to new client and use it
                 if (existingVehicle.id_cliente !== finalClientId) {
                     await tx.veiculo.update({
                         where: { id_veiculo: existingVehicle.id_veiculo },
                         data: { id_cliente: finalClientId }
                     });
                 }
                 finalVehicleId = existingVehicle.id_veiculo;
             } else {
                 const newVehicle = await tx.veiculo.create({
                     data: {
                         id_cliente: finalClientId,
                         placa: data.vehicle.placa,
                         marca: data.vehicle.marca,
                         modelo: data.vehicle.modelo,
                         cor: data.vehicle.cor || 'BRANCO',
                         ano_modelo: data.vehicle.ano,
                         combustivel: data.vehicle.combustivel || 'FLEX'
                     }
                 });
                 finalVehicleId = newVehicle.id_veiculo;
             }
        }

        // 3. Create OS
        const os = await tx.ordemDeServico.create({
            data: {
                id_cliente: finalClientId,
                id_veiculo: finalVehicleId,
                id_funcionario: Number(data.os.id_funcionario),
                km_entrada: Number(data.os.km_entrada),
                defeito_relatado: data.os.defeito_relatado,
                status: 'ABERTA',
                valor_total_cliente: 0,
                valor_mao_de_obra: 0,
                parcelas: 1 // Default
            }
        });

        await auditRepo.create({
            tabela: 'ordem_de_servico',
            registro_id: os.id_os,
            acao: 'CREATE',
            valor_novo: os
        });

        return os;
    });
  }

  async findAll() {
    return await prisma.ordemDeServico.findMany({
      where: { deleted_at: null },
      include: {
        cliente: {
          include: {
            pessoa_fisica: { include: { pessoa: true } },
            pessoa_juridica: { include: { pessoa: true } }
          }
        },
        veiculo: true,
        funcionario: { include: { pessoa_fisica: { include: { pessoa: true } } } },
        servicos_mao_de_obra: {
            select: {
                funcionario: {
                    select: {
                        id_funcionario: true,
                        pessoa_fisica: {
                            select: {
                                pessoa: { select: { nome: true } }
                            }
                        }
                    }
                }
            }
         },
        fechamento_financeiro: true
      }
    });
  }

  async findById(id: number) {
    return await prisma.ordemDeServico.findUnique({
      where: { id_os: id },
      include: {
        cliente: {
          include: {
            pessoa_fisica: { include: { pessoa: true } },
            pessoa_juridica: { include: { pessoa: true } }
          }
        },
        veiculo: true,
        funcionario: { include: { pessoa_fisica: { include: { pessoa: true } } } },
        itens_os: {
          where: { deleted_at: null },
          include: {
            pagamentos_peca: true,
            pecas_estoque: true
          }
        },
        fechamento_financeiro: true,
        pagamentos_cliente: true,
        servicos_mao_de_obra: {
            where: { deleted_at: null },
            include: { funcionario: { include: { pessoa_fisica: { include: { pessoa: true } } } } }
        }
      }
    });
  }

  async findByVehicleId(vehicleId: number) {
    return await prisma.ordemDeServico.findMany({
      where: { id_veiculo: vehicleId, deleted_at: null },
      orderBy: { dt_abertura: 'desc' },
      select: {
        id_os: true,
        dt_abertura: true,
        dt_entrega: true,
        km_entrada: true,
        status: true,
        defeito_relatado: true,
        diagnostico: true,
        obs_final: true,
        valor_total_cliente: true,
        valor_mao_de_obra: true,
        valor_pecas: true,
        funcionario: {
          select: {
            id_funcionario: true,
            pessoa_fisica: { select: { pessoa: { select: { nome: true } } } }
          }
        },
        itens_os: {
          select: {
            id_iten: true,
            descricao: true,
            quantidade: true,
            valor_venda: true,
            valor_total: true
          }
        },
        servicos_mao_de_obra: {
            select: {
                id_servico_mao_de_obra: true,
                valor: true,
                descricao: true,
                funcionario: {
                  select: {
                    id_funcionario: true,
                    pessoa_fisica: { select: { pessoa: { select: { nome: true } } } }
                  }
                }
            }
        },
        pagamentos_cliente: true
      }
    });
  }

  async update(id: number, data: Prisma.OrdemDeServicoUpdateInput) {
    const current = await this.findById(id);
    if (!current) throw new Error('OS not found');
    
    // Check lock if finalized or paid (unless it's a specific internal update we might allow, but user said disable for users)
    // Assuming this repo usage is for general updates.
    // If status is FINALIZADA or PAGA, prevent update?
    // "Implementar uma trava onde, após a OS ser marcada como "Finalizada" ou "Paga", o salvamento automático e as edições sejam desabilitados"
    // This is best enforced in Controller or Service, but Repo is the last line of defense.
    // However, sometimes we need to update status FROM Finalizada TO Something else (Reopen).
    // So assume the Caller handles logic, or we check if data DOES NOT contain status change.
    
    const updated = await prisma.ordemDeServico.update({
      where: { id_os: id },
      data,
    });

    await auditRepo.create({
        tabela: 'ordem_de_servico',
        registro_id: id,
        acao: 'UPDATE',
        valor_antigo: current,
        valor_novo: updated
    });

    return updated;
  }

  async delete(id: number) {
    // Soft Delete
    const current = await this.findById(id);
    if (!current) throw new Error('OS not found');

    const updated = await prisma.ordemDeServico.update({
      where: { id_os: id },
      data: { deleted_at: new Date() }
    });
    
    await auditRepo.create({
        tabela: 'ordem_de_servico',
        registro_id: id,
        acao: 'SOFT_DELETE',
        valor_antigo: current
    });
    
    return updated;
  }

  // Recalculates the total values for the OS based on active items and labor
  async recalculateTotals(id_os: number) {
    const items = await prisma.itensOs.aggregate({
        where: { id_os, deleted_at: null },
        _sum: { valor_total: true }
    });
    
    const labor = await prisma.servicoMaoDeObra.aggregate({
        where: { id_os, deleted_at: null },
        _sum: { valor: true }
    });

    const valor_pecas = items._sum?.valor_total || new Prisma.Decimal(0);
    const valor_mao_de_obra = labor._sum?.valor || new Prisma.Decimal(0);
    
    // Ensure accurate decimal addition
    const valor_total_cliente = new Prisma.Decimal(valor_pecas).plus(new Prisma.Decimal(valor_mao_de_obra));

    await prisma.ordemDeServico.update({
        where: { id_os },
        data: {
            valor_pecas,
            valor_mao_de_obra,
            valor_total_cliente
        }
    });

    return { valor_pecas, valor_mao_de_obra, valor_total_cliente };
  }
}



================================================================================
FILE PATH: server\src\repositories\pagamentoCliente.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class PagamentoClienteRepository {
  async create(data: Prisma.PagamentoClienteCreateInput) {
    return await prisma.pagamentoCliente.create({
      data,
    });
  }

  async findAll() {
    return await prisma.pagamentoCliente.findMany({
        include: { 
          ordem_de_servico: {
            include: {
              veiculo: true,
              cliente: {
                include: {
                  pessoa_fisica: { include: { pessoa: true } },
                  pessoa_juridica: { include: { pessoa: true } }
                }
              }
            }
          }
        }
    });
  }

  async findById(id: number) {
    return await prisma.pagamentoCliente.findUnique({
      where: { id_pagamento_cliente: id },
      include: { ordem_de_servico: true }
    });
  }

  async update(id: number, data: Prisma.PagamentoClienteUpdateInput) {
    return await prisma.pagamentoCliente.update({
      where: { id_pagamento_cliente: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.pagamentoCliente.update({
      where: { id_pagamento_cliente: id },
      data: { deleted_at: new Date() }
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\pagamentoPeca.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class PagamentoPecaRepository {
  async create(data: Prisma.PagamentoPecaCreateInput) {
    return await prisma.pagamentoPeca.create({
      data,
    });
  }

  async findAll() {
    return await prisma.pagamentoPeca.findMany({
        include: { 
          fornecedor: true,
          item_os: {
            include: {
              ordem_de_servico: {
                include: {
                  veiculo: true,
                  cliente: {
                    include: {
                      pessoa_fisica: { include: { pessoa: true } },
                      pessoa_juridica: { include: { pessoa: true } }
                    }
                  }
                }
              }
            }
          } 
        }
    });
  }

  async findById(id: number) {
    return await prisma.pagamentoPeca.findUnique({
      where: { id_pagamento_peca: id },
        include: { item_os: true, fornecedor: true }
    });
  }

  async findByItemId(itemId: number) {
      return await prisma.pagamentoPeca.findMany({
          where: { id_item_os: itemId },
          include: { fornecedor: true }
      });
  }

  async update(id: number, data: Prisma.PagamentoPecaUpdateInput) {
    return await prisma.pagamentoPeca.update({
      where: { id_pagamento_peca: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.pagamentoPeca.update({
      where: { id_pagamento_peca: id },
      data: { deleted_at: new Date() }
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\pecasEstoque.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class PecasEstoqueRepository {
  async create(data: Prisma.PecasEstoqueCreateInput) {
    return await prisma.pecasEstoque.create({
      data,
    });
  }

  async findAll() {
    return await prisma.pecasEstoque.findMany();
  }

  async findById(id: number) {
    return await prisma.pecasEstoque.findUnique({
      where: { id_pecas_estoque: id },
    });
  }

  async update(id: number, data: Prisma.PecasEstoqueUpdateInput) {
    return await prisma.pecasEstoque.update({
      where: { id_pecas_estoque: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.pecasEstoque.delete({
      where: { id_pecas_estoque: id },
    });
  }

  async search(query: string) {
    return await prisma.pecasEstoque.findMany({
      where: {
        OR: [
          { nome: { contains: query, mode: 'insensitive' } },
          { fabricante: { contains: query, mode: 'insensitive' } },
          { descricao: { contains: query, mode: 'insensitive' } },
        ]
      },
      take: 10
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\pessoa.repository.ts
================================================================================
import { Prisma, PrismaClient } from '@prisma/client';
import { prisma } from '../prisma.js';

export class PessoaRepository {
  async create(data: Prisma.PessoaCreateInput) {
    return await prisma.pessoa.create({
      data,
    });
  }

  async findAll() {
    return await prisma.pessoa.findMany();
  }

  async findById(id: number) {
    return await prisma.pessoa.findUnique({
      where: { id_pessoa: id },
    });
  }

  async update(id: number, data: Prisma.PessoaUpdateInput) {
    return await prisma.pessoa.update({
      where: { id_pessoa: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.pessoa.delete({
      where: { id_pessoa: id },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\pessoaFisica.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class PessoaFisicaRepository {
  async create(data: Prisma.PessoaFisicaCreateInput) {
    return await prisma.pessoaFisica.create({
      data,
    });
  }

  async findAll() {
    return await prisma.pessoaFisica.findMany({
        include: { pessoa: true }
    });
  }

  async findById(id: number) {
    return await prisma.pessoaFisica.findUnique({
      where: { id_pessoa_fisica: id },
      include: { pessoa: true }
    });
  }

  async update(id: number, data: Prisma.PessoaFisicaUpdateInput) {
    return await prisma.pessoaFisica.update({
      where: { id_pessoa_fisica: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.pessoaFisica.delete({
      where: { id_pessoa_fisica: id },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\pessoaJuridica.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class PessoaJuridicaRepository {
  async create(data: Prisma.PessoaJuridicaCreateInput) {
    return await prisma.pessoaJuridica.create({
      data,
    });
  }

  async findAll() {
    return await prisma.pessoaJuridica.findMany({
        include: { pessoa: true }
    });
  }

  async findById(id: number) {
    return await prisma.pessoaJuridica.findUnique({
      where: { id_pessoa_juridica: id },
      include: { pessoa: true }
    });
  }

  async update(id: number, data: Prisma.PessoaJuridicaUpdateInput) {
    return await prisma.pessoaJuridica.update({
      where: { id_pessoa_juridica: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.pessoaJuridica.delete({
      where: { id_pessoa_juridica: id },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\servicoMaoDeObra.repository.ts
================================================================================

import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';
import { AuditLogRepository } from './auditLog.repository.js';
import { OrdemDeServicoRepository } from './ordemDeServico.repository.js';

const auditRepo = new AuditLogRepository();
const osRepo = new OrdemDeServicoRepository();

export class ServicoMaoDeObraRepository {
  async create(data: { id_os: number; id_funcionario: number; valor: number; descricao?: string | null }) {
    const created = await prisma.servicoMaoDeObra.create({
      data: {
        id_os: data.id_os,
        id_funcionario: data.id_funcionario,
        valor: data.valor,
        descricao: data.descricao ?? null
      },
      include: { funcionario: { include: { pessoa_fisica: { include: { pessoa: true } } } } }
    });
    
    await auditRepo.create({
        tabela: 'servico_mao_de_obra',
        registro_id: created.id_servico_mao_de_obra,
        acao: 'CREATE',
        valor_novo: created
    });

    await osRepo.recalculateTotals(data.id_os);

    return created;
  }

  async findAllByOs(id_os: number) {
    return await prisma.servicoMaoDeObra.findMany({
      where: { id_os: id_os, deleted_at: null },
      include: {
        funcionario: { include: { pessoa_fisica: { include: { pessoa: true } } } }
      }
    });
  }

  async update(id: number, data: { valor?: number; descricao?: string; id_funcionario?: number }) {
    const current = await prisma.servicoMaoDeObra.findUnique({ where: { id_servico_mao_de_obra: id } });
    
    if (!current) throw new Error('Serviço não encontrado');
    // @ts-ignore - status_pagamento exists in db but type might leak outdated
    if (current.status_pagamento === 'PAGO') throw new Error('Bloqueado: Comissão já paga ao funcionário.');

    const updated = await prisma.servicoMaoDeObra.update({
      where: { id_servico_mao_de_obra: id },
      data,
      include: { funcionario: { include: { pessoa_fisica: { include: { pessoa: true } } } } }
    });

    await auditRepo.create({
        tabela: 'servico_mao_de_obra',
        registro_id: id,
        acao: 'UPDATE',
        valor_antigo: current,
        valor_novo: updated
    });

    await osRepo.recalculateTotals(updated.id_os);

    return updated;
  }

  async softDelete(id: number) {
    const current = await prisma.servicoMaoDeObra.findUnique({ where: { id_servico_mao_de_obra: id } });
    if (!current) throw new Error('Serviço não encontrado');
    // @ts-ignore
    if (current.status_pagamento === 'PAGO') throw new Error('Bloqueado: Comissão já paga ao funcionário.');

    const updated = await prisma.servicoMaoDeObra.update({
        where: { id_servico_mao_de_obra: id },
        data: { deleted_at: new Date() }
    });

    await auditRepo.create({
        tabela: 'servico_mao_de_obra',
        registro_id: id,
        acao: 'SOFT_DELETE',
        valor_antigo: current
    });

    await osRepo.recalculateTotals(current.id_os);
    
    return updated;
  }
}



================================================================================
FILE PATH: server\src\repositories\tipo.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class TipoRepository {
  async create(data: Prisma.TipoCreateInput) {
    return await prisma.tipo.create({
      data,
    });
  }

  async findAll() {
    return await prisma.tipo.findMany();
  }

  async findById(id: number) {
    return await prisma.tipo.findUnique({
      where: { id_tipo: id },
    });
  }

  async update(id: number, data: Prisma.TipoUpdateInput) {
    return await prisma.tipo.update({
      where: { id_tipo: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.tipo.delete({
      where: { id_tipo: id },
    });
  }
}



================================================================================
FILE PATH: server\src\repositories\veiculo.repository.ts
================================================================================
import { Prisma } from '@prisma/client';
import { prisma } from '../prisma.js';

export class VeiculoRepository {
  async create(data: Prisma.VeiculoCreateInput) {
    return await prisma.veiculo.create({
      data,
      include: {
        cliente: {
          include: {
            pessoa_fisica: { include: { pessoa: true } },
            pessoa_juridica: { include: { pessoa: true } }
          }
        }
      }
    });
  }

  async findAll() {
    return await prisma.veiculo.findMany({
        include: { 
            cliente: {
                include: {
                    pessoa_fisica: { include: { pessoa: true } },
                    pessoa_juridica: { include: { pessoa: true } }
                }
            } 
        }
    });
  }

  async findById(id: number) {
    return await prisma.veiculo.findUnique({
      where: { id_veiculo: id },
      include: { 
        cliente: {
          include: {
            pessoa_fisica: { include: { pessoa: true } },
            pessoa_juridica: { include: { pessoa: true } }
          }
        } 
      }
    });
  }

  // Search by plate (case-insensitive, normalized without hyphens)
  async findByPlaca(placa: string) {
    // Normalize: remove hyphens and convert to uppercase
    const normalizedPlaca = placa.replace(/-/g, '').toUpperCase();
    
    return await prisma.veiculo.findUnique({
      where: { placa: normalizedPlaca },
      include: { 
        cliente: {
            include: {
                pessoa_fisica: { include: { pessoa: true } },
                pessoa_juridica: { include: { pessoa: true } }
            }
        } 
      }
    });
  }

  // search by partial plate or model (accent-insensitive)
  async search(query: string) {
    // Check if query is numeric (potentially ID search) but we treat as string for now
    
    return await prisma.veiculo.findMany({
      where: {
        OR: [
          { placa: { contains: query, mode: 'insensitive' } },
          { modelo: { contains: query, mode: 'insensitive' } },
          { marca: { contains: query, mode: 'insensitive' } },
          {
            cliente: {
               OR: [
                   { pessoa_fisica: { pessoa: { nome: { contains: query, mode: 'insensitive' } } } },
                   { pessoa_juridica: { razao_social: { contains: query, mode: 'insensitive' } } },
                   { pessoa_juridica: { nome_fantasia: { contains: query, mode: 'insensitive' } } }
               ]
            }
          }
        ]
      },
      take: 20,
      include: { 
        cliente: {
            include: {
                pessoa_fisica: { include: { pessoa: true } },
                pessoa_juridica: { include: { pessoa: true } }
            }
        } 
      }
    });
  }

  async update(id: number, data: Prisma.VeiculoUpdateInput) {
    return await prisma.veiculo.update({
      where: { id_veiculo: id },
      data,
    });
  }

  async delete(id: number) {
    return await prisma.veiculo.delete({
      where: { id_veiculo: id },
    });
  }
}



================================================================================
FILE PATH: server\src\routes\categoriaFinanceira.routes.ts
================================================================================
import { Router } from 'express';
import * as CategoriaController from '../controllers/categoriaFinanceira.controller.js';

export const categoriaFinanceiraRoutes = Router();

categoriaFinanceiraRoutes.get('/', CategoriaController.getAll);
categoriaFinanceiraRoutes.post('/', CategoriaController.create);
categoriaFinanceiraRoutes.put('/:id', CategoriaController.update);
categoriaFinanceiraRoutes.delete('/:id', CategoriaController.remove);



================================================================================
FILE PATH: server\src\routes\cliente.routes.ts
================================================================================
import { Router } from 'express';
import { ClienteController } from '../controllers/cliente.controller.js';

const clienteRoutes = Router();
const controller = new ClienteController();

clienteRoutes.post('/', controller.create);
clienteRoutes.get('/', controller.findAll);
clienteRoutes.get('/search', controller.searchByName); // Must be before /:id
clienteRoutes.get('/:id', controller.findById);
clienteRoutes.put('/:id', controller.update);
clienteRoutes.delete('/:id', controller.delete);

export { clienteRoutes };



================================================================================
FILE PATH: server\src\routes\contasPagar.routes.ts
================================================================================

import { Router } from 'express';
import { createConta, getContas, getContaById, updateConta, deleteConta } from '../controllers/contasPagar.controller.js';

const router = Router();

router.post('/', createConta);
router.get('/', getContas);
router.get('/:id', getContaById);
router.put('/:id', updateConta);
router.delete('/:id', deleteConta);

export default router;



================================================================================
FILE PATH: server\src\routes\dashboard.routes.ts
================================================================================
import { Router } from 'express';
import { DashboardController } from '../controllers/dashboard.controller.js';

const dashboardRoutes = Router();
const controller = new DashboardController();

dashboardRoutes.get('/', controller.getDashboardData);

export { dashboardRoutes };



================================================================================
FILE PATH: server\src\routes\fechamentoFinanceiro.routes.ts
================================================================================
import { Router } from 'express';
import { FechamentoFinanceiroController } from '../controllers/fechamentoFinanceiro.controller.js';

const fechamentoFinanceiroRoutes = Router();
const controller = new FechamentoFinanceiroController();

fechamentoFinanceiroRoutes.post('/', controller.create);
fechamentoFinanceiroRoutes.get('/', controller.findAll);
fechamentoFinanceiroRoutes.get('/:id', controller.findById);
fechamentoFinanceiroRoutes.put('/:id', controller.update);
fechamentoFinanceiroRoutes.delete('/:id', controller.delete);

export { fechamentoFinanceiroRoutes };



================================================================================
FILE PATH: server\src\routes\fornecedor.routes.ts
================================================================================
import { Router } from 'express';
import { FornecedorController } from '../controllers/fornecedor.controller.js';

const fornecedorRoutes = Router();
const controller = new FornecedorController();

fornecedorRoutes.post('/', controller.create);
fornecedorRoutes.get('/', controller.findAll);
fornecedorRoutes.get('/:id', controller.findById);
fornecedorRoutes.put('/:id', controller.update);
fornecedorRoutes.delete('/:id', controller.delete);

export { fornecedorRoutes };



================================================================================
FILE PATH: server\src\routes\funcionario.routes.ts
================================================================================
import { Router } from 'express';
import { FuncionarioController } from '../controllers/funcionario.controller.js';

const funcionarioRoutes = Router();
const controller = new FuncionarioController();

funcionarioRoutes.post('/', controller.create);
funcionarioRoutes.get('/', controller.findAll);
funcionarioRoutes.get('/:id', controller.findById);
funcionarioRoutes.put('/:id', controller.update);
funcionarioRoutes.delete('/:id', controller.delete);

export { funcionarioRoutes };



================================================================================
FILE PATH: server\src\routes\itensOs.routes.ts
================================================================================
import { Router } from 'express';
import { ItensOsController } from '../controllers/itensOs.controller.js';

const itensOsRoutes = Router();
const controller = new ItensOsController();

itensOsRoutes.post('/', controller.create);
itensOsRoutes.get('/', controller.findAll);
itensOsRoutes.get('/os/:idOs', controller.findByOsId);
itensOsRoutes.get('/:id', controller.findById);
itensOsRoutes.put('/:id', controller.update);
itensOsRoutes.delete('/:id', controller.delete);
itensOsRoutes.get('/search/desc', controller.search);

export { itensOsRoutes };



================================================================================
FILE PATH: server\src\routes\livroCaixa.routes.ts
================================================================================
import { Router } from 'express';
import * as LivroCaixaController from '../controllers/livroCaixa.controller.js';

export const livroCaixaRoutes = Router();

livroCaixaRoutes.get('/', LivroCaixaController.getAll);
livroCaixaRoutes.post('/', LivroCaixaController.create);
livroCaixaRoutes.put('/:id', LivroCaixaController.update);
livroCaixaRoutes.delete('/:id', LivroCaixaController.softDelete);



================================================================================
FILE PATH: server\src\routes\ordemDeServico.routes.ts
================================================================================
import { Router } from 'express';
import { OrdemDeServicoController } from '../controllers/ordemDeServico.controller.js';

const ordemDeServicoRoutes = Router();
const controller = new OrdemDeServicoController();

ordemDeServicoRoutes.post('/', controller.create);
ordemDeServicoRoutes.post('/unified', controller.createUnified);
ordemDeServicoRoutes.get('/', controller.findAll);
ordemDeServicoRoutes.get('/:id', controller.findById);
ordemDeServicoRoutes.put('/:id', controller.update);
ordemDeServicoRoutes.delete('/:id', controller.delete);
ordemDeServicoRoutes.get('/veiculo/:vehicleId', controller.findByVehicleId);

export { ordemDeServicoRoutes };



================================================================================
FILE PATH: server\src\routes\pagamentoCliente.routes.ts
================================================================================
import { Router } from 'express';
import { PagamentoClienteController } from '../controllers/pagamentoCliente.controller.js';

const pagamentoClienteRoutes = Router();
const controller = new PagamentoClienteController();

pagamentoClienteRoutes.post('/', controller.create);
pagamentoClienteRoutes.get('/', controller.findAll);
pagamentoClienteRoutes.get('/:id', controller.findById);
pagamentoClienteRoutes.put('/:id', controller.update);
pagamentoClienteRoutes.delete('/:id', controller.delete);

export { pagamentoClienteRoutes };



================================================================================
FILE PATH: server\src\routes\pagamentoEquipe.routes.ts
================================================================================
import { Router } from 'express';
import * as PagamentoEquipeController from '../controllers/pagamentoEquipe.controller.js';

export const pagamentoEquipeRoutes = Router();

pagamentoEquipeRoutes.get('/pendentes/:id_funcionario', PagamentoEquipeController.getPendentesByFuncionario);
pagamentoEquipeRoutes.get('/vales/:id_funcionario', PagamentoEquipeController.getValesPendentesByFuncionario);
pagamentoEquipeRoutes.post('/', PagamentoEquipeController.createPagamento);
pagamentoEquipeRoutes.get('/', PagamentoEquipeController.getHistorico);



================================================================================
FILE PATH: server\src\routes\pagamentoPeca.routes.ts
================================================================================
import { Router } from 'express';
import { PagamentoPecaController } from '../controllers/pagamentoPeca.controller.js';

const pagamentoPecaRoutes = Router();
const controller = new PagamentoPecaController();

pagamentoPecaRoutes.post('/', controller.create);
pagamentoPecaRoutes.get('/', controller.findAll);
pagamentoPecaRoutes.get('/:id', controller.findById);
pagamentoPecaRoutes.put('/:id', controller.update);
pagamentoPecaRoutes.delete('/:id', controller.delete);

export { pagamentoPecaRoutes };



================================================================================
FILE PATH: server\src\routes\pecasEstoque.routes.ts
================================================================================
import { Router } from 'express';
import { PecasEstoqueController } from '../controllers/pecasEstoque.controller.js';

const pecasEstoqueRoutes = Router();
const controller = new PecasEstoqueController();

pecasEstoqueRoutes.post('/', controller.create);
pecasEstoqueRoutes.get('/', controller.findAll);
pecasEstoqueRoutes.get('/search', controller.search);
pecasEstoqueRoutes.get('/:id', controller.findById);
pecasEstoqueRoutes.put('/:id', controller.update);
pecasEstoqueRoutes.delete('/:id', controller.delete);

export { pecasEstoqueRoutes };



================================================================================
FILE PATH: server\src\routes\pessoa.routes.ts
================================================================================
import { Router } from 'express';
import { PessoaController } from '../controllers/pessoa.controller.js';

const pessoaRoutes = Router();
const controller = new PessoaController();

pessoaRoutes.post('/', controller.create);
pessoaRoutes.get('/', controller.findAll);
pessoaRoutes.get('/:id', controller.findById);
pessoaRoutes.put('/:id', controller.update);
pessoaRoutes.delete('/:id', controller.delete);

export { pessoaRoutes };



================================================================================
FILE PATH: server\src\routes\pessoaFisica.routes.ts
================================================================================
import { Router } from 'express';
import { PessoaFisicaController } from '../controllers/pessoaFisica.controller.js';

const pessoaFisicaRoutes = Router();
const controller = new PessoaFisicaController();

pessoaFisicaRoutes.post('/', controller.create);
pessoaFisicaRoutes.get('/', controller.findAll);
pessoaFisicaRoutes.get('/:id', controller.findById);
pessoaFisicaRoutes.put('/:id', controller.update);
pessoaFisicaRoutes.delete('/:id', controller.delete);

export { pessoaFisicaRoutes };



================================================================================
FILE PATH: server\src\routes\pessoaJuridica.routes.ts
================================================================================
import { Router } from 'express';
import { PessoaJuridicaController } from '../controllers/pessoaJuridica.controller.js';

const pessoaJuridicaRoutes = Router();
const controller = new PessoaJuridicaController();

pessoaJuridicaRoutes.post('/', controller.create);
pessoaJuridicaRoutes.get('/', controller.findAll);
pessoaJuridicaRoutes.get('/:id', controller.findById);
pessoaJuridicaRoutes.put('/:id', controller.update);
pessoaJuridicaRoutes.delete('/:id', controller.delete);

export { pessoaJuridicaRoutes };



================================================================================
FILE PATH: server\src\routes\servicoMaoDeObra.routes.ts
================================================================================
import { Router } from 'express';
import { servicoMaoDeObraController } from '../controllers/servicoMaoDeObra.controller.js';

const servicoMaoDeObraRoutes = Router();

servicoMaoDeObraRoutes.post('/', servicoMaoDeObraController.create);
servicoMaoDeObraRoutes.get('/os/:id_os', servicoMaoDeObraController.index);
servicoMaoDeObraRoutes.put('/:id', servicoMaoDeObraController.update);
servicoMaoDeObraRoutes.delete('/:id', servicoMaoDeObraController.delete);

export { servicoMaoDeObraRoutes };



================================================================================
FILE PATH: server\src\routes\tipo.routes.ts
================================================================================
import { Router } from 'express';
import { TipoController } from '../controllers/tipo.controller.js';

const tipoRoutes = Router();
const controller = new TipoController();

tipoRoutes.post('/', controller.create);
tipoRoutes.get('/', controller.findAll);
tipoRoutes.get('/:id', controller.findById);
tipoRoutes.put('/:id', controller.update);
tipoRoutes.delete('/:id', controller.delete);

export { tipoRoutes };



================================================================================
FILE PATH: server\src\routes\veiculo.routes.ts
================================================================================
import { Router } from 'express';
import { VeiculoController } from '../controllers/veiculo.controller.js';

const veiculoRoutes = Router();
const controller = new VeiculoController();

veiculoRoutes.post('/', controller.create);
veiculoRoutes.get('/', controller.findAll);
veiculoRoutes.get('/search', controller.search);
veiculoRoutes.get('/placa/:placa', controller.findByPlaca);
veiculoRoutes.get('/:id', controller.findById);
veiculoRoutes.put('/:id', controller.update);
veiculoRoutes.delete('/:id', controller.delete);

export { veiculoRoutes };



