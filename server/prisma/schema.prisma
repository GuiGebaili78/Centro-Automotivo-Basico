// server/prisma/schema.prisma

// 1. Configuração do Client: Deve ser 'prisma-client-js'
generator client {
  provider = "prisma-client-js"
  // Não precisamos de output customizado por enquanto, vamos usar o padrão
}

// 2. Configuração do Banco de Dados
datasource db {
  provider = "postgresql"
 
  
}

// --- TABELAS DE GENERALIZAÇÃO ---

// Tabela 1: Pessoa (Base)
model Pessoa {
  id_pessoa       Int      @id @default(autoincrement())
  nome            String   @db.VarChar(100)
  genero          String?  @db.VarChar(20)
  dt_nascimento   DateTime? @db.Date // DATE
  obs             String?  @db.VarChar(500)
  dt_cadastro     DateTime @default(now()) @db.Timestamp()

  // Relacionamentos 1:1 (Para Especialização)
  pessoa_fisica   PessoaFisica?
  pessoa_juridica PessoaJuridica?

  @@map("pessoa")
}

// Tabela 2: Pessoa Física (Especialização)
model PessoaFisica {
  id_pessoa_fisica Int      @id @default(autoincrement())
  id_pessoa        Int      @unique
  cpf              String?  @unique @db.VarChar(11)
  dt_cadastro      DateTime @default(now()) @db.Timestamp()

  // Relacionamento com Pessoa
  pessoa           Pessoa   @relation(fields: [id_pessoa], references: [id_pessoa])

  // Relacionamentos para outras tabelas
  funcionario      Funcionario?
  clientes         Cliente[] // Mapeamento 1:N
  
  @@map("pessoa_fisica")
}

// Tabela 3: Pessoa Jurídica (Especialização)
model PessoaJuridica {
  id_pessoa_juridica Int      @id @default(autoincrement())
  id_pessoa          Int      @unique
  razao_social       String   @db.VarChar(100)
  nome_fantasia      String?  @db.VarChar(100)
  cnpj               String?  @unique @db.VarChar(14)
  inscricao_estadual String?  @db.VarChar(50)
  dt_cadastro        DateTime @default(now()) @db.Timestamp()

  // Relacionamento com Pessoa
  pessoa             Pessoa   @relation(fields: [id_pessoa], references: [id_pessoa])

  // Relacionamentos para outras tabelas
  clientes           Cliente[]

  @@map("pessoa_juridica")
}

// Tabela 4: Tipo (Função da Pessoa/Empresa)
model Tipo {
  id_tipo     Int      @id @default(autoincrement())
  funcao      String?  @db.VarChar(50)
  dt_cadastro DateTime @default(now()) @db.Timestamp()
  
  // Relacionamento com Cliente
  clientes    Cliente[]
  
  @@map("tipo")
}

// --- TABELAS PRINCIPAIS ---

// Tabela 5: Cliente (Endereço e Contato)
model Cliente {
  id_cliente          Int       @id @default(autoincrement())
  
  // FKs OPCIONAIS (NULLABLE)
  id_pessoa_fisica    Int?      
  id_pessoa_juridica  Int?      
  tipo_pessoa         Int       // FK
  
  telefone_1          String    @db.VarChar(15)
  telefone_2          String?   @db.VarChar(15)
  telefone_3          String?   @db.VarChar(15)
  email               String?   @db.VarChar(100)
  logradouro          String    @db.VarChar(150)
  nr_logradouro       String    @db.VarChar(10)
  compl_logradouro    String?   @db.VarChar(50)
  bairro              String    @db.VarChar(100)
  cidade              String    @db.VarChar(100)
  estado              String    @db.Char(2)
  dt_cadastro         DateTime  @default(now()) @db.Timestamp()
  
  // Relacionamentos (Chaves Estrangeiras)
  pessoa_fisica       PessoaFisica?  @relation(fields: [id_pessoa_fisica], references: [id_pessoa_fisica])
  pessoa_juridica     PessoaJuridica? @relation(fields: [id_pessoa_juridica], references: [id_pessoa_juridica])
  tipo                Tipo          @relation(fields: [tipo_pessoa], references: [id_tipo])
  
  // Relacionamentos de Volta
  veiculos            Veiculo[]
  ordens_de_servico   OrdemDeServico[]

  // Índices para as FKs para otimização
  @@index([id_pessoa_fisica])
  @@index([id_pessoa_juridica])
  @@index([tipo_pessoa])
  
  // O CHECK CONSTRAINT (exclusividade PF/PJ) será tratado na lógica de serviço
  @@map("cliente")
}

// Tabela 6: Funcionário
model Funcionario {
  id_funcionario      Int      @id @default(autoincrement())
  id_pessoa_fisica    Int      @unique 
  ativo               String   @db.Char(1) // Seu SQL usa CHAR(1) para boolean/status
  cargo               String   @db.VarChar(50)
  salario             Decimal?   @db.Decimal(10, 2)
  comissao            Int?     
  dt_admissao         DateTime @db.Timestamp()
  dt_recisao          DateTime? @db.Timestamp()
  motivo_saida        String?  @db.VarChar(200)
  obs                 String?  @db.VarChar(500)
  dt_cadastro         DateTime @default(now()) @db.Timestamp()
  
  // Relacionamento 1:1 com PessoaFisica
  pessoa_fisica       PessoaFisica @relation(fields: [id_pessoa_fisica], references: [id_pessoa_fisica])
  
  // Relacionamento de Volta
  ordens_de_servico   OrdemDeServico[]

  @@map("funcionario")
}

// Tabela 7: Peças Estoque
model PecasEstoque {
    id_pecas_estoque    Int      @id @default(autoincrement())
    fabricante          String?  @db.VarChar(50)
    nome                String   @db.VarChar(255)
    descricao           String   @db.VarChar(255)
    valor_custo         Decimal    @db.Decimal(10, 2)
    valor_venda         Decimal    @db.Decimal(10, 2)
    estoque_atual       Int      
    unidade_medida      String?  @db.VarChar(20)
    dt_ultima_compra    DateTime? @db.Timestamp()
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    
    // Relacionamento de Volta (M:N com OS)
    itens_os            ItensOs[]

    @@map("pecas_estoque")
}

// Tabela 8: Veículo
model Veiculo {
    id_veiculo          Int      @id @default(autoincrement())
    id_cliente          Int      
    placa               String   @unique @db.VarChar(8)
    chassi              String?  @db.VarChar(20)
    marca               String   @db.VarChar(50)
    modelo              String   @db.VarChar(50)
    versao              String?  @db.VarChar(50)
    ano_modelo          String   @db.VarChar(10)
    cor                 String   @db.VarChar(30)
    combustivel         String   @db.VarChar(20)
    obs                 String?  @db.VarChar(500)
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    
    // Relacionamento 1:N com Cliente
    cliente             Cliente  @relation(fields: [id_cliente], references: [id_cliente])
    
    // Relacionamento de Volta
    ordens_de_servico   OrdemDeServico[]

    @@map("veiculo")
}

// Tabela 9: Ordem de Serviço (OS)
model OrdemDeServico {
    id_os               Int      @id @default(autoincrement())
    id_cliente          Int
    id_veiculo          Int
    id_funcionario      Int
    dt_abertura         DateTime @default(now()) @db.Timestamp()
    dt_entrega          DateTime? @db.Timestamp()
    km_entrada          Int      
    status              String   @db.VarChar(20)
    defeito_relatado    String?  @db.VarChar(500)
    diagnostico         String?  @db.VarChar(500)
    valor_servico       Decimal?   @db.Decimal(10, 2)
    valor_pecas         Decimal?   @db.Decimal(10, 2)
    valor_final         Decimal?   @db.Decimal(12, 2)
    modo_pagamento      String?  @db.VarChar(50)
    cod_pagamento       String?  @db.VarChar(80)
    parcelas            Int      
    obs                 String?  @db.VarChar(500)
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    
    // Relacionamentos (Chaves Estrangeiras)
    cliente             Cliente    @relation(fields: [id_cliente], references: [id_cliente])
    veiculo             Veiculo    @relation(fields: [id_veiculo], references: [id_veiculo])
    funcionario         Funcionario @relation(fields: [id_funcionario], references: [id_funcionario])
    
    // Relacionamentos de Volta
    itens_os            ItensOs[]
    finalizacao         Finalizacao?

    @@map("ordem_de_servico")
}

// Tabela 10: Tabela Associativa M:N (ITENS_OS)
model ItensOs {
    id_iten             Int      @id @default(autoincrement())
    id_os               Int      
    id_pecas_estoque    Int?      
    descricao           String   @db.VarChar(500) 
    qtd                 Int      
    valor_unt           Decimal    @db.Decimal(10, 2)
    valor_total         Decimal    @db.Decimal(12, 2)
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    
    // Relacionamentos (Chaves Estrangeiras)
    ordem_de_servico    OrdemDeServico @relation(fields: [id_os], references: [id_os])
    pecas_estoque       PecasEstoque?   @relation(fields: [id_pecas_estoque], references: [id_pecas_estoque])

    @@map("itens_os")
}

// Tabela 11: Finalização (1:1 com OS)
model Finalizacao {
    id_finalizacao      Int      @id @default(autoincrement())
    id_os               Int      @unique // 1:1 com OS
    valor_peca_entrada  Decimal?   @db.Decimal(10, 2)
    valor_peca_saida    Decimal?   @db.Decimal(10, 2)
    valor_pago_funcionario Decimal? @db.Decimal(10, 2)
    obs                 String?  @db.VarChar(500)
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    
    // Relacionamento 1:1 com OrdemDeServico
    ordem_de_servico    OrdemDeServico @relation(fields: [id_os], references: [id_os])

    @@map("finalizacao")
}