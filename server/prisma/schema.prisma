// server/prisma/schema.prisma

// 1. Configuração do Client: Deve ser 'prisma-client-js'
generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// 2. Configuração do Banco de Dados
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- TABELAS DE GENERALIZAÇÃO ---

// Tabela 1: Pessoa (Base)
model Pessoa {
  id_pessoa       Int      @id @default(autoincrement())
  nome            String   @db.VarChar(100)
  genero          String?  @db.VarChar(20)
  dt_nascimento   DateTime? @db.Date // DATE
  obs             String?  @db.VarChar(500)
  dt_cadastro     DateTime @default(now()) @db.Timestamp()

  // Relacionamentos 1:1 (Para Especialização)
  pessoa_fisica   PessoaFisica?
  pessoa_juridica PessoaJuridica?

  @@map("pessoa")
}

// Tabela 2: Pessoa Física (Especialização)
model PessoaFisica {
  id_pessoa_fisica Int      @id @default(autoincrement())
  id_pessoa        Int      @unique
  cpf              String?  @db.VarChar(11)
  dt_cadastro      DateTime @default(now()) @db.Timestamp()

  // Relacionamento com Pessoa
  pessoa           Pessoa   @relation(fields: [id_pessoa], references: [id_pessoa])

  // Relacionamentos para outras tabelas
  funcionario      Funcionario?
  clientes         Cliente[] // Mapeamento 1:N
  
  @@map("pessoa_fisica")
}

// Tabela 3: Pessoa Jurídica (Especialização)
model PessoaJuridica {
  id_pessoa_juridica Int      @id @default(autoincrement())
  id_pessoa          Int      @unique
  razao_social       String   @db.VarChar(100)
  nome_fantasia      String?  @db.VarChar(100)
  cnpj               String?  @unique @db.VarChar(14)
  inscricao_estadual String?  @db.VarChar(50)
  dt_cadastro        DateTime @default(now()) @db.Timestamp()

  // Relacionamento com Pessoa
  pessoa             Pessoa   @relation(fields: [id_pessoa], references: [id_pessoa])

  // Relacionamentos para outras tabelas
  clientes           Cliente[]

  @@map("pessoa_juridica")
}

// Tabela 4: Tipo (Função da Pessoa/Empresa)
model Tipo {
  id_tipo     Int      @id @default(autoincrement())
  funcao      String?  @db.VarChar(50)
  dt_cadastro DateTime @default(now()) @db.Timestamp()
  
  // Relacionamento com Cliente
  clientes    Cliente[]
  
  @@map("tipo")
}

// --- TABELAS PRINCIPAIS ---

// Tabela 5: Cliente (Endereço e Contato)
model Cliente {
  id_cliente          Int       @id @default(autoincrement())
  
  // FKs OPCIONAIS (NULLABLE)
  id_pessoa_fisica    Int?      
  id_pessoa_juridica  Int?      
  tipo_pessoa         Int       // FK
  
  telefone_1          String    @db.VarChar(15)
  telefone_2          String?   @db.VarChar(15)
  telefone_3          String?   @db.VarChar(15)
  email               String?   @db.VarChar(100)
  logradouro          String?   @db.VarChar(150)
  nr_logradouro       String?   @db.VarChar(10)
  compl_logradouro    String?   @db.VarChar(50)
  bairro              String?   @db.VarChar(100)
  cidade              String?   @db.VarChar(100)
  estado              String?   @db.Char(2)
  dt_cadastro         DateTime  @default(now()) @db.Timestamp()
  
  // Relacionamentos (Chaves Estrangeiras)
  pessoa_fisica       PessoaFisica?  @relation(fields: [id_pessoa_fisica], references: [id_pessoa_fisica])
  pessoa_juridica     PessoaJuridica? @relation(fields: [id_pessoa_juridica], references: [id_pessoa_juridica])
  tipo                Tipo          @relation(fields: [tipo_pessoa], references: [id_tipo])
  
  // Relacionamentos de Volta
  veiculos            Veiculo[]
  ordens_de_servico   OrdemDeServico[]

  // Índices para as FKs para otimização
  @@index([id_pessoa_fisica])
  @@index([id_pessoa_juridica])
  @@index([tipo_pessoa])
  
  @@map("cliente")
}

// Tabela 6: Funcionário
model Funcionario {
  id_funcionario      Int      @id @default(autoincrement())
  id_pessoa_fisica    Int      @unique 
  ativo               String   @db.Char(1) // Seu SQL usa CHAR(1) para boolean/status
  cargo               String   @db.VarChar(50)
  salario             Decimal?   @db.Decimal(10, 2)
  comissao            Int?     
  dt_admissao         DateTime @db.Timestamp()
  dt_recisao          DateTime? @db.Timestamp()
  motivo_saida        String?  @db.VarChar(200)
  obs                 String?  @db.VarChar(500)
  dt_cadastro         DateTime @default(now()) @db.Timestamp()
  
  // Relacionamento 1:1 com PessoaFisica
  pessoa_fisica       PessoaFisica @relation(fields: [id_pessoa_fisica], references: [id_pessoa_fisica])
  
  // Relacionamento de Volta
  ordens_de_servico   OrdemDeServico[]
  servicos_mao_de_obra ServicoMaoDeObra[]

  @@map("funcionario")
}

// Tabela 7: Peças Estoque
model PecasEstoque {
    id_pecas_estoque    Int      @id @default(autoincrement())
    fabricante          String?  @db.VarChar(50)
    nome                String   @db.VarChar(255)
    descricao           String   @db.VarChar(255)
    valor_custo         Decimal    @db.Decimal(10, 2)
    valor_venda         Decimal    @db.Decimal(10, 2)
    estoque_atual       Int      
    unidade_medida      String?  @db.VarChar(20)
    dt_ultima_compra    DateTime? @db.Timestamp()
    
    // Novo Campo
    custo_unitario_padrao Decimal @default(0) @db.Decimal(10, 2)
    
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    
    // Relacionamento de Volta (M:N com OS)
    itens_os            ItensOs[]

    @@map("pecas_estoque")
}

// Tabela 8: Veículo
model Veiculo {
    id_veiculo          Int      @id @default(autoincrement())
    id_cliente          Int      
    placa               String   @unique @db.VarChar(8)
    chassi              String?  @db.VarChar(20)
    marca               String   @db.VarChar(50)
    modelo              String   @db.VarChar(50)
    versao              String?  @db.VarChar(50)
    ano_modelo          String   @db.VarChar(10)
    cor                 String   @db.VarChar(30)
    combustivel         String   @db.VarChar(20)
    obs                 String?  @db.VarChar(500)
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    
    // Relacionamento 1:N com Cliente
    cliente             Cliente  @relation(fields: [id_cliente], references: [id_cliente])
    
    // Relacionamento de Volta
    ordens_de_servico   OrdemDeServico[]

    @@map("veiculo")
}

// Tabela 9: Ordem de Serviço (OS)
model OrdemDeServico {
    id_os               Int      @id @default(autoincrement())
    id_cliente          Int
    id_veiculo          Int
    id_funcionario      Int?
    dt_abertura         DateTime @default(now()) @db.Timestamp()
    dt_entrega          DateTime? @db.Timestamp()
    km_entrada          Int      
    status              String   @db.VarChar(50)
    defeito_relatado    String?  @db.VarChar(500)
    diagnostico         String?  @db.VarChar(500)
    
    // Campos Existentes de Valores
    valor_servico       Decimal?   @db.Decimal(10, 2)
    valor_pecas         Decimal?   @db.Decimal(10, 2)
    valor_final         Decimal?   @db.Decimal(12, 2)
    
    // Novos Campos Solicitados
    valor_total_cliente Decimal?   @db.Decimal(10, 2) // Receita do Cliente
    valor_mao_de_obra   Decimal?   @db.Decimal(10, 2) // Valor M.O. padrão
    
    modo_pagamento      String?  @db.VarChar(50)
    cod_pagamento       String?  @db.VarChar(80)
    parcelas            Int      
    obs                 String?  @db.VarChar(500)
    obs_final           String?  @db.VarChar(500)
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    deleted_at          DateTime? @db.Timestamp() // Soft Delete Marker
    
    // Relacionamentos (Chaves Estrangeiras)
    cliente             Cliente    @relation(fields: [id_cliente], references: [id_cliente])
    veiculo             Veiculo    @relation(fields: [id_veiculo], references: [id_veiculo])
    funcionario         Funcionario? @relation(fields: [id_funcionario], references: [id_funcionario])
    
    // Relacionamentos de Volta
    itens_os            ItensOs[]
    servicos_mao_de_obra ServicoMaoDeObra[]
    fechamento_financeiro FechamentoFinanceiro?
    pagamentos_cliente  PagamentoCliente[]

    @@map("ordem_de_servico")
}

// Tabela 10: Tabela Associativa M:N (ITENS_OS)
model ItensOs {
    id_iten             Int      @id @default(autoincrement())
    id_os               Int      
    id_pecas_estoque    Int?      
    descricao           String   @db.VarChar(500) 
    codigo_referencia   String?  @db.VarChar(50) // Identificação da Peça (Nota) 
    
    // Campos Renomeados/Garantidos
    quantidade          Int      
    valor_venda         Decimal    @db.Decimal(10, 2)
    valor_total         Decimal    @db.Decimal(12, 2)
    
    dt_cadastro         DateTime @default(now()) @db.Timestamp()
    deleted_at          DateTime? @db.Timestamp()
    
    // Relacionamentos (Chaves Estrangeiras)
    ordem_de_servico    OrdemDeServico @relation(fields: [id_os], references: [id_os])
    pecas_estoque       PecasEstoque?   @relation(fields: [id_pecas_estoque], references: [id_pecas_estoque])
    
    // Relacionamento com PagamentoPeca
    pagamentos_peca     PagamentoPeca[]

    @@map("itens_os")
}

// Nova Entidade: Fornecedor
model Fornecedor {
    id_fornecedor Int      @id @default(autoincrement())
    nome          String   @db.VarChar(100)
    documento     String?  @db.VarChar(20)
    contato       String?  @db.VarChar(100)
    dt_cadastro   DateTime @default(now()) @db.Timestamp()
    
    pagamentos_peca PagamentoPeca[]

    @@map("fornecedor")
}

// Nova Entidade: PagamentoPeca (Rastreio de Custo Real)
model PagamentoPeca {
    id_pagamento_peca     Int      @id @default(autoincrement())
    id_item_os            Int
    id_fornecedor         Int
    
    custo_real            Decimal  @db.Decimal(10, 2)
    data_compra           DateTime @db.Timestamp()
    data_pagamento_fornecedor DateTime? @db.Timestamp()
    pago_ao_fornecedor    Boolean  @default(false)
    deleted_at            DateTime? @db.Timestamp()
    
    item_os               ItensOs  @relation(fields: [id_item_os], references: [id_iten])
    fornecedor            Fornecedor @relation(fields: [id_fornecedor], references: [id_fornecedor])

    @@map("pagamento_peca")
}

// Nova Entidade: FechamentoFinanceiro (Substitui Finalizacao)
model FechamentoFinanceiro {
    id_fechamento_financeiro Int      @id @default(autoincrement())
    id_os                    Int      @unique
    custo_total_pecas_real   Decimal  @db.Decimal(10, 2)
    data_fechamento_financeiro DateTime @default(now()) @db.Timestamp()
    deleted_at               DateTime? @db.Timestamp()
    
    ordem_de_servico         OrdemDeServico @relation(fields: [id_os], references: [id_os])

    @@map("fechamento_financeiro")
}

// Nova Entidade: PagamentoCliente (Recebimentos)
model PagamentoCliente {
    id_pagamento_cliente  Int      @id @default(autoincrement())
    id_os                 Int      
    
    metodo_pagamento      String   @db.VarChar(50) // 'CREDITO', 'DEBITO', 'PIX', 'DINHEIRO'
    valor                 Decimal  @db.Decimal(10, 2)
    data_pagamento        DateTime @default(now()) @db.Timestamp()
    deleted_at            DateTime? @db.Timestamp()
    
    // Detalhes
    bandeira_cartao       String?  @db.VarChar(50) // 'VISA', 'MASTER', 'ELO'
    codigo_transacao      String?  @db.VarChar(100) // NSU, ID PIX
    qtd_parcelas          Int      @default(1)
    
    ordem_de_servico      OrdemDeServico @relation(fields: [id_os], references: [id_os])

    @@map("pagamento_cliente")
}

model ServicoMaoDeObra {
    id_servico_mao_de_obra Int      @id @default(autoincrement())
    id_os                 Int
    id_funcionario        Int
    valor                 Decimal  @db.Decimal(10, 2)
    descricao             String?  @db.VarChar(255)
    
    dt_cadastro           DateTime @default(now()) @db.Timestamp()
    deleted_at            DateTime? @db.Timestamp()
    
    ordem_de_servico      OrdemDeServico @relation(fields: [id_os], references: [id_os])
    funcionario           Funcionario    @relation(fields: [id_funcionario], references: [id_funcionario])

    @@map("servico_mao_de_obra")
}

model AuditLog {
    id_log          Int      @id @default(autoincrement())
    tabela          String   @db.VarChar(50)
    registro_id     Int
    acao            String   @db.VarChar(50) 
    valor_antigo    String?  @db.Text
    valor_novo      String?  @db.Text
    usuario_id      Int?
    dt_criacao      DateTime @default(now()) @db.Timestamp()

    @@map("audit_log")
}